<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö—Ä–µ–∏—Ä–∞—ò –∫–∞—Ä—Ç–∏—á–∫–∞ - AAC Card Creator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #667eea;
            --primary-gradient: linear-gradient(90deg, #4c51bf 0%, #667eea 100%);
            --bg-color: #1a202c;
            --card-bg: #2d3748;
            --text-main: #f7fafc;
            --text-muted: #a0aec0;
            --border-color: #4a5568;
            --input-bg: #1a202c;
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            --radius-lg: 16px;
            --font-family: 'Outfit', sans-serif;
        }

        body.light-mode {
            --bg-color: #f0f4f8;
            --card-bg: #ffffff;
            --text-main: #1a202c;
            --text-muted: #4a5568;
            --border-color: #e2e8f0;
            --input-bg: #f7fafc;
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-main);
            display: flex;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
        }

        .app-container {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 3rem;
            max-width: 1050px;
            width: 100%;
            align-items: start;
        }

        @media (max-width: 850px) {
            .app-container { grid-template-columns: 1fr; }
        }

        .panel {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
        }

        .header-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .control-btn {
            background: var(--input-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            font-size: 1rem;
            font-weight: 700;
            font-family: inherit;
            color: var(--text-main);
            cursor: pointer;
            transition: all 0.2s;
        }

        .control-btn:hover {
            border-color: var(--primary-color);
            transform: scale(1.05);
        }

        .panel-header h1 {
            font-size: 1.8rem;
            font-style: italic;
            margin-bottom: 0.5rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .panel-header p {
            color: var(--text-muted);
            margin-bottom: 1.5rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .tab-btn {
            flex: 1;
            padding: 0.75rem 0.5rem;
            background: transparent;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-muted);
            font-family: inherit;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            border-color: var(--primary-color);
            color: var(--text-main);
        }

        .tab-btn.active {
            background: var(--primary-gradient);
            border-color: transparent;
            color: white;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Form */
        .form-group { margin-bottom: 1.25rem; }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-main);
        }

        input[type="text"], textarea, select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            background: var(--input-bg);
            color: var(--text-main);
        }

        select {
            cursor: pointer;
        }

        textarea {
            min-height: 70px;
            resize: vertical;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        small {
            display: block;
            margin-top: 0.5rem;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        /* Buttons */
        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            width: 100%;
            font-family: inherit;
            font-size: 1.1rem;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn-primary:hover { opacity: 0.9; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-secondary {
            background-color: var(--border-color);
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1.1rem;
            font-weight: 700;
            border: none;
            cursor: pointer;
            margin-top: 1.5rem;
        }

        .btn-stop {
            background: #e53e3e;
            color: white;
            padding: 0.75rem;
            border-radius: 8px;
            width: 100%;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 700;
            border: none;
            cursor: pointer;
            margin-top: 0.5rem;
        }

        /* Drop Zone */
        .drop-zone {
            border: 3px dashed var(--border-color);
            border-radius: 12px;
            padding: 2rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--input-bg);
            margin-bottom: 1rem;
        }

        .drop-zone:hover, .drop-zone.drag-over {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.1);
        }

        .drop-zone-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        .drop-zone-text {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        .drop-zone-text strong {
            color: var(--primary-color);
        }

        .drop-zone input[type="file"] {
            display: none;
        }

        /* Image Editor */
        .image-editor {
            display: none;
            margin-top: 1rem;
        }

        .image-editor.active {
            display: block;
        }

        .crop-container {
            position: relative;
            width: 100%;
            height: 250px;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            cursor: move;
        }

        .crop-container img {
            position: absolute;
            max-width: none;
            user-select: none;
            -webkit-user-drag: none;
        }

        .crop-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 3px solid white;
            border-radius: 12px;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);
            pointer-events: none;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        .zoom-controls label {
            margin: 0;
            font-size: 0.9rem;
            min-width: 50px;
        }

        .zoom-slider {
            flex: 1;
            height: 6px;
            -webkit-appearance: none;
            background: var(--border-color);
            border-radius: 3px;
            cursor: pointer;
        }

        .zoom-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
        }

        .editor-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .editor-buttons button {
            flex: 1;
            padding: 0.75rem;
            border-radius: 8px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }

        .btn-apply {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-cancel {
            background: var(--border-color);
            color: white;
        }

        /* Emoji Grid */
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: var(--input-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1rem;
            min-height: 100px;
        }

        .emoji-item {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            background: transparent;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .emoji-item:hover {
            background: var(--card-bg);
            transform: scale(1.1);
        }

        .emoji-item.selected {
            background: rgba(102, 126, 234, 0.3);
            border-color: var(--primary-color);
        }

        .emoji-message {
            grid-column: 1 / -1;
            text-align: center;
            padding: 1rem;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* Card Display */
        .display-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: transparent;
            box-shadow: none;
            padding: 0;
            border: none;
        }

        .aac-card {
            background: white;
            width: 400px;
            height: 400px;
            border: 8px solid #a8d4ff;
            border-radius: 32px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            box-shadow: var(--shadow-lg);
            padding: 1.5rem;
            box-sizing: border-box;
            overflow: hidden;
        }

        @media (max-width: 500px) {
            .aac-card { width: 320px; height: 320px; }
        }

        .card-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            gap: 0.5rem;
        }

        .symbol-display {
            font-size: 9rem;
            line-height: 1;
            flex-shrink: 0;
        }

        .image-display {
            width: 220px;
            height: 220px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
            border-radius: 12px;
        }

        .image-display img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .placeholder-icon {
            font-size: 6rem;
            opacity: 0.2;
        }

        .large-label {
            font-size: 3rem;
            font-weight: 800;
            color: #1a1a2e;
            line-height: 1.2;
            word-break: break-word;
            text-align: center;
            max-width: 100%;
            padding: 0 0.5rem;
        }

        /* Spinner */
        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(102, 126, 234, 0.2);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-info { text-align: center; }

        .timer {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-top: 0.5rem;
        }

        /* Color controls */
        .color-controls {
            margin: 1rem 0;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .color-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .color-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            min-width: 50px;
        }

        .color-picker {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .color-swatch {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .color-swatch:hover { transform: scale(1.15); }
        .color-swatch.active {
            border-color: white;
            box-shadow: 0 0 0 2px var(--primary-color);
        }

        .sync-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-muted);
            cursor: pointer;
        }

        .credit-watermark {
            position: fixed;
            bottom: 10px;
            right: 15px;
            font-size: 10px;
            color: rgba(102, 126, 234, 0.4);
            font-weight: 500;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <main class="app-container">
        <section class="panel input-panel">
            <header class="panel-header">
                <div class="header-controls">
                    <button id="theme-toggle" class="control-btn" title="Toggle theme">üåô</button>
                    <button id="lang-toggle" class="control-btn" title="Change language">EN</button>
                </div>
                <h1 data-i18n="title">–ö—Ä–µ–∏—Ä–∞—ò –∫–∞—Ä—Ç–∏—á–∫–∞</h1>
                <p data-i18n="subtitle">–°–æ–∑–¥–∞–≤–∞—ò –≤–∏–∑—É–µ–ª–Ω–∏ –ø–æ–º–∞–≥–∞–ª–∞ –∑–∞ –∫–æ–º—É–Ω–∏–∫–∞—Ü–∏—ò–∞</p>
            </header>

            <div class="tabs">
                <button class="tab-btn active" data-tab="emoji">üòÄ –ï–º–æ—ü–∏</button>
                <button class="tab-btn" data-tab="upload">üì∑ –°–ª–∏–∫–∞</button>
                <button class="tab-btn" data-tab="ai">‚ú® AI</button>
            </div>

            <!-- TAB: EMOJI -->
            <div id="tab-emoji" class="tab-content active">
                <div class="form-group">
                    <label data-i18n="search_symbol">–ë–∞—Ä–∞—ò –°–∏–º–±–æ–ª</label>
                    <input type="text" id="emoji-search" placeholder="–ù–∞–ø–∏—à–∏ –∑–∞ –ø—Ä–µ–±–∞—Ä—É–≤–∞—ö–µ (–ø—Ä. 'happy', 'dog')..." autocomplete="off">
                </div>

                <div id="emoji-grid" class="emoji-grid">
                    <p class="emoji-message">–ü–æ—á–Ω–∏ –¥–∞ –ø–∏—à—É–≤–∞—à –∑–∞ –ø—Ä–µ–±–∞—Ä—É–≤–∞—ö–µ...</p>
                </div>

                <div class="form-group">
                    <label data-i18n="label_text">–¢–µ–∫—Å—Ç –∑–∞ –ï—Ç–∏–∫–µ—Ç–∞</label>
                    <input type="text" id="emoji-label" placeholder="–ø—Ä. –ö—É—á–µ">
                </div>

                <button class="btn-primary" id="emoji-update-btn">–ê–∂—É—Ä–∏—Ä–∞—ò –ö–∞—Ä—Ç–∏—á–∫–∞</button>
            </div>

            <!-- TAB: UPLOAD / DRAG & DROP -->
            <div id="tab-upload" class="tab-content">
                <div class="drop-zone" id="drop-zone">
                    <div class="drop-zone-icon">üì∑</div>
                    <div class="drop-zone-text">
                        <strong>–ü–æ–≤–ª–µ—á–∏ —Å–ª–∏–∫–∞ —Ç—É–∫–∞</strong><br>
                        –∏–ª–∏ –∫–ª–∏–∫–Ω–∏ –∑–∞ –∏–∑–±–µ—Ä–∏
                    </div>
                    <input type="file" id="file-input" accept="image/*">
                </div>

                <div class="image-editor" id="image-editor">
                    <div class="crop-container" id="crop-container">
                        <img id="crop-image" src="" alt="Crop preview">
                        <div class="crop-overlay"></div>
                    </div>
                    <div class="zoom-controls">
                        <label>üîç –ó—É–º:</label>
                        <input type="range" class="zoom-slider" id="zoom-slider" min="100" max="300" value="100">
                    </div>
                    <div class="editor-buttons">
                        <button class="btn-cancel" id="cancel-crop">‚úï –û—Ç–∫–∞–∂–∏</button>
                        <button class="btn-apply" id="apply-crop">‚úì –ü—Ä–∏–º–µ–Ω–∏</button>
                    </div>
                </div>

                <div class="form-group">
                    <label data-i18n="label_text">–¢–µ–∫—Å—Ç –∑–∞ –ï—Ç–∏–∫–µ—Ç–∞</label>
                    <input type="text" id="upload-label" placeholder="–ø—Ä. –ö—É—á–µ">
                </div>

                <button class="btn-primary" id="upload-update-btn">–ê–∂—É—Ä–∏—Ä–∞—ò –ö–∞—Ä—Ç–∏—á–∫–∞</button>
            </div>

            <!-- TAB: AI -->
            <div id="tab-ai" class="tab-content">
                <div class="form-group">
                    <label>API –ü—Ä–æ–≤–∞—ò–¥–µ—Ä</label>
                    <select id="api-selector">
                        <option value="pollinations">üé® Pollinations (AI –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä)</option>
                        <option value="picsum">üì∑ Picsum (–†–µ–∞–ª–Ω–∏ —Ñ–æ—Ç–æ)</option>
                    </select>
                    <small id="api-info">AI –≥–µ–Ω–µ—Ä–∏—Ä–∞—ö–µ –ø–æ –æ–ø–∏—Å. –ú–æ–∂–µ –¥–∞ –±–∏–¥–µ –±–∞–≤–Ω–æ.</small>
                </div>

                <div class="form-group">
                    <label>–û–ø–∏—Å –Ω–∞ –°–ª–∏–∫–∞</label>
                    <textarea id="ai-prompt" placeholder="–ø—Ä. –°—Ä–µ—ú–Ω–æ –∫—É—á–µ —à—Ç–æ —Å–∏ –∏–≥—Ä–∞ —Å–æ —Ç–æ–ø–∫–∞"></textarea>
                </div>

                <div class="form-group">
                    <label data-i18n="label_text">–¢–µ–∫—Å—Ç –∑–∞ –ï—Ç–∏–∫–µ—Ç–∞</label>
                    <input type="text" id="ai-label" placeholder="–ø—Ä. –ò–≥—Ä–∞">
                </div>

                <button class="btn-primary" id="ai-generate-btn">–ì–µ–Ω–µ—Ä–∏—Ä–∞—ò –°–ª–∏–∫–∞ ‚ú®</button>
                <button class="btn-stop" id="ai-stop-btn" style="display:none;">üõë –°—Ç–æ–ø</button>
            </div>
        </section>

        <section class="display-panel">
            <div id="aac-card" class="aac-card">
                <div class="card-content">
                    <div id="card-visual" class="symbol-display">üëã</div>
                    <div id="card-label" class="large-label">–ó–¥—Ä–∞–≤–æ</div>
                </div>
            </div>

            <div class="color-controls">
                <div class="color-row">
                    <span class="color-label">–†–∞–º–∫–∞:</span>
                    <div class="color-picker" id="border-color-picker">
                        <button class="color-swatch active" data-color="#a8d4ff" style="background:#a8d4ff"></button>
                        <button class="color-swatch" data-color="#000000" style="background:#000"></button>
                        <button class="color-swatch" data-color="#2563eb" style="background:#2563eb"></button>
                        <button class="color-swatch" data-color="#16a34a" style="background:#16a34a"></button>
                        <button class="color-swatch" data-color="#dc2626" style="background:#dc2626"></button>
                        <button class="color-swatch" data-color="#9333ea" style="background:#9333ea"></button>
                        <button class="color-swatch" data-color="#f59e0b" style="background:#f59e0b"></button>
                        <button class="color-swatch" data-color="#ec4899" style="background:#ec4899"></button>
                    </div>
                </div>
                <div class="color-row">
                    <span class="color-label">–¢–µ–∫—Å—Ç:</span>
                    <div class="color-picker" id="font-color-picker">
                        <button class="color-swatch active" data-color="#1a1a2e" style="background:#1a1a2e"></button>
                        <button class="color-swatch" data-color="#000000" style="background:#000"></button>
                        <button class="color-swatch" data-color="#2563eb" style="background:#2563eb"></button>
                        <button class="color-swatch" data-color="#16a34a" style="background:#16a34a"></button>
                        <button class="color-swatch" data-color="#dc2626" style="background:#dc2626"></button>
                        <button class="color-swatch" data-color="#9333ea" style="background:#9333ea"></button>
                        <button class="color-swatch" data-color="#f59e0b" style="background:#f59e0b"></button>
                        <button class="color-swatch" data-color="#ec4899" style="background:#ec4899"></button>
                    </div>
                </div>
                <label class="sync-checkbox">
                    <input type="checkbox" id="sync-colors"> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–∞—ò –±–æ–∏
                </label>
            </div>

            <button id="download-btn" class="btn-secondary">–ó–∞—á—É–≤–∞—ò –ö–∞—Ä—Ç–∏—á–∫–∞ üì∏</button>
        </section>
    </main>

    <div class="credit-watermark">Created by Blagoj Nasev</div>

    <script>
    // ============ EMOJI DATABASE ============
    var EMOJI_DATA = [
        {e:"üòÄ",n:"happy grinning smile"},{e:"üòÉ",n:"happy smile excited"},{e:"üòÑ",n:"happy laugh smile"},
        {e:"üòÅ",n:"happy grin teeth"},{e:"üòÜ",n:"laugh happy squint"},{e:"üòÖ",n:"sweat smile nervous"},
        {e:"ü§£",n:"rofl laugh rolling"},{e:"üòÇ",n:"joy tears laugh cry"},{e:"üôÇ",n:"smile slight happy"},
        {e:"üòä",n:"blush smile happy shy"},{e:"üòá",n:"angel innocent halo"},{e:"ü•∞",n:"love hearts smile"},
        {e:"üòç",n:"love heart eyes"},{e:"üòò",n:"kiss love blow"},{e:"üòã",n:"yum delicious tasty food"},
        {e:"üòõ",n:"tongue playful"},{e:"üòú",n:"wink tongue crazy"},{e:"ü§™",n:"crazy zany wild"},
        {e:"ü§ó",n:"hug hands open"},{e:"ü§î",n:"think hmm wonder"},{e:"ü§´",n:"quiet shush secret"},
        {e:"üòê",n:"neutral face blank"},{e:"üòè",n:"smirk sly"},{e:"üòí",n:"unamused annoyed"},
        {e:"üôÑ",n:"eye roll annoyed"},{e:"üòå",n:"relieved peaceful calm"},{e:"üòî",n:"sad pensive down"},
        {e:"üò™",n:"sleepy tired"},{e:"ü§§",n:"drool hungry"},{e:"üò¥",n:"sleep zzz tired"},
        {e:"üò∑",n:"sick mask ill"},{e:"ü§í",n:"sick fever ill"},{e:"ü§ï",n:"hurt bandage injured"},
        {e:"ü§¢",n:"sick nausea green"},{e:"ü§Æ",n:"vomit throw up sick"},{e:"ü§ß",n:"sneeze sick tissue"},
        {e:"ü•µ",n:"hot warm sweat"},{e:"ü•∂",n:"cold freezing"},{e:"üòµ",n:"dizzy spiral"},
        {e:"ü§Ø",n:"mind blown explode"},{e:"ü•≥",n:"party celebrate birthday"},{e:"üòé",n:"cool sunglasses"},
        {e:"ü§ì",n:"nerd glasses smart"},{e:"üòï",n:"confused unsure"},{e:"üòü",n:"worried nervous"},
        {e:"üôÅ",n:"sad frown"},{e:"üòÆ",n:"surprised wow open mouth"},{e:"üò≤",n:"astonished shocked"},
        {e:"üò≥",n:"flushed embarrassed"},{e:"ü•∫",n:"pleading eyes puppy"},{e:"üò®",n:"fearful scared afraid"},
        {e:"üò∞",n:"anxious sweat worried"},{e:"üò¢",n:"cry tear sad"},{e:"üò≠",n:"cry sob tears"},
        {e:"üò±",n:"scream fear"},{e:"üòû",n:"disappointed sad"},{e:"üò©",n:"weary tired"},
        {e:"üò´",n:"tired exhausted"},{e:"ü•±",n:"yawn tired sleepy"},{e:"üò§",n:"triumph huff angry"},
        {e:"üò°",n:"angry mad rage"},{e:"üò†",n:"angry"},{e:"ü§¨",n:"curse angry swear"},
        {e:"üëã",n:"wave hand hello hi bye"},{e:"ü§ö",n:"raised hand stop"},{e:"‚úã",n:"hand raised stop"},
        {e:"üëå",n:"ok okay hand"},{e:"‚úåÔ∏è",n:"peace victory hand"},{e:"ü§û",n:"fingers crossed luck"},
        {e:"ü§ü",n:"love you hand"},{e:"ü§ò",n:"rock on hand"},{e:"üëà",n:"point left"},
        {e:"üëâ",n:"point right"},{e:"üëÜ",n:"point up"},{e:"üëá",n:"point down"},
        {e:"üëç",n:"thumbs up good yes like"},{e:"üëé",n:"thumbs down bad no dislike"},{e:"üëè",n:"clap hands applause"},
        {e:"üôå",n:"hands raised celebration"},{e:"ü§ù",n:"handshake deal"},{e:"üôè",n:"pray thanks please"},
        {e:"üí™",n:"muscle strong flex"},{e:"üëÇ",n:"ear listen hear"},{e:"üëÉ",n:"nose smell"},
        {e:"üß†",n:"brain think"},{e:"üëÄ",n:"eyes look see"},{e:"üëÖ",n:"tongue taste"},
        {e:"üëÑ",n:"mouth lips"},{e:"üë∂",n:"baby infant"},{e:"üßí",n:"child kid"},
        {e:"üë¶",n:"boy"},{e:"üëß",n:"girl"},{e:"üë®",n:"man"},{e:"üë©",n:"woman"},
        {e:"üë¥",n:"old man grandfather grandpa"},{e:"üëµ",n:"old woman grandmother grandma"},
        {e:"üëÆ",n:"police officer cop"},{e:"üë∑",n:"construction worker"},{e:"üë©‚Äç‚öïÔ∏è",n:"doctor health nurse"},
        {e:"üë©‚Äçüç≥",n:"cook chef"},{e:"üë©‚Äçüéì",n:"student graduate"},{e:"üë©‚Äçüè´",n:"teacher"},
        {e:"üö∂",n:"walk person walking"},{e:"üèÉ",n:"run person running"},{e:"üíÉ",n:"dance woman dancing"},
        {e:"üßò",n:"yoga meditation"},{e:"üõÄ",n:"bath bathtub"},{e:"üõå",n:"sleep bed"},
        {e:"üë™",n:"family"},{e:"üê∂",n:"dog puppy"},{e:"üêï",n:"dog"},{e:"üê©",n:"poodle dog"},
        {e:"üê∫",n:"wolf"},{e:"ü¶ä",n:"fox"},{e:"üê±",n:"cat kitten"},{e:"üêà",n:"cat"},
        {e:"ü¶Å",n:"lion"},{e:"üêØ",n:"tiger"},{e:"üê¥",n:"horse"},{e:"ü¶Ñ",n:"unicorn"},
        {e:"üêÆ",n:"cow"},{e:"üê∑",n:"pig"},{e:"üêë",n:"sheep"},{e:"üêê",n:"goat"},
        {e:"üêò",n:"elephant"},{e:"üê≠",n:"mouse"},{e:"üê∞",n:"rabbit bunny"},{e:"üêª",n:"bear"},
        {e:"üêº",n:"panda"},{e:"üê®",n:"koala"},{e:"üêî",n:"chicken"},{e:"üêß",n:"penguin"},
        {e:"üê¶",n:"bird"},{e:"ü¶Ö",n:"eagle"},{e:"ü¶Ü",n:"duck"},{e:"ü¶â",n:"owl"},
        {e:"üê∏",n:"frog"},{e:"üê¢",n:"turtle"},{e:"üêç",n:"snake"},{e:"üê≥",n:"whale"},
        {e:"üê¨",n:"dolphin"},{e:"üêü",n:"fish"},{e:"ü¶à",n:"shark"},{e:"üêô",n:"octopus"},
        {e:"ü¶ã",n:"butterfly"},{e:"üêõ",n:"bug caterpillar"},{e:"üêú",n:"ant"},{e:"üêù",n:"bee honeybee"},
        {e:"üêû",n:"ladybug"},{e:"üçé",n:"apple red"},{e:"üçè",n:"apple green"},{e:"üçä",n:"orange"},
        {e:"üçã",n:"lemon"},{e:"üçå",n:"banana"},{e:"üçâ",n:"watermelon"},{e:"üçá",n:"grapes"},
        {e:"üçì",n:"strawberry"},{e:"üçí",n:"cherries"},{e:"üçë",n:"peach"},{e:"ü•≠",n:"mango"},
        {e:"üçç",n:"pineapple"},{e:"ü•ù",n:"kiwi"},{e:"üçÖ",n:"tomato"},{e:"ü•ë",n:"avocado"},
        {e:"ü•¶",n:"broccoli"},{e:"ü•ï",n:"carrot"},{e:"üåΩ",n:"corn"},{e:"ü•î",n:"potato"},
        {e:"üçû",n:"bread"},{e:"üßÄ",n:"cheese"},{e:"ü•ö",n:"egg"},{e:"üç≥",n:"cooking egg"},
        {e:"ü•û",n:"pancakes"},{e:"ü•ì",n:"bacon"},{e:"üçó",n:"chicken leg"},{e:"üçñ",n:"meat bone"},
        {e:"üå≠",n:"hot dog"},{e:"üçî",n:"hamburger burger"},{e:"üçü",n:"fries french fries"},
        {e:"üçï",n:"pizza"},{e:"ü•™",n:"sandwich"},{e:"üåÆ",n:"taco"},{e:"üåØ",n:"burrito"},
        {e:"üçù",n:"spaghetti pasta"},{e:"üçú",n:"noodles ramen"},{e:"üç≤",n:"pot stew"},
        {e:"üç£",n:"sushi"},{e:"üç§",n:"shrimp"},{e:"üçö",n:"rice"},{e:"üçß",n:"shaved ice"},
        {e:"üç®",n:"ice cream"},{e:"üç¶",n:"ice cream cone"},{e:"üéÇ",n:"birthday cake"},
        {e:"üç∞",n:"cake"},{e:"üç≠",n:"lollipop candy"},{e:"üç¨",n:"candy"},{e:"üç´",n:"chocolate"},
        {e:"üçø",n:"popcorn"},{e:"üç©",n:"doughnut donut"},{e:"üç™",n:"cookie"},{e:"ü•õ",n:"milk glass"},
        {e:"üçº",n:"baby bottle"},{e:"‚òï",n:"coffee hot"},{e:"üçµ",n:"tea"},{e:"üßÉ",n:"juice box"},
        {e:"ü•§",n:"cup straw"},{e:"üç∫",n:"beer"},{e:"üç∑",n:"wine"},{e:"‚öΩ",n:"soccer football"},
        {e:"üèÄ",n:"basketball"},{e:"üèà",n:"american football"},{e:"‚öæ",n:"baseball"},
        {e:"üéæ",n:"tennis"},{e:"üèê",n:"volleyball"},{e:"üé±",n:"pool billiards"},
        {e:"üèì",n:"ping pong"},{e:"üéØ",n:"target bullseye"},{e:"üéÆ",n:"video game controller"},
        {e:"üß©",n:"puzzle piece"},{e:"üß∏",n:"teddy bear"},{e:"üé®",n:"art palette paint"},
        {e:"üéµ",n:"musical note"},{e:"üé∂",n:"musical notes"},{e:"üé§",n:"microphone"},
        {e:"üéß",n:"headphone"},{e:"üéπ",n:"piano keyboard"},{e:"üé∏",n:"guitar"},
        {e:"ü•Å",n:"drum"},{e:"üì±",n:"mobile phone"},{e:"üíª",n:"laptop computer"},
        {e:"üì∫",n:"television tv"},{e:"üì∑",n:"camera"},{e:"üìö",n:"books reading"},
        {e:"üìñ",n:"open book read"},{e:"üìù",n:"memo write note"},{e:"‚úèÔ∏è",n:"pencil write"},
        {e:"üéí",n:"backpack school bag"},{e:"üè†",n:"house"},{e:"üè´",n:"school building"},
        {e:"üè•",n:"hospital"},{e:"üöó",n:"car automobile"},{e:"üöå",n:"bus"},{e:"üö≤",n:"bicycle bike"},
        {e:"‚úàÔ∏è",n:"airplane"},{e:"üöÄ",n:"rocket"},{e:"‚≠ê",n:"star"},{e:"üåü",n:"glowing star"},
        {e:"‚ú®",n:"sparkles"},{e:"üî•",n:"fire flame hot"},{e:"üåà",n:"rainbow"},
        {e:"‚òÄÔ∏è",n:"sun sunny"},{e:"üåô",n:"moon"},{e:"‚òÅÔ∏è",n:"cloud"},{e:"üåßÔ∏è",n:"rain"},
        {e:"‚ùÑÔ∏è",n:"snowflake"},{e:"üíß",n:"water droplet"},{e:"üåä",n:"wave water ocean"},
        {e:"‚ù§Ô∏è",n:"red heart love"},{e:"üß°",n:"orange heart"},{e:"üíõ",n:"yellow heart"},
        {e:"üíö",n:"green heart"},{e:"üíô",n:"blue heart"},{e:"üíú",n:"purple heart"},
        {e:"üíî",n:"broken heart"},{e:"üíï",n:"two hearts"},{e:"üíØ",n:"hundred points"},
        {e:"‚úÖ",n:"check mark"},{e:"‚ùå",n:"cross mark wrong"},{e:"‚ùì",n:"question mark"},
        {e:"‚ùó",n:"exclamation mark"},{e:"üéâ",n:"party popper"},{e:"üéä",n:"confetti"},
        {e:"üéÅ",n:"gift present"},{e:"üéà",n:"balloon"},{e:"üéÑ",n:"christmas tree"},
        {e:"üéÉ",n:"pumpkin halloween"},{e:"üîî",n:"bell notification"},{e:"‚è∞",n:"alarm clock time"}
    ];

    var STYLE_PROMPT = ', simple flat illustration style, centered composition, minimal background, child-friendly, educational visual, AAC communication symbol style, high contrast, clean lines, no text';

    // ============ MAIN APP ============
    document.addEventListener('DOMContentLoaded', function() {
        var themeToggle = document.getElementById('theme-toggle');
        var langToggle = document.getElementById('lang-toggle');
        var tabBtns = document.querySelectorAll('.tab-btn');
        var emojiSearch = document.getElementById('emoji-search');
        var emojiGrid = document.getElementById('emoji-grid');
        var emojiLabel = document.getElementById('emoji-label');
        var emojiUpdateBtn = document.getElementById('emoji-update-btn');
        var uploadLabel = document.getElementById('upload-label');
        var uploadUpdateBtn = document.getElementById('upload-update-btn');
        var aiPrompt = document.getElementById('ai-prompt');
        var aiLabel = document.getElementById('ai-label');
        var aiGenerateBtn = document.getElementById('ai-generate-btn');
        var aiStopBtn = document.getElementById('ai-stop-btn');
        var apiSelector = document.getElementById('api-selector');
        var apiInfo = document.getElementById('api-info');
        var aacCard = document.getElementById('aac-card');
        var cardVisual = document.getElementById('card-visual');
        var cardLabel = document.getElementById('card-label');
        var downloadBtn = document.getElementById('download-btn');

        // Drop zone elements
        var dropZone = document.getElementById('drop-zone');
        var fileInput = document.getElementById('file-input');
        var imageEditor = document.getElementById('image-editor');
        var cropContainer = document.getElementById('crop-container');
        var cropImage = document.getElementById('crop-image');
        var zoomSlider = document.getElementById('zoom-slider');
        var cancelCrop = document.getElementById('cancel-crop');
        var applyCrop = document.getElementById('apply-crop');

        var selectedEmoji = 'üëã';
        var isGenerating = false;
        var timerInterval = null;
        var isDarkMode = true;
        var currentLang = 'mk';

        // Image cropper state
        var cropState = {
            img: null,
            scale: 1,
            x: 0,
            y: 0,
            isDragging: false,
            startX: 0,
            startY: 0
        };

        // Theme toggle
        themeToggle.addEventListener('click', function() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('light-mode', !isDarkMode);
            themeToggle.textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
        });

        // Language toggle (simplified)
        langToggle.addEventListener('click', function() {
            currentLang = currentLang === 'mk' ? 'en' : 'mk';
            langToggle.textContent = currentLang === 'mk' ? 'EN' : 'MK';
        });

        // Set label function
        function setLabel(text) {
            cardLabel.textContent = text || '–ï—Ç–∏–∫–µ—Ç–∞';
            autoResizeLabel();
        }

        function autoResizeLabel() {
            var len = cardLabel.textContent.length;
            var fontSize = 3;
            if (len > 20) fontSize = 1.8;
            else if (len > 15) fontSize = 2.2;
            else if (len > 10) fontSize = 2.5;
            else if (len > 5) fontSize = 2.8;
            cardLabel.style.fontSize = fontSize + 'rem';
        }

        // Tab switching
        tabBtns.forEach(function(btn) {
            btn.addEventListener('click', function() {
                tabBtns.forEach(function(b) { b.classList.remove('active'); });
                document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
                btn.classList.add('active');
                document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
            });
        });

        // Color pickers
        var borderColorPicker = document.getElementById('border-color-picker');
        var fontColorPicker = document.getElementById('font-color-picker');
        var syncColors = document.getElementById('sync-colors');

        borderColorPicker.addEventListener('click', function(e) {
            if (e.target.classList.contains('color-swatch')) {
                borderColorPicker.querySelectorAll('.color-swatch').forEach(function(s) { s.classList.remove('active'); });
                e.target.classList.add('active');
                aacCard.style.borderColor = e.target.dataset.color;
                if (syncColors.checked) {
                    fontColorPicker.querySelectorAll('.color-swatch').forEach(function(s) {
                        s.classList.remove('active');
                        if (s.dataset.color === e.target.dataset.color) s.classList.add('active');
                    });
                    cardLabel.style.color = e.target.dataset.color;
                }
            }
        });

        fontColorPicker.addEventListener('click', function(e) {
            if (e.target.classList.contains('color-swatch')) {
                fontColorPicker.querySelectorAll('.color-swatch').forEach(function(s) { s.classList.remove('active'); });
                e.target.classList.add('active');
                cardLabel.style.color = e.target.dataset.color;
                if (syncColors.checked) {
                    borderColorPicker.querySelectorAll('.color-swatch').forEach(function(s) {
                        s.classList.remove('active');
                        if (s.dataset.color === e.target.dataset.color) s.classList.add('active');
                    });
                    aacCard.style.borderColor = e.target.dataset.color;
                }
            }
        });

        // ============ EMOJI SEARCH ============
        emojiSearch.addEventListener('input', function() {
            var query = emojiSearch.value.trim().toLowerCase();
            if (query.length < 2) {
                emojiGrid.innerHTML = '<p class="emoji-message">–ù–∞–ø–∏—à–∏ –±–∞—Ä–µ–º 2 –±—É–∫–≤–∏...</p>';
                return;
            }

            var results = EMOJI_DATA.filter(function(item) {
                return item.n.toLowerCase().indexOf(query) !== -1;
            });

            emojiGrid.innerHTML = '';
            if (results.length > 0) {
                results.slice(0, 25).forEach(function(item) {
                    var btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'emoji-item';
                    btn.textContent = item.e;
                    btn.title = item.n;
                    btn.addEventListener('click', function() {
                        document.querySelectorAll('.emoji-item').forEach(function(i) { i.classList.remove('selected'); });
                        btn.classList.add('selected');
                        selectedEmoji = item.e;
                        emojiLabel.value = item.n.split(' ')[0];
                        cardVisual.className = 'symbol-display';
                        cardVisual.textContent = item.e;
                        setLabel(emojiLabel.value);
                    });
                    emojiGrid.appendChild(btn);
                });
            } else {
                emojiGrid.innerHTML = '<p class="emoji-message">–ù–µ–º–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏</p>';
            }
        });

        emojiUpdateBtn.addEventListener('click', function() {
            cardVisual.className = 'symbol-display';
            cardVisual.textContent = selectedEmoji;
            setLabel(emojiLabel.value);
        });

        // ============ DRAG & DROP / UPLOAD ============
        dropZone.addEventListener('click', function() {
            fileInput.click();
        });

        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', function() {
            dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            var files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                loadImageForCrop(files[0]);
            }
        });

        fileInput.addEventListener('change', function() {
            if (fileInput.files.length > 0) {
                loadImageForCrop(fileInput.files[0]);
            }
        });

        function loadImageForCrop(file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                cropImage.src = e.target.result;
                cropImage.onload = function() {
                    imageEditor.classList.add('active');
                    dropZone.style.display = 'none';
                    initCropper();
                };
            };
            reader.readAsDataURL(file);
        }

        function initCropper() {
            cropState.scale = 1;
            cropState.x = 0;
            cropState.y = 0;
            zoomSlider.value = 100;
            updateCropImage();
        }

        function updateCropImage() {
            var containerWidth = cropContainer.offsetWidth;
            var containerHeight = cropContainer.offsetHeight;
            var imgWidth = cropImage.naturalWidth;
            var imgHeight = cropImage.naturalHeight;

            // Calculate base scale to fit container
            var baseScale = Math.max(200 / imgWidth, 200 / imgHeight);
            var scale = baseScale * cropState.scale;

            var scaledWidth = imgWidth * scale;
            var scaledHeight = imgHeight * scale;

            cropImage.style.width = scaledWidth + 'px';
            cropImage.style.height = scaledHeight + 'px';

            // Center initially
            var centerX = (containerWidth - scaledWidth) / 2 + cropState.x;
            var centerY = (containerHeight - scaledHeight) / 2 + cropState.y;

            cropImage.style.left = centerX + 'px';
            cropImage.style.top = centerY + 'px';
        }

        zoomSlider.addEventListener('input', function() {
            cropState.scale = zoomSlider.value / 100;
            updateCropImage();
        });

        // Drag to position
        cropContainer.addEventListener('mousedown', function(e) {
            cropState.isDragging = true;
            cropState.startX = e.clientX - cropState.x;
            cropState.startY = e.clientY - cropState.y;
        });

        document.addEventListener('mousemove', function(e) {
            if (cropState.isDragging) {
                cropState.x = e.clientX - cropState.startX;
                cropState.y = e.clientY - cropState.startY;
                updateCropImage();
            }
        });

        document.addEventListener('mouseup', function() {
            cropState.isDragging = false;
        });

        // Touch support
        cropContainer.addEventListener('touchstart', function(e) {
            var touch = e.touches[0];
            cropState.isDragging = true;
            cropState.startX = touch.clientX - cropState.x;
            cropState.startY = touch.clientY - cropState.y;
        });

        document.addEventListener('touchmove', function(e) {
            if (cropState.isDragging) {
                var touch = e.touches[0];
                cropState.x = touch.clientX - cropState.startX;
                cropState.y = touch.clientY - cropState.startY;
                updateCropImage();
            }
        });

        document.addEventListener('touchend', function() {
            cropState.isDragging = false;
        });

        cancelCrop.addEventListener('click', function() {
            imageEditor.classList.remove('active');
            dropZone.style.display = 'block';
            fileInput.value = '';
        });

        applyCrop.addEventListener('click', function() {
            // Create cropped image
            var canvas = document.createElement('canvas');
            canvas.width = 220;
            canvas.height = 220;
            var ctx = canvas.getContext('2d');

            var containerRect = cropContainer.getBoundingClientRect();
            var overlaySize = 200;
            var overlayX = (containerRect.width - overlaySize) / 2;
            var overlayY = (containerRect.height - overlaySize) / 2;

            var imgRect = cropImage.getBoundingClientRect();
            var scaleX = cropImage.naturalWidth / imgRect.width;
            var scaleY = cropImage.naturalHeight / imgRect.height;

            var srcX = (overlayX - (imgRect.left - containerRect.left)) * scaleX;
            var srcY = (overlayY - (imgRect.top - containerRect.top)) * scaleY;
            var srcW = overlaySize * scaleX;
            var srcH = overlaySize * scaleY;

            ctx.drawImage(cropImage, srcX, srcY, srcW, srcH, 0, 0, 220, 220);

            var croppedDataUrl = canvas.toDataURL('image/png');

            // Apply to card
            cardVisual.className = 'image-display';
            cardVisual.innerHTML = '<img src="' + croppedDataUrl + '" alt="Custom image">';
            setLabel(uploadLabel.value);

            // Reset editor
            imageEditor.classList.remove('active');
            dropZone.style.display = 'block';
            fileInput.value = '';
        });

        uploadUpdateBtn.addEventListener('click', function() {
            setLabel(uploadLabel.value);
        });

        // ============ AI GENERATION ============
        apiSelector.addEventListener('change', function() {
            if (apiSelector.value === 'pollinations') {
                apiInfo.textContent = 'AI –≥–µ–Ω–µ—Ä–∏—Ä–∞—ö–µ –ø–æ –æ–ø–∏—Å. –ú–æ–∂–µ –¥–∞ –±–∏–¥–µ –±–∞–≤–Ω–æ.';
            } else {
                apiInfo.textContent = '–†–µ–∞–ª–Ω–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏. –ë—Ä–∑–æ –∏ —Å–∏–≥—É—Ä–Ω–æ!';
            }
        });

        aiGenerateBtn.addEventListener('click', function() {
            var prompt = aiPrompt.value.trim();
            var label = aiLabel.value.trim() || prompt.split(',')[0] || '–°–ª–∏–∫–∞';

            if (!prompt && apiSelector.value === 'pollinations') {
                alert('–í–Ω–µ—Å–∏ –æ–ø–∏—Å –Ω–∞ —Å–ª–∏–∫–∞');
                return;
            }

            isGenerating = true;
            aiGenerateBtn.disabled = true;
            aiGenerateBtn.textContent = '‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä–∞–º...';
            aiStopBtn.style.display = 'block';

            var seconds = 0;
            cardVisual.className = 'image-display';
            cardVisual.innerHTML = '<div class="loading-info"><div class="spinner"></div><div class="timer" id="timer">0s</div></div>';
            setLabel(label);

            timerInterval = setInterval(function() {
                seconds++;
                var timer = document.getElementById('timer');
                if (timer) timer.textContent = seconds + 's';
            }, 1000);

            var seed = Math.floor(Math.random() * 100000);
            var imageUrl;

            if (apiSelector.value === 'pollinations') {
                var fullPrompt = prompt + STYLE_PROMPT;
                imageUrl = 'https://image.pollinations.ai/prompt/' + encodeURIComponent(fullPrompt) + '?width=512&height=512&nologo=true&seed=' + seed;
            } else {
                imageUrl = 'https://picsum.photos/512/512?random=' + seed;
            }

            var img = new Image();
            img.crossOrigin = 'Anonymous';

            var timeout = setTimeout(function() {
                if (isGenerating) {
                    stopGeneration();
                    cardVisual.innerHTML = '<span class="placeholder-icon">‚ùå</span>';
                    alert('–ò—Å—Ç–µ—á–µ –≤—Ä–µ–º–µ—Ç–æ - –ø—Ä–æ–±–∞—ò –ø–æ–≤—Ç–æ—Ä–Ω–æ –∏–ª–∏ –∫–æ—Ä–∏—Å—Ç–∏ Picsum');
                }
            }, 60000);

            img.onload = function() {
                clearTimeout(timeout);
                clearInterval(timerInterval);
                if (!isGenerating) return;

                cardVisual.innerHTML = '';
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                cardVisual.appendChild(img);

                isGenerating = false;
                aiGenerateBtn.disabled = false;
                aiGenerateBtn.textContent = '–ì–µ–Ω–µ—Ä–∏—Ä–∞—ò –°–ª–∏–∫–∞ ‚ú®';
                aiStopBtn.style.display = 'none';
            };

            img.onerror = function() {
                clearTimeout(timeout);
                clearInterval(timerInterval);
                if (!isGenerating) return;

                cardVisual.innerHTML = '<span class="placeholder-icon">‚ùå</span>';
                isGenerating = false;
                aiGenerateBtn.disabled = false;
                aiGenerateBtn.textContent = '–ì–µ–Ω–µ—Ä–∏—Ä–∞—ò –°–ª–∏–∫–∞ ‚ú®';
                aiStopBtn.style.display = 'none';
                alert('–ì—Ä–µ—à–∫–∞ - –ø—Ä–æ–±–∞—ò –ø–æ–≤—Ç–æ—Ä–Ω–æ –∏–ª–∏ –∫–æ—Ä–∏—Å—Ç–∏ Picsum');
            };

            img.src = imageUrl;
        });

        function stopGeneration() {
            isGenerating = false;
            clearInterval(timerInterval);
            aiGenerateBtn.disabled = false;
            aiGenerateBtn.textContent = '–ì–µ–Ω–µ—Ä–∏—Ä–∞—ò –°–ª–∏–∫–∞ ‚ú®';
            aiStopBtn.style.display = 'none';
        }

        aiStopBtn.addEventListener('click', function() {
            stopGeneration();
            cardVisual.className = 'symbol-display';
            cardVisual.textContent = 'üé®';
        });

        // ============ DOWNLOAD ============
        downloadBtn.addEventListener('click', function() {
            downloadBtn.textContent = '‚è≥ –ó–∞—á—É–≤—É–≤–∞–º...';
            downloadBtn.disabled = true;

            html2canvas(aacCard, {
                scale: 3,
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff'
            }).then(function(canvas) {
                var link = document.createElement('a');
                var filename = cardLabel.textContent.replace(/[^a-zA-Z–∞-—è–ê-–Ø–∞-—à–ê-–®0-9]/g, '_') || 'symbol';
                link.download = 'aac_' + filename + '.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
                downloadBtn.textContent = '–ó–∞—á—É–≤–∞—ò –ö–∞—Ä—Ç–∏—á–∫–∞ üì∏';
                downloadBtn.disabled = false;
            }).catch(function(err) {
                console.error('Save error:', err);
                alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—á—É–≤—É–≤–∞—ö–µ');
                downloadBtn.textContent = '–ó–∞—á—É–≤–∞—ò –ö–∞—Ä—Ç–∏—á–∫–∞ üì∏';
                downloadBtn.disabled = false;
            });
        });

        autoResizeLabel();
    });
    </script>
</body>
</html>
