<!DOCTYPE html>
<html lang="mk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–°—Ç—É–¥–µ–Ω—Ç—Å–∫–æ –î–æ—Å–∏–µ (GitHub Friendly)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --card-bg: rgba(255, 255, 255, 0.95);
      --text-color: #2d3748;
      --border-color: #e2e8f0;
      --input-bg: #fff;
      --muted: #718096;
    }
    body.dark-mode {
      --primary-gradient: linear-gradient(135deg, #4c51bf 0%, #2d3748 100%);
      --bg-gradient: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
      --card-bg: #1a202c;
      --text-color: #e2e8f0;
      --border-color: #4a5568;
      --input-bg: #2d3748;
      --muted: #a0aec0;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-gradient);
      min-height: 100vh;
      color: var(--text-color);
      padding: 20px;
      transition: background 0.3s, color 0.3s;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--card-bg);
      border-radius: 15px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      overflow: hidden;
      min-height: 80vh;
      display: flex;
      flex-direction: column;
    }
    .header {
      background: var(--primary-gradient);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .header h1 { font-size: 1.4em; }
    .controls { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      font-size: 14px;
      white-space: nowrap;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .btn-primary { background: #667eea; color: white; }
    .btn-success { background: #48bb78; color: white; }
    .btn-danger { background: #e53e3e; color: white; }
    .btn-secondary { background: #cbd5e0; color: #2d3748; }
    body.dark-mode .btn-secondary { background: #4a5568; color: #e2e8f0; }

    .main-content { display: flex; flex: 1; overflow: hidden; }
    .sidebar {
      width: 350px;
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      background: rgba(0,0,0,0.02);
    }
    body.dark-mode .sidebar { background: rgba(255,255,255,0.03); }
    .search-box { padding: 15px; border-bottom: 1px solid var(--border-color); }
    .search-box input {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background: var(--input-bg);
      color: var(--text-color);
      outline: none;
    }
    .student-list { flex: 1; overflow-y: auto; }
    .student-item {
      padding: 15px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: background 0.2s;
    }
    .student-item:hover { background: rgba(0,0,0,0.05); }
    body.dark-mode .student-item:hover { background: rgba(255,255,255,0.05); }
    .student-item.active {
      background: rgba(102,126,234,0.12);
      border-left: 4px solid #667eea;
    }
    .student-item h3 { font-size: 16px; margin-bottom: 4px; }
    .student-item p { font-size: 13px; opacity: 0.75; }

    .detail-view { flex: 1; padding: 30px; overflow-y: auto; background: var(--card-bg); }
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      opacity: 0.6;
      text-align: center;
      gap: 6px;
      color: var(--muted);
    }

    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .form-group { margin-bottom: 15px; }
    .form-group.full-width { grid-column: span 2; }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 14px;
      opacity: 0.9;
    }
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 14px;
      background: var(--input-bg);
      color: var(--text-color);
      transition: border-color 0.3s;
      outline: none;
    }
    .form-group input:focus,
    .form-group textarea:focus { border-color: #667eea; }
    .form-group textarea { min-height: 110px; resize: vertical; }

    .section-title {
      grid-column: span 2;
      font-size: 1.2em;
      color: #667eea;
      margin: 20px 0 10px 0;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--border-color);
    }

    /* Preview */
    .preview-grid { display: flex; flex-direction: column; gap: 15px; }
    .preview-row { display: grid; grid-template-columns: 250px 1fr; gap: 20px; align-items: baseline; }
    .preview-label { font-weight: 600; color: #667eea; font-size: 14px; }
    .preview-value { color: var(--text-color); font-size: 15px; line-height: 1.55; white-space: pre-wrap; }

    /* Attachments */
    .attachment-thumb {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      cursor: pointer;
      transition: transform 0.2s;
      background: rgba(0,0,0,0.02);
      margin-top: 8px;
    }
    .attachment-thumb:hover { transform: scale(1.03); }
    .link-item {
      display: block;
      margin-bottom: 8px;
      color: #667eea;
      text-decoration: none;
      word-break: break-all;
      font-size: 13px;
    }
    .link-item:hover { text-decoration: underline; }
    .help {
      margin-top: 10px;
      font-size: 12.5px;
      color: var(--muted);
      line-height: 1.45;
    }
    .help code {
      background: rgba(0,0,0,0.06);
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 12px;
    }
    body.dark-mode .help code { background: rgba(255,255,255,0.08); }

    .theme-switch-wrapper {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--card-bg);
      padding: 10px;
      border-radius: 30px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      border: 1px solid var(--border-color);
    }
    .theme-toggle {
      position: relative;
      width: 50px;
      height: 26px;
      background: #ccc;
      border-radius: 25px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .theme-toggle::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    body.dark-mode .theme-toggle { background: #667eea; }
    body.dark-mode .theme-toggle::after { transform: translateX(24px); }

    @media (max-width: 768px) {
      body { padding: 0; }
      .container { margin: 0; border-radius: 0; height: 100vh; }
      .main-content { flex-direction: column; }
      .sidebar { width: 100%; height: 40%; }
      .detail-view { height: 60%; }
      .form-grid { grid-template-columns: 1fr; }
      .form-group.full-width { grid-column: span 1; }
      .preview-row { grid-template-columns: 1fr; gap: 5px; }
      .preview-label { font-size: 13px; opacity: 0.85; }
    }

    @media print {
      @page { margin: 0; size: A4; }
      body, body.dark-mode {
        background: white !important;
        color: black !important;
        padding: 2cm !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      * { background-color: transparent !important; color: black !important; box-shadow: none !important; }
      .header, .sidebar, .theme-switch-wrapper, .controls, .btn, #emptyState, #dossierForm { display: none !important; }
      .main-content { display: block !important; }
      .detail-view { padding: 0 !important; overflow: visible !important; height: auto !important; background: white !important; }
      #previewView { display: block !important; width: 100% !important; }
      /* keep print simple: hide thumbs, keep links */
      #viewAttachmentsGrid img { display: none !important; }
    }
  </style>

  <script>
    // ============================
    // EMBEDDED DATABASE MODULE (IndexedDB)
    // ============================
    (function () {
      const DB_NAME = "StudentDossierDB";
      const DB_VERSION = 2;
      const STORES = ["student_records", "triage", "attendance", "plans"];

      let db = null;
      let isConnected = false;

      function openDB() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(DB_NAME, DB_VERSION);

          request.onerror = () => reject(request.error);

          request.onsuccess = () => {
            db = request.result;
            isConnected = true;
            resolve(db);
          };

          request.onupgradeneeded = (event) => {
            const database = event.target.result;
            STORES.forEach((storeName) => {
              if (!database.objectStoreNames.contains(storeName)) {
                database.createObjectStore(storeName, { keyPath: "id" });
              }
            });
          };
        });
      }

      window.studentDB = {
        isConnected: false,

        getStatus() {
          return {
            status: isConnected ? "Connected" : "Disconnected",
            name: DB_NAME,
            version: DB_VERSION,
          };
        },

        async getAllRecords(storeName) {
          if (!db) await openDB();
          return new Promise((resolve, reject) => {
            const tx = db.transaction(storeName, "readonly");
            const store = tx.objectStore(storeName);
            const request = store.getAll();
            request.onsuccess = () => resolve(request.result || []);
            request.onerror = () => reject(request.error);
          });
        },

        async addRecord(storeName, data) {
          if (!db) await openDB();
          if (!data.id) data.id = Date.now();
          if (!data.timestamp) data.timestamp = new Date().toISOString();

          return new Promise((resolve, reject) => {
            const tx = db.transaction(storeName, "readwrite");
            const store = tx.objectStore(storeName);
            const request = store.add(data);
            request.onsuccess = () => resolve(data.id);
            request.onerror = () => reject(request.error);
          });
        },

        async updateRecord(storeName, data) {
          if (!db) await openDB();
          return new Promise((resolve, reject) => {
            const tx = db.transaction(storeName, "readwrite");
            const store = tx.objectStore(storeName);
            const request = store.put(data);
            request.onsuccess = () => resolve(true);
            request.onerror = () => reject(request.error);
          });
        },

        async deleteRecord(storeName, id) {
          if (!db) await openDB();
          return new Promise((resolve, reject) => {
            const tx = db.transaction(storeName, "readwrite");
            const store = tx.objectStore(storeName);
            const request = store.delete(id);
            request.onsuccess = () => resolve(true);
            request.onerror = () => reject(request.error);
          });
        },

        // GitHub-friendly export: strips base64 image blobs if they exist
        async exportBackup() {
          if (!db) await openDB();

          const stripLargeFields = (record) => {
            const r = { ...record };
            if (typeof r.attachment === "string" && r.attachment.startsWith("data:image")) delete r.attachment;
            if (Array.isArray(r.attachments)) {
              r.attachments = r.attachments.filter(x => !(typeof x === "string" && x.startsWith("data:image")));
              if (r.attachments.length === 0) delete r.attachments;
            }
            return r; // keep attachmentLinks
          };

          const backup = {
            meta: {
              version: DB_VERSION,
              date: new Date().toISOString(),
              appName: "–°—Ç—É–¥–µ–Ω—Ç—Å–∫–æ –î–æ—Å–∏–µ (GitHub Friendly)",
            },
            data: {},
          };

          for (const storeName of STORES) {
            const rows = await this.getAllRecords(storeName);
            backup.data[storeName] = rows.map(stripLargeFields);
          }

          return JSON.stringify(backup, null, 2);
        },

        // Reliable import: clear store then put
        async importBackup(jsonString) {
          if (!db) await openDB();

          const cleaned = String(jsonString || "").replace(/^\uFEFF/, "").trim();
          let backup;
          try {
            backup = JSON.parse(cleaned);
          } catch (e) {
            throw new Error("–ù–µ–≤–∞–ª–∏–¥–µ–Ω JSON —Ñ–æ—Ä–º–∞—Ç: " + e.message);
          }

          let dataToImport = {};
          if (backup.data && typeof backup.data === "object") {
            dataToImport = backup.data;
          } else if (Array.isArray(backup)) {
            dataToImport = { student_records: backup };
          } else if (backup.student_records) {
            dataToImport = backup;
          } else {
            throw new Error("–ù–µ–ø–æ–∑–Ω–∞—Ç —Ñ–æ—Ä–º–∞—Ç –Ω–∞ backup –¥–∞—Ç–æ—Ç–µ–∫–∞");
          }

          for (const storeName of STORES) {
            const rows = dataToImport[storeName];
            if (!Array.isArray(rows)) continue;

            const tx = db.transaction(storeName, "readwrite");
            const store = tx.objectStore(storeName);

            await new Promise((resolve, reject) => {
              const req = store.clear();
              req.onsuccess = () => resolve(true);
              req.onerror = () => reject(req.error);
            });

            for (const record of rows) {
              if (!record || !record.id) continue;
              await new Promise((resolve, reject) => {
                const req = store.put(record);
                req.onsuccess = () => resolve(true);
                req.onerror = () => reject(req.error);
              });
            }

            await new Promise((resolve, reject) => {
              tx.oncomplete = () => resolve(true);
              tx.onerror = () => reject(tx.error);
              tx.onabort = () => reject(tx.error || new Error("Import aborted"));
            });
          }

          return true;
        },
      };

      openDB()
        .then(() => {
          window.studentDB.isConnected = true;
          window.dispatchEvent(new Event("db-ready"));
          console.log("‚úÖ IndexedDB connected:", DB_NAME);
        })
        .catch((err) => {
          console.error("‚ùå IndexedDB error:", err);
          alert("IndexedDB error: " + (err?.message || err));
        });
    })();

    // ============================
    // Link normalization (Drive/Dropbox)
    // ============================
    function normalizeImageLink(url) {
      if (!url) return url;
      let u = url.trim();

      // Google Drive: /file/d/ID/view -> uc?export=view&id=ID
      const m = u.match(/drive\.google\.com\/file\/d\/([^\/\?]+)/i);
      if (m && m[1]) u = `https://drive.google.com/uc?export=view&id=${m[1]}`;

      // Dropbox: dl=0 -> raw=1
      if (u.includes("dropbox.com") && /[?&]dl=0/.test(u)) u = u.replace(/([?&])dl=0/, "$1raw=1");

      return u;
    }

    function looksLikeDirectImageUrl(url) {
      return /\.(png|jpe?g|webp|gif)(\?.*)?$/i.test(url);
    }
  </script>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üìÇ –°—Ç—É–¥–µ–Ω—Ç—Å–∫–æ –î–æ—Å–∏–µ <span style="font-size:12px; opacity:.85;">(GitHub Friendly)</span></h1>
      <div class="controls">
        <button class="btn btn-secondary" onclick="app.exportData()">‚¨á Backup</button>
        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">‚¨Ü Import</button>
        <input type="file" id="importFile" hidden accept="application/json" onchange="app.importData(this)">
        <button class="btn btn-success" onclick="app.createNewStudent()">+ –ù–æ–≤ –£—á–µ–Ω–∏–∫</button>
      </div>
    </div>

    <div class="main-content">
      <div class="sidebar">
        <div class="search-box">
          <input type="text" placeholder="üîç –ü—Ä–µ–±–∞—Ä–∞—ò —É—á–µ–Ω–∏–∫..." oninput="app.filterStudents(this.value)">
        </div>
        <div class="student-list" id="studentList"></div>
      </div>

      <div class="detail-view">
        <div id="emptyState" class="empty-state">
          <h2>–ò–∑–±–µ—Ä–µ—Ç–µ —É—á–µ–Ω–∏–∫ –æ–¥ –ª–∏—Å—Ç–∞—Ç–∞</h2>
          <p>–∏–ª–∏ –∫—Ä–µ–∏—Ä–∞—ò—Ç–µ –Ω–æ–≤ –∑–∞–ø–∏—Å</p>
        </div>

        <!-- Preview -->
        <div id="previewView" style="display:none;">
          <h2 style="margin-bottom: 5px; color:#667eea;">–£—á–µ–Ω–∏—á–∫–æ –¥–æ—Å–∏–µ</h2>
          <h3 id="previewStudentTitle" style="margin-bottom: 30px; font-weight: normal; color: var(--text-color);">–£—á–µ–Ω–∏–∫</h3>

          <div class="preview-grid">
            <div class="preview-row"><div class="preview-label">–ò–º–µ</div><div class="preview-value" data-field="firstName"></div></div>
            <div class="preview-row"><div class="preview-label">–ü—Ä–µ–∑–∏–º–µ</div><div class="preview-value" data-field="lastName"></div></div>
            <div class="preview-row"><div class="preview-label">–î–∞—Ç—É–º –Ω–∞ —Ä–∞—ì–∞—ö–µ</div><div class="preview-value" data-field="birthDate"></div></div>
            <div class="preview-row"><div class="preview-label">–û–¥–¥–µ–ª–µ–Ω–∏–µ</div><div class="preview-value" data-field="grade"></div></div>
            <div class="preview-row"><div class="preview-label">–ö–æ–Ω—Ç–∞–∫—Ç –¥–µ—Ç–∞–ª–∏</div><div class="preview-value" data-field="contact"></div></div>
            <div class="preview-row"><div class="preview-label">–ò–º–µ –∏ –ø—Ä–µ–∑–∏–º–µ –Ω–∞ —Ç–∞—Ç–∫–æ—Ç–æ</div><div class="preview-value" data-field="fatherName"></div></div>
            <div class="preview-row"><div class="preview-label">–ò–º–µ –∏ –ø—Ä–µ–∑–∏–º–µ –Ω–∞ –º–∞—ò–∫–∞—Ç–∞</div><div class="preview-value" data-field="motherName"></div></div>
            <div class="preview-row"><div class="preview-label">–ê–¥—Ä–µ—Å–∞</div><div class="preview-value" data-field="address"></div></div>
            <div class="preview-row"><div class="preview-label">–ú–µ—Å—Ç–æ –Ω–∞ –∂–∏–≤–µ–µ—ö–µ</div><div class="preview-value" data-field="residence"></div></div>
            <div class="preview-row"><div class="preview-label">–ù–∞–æ–¥</div><div class="preview-value" data-field="findings"></div></div>
            <div class="preview-row"><div class="preview-label">–ú–∏—Å–ª–µ—ö–µ</div><div class="preview-value" data-field="opinion"></div></div>
          </div>

          <div id="viewAttachmentContainer" style="display:none; margin-top: 30px; border-top: 1px solid var(--border-color); padding-top: 20px;">
            <h3 style="font-size: 18px; color: var(--muted); margin-bottom: 12px;">–ü—Ä–∏–ª–æ–∑–∏ (–ª–∏–Ω–∫–æ–≤–∏ + thumbnails)</h3>
            <div id="viewAttachmentsGrid" style="display:grid; grid-template-columns: repeat(auto-fill,minmax(150px,1fr)); gap:10px;"></div>
            <div class="help">
              –ó–∞ Google Drive: –∞–ø–ª–∏–∫–∞—Ü–∏—ò–∞—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç—Å–∫–∏ –≥–æ –ø—Ä–µ—Ç–≤–æ—Ä–∞ <code>.../file/d/ID/view</code> –≤–æ <code>uc?export=view&id=ID</code>.
              Thumbnail —ú–µ —Å–µ –ø–æ—ò–∞–≤–∏ –∞–∫–æ —Ñ–∞—ò–ª–æ—Ç –µ —Å–ø–æ–¥–µ–ª–µ–Ω ‚ÄúAnyone with the link‚Äù.
            </div>
          </div>

          <div style="margin-top: 30px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn btn-primary" onclick="app.editStudent()">‚úé –ü—Ä–æ–º–µ–Ω–∏</button>
            <button class="btn btn-secondary" onclick="app.exportToJpeg()">üì∏ –ó–∞—á—É–≤–∞—ò –∫–∞–∫–æ –°–ª–∏–∫–∞</button>
            <button class="btn btn-secondary" onclick="app.closeStudent()">–ù–∞–∑–∞–¥ –¥–æ –ª–∏—Å—Ç–∞—Ç–∞</button>
          </div>
        </div>

        <!-- Edit -->
        <form id="dossierForm" style="display:none;" onsubmit="event.preventDefault(); app.saveCurrentStudent();">
          <div class="form-grid">
            <div class="section-title">–û—Å–Ω–æ–≤–Ω–∏ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</div>

            <div class="form-group">
              <label>–û–¥–¥–µ–ª–µ–Ω–∏–µ</label>
              <input type="text" name="grade">
            </div>

            <div class="form-group">
              <label>–ò–º–µ</label>
              <input type="text" name="firstName" required>
            </div>

            <div class="form-group">
              <label>–ü—Ä–µ–∑–∏–º–µ</label>
              <input type="text" name="lastName" required>
            </div>

            <div class="form-group">
              <label>–î–∞—Ç—É–º –Ω–∞ —Ä–∞—ì–∞—ö–µ</label>
              <input type="date" name="birthDate">
            </div>

            <div class="form-group">
              <label>–ö–æ–Ω—Ç–∞–∫—Ç –¥–µ—Ç–∞–ª–∏</label>
              <input type="text" name="contact">
            </div>

            <div class="section-title">–°–µ–º–µ—ò–Ω–∏ –ü–æ–¥–∞—Ç–æ—Ü–∏</div>

            <div class="form-group">
              <label>–ò–º–µ –∏ –ø—Ä–µ–∑–∏–º–µ –Ω–∞ —Ç–∞—Ç–∫–æ—Ç–æ</label>
              <input type="text" name="fatherName">
            </div>

            <div class="form-group">
              <label>–ò–º–µ –∏ –ø—Ä–µ–∑–∏–º–µ –Ω–∞ –º–∞—ò–∫–∞—Ç–∞</label>
              <input type="text" name="motherName">
            </div>

            <div class="form-group full-width">
              <label>–ê–¥—Ä–µ—Å–∞</label>
              <input type="text" name="address">
            </div>

            <div class="form-group full-width">
              <label>–ú–µ—Å—Ç–æ –Ω–∞ –∂–∏–≤–µ–µ—ö–µ</label>
              <input type="text" name="residence">
            </div>

            <div class="section-title">–°—Ç—Ä—É—á–Ω–∞ –ü—Ä–æ—Ü–µ–Ω–∫–∞</div>

            <div class="form-group full-width">
              <label>–ù–∞–æ–¥</label>
              <textarea name="findings"></textarea>
            </div>

            <div class="form-group full-width">
              <label>–ú–∏—Å–ª–µ—ö–µ</label>
              <textarea name="opinion"></textarea>
            </div>

            <div class="section-title">–ü—Ä–∏–ª–æ–∑–∏ (–ª–∏–Ω–∫–æ–≤–∏)</div>

            <div class="form-group full-width">
              <label>–õ–∏–Ω–∫–æ–≤–∏ –¥–æ –ø—Ä–∏–ª–æ–∑–∏ (–ø–æ –µ–¥–µ–Ω –ª–∏–Ω–∫ –≤–æ —Ä–µ–¥)</label>
              <textarea id="attachmentLinksInput" placeholder="https://..."></textarea>
              <div class="help">
                Paste Google Drive/Dropbox/OneDrive –ª–∏–Ω–∫–æ–≤–∏. –ê–ø–ª–∏–∫–∞—Ü–∏—ò–∞—Ç–∞ —ú–µ —Å–µ –æ–±–∏–¥–µ –¥–∞ –≥–∏ ‚Äú–Ω–æ—Ä–º–∞–ª–∏–∑–∏—Ä–∞‚Äù (Drive ‚Üí direct view).
                –ê–∫–æ –∏–º–∞ —Å—Ç–∞—Ä base64 –ø—Ä–∏–ª–æ–≥ –æ–¥ –ø–æ—Ä–∞–Ω–æ, —ú–µ —Å–µ —Ç—Ä–≥–Ω–µ –∫–æ–≥–∞ —ú–µ –∑–∞—á—É–≤–∞—à –±–∞—Ä–µ–º –µ–¥–µ–Ω –ª–∏–Ω–∫.
              </div>
            </div>
          </div>

          <div style="display:flex; justify-content:flex-end; gap:10px; margin-top: 20px; flex-wrap:wrap;">
            <button type="button" class="btn btn-secondary" onclick="app.cancelEdit()">–û—Ç–∫–∞–∂–∏</button>
            <button type="button" class="btn btn-danger" onclick="app.deleteStudent()">–ò–∑–±—Ä–∏—à–∏</button>
            <button type="button" class="btn btn-primary" onclick="app.saveCurrentStudent()">–ó–∞—á—É–≤–∞—ò –ü—Ä–æ–º–µ–Ω–∏</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="theme-switch-wrapper">
    <span style="font-size: 14px; font-weight: 600;">Dark Mode</span>
    <div class="theme-toggle" onclick="document.body.classList.toggle('dark-mode')"></div>
  </div>

  <script>
    const INITIAL_STUDENTS = [
      { id: 1759384696342, firstName: "–°–∞—Ä–¥–∏", lastName: "–ú—É–∞—Ä–µ–º–∏", grade: "(–Ω–∞–¥.)" },
      { id: 1759384710134, firstName: "–¢–µ–æ–¥–æ—Ä–∞", lastName: "–ë–æ–≥–∞—Ç–∏–Ω–æ–≤–∞", grade: "(–Ω–∞–¥.)" },
      { id: 1759384625367, firstName: "–ï–Ω–µ—Å", lastName: "–ê–ª–∏—É", grade: "(–Ω–∞–¥.)" },
      { id: 1759384723398, firstName: "–°—Ç–µ—Ñ–∞–Ω", lastName: "–ú–∞—Ä–∏–Ω–∫–æ–≤–∏—ú", grade: "(–Ω–∞–¥.)" },
      { id: 1759384447857, firstName: "–ú–∏—Ä–µ–º", lastName: "–û—Å–º–∞–Ω–æ–≤–∞", grade: "IV-–∞" },
      { id: 1759384496127, firstName: "–õ–µ–∞—Ä—Ç–∞", lastName: "–ó—É–ª–∞–º–∏", grade: "V-–∞" },
      { id: 1759384514431, firstName: "–ú–∞—Ä—Ç–∏–Ω", lastName: "–É—É—Ä–æ–≤—Å–∫–∏", grade: "V-–±" },
      { id: 1759384531343, firstName: "–ò–≤–∞–Ω", lastName: "–¶–≤–µ—Ç–∞–Ω–æ–≤—Å–∫–∏", grade: "V-–±" },
      { id: 1759384547455, firstName: "–ú–∞—Ä–∏—ò–∞", lastName: "–ß–∞–¥–∞–º–æ–≤–∞", grade: "VI-–∞" },
      { id: 1759384565063, firstName: "–ï–º–∏–Ω", lastName: "–ï—Ç–µ–º–æ–≤", grade: "VI" },
      { id: 1759384580351, firstName: "–î–∏–º–∏—Ç–∞—Ä", lastName: "–¢—Ä–∞—ò—á–µ–≤—Å–∫–∏", grade: "VII-–∞" },
      { id: 1759384595134, firstName: "–ú–∞–∫—Å–∏–ª–¥–∞", lastName: "–°–µ–ª–∏–º–æ–≤–∞", grade: "VII-–±" },
      { id: 1759384610343, firstName: "–î–∞–≤–∏–¥", lastName: "–ü–µ—Ç—Ä–æ–≤—Å–∫–∏", grade: "VII-–±" },
      { id: 1759384642270, firstName: "–ì–∞–±—Ä–∏–µ–ª–∞", lastName: "–ö–æ–Ω–µ—Å–∫–∞", grade: "VIII-–∞" },
      { id: 1759384666199, firstName: "–°–µ—ò—Ö–∞–Ω", lastName: "–ù–µ—ü–∏–ø–æ–≤", grade: "VIII-–∞" },
      { id: 1759384680910, firstName: "–ö—Ä–∏—Å—Ç–∏—ò–∞–Ω", lastName: "–¢–æ–¥–æ—Ä–æ—Å–∫–∏", grade: "VIII-–±" },
    ];

    class App {
      constructor() {
        this.students = [];
        this.currentStudentId = null;
        this.init();
      }

      async init() {
        if (window.studentDB && window.studentDB.isConnected) {
          this.startApp();
        } else {
          window.addEventListener("db-ready", () => this.startApp(), { once: true });
        }
      }

      async startApp() {
        await this.loadStudents();
        if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
          document.body.classList.add("dark-mode");
        }
      }

      async loadStudents() {
        this.students = await window.studentDB.getAllRecords("student_records");
        if (this.students.length === 0) {
          for (const s of INITIAL_STUDENTS) await window.studentDB.addRecord("student_records", s);
          this.students = await window.studentDB.getAllRecords("student_records");
        }
        this.renderList();
      }

      renderList(filter = "") {
        const listEl = document.getElementById("studentList");
        listEl.innerHTML = "";

        const f = filter.toLowerCase();
        const filtered = this.students.filter((s) =>
          `${s.firstName || ""} ${s.lastName || ""}`.toLowerCase().includes(f)
        );

        filtered.forEach((s) => {
          const el = document.createElement("div");
          el.className = `student-item ${s.id === this.currentStudentId ? "active" : ""}`;
          el.onclick = () => this.loadStudent(s.id);
          el.innerHTML = `<h3>${escapeHtml(s.firstName || "")} ${escapeHtml(s.lastName || "")}</h3>
                          <p>${escapeHtml(s.grade || "–ù–µ–º–∞ –æ–¥–¥–µ–ª–µ–Ω–∏–µ")}</p>`;
          listEl.appendChild(el);
        });
      }

      async loadStudent(id) {
        this.currentStudentId = id;
        const student = this.students.find((s) => s.id === id);
        if (!student) return;

        document.getElementById("emptyState").style.display = "none";
        document.getElementById("dossierForm").style.display = "none";
        const previewView = document.getElementById("previewView");
        previewView.style.display = "block";

        document.title = `–°—Ç—É–¥–µ–Ω—Ç—Å–∫–æ –¥–æ—Å–∏–µ - ${student.firstName || ""} ${student.lastName || ""}`.trim();
        document.getElementById("previewStudentTitle").textContent =
          `${student.firstName || ""} ${student.lastName || ""}`.trim() || "–£—á–µ–Ω–∏–∫";

        const fields = previewView.querySelectorAll("[data-field]");
        fields.forEach((field) => {
          const key = field.getAttribute("data-field");
          const val = student[key];
          field.textContent = (val === undefined || val === null || val === "") ? "/" : String(val);
        });

        this.renderAttachments(student);
        this.renderList();
      }

      renderAttachments(student) {
        const attachmentContainer = document.getElementById("viewAttachmentContainer");
        const grid = document.getElementById("viewAttachmentsGrid");
        grid.innerHTML = "";

        const rawLinks = Array.isArray(student.attachmentLinks) ? student.attachmentLinks : [];
        const links = Array.from(new Set(rawLinks.map(normalizeImageLink).map(s => (s || "").trim()).filter(Boolean)));

        if (links.length === 0) {
          attachmentContainer.style.display = "none";
          attachmentContainer.classList.remove("has-attachments");
          return;
        }

        attachmentContainer.style.display = "block";
        attachmentContainer.classList.add("has-attachments");

        links.forEach((url) => {
          const a = document.createElement("a");
          a.href = url;
          a.target = "_blank";
          a.rel = "noopener";
          a.className = "link-item";
          a.textContent = url;
          grid.appendChild(a);

          const shouldTryThumb = looksLikeDirectImageUrl(url) || url.includes("drive.google.com/uc?export=view&id=");
          if (shouldTryThumb) {
            const img = document.createElement("img");
            img.src = url;
            img.className = "attachment-thumb";
            img.onclick = () => window.open(url, "_blank", "noopener");
            grid.appendChild(img);
          }
        });
      }

      editStudent() {
        const student = this.students.find((s) => s.id === this.currentStudentId);
        if (!student) return;

        document.getElementById("previewView").style.display = "none";
        const form = document.getElementById("dossierForm");
        form.style.display = "block";

        const inputs = form.querySelectorAll("input, textarea[name]");
        inputs.forEach((input) => {
          if (!input.name) return;
          input.value = student[input.name] || "";
        });

        document.getElementById("attachmentLinksInput").value =
          (student.attachmentLinks || []).join("\n");
      }

      cancelEdit() {
        this.loadStudent(this.currentStudentId);
      }

      closeStudent() {
        this.currentStudentId = null;
        document.getElementById("previewView").style.display = "none";
        document.getElementById("dossierForm").style.display = "none";
        document.getElementById("emptyState").style.display = "flex";
        document.title = "–°—Ç—É–¥–µ–Ω—Ç—Å–∫–æ –î–æ—Å–∏–µ (GitHub Friendly)";
        this.renderList();
      }

      async createNewStudent() {
        const newId = Date.now();
        const newStudent = { id: newId, firstName: "–ù–æ–≤", lastName: "–£—á–µ–Ω–∏–∫", grade: "", attachmentLinks: [] };
        await window.studentDB.addRecord("student_records", newStudent);
        await this.loadStudents();
        this.currentStudentId = newId;
        this.renderList();
        this.editStudent();
      }

      async saveCurrentStudent() {
        if (!this.currentStudentId) return;

        const form = document.getElementById("dossierForm");
        const formData = new FormData(form);
        const studentIndex = this.students.findIndex((s) => s.id === this.currentStudentId);
        if (studentIndex === -1) return;

        const updatedData = Object.fromEntries(formData.entries());
        const student = this.students[studentIndex];

        // Attachment LINKS (GitHub-friendly)
        const linksText = document.getElementById("attachmentLinksInput").value || "";
        const links = linksText
          .split("\n")
          .map((s) => normalizeImageLink(s))
          .map((s) => (s || "").trim())
          .filter(Boolean)
          .filter((u) => /^https?:\/\//i.test(u));

        updatedData.attachmentLinks = links;

        // If user added links, remove old base64 attachments to prevent confusion/quota
        if (links.length > 0) {
          delete updatedData.attachments;
          delete updatedData.attachment;
          // also wipe from old student object if present
          if (student.attachments) student.attachments = [];
          if (student.attachment) delete student.attachment;
        } else {
          // keep existing links if none typed? (we keep exactly what is typed)
          updatedData.attachmentLinks = [];
        }

        const updatedStudent = { ...student, ...updatedData };
        await window.studentDB.updateRecord("student_records", updatedStudent);

        await this.loadStudents();
        this.loadStudent(this.currentStudentId);
      }

      async deleteStudent() {
        if (!confirm("–î–∞–ª–∏ —Å—Ç–µ —Å–∏–≥—É—Ä–Ω–∏ –¥–µ–∫–∞ —Å–∞–∫–∞—Ç–µ –¥–∞ –≥–æ –∏–∑–±—Ä–∏—à–µ—Ç–µ –æ–≤–æ—ò —É—á–µ–Ω–∏–∫?")) return;
        await window.studentDB.deleteRecord("student_records", this.currentStudentId);
        this.closeStudent();
        await this.loadStudents();
      }

      filterStudents(query) {
        this.renderList(query);
      }

      async exportData() {
        try {
          const json = await window.studentDB.exportBackup();
          const blob = new Blob([json], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `student_db_backup_${new Date().toISOString().slice(0, 10)}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } catch (err) {
          alert("Export failed: " + (err?.message || err));
        }
      }

      async importData(input) {
        const file = input.files[0];
        if (!file) return;

        try {
          const text = await file.text();
          await window.studentDB.importBackup(text);
          await this.loadStudents();
          alert("Backup successfully imported ‚úÖ");
        } catch (err) {
          console.error(err);
          alert("Import failed: " + (err?.message || err));
        } finally {
          input.value = "";
        }
      }

      async exportToJpeg() {
        const element = document.getElementById("previewView");
        if (!element || !window.html2canvas) return;

        const originalStyle = element.style.cssText;
        const originalDisplay = element.style.display;

        element.style.display = "block";
        element.style.background = "white";
        element.style.padding = "40px";
        element.style.width = "800px";
        element.style.margin = "0 auto";
        element.style.color = "black";

        const buttons = element.querySelectorAll("button");
        buttons.forEach((b) => (b.style.display = "none"));

        try {
          const canvas = await html2canvas(element, {
            scale: 2,
            useCORS: true,
            backgroundColor: "#ffffff",
            windowWidth: 1200,
            scrollY: -window.scrollY,
          });

          const student = this.students.find((s) => s.id === this.currentStudentId) || {};
          const link = document.createElement("a");
          link.download = `Dossier_${(student.firstName || "")}_${(student.lastName || "")}.jpg`.replace(/\s+/g, "_");
          link.href = canvas.toDataURL("image/jpeg", 0.9);
          link.click();
        } catch (err) {
          console.error("Export failed:", err);
          alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –µ–∫—Å–ø–æ—Ä—Ç: " + (err?.message || err));
        } finally {
          element.style.cssText = originalStyle;
          element.style.display = originalDisplay;
          buttons.forEach((b) => (b.style.display = ""));
        }
      }
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    const app = new App();
  </script>
</body>
</html>
