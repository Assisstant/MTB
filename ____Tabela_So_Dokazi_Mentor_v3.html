<!DOCTYPE html>
<html lang="mk">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>–¢–∞–±–µ–ª–∞ —Å–æ –¥–æ–∫–∞–∑–∏ - –°—Ç—Ä—É—á–µ–Ω —Å–æ—Ä–∞–±–æ—Ç–Ω–∏–∫ –º–µ–Ω—Ç–æ—Ä</title>
    <style>
        :root {
            --bg: #f5f5f5;
            --bg2: #ffffff;
            --text: #333333;
            --muted: #666666;
            --border: #d2d2d7;
            --primary: #1877f2;
            --primary-lt: #e7f3ff;
            --danger: #ff4444;
            --success: #22c55e;
            --gdrive: #4285f4;
            --cloud: #34a853;
        }

        .dark {
            --bg: #1a1a2e;
            --bg2: #16213e;
            --text: #f5f5f7;
            --muted: #98989d;
            --border: #3a3a5a;
            --primary: #4dabf7;
            --primary-lt: #1e3a5f;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            background: var(--bg);
            color: var(--text);
            font-family: Arial, sans-serif;
            line-height: 1.6;
        }

        body {
            padding: 16px;
            min-height: 100vh;
        }

        /* Format Bar */
        .format-bar {
            display: none;
            position: absolute;
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px;
            gap: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 100;
            flex-wrap: wrap;
            align-items: center;
        }

        .format-bar.visible {
            display: flex;
        }

        .format-bar button {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            background: var(--bg);
            color: var(--text);
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .format-bar button:hover {
            background: var(--primary);
            color: white;
        }

        .format-bar select {
            padding: 6px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text);
        }

        .editable {
            background: transparent;
            border: 2px dashed transparent;
            border-radius: 6px;
            padding: 8px 10px;
            color: var(--text);
            font-family: inherit;
            min-height: 36px;
            transition: all 0.2s;
            outline: none;
        }

        .editable:hover {
            border-color: var(--border);
            background: var(--bg2);
        }

        .editable:focus {
            border-color: var(--primary);
            background: var(--bg2);
            border-style: solid;
        }

        div.editable {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .main-title {
            font-size: 1.6rem;
            font-weight: bold;
            min-height: 40px;
            margin-bottom: 6px;
            text-align: center;
            display: block;
            width: 100%;
        }

        .subtitle {
            font-size: 0.9rem;
            color: var(--muted);
            min-height: 24px;
            margin-bottom: 14px;
            text-align: center;
            display: block;
            width: 100%;
        }

        .controls {
            display: flex;
            position: relative;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 16px;
            padding: 10px 14px;
            background: var(--bg2);
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .btn {
            padding: 7px 14px;
            border-radius: 100px;
            border: none;
            background: var(--bg2);
            color: var(--text);
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-gdrive {
            background: var(--gdrive);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn.active {
            background: var(--primary);
            color: white;
        }

        /* Points display */
        .points-display {
            display: flex;
            align-items: center;
            gap: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 7px 14px;
            border-radius: 100px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .points-label {
            font-size: 11px;
            opacity: 0.9;
        }

        .points-value {
            font-size: 15px;
            min-width: 24px;
            text-align: center;
        }

        .points-separator {
            opacity: 0.7;
        }

        .points-max {
            font-size: 14px;
            opacity: 0.8;
        }

        /* Checkbox for points */
        .points-checkbox-wrap {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 6px;
            padding: 6px 8px;
            background: var(--bg);
            border-radius: 6px;
            border: 1px dashed var(--border);
        }

        .points-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--success);
        }

        .points-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 20px;
        }

        .points-badge.checked {
            background: var(--success);
        }

        .points-label-text {
            font-size: 12px;
            color: var(--muted);
        }

        
        /* Discreet order/number controls (rows + sections) */
        .btn.btn-icon {
            padding: 6px 10px;
            font-size: 12px;
            border: 1px solid var(--border);
            background: var(--bg);
            box-shadow: none;
        }

        .btn.btn-icon:hover {
            transform: none;
            box-shadow: none;
            background: var(--primary-lt);
        }

        .btn.btn-icon.active {
            background: var(--primary);
            color: white;
            border-color: transparent;
        }

        /* Attachment view selector (Explorer-like: Tiles S/M/L + List) */
        .att-view-pop {
            position: absolute;
            top: 58px;
            right: 16px;
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
            display: none;
            z-index: 2000;
            min-width: 240px;
        }

        .att-view-pop.open { display: block; }

        .att-view-pop .row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin: 6px 0;
            flex-wrap: wrap;
        }

        .att-view-pop .lbl {
            font-size: 11px;
            color: var(--muted);
            width: 78px;
            flex: 0 0 auto;
        }

        .att-view-pop button {
            padding: 6px 10px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text);
            cursor: pointer;
            font-size: 12px;
            line-height: 1;
        }

        .att-view-pop button:hover { background: var(--primary-lt); }
        .att-view-pop button.active {
            background: var(--primary);
            color: white;
            border-color: transparent;
        }

        .att-view-pop .hint {
            margin-top: 6px;
            font-size: 11px;
            color: var(--muted);
        }


        th.col-idx,
        td.col-idx {
            width: 56px;
            min-width: 56px;
            max-width: 56px;
            padding: 4px;
            vertical-align: top;
        }

        .idx-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
        }

        .idx-input {
            width: 46px;
            text-align: center;
            padding: 3px 4px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg2);
            color: var(--text);
            font-size: 11px;
            outline: none;
        }

        .idx-input:focus {
            border-color: var(--primary);
        }

        .idx-move {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .move-btn {
            width: 22px;
            height: 18px;
            border: none;
            border-radius: 6px;
            background: var(--bg);
            color: var(--muted);
            cursor: pointer;
            font-size: 9px;
            line-height: 1;
        }

        .move-btn:hover {
            background: var(--primary-lt);
            color: var(--text);
        }

        /* UI Lock (prevents moving rows/sections and changing attachment thumbnail size) */
        .ui-locked .move-btn,
        .ui-locked .sec-move {
            pointer-events: none;
            opacity: 0.25;
        }

        .ui-locked #attViewPop .av-btn {
            pointer-events: none;
            opacity: 0.35;
        }

        .ui-locked #attViewPop .av-btn.active {
            opacity: 0.75;
        }

        .ui-locked #attViewPop .row:first-child .lbl::after {
            content: "  üîí";
            font-size: 12px;
            color: var(--muted);
        }

        /* Lock button states */
        #uiLockBtn.locked {
            background: var(--bg);
            border: 1px solid var(--border);
        }
        .move-btn:disabled {
            opacity: 0.35;
            cursor: default;
        }

        /* Folder access per row */
        .folder-row {
            display: flex;
            align-items: center;
            gap: 2px;
            margin-top: 2px;
        }
        .folder-name-input {
            width: 40px;
            text-align: center;
            padding: 1px 2px;
            border: 1px dashed var(--border);
            border-radius: 4px;
            background: transparent;
            color: var(--muted);
            font-size: 8px;
            outline: none;
        }
        .folder-name-input:focus {
            border-color: var(--primary);
            border-style: solid;
            background: var(--bg2);
            color: var(--text);
        }
        .folder-btn {
            width: 20px;
            height: 20px;
            border: none;
            border-radius: 6px;
            background: var(--bg);
            color: var(--text);
            cursor: pointer;
            font-size: 11px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }
        .folder-btn:hover {
            background: var(--primary-lt);
            transform: scale(1.1);
        }
        .folder-btn.has-folder {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .dark .folder-btn.has-folder {
            background: #1b3a1b;
            color: #66bb6a;
        }

        /* Google Drive upload button in att bar */
        .gdrive-upload-btn {
            padding: 4px 10px;
            border: none;
            border-radius: 6px;
            background: var(--gdrive);
            color: white;
            cursor: pointer;
            font-size: 11px;
            white-space: nowrap;
            transition: all 0.15s;
        }
        .gdrive-upload-btn:hover {
            filter: brightness(1.15);
        }

        /* Folder Browser Modal */
        .folder-modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.45);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        .folder-modal-overlay.active {
            display: flex;
        }
        .folder-modal {
            background: var(--bg2);
            border-radius: 12px;
            width: 620px;
            max-width: 92vw;
            max-height: 75vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 16px 48px rgba(0,0,0,0.25);
            overflow: hidden;
        }
        .folder-modal-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            border-bottom: 1px solid var(--border);
            background: var(--bg);
        }
        .folder-modal-title {
            font-weight: 600;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .folder-modal-actions {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-shrink: 0;
        }
        .folder-modal-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: var(--muted);
            padding: 2px 6px;
            border-radius: 4px;
        }
        .folder-modal-close:hover {
            background: var(--border);
            color: var(--text);
        }
        .folder-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        .folder-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(88px, 1fr));
            gap: 6px;
        }
        .folder-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 4px 6px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            text-align: center;
            border: 1px solid transparent;
        }
        .folder-item:hover {
            background: var(--primary-lt);
            border-color: var(--primary);
        }
        .folder-item-icon {
            width: 48px;
            height: 48px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            margin-bottom: 4px;
            overflow: hidden;
        }
        .folder-item-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }
        .folder-item-icon.type-pdf { background: #fde8e8; color: #e53935; }
        .folder-item-icon.type-img { background: #e8f5e9; color: #2e7d32; }
        .folder-item-icon.type-video { background: #f3e5f5; color: #7b1fa2; }
        .folder-item-icon.type-doc { background: #e3f2fd; color: #1976d2; }
        .folder-item-icon.type-xls { background: #e8f5e9; color: #2e7d32; }
        .folder-item-icon.type-ppt { background: #fbe9e7; color: #d84315; }
        .folder-item-icon.type-other { background: var(--bg); color: var(--muted); }
        .dark .folder-item-icon.type-pdf { background: #3b1515; }
        .dark .folder-item-icon.type-img { background: #1b3a1b; }
        .dark .folder-item-icon.type-video { background: #2a1535; }
        .dark .folder-item-icon.type-doc { background: #152535; }
        .dark .folder-item-icon.type-other { background: var(--bg); }
        .folder-item-name {
            font-size: 10px;
            word-break: break-word;
            line-height: 1.2;
            max-height: 2.4em;
            overflow: hidden;
            color: var(--text);
        }
        .folder-empty {
            text-align: center;
            padding: 30px;
            color: var(--muted);
        }
        .folder-empty-icon {
            font-size: 36px;
            margin-bottom: 8px;
        }
        .folder-connect-btn {
            padding: 6px 14px;
            border: 2px dashed var(--primary);
            border-radius: 8px;
            background: var(--primary-lt);
            color: var(--primary);
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.15s;
        }
        .folder-connect-btn:hover {
            background: var(--primary);
            color: white;
            border-style: solid;
        }
        .folder-status {
            font-size: 10px;
            color: var(--muted);
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--bg);
        }
        .folder-status.connected {
            color: #2e7d32;
            background: #e8f5e9;
        }
        .dark .folder-status.connected {
            color: #66bb6a;
            background: #1b3a1b;
        }

        @media print {
            .folder-row { display: none !important; }
        }

        .sec-head {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sec-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .sec-no {
            width: 44px;
            text-align: center;
            padding: 4px 6px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--bg2);
            color: var(--text);
            font-size: 12px;
            outline: none;
        }

        .sec-no:focus {
            border-color: var(--primary);
        }
.spacer {
            flex: 1;
        }

        .toggle-group {
            display: flex;
            gap: 4px;
            background: var(--bg);
            padding: 4px;
            border-radius: 100px;
        }

        .toggle-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 100px;
            background: transparent;
            color: var(--muted);
            cursor: pointer;
            font-size: 11px;
        }

        .toggle-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Tabs */
        .tabs-container {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 14px;
        }

        .tab {
            padding: 8px 14px;
            border-radius: 10px;
            background: var(--bg2);
            color: var(--text);
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            transition: all 0.2s;
        }

        .tab:hover {
            transform: translateY(-1px);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .tab input {
            background: transparent;
            border: none;
            color: inherit;
            font: inherit;
            width: 100px;
            padding: 2px 4px;
        }

        .tab input:focus {
            outline: none;
        }

        .tab .close-btn {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: inherit;
            cursor: pointer;
            font-size: 14px;
        }

        .tab .close-btn:hover {
            background: var(--danger);
        }

        .add-tab {
            padding: 8px 14px;
            border: 2px dashed var(--border);
            border-radius: 10px;
            background: transparent;
            color: var(--muted);
            cursor: pointer;
            font-size: 12px;
        }

        .add-tab:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Table */
        .table-wrap {
            overflow-x: auto;
            border-radius: 12px;
            background: var(--bg2);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
            table-layout: fixed;
        }

        th,
        td {
            border: 1px solid var(--border);
            padding: 0;
            vertical-align: top;
            overflow: hidden;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        th {
            background: var(--bg);
            font-weight: 600;
        }

        th .editable {
            font-weight: 600;
            text-align: center;
        }

        td .editable {
            min-height: 80px;
            width: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .col-sm {
            width: 22%;
        }

        .col-lg {
            width: 56%;
        }

        /* Attachment Cell */
        .att-cell {
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        

        .cell-stack {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .cell-text {
            /* Scrollable text area */
            min-height: 6em;
            max-height: 9em;
            overflow-y: auto;
            overflow-x: hidden;
            scrollbar-width: thin;
            scrollbar-gutter: stable;
            padding-right: 4px;
        }

        /* Better scrollbar styling for cell-text */
        .cell-text::-webkit-scrollbar {
            width: 8px;
        }

        .cell-text::-webkit-scrollbar-track {
            background: var(--bg);
            border-radius: 4px;
        }

        .cell-text::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .cell-text::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        .dark .cell-text::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.25);
        }

        .dark .cell-text::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        .att-bar {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            align-items: center;
            padding: 8px 10px;
            background: var(--bg);
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px dashed var(--border);
        }

        .att-bar-title {
            width: 100%;
            font-size: 11px;
            color: var(--muted);
            margin-bottom: 4px;
        }

        .att-bar input[type="text"] {
            flex: 1;
            min-width: 130px;
            padding: 6px 12px;
            border: 1px solid var(--border);
            border-radius: 100px;
            background: var(--bg2);
            color: var(--text);
            font-size: 12px;
        }

        .att-bar input[type="text"]:focus {
            outline: none;
            border-color: var(--primary);
        }

        .att-bar input[type="file"] {
            display: none;
        }

        /* Storage Mode Selector */
        .storage-mode {
            display: flex;
            gap: 4px;
            background: var(--bg2);
            padding: 3px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .storage-mode button {
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            background: transparent;
            color: var(--muted);
            cursor: pointer;
            font-size: 11px;
        }

        .storage-mode button.active {
            background: var(--primary);
            color: white;
        }

        .storage-mode button.gdrive.active {
            background: var(--gdrive);
        }

        /* Attachment List (default: Tiles M) */
        .att-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        /* Tiles: S / M / L (Explorer-like sizes) */
        .att-list[data-view="tiles"][data-size="s"] { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
        .att-list[data-view="tiles"][data-size="m"] { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
        .att-list[data-view="tiles"][data-size="l"] { grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); }

        .att-list[data-view="tiles"][data-size="s"] .thumb-box { padding-top: 40%; }
        .att-list[data-view="tiles"][data-size="s"] .thumb-icon-wrap { font-size: 28px; }
        .att-list[data-view="tiles"][data-size="s"] .att-desc { max-height: 50px; }

        /* List view (compact) */
        .att-list[data-view="list"] {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .att-list[data-view="list"] .att-item {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        .att-list[data-view="list"] .thumb-box {
            width: 84px;
            height: 63px;
            padding-top: 0;
            flex: 0 0 auto;
            border-radius: 12px;
        }

        .att-list[data-view="list"] .thumb-content {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .att-list[data-view="list"] .att-info {
            flex: 1;
            background: transparent;
            padding: 0;
        }

        .att-list[data-view="list"] .att-name {
            white-space: normal;
            overflow: visible;
            text-overflow: clip;
            margin-bottom: 4px;
        }

        .att-list[data-view="list"] .att-meta {
            justify-content: flex-start;
            gap: 10px;
        }

        
        /* Keep attachments from growing the table row too tall:
           if there are >2 rows of attachments, the list becomes scrollable (height is set dynamically in JS). */
        .att-list.clamp2 {
            overflow-y: auto;
            overscroll-behavior: contain;
            padding-right: 6px;
            scrollbar-gutter: stable;
        }

        .att-list.clamp2::-webkit-scrollbar { width: 10px; }
        .att-list.clamp2::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.20); border-radius: 10px; }
        .dark .att-list.clamp2::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.25); }
.att-item {
            background: var(--bg2);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
            transition: all 0.2s;
            position: relative;
        }

        .att-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        /* Storage Badge */
        .storage-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 5;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
        }

        .storage-badge.local {
            background: var(--success);
        }

        .storage-badge.cloud {
            background: var(--gdrive);
        }

        .thumb-box {
            position: relative;
            width: 100%;
            padding-top: 56.25%;
            background: #1a1a2e;
            overflow: hidden;
            cursor: pointer;
        }

        .thumb-box:hover .thumb-hover {
            opacity: 1;
        }

        .thumb-content {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .thumb-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .thumb-icon-wrap {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 36px;
        }

        .thumb-icon-wrap.pdf {
            background: linear-gradient(135deg, #e53935 0%, #b71c1c 100%);
        }

        .thumb-icon-wrap.doc {
            background: linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);
        }

        .thumb-icon-wrap.xls {
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
        }

        .thumb-icon-wrap.ppt {
            background: linear-gradient(135deg, #d84315 0%, #bf360c 100%);
        }

        .thumb-icon-wrap.video {
            background: linear-gradient(135deg, #7b1fa2 0%, #4a148c 100%);
        }

        .thumb-icon-wrap.link {
            background: linear-gradient(135deg, #1877f2 0%, #0d47a1 100%);
        }

        .thumb-icon-wrap.file {
            background: linear-gradient(135deg, #546e7a 0%, #37474f 100%);
        }

        .thumb-icon-wrap.gdrive {
            background: linear-gradient(135deg, #4285f4 0%, #1a73e8 100%);
        }

        .thumb-icon-text {
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .yt-play {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 42px;
            background: rgba(255, 0, 0, 0.9);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 2;
        }

        .thumb-box:hover .yt-play {
            background: #ff0000;
            transform: translate(-50%, -50%) scale(1.1);
        }

        .yt-play::after {
            content: '';
            border-style: solid;
            border-width: 8px 0 8px 14px;
            border-color: transparent transparent transparent white;
            margin-left: 3px;
        }

        .thumb-hover {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 3;
        }

        .thumb-hover-text {
            background: white;
            color: #333;
            padding: 8px 16px;
            border-radius: 100px;
            font-size: 12px;
            font-weight: 600;
        }

        .att-info {
            padding: 10px 12px;
            background: var(--bg);
        }

        .att-name {
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 6px;
        }

        .att-desc {
            width: 100%;
            padding: 8px;
            margin-top: 6px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg2);
            color: var(--text);
            font-size: 11px;
            min-height: 40px;
            max-height: 80px;
            overflow-y: auto;
            scrollbar-width: thin;
            font-family: inherit;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Scrollbar for att-desc */
        .att-desc::-webkit-scrollbar {
            width: 6px;
        }

        .att-desc::-webkit-scrollbar-track {
            background: transparent;
        }

        .att-desc::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .att-desc::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        .att-desc[contenteditable="true"]:empty:before {
            content: attr(data-placeholder);
            color: var(--muted);
        }

        .att-desc:focus {
            outline: none;
            border-color: var(--primary);
        }

        .att-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 6px;
        }

        .att-size {
            font-size: 10px;
            color: var(--muted);
        }

        .att-btns {
            display: flex;
            gap: 4px;
        }

        .att-btns button {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 6px;
            border: none;
            background: var(--bg2);
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
        }

        .att-btns button:hover {
            background: var(--primary);
            color: white;
        }

        .att-btns button.del:hover {
            background: var(--danger);
        }

        .empty {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            color: var(--muted);
            font-style: italic;
            background: var(--bg);
            border-radius: 12px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            z-index: 9999;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-box {
            background: var(--bg2);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            resize: both;
            min-width: 400px;
            min-height: 300px;
            max-width: calc(100vw - 40px);
            max-height: calc(100vh - 40px);
        }

        .modal-head {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            cursor: move;
            user-select: none;
            flex-shrink: 0;
        }

        .modal-title {
            font-weight: 600;
            font-size: 14px;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 12px;
        }

        .modal-sizes {
            display: flex;
            gap: 4px;
            margin-right: 12px;
        }

        .modal-size-btn {
            padding: 4px 10px;
            border: none;
            border-radius: 6px;
            background: var(--bg2);
            color: var(--text);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-size-btn:hover,
        .modal-size-btn.active {
            background: var(--primary);
            color: white;
        }

        .modal-link {
            color: var(--primary);
            text-decoration: none;
            font-size: 12px;
            margin-right: 12px;
            white-space: nowrap;
        }

        .modal-link:hover {
            text-decoration: underline;
        }

        .modal-close {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background: var(--danger);
            color: white;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .modal-close:hover {
            background: #cc0000;
        }

        .modal-body {
            flex: 1;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }

        .modal-body iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .modal-body img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .modal-body video {
            max-width: 100%;
            max-height: 100%;
        }

        .modal-box::after {
            content: '‚§°';
            position: absolute;
            bottom: 4px;
            right: 8px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            pointer-events: none;
        }

        /* Google Drive Help Panel */
        .gdrive-help {
            background: var(--primary-lt);
            border: 1px solid var(--gdrive);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .gdrive-help h4 {
            color: var(--gdrive);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .gdrive-help p {
            font-size: 13px;
            color: var(--text);
            margin-bottom: 8px;
        }

        .gdrive-help code {
            background: var(--bg2);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        .gdrive-help .close-help {
            float: right;
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            font-size: 18px;
        }

        .print-link {
            display: none;
        }

        /* Attachment toolbar: hidden by default, shows on hover/click, never prints.
           Toolbar is overlayed (absolute) so it does NOT push thumbnails/videos down. */
        .att-cell {
            position: relative;
        }

        /* Discreet paperclip button */
        .att-toggle {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 22px;
            height: 22px;
            border-radius: 8px;
            border: 1px solid transparent;
            background: transparent;
            color: var(--muted);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            opacity: 0.55;
            transition: opacity 120ms ease, background 120ms ease, border-color 120ms ease, color 120ms ease;
            z-index: 30;
        }

        .att-cell:hover .att-toggle,
        .att-cell.att-open .att-toggle,
        .att-cell:focus-within .att-toggle {
            opacity: 0.95;
        }

        .att-toggle:hover {
            background: var(--bg);
            border-color: var(--border);
            color: var(--text);
        }

        
        /* Toggle icon parts (paperclip + lock when pinned/open) */
        .att-toggle-clip { line-height: 1; }
        .att-toggle-lock { display: none; margin-left: 2px; font-size: 12px; line-height: 1; }

        .att-cell.att-open .att-toggle-lock { display: inline; }

        /* When attachments bar is "locked" open, make the button clearly visible */
        .att-cell.att-open .att-toggle {
            opacity: 1;
            background: var(--primary);
            border-color: var(--primary);
            color: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.12);
        }

        .att-cell.att-open .att-toggle:hover {
            filter: brightness(1.03);
        }
/* Overlay add-attachments bar (appears upward over the text box area) */
        .att-cell .att-bar {
            position: absolute;
            left: 0;
            right: 0;
            bottom: calc(100% + 8px);
            z-index: 40;

            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transform: translateY(6px);

            padding: 12px !important;
            margin: 0 !important;
            border: 2px dashed var(--border) !important;
            background: var(--bg) !important;
            border-radius: 12px;

            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
            transition: opacity 140ms ease, transform 140ms ease, visibility 0ms linear 140ms;
        }

        .att-cell:hover .att-bar,
        .att-cell.att-open .att-bar,
        .att-cell:focus-within .att-bar {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transform: translateY(0);
            transition: opacity 140ms ease, transform 140ms ease, visibility 0ms;
        }

        .print-link {
            display: none;
        }

        @media print {
            body {
                padding: 10mm;
                background: white !important;
                color: black !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .controls,
            .tabs-container,
            .att-bar,
            .att-toggle,
            .btn,
            .toggle-group,
            .add-tab,
            .close-btn,
            .modal-overlay,
            .gdrive-help,
            .att-view-pop,
            .format-bar,
            .video-path-input,
            .video-path-btn {
                display: none !important;
            }

            
            .idx-move,
            .move-btn {
                display: none !important;
            }

            .idx-input,
            .sec-no {
                border: none !important;
                background: transparent !important;
                box-shadow: none !important;
                padding: 0 !important;
                font-weight: bold !important;
            }
.page {
                display: none !important;
            }

            .page.printing {
                display: block !important;
            }

            .main-title,
            .subtitle {
                color: black !important;
            }
            .editable {
                border: none !important;
                padding: 4px !important;
                background: transparent !important;
                color: black !important;
            }

            /* Print: show full text (no 4-line clamp), and hide empty placeholders */
            .cell-text {
                min-height: auto !important;
                max-height: none !important;
                overflow: visible !important;
            }

            /* Hide 'no attachments' placeholder boxes in print (so they don't clutter/cover) */
            .empty {
                display: none !important;
            }

            /* Ensure attachment descriptions are not clamped and don't show placeholder text */
            .att-desc {
                max-height: none !important;
                overflow: visible !important;
            }

            .att-desc[contenteditable="true"]:empty:before {
                content: "" !important;
            }

            /* Expand scroll-clamped attachment lists in print */
            .att-list.clamp2 {
                max-height: none !important;
                height: auto !important;
                overflow: visible !important;
            }

            .table-wrap {
                box-shadow: none;
                overflow: visible;
            }

            table {
                min-width: 100% !important;
                border-collapse: collapse;
            }

            th,
            td {
                border: 2px solid #333 !important;
                overflow: visible !important;
                padding: 8px !important;
                overflow: visible !important;
                vertical-align: top;
                overflow: visible !important;
            }

            th {
                background: #e0e0e0 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .att-cell {
                padding: 10px !important;
            }

            .att-list {
                display: block !important;
                max-height: none !important;
                overflow: visible !important;
            }

            .att-item {
                display: block !important;
                margin-bottom: 15px;
                page-break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ccc;
                border-radius: 8px;
                padding: 10px;
                background: #f9f9f9 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .thumb-box {
                display: inline-block !important;
                width: 60px !important;
                height: 45px !important;
                padding-top: 0 !important;
                vertical-align: middle;
                margin-right: 10px;
            }

            .thumb-content {
                position: relative !important;
                width: 60px !important;
                height: 45px !important;
            }

            .thumb-icon-wrap {
                font-size: 24px !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .thumb-hover,
            .yt-play,
            .storage-badge,
            .att-btns {
                display: none !important;
            }

            .att-info {
                display: block !important;
                background: transparent !important;
                padding: 5px 0 !important;
            }

            .att-name {
                font-size: 11px !important;
                font-weight: bold !important;
                color: black !important;
                white-space: normal !important;
                overflow: visible !important;
            }

            .att-desc {
                display: block !important;
                border: 1px solid #ccc !important;
                background: white !important;
                color: black !important;
                font-size: 10px !important;
                min-height: 30px !important;
                max-height: none !important;
                padding: 5px !important;
                overflow: visible !important;
            }

            /* Print attachment mode:
               - compact: show name + link only (no description box)
               - text: hide thumbnails (keeps name + description + link)
            */
            body[data-print-att="compact"] .att-desc {
                display: none !important;
            }
            body[data-print-att="compact"] .att-item {
                padding: 8px 10px !important;
            }

            body[data-print-att="text"] .thumb-box,
            body[data-print-att="text"] .thumb-content,
            body[data-print-att="text"] .thumb-icon-wrap {
                display: none !important;
            }


            .att-meta {
                display: none !important;
            }

            /* Show clickable link URLs after attachment items */
            .att-item::after {
                content: "";
                /* Disable pseudo-element as we use real element now */
                display: none;
            }

            /* Print link for attachments */
            .print-link {
                display: block !important;
                font-size: 10px !important;
                color: #0000EE !important;
                word-break: break-all;
                margin-top: 5px;
                text-decoration: underline !important;
                cursor: pointer;
            }

            .att-item {
                overflow: visible !important;
            }

            a {
                color: #0000EE !important;
                text-decoration: underline !important;
            }

            /* Ensure colors print */
            .thumb-icon-wrap.pdf {
                background: #e53935 !important;
            }

            .thumb-icon-wrap.video {
                background: #7b1fa2 !important;
            }

            .thumb-icon-wrap.doc {
                background: #1976d2 !important;
            }

            .thumb-icon-wrap.xls {
                background: #2e7d32 !important;
            }

            .thumb-icon-wrap.ppt {
                background: #d84315 !important;
            }

            .thumb-icon-wrap.link {
                background: #1877f2 !important;
            }

            .thumb-icon-wrap.file {
                background: #546e7a !important;
            }

            .thumb-icon-wrap.gdrive {
                background: #4285f4 !important;
            }

            .section-divider {
                background: #e0e0e0;
                padding: 10px;
                font-weight: bold;
                font-size: 1.2rem;
                margin-top: 20px;
                margin-bottom: 10px;
                border-radius: 8px;
                border: 1px solid #ccc;
                break-inside: avoid;
            }

            .section-controls {
                display: flex;
                justify-content: flex-end;
                gap: 8px;
                margin-top: 4px;
            }

            @media print {
                .section-divider {
                    background: transparent !important;
                    border: none !important;
                    border-bottom: 2px solid #000 !important;
                    color: black !important;
                    margin-top: 30px !important;
                }

                .section-controls {
                    display: none !important;
                }
                
                /* Points checkbox print styles */
                .points-checkbox-wrap {
                    background: #f0f0f0 !important;
                    border: 1px solid #999 !important;
                    -webkit-print-color-adjust: exact !important;
                    print-color-adjust: exact !important;
                }
                
                .points-badge {
                    background: #1877f2 !important;
                    -webkit-print-color-adjust: exact !important;
                    print-color-adjust: exact !important;
                }
                
                .points-badge.checked {
                    background: #22c55e !important;
                }
                
                .points-display {
                    display: none !important;
                }
            }
        }
    </style>
</head>

<body>
    <!-- Help Panel -->
    <div class="gdrive-help" id="gdriveHelp" style="display:none; max-width:600px;">
        <button class="close-help" onclick="this.parentElement.style.display='none'">√ó</button>
        <h4 style="margin-bottom:15px; border-bottom:1px solid var(--border); padding-bottom:10px;">‚ùì –£–ø–∞—Ç—Å—Ç–≤–æ –∑–∞
            –∫–æ—Ä–∏—Å—Ç–µ—ö–µ</h4>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <div>
                <h5 style="color:var(--primary); margin-bottom:8px;">üìé –î–æ–¥–∞–≤–∞—ö–µ –ü—Ä–∏–ª–æ–∑–∏</h5>
                <p><strong>1. Smart Input –ø–æ–ª–µ:</strong></p>
                <ul style="padding-left:20px; font-size:13px; margin-bottom:10px; color:var(--text);">
                    <li><strong>–õ–∏–Ω–∫–æ–≤–∏:</strong> –ó–∞–ª–µ–ø–∏ URL (YouTube, Drive, Web) –∏ –ø—Ä–∏—Ç–∏—Å–Ω–∏ Enter.</li>
                    <li><strong>–§–æ–ª–¥–µ—Ä–∏:</strong> –ó–∞–ª–µ–ø–∏ –ø–∞—Ç–µ–∫–∞ (–ø—Ä. <code>documents/</code>) –∑–∞ –ª–∏–Ω–∫ –¥–æ —Ñ–æ–ª–¥–µ—Ä.</li>
                    <li><strong>–õ–æ–∫–∞–ª–Ω–∏ –≤–∏–¥–µ–∞:</strong> –ó–∞–ª–µ–ø–∏ –ø–∞—Ç–µ–∫–∞ (–ø—Ä. <code>videos/video.mp4</code>).</li>
                </ul>
                <p><strong>2. –õ–æ–∫–∞–ª–Ω–∏ –§–∞—ò–ª–æ–≤–∏:</strong></p>
                <p>–ö–ª–∏–∫–Ω–∏ –Ω–∞ –∫–æ–ø—á–µ—Ç–æ üìÇ –∑–∞ –¥–∞ –∏–∑–±–µ—Ä–µ—à —Ñ–∞—ò–ª –æ–¥ —Ç–≤–æ—ò–æ—Ç –∫–æ–º–ø—ò—É—Ç–µ—Ä.</p>
            </div>

            <div>
                <h5 style="color:var(--gdrive); margin-bottom:8px;">‚òÅÔ∏è Google Drive</h5>
                <p><strong>–ö–∞–∫–æ –¥–∞ —Å–ø–æ–¥–µ–ª–∏—à —Ñ–∞—ò–ª:</strong></p>
                <ol style="padding-left:20px; font-size:13px; color:var(--text);">
                    <li>–î–µ—Å–µ–Ω –∫–ª–∏–∫ –Ω–∞ —Ñ–∞—ò–ª–æ—Ç –≤–æ Drive</li>
                    <li>–û–¥–±–µ—Ä–∏ <strong>"Share"</strong> ‚Üí <strong>"Copy Link"</strong></li>
                    <li>–ü—Ä–æ–≤–µ—Ä–∏ –¥–∞–ª–∏ –µ <strong>"Anyone with the link"</strong></li>
                    <li>–ó–∞–ª–µ–ø–∏ –≥–æ –ª–∏–Ω–∫–æ—Ç –≤–æ Smart –ø–æ–ª–µ—Ç–æ</li>
                </ol>
            </div>
        </div>
        <div style="margin-top:15px; background:var(--bg2); padding:10px; border-radius:8px; font-size:12px;">
            üí° <strong>–°–æ–≤–µ—Ç –∑–∞ USB:</strong> –ß—É–≤–∞—ò –≥–∏ –≤–∏–¥–µ–∞—Ç–∞ –≤–æ —Ñ–æ–ª–¥–µ—Ä –¥–æ HTML —Ñ–∞—ò–ª–æ—Ç (–ø—Ä. <code>videos/</code>) –∑–∞ –¥–∞
            —Ä–∞–±–æ—Ç–∞—Ç –Ω–∞ –±–∏–ª–æ –∫–æ—ò –∫–æ–º–ø—ò—É—Ç–µ—Ä —Å–æ —Ä–µ–ª–∞—Ç–∏–≤–Ω–∞ –ø–∞—Ç–µ–∫–∞.
        </div>
        <div style="margin-top:10px; background:var(--bg2); padding:10px; border-radius:8px; font-size:12px;">
            üìÅ <strong>–§–æ–ª–¥–µ—Ä–∏ –ø–æ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏:</strong>
            <ol style="padding-left:20px; margin-top:5px;">
                <li>–ö–ª–∏–∫–Ω–∏ <strong>üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞</strong> ‚Üí —Å–µ –≥–µ–Ω–µ—Ä–∏—Ä–∞ .bat —Å–∫—Ä–∏–ø—Ç–∞</li>
                <li>–°—Ç–∞–≤–∏ —ò–∞ .bat –≤–æ —Ñ–æ–ª–¥–µ—Ä–æ—Ç –∫–∞–¥–µ –µ HTML-–æ—Ç</li>
                <li>–°—Ç–∞—Ä—Ç—É–≤–∞—ò —ò–∞ ‚Üí —Å–µ –∫—Ä–µ–∏—Ä–∞–∞—Ç —Å–∏—Ç–µ —Ñ–æ–ª–¥–µ—Ä–∏ (1.1.1, 1.1.2, –∏—Ç–Ω.)</li>
                <li>–°—Ç–∞–≤–∏ –¥–æ–∫–∞–∑–∏ –≤–æ —Å–æ–æ–¥–≤–µ—Ç–Ω–∏—Ç–µ —Ñ–æ–ª–¥–µ—Ä–∏</li>
                <li>üìÇ –∫–æ–ø—á–µ—Ç–æ –≤–æ —Å–µ–∫–æ—ò —Ä–µ–¥ –≥–∏ –æ—Ç–≤–æ—Ä–∞</li>
            </ol>
        </div>
        <div style="margin-top:10px; background:var(--bg2); padding:10px; border-radius:8px; font-size:12px;">
            ‚òÅÔ∏è <strong>Google Drive Upload:</strong> –°–µ–∫–æ—ò–∞ —ú–µ–ª–∏—ò–∞ –∏–º–∞ ‚ÜëDrive –∫–æ–ø—á–µ. –ö–ª–∏–∫–Ω–∏ ‚Üí —Å–µ –æ—Ç–≤–æ—Ä–∞ Drive –∑–∞ upload. –õ–∏–Ω–∫–æ—Ç –ø–æ—Ç–æ–∞ –∑–∞–ª–µ–ø–∏ –≥–æ –≤–æ Smart –ø–æ–ª–µ—Ç–æ.
        </div>
    </div>

    <!-- Format Bar -->
    <div class="format-bar" id="formatBar">
        <button onclick="formatText('bold')" title="Bold"><b>B</b></button>
        <button onclick="formatText('italic')" title="Italic"><i>I</i></button>
        <button onclick="formatText('underline')" title="Underline"><u>U</u></button>
        <select onchange="formatBlock(this.value); this.selectedIndex=0;">
            <option value="">–°—Ç–∏–ª</option>
            <option value="h1">H1</option>
            <option value="h2">H2</option>
            <option value="h3">H3</option>
            <option value="p">–ü–∞—Ä–∞–≥—Ä–∞—Ñ</option>
        </select>
        <select onchange="changeFontSize(this.value); this.selectedIndex=0;">
            <option value="">–ì–æ–ª–µ–º–∏–Ω–∞</option>
            <option value="1">–ú–∞–ª–∞</option>
            <option value="3">–ù–æ—Ä–º–∞–ª–Ω–∞</option>
            <option value="5">–ì–æ–ª–µ–º–∞</option>
            <option value="7">–û–≥—Ä–æ–º–Ω–∞</option>
        </select>
        <input type="color" onchange="changeColor(this.value)" title="–ë–æ—ò–∞"
            style="width:32px;height:32px;border:none;cursor:pointer;">
        <button onclick="formatText('justifyLeft')" title="–õ–µ–≤–æ">‚¨Ö</button>
        <button onclick="formatText('justifyCenter')" title="–¶–µ–Ω—Ç–∞—Ä">‚¨õ</button>
        <button onclick="formatText('justifyRight')" title="–î–µ—Å–Ω–æ">‚û°</button>
    </div>

    <div contenteditable="true" class="editable main-title" id="mainTitle">–¢–∞–±–µ–ª–∞ —Å–æ –¥–æ–∫–∞–∑–∏</div>
    <div contenteditable="true" class="editable subtitle" id="subtitle">–û—Ü–µ–Ω–∫–∞ –∑–∞ –∏—Å–ø–æ–ª–Ω–µ—Ç–æ—Å—Ç–∞ –Ω–∞ –ø—Ä–æ—Ñ–µ—Å–∏–æ–Ω–∞–ª–Ω–∏—Ç–µ —Å—Ç–∞–Ω–¥–∞—Ä–¥–∏ –∑–∞ —Å—Ç—Ä—É—á–µ–Ω —Å–æ—Ä–∞–±–æ—Ç–Ω–∏–∫ - –º–µ–Ω—Ç–æ—Ä</div>

    <div class="controls">
        <div class="toggle-group">
            <button class="toggle-btn active" data-lang="mk">MK</button>
            <button class="toggle-btn" data-lang="en">EN</button>
        </div>
        <div class="toggle-group">
            <button class="toggle-btn active" data-theme="light">‚òÄÔ∏è</button>
            <button class="toggle-btn" data-theme="dark">üåô</button>
        </div>
        <button class="btn btn-primary" id="helpBtn">‚ùì –ü–æ–º–æ—à</button>
        <button class="btn btn-icon" id="uiLockBtn" title="–ó–∞–∫–ª—É—á–∏/–û—Ç–∫–ª—É—á–∏ —Ä–∞—Å–ø–æ—Ä–µ–¥ –∏ –≥–æ–ª–µ–º–∏–Ω–∞ –Ω–∞ –ø—Ä–∏–ª–æ–∑–∏">üîì</button>
        <button class="btn btn-icon" id="toggleOrderBtn" title="–ù—É–º–µ—Ä–∞—Ü–∏—ò–∞ –∏ —Ä–µ–¥–æ—Å–ª–µ–¥">‚Ññ</button>
        <button class="btn btn-icon" id="attViewBtn" title="–ü—Ä–∏–∫–∞–∑ –Ω–∞ –ø—Ä–∏–ª–æ–∑–∏">‚ñ¶</button>
        <div class="points-display" id="pointsDisplay">
            <span class="points-label">–ë–æ–¥–æ–≤–∏:</span>
            <span class="points-value" id="pointsValue">0</span>
            <span class="points-separator">/</span>
            <span class="points-max">80</span>
        </div>
        <div class="spacer"></div>
        <button class="btn btn-success" id="printBtn">üñ®Ô∏è –ü–µ—á–∞—Ç–∏</button>
        <button class="btn" id="genStructBtn" title="–ì–µ–Ω–µ—Ä–∏—Ä–∞—ò BAT —Å–∫—Ä–∏–ø—Ç–∞ –∑–∞ –∫—Ä–µ–∏—Ä–∞—ö–µ —Ñ–æ–ª–¥–µ—Ä–∏">üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞</button>
        <button class="btn" id="connectFolderTopBtn" title="–ü–æ–≤—Ä–∑–∏ –≥–æ –≥–ª–∞–≤–Ω–∏–æ—Ç —Ñ–æ–ª–¥–µ—Ä –∑–∞ –ø—Ä–µ–≥–ª–µ–¥ –Ω–∞ –¥–æ–∫–∞–∑–∏">üìÇ –ü–æ–≤—Ä–∑–∏</button>
        <button class="btn" id="exportHtmlBtn">üìÑ HTML</button>
        <button class="btn" id="exportJsonBtn">üíæ JSON</button>
        <button class="btn" id="importJsonBtn">üìÇ –í–Ω–µ—Å–∏</button>
        <input type="file" id="importFile" accept=".json" hidden>
    </div>

    <div class="att-view-pop" id="attViewPop" aria-hidden="true">
        <div class="row">
            <span class="lbl">–ü—Ä–∏–ª–æ–∑–∏</span>
            <button type="button" class="av-btn" data-view="tiles" data-size="s" title="Tiles S">S</button>
            <button type="button" class="av-btn" data-view="tiles" data-size="m" title="Tiles M">M</button>
            <button type="button" class="av-btn" data-view="tiles" data-size="l" title="Tiles L">L</button>
            <button type="button" class="av-btn" data-view="list" title="List">‚â°</button>
        </div>
        <div class="row">
            <span class="lbl">–ü–µ—á–∞—Ç–∏</span>
            <button type="button" class="pv-btn" data-print="compact" title="–ö–æ–º–ø–∞–∫—Ç–Ω–æ (–±–µ–∑ –æ–ø–∏—Å)">–°–ø–∏—Å–æ–∫</button>
            <button type="button" class="pv-btn" data-print="text" title="–¢–µ–∫—Å—Ç (–±–µ–∑ —Å–ª–∏–∫–∏)">–¢–µ–∫—Å—Ç</button>
            <button type="button" class="pv-btn" data-print="full" title="–ö–∞—Ä—Ç–∏—á–∫–∏ (—Å–æ –æ–ø–∏—Å –∏ —Å–ª–∏–∫–∏)">–ö–∞—Ä—Ç–∏—á–∫–∏</button>
        </div>
        <div class="hint">‚ñ¶ –≤–ª–∏—ò–∞–µ –Ω–∞ —Å–∏—Ç–µ –ø—Ä–∏–ª–æ–∑–∏. –ü–µ—á–∞—Ç–µ—ö–µ: –∏–∑–±–µ—Ä–∏ –∫–∞–∫–æ –¥–∞ —Å–µ –ø—Ä–∏–∫–∞–∂—É–≤–∞–∞—Ç.</div>
    </div>

    <div class="tabs-container" id="tabs"></div>
    <div id="pages"></div>

    <!-- Folder Browser Modal -->
    <div class="folder-modal-overlay" id="folderModal">
        <div class="folder-modal">
            <div class="folder-modal-head">
                <span class="folder-modal-title">
                    <span>üìÇ</span>
                    <span id="folderModalTitle">–§–æ–ª–¥–µ—Ä</span>
                </span>
                <div class="folder-modal-actions">
                    <span class="folder-status" id="folderStatus">–ù–µ –µ –ø–æ–≤—Ä–∑–∞–Ω–æ</span>
                    <button class="folder-connect-btn" id="folderConnectBtn">üìÅ –ü–æ–≤—Ä–∑–∏ —Ñ–æ–ª–¥–µ—Ä</button>
                    <button class="folder-modal-close" id="folderModalClose">√ó</button>
                </div>
            </div>
            <div class="folder-modal-body" id="folderModalBody">
                <div class="folder-empty">
                    <div class="folder-empty-icon">üìÅ</div>
                    <p>–ö–ª–∏–∫–Ω–∏ <strong>üìÅ –ü–æ–≤—Ä–∑–∏ —Ñ–æ–ª–¥–µ—Ä</strong> –∑–∞ –¥–∞ –≥–æ –∏–∑–±–µ—Ä–µ—à –≥–ª–∞–≤–Ω–∏–æ—Ç —Ñ–æ–ª–¥–µ—Ä –∫–∞–¥–µ —Å–µ –Ω–∞–æ—ì–∞–∞—Ç —Å–∏—Ç–µ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏.</p>
                    <p style="margin-top:8px;font-size:12px;color:var(--muted)">–ü–æ—Ç—Ä–µ–±–Ω–æ –µ –µ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ ‚Äî –ø–æ—Ç–æ–∞ üìÇ –∫–æ–ø—á–∏—ö–∞—Ç–∞ —ú–µ —Ä–∞–±–æ—Ç–∞—Ç –¥–∏—Ä–µ–∫—Ç–Ω–æ.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal-overlay" id="modal">
        <div class="modal-box" id="modalBox" style="width:800px;height:500px;">
            <div class="modal-head" id="modalHead">
                <span class="modal-title" id="modalTitle">Preview</span>
                <div class="modal-sizes">
                    <button class="modal-size-btn" data-w="500" data-h="350">S</button>
                    <button class="modal-size-btn active" data-w="800" data-h="500">M</button>
                    <button class="modal-size-btn" data-w="1100" data-h="700">L</button>
                    <button class="modal-size-btn" data-w="full" data-h="full">‚õ∂</button>
                </div>
                <a href="#" target="_blank" class="modal-link" id="modalLink">‚Üó –û—Ç–≤–æ—Ä–∏</a>
                <button class="modal-close" id="modalClose">√ó</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script type="application/json" id="embeddedState"></script>

    <script>
        (function () {
            "use strict";

            // ======== File System Access API - Folder Browser ========
            var rootDirHandle = null; // Stores the root directory handle for the session

            function getFileIcon(name) {
                var ext = name.split(".").pop().toLowerCase();
                if (["jpg","jpeg","png","gif","webp","bmp","svg"].indexOf(ext) >= 0) return { icon: "üñºÔ∏è", type: "img" };
                if (ext === "pdf") return { icon: "üìÑ", type: "pdf" };
                if (["mp4","avi","mkv","mov","webm"].indexOf(ext) >= 0) return { icon: "üé¨", type: "video" };
                if (["doc","docx","odt","txt","rtf"].indexOf(ext) >= 0) return { icon: "üìù", type: "doc" };
                if (["xls","xlsx","csv","ods"].indexOf(ext) >= 0) return { icon: "üìä", type: "xls" };
                if (["ppt","pptx","odp"].indexOf(ext) >= 0) return { icon: "üìΩÔ∏è", type: "ppt" };
                if (["mp3","wav","ogg","flac"].indexOf(ext) >= 0) return { icon: "üéµ", type: "other" };
                if (["zip","rar","7z"].indexOf(ext) >= 0) return { icon: "üì¶", type: "other" };
                return { icon: "üìé", type: "other" };
            }

            async function connectRootFolder() {
                try {
                    rootDirHandle = await window.showDirectoryPicker({ mode: "read" });
                    var statusEl = document.getElementById("folderStatus");
                    if (statusEl) {
                        statusEl.textContent = "‚úì " + rootDirHandle.name;
                        statusEl.className = "folder-status connected";
                    }
                    return true;
                } catch (e) {
                    if (e.name !== "AbortError") console.error("Folder connect error:", e);
                    return false;
                }
            }

            async function findSubfolder(targetName) {
                if (!rootDirHandle) return null;
                // Try exact match first
                try {
                    return await rootDirHandle.getDirectoryHandle(targetName);
                } catch (e) { /* not found, try prefix match */ }
                // Try prefix match (e.g. "1.1.1" matches "1.1.1 - –à–∞ –ø—Ä–æ—Ü–µ–Ω—É–≤–∞...")
                try {
                    for await (var entry of rootDirHandle.values()) {
                        if (entry.kind === "directory" && entry.name.indexOf(targetName) === 0) {
                            return entry;
                        }
                    }
                } catch (e) { console.error("Subfolder search error:", e); }
                return null;
            }

            async function listFolderContents(dirHandle) {
                var files = [];
                try {
                    for await (var entry of dirHandle.values()) {
                        if (entry.kind === "file") {
                            var fi = getFileIcon(entry.name);
                            var fileData = { name: entry.name, icon: fi.icon, type: fi.type, handle: entry };
                            // For images, generate a thumbnail URL
                            if (fi.type === "img") {
                                try {
                                    var file = await entry.getFile();
                                    fileData.thumbUrl = URL.createObjectURL(file);
                                    fileData.size = file.size;
                                } catch (e) { /* ignore */ }
                            } else {
                                try {
                                    var f2 = await entry.getFile();
                                    fileData.size = f2.size;
                                } catch (e) { /* ignore */ }
                            }
                            files.push(fileData);
                        }
                    }
                } catch (e) { console.error("List error:", e); }
                files.sort(function (a, b) { return a.name.localeCompare(b.name); });
                return files;
            }

            function formatSize(bytes) {
                if (!bytes) return "";
                if (bytes < 1024) return bytes + " B";
                if (bytes < 1048576) return (bytes / 1024).toFixed(1) + " KB";
                return (bytes / 1048576).toFixed(1) + " MB";
            }

            async function openFileFromHandle(handle) {
                try {
                    var file = await handle.getFile();
                    var url = URL.createObjectURL(file);
                    // Use existing modal for preview
                    var ext = file.name.split(".").pop().toLowerCase();
                    var modalBody = document.getElementById("modalBody");
                    var modalTitle = document.getElementById("modalTitle");
                    var modalLink = document.getElementById("modalLink");
                    var modal = document.getElementById("modal");

                    modalTitle.textContent = file.name;
                    modalLink.href = url;
                    modalLink.style.display = "inline";

                    if (["jpg","jpeg","png","gif","webp","bmp","svg"].indexOf(ext) >= 0) {
                        modalBody.innerHTML = '<img src="' + url + '" style="max-width:100%;max-height:100%;object-fit:contain;">';
                    } else if (ext === "pdf") {
                        modalBody.innerHTML = '<iframe src="' + url + '" style="width:100%;height:100%;border:none;"></iframe>';
                    } else if (["mp4","webm","mov"].indexOf(ext) >= 0) {
                        modalBody.innerHTML = '<video controls style="max-width:100%;max-height:100%;"><source src="' + url + '"></video>';
                    } else if (["mp3","wav","ogg"].indexOf(ext) >= 0) {
                        modalBody.innerHTML = '<div style="padding:40px;text-align:center;"><p style="font-size:48px;margin-bottom:20px;">üéµ</p><audio controls src="' + url + '"></audio></div>';
                    } else {
                        // For other files, just offer download
                        modalBody.innerHTML = '<div style="padding:40px;text-align:center;"><p style="font-size:48px;margin-bottom:20px;">' + getFileIcon(file.name).icon + '</p><p>' + file.name + '</p><p style="color:var(--muted)">' + formatSize(file.size) + '</p><br><a href="' + url + '" download="' + file.name + '" style="padding:10px 20px;background:var(--primary);color:white;border-radius:8px;text-decoration:none;">‚¨á –ü—Ä–µ–∑–µ–º–∏</a></div>';
                    }

                    // Close folder modal, show preview modal
                    document.getElementById("folderModal").classList.remove("active");
                    modal.classList.add("active");
                } catch (e) {
                    console.error("Open file error:", e);
                    alert("–ù–µ –º–æ–∂–µ –¥–∞ —Å–µ –æ—Ç–≤–æ—Ä–∏: " + e.message);
                }
            }

            function renderFolderContents(files, folderName) {
                var body = document.getElementById("folderModalBody");
                if (!files.length) {
                    body.innerHTML = '<div class="folder-empty"><div class="folder-empty-icon">üìÇ</div><p>–§–æ–ª–¥–µ—Ä–æ—Ç <strong>' + folderName + '</strong> –µ –ø—Ä–∞–∑–µ–Ω.</p><p style="margin-top:8px;font-size:12px;color:var(--muted)">–°—Ç–∞–≤–∏ –¥–æ–∫–∞–∑–∏ (—Å–ª–∏–∫–∏, PDF, –≤–∏–¥–µ–∞) –≤–æ –æ–≤–æ—ò —Ñ–æ–ª–¥–µ—Ä.</p></div>';
                    return;
                }

                var grid = document.createElement("div");
                grid.className = "folder-grid";

                files.forEach(function (f) {
                    var item = document.createElement("div");
                    item.className = "folder-item";
                    item.title = f.name + (f.size ? " (" + formatSize(f.size) + ")" : "");

                    var iconDiv = document.createElement("div");
                    iconDiv.className = "folder-item-icon type-" + f.type;

                    if (f.thumbUrl) {
                        var img = document.createElement("img");
                        img.src = f.thumbUrl;
                        img.alt = f.name;
                        iconDiv.appendChild(img);
                    } else {
                        iconDiv.textContent = f.icon;
                    }

                    var nameDiv = document.createElement("div");
                    nameDiv.className = "folder-item-name";
                    nameDiv.textContent = f.name;

                    item.appendChild(iconDiv);
                    item.appendChild(nameDiv);

                    item.addEventListener("click", function () {
                        openFileFromHandle(f.handle);
                    });

                    grid.appendChild(item);
                });

                body.innerHTML = "";
                // File count bar
                var countBar = document.createElement("div");
                countBar.style.cssText = "margin-bottom:12px;font-size:12px;color:var(--muted);display:flex;justify-content:space-between;";
                countBar.innerHTML = "<span>" + files.length + " —Ñ–∞—ò–ª" + (files.length > 1 ? "–æ–≤–∏" : "") + "</span><span>–ö–ª–∏–∫–Ω–∏ –∑–∞ –ø—Ä–µ–≥–ª–µ–¥</span>";
                body.appendChild(countBar);
                body.appendChild(grid);
            }

            async function openFolderBrowser(folderName, autoNo) {
                var modal = document.getElementById("folderModal");
                var titleEl = document.getElementById("folderModalTitle");
                titleEl.textContent = folderName;
                modal.classList.add("active");

                if (!rootDirHandle) {
                    // Show connect prompt
                    var body = document.getElementById("folderModalBody");
                    body.innerHTML = '<div class="folder-empty"><div class="folder-empty-icon">üìÅ</div><p>–ö–ª–∏–∫–Ω–∏ <strong>üìÅ –ü–æ–≤—Ä–∑–∏ —Ñ–æ–ª–¥–µ—Ä</strong> –∑–∞ –¥–∞ –≥–æ –∏–∑–±–µ—Ä–µ—à –≥–ª–∞–≤–Ω–∏–æ—Ç —Ñ–æ–ª–¥–µ—Ä.</p><p style="margin-top:8px;font-size:12px;color:var(--muted)">–ò–∑–±–µ—Ä–∏ –≥–æ —Ñ–æ–ª–¥–µ—Ä–æ—Ç –∫–∞–¥–µ —Å–µ –Ω–∞–æ—ì–∞ HTML —Ñ–∞—ò–ª–æ—Ç –∏ —Å–∏—Ç–µ –ø–æ–¥—Ñ–æ–ª–¥–µ—Ä–∏ (1.1.1, 1.1.2, –∏—Ç–Ω.)</p></div>';
                    return;
                }

                // Show loading
                var body = document.getElementById("folderModalBody");
                body.innerHTML = '<div class="folder-empty"><div class="folder-empty-icon">‚è≥</div><p>–ß–∏—Ç–∞–º...</p></div>';

                // Find the subfolder - try autoNo first (e.g. "1.1.1"), it will prefix-match "1.1.1 - –à–∞ –ø—Ä–æ—Ü–µ–Ω—É–≤–∞..."
                var subDir = await findSubfolder(autoNo);
                if (!subDir && folderName !== autoNo) {
                    subDir = await findSubfolder(folderName);
                }

                if (!subDir) {
                    body.innerHTML = '<div class="folder-empty"><div class="folder-empty-icon">‚ùå</div><p>–§–æ–ª–¥–µ—Ä–æ—Ç <strong>' + autoNo + '</strong> –Ω–µ –µ –ø—Ä–æ–Ω–∞—ò–¥–µ–Ω.</p><p style="margin-top:8px;font-size:12px;">–ü—Ä–æ–≤–µ—Ä–∏ –¥–∞–ª–∏ –ø–æ—Å—Ç–æ–∏ —Ñ–æ–ª–¥–µ—Ä –∫–æ—ò –ø–æ—á–Ω—É–≤–∞ —Å–æ <code>' + autoNo + '</code> –≤–æ –ø–æ–≤—Ä–∑–∞–Ω–∏–æ—Ç —Ñ–æ–ª–¥–µ—Ä.</p></div>';
                    return;
                }

                titleEl.textContent = subDir.name;
                var files = await listFolderContents(subDir);
                renderFolderContents(files, subDir.name);
            }

            // Wire up modal close and connect buttons
            document.addEventListener("DOMContentLoaded", function () {
                var closeBtn = document.getElementById("folderModalClose");
                if (closeBtn) closeBtn.addEventListener("click", function () {
                    document.getElementById("folderModal").classList.remove("active");
                });
                document.getElementById("folderModal").addEventListener("click", function (e) {
                    if (e.target === this) this.classList.remove("active");
                });
                var connectBtn = document.getElementById("folderConnectBtn");
                if (connectBtn) connectBtn.addEventListener("click", async function () {
                    var ok = await connectRootFolder();
                    if (ok) {
                        // Re-trigger browse for current folder if one was open
                        var title = document.getElementById("folderModalTitle").textContent;
                        if (title && title !== "–§–æ–ª–¥–µ—Ä") {
                            openFolderBrowser(title, title.split(" ")[0]);
                        }
                    }
                });
            });
            // ======== End Folder Browser ========

            var LANG = {
                mk: {
                    addPage: "+ –°—Ç—Ä–∞–Ω–∏—Ü–∞", addRow: "+ –†–µ–¥",
                    addFileLocal: "üìé –õ–æ–∫–∞–ª–µ–Ω", addFileCloud: "‚òÅÔ∏è Drive –ª–∏–Ω–∫",
                    addLink: "üîó –õ–∏–Ω–∫", deleteRow: "üóëÔ∏è",
                    addLocalVideo: "üé¨ –í–∏–¥–µ–æ (–ø–∞—Ç–µ–∫–∞)",
                    col1: "–ö–æ–ª–æ–Ω–∞ 1", col2: "–ö–æ–ª–æ–Ω–∞ 2", col3: "–ü—Ä–∏–ª–æ–∑–∏",
                    urlPlaceholder: "–ó–∞–ª–µ–ø–∏ URL, –ø–∞—Ç–µ–∫–∞ –∏–ª–∏ —Ñ–æ–ª–¥–µ—Ä...",
                    localVideoPlaceholder: "videos/video.mp4",
                    noAtt: "–ù–µ–º–∞ –ø—Ä–∏–ª–æ–∑–∏. –î–æ–¥–∞—ò —Ñ–∞—ò–ª, –ª–∏–Ω–∫ –∏–ª–∏ –ø–∞—Ç–µ–∫–∞.",
                    confirmDel: "–ò–∑–±—Ä–∏—à–∏?", newPage: "–°—Ç—Ä–∞–Ω–∏—Ü–∞",
                    clickToOpen: "–ö–ª–∏–∫–Ω–∏ –∑–∞ –ø—Ä–µ–≥–ª–µ–¥",
                    addMore: "‚ûï –î–æ–¥–∞—ò –ø—Ä–∏–ª–æ–∑–∏",
                    addSection: "+ –°–µ–∫—Ü–∏—ò–∞",
                    descPlaceholder: "–û–ø–∏—Å...",
                    local: "–õ–æ–∫–∞–ª–µ–Ω", cloud: "Cloud",
                    storageLocal: "üìé –í–≥—Ä–∞–¥–∏", storageDrive: "‚òÅÔ∏è –õ–∏–Ω–∫"
                },
                en: {
                    addPage: "+ Page", addRow: "+ Row",
                    addFileLocal: "üìé Local", addFileCloud: "‚òÅÔ∏è Drive Link",
                    addLink: "üîó Link", deleteRow: "üóëÔ∏è",
                    addLocalVideo: "üé¨ Video (path)",
                    col1: "Column 1", col2: "Column 2", col3: "Attachments",
                    urlPlaceholder: "Paste URL, path or folder...",
                    localVideoPlaceholder: "videos/video.mp4",
                    noAtt: "No attachments. Add file, link or path.",
                    confirmDel: "Delete?", newPage: "Page",
                    clickToOpen: "Click to preview",
                    addMore: "‚ûï Add attachments",
                    addSection: "+ Section",
                    descPlaceholder: "Description...",
                    local: "Local", cloud: "Cloud",
                    storageLocal: "üìé Embed", storageDrive: "‚òÅÔ∏è Link"
                }
            };

            var STORAGE_KEY = "table_mentor_v2";
            var state = {
                lang: "mk", theme: "light",
                showOrder: true,
                uiLocked: false,
                attView: "tiles",      // tiles | list
                attSize: "m",          // s | m | l (tiles only)
                printAtt: "text",      // full | compact | text
                mainTitle: "–¢–∞–±–µ–ª–∞ —Å–æ –¥–æ–∫–∞–∑–∏",
                subtitle: "–û—Ü–µ–Ω–∫–∞ –∑–∞ –∏—Å–ø–æ–ª–Ω–µ—Ç–æ—Å—Ç–∞ –Ω–∞ –ø—Ä–æ—Ñ–µ—Å–∏–æ–Ω–∞–ª–Ω–∏—Ç–µ —Å—Ç–∞–Ω–¥–∞—Ä–¥–∏ –∑–∞ —Å—Ç—Ä—É—á–µ–Ω —Å–æ—Ä–∞–±–æ—Ç–Ω–∏–∫ - –º–µ–Ω—Ç–æ—Ä",
                currentPage: 0,
                pages: [{
                    id: 1,
                    name: "–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1",
                    cols: ["–î–æ–∫–∞–∑–∏", "–ö–æ–º–ø–µ—Ç–µ–Ω—Ü–∏—ò–∞", "–û–ë–à–ê–°–ù–£–í–ê–ä–ï/–û–ë–†–ê–ó–õ–û–ñ–ï–ù–ò–ï"],
                    rows: [
                        // ===== –ü–û–î–†–ê–ß–à–ï 1: –†–ê–ë–û–¢–ê –°–û –£–ß–ï–ù–ò–¶–ò =====
                        { isSection: true, title: "–ü–æ–¥—Ä–∞—á—ò–µ 1: –†–ê–ë–û–¢–ê –°–û –£–ß–ï–ù–ò–¶–ò", secNo: "1" },
                        
                        // 1.1. –ü–û–î–î–†–®–ö–ê –ù–ê –£–ß–ï–ù–ò–¶–ò–¢–ï –í–û –£–ß–ï–ä–ï–¢–û (7 –±–æ–¥–æ–≤–∏)
                        { isSection: true, title: "1.1. –ü–û–î–î–†–®–ö–ê –ù–ê –£–ß–ï–ù–ò–¶–ò–¢–ï –í–û –£–ß–ï–ä–ï–¢–û (–≤–∫—É–ø–Ω–æ 7 –±–æ–¥–æ–≤–∏)", secNo: "1.1" },
                        { col1: "", col2: "–à–∞ –ø—Ä–æ—Ü–µ–Ω—É–≤–∞ –ø–æ–¥–≥–æ—Ç–≤–µ–Ω–æ—Å—Ç–∞ –Ω–∞ —É—á–µ–Ω–∏—Ü–∏—Ç–µ –∑–∞ –≤–∫–ª—É—á—É–≤–∞—ö–µ –∏ –Ω–∞–ø—Ä–µ–¥—É–≤–∞—ö–µ –≤–æ –æ–±—Ä–∞–∑–æ–≤–Ω–∏–æ—Ç —Å–∏—Å—Ç–µ–º.", col3: "", atts: [], atts1: [], atts2: [], points: 1, checked: false },
                        { col1: "", col2: "–£–º–µ–µ –¥–∞ –≥–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫—É–≤–∞ —Ä–∞–∑–ª–∏—á–Ω–∏—Ç–µ –æ–±—Ä–∞–∑–æ–≤–Ω–∏ –ø–æ—Ç—Ä–µ–±–∏ –Ω–∞ —É—á–µ–Ω–∏—Ü–∏—Ç–µ –∏ –∫–æ—Ä–∏—Å—Ç–∏ —Ä–∞–∑–ª–∏—á–Ω–∏ –ø—Ä–∏—Å—Ç–∞–ø–∏ –≤–æ –ø–æ–º–∞–≥–∞—ö–µ—Ç–æ –Ω–∞ —É—á–µ–Ω–∏—Ü–∏—Ç–µ –≤–æ –∫–æ—Ä–∏—Å—Ç–µ—ö–µ –Ω–∞ —Å–æ–æ–¥–≤–µ—Ç–Ω–∞—Ç–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—ò–∞ –∏ —Ç–µ—Ö–Ω–∏–∫–∞ –≤–æ —É—á–µ—ö–µ—Ç–æ.", col3: "", atts: [], atts1: [], atts2: [], points: 1, checked: false },
                        { col1: "", col2: "–ò–º–∞ –ø–æ–∑–Ω–∞–≤–∞—ö–µ –∑–∞ –∫–æ—Ä–∏—Å—Ç–µ—ö–µ –∞—Å–∏—Å—Ç–∏–≤–Ω–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—ò–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–∞ —Å–æ —É—á–µ–Ω–∏—Ü–∏ —Å–æ –ø–æ—Å–µ–±–Ω–∏ –æ–±—Ä–∞–∑–æ–≤–Ω–∏ –ø–æ—Ç—Ä–µ–±–∏.", col3: "", atts: [], atts1: [], atts2: [], points: 1, checked: false },
                        { col1: "", col2: "–û–±–µ–∑–±–µ–¥—É–≤–∞ —Å–∏—Ç–µ —É—á–µ–Ω–∏—Ü–∏ –¥–∞ –∏–º–∞–∞—Ç –µ–¥–Ω–∞–∫–≤–∏ –º–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞ —É—Å–ø–µ—Ö –∫–æ—Ä–∏—Å—Ç–µ—ò—ú–∏ –ø—Ä–∏–æ–¥–∏ –∑–∞ –ø–æ–¥–æ–±—Ä—É–≤–∞—ö–µ –Ω–∞ —É—á–µ—ö–µ—Ç–æ –±–∞–∑–∏—Ä–∞–Ω–∏ –Ω–∞ –Ω–∞—ò–Ω–æ–≤–∏—Ç–µ –Ω–∞—É—á–Ω–∏ —Å–æ–∑–Ω–∞–Ω–∏—ò–∞.", col3: "", atts: [], atts1: [], atts2: [], points: 2, checked: false },
                        { col1: "", col2: "–ü–æ–∑–Ω–∞–≤–∞ —Ä–∞–∑–ª–∏—á–Ω–∏ –∫–æ–Ω—Ü–µ–ø—Ç–∏ –∏ –º–æ–¥–µ–ª–∏ –∑–∞ —Ä–∞–∑–≤–æ—ò –Ω–∞ –∏–Ω–∫–ª—É–∑–∏–≤–Ω–æ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏ –≥–∏ –∫–æ—Ä–∏—Å—Ç–∏ –∑–∞ –≥—Ä–∞–¥–µ—ö–µ –Ω–∞ –∏–Ω–∫–ª—É–∑–∏–≤–Ω–æ —É—á–∏–ª–∏—à—Ç–µ.", col3: "", atts: [], atts1: [], atts2: [], points: 2, checked: false },
                        
                        // 1.2. –°–õ–ï–î–ï–ä–ï –ò –ü–û–î–î–†–®–ö–ê –ù–ê –†–ê–ó–í–û–à–û–¢ –ù–ê –£–ß–ï–ù–ò–¶–ò–¢–ï (5 –±–æ–¥–æ–≤–∏)
                        { isSection: true, title: "1.2. –°–õ–ï–î–ï–ä–ï –ò –ü–û–î–î–†–®–ö–ê –ù–ê –†–ê–ó–í–û–à–û–¢ –ù–ê –£–ß–ï–ù–ò–¶–ò–¢–ï (–≤–∫—É–ø–Ω–æ 5 –±–æ–¥–æ–≤–∏)", secNo: "1.2" },
                        { col1: "", col2: "–ü—Ä–∏–º–µ–Ω—É–≤–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª–Ω–∞ –∏ –≥—Ä—É–ø–Ω–∞ —Ñ–æ—Ä–º–∞ –Ω–∞ —Ä–∞–±–æ—Ç–∞ —Å–æ —É—á–µ–Ω–∏—Ü–∏—Ç–µ –ø—Ä–∏–ª–∞–≥–æ–¥—É–≤–∞—ò—ú–∏ –≥–∏ –Ω–∞ —Å–æ–∑–¥–∞–¥–µ–Ω–∞—Ç–∞ —Å–∏—Ç—É–∞—Ü–∏—ò–∞—Ç–∞ –∏ –≤–∏–¥–æ—Ç –Ω–∞ –ø—Ä–æ–±–ª–µ–º–æ—Ç.", col3: "", atts: [], atts1: [], atts2: [], points: 2, checked: false },
                        { col1: "", col2: "–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫—É–≤–∞ –∏ —Å–æ–æ–¥–≤–µ—Ç–Ω–æ —Ä–µ–∞–≥–∏—Ä–∞ –Ω–∞ –∫—Ä–∏–∑–Ω–∏ —Å–æ—Å—Ç–æ—ò–±–∏ –Ω–∞ —É—á–µ–Ω–∏—Ü–∏—Ç–µ.", col3: "", atts: [], atts1: [], atts2: [], points: 1, checked: false },
                        { col1: "", col2: "–†–∞–∑–≤–∏–≤–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—ò–∞ –∑–∞ –ø–æ–¥–¥—Ä—à–∫–∞ –Ω–∞ —Ä–∞–∑–≤–æ—ò–æ—Ç –Ω–∞ —É—á–µ–Ω–∏—Ü–∏—Ç–µ, –ø—Ä–∏–ª–∞–≥–æ–¥–µ–Ω–∞ –Ω–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∏—Ç–µ –º–æ–∂–Ω–æ—Å—Ç–∏, –ø–æ—Ç—Ä–µ–±–∏ –∏ –∏–Ω—Ç–µ—Ä–µ—Å–∏ –Ω–∞ —É—á–µ–Ω–∏—Ü–∏ –∏ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∏—Ç–µ –Ω–∞ —Å–∞–º–æ—Ç–æ —É—á–∏–ª–∏—à—Ç–µ—Ç–æ.", col3: "", atts: [], atts1: [], atts2: [], points: 2, checked: false },
                        
                        // 1.3. –ö–ê–†–ò–ï–†–ù–û –°–û–í–ï–¢–£–í–ê–ä–ï –ù–ê –£–ß–ï–ù–ò–¶–ò–¢–ï (4 –±–æ–¥–æ–≤–∏)
                        { isSection: true, title: "1.3. –ö–ê–†–ò–ï–†–ù–û –°–û–í–ï–¢–£–í–ê–ä–ï –ù–ê –£–ß–ï–ù–ò–¶–ò–¢–ï (–≤–∫—É–ø–Ω–æ 4 –±–æ–¥–æ–≤–∏)", secNo: "1.3" },
                        { col1: "", col2: "–ò–∑–±–∏—Ä–∞ –∏ –∫–æ—Ä–∏—Å—Ç–∏ —Å–æ–æ–¥–≤–µ—Ç–Ω–∏ –º–µ—Ç–æ–¥–∏ –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –∑–∞ –ø—Ä–æ—Ñ–µ—Å–∏–æ–Ω–∞–ª–Ω–∞ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—ò–∞ –∏ —Å–æ–≤–µ—Ç—É–≤–∞—ö–µ –∑–∞ –∫–∞—Ä–∏–µ—Ä–Ω–æ –Ω–∞—Å–æ—á—É–≤–∞—ö–µ –Ω–∞ —É—á–µ–Ω–∏—Ü–∏.", col3: "", atts: [], atts1: [], atts2: [], points: 1, checked: false },
                        { col1: "", col2: "–ü—Ä–æ—Ñ–µ—Å–∏–æ–Ω–∞–ª–Ω–æ—Ç–æ –∏ –∫–∞—Ä–∏–µ—Ä–Ω–æ —Å–æ–≤–µ—Ç—É–≤–∞—ö–µ –Ω–∞ —É—á–µ–Ω–∏—Ü–∏—Ç–µ –≥–æ –±–∞–∑–∏—Ä–∞ –Ω–∞ —É—Ç–≤—Ä–¥–µ–Ω–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å–∏, —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∏ –æ–ø—à—Ç–µ—Å—Ç–≤–µ–Ω–∏ –º–æ–∂–Ω–æ—Å—Ç–∏.", col3: "", atts: [], atts1: [], atts2: [], points: 1, checked: false },
                        { col1: "", col2: "–ì–æ —É–Ω–∞–ø—Ä–µ–¥—É–≤–∞ –ø—Ä–æ—Ü–µ—Å–æ—Ç –Ω–∞ –ø—Ä–æ—Ñ–µ—Å–∏–æ–Ω–∞–ª–Ω–∞ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—ò–∞ –∏ –∫–∞—Ä–∏–µ—Ä–Ω–æ –Ω–∞—Å–æ—á—É–≤–∞—ö–µ –≤–æ —É—á–∏–ª–∏—à—Ç–µ—Ç–æ.", col3: "", atts: [], atts1: [], atts2: [], points: 2, checked: false },
                        
                        // ===== –ü–û–î–†–ê–ß–à–ï 2: –†–ê–ë–û–¢–ê –°–û –ù–ê–°–¢–ê–í–ù–ò–¶–ò =====
                        { isSection: true, title: "–ü–æ–¥—Ä–∞—á—ò–µ 2: –†–ê–ë–û–¢–ê –°–û –ù–ê–°–¢–ê–í–ù–ò–¶–ò", secNo: "2" },
                        
                        // 2.1. –ü–û–î–î–†–®–ö–ê –ù–ê –ù–ê–°–¢–ê–í–ù–ò–¶–ò–¢–ï –ó–ê –ü–õ–ê–ù–ò–†–ê–ä–ï (6 –±–æ–¥–æ–≤–∏)
                        { isSection: true, title: "2.1. –ü–û–î–î–†–®–ö–ê –ù–ê –ù–ê–°–¢–ê–í–ù–ò–¶–ò–¢–ï –ó–ê –ü–õ–ê–ù–ò–†–ê–ä–ï –ò –†–ï–ê–õ–ò–ó–ò–†–ê–ä–ï –ù–ê –í–û–°–ü–ò–¢–ù–û-–û–ë–†–ê–ó–û–í–ù–ò–û–¢ –ü–†–û–¶–ï–° –ò –°–ê–ú–û–ï–í–ê–õ–£–ê–¶–ò–à–ê–¢–ê (–≤–∫—É–ø–Ω–æ 6 –±–æ–¥–æ–≤–∏)", secNo: "2.1" },
                        { col1: "", col2: "–î–∞–≤–∞ —Å—Ç—Ä—É—á–Ω–∞ –ø–æ–¥–¥—Ä—à–∫–∞ –≤–æ –ø–ª–∞–Ω–∏—Ä–∞—ö–µ –Ω–∞ –Ω–∞—Å—Ç–∞–≤–∞—Ç–∞/–∏–∑–≥–æ—Ç–≤—É–≤–∞—ö–µ –Ω–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª–µ–Ω –æ–±—Ä–∞–∑–æ–≤–µ–Ω –ø–ª–∞–Ω.", col3: "", atts: [], atts1: [], atts2: [], points: 1, checked: false },
                        { col1: "", col2: "–î–∞–≤–∞ –Ω–∞—Å–æ–∫–∏ –Ω–∞ –Ω–∞—Å—Ç–∞–≤–Ω–∏—Ü–∏—Ç–µ –∫–∞–∫–æ –¥–∞ –≥–∏ –∫–æ—Ä–∏—Å—Ç–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ –æ–¥ –æ—Ü–µ–Ω—É–≤–∞—ö–µ—Ç–æ –∑–∞ –ø–æ–¥–æ–±—Ä—É–≤–∞—ö–µ –Ω–∞ –ø–ª–∞–Ω–∏—Ä–∞—ö–µ—Ç–æ, –ø–æ—É—á—É–≤–∞—ö–µ—Ç–æ, –≤—Ä–µ–¥–Ω—É–≤–∞—ö–µ—Ç–æ –∏ —É—á–µ—ö–µ—Ç–æ.", col3: "", atts: [], atts1: [], atts2: [], points: 1, checked: false },
                        { col1: "", col2: "–î–∞–≤–∞ –ø–æ–¥–¥—Ä—à–∫–∞ –≤–æ —Å–ø—Ä–æ–≤–µ–¥—É–≤–∞—ö–µ –Ω–∞ –ø—Ä–æ–µ–∫—Ç–Ω–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ –≤–æ–Ω–Ω–∞—Å—Ç–∞–≤–Ω–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–æ –∫–æ–∏ —Å–µ –ø–æ–¥–æ–±—Ä—É–≤–∞ –∫–≤–∞–ª–∏—Ç–µ—Ç–æ—Ç –Ω–∞ –Ω–∞—Å—Ç–∞–≤–∞—Ç–∞.", col3: "", atts: [], atts1: [], atts2: [], points: 1, checked: false },
                        { col1: "", col2: "–ò–º –ø–æ–º–∞–≥–∞ –Ω–∞ –Ω–∞—Å—Ç–∞–≤–Ω–∏—Ü–∏—Ç–µ –¥–∞ –∏–∑–±–∏—Ä–∞–∞—Ç –∏ –∏–∑–≥–æ—Ç–≤—É–≤–∞–∞—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –∑–∞ –≤—Ä–µ–¥–Ω—É–≤–∞—ö–µ –∏ —Å–∞–º–æ–≤—Ä–µ–¥–Ω—É–≤–∞—ö–µ –Ω–∞ –ø–æ—Å—Ç–∏–≥–∞—ö–∞—Ç–∞ –Ω–∞ —É—á–µ–Ω–∏—Ü–∏—Ç–µ –∏ —Å–æ–æ–¥–≤–µ—Ç–Ω–æ –¥–∞ –≥–∏ –∫–æ—Ä–∏—Å—Ç–∞—Ç –∏–ª–∏ –∏–º –ø–æ–º–∞–≥–∞ –Ω–∞ –Ω–∞—Å—Ç–∞–≤–Ω–∏—Ü–∏—Ç–µ –ø—Ä–∏ –ø–ª–∞–Ω–∏—Ä–∞—ö–µ—Ç–æ –¥–∞ –≤–æ–¥–∞—Ç –≥—Ä–∏–∂–∞ –∑–∞ —Å–æ—Ü–∏—ò–∞–ª–Ω–∏—Ç–µ –∏ –∫—É–ª—Ç—É—Ä–Ω–∏—Ç–µ –∫–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –Ω–∞ —Å—Ä–µ–¥–∏–Ω–∞—Ç–∞ –∏ —Å–µ–º–µ—ò—Å—Ç–≤–∞—Ç–∞ –Ω–∞ —É—á–µ–Ω–∏—Ü–∏—Ç–µ.", col3: "", atts: [], atts1: [], atts2: [], points: 1, checked: false },
                        { col1: "", col2: "–ü—Ä–æ–º–æ–≤–∏—Ä–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–∏ –∏ –∏–Ω–æ–≤–∞—Ç–∏–≤–Ω–∏ –ø—Ä–∏–æ–¥–∏ –≤–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—ò–∞—Ç–∞ –Ω–∞ –≤–æ—Å–ø–∏—Ç–Ω–æ-–æ–±—Ä–∞–∑–æ–≤–Ω–∞ —Ä–∞–±–æ—Ç–∞.", col3: "", atts: [], atts1: [], atts2: [], points: 2, checked: false },
                        
                        // 2.2. –ü–û–î–î–†–®–ö–ê –ù–ê –ù–ê–°–¢–ê–í–ù–ò–¶–ò–¢–ï –ó–ê –†–ê–ë–û–¢–ê –°–û –£–ß–ï–ù–ò–¶–ò–¢–ï –ò –†–û–î–ò–¢–ï–õ–ò–¢–ï (9 –±–æ–¥–æ–≤–∏)
                        { isSection: true, title: "2.2. –ü–û–î–î–†–®–ö–ê –ù–ê –ù–ê–°–¢–ê–í–ù–ò–¶–ò–¢–ï –ó–ê –†–ê–ë–û–¢–ê –°–û –£–ß–ï–ù–ò–¶–ò–¢–ï –ò –†–û–î–ò–¢–ï–õ–ò–¢–ï (–≤–∫—É–ø–Ω–æ 9 –±–æ–¥–æ–≤–∏)", secNo: "2.2" },
                        { col1: "", col2: "–ò–º –ø–æ–º–∞–≥–∞ –Ω–∞ –Ω–∞—Å—Ç–∞–≤–Ω–∏—Ü–∏—Ç–µ –≤–æ –∏–∑–±–æ—Ä–æ—Ç –Ω–∞ —Å–æ–æ–¥–≤–µ—Ç–Ω–∏ –º–µ—Ç–æ–¥–∏, –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏ —Å–æ–¥—Ä–∂–∏–Ω–∏ –∑–∞ —Å–æ—Ä–∞–±–æ—Ç–∫–∞ —Å–æ —Ä–æ–¥–∏—Ç–µ–ª–∏—Ç–µ.", col3: "", atts: [], atts1: [], atts2: [], points: 1, checked: false },
                        { col1: "", col2: "–î–∞–≤–∞ –ø–æ–¥–¥—Ä—à–∫–∞ –Ω–∞ –Ω–∞—Å—Ç–∞–≤–Ω–∏—Ü–∏—Ç–µ –∑–∞ –∫–æ—Ä–∏—Å—Ç–µ—ö–µ –Ω–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª–∏–∑–∞—Ü–∏—ò–∞ –∏ –¥–∏—Ñ–µ—Ä–µ–Ω—Ü–∏—ò–∞—Ü–∏—ò–∞ –≤–æ –Ω–∞—Å—Ç–∞–≤–∞—Ç–∞, –≤–æ –¥–æ–¥–∞—Ç–Ω–∞—Ç–∞ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª–Ω–∞—Ç–∞ –Ω–∞—Å—Ç–∞–≤–∞ –∏ –≤–æ–Ω–Ω–∞—Å—Ç–∞–≤–Ω–∏—Ç–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.", col3: "", atts: [], atts1: [], atts2: [], points: 1, checked: false },
                        { col1: "", col2: "–î–∞–≤–∞ –ø–æ–º–æ—à –Ω–∞ –Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–æ—Ç –≤–æ —Å–ø—Ä–∞–≤—É–≤–∞—ö–µ —Å–æ –Ω–µ–ø–æ—á–∏—Ç—É–≤–∞—ö–µ—Ç–æ –Ω–∞ –ø—Ä–∞–≤–∏–ª–∞—Ç–∞ –∑–∞ –∏ —Ä–∞–∑—Ä–µ—à—É–≤–∞—ö–µ –Ω–∞ –ø—Ä–æ–±–ª–µ–º–∏ —Å–æ –æ–¥–Ω–µ—Å—É–≤–∞—ö–µ—Ç–æ –Ω–∞ —É—á–µ–Ω–∏—Ü–∏—Ç–µ.", col3: "", atts: [], atts1: [], atts2: [], points: 1, checked: false },
                        { col1: "", col2: "–ò–º –ø–æ–º–∞–≥–∞ –Ω–∞ –Ω–∞—Å—Ç–∞–≤–Ω–∏—Ü–∏—Ç–µ –≤–æ –ø—Ä–µ–ø–æ–∑–Ω–∞–≤–∞—ö–µ –∏ —Ä–∞–±–æ—Ç–∞ —Å–æ —Ä–∞–∑–ª–∏—á–Ω–∏ —É—á–µ–Ω–∏—Ü–∏ —Å–ø–æ—Ä–µ–¥ –º–æ–∂–Ω–æ—Å—Ç–∏—Ç–µ, –ø–æ—Ç—Ä–µ–±–∏—Ç–µ –∏ –∏–Ω—Ç–µ—Ä–µ—Å–∏—Ç–µ.", col3: "", atts: [], atts1: [], atts2: [], points: 2, checked: false },
                        { col1: "", col2: "–ü—Ä–∏–¥–æ–Ω–µ—Å—É–≤–∞ –∑–∞ —Å–æ–∑–¥–∞–≤–∞—ö–µ —Å—Ç–∏–º—É–ª–∞—Ç–∏–≤–Ω–∞ –∏ –ø–æ—Ç—Ç–∏–∫–Ω—É–≤–∞—á–∫–∞ —Å—Ä–µ–¥–∏–Ω–∞ –∑–∞ —É—á–µ–Ω–∏—Ü–∏—Ç–µ –≤–æ —É—á–∏–ª–∏—à—Ç–µ—Ç–æ.", col3: "", atts: [], atts1: [], atts2: [], points: 2, checked: false },
                        { col1: "", col2: "–°–æ–∑–¥–∞–≤–∞ –∫–ª–∏–º–∞ –Ω–∞ –ø—Ä–∏—Ñ–∞—ú–∞—ö–µ –Ω–∞ —Ä–∞–∑–ª–∏—á–Ω–æ—Å—Ç–∏—Ç–µ –∏ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω–æ —Å–ø—Ä–∞–≤—É–≤–∞—ö–µ —Å–æ –∫—Ä–∏–∑–Ω–∏ —Å–æ—Å—Ç–æ—ò–±–∏.", col3: "", atts: [], atts1: [], atts2: [], points: 2, checked: false },
                        
                        // ===== –ü–û–î–†–ê–ß–à–ï 3: –†–ê–ë–û–¢–ê –°–û –†–û–î–ò–¢–ï–õ–ò =====
                        { isSection: true, title: "–ü–æ–¥—Ä–∞—á—ò–µ 3: –†–ê–ë–û–¢–ê –°–û –†–û–î–ò–¢–ï–õ–ò", secNo: "3" },
                        
                        // 3.1. –ò–ù–î–ò–í–ò–î–£–ê–õ–ù–ò –ò –ì–†–£–ü–ù–ò –°–û–í–ï–¢–£–í–ê–ä–ê (7 –±–æ–¥–æ–≤–∏)
                        { isSection: true, title: "3.1. –ò–ù–î–ò–í–ò–î–£–ê–õ–ù–ò –ò –ì–†–£–ü–ù–ò –°–û–í–ï–¢–£–í–ê–ä–ê, –ö–û–ù–°–£–õ–¢–ê–¶–ò–ò –ò –ï–î–£–ö–ê–¶–ò–à–ê –°–û –†–û–î–ò–¢–ï–õ–ò–¢–ï (–≤–∫—É–ø–Ω–æ 7 –±–æ–¥–æ–≤–∏)", secNo: "3.1" },
                        { col1: "", col2: "–ì–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫—É–≤–∞ –ø–æ—Ç–µ–Ω—Ü–∏—ò–∞–ª–Ω–∏—Ç–µ –∫—Ä–∏–∑–Ω–∏ —Å–∏—Ç—É–∞—Ü–∏–∏ –≤–æ —Å–µ–º–µ—ò—Å—Ç–≤–∞—Ç–∞ —à—Ç–æ –≥–æ –∑–∞—Å–µ–≥–∞–∞—Ç —Ä–∞–∑–≤–æ—ò–æ—Ç –∏ —É—á–µ—ö–µ—Ç–æ –Ω–∞ —É—á–µ–Ω–∏—Ü–∏—Ç–µ –∏ –¥–∞–≤–∞ —Å–æ–æ–¥–≤–µ—Ç–Ω–∞ –ø–æ–¥–¥—Ä—à–∫–∞ –Ω–∞ —Å–µ–º–µ—ò—Å—Ç–≤–æ—Ç–æ.", col3: "", atts: [], atts1: [], atts2: [], points: 1, checked: false },
                        { col1: "", col2: "–ù–∞ —Ä–æ–¥–∏—Ç–µ–ª–∏—Ç–µ –Ω–∞ –¥–µ—Ü–∞—Ç–∞ —Å–æ –ø–æ—Å–µ–±–Ω–∏ –æ–±—Ä–∞–∑–æ–≤–Ω–∏ –ø–æ—Ç—Ä–µ–±–∏ –∏–º –ø–æ–º–∞–≥–∞ –¥–∞ —ò–∞ —Ä–∞–∑–±–µ—Ä–∞—Ç –∏ –ø—Ä–∏—Ñ–∞—Ç–∞—Ç —Å–æ—Å—Ç–æ—ò–±–∞—Ç–∞ –Ω–∞ –Ω–∏–≤–Ω–∏—Ç–µ –¥–µ—Ü–∞ –∏ –¥–∞ –∏–º —ò–∞ –¥–∞–¥–∞—Ç –ø–æ—Ç—Ä–µ–±–Ω–∞—Ç–∞ –ø–æ–º–æ—à –∏ –ø–æ–¥–¥—Ä—à–∫–∞.", col3: "", atts: [], atts1: [], atts2: [], points: 1, checked: false },
                        { col1: "", col2: "–ò–º –ø–æ–º–∞–≥–∞ –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª–∏—Ç–µ –¥–∞ —Ä–∞–∑–≤–∏—ò–∞—Ç –≤–µ—à—Ç–∏–Ω–∏ –ø–æ–∫–≤–∞–ª–∏—Ç–µ—Ç–Ω–æ –¥–∞ –≥–æ –ø–æ—Ç—Ç–∏–∫–Ω–∞—Ç —Ä–∞–∑–≤–æ—ò–æ—Ç –∏ —É—á–µ—ö–µ—Ç–æ –Ω–∞ —Å–≤–æ–µ—Ç–æ –¥–µ—Ç–µ –ø–æ—á–∏—Ç—É–≤–∞—ò—ú–∏ –≥–∏ —Å–æ–≤—Ä–µ–º–µ–Ω–∏—Ç–µ —Ç—Ä–µ–Ω–¥–æ–≤–∏ –∑–∞ —Ä–æ–¥–∏—Ç–µ–ª—Å—Ç–≤–æ.", col3: "", atts: [], atts1: [], atts2: [], points: 1, checked: false },
                        { col1: "", col2: "–°–æ–æ–¥–≤–µ—Ç–Ω–æ —Ä–µ–∞–≥–∏—Ä–∞ –Ω–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–Ω–∏ —Å–∏—Ç—É–∞—Ü–∏–∏ –Ω–∞ —Ä–µ–ª–∞—Ü–∏—ò–∞ —Ä–æ–¥–∏—Ç–µ–ª - —É—á–∏–ª–∏—à—Ç–µ.", col3: "", atts: [], atts1: [], atts2: [], points: 2, checked: false },
                        { col1: "", col2: "–ì–æ –ø–æ–¥–æ–±—Ä—É–≤–∞ –∏–Ω—Ñ–æ—Ä–º–∏—Ä–∞—ö–µ—Ç–æ –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª–∏—Ç–µ –æ–¥ —Å—Ç—Ä–∞–Ω–∞ –Ω–∞ —É—á–∏–ª–∏—à—Ç–µ—Ç–æ.", col3: "", atts: [], atts1: [], atts2: [], points: 2, checked: false },
                        
                        // 3.2. –í–ö–õ–£–ß–£–í–ê–ä–ï –ù–ê –†–û–î–ò–¢–ï–õ–ò–¢–ï (2 –±–æ–¥–æ–≤–∏)
                        { isSection: true, title: "3.2. –í–ö–õ–£–ß–£–í–ê–ä–ï –ù–ê –†–û–î–ò–¢–ï–õ–ò–¢–ï –í–û –ñ–ò–í–û–¢–û–¢ –ò –†–ê–ë–û–¢–ê–¢–ê –ù–ê –£–ß–ò–õ–ò–®–¢–ï–¢–û (–≤–∫—É–ø–Ω–æ 2 –±–æ–¥–æ–≤–∏)", secNo: "3.2" },
                        { col1: "", col2: "–°–∏—Å—Ç–µ–º–∞—Ç–∏—á–Ω–æ —ò–∞ –ø–æ–¥–æ–±—Ä—É–≤–∞ —Å–æ—Ä–∞–±–æ—Ç–∫–∞—Ç–∞ –Ω–∞ —É—á–∏–ª–∏—à—Ç–µ—Ç–æ —Å–æ —Å–µ–º–µ—ò—Å—Ç–≤–æ—Ç–æ.", col3: "", atts: [], atts1: [], atts2: [], points: 2, checked: false },
                        
                        // ===== –ü–û–î–†–ê–ß–à–ï 4: –°–û–†–ê–ë–û–¢–ö–ê –°–û –ó–ê–ï–î–ù–ò–¶–ê–¢–ê =====
                        { isSection: true, title: "–ü–æ–¥—Ä–∞—á—ò–µ 4: –°–û–†–ê–ë–û–¢–ö–ê –°–û –ó–ê–ï–î–ù–ò–¶–ê–¢–ê", secNo: "4" },
                        
                        // 4.1. –°–û–†–ê–ë–û–¢–ö–ê –°–û –õ–û–ö–ê–õ–ù–ê–¢–ê –ó–ê–ï–î–ù–ò–¶–ê (3 –±–æ–¥–æ–≤–∏)
                        { isSection: true, title: "4.1. –°–û–†–ê–ë–û–¢–ö–ê –°–û –õ–û–ö–ê–õ–ù–ê–¢–ê –ó–ê–ï–î–ù–ò–¶–ê –ò –°–¢–†–£–ß–ù–ò–¢–ï –ò–ù–°–¢–ò–¢–£–¶–ò–ò –ò –û–†–ì–ê–ù–ò–ó–ê–¶–ò–ò (–≤–∫—É–ø–Ω–æ 3 –±–æ–¥–æ–≤–∏)", secNo: "4.1" },
                        { col1: "", col2: "–ü—Ä–∏–¥–æ–Ω–µ—Å—É–≤–∞ –≤—Ä–µ–¥–Ω–æ—Å—Ç–∏—Ç–µ –Ω–∞ –∫—É–ª—Ç—É—Ä–∏—Ç–µ –≤–æ –∑–∞–µ–¥–Ω–∏—Ü–∞—Ç–∞ –¥–∞ —Å–µ —Ä–µ—Ñ–ª–µ–∫—Ç–∏—Ä–∞–∞—Ç –≤–æ —Å–∏—Ç–µ –∞—Å–ø–µ–∫—Ç–∏ –Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç–∞ –Ω–∞ —É—á–∏–ª–∏—à—Ç–µ—Ç–æ.", col3: "", atts: [], atts1: [], atts2: [], points: 1, checked: false },
                        { col1: "", col2: "–ò–Ω–∏—Ü–∏—Ä–∞ –∏ —Ä–∞–∑–≤–∏–≤–∞ –ø–∞—Ä—Ç–Ω–µ—Ä—Å–∫–∞ —Å–æ—Ä–∞–±–æ—Ç–∫–∞ —Å–æ –∑–∞–µ–¥–Ω–∏—Ü–∞—Ç–∞ –∑–∞ –ø—Ä–∞—à–∞—ö–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∏ –∑–∞ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ—Ç–æ –≤–æ –∑–∞–µ–¥–Ω–∏—Ü–∞—Ç–∞.", col3: "", atts: [], atts1: [], atts2: [], points: 2, checked: false },
                        
                        // ===== –ü–û–î–†–ê–ß–à–ï 5: –ü–†–û–§–ï–°–ò–û–ù–ê–õ–ï–ù –†–ê–ó–í–û–à =====
                        { isSection: true, title: "–ü–æ–¥—Ä–∞—á—ò–µ 5: –ü–†–û–§–ï–°–ò–û–ù–ê–õ–ï–ù –†–ê–ó–í–û–à –ò –ü–†–û–§–ï–°–ò–û–ù–ê–õ–ù–ê –°–û–†–ê–ë–û–¢–ö–ê", secNo: "5" },
                        
                        // 5.1. –õ–ò–ß–ï–ù –ü–†–û–§–ï–°–ò–û–ù–ê–õ–ï–ù –†–ê–ó–í–û–à (6 –±–æ–¥–æ–≤–∏)
                        { isSection: true, title: "5.1. –õ–ò–ß–ï–ù –ü–†–û–§–ï–°–ò–û–ù–ê–õ–ï–ù –†–ê–ó–í–û–à (–≤–∫—É–ø–Ω–æ 6 –±–æ–¥–æ–≤–∏)", secNo: "5.1" },
                        { col1: "", col2: "–°–æ—Ä–∞–±–æ—Ç—É–≤–∞ —Å–æ —Å—Ç—Ä—É—á–Ω–∏—Ç–µ —Å–æ—Ä–∞–±–æ—Ç–Ω–∏—Ü–∏ –∏ —Å–æ –ø—Ä–æ—Ñ–µ—Å–∏–æ–Ω–∞–ª–Ω–∏ –∑–¥—Ä—É–∂–µ–Ω–∏—ò–∞ –≤–æ –∏ –Ω–∞–¥–≤–æ—Ä –æ–¥ —É—á–∏–ª–∏—à—Ç–µ—Ç–æ.", col3: "", atts: [], atts1: [], atts2: [], points: 1, checked: false },
                        { col1: "", col2: "–ì–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫—É–≤–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ –∑–∞ –ª–∏—á–µ–Ω –ø—Ä–æ—Ñ–µ—Å–∏–æ–Ω–∞–ª–µ–Ω —Ä–∞–∑–≤–æ—ò –∫–æ—Ä–∏—Å—Ç–µ—ò—ú–∏ –≥–∏ —Å—Ç–∞–Ω–¥–∞—Ä–¥–∏—Ç–µ –∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ –æ–¥ —Å–∞–º–æ—Ä–µ—Ñ–ª–µ–∫—Å–∏—ò–∞ –Ω–∞ —Å–æ–ø—Å—Ç–≤–µ–Ω–∞—Ç–∞ —Ä–∞–±–æ—Ç–∞.", col3: "", atts: [], atts1: [], atts2: [], points: 1, checked: false },
                        { col1: "", col2: "–°—Ç–µ–∫–Ω–∞—Ç–∏—Ç–µ –∑–Ω–∞–µ—ö–∞ –ø—Ä–µ–∫—É —Å—Ç—Ä—É—á–Ω–æ —É—Å–æ–≤—Ä—à—É–≤–∞—ö–µ (—Ñ–æ—Ä–º–∞–ª–Ω–æ—Ç–æ, –Ω–µ—Ñ–æ—Ä–º–∞–ª–Ω–æ—Ç–æ –∏ –∏–Ω—Ñ–æ—Ä–º–∞–ª–Ω–æ—Ç–æ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∏ —É—á–µ—ö–µ) –≥–∏ –∫–æ—Ä–∏—Å—Ç–∏ –∑–∞ —É–Ω–∞–ø—Ä–µ–¥—É–≤–∞—ö–µ –Ω–∞ —Å–æ–ø—Å—Ç–≤–µ–Ω–∞—Ç–∞ –ø—Ä–∞–∫—Å–∞.", col3: "", atts: [], atts1: [], atts2: [], points: 2, checked: false },
                        { col1: "", col2: "–ò–∑–≥–æ—Ç–≤—É–≤–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –∑–∞ —Ä–µ—Ñ–ª–µ–∫—Å–∏—ò–∞ –∏ —Å–∞–º–æ–µ–≤–∞–ª—É–∞—Ü–∏—ò–∞ –∏ –≥–∏ —Å–ø–æ–¥–µ–ª—É–≤–∞ –∏—Å–∫—É—Å—Ç–≤–∞—Ç–∞ –æ–¥ —Å–æ–ø—Å—Ç–≤–µ–Ω–∏–æ—Ç –ø—Ä–æ—Ñ–µ—Å–∏–æ–Ω–∞–ª–µ–Ω —Ä–∞–∑–≤–æ—ò –∏ –ø—Ä–æ—Ñ–µ—Å–∏–æ–Ω–∞–ª–Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–∞.", col3: "", atts: [], atts1: [], atts2: [], points: 2, checked: false },
                        
                        // 5.2. –ü–û–î–î–†–®–ö–ê –ù–ê –ü–†–û–§–ï–°–ò–û–ù–ê–õ–ù–ò–û–¢ –†–ê–ó–í–û–à (6 –±–æ–¥–æ–≤–∏)
                        { isSection: true, title: "5.2. –ü–û–î–î–†–®–ö–ê –ù–ê –ü–†–û–§–ï–°–ò–û–ù–ê–õ–ù–ò–û–¢ –†–ê–ó–í–û–à –ò –°–û–†–ê–ë–û–¢–ö–ê–¢–ê –í–û –£–ß–ò–õ–ò–®–¢–ï–¢–û (–≤–∫—É–ø–Ω–æ 6 –±–æ–¥–æ–≤–∏)", secNo: "5.2" },
                        { col1: "", col2: "–ü–ª–∞–Ω–∏—Ä–∞—ö–µ—Ç–æ –Ω–∞ –ø—Ä–æ—Ñ–µ—Å–∏–æ–Ω–∞–ª–Ω–∏–æ—Ç —Ä–∞–∑–≤–æ—ò –≥–æ –ø–æ–≤—Ä–∑—É–≤–∞ —Å–æ –ø–æ—Ç—Ä–µ–±–Ω–∏—Ç–µ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏ –Ω–∞ –Ω–∞—Å—Ç–∞–≤–Ω–∏—Ü–∏—Ç–µ –∏ —Å—Ç—Ä—É—á–Ω–∏—Ç–µ —Å–æ—Ä–∞–±–æ—Ç–Ω–∏—Ü–∏ –∏ –ø—Ä–æ–º–æ–≤–∏—Ä–∞ –¥–æ–∂–∏–≤–æ—Ç–Ω–æ —É—á–µ—ö–µ.", col3: "", atts: [], atts1: [], atts2: [], points: 2, checked: false },
                        { col1: "", col2: "–ü—Ä–∏–¥–æ–Ω–µ—Å—É–≤–∞ –∑–∞ –ø—Ä–æ—Ñ–µ—Å–∏–æ–Ω–∞–ª–Ω–∏–æ—Ç —Ä–∞–∑–≤–æ—ò –Ω–∞ –≤–æ—Å–ø–∏—Ç–Ω–æ-–æ–±—Ä–∞–∑–æ–≤–Ω–∏–æ—Ç –∫–∞–¥–∞—Ä –≤–æ —É—á–∏–ª–∏—à—Ç–µ—Ç–æ –ø—Ä–µ–∫—É —Ä–µ–∞–ª–∏–∑–∏—Ä–∞—ö–µ —Ä–∞–∑–Ω–∏ —Ñ–æ—Ä–º–∏ –Ω–∞ –æ–±—É–∫–∏ –∏ –ø–æ–¥–¥—Ä—à–∫–∞.", col3: "", atts: [], atts1: [], atts2: [], points: 2, checked: false },
                        { col1: "", col2: "–í–æ—Å–ø–æ—Å—Ç–∞–≤—É–≤–∞ —Å–∏—Å—Ç–µ–º –Ω–∞ –ø—Ä–æ—Ñ–µ—Å–∏–æ–Ω–∞–ª–µ–Ω —Ä–∞–∑–≤–æ—ò –Ω–∞ –≤–æ—Å–ø–∏—Ç–Ω–æ-–æ–±—Ä–∞–∑–æ–≤–Ω–∏–æ—Ç –∫–∞–¥–∞—Ä –≤–æ —É—á–∏–ª–∏—à—Ç–µ—Ç–æ.", col3: "", atts: [], atts1: [], atts2: [], points: 2, checked: false },
                        
                        // ===== –ü–û–î–†–ê–ß–à–ï 6: –ê–ù–ê–õ–ò–¢–ò–ß–ö–û –ò–°–¢–†–ê–ñ–£–í–ê–ß–ö–ê –†–ê–ë–û–¢–ê =====
                        { isSection: true, title: "–ü–æ–¥—Ä–∞—á—ò–µ 6: –ê–ù–ê–õ–ò–¢–ò–ß–ö–û –ò–°–¢–†–ê–ñ–£–í–ê–ß–ö–ê –†–ê–ë–û–¢–ê", secNo: "6" },
                        
                        // 6.1. –ê–ù–ê–õ–ò–ó–ê –ò –ü–†–û–¶–ï–ù–ö–ê (4 –±–æ–¥–æ–≤–∏)
                        { isSection: true, title: "6.1. –ê–ù–ê–õ–ò–ó–ê –ò –ü–†–û–¶–ï–ù–ö–ê –ù–ê –í–û–°–ü–ò–¢–ù–û –û–ë–†–ê–ó–û–í–ù–ê–¢–ê –†–ê–ë–û–¢–ê (–≤–∫—É–ø–Ω–æ 4 –±–æ–¥–æ–≤–∏)", secNo: "6.1" },
                        { col1: "", col2: "–ü–æ–≤—Ä–∑—É–≤–∞, –æ–±—Ä–∞–±–æ—Ç—É–≤–∞ –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä–∞ —Ä–∞–∑–ª–∏—á–Ω–∏ –ø–æ–¥–∞—Ç–æ—Ü–∏ –∑–∞ –≤–æ—Å–ø–∏—Ç–Ω–æ –æ–±—Ä–∞–∑–æ–≤–Ω–∞—Ç–∞ —Ä–∞–±–æ—Ç–∞ –∏ –∏–∑–≤–ª–µ–∫—É–≤–∞ –∑–∞–∫–ª—É—á–æ—Ü–∏ –æ–¥ –∞–Ω–∞–ª–∏–∑–∏—Ç–µ.", col3: "", atts: [], atts1: [], atts2: [], points: 1, checked: false },
                        { col1: "", col2: "–ü—Ä–∏–¥–æ–Ω–µ—Å—É–≤–∞ –¥–∞ —Å–µ –≤–æ—Å–ø–æ—Å—Ç–∞–≤–∏ —Å–∏—Å—Ç–µ–º –∑–∞ —Ä–µ–¥–æ–≤–Ω–∏ –∞–Ω–∞–ª–∏–∑–∏ –Ω–∞ –æ–¥–¥–µ–ª–Ω–∏ –≤–æ—Å–ø–∏—Ç–Ω–æ-–æ–±—Ä–∞–∑–æ–≤–Ω–∏ –ø—Ä–∞—à–∞—ö–∞ –≤–æ —É—á–∏–ª–∏—à—Ç–µ—Ç–æ.", col3: "", atts: [], atts1: [], atts2: [], points: 1, checked: false },
                        { col1: "", col2: "–ì–∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ –æ–¥ –∞–Ω–∞–ª–∏–∑–∏—Ç–µ –∏ –∏–∑–≤–µ—Å—Ç—É–≤–∞ –∑–∞ –Ω–∏–≤.", col3: "", atts: [], atts1: [], atts2: [], points: 1, checked: false },
                        { col1: "", col2: "–°–µ –∑–∞–ª–∞–≥–∞ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ –æ–¥ –∞–Ω–∞–ª–∏–∑–∏—Ç–µ –¥–∞ —Å–µ –∫–æ—Ä–∏—Å—Ç–∞—Ç –∑–∞ —É–Ω–∞–ø—Ä–µ–¥—É–≤–∞—ö–µ –≤–æ—Å–ø–∏—Ç–Ω–æ-–æ–±—Ä–∞–∑–æ–≤–Ω–∏–æ—Ç –ø—Ä–æ—Ü–µ—Å.", col3: "", atts: [], atts1: [], atts2: [], points: 1, checked: false },
                        
                        // 6.2. –ò–°–¢–†–ê–ñ–£–í–ê–ä–ï (4 –±–æ–¥–æ–≤–∏)
                        { isSection: true, title: "6.2. –ò–°–¢–†–ê–ñ–£–í–ê–ä–ï –ù–ê –í–û–°–ü–ò–¢–ù–û-–û–ë–†–ê–ó–û–í–ù–ê–¢–ê –†–ê–ë–û–¢–ê (–≤–∫—É–ø–Ω–æ 4 –±–æ–¥–æ–≤–∏)", secNo: "6.2" },
                        { col1: "", col2: "–ì–∏ –ø–æ—á–∏—Ç—É–≤–∞ –º–µ—Ç–æ–¥–æ–ª–æ—à–∫–∏—Ç–µ —Å—Ç–∞–Ω–¥–∞—Ä–¥–∏ –ø—Ä–∏ –∏–∑–±–æ—Ä –∏ –∏–∑—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ –º–µ—Ä–Ω–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –∏ –ø—Ä–∞–≤–∏–ª–∞—Ç–∞ –∑–∞ –∫–æ—Ä–∏—Å—Ç–µ—ö–µ –Ω–∞ –∏—Å—Ç–∏—Ç–µ.", col3: "", atts: [], atts1: [], atts2: [], points: 1, checked: false },
                        { col1: "", col2: "–°–ø—Ä–æ–≤–µ–¥—É–≤–∞ –∏—Å—Ç—Ä–∞–∂—É–≤–∞—ö–∞/–∞–∫—Ü–∏—Å–∫–∏ –∏—Å—Ç—Ä–∞–∂—É–≤–∞—ö–∞ –Ω–∞ –ø—Ä–∞—à–∞—ö–∞ –∞–∫—Ç—É–µ–ª–Ω–∏ –∑–∞ —É—á–∏–ª–∏—à—Ç–µ—Ç–æ, –ø—Ä–æ—Ü–µ—Å–æ—Ç –Ω–∞ —É—á–µ—ö–µ –∏ –∑–∞ —É—á–µ–Ω–∏—Ü–∏—Ç–µ.", col3: "", atts: [], atts1: [], atts2: [], points: 1, checked: false },
                        { col1: "", col2: "–ì–∏ –∫–æ—Ä–∏—Å—Ç–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ –æ–¥ –∏—Å—Ç—Ä–∞–∂—É–≤–∞—ö–∞—Ç–∞ –≤–æ —Å–æ–ø—Å—Ç–≤–µ–Ω–∞—Ç–∞ –ø—Ä–∞–∫—Ç–∏–∫–∞.", col3: "", atts: [], atts1: [], atts2: [], points: 2, checked: false },
                        
                        // ===== –ü–û–î–†–ê–ß–à–ï 7: –£–ß–ò–õ–ò–®–ù–ê –û–†–ì–ê–ù–ò–ó–ê–¶–ò–à–ê, –°–¢–†–£–ö–¢–£–†–ê –ò –ö–õ–ò–ú–ê =====
                        { isSection: true, title: "–ü–æ–¥—Ä–∞—á—ò–µ 7: –£–ß–ò–õ–ò–®–ù–ê –û–†–ì–ê–ù–ò–ó–ê–¶–ò–à–ê, –°–¢–†–£–ö–¢–£–†–ê –ò –ö–õ–ò–ú–ê", secNo: "7" },
                        
                        // 7.1. –£–ß–ò–õ–ò–®–ù–ê –°–¢–†–£–ö–¢–£–†–ê –ò –û–†–ì–ê–ù–ò–ó–ê–¶–ò–à–ê (6 –±–æ–¥–æ–≤–∏)
                        { isSection: true, title: "7.1. –£–ß–ò–õ–ò–®–ù–ê –°–¢–†–£–ö–¢–£–†–ê –ò –û–†–ì–ê–ù–ò–ó–ê–¶–ò–à–ê (–≤–∫—É–ø–Ω–æ 6 –±–æ–¥–æ–≤–∏)", secNo: "7.1" },
                        { col1: "", col2: "–ì–æ —Å–ª–µ–¥–∏ –≤–æ—Å–ø–∏—Ç–Ω–æ-–æ–±—Ä–∞–∑–æ–≤–Ω–∏–æ—Ç –ø—Ä–æ—Ü–µ—Å –∏ –ø—Ä–µ–¥–ª–∞–≥–∞ –º–µ—Ä–∫–∏ –∑–∞ —É–Ω–∞–ø—Ä–µ–¥—É–≤–∞—ö–µ.", col3: "", atts: [], atts1: [], atts2: [], points: 1, checked: false },
                        { col1: "", col2: "–ö–æ—Ä–∏—Å—Ç–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –∑–∞ —Å–ª–µ–¥–µ—ö–µ –∏ –≥–∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–∞ –¥–æ–±–∏–µ–Ω–∏—Ç–µ —Å–æ–∑–Ω–∞–Ω–∏—ò–∞ –∑–∞ —Å–ª–µ–¥–µ–Ω–∏–æ—Ç —á–∞—Å; —Ä–∞–∑–≤–∏–≤–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∑–∞ –ø–æ–¥–æ–±—Ä—É–≤–∞—ö–µ –Ω–∞ –Ω–∞—Å—Ç–∞–≤–∞—Ç–∞; –∏–ª–∏ —É—á–µ—Å—Ç–≤—É–≤–∞ –≤–æ –ø—Ä–æ—Ü–µ—Å–æ—Ç –Ω–∞ –æ–ø—Ñ–∞—ú–∞—ö–µ –Ω–∞ —É—á–∏–ª–∏—à–Ω–∏—Ç–µ –æ–±–≤—Ä–∑–Ω–∏—Ü–∏ –∏ —Ñ–æ—Ä–º–∏—Ä–∞—ö–µ –Ω–∞ –ø–∞—Ä–∞–ª–µ–ª–∫–∏—Ç–µ.", col3: "", atts: [], atts1: [], atts2: [], points: 1, checked: false },
                        { col1: "", col2: "–ì–∏ —Å–ª–µ–¥–∏ –∏ –∞–Ω–∞–ª–∏–∑–∏—Ä–∞ –ø—Ä–æ–º–µ–Ω–∏—Ç–µ –≤–æ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ—Ç–æ –∏ –≥–∏ –∫–æ—Ä–∏—Å—Ç–∏ –ø—Ä–∏ –≥—Ä–∞–¥–µ—ö–µ –Ω–∞ –æ–±—Ä–∞–∑–æ–≤–Ω–∏ –ø–æ–ª–∏—Ç–∏–∫–∏ –≤–æ —É—á–∏–ª–∏—à—Ç–µ—Ç–æ.", col3: "", atts: [], atts1: [], atts2: [], points: 2, checked: false },
                        { col1: "", col2: "–†–µ–∑—É–ª—Ç–∞—Ç–∏—Ç–µ –æ–¥ –µ–≤–∞–ª—É–∞—Ü–∏—ò–∞—Ç–∞ –Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç–∞ –Ω–∞ —É—á–∏–ª–∏—à—Ç–µ—Ç–æ –≥–∏ –∫–æ—Ä–∏—Å—Ç–∏ –∑–∞ –ø–æ–¥–∏–≥–∞—ö–µ –Ω–∞ –∫–≤–∞–ª–∏—Ç–µ—Ç–æ—Ç –Ω–∞ –≤–æ—Å–ø–∏—Ç–Ω–æ-–æ–±—Ä–∞–∑–æ–≤–Ω–∏–æ—Ç –ø—Ä–æ—Ü–µ—Å.", col3: "", atts: [], atts1: [], atts2: [], points: 2, checked: false },
                        
                        // 7.2. –£–ß–ò–õ–ò–®–ù–ê –ö–õ–ò–ú–ê, –ë–ï–ó–ë–ï–î–ù–ê –°–†–ï–î–ò–ù–ê –ò –î–ï–ú–û–ö–†–ê–¢–°–ö–û –£–ß–ï–°–¢–í–û (11 –±–æ–¥–æ–≤–∏)
                        { isSection: true, title: "7.2. –£–ß–ò–õ–ò–®–ù–ê –ö–õ–ò–ú–ê, –ë–ï–ó–ë–ï–î–ù–ê –°–†–ï–î–ò–ù–ê –ò –î–ï–ú–û–ö–†–ê–¢–°–ö–û –£–ß–ï–°–¢–í–û (–≤–∫—É–ø–Ω–æ 11 –±–æ–¥–æ–≤–∏)", secNo: "7.2" },
                        { col1: "", col2: "–ü—Ä–∏–¥–æ–Ω–µ—Å—É–≤–∞ –∑–∞ –∏–Ω–∫–ª—É–∑–∏–≤–Ω–∞—Ç–∞ –∫–ª–∏–º–∞ –≤–æ —É—á–∏–ª–∏—à—Ç–µ—Ç–æ.", col3: "", atts: [], atts1: [], atts2: [], points: 1, checked: false },
                        { col1: "", col2: "–†–∞–∑–≤–∏–≤–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∑–∞ –º—É–ª—Ç–∏–∫—É–ª—Ç—É—Ä–∞–ª–∏–∑–∞–º, –∏–Ω—Ç–µ—Ä–∫—É–ª—Ç—É—Ä–∞–ª–∏–∑–∞–º –∏ –º–µ—ì—É–µ—Ç–Ω–∏—á–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—ò–∞ –∏ —Å–æ—Ä–∞–±–æ—Ç–∫–∞ –∏ –¥–µ–º–æ–∫—Ä–∞—Ç—Å–∫–æ —É—á–µ—Å—Ç–≤–æ –Ω–∞ —É—á–µ–Ω–∏—Ü–∏—Ç–µ –≤–æ —É—á–∏–ª–∏—à—Ç–µ—Ç–æ.", col3: "", atts: [], atts1: [], atts2: [], points: 2, checked: false },
                        { col1: "", col2: "–ì–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫—É–≤–∞ –º–æ–∂–Ω–∏—Ç–µ –∑–∞–∫–∞–Ω–∏ –ø–æ –±–µ–∑–±–µ–¥–Ω–æ—Å—Ç–∞ –∫–æ–∏ —Å–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∏ –∑–∞ —É—á–∏–ª–∏—à—Ç–µ—Ç–æ –∏ –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—Ç–∞ –ø–æ–ø—É–ª–∞—Ü–∏—ò–∞ –≤–æ —É—á–∏–ª–∏—à—Ç–µ—Ç–æ.", col3: "", atts: [], atts1: [], atts2: [], points: 1, checked: false },
                        { col1: "", col2: "–°–æ–∑–¥–∞–≤–∞ –ø–æ–∑–∏—Ç–∏–≤–Ω–∞ –∏ –Ω–µ–¥–∏—Å–∫—Ä–∏–º–∏–Ω–∞—Ç–æ—Ä—Å–∫–∞ —É—á–∏–ª–∏—à–Ω–∞ –∫–ª–∏–º–∞ –∏ –∫–æ–º—É–Ω–∏–∫–∞—Ü–∏—ò–∞.", col3: "", atts: [], atts1: [], atts2: [], points: 2, checked: false },
                        { col1: "", col2: "–ü—Ä–∞–∫—Ç–∏–∫—É–≤–∞ —Ä–∞–∑–ª–∏—á–Ω–∏ –Ω–∞—á–∏–Ω–∏ –∑–∞ —Å–ø—Ä–∞–≤—É–≤–∞—ö–µ —Å–æ –∫—Ä–∏–∑–Ω–∏ —Å–∏—Ç—É–∞—Ü–∏–∏ –≤–æ —É—á–∏–ª–∏—à—Ç–µ—Ç–æ –∏–ª–∏ —Å–µ –≥—Ä–∏–∂–∏ –∑–∞ –≤–∫–ª—É—á–µ–Ω–æ—Å—Ç–∞ –Ω–∞ —É—á–µ–Ω–∏—Ü–∏—Ç–µ —Å–æ –¥–µ–≤–∏—ò–∞–Ω—Ç–Ω–æ –æ–¥–Ω–µ—Å—É–≤–∞—ö–µ –≤–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏—Ç–µ –≤–æ –∏ –Ω–∞–¥–≤–æ—Ä –æ–¥ —É—á–∏–ª–∏—à—Ç–µ—Ç–æ, –∏–ª–∏ —Ä–∞–±–æ—Ç–∏ –Ω–∞ –æ–±–µ–∑–±–µ–¥—É–≤–∞—ö–µ —Ü–µ–ª–æ—Å–µ–Ω –æ–ø—Ñ–∞—Ç –Ω–∞ —É—á–µ–Ω–∏—Ü–∏—Ç–µ –æ–¥ —Å–µ–º–µ—ò—Å—Ç–≤–∞ —Å–æ —Å–æ—Ü–∏—ò–∞–ª–µ–Ω —Ä–∏–∑–∏–∫ –∏–ª–∏ —Å–µ –≥—Ä–∏–∂–∏ –∑–∞ —Å–æ–æ–¥–≤–µ—Ç–Ω–∞ –≤–∫–ª—É—á–µ–Ω–æ—Å—Ç–∞ –Ω–∞ —É—á–µ–Ω–∏—Ü–∏—Ç–µ —Å–æ –ø–æ—Å–µ–±–Ω–∏ –æ–±—Ä–∞–∑–æ–≤–Ω–∏ –ø–æ—Ç—Ä–µ–±–∏ –≤–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏—Ç–µ –Ω–∞ —É—á–µ–Ω–∏—á–∫–∏—Ç–µ –∑–∞–µ–¥–Ω–∏—Ü–∏.", col3: "", atts: [], atts1: [], atts2: [], points: 1, checked: false },
                        { col1: "", col2: "–†–∞–∑–≤–∏–≤–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∑–∞ —Å–æ–∑–¥–∞–≤–∞—ö–µ –±–µ–∑–±–µ–¥–Ω–∞ –∏ —Å—Ç–∏–º—É–ª–∞—Ç–∏–≤–Ω–∞ —Å—Ä–µ–¥–∏–Ω–∞ –∑–∞ —É—á–µ—ö–µ.", col3: "", atts: [], atts1: [], atts2: [], points: 2, checked: false },
                        { col1: "", col2: "–ì–æ –æ—Å–º–∏—Å–ª—É–≤–∞ –ø—Ä–æ—Ü–µ—Å–æ—Ç –Ω–∞ –∫—Ä–∏–∑–Ω–∞ –∏–Ω—Ç–µ—Ä–≤–µ–Ω—Ü–∏—ò–∞ –≤–æ —É—á–∏–ª–∏—à—Ç–µ—Ç–æ.", col3: "", atts: [], atts1: [], atts2: [], points: 2, checked: false }
                    ]
                }]
            };

            function $(s) { return document.querySelector(s); }
            function $$(s) { return document.querySelectorAll(s); }
            function t(k) { return LANG[state.lang][k] || k; }
            function esc(s) { var d = document.createElement("div"); d.textContent = s || ""; return d.innerHTML; }
            function fmtSize(b) {
                b = Number(b) || 0;
                if (b < 1024) return b + " B";
                if (b < 1048576) return (b / 1024).toFixed(1) + " KB";
                if (b < 1073741824) return (b / 1048576).toFixed(1) + " MB";
                return (b / 1073741824).toFixed(2) + " GB";
            }

            // Format bar functions
            window.formatText = function (cmd) { document.execCommand(cmd, false, null); };
            window.formatBlock = function (tag) { if (tag) document.execCommand('formatBlock', false, '<' + tag + '>'); };
            window.changeFontSize = function (size) { if (size) document.execCommand('fontSize', false, size); };
            window.changeColor = function (color) { document.execCommand('foreColor', false, color); };

            function showFormatBar(el) {
                var bar = $("#formatBar");
                var rect = el.getBoundingClientRect();
                bar.style.top = (rect.top + window.scrollY - 50) + "px";
                bar.style.left = rect.left + "px";
                bar.classList.add("visible");
            }

            document.addEventListener("click", function (e) {
                if (!e.target.closest(".editable") && !e.target.closest(".format-bar")) {
                    $("#formatBar").classList.remove("visible");
                }
            });

            // Google Drive URL parsing
            function parseGoogleDriveUrl(url) {
                // Handle various Google Drive URL formats
                var patterns = [
                    /drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/,
                    /drive\.google\.com\/open\?id=([a-zA-Z0-9_-]+)/,
                    /docs\.google\.com\/document\/d\/([a-zA-Z0-9_-]+)/,
                    /docs\.google\.com\/spreadsheets\/d\/([a-zA-Z0-9_-]+)/,
                    /docs\.google\.com\/presentation\/d\/([a-zA-Z0-9_-]+)/
                ];

                for (var i = 0; i < patterns.length; i++) {
                    var match = url.match(patterns[i]);
                    if (match) return { id: match[1], type: getGDriveType(url) };
                }
                return null;
            }

            function getGDriveType(url) {
                if (url.includes('docs.google.com/document')) return 'doc';
                if (url.includes('docs.google.com/spreadsheets')) return 'xls';
                if (url.includes('docs.google.com/presentation')) return 'ppt';
                return 'file';
            }

            function getGDrivePreviewUrl(fileId, type) {
                if (type === 'doc') return 'https://docs.google.com/document/d/' + fileId + '/preview';
                if (type === 'xls') return 'https://docs.google.com/spreadsheets/d/' + fileId + '/preview';
                if (type === 'ppt') return 'https://docs.google.com/presentation/d/' + fileId + '/preview';
                return 'https://drive.google.com/file/d/' + fileId + '/preview';
            }

            function getGDriveThumbnailUrl(fileId) {
                return 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w400';
            }

            function getGDriveDirectUrl(fileId) {
                return 'https://drive.google.com/uc?export=view&id=' + fileId;
            }

            function isGoogleDriveUrl(url) {
                return url.includes('drive.google.com') || url.includes('docs.google.com');
            }

            // PDF Cloud Services Detection
            function isPCloudUrl(url) {
                return url.includes('pcloud.com') || url.includes('e.pcloud.com') || url.includes('filelink.pcloud.com');
            }

            function isDropboxUrl(url) {
                return url.includes('dropbox.com') || url.includes('dl.dropboxusercontent.com');
            }

            function isOneDriveUrl(url) {
                return url.includes('onedrive.live.com') || url.includes('1drv.ms') || url.includes('sharepoint.com');
            }

            function getDropboxDirectUrl(url) {
                // Convert Dropbox share link to direct download
                if (url.includes('dropbox.com')) {
                    return url.replace('www.dropbox.com', 'dl.dropboxusercontent.com').replace('?dl=0', '').replace('?dl=1', '');
                }
                return url;
            }

            function getPCloudEmbedUrl(url) {
                // pCloud public links can be embedded directly
                if (url.includes('e.pcloud.com') || url.includes('filelink.pcloud.com')) {
                    return url;
                }
                // For pcloud.com/publink URLs, they can be viewed directly
                return url;
            }

            function isCloudPdfUrl(url) {
                // Check if URL is a PDF from any cloud service
                if (isPdfUrl(url)) return true;

                // Check for cloud service PDF indicators
                var lowerUrl = url.toLowerCase();
                if (isPCloudUrl(url) && (lowerUrl.includes('.pdf') || lowerUrl.includes('pdf'))) return true;
                if (isDropboxUrl(url) && lowerUrl.includes('.pdf')) return true;
                if (isOneDriveUrl(url) && lowerUrl.includes('.pdf')) return true;

                return false;
            }

            function getCloudPdfViewerUrl(url) {
                // Return appropriate viewer URL for cloud PDFs
                if (isDropboxUrl(url)) {
                    return getDropboxDirectUrl(url);
                }
                if (isPCloudUrl(url)) {
                    return getPCloudEmbedUrl(url);
                }
                // For other URLs, try Google Docs viewer for better compatibility
                if (url.includes('.pdf')) {
                    // Use Google Docs Viewer for external PDFs
                    return 'https://docs.google.com/viewer?url=' + encodeURIComponent(url) + '&embedded=true';
                }
                return url;
            }

            // YouTube
            function ytId(url) {
                try {
                    var u = new URL(url);
                    if (u.hostname.indexOf("youtu.be") !== -1) return u.pathname.slice(1).split(/[?#]/)[0];
                    if (u.hostname.indexOf("youtube.com") !== -1) {
                        if (u.searchParams.get("v")) return u.searchParams.get("v");
                        var m = u.pathname.match(/\/(embed|shorts|v)\/([^/?#]+)/);
                        if (m) return m[2];
                    }
                } catch (e) { }
                return null;
            }

            function fileExt(n) { return (n || "").split(".").pop().toLowerCase(); }
            function fileCat(f) {
                var type = f.type || "", ext = fileExt(f.name);
                if (type.indexOf("image/") === 0) return "image";
                if (type.indexOf("video/") === 0) return "video";
                if (type === "application/pdf" || ext === "pdf") return "pdf";
                if (["doc", "docx"].includes(ext)) return "doc";
                if (["xls", "xlsx"].includes(ext)) return "xls";
                if (["ppt", "pptx"].includes(ext)) return "ppt";
                return "file";
            }
            function isImgUrl(u) { return /\.(jpg|jpeg|png|gif|webp|bmp|svg)(\?|$)/i.test(u); }
            function isPdfUrl(u) { return /\.pdf(\?|$)/i.test(u); }

            // Local relative path detection (for USB/portable use)
            function isLocalVideoPath(path) {
                // Check if it's a relative path to a video file (not http/https)
                if (!path || /^https?:\/\//i.test(path)) return false;
                return /\.(mp4|webm|mov|avi|mkv|m4v|ogv)$/i.test(path);
            }

            function isLocalPdfPath(path) {
                // Check if it's a relative path to a PDF file (not http/https)
                if (!path || /^https?:\/\//i.test(path)) return false;
                return /\.pdf$/i.test(path);
            }

            function getVideoNameFromPath(path) {
                // Extract filename from path
                var parts = path.replace(/\\/g, '/').split('/');
                return parts[parts.length - 1] || path;
            }

            // Modal
            function openModal(title, html, extUrl) {
                $("#modalTitle").textContent = title;
                $("#modalBody").innerHTML = html;
                var link = $("#modalLink");
                if (extUrl) { link.href = extUrl; link.style.display = "inline"; }
                else { link.style.display = "none"; }
                setModalSize(800, 500);
                $$(".modal-size-btn").forEach(function (b) { b.classList.toggle("active", b.dataset.w === "800"); });
                $("#modal").classList.add("active");
                document.body.style.overflow = "hidden";
            }
            function closeModal() {
                $("#modal").classList.remove("active");
                document.body.style.overflow = "";
                setTimeout(function () { $("#modalBody").innerHTML = ""; }, 200);
            }
            function setModalSize(w, h) {
                var box = $("#modalBox");
                if (w === "full") {
                    box.style.width = (window.innerWidth - 40) + "px";
                    box.style.height = (window.innerHeight - 40) + "px";
                } else {
                    box.style.width = w + "px";
                    box.style.height = h + "px";
                }
            }

            // Storage

            // ---- v2: per-column attachments + rich descriptions ----
            function normalizeRow(row) {
                if (!row || row.isSection) return;
                if (row.col1 === undefined) row.col1 = "";
                if (row.col2 === undefined) row.col2 = "";
                if (row.col3 === undefined) row.col3 = "";
                if (row.folder === undefined) row.folder = "";

                if (!Array.isArray(row.atts)) row.atts = row.atts ? row.atts : [];
                if (!Array.isArray(row.atts1)) row.atts1 = [];
                if (!Array.isArray(row.atts2)) row.atts2 = [];
            }

            function normalizeState() {
                if (state.showOrder === undefined) state.showOrder = true;

                if (!state.attView) state.attView = "tiles";
                if (!state.attSize) state.attSize = "m";
                if (!state.printAtt) state.printAtt = "text";

                if (!state.pages) state.pages = [];
                state.pages.forEach(function (p) {
                    if (!p.rows) p.rows = [];
                    p.rows.forEach(function (r) { normalizeRow(r); });
                });

            }

            function getAtts(pi, ri, attsKey) {
                var row = state.pages[pi].rows[ri];
                normalizeRow(row);
                if (!Array.isArray(row[attsKey])) row[attsKey] = [];
                return row[attsKey];
            }

            function looksLikeHtml(s) {
                if (!s) return false;
                return /<\/?[a-z][\s\S]*>/i.test(s);
            }

            function setEditableContent(el, val) {
                if (val === undefined || val === null) val = "";
                if (looksLikeHtml(val)) el.innerHTML = val;
                else el.textContent = val;
            }

            function load() {
                var fromEmbed = false;
                var emb = $("#embeddedState");
                if (emb && emb.textContent.trim()) {
                    try {
                        var d = JSON.parse(emb.textContent);
                        if (d.pages) { state = d; emb.textContent = ""; fromEmbed = true; }
                    } catch (e) { }
                }
                if (!fromEmbed) {
                    try {
                        var r = localStorage.getItem(STORAGE_KEY);
                        if (r) {
                            var p = JSON.parse(r);
                            for (var k in p) if (p.hasOwnProperty(k)) state[k] = p[k];
                        }
                    } catch (e) { }
                }
                if (!state.pages || !state.pages.length) {
                    state.pages = [{
                        id: Date.now(),
                        name: t("newPage") + " 1",
                        cols: [t("col1"), t("col2"), t("col3")],
                        rows: []
                    }];
                }
                normalizeState();
                if (fromEmbed) save();
            }
            function save() {
                state.mainTitle = $("#mainTitle").innerHTML;
                state.subtitle = $("#subtitle").innerHTML;
                try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch (e) { }
            }

            // Render
            function applyAttViewAll() {
                // Apply print attachment mode (used by @media print rules)
                document.body.setAttribute("data-print-att", state.printAtt || "compact");

                $$(".att-list").forEach(function (c) {
                    c.dataset.view = state.attView || "tiles";
                    c.dataset.size = state.attSize || "m";
                    clampAttList(c);
                });
            }

            function render() {
                document.body.classList.toggle("dark", state.theme === "dark");
                document.body.classList.toggle("ui-locked", !!state.uiLocked);
                var lb = $("#uiLockBtn");
                if (lb) {
                    lb.textContent = state.uiLocked ? "üîí" : "üîì";
                    lb.classList.toggle("locked", !!state.uiLocked);
                    lb.title = state.uiLocked ? "–û—Ç–∫–ª—É—á–∏ —Ä–∞—Å–ø–æ—Ä–µ–¥ –∏ –≥–æ–ª–µ–º–∏–Ω–∞ –Ω–∞ –ø—Ä–∏–ª–æ–∑–∏" : "–ó–∞–∫–ª—É—á–∏ —Ä–∞—Å–ø–æ—Ä–µ–¥ –∏ –≥–æ–ª–µ–º–∏–Ω–∞ –Ω–∞ –ø—Ä–∏–ª–æ–∑–∏";
                }
                $$("[data-theme]").forEach(function (b) { b.classList.toggle("active", b.dataset.theme === state.theme); });
                $$("[data-lang]").forEach(function (b) { b.classList.toggle("active", b.dataset.lang === state.lang); });

                var ob = $("#toggleOrderBtn");
                if (ob) ob.classList.toggle("active", !!state.showOrder);
                renderTabs();
                renderPages();
                applyAttViewAll();
                updatePointsDisplay();
            }

            // Calculate and display total points
            function updatePointsDisplay() {
                var total = 0;
                state.pages.forEach(function (page) {
                    if (page.rows) {
                        page.rows.forEach(function (row) {
                            if (!row.isSection && row.checked && row.points) {
                                total += row.points;
                            }
                        });
                    }
                });
                var el = $("#pointsValue");
                if (el) el.textContent = total;
            }

            function renderTabs() {
                var c = $("#tabs"); c.innerHTML = "";
                state.pages.forEach(function (p, i) {
                    var tab = document.createElement("div");
                    tab.className = "tab" + (i === state.currentPage ? " active" : "");
                    var inp = document.createElement("input");
                    inp.type = "text"; inp.value = p.name;
                    inp.addEventListener("input", function () { state.pages[i].name = inp.value; save(); });
                    inp.addEventListener("click", function (e) { e.stopPropagation(); });
                    tab.appendChild(inp);
                    if (state.pages.length > 1) {
                        var cb = document.createElement("button"); cb.className = "close-btn"; cb.textContent = "√ó";
                        cb.addEventListener("click", function (e) {
                            e.stopPropagation();
                            if (confirm(t("confirmDel"))) {
                                state.pages.splice(i, 1);
                                if (state.currentPage >= state.pages.length) state.currentPage = state.pages.length - 1;
                                save(); render();
                            }
                        });
                        tab.appendChild(cb);
                    }
                    tab.addEventListener("click", function () { state.currentPage = i; save(); render(); });
                    c.appendChild(tab);
                });
                var addB = document.createElement("button");
                addB.className = "add-tab"; addB.textContent = t("addPage");
                addB.addEventListener("click", function () {
                    state.pages.push({
                        id: Date.now(),
                        name: t("newPage") + " " + (state.pages.length + 1),
                        cols: [t("col1"), t("col2"), t("col3")],
                        rows: []
                    });
                    state.currentPage = state.pages.length - 1;
                    save(); render();
                });
                c.appendChild(addB);
            }

            
            function renderPages() {
                var c = $("#pages"); c.innerHTML = "";
                state.pages.forEach(function (p, pi) {
                    var div = document.createElement("div");
                    div.className = "page" + (pi === state.currentPage ? " active" : "");

                    // Start table container
                    var container = document.createElement("div");
                    div.appendChild(container);

                    if (!p.rows) p.rows = [];

                    // Loop through all rows to render sections and tables
                    var tableRows = [];

                    // Helper to flush current tableRows into a table
                    function flushTable() {
                        if (tableRows.length === 0) return;
                        var tw = document.createElement("div"); tw.className = "table-wrap";
                        var tbl = document.createElement("table");

                        // Header
                        var thead = document.createElement("thead");
                        var hr = document.createElement("tr");

                        if (state.showOrder) {
                            var th0 = document.createElement("th");
                            th0.className = "col-idx";
                            th0.textContent = "#";
                            hr.appendChild(th0);
                        }

                        p.cols.forEach(function (ct, ci) {
                            var th = document.createElement("th");
                            th.className = ci < 2 ? "col-sm" : "col-lg";
                            var ed = document.createElement("div");
                            ed.className = "editable"; ed.contentEditable = "true"; ed.innerHTML = ct;
                            ed.addEventListener("focus", function () { showFormatBar(this); });
                            ed.addEventListener("input", function () { state.pages[pi].cols[ci] = ed.innerHTML; save(); });
                            th.appendChild(ed); hr.appendChild(th);
                        });
                        thead.appendChild(hr); tbl.appendChild(thead);

                        // Body
                        var tbody = document.createElement("tbody");
                        renderRowChunk(tbody, pi, tableRows); // Render collected rows
                        tbl.appendChild(tbody);
                        tw.appendChild(tbl);
                        container.appendChild(tw);

                        tableRows = []; // Clear buffer
                    }

                    var secCounter = 0, rowGlobal = 0, rowInSec = 0;
                    var currentSecNo = ""; // Track actual secNo from section headers

                    p.rows.forEach(function (row, ri) {
                        if (row.isSection) {
                            flushTable(); // Close previous table

                            secCounter += 1;
                            rowInSec = 0;
                            // Use actual secNo from the section (e.g. "1.1", "2.1") instead of counter
                            currentSecNo = (row.secNo !== undefined && row.secNo !== null && String(row.secNo).trim() !== "") ? String(row.secNo) : String(secCounter);

                            // Render Section Divider
                            var secDiv = document.createElement("div");
                            secDiv.className = "section-divider";

                            var headWrap = document.createElement("div");
                            headWrap.className = "sec-head";

                            if (state.showOrder) {
                                var badge = document.createElement("div");
                                badge.className = "sec-badge";

                                var secInput = document.createElement("input");
                                secInput.type = "text";
                                secInput.className = "sec-no";
                                var autoSec = String(secCounter);
                                secInput.value = (row.secNo !== undefined && row.secNo !== null && String(row.secNo).trim() !== "") ? String(row.secNo) : autoSec;
                                secInput.title = "–ë—Ä–æ—ò –Ω–∞ —Å–µ–∫—Ü–∏—ò–∞";
                                secInput.addEventListener("input", function () {
                                    var v = secInput.value.trim();
                                    if (v) state.pages[pi].rows[ri].secNo = v;
                                    else delete state.pages[pi].rows[ri].secNo;
                                    save();
                                });

                                badge.appendChild(secInput);
                                headWrap.appendChild(badge);
                            }

                            var secTitle = document.createElement("div");
                            secTitle.className = "editable";
                            secTitle.contentEditable = "true";
                            secTitle.innerHTML = row.title || "Section";
                            secTitle.addEventListener("focus", function () { showFormatBar(this); });
                            secTitle.addEventListener("input", function () {
                                state.pages[pi].rows[ri].title = secTitle.innerHTML;
                                save();
                            });

                            headWrap.appendChild(secTitle);
                            secDiv.appendChild(headWrap);

                            // Controls for section
                            var ctrlDiv = document.createElement("div");
                            ctrlDiv.className = "section-controls";

                            if (state.showOrder) {
                                var upBtn = document.createElement("button");
                                upBtn.className = "move-btn sec-move";
                                upBtn.type = "button";
                                upBtn.textContent = "‚ñ≤";
                                upBtn.title = "–ü—Ä–µ–º–µ—Å—Ç–∏ —Å–µ–∫—Ü–∏—ò–∞ –Ω–∞–≥–æ—Ä–µ";
                                upBtn.disabled = !!state.uiLocked;
                                upBtn.addEventListener("click", function (e) {
                                    e.preventDefault(); e.stopPropagation();
                                    var idx = state.pages[pi].rows.indexOf(row);
                                    moveSection(pi, idx, -1);
                                });

                                var downBtn = document.createElement("button");
                                downBtn.className = "move-btn sec-move";
                                downBtn.type = "button";
                                downBtn.textContent = "‚ñº";
                                downBtn.title = "–ü—Ä–µ–º–µ—Å—Ç–∏ —Å–µ–∫—Ü–∏—ò–∞ –Ω–∞–¥–æ–ª—É";
                                downBtn.disabled = !!state.uiLocked;
                                downBtn.addEventListener("click", function (e) {
                                    e.preventDefault(); e.stopPropagation();
                                    var idx = state.pages[pi].rows.indexOf(row);
                                    moveSection(pi, idx, +1);
                                });

                                ctrlDiv.appendChild(upBtn);
                                ctrlDiv.appendChild(downBtn);
                            }

                            // Delete button for section
                            var delBtn = document.createElement("button");
                            delBtn.className = "btn btn-sm btn-danger";
                            delBtn.innerHTML = t("deleteRow"); // Reuse delete icon
                            delBtn.addEventListener("click", function () {
                                if (confirm(t("confirmDel"))) {
                                    state.pages[pi].rows.splice(ri, 1);
                                    save(); render();
                                }
                            });
                            ctrlDiv.appendChild(delBtn);

                            secDiv.appendChild(ctrlDiv);
                            container.appendChild(secDiv);
                        } else {
                            // Normal row
                            rowGlobal += 1;
                            rowInSec += 1;
                            tableRows.push({ row: row, index: ri, meta: { sec: secCounter, secNo: currentSecNo, rowInSec: rowInSec, rowGlobal: rowGlobal } });
                        }
                    });

                    flushTable(); // Flush remaining rows

                    var addDiv = document.createElement("div"); addDiv.style.marginTop = "16px"; addDiv.style.display = "flex"; addDiv.style.gap = "10px";

                    var addBtn = document.createElement("button");
                    addBtn.className = "btn btn-primary"; addBtn.textContent = t("addRow");
                    addBtn.addEventListener("click", function () { addRow(pi); });

                    var addSecBtn = document.createElement("button");
                    addSecBtn.className = "btn btn-success"; addSecBtn.textContent = t("addSection");
                    addSecBtn.addEventListener("click", function () { addSection(pi); });

                    addDiv.appendChild(addBtn);
                    addDiv.appendChild(addSecBtn);

                    div.appendChild(addDiv);
                    c.appendChild(div);
                });
            }

            // New helper to render a specific chunk of rows

            
            function renderRowChunk(tbody, pi, rowItems) {
                rowItems.forEach(function (item) {
                    var row = item.row;
                    var ri = item.index; // Original index
                    var meta = item.meta || {};
                    normalizeRow(row);

                    var tr = document.createElement("tr");

                    if (state.showOrder) {
                        var td0 = document.createElement("td");
                        td0.className = "col-idx";

                        var wrap = document.createElement("div");
                        wrap.className = "idx-wrap";

                        var autoNo = "";
                        if (meta.secNo) autoNo = meta.secNo + "." + String(meta.rowInSec || "");
                        else if (meta.sec && meta.sec > 0) autoNo = String(meta.sec) + "." + String(meta.rowInSec || "");
                        else autoNo = String(meta.rowGlobal || "");

                        var inp = document.createElement("input");
                        inp.type = "text";
                        inp.className = "idx-input";
                        var custom = (row.rowNo !== undefined && row.rowNo !== null && String(row.rowNo).trim() !== "") ? String(row.rowNo) : "";
                        inp.value = custom || autoNo;
                        inp.title = "–ë—Ä–æ—ò –Ω–∞ —Ä–µ–¥ (–º–æ–∂–µ –∏ —Ä–∞—á–Ω–æ)";
                        inp.addEventListener("input", function () {
                            var v = inp.value.trim();
                            if (v && v !== autoNo) state.pages[pi].rows[ri].rowNo = v;
                            else delete state.pages[pi].rows[ri].rowNo;
                            save();
                        });

                        var mv = document.createElement("div");
                        mv.className = "idx-move";

                        var up = document.createElement("button");
                        up.type = "button";
                        up.className = "move-btn";
                        up.textContent = "‚ñ≤";
                        up.title = "–ü—Ä–µ–º–µ—Å—Ç–∏ —Ä–µ–¥ –Ω–∞–≥–æ—Ä–µ";
                        up.disabled = (state.uiLocked || ri <= 0);
                        up.addEventListener("click", function (e) {
                            e.preventDefault(); e.stopPropagation();
                            moveRow(pi, ri, -1);
                        });

                        var down = document.createElement("button");
                        down.type = "button";
                        down.className = "move-btn";
                        down.textContent = "‚ñº";
                        down.title = "–ü—Ä–µ–º–µ—Å—Ç–∏ —Ä–µ–¥ –Ω–∞–¥–æ–ª—É";
                        down.disabled = (state.uiLocked || ri >= state.pages[pi].rows.length - 1);
                        down.addEventListener("click", function (e) {
                            e.preventDefault(); e.stopPropagation();
                            moveRow(pi, ri, +1);
                        });

                        mv.appendChild(up);
                        mv.appendChild(down);

                        wrap.appendChild(inp);
                        wrap.appendChild(mv);

                        // Folder access row - auto-generate descriptive name matching BAT structure
                        var folderDiv = document.createElement("div");
                        folderDiv.className = "folder-row";

                        // Build auto folder name: "1.1.1 - Short description from col2"
                        var col2text = (row.col2 || "").replace(/<[^>]*>/g, "").replace(/\s+/g, " ").trim();
                        var shortDesc = col2text.length > 50 ? col2text.substring(0, 50) : col2text;
                        shortDesc = shortDesc.replace(/[\\/:*?"<>|]/g, ""); // Windows-safe
                        var autoFolder = autoNo + " - " + shortDesc;
                        if (autoFolder.length > 80) autoFolder = autoFolder.substring(0, 77) + "...";

                        var folderInput = document.createElement("input");
                        folderInput.type = "text";
                        folderInput.className = "folder-name-input";
                        var effectiveFolder = (row.folder && row.folder.trim()) ? row.folder.trim() : autoFolder;
                        folderInput.value = autoNo; // Show short number in the input
                        folderInput.title = effectiveFolder; // Full name on hover
                        folderInput.placeholder = autoNo;
                        folderInput.addEventListener("input", function () {
                            var v = folderInput.value.trim();
                            if (v && v !== autoNo && v !== autoFolder) state.pages[pi].rows[ri].folder = v;
                            else { state.pages[pi].rows[ri].folder = ""; }
                            save();
                            var eff = v || autoFolder;
                            folderBtn.title = "–û—Ç–≤–æ—Ä–∏: ./" + eff + "/";
                            folderInput.title = eff;
                        });

                        var folderBtn = document.createElement("button");
                        folderBtn.type = "button";
                        folderBtn.className = "folder-btn has-folder";
                        folderBtn.textContent = "üìÇ";
                        folderBtn.title = "–û—Ç–≤–æ—Ä–∏: " + effectiveFolder;
                        folderBtn.addEventListener("click", function (e) {
                            e.preventDefault(); e.stopPropagation();
                            var fname = (row.folder && row.folder.trim()) ? row.folder.trim() : autoFolder;
                            if (!fname) { alert("–ù–µ–º–∞ –∏–º–µ –Ω–∞ —Ñ–æ–ª–¥–µ—Ä"); return; }
                            openFolderBrowser(fname, autoNo);
                        });

                        folderDiv.appendChild(folderInput);
                        folderDiv.appendChild(folderBtn);
                        wrap.appendChild(folderDiv);

                        td0.appendChild(wrap);
                        tr.appendChild(td0);
                    }

                    function renderCell(td, textKey, attsKey, showRowDelete) {
                        td.innerHTML = '<div class="cell-stack">' +
                            '<div class="editable cell-text" contenteditable="true"></div>' +
                            '<div class="cell-att"></div>' +
                            '</div>';

                        var ed = td.querySelector(".cell-text");
                        // Preserve legacy plain text or rich HTML
                        if (row[textKey] !== undefined && row[textKey] !== null) ed.innerHTML = row[textKey];
                        ed.addEventListener("focus", function () { showFormatBar(this); });
                        ed.addEventListener("input", function () {
                            state.pages[pi].rows[ri][textKey] = ed.innerHTML; save();
                        });

                        var attHost = td.querySelector(".cell-att");
                        renderAttCell(attHost, pi, ri, attsKey, !!showRowDelete);
                    }

                    // Col 1
                    var td1 = document.createElement("td");
                    renderCell(td1, "col1", "atts1", false);

                    // Col 2 - Competency with points checkbox
                    var td2 = document.createElement("td");
                    var stack2 = document.createElement("div");
                    stack2.className = "cell-stack";
                    
                    var ed2 = document.createElement("div");
                    ed2.className = "editable cell-text";
                    ed2.contentEditable = "true";
                    if (row.col2 !== undefined && row.col2 !== null) ed2.innerHTML = row.col2;
                    ed2.addEventListener("focus", function () { showFormatBar(this); });
                    ed2.addEventListener("input", function () {
                        state.pages[pi].rows[ri].col2 = ed2.innerHTML; save();
                    });
                    stack2.appendChild(ed2);
                    
                    // Add points checkbox if row has points defined
                    if (row.points !== undefined && row.points > 0) {
                        var checkWrap = document.createElement("div");
                        checkWrap.className = "points-checkbox-wrap";
                        
                        var checkbox = document.createElement("input");
                        checkbox.type = "checkbox";
                        checkbox.className = "points-checkbox";
                        checkbox.checked = !!row.checked;
                        checkbox.addEventListener("change", function () {
                            state.pages[pi].rows[ri].checked = checkbox.checked;
                            save();
                            updatePointsDisplay();
                            badge.className = "points-badge" + (checkbox.checked ? " checked" : "");
                        });
                        
                        var badge = document.createElement("span");
                        badge.className = "points-badge" + (row.checked ? " checked" : "");
                        badge.textContent = row.points + " –±–æ–¥" + (row.points > 1 ? "–∞" : "");
                        
                        var labelText = document.createElement("span");
                        labelText.className = "points-label-text";
                        labelText.textContent = row.checked ? "‚úì –ò—Å–ø–æ–ª–Ω–µ—Ç–æ" : "–û–∑–Ω–∞—á–∏ –∞–∫–æ –µ –∏—Å–ø–æ–ª–Ω–µ—Ç–æ";
                        
                        checkWrap.appendChild(checkbox);
                        checkWrap.appendChild(badge);
                        checkWrap.appendChild(labelText);
                        stack2.appendChild(checkWrap);
                    }
                    
                    var attHost2 = document.createElement("div");
                    attHost2.className = "cell-att";
                    renderAttCell(attHost2, pi, ri, "atts2", false);
                    stack2.appendChild(attHost2);
                    
                    td2.appendChild(stack2);

                    // Col 3
                    var td3 = document.createElement("td");
                    renderCell(td3, "col3", "atts", true);

                    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
                    tbody.appendChild(tr);
                });
            }

            // Replaces old renderRows

            function addSection(pi) {
                state.pages[pi].rows.push({ isSection: true, title: "New Section" });
                // Automatically add a row after a section for convenience
                state.pages[pi].rows.push({ col1: "", col2: "", col3: "", atts1: [], atts2: [], atts: [] });
                save(); render();
            }

            function moveRow(pi, ri, dir) {
                if (state.uiLocked) return;
                var rows = state.pages[pi].rows;
                var ti = ri + dir;
                if (ti < 0 || ti >= rows.length) return;
                var tmp = rows[ri];
                rows[ri] = rows[ti];
                rows[ti] = tmp;
                save(); render();
            }

            // Moves a whole section block (section divider + following rows until next section)
            function moveSection(pi, secIndex, dir) {
                if (state.uiLocked) return;
                var rows = state.pages[pi].rows;
                if (!rows[secIndex] || !rows[secIndex].isSection) return;

                // Find current block
                var start = secIndex;
                var end = secIndex;
                for (var i = secIndex + 1; i < rows.length; i++) {
                    if (rows[i].isSection) break;
                    end = i;
                }

                function findPrevSectionHeader(idx) {
                    for (var j = idx; j >= 0; j--) {
                        if (rows[j] && rows[j].isSection) return j;
                    }
                    return -1;
                }

                function findNextSectionHeader(idx) {
                    for (var j = idx; j < rows.length; j++) {
                        if (rows[j] && rows[j].isSection) return j;
                    }
                    return -1;
                }

                if (dir < 0) {
                    var prevHeader = findPrevSectionHeader(start - 1);
                    if (prevHeader === -1) return;

                    var prevStart = prevHeader;
                    var prevEnd = start - 1;

                    var before = rows.slice(0, prevStart);
                    var prevBlock = rows.slice(prevStart, prevEnd + 1);
                    var curBlock = rows.slice(start, end + 1);
                    var after = rows.slice(end + 1);

                    state.pages[pi].rows = before.concat(curBlock, prevBlock, after);
                    save(); render();
                    return;
                }

                if (dir > 0) {
                    var nextHeader = findNextSectionHeader(end + 1);
                    if (nextHeader === -1) return;

                    var nextStart = nextHeader;
                    var nextEnd = nextHeader;
                    for (var k = nextHeader + 1; k < rows.length; k++) {
                        if (rows[k].isSection) break;
                        nextEnd = k;
                    }

                    var before2 = rows.slice(0, start);
                    var curBlock2 = rows.slice(start, end + 1);
                    var nextBlock = rows.slice(nextStart, nextEnd + 1);
                    var after2 = rows.slice(nextEnd + 1);

                    state.pages[pi].rows = before2.concat(nextBlock, curBlock2, after2);
                    save(); render();
                    return;
                }
            }


            function renderAttCell(host, pi, ri, attsKey, showRowDelete) {
                var fid = "file-" + pi + "-" + ri + "-" + attsKey;
                var html = '<div class="att-cell">' +
                    '<button type="button" class="att-toggle" title="' + esc(t("addMore")) + '" aria-label="' + esc(t("addMore")) + '"><span class="att-toggle-clip">üìé</span><span class="att-toggle-lock" aria-hidden="true">üîí</span></button>' +
                    '<div class="att-bar">' +
                    '<div class="att-bar-title">' + esc(t("addMore")) + '</div>' +
                    '<input type="file" id="' + fid + '" multiple hidden>' +
                    '<div style="display:flex;gap:4px;width:100%;align-items:center;">' +
                    '<input type="text" class="smart-input" placeholder="' + esc(t("urlPlaceholder")) + '" style="flex:1;">' +
                    '<button class="add-smart-btn" style="padding:6px 12px;border:none;border-radius:6px;background:var(--primary);color:white;cursor:pointer;">‚ûï</button>' +
                    '<button class="file-btn" style="padding:6px 12px;border:none;border-radius:6px;background:var(--success);color:white;cursor:pointer;">üìÇ</button>' +
                    '<button class="gdrive-upload-btn" title="–ö–∞—á–∏ –Ω–∞ Google Drive">‚ÜëDrive</button>' +
                    (showRowDelete ? '<button class="row-del" style="padding:6px 12px;border:none;border-radius:6px;background:var(--danger);color:white;cursor:pointer;">üóëÔ∏è</button>' : '') +
                    '</div>' +
                    '</div>' +
                    '<div class="att-list" data-view="' + esc(state.attView || "tiles") + '" data-size="' + esc(state.attSize || "m") + '"></div>' +
                    '</div>';
                host.innerHTML = html;

                var fi = host.querySelector("#" + fid);
                var smartInput = host.querySelector(".smart-input");

                // Toggle attachment bar (click) - hover also works via CSS
                var attCell = host.querySelector(".att-cell");
                var toggleBtn = host.querySelector(".att-toggle");
                if (toggleBtn && attCell) {
                    toggleBtn.addEventListener("click", function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        attCell.classList.toggle("att-open");
                        if (attCell.classList.contains("att-open") && smartInput) {
                            setTimeout(function(){ smartInput.focus(); }, 0);
                        }
                    });
                }


                // File Upload
                host.querySelector(".file-btn").addEventListener("click", function () { fi.click(); });
                fi.addEventListener("change", function (e) {
                    for (var i = 0; i < e.target.files.length; i++) addFile(pi, ri, e.target.files[i], attsKey);
                    e.target.value = "";
                });

                // Google Drive Upload button
                var gduBtn = host.querySelector(".gdrive-upload-btn");
                if (gduBtn) gduBtn.addEventListener("click", function () {
                    window.open("https://drive.google.com/drive/my-drive", "_blank");
                    setTimeout(function () {
                        var tip = "–û—Ç–∫–∞–∫–æ —ú–µ –≥–æ –∫–∞—á–∏—à —Ñ–∞—ò–ª–æ—Ç –Ω–∞ Drive:\n\n" +
                            "1. –î–µ—Å–µ–Ω –∫–ª–∏–∫ ‚Üí Share ‚Üí Copy link\n" +
                            "2. –ü—Ä–æ–≤–µ—Ä–∏ 'Anyone with the link'\n" +
                            "3. –ó–∞–ª–µ–ø–∏ –≥–æ –ª–∏–Ω–∫–æ—Ç –≤–æ Smart –ø–æ–ª–µ—Ç–æ (‚ûï)\n\n" +
                            "–õ–∏–Ω–∫–æ—Ç –∞–≤—Ç–æ–º–∞—Ç—Å–∫–∏ —ú–µ —Å–µ –ø—Ä–µ–ø–æ–∑–Ω–∞–µ –∫–∞–∫–æ Google Drive –ø—Ä–∏–ª–æ–≥.";
                        alert(tip);
                    }, 500);
                });

                // Smart Add Input
                function triggerSmartAdd() {
                    var val = smartInput.value.trim();
                    if (val) {
                        smartHandle(pi, ri, val, attsKey);
                        smartInput.value = "";
                    }
                }

                host.querySelector(".add-smart-btn").addEventListener("click", triggerSmartAdd);
                smartInput.addEventListener("keydown", function (e) {
                    if (e.key === "Enter") triggerSmartAdd();
                });

                if (showRowDelete) {
                    host.querySelector(".row-del").addEventListener("click", function () {
                        if (confirm(t("confirmDel"))) { state.pages[pi].rows.splice(ri, 1); save(); render(); }
                    });
                }

                renderAtts(host.querySelector(".att-list"), pi, ri, attsKey);
            }

            function smartHandle(pi, ri, val, attsKey) {
                // Check if URL
                if (/^https?:\/\//i.test(val) || /^www\./i.test(val)) {
                    // Add protocol if missing
                    if (/^www\./i.test(val)) val = "https://" + val;
                    addLink(pi, ri, val, attsKey);
                    return;
                }

                // Check if likely a URL but missing protocol (e.g. drive.google.com)
                if ((val.includes("drive.google.com") || val.includes("docs.google.com") || val.includes("youtube.com")) && !val.includes(" ")) {
                    if (!/^https?:\/\//i.test(val)) val = "https://" + val;
                    addLink(pi, ri, val, attsKey);
                    return;
                }

                // Treat as local path (Video, PDF, or Folder)
                addLocalPath(pi, ri, val, attsKey);
            }


            // Clamp attachment list to a maximum of ~2 rows; if there are more, make it scrollable.
            // Clamp attachment list to a maximum of ~2 rows/items; if there are more, make it scrollable.
            function clampAttList(c) {
                if (!c) return;
                try {
                    var items = c.querySelectorAll(".att-item");
                    c.classList.remove("clamp2");
                    c.style.maxHeight = "";
                    c.style.overflowY = "";

                    if (!items || !items.length) return;

                    var view = (c.dataset && c.dataset.view) ? c.dataset.view : "tiles";
                    var size = (c.dataset && c.dataset.size) ? c.dataset.size : "m";

                    var cs = getComputedStyle(c);
                    var gap = parseFloat((cs.gap || cs.gridGap || "12").toString()) || 12;

                    // List view: clamp to 2 items
                    if (view === "list") {
                        if (items.length <= 2) return;
                        var h0 = items[0].getBoundingClientRect().height || 0;
                        if (!h0) return;
                        c.style.maxHeight = Math.round(h0 * 2 + gap) + "px";
                        c.style.overflowY = "auto";
                        c.classList.add("clamp2");
                        return;
                    }

                    // Tiles view: clamp to 2 grid rows (size-aware)
                    var minCol = (size === "s") ? 150 : (size === "l") ? 260 : 200;
                    var w = c.clientWidth || 0;
                    if (!w) return;

                    var cols = Math.max(1, Math.floor((w + gap) / (minCol + gap)));
                    var rows = Math.ceil(items.length / cols);

                    if (rows <= 2) return;

                    // Measure first row height (max of first-row tiles)
                    var maxH = 0;
                    for (var i = 0; i < Math.min(cols, items.length); i++) {
                        var h = items[i].getBoundingClientRect().height;
                        if (h > maxH) maxH = h;
                    }
                    if (!maxH) maxH = items[0].getBoundingClientRect().height || 0;
                    if (!maxH) return;

                    c.style.maxHeight = Math.round(maxH * 2 + gap) + "px";
                    c.style.overflowY = "auto";
                    c.classList.add("clamp2");
                } catch (e) { }
            }

            // Recalculate attachment clamp on resize (keeps row height stable)
            window.addEventListener("resize", function () {
                $$(".att-list").forEach(function (x) { clampAttList(x); });
            });


            function renderAtts(c, pi, ri, attsKey) {
                var atts = getAtts(pi, ri, attsKey);
                c.innerHTML = "";
                if (!atts.length) { c.innerHTML = '<div class="empty">' + esc(t("noAtt")) + '</div>'; return; }

                atts.forEach(function (att, ai) {
                    var item = document.createElement("div");
                    item.className = "att-item";
                    var thumbHtml = "", name = att.name || att.title || "File", size = att.size ? fmtSize(att.size) : "";
                    var storageBadge = att.storage === "cloud" ? '<span class="storage-badge cloud">‚òÅÔ∏è</span>' : (att.data ? '<span class="storage-badge local">üìé</span>' : '');

                    if (att.kind === "youtube") {
                        var thumb = "https://i.ytimg.com/vi/" + att.vid + "/hqdefault.jpg";
                        thumbHtml = storageBadge + '<div class="thumb-box"><div class="thumb-content"><img class="thumb-img" src="' + esc(thumb) + '" alt=""></div><div class="yt-play"></div><div class="thumb-hover"><span class="thumb-hover-text">' + esc(t("clickToOpen")) + '</span></div></div>';
                        name = att.title || "YouTube";
                    } else if (att.kind === "gdrive") {
                        // Google Drive file
                        var gType = att.gtype || 'file';
                        var iconClass = gType === 'doc' ? 'doc' : gType === 'xls' ? 'xls' : gType === 'ppt' ? 'ppt' : 'gdrive';
                        var iconEmoji = gType === 'doc' ? 'üìù' : gType === 'xls' ? 'üìä' : gType === 'ppt' ? 'üìΩ' : '‚òÅÔ∏è';

                        // Try to show thumbnail for images
                        if (att.isImage) {
                            thumbHtml = storageBadge + '<div class="thumb-box"><div class="thumb-content"><img class="thumb-img" src="' + esc(getGDriveDirectUrl(att.gid)) + '" alt="" onerror="this.parentElement.innerHTML=\'<div class=thumb-icon-wrap gdrive>‚òÅÔ∏è<span class=thumb-icon-text>DRIVE</span></div>\'"></div><div class="thumb-hover"><span class="thumb-hover-text">' + esc(t("clickToOpen")) + '</span></div></div>';
                        } else {
                            thumbHtml = storageBadge + '<div class="thumb-box"><div class="thumb-content"><div class="thumb-icon-wrap ' + iconClass + '">' + iconEmoji + '<span class="thumb-icon-text">' + gType.toUpperCase() + '</span></div></div><div class="thumb-hover"><span class="thumb-hover-text">' + esc(t("clickToOpen")) + '</span></div></div>';
                        }
                        name = att.title || "Google Drive";
                    } else if (att.kind === "file") {
                        var cat = att.ftype || "file";
                        if (cat === "image" && att.data) {
                            thumbHtml = storageBadge + '<div class="thumb-box"><div class="thumb-content"><img class="thumb-img" src="' + att.data + '" alt=""></div><div class="thumb-hover"><span class="thumb-hover-text">' + esc(t("clickToOpen")) + '</span></div></div>';
                        } else if (cat === "video") {
                            thumbHtml = storageBadge + '<div class="thumb-box"><div class="thumb-content"><div class="thumb-icon-wrap video">üé¨<span class="thumb-icon-text">VIDEO</span></div></div><div class="thumb-hover"><span class="thumb-hover-text">' + esc(t("clickToOpen")) + '</span></div></div>';
                        } else if (cat === "pdf") {
                            thumbHtml = storageBadge + '<div class="thumb-box"><div class="thumb-content"><div class="thumb-icon-wrap pdf">üìÑ<span class="thumb-icon-text">PDF</span></div></div><div class="thumb-hover"><span class="thumb-hover-text">' + esc(t("clickToOpen")) + '</span></div></div>';
                        } else if (cat === "doc") {
                            thumbHtml = storageBadge + '<div class="thumb-box"><div class="thumb-content"><div class="thumb-icon-wrap doc">üìù<span class="thumb-icon-text">DOC</span></div></div></div>';
                        } else if (cat === "xls") {
                            thumbHtml = storageBadge + '<div class="thumb-box"><div class="thumb-content"><div class="thumb-icon-wrap xls">üìä<span class="thumb-icon-text">XLS</span></div></div></div>';
                        } else if (cat === "ppt") {
                            thumbHtml = storageBadge + '<div class="thumb-box"><div class="thumb-content"><div class="thumb-icon-wrap ppt">üìΩ<span class="thumb-icon-text">PPT</span></div></div></div>';
                        } else {
                            var ext = fileExt(att.name).toUpperCase() || "FILE";
                            thumbHtml = storageBadge + '<div class="thumb-box"><div class="thumb-content"><div class="thumb-icon-wrap file">üìÅ<span class="thumb-icon-text">' + esc(ext) + '</span></div></div></div>';
                        }
                        name = att.name;
                    } else if (att.kind === "cloudpdf") {
                        // Cloud PDF from pCloud, Dropbox, OneDrive, or direct PDF links
                        var cloudIcon = "üìÑ";
                        var cloudLabel = "PDF";
                        if (isPCloudUrl(att.url)) cloudLabel = "pCloud";
                        else if (isDropboxUrl(att.url)) cloudLabel = "Dropbox";
                        else if (isOneDriveUrl(att.url)) cloudLabel = "OneDrive";

                        thumbHtml = storageBadge + '<div class="thumb-box"><div class="thumb-content"><div class="thumb-icon-wrap pdf">' + cloudIcon + '<span class="thumb-icon-text">' + cloudLabel + '</span></div></div><div class="thumb-hover"><span class="thumb-hover-text">' + esc(t("clickToOpen")) + '</span></div></div>';
                        name = att.title || "PDF";
                    } else if (att.kind === "localvideo") {
                        // Local video via relative path (portable USB)
                        thumbHtml = '<span class="storage-badge local">üìÅ</span><div class="thumb-box"><div class="thumb-content"><div class="thumb-icon-wrap video">üé¨<span class="thumb-icon-text">VIDEO</span></div></div><div class="thumb-hover"><span class="thumb-hover-text">' + esc(t("clickToOpen")) + '</span></div></div>';
                        name = att.title || att.name || "Video";
                    } else if (att.kind === "localpdf") {
                        // Local PDF via relative path (portable USB)
                        thumbHtml = '<span class="storage-badge local">üìÅ</span><div class="thumb-box"><div class="thumb-content"><div class="thumb-icon-wrap pdf">üìÑ<span class="thumb-icon-text">PDF</span></div></div><div class="thumb-hover"><span class="thumb-hover-text">' + esc(t("clickToOpen")) + '</span></div></div>';
                        name = att.title || att.name || "PDF";
                    } else if (att.kind === "localfolder") {
                        // Local Folder Path
                        thumbHtml = '<span class="storage-badge local">üìÇ</span><div class="thumb-box"><div class="thumb-content"><div class="thumb-icon-wrap file">üìÇ<span class="thumb-icon-text">DIR</span></div></div><div class="thumb-hover"><span class="thumb-hover-text">' + esc(t("clickToOpen")) + '</span></div></div>';
                        name = att.name || "Folder";
                    } else if (att.kind === "localfile") {
                        // Local file via relative path (portable USB)
                        var localExt = fileExt(att.name).toUpperCase() || "FILE";
                        thumbHtml = '<span class="storage-badge local">üìÅ</span><div class="thumb-box"><div class="thumb-content"><div class="thumb-icon-wrap file">üìÅ<span class="thumb-icon-text">' + esc(localExt) + '</span></div></div><div class="thumb-hover"><span class="thumb-hover-text">' + esc(t("clickToOpen")) + '</span></div></div>';
                        name = att.title || att.name || "File";
                    } else if (att.kind === "link") {
                        if (isImgUrl(att.url)) {
                            thumbHtml = storageBadge + '<div class="thumb-box"><div class="thumb-content"><img class="thumb-img" src="' + esc(att.url) + '" alt="" onerror="this.style.display=\'none\'"></div><div class="thumb-hover"><span class="thumb-hover-text">' + esc(t("clickToOpen")) + '</span></div></div>';
                        } else if (isPdfUrl(att.url)) {
                            thumbHtml = storageBadge + '<div class="thumb-box"><div class="thumb-content"><div class="thumb-icon-wrap pdf">üìÑ<span class="thumb-icon-text">PDF</span></div></div><div class="thumb-hover"><span class="thumb-hover-text">' + esc(t("clickToOpen")) + '</span></div></div>';
                        } else {
                            thumbHtml = storageBadge + '<div class="thumb-box"><div class="thumb-content"><div class="thumb-icon-wrap link">üîó<span class="thumb-icon-text">LINK</span></div></div></div>';
                        }
                        name = att.title || att.url;
                    }

                    item.innerHTML = thumbHtml +
                        '<div class="att-info">' +
                        '<div class="att-name" title="' + esc(name) + '">' + esc(name) + '</div>' +
                        '<div class="att-desc editable" contenteditable="true" data-placeholder="' + esc(t("descPlaceholder")) + '"></div>' +
                        '<div class="att-meta">' +
                        '<span class="att-size">' + size + (att.storage === "cloud" ? " ‚òÅÔ∏è" : "") + '</span>' +
                        '<div class="att-btns">' +
                        (att.data ? '<button class="dl">‚¨á</button>' : '') +
                        (att.url ? '<button class="open">‚Üó</button>' : '') +
                        '<button class="del">‚úï</button>' +
                        '</div></div>' +
                        (att.url ? '<a class="print-link" href="' + esc(att.url) + '" target="_blank">' + esc(att.url) + '</a>' : '') +
                        (att.path ? '<a class="print-link" href="' + esc(att.path) + '" target="_blank">' + esc(att.path) + '</a>' : '') +
                        '</div>';

                    // Description event
                    var descEl = item.querySelector(".att-desc");
                    setEditableContent(descEl, att.description || "");
                    descEl.addEventListener("focus", function () { showFormatBar(this); });
                    descEl.addEventListener("input", function () {
                        atts[ai].description = descEl.innerHTML; save();
                    });

                    // Thumb click events
                    var thumbBox = item.querySelector(".thumb-box");
                    if (thumbBox) {
                        thumbBox.addEventListener("click", function () {
                            if (att.kind === "youtube") {
                                openModal(name, '<iframe src="https://www.youtube.com/embed/' + att.vid + '?autoplay=1&rel=0" allow="autoplay; encrypted-media" allowfullscreen></iframe>', att.url);
                            } else if (att.kind === "gdrive") {
                                var previewUrl = getGDrivePreviewUrl(att.gid, att.gtype);
                                if (att.isImage) {
                                    openModal(att.title, '<img src="' + getGDriveDirectUrl(att.gid) + '" alt="">', att.url);
                                } else {
                                    openModal(att.title || "Google Drive", '<iframe src="' + previewUrl + '"></iframe>', att.url);
                                }
                            } else if (att.kind === "file" && att.ftype === "image" && att.data) {
                                openModal(att.name, '<img src="' + att.data + '" alt="">', att.data);
                            } else if (att.kind === "file" && att.ftype === "video" && att.data) {
                                openModal(att.name, '<video controls autoplay src="' + att.data + '"></video>', null);
                            } else if (att.kind === "file" && att.ftype === "pdf" && att.data) {
                                openModal(att.name, '<iframe src="' + att.data + '"></iframe>', att.data);
                            } else if (att.kind === "cloudpdf") {
                                // Cloud PDF from pCloud, Dropbox, OneDrive, or direct links
                                var pdfViewerUrl = getCloudPdfViewerUrl(att.url);
                                openModal(att.title || "PDF", '<iframe src="' + esc(pdfViewerUrl) + '"></iframe>', att.url);
                            } else if (att.kind === "localvideo") {
                                // Local video via relative path (portable USB)
                                openModal(att.title || att.name, '<video controls autoplay src="' + esc(att.path) + '"></video>', null);
                            } else if (att.kind === "localpdf") {
                                // Local PDF via relative path (portable USB)
                                openModal(att.title || att.name, '<iframe src="' + esc(att.path) + '"></iframe>', null);
                            } else if (att.kind === "localfolder") {
                                // Local folder - open in new tab (browser behavior varies)
                                window.open(att.path, "_blank");
                            } else if (att.kind === "localfile") {
                                // Local file via relative path - just open in new tab
                                window.open(att.path, "_blank");
                            } else if (att.kind === "link") {
                                if (isImgUrl(att.url)) openModal(att.title || "Image", '<img src="' + esc(att.url) + '" alt="">', att.url);
                                else if (isCloudPdfUrl(att.url)) {
                                    var viewerUrl = getCloudPdfViewerUrl(att.url);
                                    openModal(att.title || "PDF", '<iframe src="' + esc(viewerUrl) + '"></iframe>', att.url);
                                }
                                else window.open(att.url, "_blank");
                            }
                        });
                    }

                    // Download button
                    var dlB = item.querySelector(".dl");
                    if (dlB) dlB.addEventListener("click", function (e) {
                        e.stopPropagation();
                        var a = document.createElement("a"); a.href = att.data; a.download = att.name; a.click();
                    });

                    // Open external
                    var openB = item.querySelector(".open");
                    if (openB) openB.addEventListener("click", function (e) {
                        e.stopPropagation();
                        window.open(att.url, "_blank");
                    });

                    // Delete button
                    item.querySelector(".del").addEventListener("click", function (e) {
                        e.stopPropagation();
                        atts.splice(ai, 1); save(); render();
                    });

                    c.appendChild(item);
                });

                // Apply 2-row clamp after render
                setTimeout(function(){ clampAttList(c); }, 0);
            }

            function addRow(pi) {
                state.pages[pi].rows.push({ col1: "", col2: "", col3: "", atts1: [], atts2: [], atts: [] });
                save(); render();
            }

            function addFile(pi, ri, file, attsKey) {
                var reader = new FileReader();
                reader.onload = function () {
                    var atts = getAtts(pi, ri, attsKey);
                    atts.push({
                        kind: "file",
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        ftype: fileCat(file),
                        data: reader.result,
                        storage: "local",
                        description: ""
                    });
                    save(); render();
                };
                reader.readAsDataURL(file);
            }

            function addLink(pi, ri, url, attsKey) {
                if (!/^https?:\/\//i.test(url)) url = "https://" + url;
                var atts = getAtts(pi, ri, attsKey);

                // Check if YouTube
                var vid = ytId(url);
                if (vid) {
                    atts.push({
                        kind: "youtube", url: url, vid: vid,
                        title: "YouTube Video", storage: "cloud", description: ""
                    });
                    save(); render();
                    return;
                }

                // Check if Google Drive
                var gd = parseGoogleDriveUrl(url);
                if (gd) {
                    var isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(url);
                    atts.push({
                        kind: "gdrive",
                        url: url,
                        gid: gd.id,
                        gtype: gd.type,
                        isImage: isImage,
                        title: "Google Drive",
                        storage: "cloud",
                        description: ""
                    });
                    save(); render();
                    return;
                }

                // Check if cloud PDF (pCloud, Dropbox, OneDrive, or direct PDF link)
                if (isCloudPdfUrl(url)) {
                    var pdfTitle = "PDF";
                    if (isPCloudUrl(url)) pdfTitle = "PDF (pCloud)";
                    else if (isDropboxUrl(url)) pdfTitle = "PDF (Dropbox)";
                    else if (isOneDriveUrl(url)) pdfTitle = "PDF (OneDrive)";

                    atts.push({
                        kind: "cloudpdf",
                        url: url,
                        title: pdfTitle,
                        storage: "cloud",
                        description: ""
                    });
                    save(); render();
                    return;
                }

                // Regular link
                var domain = "";
                try { domain = new URL(url).hostname; } catch (e) { }
                var title = domain;
                if (isImgUrl(url)) title = "Image";

                atts.push({
                    kind: "link", url: url, title: title || url,
                    storage: "cloud", description: ""
                });
                save(); render();
            }

            // Add local relative path (for USB/portable videos and PDFs)
            function addLocalPath(pi, ri, path, attsKey) {
                var atts = getAtts(pi, ri, attsKey);

                // Normalize path separators (use forward slashes)
                path = path.replace(/\\/g, '/');
                var name = getVideoNameFromPath(path);

                // Check if it's a local video path
                if (isLocalVideoPath(path)) {
                    atts.push({
                        kind: "localvideo", path: path, name: name, title: name,
                        storage: "local", description: ""
                    });
                }

                // Check if it's a local PDF path
                else if (isLocalPdfPath(path)) {
                    atts.push({
                        kind: "localpdf", path: path, name: name, title: name,
                        storage: "local", description: ""
                    });
                }
                // Check if it's a folder (no extension or ends with slash)
                else if (path.indexOf(".") === -1 || path.endsWith("/")) {
                    atts.push({
                        kind: "localfolder", path: path, name: name || path, title: name || path,
                        storage: "local", description: ""
                    });
                }
                // Unknown file type - add as generic local file
                else {
                    atts.push({
                        kind: "localfile",
                        path: path,
                        name: name,
                        title: name,
                        storage: "local",
                        description: ""
                    });
                }
                save(); render();
            }

            // Export/Import
            function exportJson() {
                save();
                var b = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
                dl(b, "tabela.json");
            }

            function exportHtml() {
                save();
                var h = document.documentElement.outerHTML;
                var s = JSON.stringify(state)
                    .replace(/</g, "\\u003c")
                    .replace(/>/g, "\\u003e")
                    .replace(/&/g, "\\u0026");
                h = h.replace(
                    /<script type="application\/json" id="embeddedState"><\/script>/,
                    '<script type="application/json" id="embeddedState">' + s + '<\/script>'
                );
                var b = new Blob([h], { type: "text/html;charset=utf-8" });
                var filename = (state.mainTitle || "tabela").replace(/<[^>]*>/g, "").replace(/[^a-zA-Z0-9\u0400-\u04FF\s-]/g, "").replace(/\s+/g, "_") + ".html";
                dl(b, filename);
            }

            function dl(blob, name) {
                var u = URL.createObjectURL(blob);
                var a = document.createElement("a"); a.href = u; a.download = name; a.click();
                setTimeout(function () { URL.revokeObjectURL(u); }, 100);
            }

            function importJson(e) {
                var f = e.target.files && e.target.files[0];
                if (!f) return;
                var r = new FileReader();
                r.onload = function () {
                    try {
                        var d = JSON.parse(r.result);
                        if (d.pages) {
                            for (var k in d) if (d.hasOwnProperty(k)) state[k] = d[k];
                            normalizeState();
                            save();
                            $("#mainTitle").innerHTML = state.mainTitle;
                            $("#subtitle").innerHTML = state.subtitle;
                            render();
                        }
                    } catch (err) { alert("Error: " + err.message); }
                };
                r.readAsText(f);
                e.target.value = "";
            }

            function printPage() {
                save();
                $$(".page").forEach(function (p, i) { p.classList.toggle("printing", i === state.currentPage); });
                window.print();
                setTimeout(function () { $$(".page").forEach(function (p) { p.classList.remove("printing"); }); }, 1000);
            }

            // Generate folder structure script (.bat for Windows)
            function generateFolderStructure() {
                // Calculate all folder names using same logic as render (secNo-based)
                var folders = [];

                state.pages.forEach(function (p) {
                    if (!p.rows) return;
                    var secCounter = 0, rowGlobal = 0, rowInSec = 0;
                    var currentSecNo = "";

                    p.rows.forEach(function (row) {
                        if (row.isSection) {
                            secCounter++;
                            rowInSec = 0;
                            currentSecNo = (row.secNo !== undefined && row.secNo !== null && String(row.secNo).trim() !== "") ? String(row.secNo) : String(secCounter);
                        } else {
                            rowGlobal++;
                            rowInSec++;

                            // Calculate autoNo using secNo (same as render)
                            var autoNo = "";
                            if (currentSecNo) autoNo = currentSecNo + "." + String(rowInSec);
                            else autoNo = String(rowGlobal);

                            // Use custom rowNo if set, else autoNo; use custom folder if set
                            var rowNo = (row.rowNo !== undefined && row.rowNo !== null && String(row.rowNo).trim() !== "") ? String(row.rowNo) : autoNo;

                            // Build descriptive folder name: "1.1.1 - Short description"
                            var shortDesc = col2.length > 50 ? col2.substring(0, 50) : col2;
                            shortDesc = shortDesc.replace(/[\\/:*?"<>|]/g, "");
                            var autoFolderName = rowNo + " - " + shortDesc;
                            if (autoFolderName.length > 80) autoFolderName = autoFolderName.substring(0, 77) + "...";

                            var folderName = (row.folder && row.folder.trim()) ? row.folder.trim() : autoFolderName;

                            // Extract short competency text
                            var col2 = (row.col2 || "").replace(/<[^>]*>/g, "").replace(/\s+/g, " ").trim();
                            var shortDesc = col2.length > 60 ? col2.substring(0, 57) + "..." : col2;

                            folders.push({ name: folderName, desc: col2, shortDesc: shortDesc, points: row.points || 0 });
                        }
                    });
                });

                if (!folders.length) { alert("–ù–µ–º–∞ —Ä–µ–¥–æ–≤–∏ –∑–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞—ö–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞."); return; }

                // Generate Windows BAT script (UTF-8 with BOM for Cyrillic support)
                var bat = "\uFEFF"; // BOM for UTF-8
                bat += "@echo off\r\n";
                bat += "chcp 65001 >nul\r\n";
                bat += "echo.\r\n";
                bat += "echo =============================================\r\n";
                bat += "echo   –¢–∞–±–µ–ª–∞ —Å–æ –¥–æ–∫–∞–∑–∏ - –ì–µ–Ω–µ—Ä–∏—Ä–∞—ö–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞\r\n";
                bat += "echo   –í–∫—É–ø–Ω–æ —Ñ–æ–ª–¥–µ—Ä–∏: " + folders.length + "\r\n";
                bat += "echo =============================================\r\n";
                bat += "echo.\r\n";
                bat += 'echo –§–æ–ª–¥–µ—Ä–∏—Ç–µ —Å–µ –∫—Ä–µ–∏—Ä–∞–∞—Ç –≤–æ: "%~dp0"\r\n';
                bat += "echo.\r\n\r\n";

                folders.forEach(function (f) {
                    // Folder name is just the number (e.g. "1.1.1")
                    var safeName = f.name.replace(/[\\/:*?"<>|]/g, "").trim();
                    bat += 'if not exist "' + safeName + '" mkdir "' + safeName + '"\r\n';

                    // Create README.txt with competency info
                    var safeDesc = f.desc.replace(/[&|<>^%"]/g, "").replace(/\r?\n/g, " ");
                    bat += 'if not exist "' + safeName + '\\README.txt" (\r\n';
                    bat += '  echo –ö–æ–º–ø–µ—Ç–µ–Ω—Ü–∏—ò–∞: ' + safeName + '> "' + safeName + '\\README.txt"\r\n';
                    bat += '  echo –ë–æ–¥–æ–≤–∏: ' + f.points + '>> "' + safeName + '\\README.txt"\r\n';
                    bat += '  echo.>> "' + safeName + '\\README.txt"\r\n';
                    if (safeDesc.length > 200) safeDesc = safeDesc.substring(0, 200);
                    bat += '  echo ' + safeDesc + '>> "' + safeName + '\\README.txt"\r\n';
                    bat += '  echo.>> "' + safeName + '\\README.txt"\r\n';
                    bat += '  echo –°—Ç–∞–≤–∏ –≥–∏ –¥–æ–∫–∞–∑–∏—Ç–µ –∑–∞ –æ–≤–∞–∞ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏—ò–∞ –≤–æ –æ–≤–æ—ò —Ñ–æ–ª–¥–µ—Ä.>> "' + safeName + '\\README.txt"\r\n';
                    bat += ')\r\n\r\n';
                });

                bat += "echo.\r\n";
                bat += "echo =============================================\r\n";
                bat += "echo   –ì–û–¢–û–í–û! –ö—Ä–µ–∏—Ä–∞–Ω–∏ " + folders.length + " —Ñ–æ–ª–¥–µ—Ä–∏.\r\n";
                bat += "echo =============================================\r\n";
                bat += "echo.\r\n";
                bat += "echo –°–ª–µ–¥–Ω–∏ —á–µ–∫–æ—Ä–∏:\r\n";
                bat += "echo   1. –°—Ç–∞–≤–∏ –¥–æ–∫–∞–∑–∏ –≤–æ —Å–µ–∫–æ—ò —Ñ–æ–ª–¥–µ—Ä\r\n";
                bat += 'echo   2. –û—Ç–≤–æ—Ä–∏ –≥–æ HTML —Ñ–∞—ò–ª–æ—Ç –≤–æ Chrome\r\n';
                bat += "echo   3. –ö–æ—Ä–∏—Å—Ç–∏ –≥–æ üìÇ –∫–æ–ø—á–µ—Ç–æ –∑–∞ —Å–µ–∫–æ—ò —Ä–µ–¥\r\n";
                bat += "echo.\r\n";
                bat += "pause\r\n";

                var blob = new Blob([bat], { type: "text/plain;charset=utf-8" });
                dl(blob, "kreiraj_struktura.bat");

                // Show summary
                var summary = "üìÅ –å–µ —Å–µ –∫—Ä–µ–∏—Ä–∞–∞—Ç " + folders.length + " —Ñ–æ–ª–¥–µ—Ä–∏:\n\n";
                folders.forEach(function (f, i) {
                    if (i < 15) summary += "  " + f.name + "/  (" + f.points + " –±–æ–¥" + (f.points > 1 ? "–∞" : "") + ") " + f.shortDesc + "\n";
                });
                if (folders.length > 15) summary += "  ... –∏ —É—à—Ç–µ " + (folders.length - 15) + " —Ñ–æ–ª–¥–µ—Ä–∏\n";
                summary += "\nüì• –°—Ç–∞–≤–∏ —ò–∞ .bat —Å–∫—Ä–∏–ø—Ç–∞—Ç–∞ –¥–æ HTML —Ñ–∞—ò–ª–æ—Ç –∏ —Å—Ç–∞—Ä—Ç—É–≤–∞—ò —ò–∞.";
                summary += "\n\n‚ö†Ô∏è –ê–∫–æ Windows —ò–∞ –±–ª–æ–∫–∏—Ä–∞: –¥–µ—Å–µ–Ω –∫–ª–∏–∫ ‚Üí Properties ‚Üí Unblock ‚úì";
                alert(summary);
            }

            // Setup
            function setup() {
                $$("[data-theme]").forEach(function (b) {
                    b.addEventListener("click", function () { state.theme = b.dataset.theme; save(); render(); });
                });
                $$("[data-lang]").forEach(function (b) {
                    b.addEventListener("click", function () { state.lang = b.dataset.lang; save(); render(); });
                });

                $("#mainTitle").addEventListener("focus", function () { showFormatBar(this); });
                $("#mainTitle").addEventListener("input", save);
                $("#subtitle").addEventListener("focus", function () { showFormatBar(this); });
                $("#subtitle").addEventListener("input", save);

                $("#helpBtn").addEventListener("click", function () {
                    var h = $("#gdriveHelp");
                    if (!h) return;
                    h.style.display = (h.style.display === "none" || !h.style.display) ? "block" : "none";
                });

                var ob = $("#toggleOrderBtn");
                if (ob) ob.addEventListener("click", function () {
                    state.showOrder = !state.showOrder;
                    save(); render();
                });

                var lb = $("#uiLockBtn");
                if (lb) lb.addEventListener("click", function (e) {
                    e.preventDefault();
                    state.uiLocked = !state.uiLocked;
                    save();
                    render();
                });


                // Attachment view / print mode popover
                var vb = $("#attViewBtn");
                var pop = $("#attViewPop");

                function syncViewButtons() {
                    if (!pop) return;
                    pop.querySelectorAll(".av-btn").forEach(function (b) {
                        var v = b.dataset.view;
                        var s = b.dataset.size;
                        var active = (v === (state.attView || "tiles")) && (v === "list" || s === (state.attSize || "m"));
                        b.classList.toggle("active", !!active);
                    });
                    pop.querySelectorAll(".pv-btn").forEach(function (b) {
                        b.classList.toggle("active", b.dataset.print === (state.printAtt || "compact"));
                    });
                }

                function closeAttPop() {
                    if (!pop) return;
                    pop.classList.remove("open");
                    pop.setAttribute("aria-hidden", "true");
                }

                if (vb && pop) {
                    vb.addEventListener("click", function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        pop.classList.toggle("open");
                        pop.setAttribute("aria-hidden", pop.classList.contains("open") ? "false" : "true");
                        syncViewButtons();
                    });

                    pop.addEventListener("click", function (e) { e.stopPropagation(); });

                    document.addEventListener("click", function () { closeAttPop(); });

                    pop.querySelectorAll(".av-btn").forEach(function (b) {
                        b.addEventListener("click", function () {
                            if (state.uiLocked) return;
                            state.attView = b.dataset.view || "tiles";
                            if (state.attView === "tiles") state.attSize = b.dataset.size || state.attSize || "m";
                            save();
                            applyAttViewAll();
                            syncViewButtons();
                        });
                    });

                    pop.querySelectorAll(".pv-btn").forEach(function (b) {
                        b.addEventListener("click", function () {
                            state.printAtt = b.dataset.print || "compact";
                            save();
                            applyAttViewAll();
                            syncViewButtons();
                        });
                    });

                    syncViewButtons();
                }

                $("#printBtn").addEventListener("click", printPage);

                // Generate folder structure BAT script
                var gsb = $("#genStructBtn");
                if (gsb) gsb.addEventListener("click", generateFolderStructure);

                // Connect folder top button
                var cftb = $("#connectFolderTopBtn");
                if (cftb) cftb.addEventListener("click", function () {
                    connectRootFolder().then(function (ok) {
                        if (ok) {
                            cftb.textContent = "‚úÖ –ü–æ–≤—Ä–∑–∞–Ω–æ";
                            cftb.style.background = "#e8f5e9";
                            cftb.style.color = "#2e7d32";
                        }
                    });
                });

                $("#exportHtmlBtn").addEventListener("click", exportHtml);
                $("#exportJsonBtn").addEventListener("click", exportJson);
                $("#importJsonBtn").addEventListener("click", function () { $("#importFile").click(); });
                $("#importFile").addEventListener("change", importJson);

                // Modal
                $("#modalClose").addEventListener("click", closeModal);
                $("#modal").addEventListener("click", function (e) { if (e.target === this) closeModal(); });
                document.addEventListener("keydown", function (e) { if (e.key === "Escape") closeModal(); });

                $$(".modal-size-btn").forEach(function (b) {
                    b.addEventListener("click", function () {
                        $$(".modal-size-btn").forEach(function (x) { x.classList.remove("active"); });
                        b.classList.add("active");
                        setModalSize(b.dataset.w, b.dataset.h);
                    });
                });

                // Modal drag
                var head = $("#modalHead"), box = $("#modalBox"), dragging = false, sx, sy, sl, st;
                head.addEventListener("mousedown", function (e) {
                    if (e.target.tagName === "BUTTON" || e.target.tagName === "A") return;
                    dragging = true; sx = e.clientX; sy = e.clientY;
                    var r = box.getBoundingClientRect(); sl = r.left; st = r.top;
                    box.style.position = "fixed"; box.style.margin = "0";
                });
                document.addEventListener("mousemove", function (e) {
                    if (!dragging) return;
                    box.style.left = (sl + e.clientX - sx) + "px";
                    box.style.top = (st + e.clientY - sy) + "px";
                });
                document.addEventListener("mouseup", function () { dragging = false; });
            }

            function init() {
                load();
                $("#mainTitle").innerHTML = state.mainTitle;
                $("#subtitle").innerHTML = state.subtitle;
                setup();
                render();
            }

            init();
        })();
    </script>
    <script src="home-button.js"></script>
</body>

</html>
