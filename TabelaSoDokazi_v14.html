<!DOCTYPE html>
<html lang="mk">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>–¢–∞–±–µ–ª–∞ —Å–æ –¥–æ–∫–∞–∑–∏</title>
    <style>
        :root {
            --bg: #f5f5f5;
            --bg2: #ffffff;
            --text: #333333;
            --muted: #666666;
            --border: #d2d2d7;
            --primary: #1877f2;
            --primary-lt: #e7f3ff;
            --danger: #ff4444;
            --success: #22c55e;
            --gdrive: #4285f4;
            --cloud: #34a853;
        }

        .dark {
            --bg: #1a1a2e;
            --bg2: #16213e;
            --text: #f5f5f7;
            --muted: #98989d;
            --border: #3a3a5a;
            --primary: #4dabf7;
            --primary-lt: #1e3a5f;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            background: var(--bg);
            color: var(--text);
            font-family: Arial, sans-serif;
            line-height: 1.6;
        }

        body {
            padding: 20px;
            min-height: 100vh;
        }

        /* Format Bar */
        .format-bar {
            display: none;
            position: absolute;
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px;
            gap: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 100;
            flex-wrap: wrap;
            align-items: center;
        }

        .format-bar.visible {
            display: flex;
        }

        .format-bar button {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            background: var(--bg);
            color: var(--text);
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .format-bar button:hover {
            background: var(--primary);
            color: white;
        }

        .format-bar select {
            padding: 6px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text);
        }

        .editable {
            background: transparent;
            border: 2px dashed transparent;
            border-radius: 8px;
            padding: 10px 14px;
            color: var(--text);
            font-family: inherit;
            min-height: 40px;
            max-height: 72px;
            overflow-y: auto;
            transition: all 0.2s;
            outline: none;
        }

            /* Ensure full cell text prints (no clipping from on-screen scroll limits) */
            .cell-text {
                min-height: auto !important;
                max-height: none !important;
                overflow: visible !important;
            }

            /* Hide 'no attachments' placeholders in print (keeps cells clean) */
            .empty {
                display: none !important;
            }

            /* Attachment description should expand fully in print */
            .att-desc {
                max-height: none !important;
                overflow: visible !important;
            }

            .att-desc[contenteditable="true"]:empty:before {
                content: "" !important;
            }

            /* If attachments list is clamped on screen, disable clamping in print */
            .att-list.clamp2 {
                max-height: none !important;
                height: auto !important;
                overflow: visible !important;
            }

        .editable:hover {
            border-color: var(--border);
            background: var(--bg2);
        }

        .editable:focus {
            border-color: var(--primary);
            background: var(--bg2);
            border-style: solid;
        }

        div.editable {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .main-title {
            font-size: 2rem;
            font-weight: bold;
            min-height: 50px;
            margin-bottom: 8px;
            text-align: center;
            display: block;
            width: 100%;
        }

        .subtitle {
            font-size: 1rem;
            color: var(--muted);
            min-height: 30px;
            margin-bottom: 20px;
            text-align: center;
            display: block;
            width: 100%;
        }

        .controls {
            display: flex;
            position: relative;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 20px;
            padding: 16px;
            background: var(--bg2);
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .btn {
            padding: 10px 18px;
            border-radius: 100px;
            border: none;
            background: var(--bg2);
            color: var(--text);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-gdrive {
            background: var(--gdrive);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn.active {
            background: var(--primary);
            color: white;
        }

        
        /* Discreet order/number controls (rows + sections) */
        .btn.btn-icon {
            padding: 6px 10px;
            font-size: 12px;
            border: 1px solid var(--border);
            background: var(--bg);
            box-shadow: none;
        }

        .btn.btn-icon:hover {
            transform: none;
            box-shadow: none;
            background: var(--primary-lt);
        }

        .btn.btn-icon.active {
            background: var(--primary);
            color: white;
            border-color: transparent;
        }

        /* Attachment view selector (Explorer-like: Tiles S/M/L + List) */
        .att-view-pop {
            position: absolute;
            top: 58px;
            right: 16px;
            background: var(--bg2);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
            display: none;
            z-index: 2000;
            min-width: 240px;
        }

        .att-view-pop.open { display: block; }

        .att-view-pop .row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin: 6px 0;
            flex-wrap: wrap;
        }

        .att-view-pop .lbl {
            font-size: 11px;
            color: var(--muted);
            width: 78px;
            flex: 0 0 auto;
        }

        .att-view-pop button {
            padding: 6px 10px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg);
            color: var(--text);
            cursor: pointer;
            font-size: 12px;
            line-height: 1;
        }

        .att-view-pop button:hover { background: var(--primary-lt); }
        .att-view-pop button.active {
            background: var(--primary);
            color: white;
            border-color: transparent;
        }

        .att-view-pop .hint {
            margin-top: 6px;
            font-size: 11px;
            color: var(--muted);
        }


        th.col-idx,
        td.col-idx {
            width: 64px;
            min-width: 64px;
            max-width: 64px;
            padding: 6px;
            vertical-align: top;
        }

        .idx-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .idx-input {
            width: 52px;
            text-align: center;
            padding: 4px 6px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--bg2);
            color: var(--text);
            font-size: 12px;
            outline: none;
        }

        .idx-input:focus {
            border-color: var(--primary);
        }

        .idx-move {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .move-btn {
            width: 26px;
            height: 26px;
            border: none;
            border-radius: 10px;
            background: var(--bg);
            color: var(--muted);
            cursor: pointer;
            font-size: 12px;
            line-height: 1;
        }

        .move-btn:hover {
            background: var(--primary-lt);
            color: var(--text);
        }

        /* UI Lock (prevents moving rows/sections and changing attachment thumbnail size) */
        .ui-locked .move-btn,
        .ui-locked .sec-move {
            pointer-events: none;
            opacity: 0.25;
        }

        .ui-locked #attViewPop .av-btn {
            pointer-events: none;
            opacity: 0.35;
        }

        .ui-locked #attViewPop .av-btn.active {
            opacity: 0.75;
        }

        .ui-locked #attViewPop .row:first-child .lbl::after {
            content: "  üîí";
            font-size: 12px;
            color: var(--muted);
        }

        /* Lock button states */
        #uiLockBtn.locked {
            background: var(--bg);
            border: 1px solid var(--border);
        }
        .move-btn:disabled {
            opacity: 0.35;
            cursor: default;
        }

        .sec-head {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sec-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .sec-no {
            width: 44px;
            text-align: center;
            padding: 4px 6px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--bg2);
            color: var(--text);
            font-size: 12px;
            outline: none;
        }

        .sec-no:focus {
            border-color: var(--primary);
        }
.spacer {
            flex: 1;
        }

        .toggle-group {
            display: flex;
            gap: 4px;
            background: var(--bg);
            padding: 4px;
            border-radius: 100px;
        }

        .toggle-btn {
            padding: 8px 14px;
            border: none;
            border-radius: 100px;
            background: transparent;
            color: var(--muted);
            cursor: pointer;
            font-size: 13px;
        }

        .toggle-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Tabs */
        .tabs-container {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 20px;
            border-radius: 12px;
            background: var(--bg2);
            color: var(--text);
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        .tab:hover {
            transform: translateY(-2px);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .tab input {
            background: transparent;
            border: none;
            color: inherit;
            font: inherit;
            width: 100px;
            padding: 2px 4px;
        }

        .tab input:focus {
            outline: none;
        }

        .tab .close-btn {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: inherit;
            cursor: pointer;
            font-size: 14px;
        }

        .tab .close-btn:hover {
            background: var(--danger);
        }

        .add-tab {
            padding: 12px 20px;
            border: 2px dashed var(--border);
            border-radius: 12px;
            background: transparent;
            color: var(--muted);
            cursor: pointer;
            font-size: 14px;
        }

        .add-tab:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Table */
        .table-wrap {
            overflow-x: auto;
            border-radius: 12px;
            background: var(--bg2);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
            table-layout: fixed;
        }

        th,
        td {
            border: 1px solid var(--border);
            padding: 0;
            vertical-align: top;
            overflow: hidden;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        th {
            background: var(--bg);
            font-weight: 600;
        }

        th .editable {
            font-weight: 600;
            text-align: center;
        }

        td .editable {
            min-height: 80px;
            width: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .col-sm {
            width: 22%;
        }

        .col-lg {
            width: 56%;
        }

        /* Attachment Cell */
        .att-cell {
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        

        .cell-stack {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .cell-text {
            /* Fixed height (~4 lines). More text becomes scrollable (slider). */
            min-height: 7.8em !important;
            max-height: 7.8em !important;
            overflow-y: auto;
            overflow-x: hidden;
            scrollbar-gutter: stable;
        }
.att-bar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
            padding: 12px;
            background: var(--bg);
            border-radius: 12px;
            margin-bottom: 15px;
            border: 2px dashed var(--border);
        }

        .att-bar-title {
            width: 100%;
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 8px;
        }

        .att-bar input[type="text"] {
            flex: 1;
            min-width: 150px;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 100px;
            background: var(--bg2);
            color: var(--text);
            font-size: 14px;
        }

        .att-bar input[type="text"]:focus {
            outline: none;
            border-color: var(--primary);
        }

        .att-bar input[type="file"] {
            display: none;
        }

        /* Storage Mode Selector */
        .storage-mode {
            display: flex;
            gap: 4px;
            background: var(--bg2);
            padding: 3px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .storage-mode button {
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            background: transparent;
            color: var(--muted);
            cursor: pointer;
            font-size: 11px;
        }

        .storage-mode button.active {
            background: var(--primary);
            color: white;
        }

        .storage-mode button.gdrive.active {
            background: var(--gdrive);
        }

        /* Attachment List (default: Tiles M) */
        .att-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        /* Tiles: S / M / L (Explorer-like sizes) */
        .att-list[data-view="tiles"][data-size="s"] { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
        .att-list[data-view="tiles"][data-size="m"] { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
        .att-list[data-view="tiles"][data-size="l"] { grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); }

        .att-list[data-view="tiles"][data-size="s"] .thumb-box { padding-top: 45%; }
        .att-list[data-view="tiles"][data-size="s"] .thumb-icon-wrap { font-size: 38px; }
        .att-list[data-view="tiles"][data-size="s"] .att-desc { max-height: 60px; }

        /* List view (compact) */
        .att-list[data-view="list"] {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .att-list[data-view="list"] .att-item {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        .att-list[data-view="list"] .thumb-box {
            width: 84px;
            height: 63px;
            padding-top: 0;
            flex: 0 0 auto;
            border-radius: 12px;
        }

        .att-list[data-view="list"] .thumb-content {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .att-list[data-view="list"] .att-info {
            flex: 1;
            background: transparent;
            padding: 0;
        }

        .att-list[data-view="list"] .att-name {
            white-space: normal;
            overflow: visible;
            text-overflow: clip;
            margin-bottom: 4px;
        }

        .att-list[data-view="list"] .att-meta {
            justify-content: flex-start;
            gap: 10px;
        }

        
        /* Keep attachments from growing the table row too tall:
           if there are >2 rows of attachments, the list becomes scrollable (height is set dynamically in JS). */
        .att-list.clamp2 {
            overflow-y: auto;
            overscroll-behavior: contain;
            padding-right: 6px;
            scrollbar-gutter: stable;
        }

        .att-list.clamp2::-webkit-scrollbar { width: 10px; }
        .att-list.clamp2::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.20); border-radius: 10px; }
        .dark .att-list.clamp2::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.25); }
.att-item {
            background: var(--bg2);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            position: relative;
        }

        .att-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        /* Storage Badge */
        .storage-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 5;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
        }

        .storage-badge.local {
            background: var(--success);
        }

        .storage-badge.cloud {
            background: var(--gdrive);
        }

        .thumb-box {
            position: relative;
            width: 100%;
            padding-top: 56.25%;
            background: #1a1a2e;
            overflow: hidden;
            cursor: pointer;
        }

        .thumb-box:hover .thumb-hover {
            opacity: 1;
        }

        .thumb-content {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .thumb-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .thumb-icon-wrap {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 48px;
        }

        .thumb-icon-wrap.pdf {
            background: linear-gradient(135deg, #e53935 0%, #b71c1c 100%);
        }

        .thumb-icon-wrap.doc {
            background: linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);
        }

        .thumb-icon-wrap.xls {
            background: linear-gradient(135deg, #2e7d32 0%, #1b5e20 100%);
        }

        .thumb-icon-wrap.ppt {
            background: linear-gradient(135deg, #d84315 0%, #bf360c 100%);
        }

        .thumb-icon-wrap.video {
            background: linear-gradient(135deg, #7b1fa2 0%, #4a148c 100%);
        }

        .thumb-icon-wrap.link {
            background: linear-gradient(135deg, #1877f2 0%, #0d47a1 100%);
        }

        .thumb-icon-wrap.file {
            background: linear-gradient(135deg, #546e7a 0%, #37474f 100%);
        }

        .thumb-icon-wrap.gdrive {
            background: linear-gradient(135deg, #4285f4 0%, #1a73e8 100%);
        }

        .thumb-icon-text {
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .yt-play {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 42px;
            background: rgba(255, 0, 0, 0.9);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 2;
        }

        .thumb-box:hover .yt-play {
            background: #ff0000;
            transform: translate(-50%, -50%) scale(1.1);
        }

        .yt-play::after {
            content: '';
            border-style: solid;
            border-width: 8px 0 8px 14px;
            border-color: transparent transparent transparent white;
            margin-left: 3px;
        }

        .thumb-hover {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 3;
        }

        .thumb-hover-text {
            background: white;
            color: #333;
            padding: 8px 16px;
            border-radius: 100px;
            font-size: 12px;
            font-weight: 600;
        }

        .att-info {
            padding: 10px 12px;
            background: var(--bg);
        }

        .att-name {
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 6px;
        }

        .att-desc {
            width: 100%;
            padding: 8px;
            margin-top: 6px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg2);
            color: var(--text);
            font-size: 11px;
            min-height: 40px;
            max-height: 72px;
            overflow-y: auto;
            scrollbar-width: thin;
            font-family: inherit;
            white-space: pre-wrap;
        }

        .att-desc[contenteditable="true"]:empty:before {
            content: attr(data-placeholder);
            color: var(--muted);
        }

        .att-desc:focus {
            outline: none;
            border-color: var(--primary);
        }

        .att-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 6px;
        }

        .att-size {
            font-size: 10px;
            color: var(--muted);
        }

        .att-btns {
            display: flex;
            gap: 4px;
        }

        .att-btns button {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 6px;
            border: none;
            background: var(--bg2);
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
        }

        .att-btns button:hover {
            background: var(--primary);
            color: white;
        }

        .att-btns button.del:hover {
            background: var(--danger);
        }

        .empty {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            color: var(--muted);
            font-style: italic;
            background: var(--bg);
            border-radius: 12px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            z-index: 9999;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-box {
            background: var(--bg2);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            resize: both;
            min-width: 400px;
            min-height: 300px;
            max-width: calc(100vw - 40px);
            max-height: calc(100vh - 40px);
        }

        .modal-head {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg);
            border-bottom: 1px solid var(--border);
            cursor: move;
            user-select: none;
            flex-shrink: 0;
        }

        .modal-title {
            font-weight: 600;
            font-size: 14px;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 12px;
        }

        .modal-sizes {
            display: flex;
            gap: 4px;
            margin-right: 12px;
        }

        .modal-size-btn {
            padding: 4px 10px;
            border: none;
            border-radius: 6px;
            background: var(--bg2);
            color: var(--text);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-size-btn:hover,
        .modal-size-btn.active {
            background: var(--primary);
            color: white;
        }

        .modal-link {
            color: var(--primary);
            text-decoration: none;
            font-size: 12px;
            margin-right: 12px;
            white-space: nowrap;
        }

        .modal-link:hover {
            text-decoration: underline;
        }

        .modal-close {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background: var(--danger);
            color: white;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .modal-close:hover {
            background: #cc0000;
        }

        .modal-body {
            flex: 1;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }

        .modal-body iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .modal-body img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .modal-body video {
            max-width: 100%;
            max-height: 100%;
        }

        .modal-box::after {
            content: '‚§°';
            position: absolute;
            bottom: 4px;
            right: 8px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            pointer-events: none;
        }

        /* Google Drive Help Panel */
        .gdrive-help {
            background: var(--primary-lt);
            border: 1px solid var(--gdrive);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .gdrive-help h4 {
            color: var(--gdrive);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .gdrive-help p {
            font-size: 13px;
            color: var(--text);
            margin-bottom: 8px;
        }

        .gdrive-help code {
            background: var(--bg2);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        .gdrive-help .close-help {
            float: right;
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            font-size: 18px;
        }

        .print-link {
            display: none;
        }

        /* Attachment toolbar: hidden by default, shows on hover/click, never prints.
           Toolbar is overlayed (absolute) so it does NOT push thumbnails/videos down. */
        .att-cell {
            position: relative;
        }

        /* Discreet paperclip button */
        .att-toggle {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 22px;
            height: 22px;
            border-radius: 8px;
            border: 1px solid transparent;
            background: transparent;
            color: var(--muted);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            opacity: 0.55;
            transition: opacity 120ms ease, background 120ms ease, border-color 120ms ease, color 120ms ease;
            z-index: 30;
        }

        .att-cell:hover .att-toggle,
        .att-cell.att-open .att-toggle,
        .att-cell:focus-within .att-toggle {
            opacity: 0.95;
        }

        .att-toggle:hover {
            background: var(--bg);
            border-color: var(--border);
            color: var(--text);
        }

        
        /* Toggle icon parts (paperclip + lock when pinned/open) */
        .att-toggle-clip { line-height: 1; }
        .att-toggle-lock { display: none; margin-left: 2px; font-size: 12px; line-height: 1; }

        .att-cell.att-open .att-toggle-lock { display: inline; }

        /* When attachments bar is "locked" open, make the button clearly visible */
        .att-cell.att-open .att-toggle {
            opacity: 1;
            background: var(--primary);
            border-color: var(--primary);
            color: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.12);
        }

        .att-cell.att-open .att-toggle:hover {
            filter: brightness(1.03);
        }
/* Overlay add-attachments bar (appears upward over the text box area) */
        .att-cell .att-bar {
            position: absolute;
            left: 0;
            right: 0;
            bottom: calc(100% + 8px);
            z-index: 40;

            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transform: translateY(6px);

            padding: 12px !important;
            margin: 0 !important;
            border: 2px dashed var(--border) !important;
            background: var(--bg) !important;
            border-radius: 12px;

            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
            transition: opacity 140ms ease, transform 140ms ease, visibility 0ms linear 140ms;
        }

        .att-cell:hover .att-bar,
        .att-cell.att-open .att-bar,
        .att-cell:focus-within .att-bar {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transform: translateY(0);
            transition: opacity 140ms ease, transform 140ms ease, visibility 0ms;
        }

        .print-link {
            display: none;
        }

        @media print {
            body {
                padding: 10mm;
                background: white !important;
                color: black !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .controls,
            .tabs-container,
            .att-bar,
            .att-toggle,
            .btn,
            .toggle-group,
            .add-tab,
            .close-btn,
            .modal-overlay,
            .gdrive-help,
            .att-view-pop,
            .format-bar,
            .video-path-input,
            .video-path-btn {
                display: none !important;
            }

            
            .idx-move,
            .move-btn {
                display: none !important;
            }

            .idx-input,
            .sec-no {
                border: none !important;
                background: transparent !important;
                box-shadow: none !important;
                padding: 0 !important;
                font-weight: bold !important;
            }
.page {
                display: none !important;
            }

            .page.printing {
                display: block !important;
            }

            .main-title,
            .subtitle {
                color: black !important;
            }
            .editable {
                border: none !important;
                padding: 4px !important;
                background: transparent !important;
                color: black !important;
            }

            /* Print: show full text (no 4-line clamp), and hide empty placeholders */
            .cell-text {
                min-height: auto !important;
                max-height: none !important;
                overflow: visible !important;
            }

            /* Hide 'no attachments' placeholder boxes in print (so they don't clutter/cover) */
            .empty {
                display: none !important;
            }

            /* Ensure attachment descriptions are not clamped and don't show placeholder text */
            .att-desc {
                max-height: none !important;
                overflow: visible !important;
            }

            .att-desc[contenteditable="true"]:empty:before {
                content: "" !important;
            }

            /* Expand scroll-clamped attachment lists in print */
            .att-list.clamp2 {
                max-height: none !important;
                height: auto !important;
                overflow: visible !important;
            }

            .table-wrap {
                box-shadow: none;
                overflow: visible;
            }

            table {
                min-width: 100% !important;
                border-collapse: collapse;
            }

            th,
            td {
                border: 2px solid #333 !important;
                overflow: visible !important;
                padding: 8px !important;
                overflow: visible !important;
                vertical-align: top;
                overflow: visible !important;
            }

            th {
                background: #e0e0e0 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .att-cell {
                padding: 10px !important;
            }

            .att-list {
                display: block !important;
                max-height: none !important;
                overflow: visible !important;
            }

            .att-item {
                display: block !important;
                margin-bottom: 15px;
                page-break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ccc;
                border-radius: 8px;
                padding: 10px;
                background: #f9f9f9 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .thumb-box {
                display: inline-block !important;
                width: 60px !important;
                height: 45px !important;
                padding-top: 0 !important;
                vertical-align: middle;
                margin-right: 10px;
            }

            .thumb-content {
                position: relative !important;
                width: 60px !important;
                height: 45px !important;
            }

            .thumb-icon-wrap {
                font-size: 24px !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            .thumb-hover,
            .yt-play,
            .storage-badge,
            .att-btns {
                display: none !important;
            }

            .att-info {
                display: block !important;
                background: transparent !important;
                padding: 5px 0 !important;
            }

            .att-name {
                font-size: 11px !important;
                font-weight: bold !important;
                color: black !important;
                white-space: normal !important;
                overflow: visible !important;
            }

            .att-desc {
                display: block !important;
                border: 1px solid #ccc !important;
                background: white !important;
                color: black !important;
                font-size: 10px !important;
                min-height: 30px !important;
                max-height: none !important;
                padding: 5px !important;
                overflow: visible !important;
            }

            /* Print attachment mode:
               - compact: show name + link only (no description box)
               - text: hide thumbnails (keeps name + description + link)
            */
            body[data-print-att="compact"] .att-desc {
                display: none !important;
            }
            body[data-print-att="compact"] .att-item {
                padding: 8px 10px !important;
            }

            body[data-print-att="text"] .thumb-box,
            body[data-print-att="text"] .thumb-content,
            body[data-print-att="text"] .thumb-icon-wrap {
                display: none !important;
            }


            .att-meta {
                display: none !important;
            }

            /* Show clickable link URLs after attachment items */
            .att-item::after {
                content: "";
                /* Disable pseudo-element as we use real element now */
                display: none;
            }

            /* Print link for attachments */
            .print-link {
                display: block !important;
                font-size: 10px !important;
                color: #0000EE !important;
                word-break: break-all;
                margin-top: 5px;
                text-decoration: underline !important;
                cursor: pointer;
            }

            .att-item {
                overflow: visible !important;
            }

            a {
                color: #0000EE !important;
                text-decoration: underline !important;
            }

            /* Ensure colors print */
            .thumb-icon-wrap.pdf {
                background: #e53935 !important;
            }

            .thumb-icon-wrap.video {
                background: #7b1fa2 !important;
            }

            .thumb-icon-wrap.doc {
                background: #1976d2 !important;
            }

            .thumb-icon-wrap.xls {
                background: #2e7d32 !important;
            }

            .thumb-icon-wrap.ppt {
                background: #d84315 !important;
            }

            .thumb-icon-wrap.link {
                background: #1877f2 !important;
            }

            .thumb-icon-wrap.file {
                background: #546e7a !important;
            }

            .thumb-icon-wrap.gdrive {
                background: #4285f4 !important;
            }

            .section-divider {
                background: #e0e0e0;
                padding: 10px;
                font-weight: bold;
                font-size: 1.2rem;
                margin-top: 20px;
                margin-bottom: 10px;
                border-radius: 8px;
                border: 1px solid #ccc;
                break-inside: avoid;
            }

            .section-controls {
                display: flex;
                justify-content: flex-end;
                gap: 8px;
                margin-top: 4px;
            }

            @media print {
                .section-divider {
                    background: transparent !important;
                    border: none !important;
                    border-bottom: 2px solid #000 !important;
                    color: black !important;
                    margin-top: 30px !important;
                }

                .section-controls {
                    display: none !important;
                }
            }
        }
    </style>
</head>

<body>
    <!-- Help Panel -->
    <div class="gdrive-help" id="gdriveHelp" style="display:none; max-width:600px;">
        <button class="close-help" onclick="this.parentElement.style.display='none'">√ó</button>
        <h4 style="margin-bottom:15px; border-bottom:1px solid var(--border); padding-bottom:10px;">‚ùì –£–ø–∞—Ç—Å—Ç–≤–æ –∑–∞
            –∫–æ—Ä–∏—Å—Ç–µ—ö–µ</h4>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
            <div>
                <h5 style="color:var(--primary); margin-bottom:8px;">üìé –î–æ–¥–∞–≤–∞—ö–µ –ü—Ä–∏–ª–æ–∑–∏</h5>
                <p><strong>1. Smart Input –ø–æ–ª–µ:</strong></p>
                <ul style="padding-left:20px; font-size:13px; margin-bottom:10px; color:var(--text);">
                    <li><strong>–õ–∏–Ω–∫–æ–≤–∏:</strong> –ó–∞–ª–µ–ø–∏ URL (YouTube, Drive, Web) –∏ –ø—Ä–∏—Ç–∏—Å–Ω–∏ Enter.</li>
                    <li><strong>–§–æ–ª–¥–µ—Ä–∏:</strong> –ó–∞–ª–µ–ø–∏ –ø–∞—Ç–µ–∫–∞ (–ø—Ä. <code>documents/</code>) –∑–∞ –ª–∏–Ω–∫ –¥–æ —Ñ–æ–ª–¥–µ—Ä.</li>
                    <li><strong>–õ–æ–∫–∞–ª–Ω–∏ –≤–∏–¥–µ–∞:</strong> –ó–∞–ª–µ–ø–∏ –ø–∞—Ç–µ–∫–∞ (–ø—Ä. <code>videos/video.mp4</code>).</li>
                </ul>
                <p><strong>2. –õ–æ–∫–∞–ª–Ω–∏ –§–∞—ò–ª–æ–≤–∏:</strong></p>
                <p>–ö–ª–∏–∫–Ω–∏ –Ω–∞ –∫–æ–ø—á–µ—Ç–æ üìÇ –∑–∞ –¥–∞ –∏–∑–±–µ—Ä–µ—à —Ñ–∞—ò–ª –æ–¥ —Ç–≤–æ—ò–æ—Ç –∫–æ–º–ø—ò—É—Ç–µ—Ä.</p>
            </div>

            <div>
                <h5 style="color:var(--gdrive); margin-bottom:8px;">‚òÅÔ∏è Google Drive</h5>
                <p><strong>–ö–∞–∫–æ –¥–∞ —Å–ø–æ–¥–µ–ª–∏—à —Ñ–∞—ò–ª:</strong></p>
                <ol style="padding-left:20px; font-size:13px; color:var(--text);">
                    <li>–î–µ—Å–µ–Ω –∫–ª–∏–∫ –Ω–∞ —Ñ–∞—ò–ª–æ—Ç –≤–æ Drive</li>
                    <li>–û–¥–±–µ—Ä–∏ <strong>"Share"</strong> ‚Üí <strong>"Copy Link"</strong></li>
                    <li>–ü—Ä–æ–≤–µ—Ä–∏ –¥–∞–ª–∏ –µ <strong>"Anyone with the link"</strong></li>
                    <li>–ó–∞–ª–µ–ø–∏ –≥–æ –ª–∏–Ω–∫–æ—Ç –≤–æ Smart –ø–æ–ª–µ—Ç–æ</li>
                </ol>
            </div>
        </div>
        <div style="margin-top:15px; background:var(--bg2); padding:10px; border-radius:8px; font-size:12px;">
            üí° <strong>–°–æ–≤–µ—Ç –∑–∞ USB:</strong> –ß—É–≤–∞—ò –≥–∏ –≤–∏–¥–µ–∞—Ç–∞ –≤–æ —Ñ–æ–ª–¥–µ—Ä –¥–æ HTML —Ñ–∞—ò–ª–æ—Ç (–ø—Ä. <code>videos/</code>) –∑–∞ –¥–∞
            —Ä–∞–±–æ—Ç–∞—Ç –Ω–∞ –±–∏–ª–æ –∫–æ—ò –∫–æ–º–ø—ò—É—Ç–µ—Ä —Å–æ —Ä–µ–ª–∞—Ç–∏–≤–Ω–∞ –ø–∞—Ç–µ–∫–∞.
        </div>
    </div>

    <!-- Format Bar -->
    <div class="format-bar" id="formatBar">
        <button onclick="formatText('bold')" title="Bold"><b>B</b></button>
        <button onclick="formatText('italic')" title="Italic"><i>I</i></button>
        <button onclick="formatText('underline')" title="Underline"><u>U</u></button>
        <select onchange="formatBlock(this.value); this.selectedIndex=0;">
            <option value="">–°—Ç–∏–ª</option>
            <option value="h1">H1</option>
            <option value="h2">H2</option>
            <option value="h3">H3</option>
            <option value="p">–ü–∞—Ä–∞–≥—Ä–∞—Ñ</option>
        </select>
        <select onchange="changeFontSize(this.value); this.selectedIndex=0;">
            <option value="">–ì–æ–ª–µ–º–∏–Ω–∞</option>
            <option value="1">–ú–∞–ª–∞</option>
            <option value="3">–ù–æ—Ä–º–∞–ª–Ω–∞</option>
            <option value="5">–ì–æ–ª–µ–º–∞</option>
            <option value="7">–û–≥—Ä–æ–º–Ω–∞</option>
        </select>
        <input type="color" onchange="changeColor(this.value)" title="–ë–æ—ò–∞"
            style="width:32px;height:32px;border:none;cursor:pointer;">
        <button onclick="formatText('justifyLeft')" title="–õ–µ–≤–æ">‚¨Ö</button>
        <button onclick="formatText('justifyCenter')" title="–¶–µ–Ω—Ç–∞—Ä">‚¨õ</button>
        <button onclick="formatText('justifyRight')" title="–î–µ—Å–Ω–æ">‚û°</button>
    </div>

    <div contenteditable="true" class="editable main-title" id="mainTitle">–¢–∞–±–µ–ª–∞ —Å–æ –î–æ–∫–∞–∑–∏</div>
    <div contenteditable="true" class="editable subtitle" id="subtitle">–•–∏–±—Ä–∏–¥–Ω–∞ –≤–µ—Ä–∑–∏—ò–∞ - –ø–æ–¥–¥—Ä–∂—É–≤–∞ –ª–æ–∫–∞–ª–Ω–∏ —Ñ–∞—ò–ª–æ–≤–∏ –ò
        Google Drive –ª–∏–Ω–∫–æ–≤–∏</div>

    <div class="controls">
        <div class="toggle-group">
            <button class="toggle-btn active" data-lang="mk">MK</button>
            <button class="toggle-btn" data-lang="en">EN</button>
        </div>
        <div class="toggle-group">
            <button class="toggle-btn active" data-theme="light">‚òÄÔ∏è</button>
            <button class="toggle-btn" data-theme="dark">üåô</button>
        </div>
        <button class="btn btn-primary" id="helpBtn">‚ùì –ü–æ–º–æ—à</button>
        <button class="btn btn-icon" id="uiLockBtn" title="–ó–∞–∫–ª—É—á–∏/–û—Ç–∫–ª—É—á–∏ —Ä–∞—Å–ø–æ—Ä–µ–¥ –∏ –≥–æ–ª–µ–º–∏–Ω–∞ –Ω–∞ –ø—Ä–∏–ª–æ–∑–∏">üîì</button>
        <button class="btn btn-icon" id="toggleOrderBtn" title="–ù—É–º–µ—Ä–∞—Ü–∏—ò–∞ –∏ —Ä–µ–¥–æ—Å–ª–µ–¥">‚Ññ</button>
        <button class="btn btn-icon" id="attViewBtn" title="–ü—Ä–∏–∫–∞–∑ –Ω–∞ –ø—Ä–∏–ª–æ–∑–∏">‚ñ¶</button>
        <div class="spacer"></div>
        <button class="btn btn-success" id="printBtn">üñ®Ô∏è –ü–µ—á–∞—Ç–∏</button>
        <button class="btn" id="exportHtmlBtn">üìÑ HTML</button>
        <button class="btn" id="exportJsonBtn">üíæ JSON</button>
        <button class="btn" id="importJsonBtn">üìÇ –í–Ω–µ—Å–∏</button>
        <input type="file" id="importFile" accept=".json" hidden>
    </div>

    <div class="att-view-pop" id="attViewPop" aria-hidden="true">
        <div class="row">
            <span class="lbl">–ü—Ä–∏–ª–æ–∑–∏</span>
            <button type="button" class="av-btn" data-view="tiles" data-size="s" title="Tiles S">S</button>
            <button type="button" class="av-btn" data-view="tiles" data-size="m" title="Tiles M">M</button>
            <button type="button" class="av-btn" data-view="tiles" data-size="l" title="Tiles L">L</button>
            <button type="button" class="av-btn" data-view="list" title="List">‚â°</button>
        </div>
        <div class="row">
            <span class="lbl">–ü–µ—á–∞—Ç–∏</span>
            <button type="button" class="pv-btn" data-print="compact" title="–ö–æ–º–ø–∞–∫—Ç–Ω–æ (–±–µ–∑ –æ–ø–∏—Å)">–°–ø–∏—Å–æ–∫</button>
            <button type="button" class="pv-btn" data-print="text" title="–¢–µ–∫—Å—Ç (–±–µ–∑ —Å–ª–∏–∫–∏)">–¢–µ–∫—Å—Ç</button>
            <button type="button" class="pv-btn" data-print="full" title="–ö–∞—Ä—Ç–∏—á–∫–∏ (—Å–æ –æ–ø–∏—Å –∏ —Å–ª–∏–∫–∏)">–ö–∞—Ä—Ç–∏—á–∫–∏</button>
        </div>
        <div class="hint">‚ñ¶ –≤–ª–∏—ò–∞–µ –Ω–∞ —Å–∏—Ç–µ –ø—Ä–∏–ª–æ–∑–∏. –ü–µ—á–∞—Ç–µ—ö–µ: –∏–∑–±–µ—Ä–∏ –∫–∞–∫–æ –¥–∞ —Å–µ –ø—Ä–∏–∫–∞–∂—É–≤–∞–∞—Ç.</div>
    </div>

    <div class="tabs-container" id="tabs"></div>
    <div id="pages"></div>

    <!-- Modal -->
    <div class="modal-overlay" id="modal">
        <div class="modal-box" id="modalBox" style="width:800px;height:500px;">
            <div class="modal-head" id="modalHead">
                <span class="modal-title" id="modalTitle">Preview</span>
                <div class="modal-sizes">
                    <button class="modal-size-btn" data-w="500" data-h="350">S</button>
                    <button class="modal-size-btn active" data-w="800" data-h="500">M</button>
                    <button class="modal-size-btn" data-w="1100" data-h="700">L</button>
                    <button class="modal-size-btn" data-w="full" data-h="full">‚õ∂</button>
                </div>
                <a href="#" target="_blank" class="modal-link" id="modalLink">‚Üó –û—Ç–≤–æ—Ä–∏</a>
                <button class="modal-close" id="modalClose">√ó</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script type="application/json" id="embeddedState"></script>

    <script>
        (function () {
            "use strict";

            var LANG = {
                mk: {
                    addPage: "+ –°—Ç—Ä–∞–Ω–∏—Ü–∞", addRow: "+ –†–µ–¥",
                    addFileLocal: "üìé –õ–æ–∫–∞–ª–µ–Ω", addFileCloud: "‚òÅÔ∏è Drive –ª–∏–Ω–∫",
                    addLink: "üîó –õ–∏–Ω–∫", deleteRow: "üóëÔ∏è",
                    addLocalVideo: "üé¨ –í–∏–¥–µ–æ (–ø–∞—Ç–µ–∫–∞)",
                    col1: "–ö–æ–ª–æ–Ω–∞ 1", col2: "–ö–æ–ª–æ–Ω–∞ 2", col3: "–ü—Ä–∏–ª–æ–∑–∏",
                    urlPlaceholder: "–ó–∞–ª–µ–ø–∏ URL, –ø–∞—Ç–µ–∫–∞ –∏–ª–∏ —Ñ–æ–ª–¥–µ—Ä...",
                    localVideoPlaceholder: "videos/video.mp4",
                    noAtt: "–ù–µ–º–∞ –ø—Ä–∏–ª–æ–∑–∏. –î–æ–¥–∞—ò —Ñ–∞—ò–ª, –ª–∏–Ω–∫ –∏–ª–∏ –ø–∞—Ç–µ–∫–∞.",
                    confirmDel: "–ò–∑–±—Ä–∏—à–∏?", newPage: "–°—Ç—Ä–∞–Ω–∏—Ü–∞",
                    clickToOpen: "–ö–ª–∏–∫–Ω–∏ –∑–∞ –ø—Ä–µ–≥–ª–µ–¥",
                    addMore: "‚ûï –î–æ–¥–∞—ò –ø—Ä–∏–ª–æ–∑–∏",
                    addSection: "+ –°–µ–∫—Ü–∏—ò–∞",
                    descPlaceholder: "–û–ø–∏—Å...",
                    local: "–õ–æ–∫–∞–ª–µ–Ω", cloud: "Cloud",
                    storageLocal: "üìé –í–≥—Ä–∞–¥–∏", storageDrive: "‚òÅÔ∏è –õ–∏–Ω–∫"
                },
                en: {
                    addPage: "+ Page", addRow: "+ Row",
                    addFileLocal: "üìé Local", addFileCloud: "‚òÅÔ∏è Drive Link",
                    addLink: "üîó Link", deleteRow: "üóëÔ∏è",
                    addLocalVideo: "üé¨ Video (path)",
                    col1: "Column 1", col2: "Column 2", col3: "Attachments",
                    urlPlaceholder: "Paste URL, path or folder...",
                    localVideoPlaceholder: "videos/video.mp4",
                    noAtt: "No attachments. Add file, link or path.",
                    confirmDel: "Delete?", newPage: "Page",
                    clickToOpen: "Click to preview",
                    addMore: "‚ûï Add attachments",
                    addSection: "+ Section",
                    descPlaceholder: "Description...",
                    local: "Local", cloud: "Cloud",
                    storageLocal: "üìé Embed", storageDrive: "‚òÅÔ∏è Link"
                }
            };

            var STORAGE_KEY = "table_hybrid_v1";
            var state = {
                lang: "mk", theme: "light",
                showOrder: true,
                uiLocked: false,
                attView: "tiles",      // tiles | list
                attSize: "m",          // s | m | l (tiles only)
                printAtt: "text",      // full | compact | text
                mainTitle: "–¢–∞–±–µ–ª–∞ —Å–æ –î–æ–∫–∞–∑–∏",
                subtitle: "–•–∏–±—Ä–∏–¥–Ω–∞ –≤–µ—Ä–∑–∏—ò–∞",
                currentPage: 0, pages: []
            };

            function $(s) { return document.querySelector(s); }
            function $$(s) { return document.querySelectorAll(s); }
            function t(k) { return LANG[state.lang][k] || k; }
            function esc(s) { var d = document.createElement("div"); d.textContent = s || ""; return d.innerHTML; }
            function fmtSize(b) {
                b = Number(b) || 0;
                if (b < 1024) return b + " B";
                if (b < 1048576) return (b / 1024).toFixed(1) + " KB";
                if (b < 1073741824) return (b / 1048576).toFixed(1) + " MB";
                return (b / 1073741824).toFixed(2) + " GB";
            }

            // Format bar functions
            window.formatText = function (cmd) { document.execCommand(cmd, false, null); };
            window.formatBlock = function (tag) { if (tag) document.execCommand('formatBlock', false, '<' + tag + '>'); };
            window.changeFontSize = function (size) { if (size) document.execCommand('fontSize', false, size); };
            window.changeColor = function (color) { document.execCommand('foreColor', false, color); };

            function showFormatBar(el) {
                var bar = $("#formatBar");
                var rect = el.getBoundingClientRect();
                bar.style.top = (rect.top + window.scrollY - 50) + "px";
                bar.style.left = rect.left + "px";
                bar.classList.add("visible");
            }

            document.addEventListener("click", function (e) {
                if (!e.target.closest(".editable") && !e.target.closest(".format-bar")) {
                    $("#formatBar").classList.remove("visible");
                }
            });

            // Google Drive URL parsing
            function parseGoogleDriveUrl(url) {
                // Handle various Google Drive URL formats
                var patterns = [
                    /drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/,
                    /drive\.google\.com\/open\?id=([a-zA-Z0-9_-]+)/,
                    /docs\.google\.com\/document\/d\/([a-zA-Z0-9_-]+)/,
                    /docs\.google\.com\/spreadsheets\/d\/([a-zA-Z0-9_-]+)/,
                    /docs\.google\.com\/presentation\/d\/([a-zA-Z0-9_-]+)/
                ];

                for (var i = 0; i < patterns.length; i++) {
                    var match = url.match(patterns[i]);
                    if (match) return { id: match[1], type: getGDriveType(url) };
                }
                return null;
            }

            function getGDriveType(url) {
                if (url.includes('docs.google.com/document')) return 'doc';
                if (url.includes('docs.google.com/spreadsheets')) return 'xls';
                if (url.includes('docs.google.com/presentation')) return 'ppt';
                return 'file';
            }

            function getGDrivePreviewUrl(fileId, type) {
                if (type === 'doc') return 'https://docs.google.com/document/d/' + fileId + '/preview';
                if (type === 'xls') return 'https://docs.google.com/spreadsheets/d/' + fileId + '/preview';
                if (type === 'ppt') return 'https://docs.google.com/presentation/d/' + fileId + '/preview';
                return 'https://drive.google.com/file/d/' + fileId + '/preview';
            }

            function getGDriveThumbnailUrl(fileId) {
                return 'https://drive.google.com/thumbnail?id=' + fileId + '&sz=w400';
            }

            function getGDriveDirectUrl(fileId) {
                return 'https://drive.google.com/uc?export=view&id=' + fileId;
            }

            function isGoogleDriveUrl(url) {
                return url.includes('drive.google.com') || url.includes('docs.google.com');
            }

            // PDF Cloud Services Detection
            function isPCloudUrl(url) {
                return url.includes('pcloud.com') || url.includes('e.pcloud.com') || url.includes('filelink.pcloud.com');
            }

            function isDropboxUrl(url) {
                return url.includes('dropbox.com') || url.includes('dl.dropboxusercontent.com');
            }

            function isOneDriveUrl(url) {
                return url.includes('onedrive.live.com') || url.includes('1drv.ms') || url.includes('sharepoint.com');
            }

            function getDropboxDirectUrl(url) {
                // Convert Dropbox share link to direct download
                if (url.includes('dropbox.com')) {
                    return url.replace('www.dropbox.com', 'dl.dropboxusercontent.com').replace('?dl=0', '').replace('?dl=1', '');
                }
                return url;
            }

            function getPCloudEmbedUrl(url) {
                // pCloud public links can be embedded directly
                if (url.includes('e.pcloud.com') || url.includes('filelink.pcloud.com')) {
                    return url;
                }
                // For pcloud.com/publink URLs, they can be viewed directly
                return url;
            }

            function isCloudPdfUrl(url) {
                // Check if URL is a PDF from any cloud service
                if (isPdfUrl(url)) return true;

                // Check for cloud service PDF indicators
                var lowerUrl = url.toLowerCase();
                if (isPCloudUrl(url) && (lowerUrl.includes('.pdf') || lowerUrl.includes('pdf'))) return true;
                if (isDropboxUrl(url) && lowerUrl.includes('.pdf')) return true;
                if (isOneDriveUrl(url) && lowerUrl.includes('.pdf')) return true;

                return false;
            }

            function getCloudPdfViewerUrl(url) {
                // Return appropriate viewer URL for cloud PDFs
                if (isDropboxUrl(url)) {
                    return getDropboxDirectUrl(url);
                }
                if (isPCloudUrl(url)) {
                    return getPCloudEmbedUrl(url);
                }
                // For other URLs, try Google Docs viewer for better compatibility
                if (url.includes('.pdf')) {
                    // Use Google Docs Viewer for external PDFs
                    return 'https://docs.google.com/viewer?url=' + encodeURIComponent(url) + '&embedded=true';
                }
                return url;
            }

            // YouTube
            function ytId(url) {
                try {
                    var u = new URL(url);
                    if (u.hostname.indexOf("youtu.be") !== -1) return u.pathname.slice(1).split(/[?#]/)[0];
                    if (u.hostname.indexOf("youtube.com") !== -1) {
                        if (u.searchParams.get("v")) return u.searchParams.get("v");
                        var m = u.pathname.match(/\/(embed|shorts|v)\/([^/?#]+)/);
                        if (m) return m[2];
                    }
                } catch (e) { }
                return null;
            }

            function fileExt(n) { return (n || "").split(".").pop().toLowerCase(); }
            function fileCat(f) {
                var type = f.type || "", ext = fileExt(f.name);
                if (type.indexOf("image/") === 0) return "image";
                if (type.indexOf("video/") === 0) return "video";
                if (type === "application/pdf" || ext === "pdf") return "pdf";
                if (["doc", "docx"].includes(ext)) return "doc";
                if (["xls", "xlsx"].includes(ext)) return "xls";
                if (["ppt", "pptx"].includes(ext)) return "ppt";
                return "file";
            }
            function isImgUrl(u) { return /\.(jpg|jpeg|png|gif|webp|bmp|svg)(\?|$)/i.test(u); }
            function isPdfUrl(u) { return /\.pdf(\?|$)/i.test(u); }

            // Local relative path detection (for USB/portable use)
            function isLocalVideoPath(path) {
                // Check if it's a relative path to a video file (not http/https)
                if (!path || /^https?:\/\//i.test(path)) return false;
                return /\.(mp4|webm|mov|avi|mkv|m4v|ogv)$/i.test(path);
            }

            function isLocalPdfPath(path) {
                // Check if it's a relative path to a PDF file (not http/https)
                if (!path || /^https?:\/\//i.test(path)) return false;
                return /\.pdf$/i.test(path);
            }

            function getVideoNameFromPath(path) {
                // Extract filename from path
                var parts = path.replace(/\\/g, '/').split('/');
                return parts[parts.length - 1] || path;
            }

            // Modal
            function openModal(title, html, extUrl) {
                $("#modalTitle").textContent = title;
                $("#modalBody").innerHTML = html;
                var link = $("#modalLink");
                if (extUrl) { link.href = extUrl; link.style.display = "inline"; }
                else { link.style.display = "none"; }
                setModalSize(800, 500);
                $$(".modal-size-btn").forEach(function (b) { b.classList.toggle("active", b.dataset.w === "800"); });
                $("#modal").classList.add("active");
                document.body.style.overflow = "hidden";
            }
            function closeModal() {
                $("#modal").classList.remove("active");
                document.body.style.overflow = "";
                setTimeout(function () { $("#modalBody").innerHTML = ""; }, 200);
            }
            function setModalSize(w, h) {
                var box = $("#modalBox");
                if (w === "full") {
                    box.style.width = (window.innerWidth - 40) + "px";
                    box.style.height = (window.innerHeight - 40) + "px";
                } else {
                    box.style.width = w + "px";
                    box.style.height = h + "px";
                }
            }

            // Storage

            // ---- v2: per-column attachments + rich descriptions ----
            function normalizeRow(row) {
                if (!row || row.isSection) return;
                if (row.col1 === undefined) row.col1 = "";
                if (row.col2 === undefined) row.col2 = "";
                if (row.col3 === undefined) row.col3 = "";

                if (!Array.isArray(row.atts)) row.atts = row.atts ? row.atts : [];
                if (!Array.isArray(row.atts1)) row.atts1 = [];
                if (!Array.isArray(row.atts2)) row.atts2 = [];
            }

            function normalizeState() {
                if (state.showOrder === undefined) state.showOrder = true;

                if (!state.attView) state.attView = "tiles";
                if (!state.attSize) state.attSize = "m";
                if (!state.printAtt) state.printAtt = "text";

                if (!state.pages) state.pages = [];
                state.pages.forEach(function (p) {
                    if (!p.rows) p.rows = [];
                    p.rows.forEach(function (r) { normalizeRow(r); });
                });

            }

            function getAtts(pi, ri, attsKey) {
                var row = state.pages[pi].rows[ri];
                normalizeRow(row);
                if (!Array.isArray(row[attsKey])) row[attsKey] = [];
                return row[attsKey];
            }

            function looksLikeHtml(s) {
                if (!s) return false;
                return /<\/?[a-z][\s\S]*>/i.test(s);
            }

            function setEditableContent(el, val) {
                if (val === undefined || val === null) val = "";
                if (looksLikeHtml(val)) el.innerHTML = val;
                else el.textContent = val;
            }

            function load() {
                var fromEmbed = false;
                var emb = $("#embeddedState");
                if (emb && emb.textContent.trim()) {
                    try {
                        var d = JSON.parse(emb.textContent);
                        if (d.pages) { state = d; emb.textContent = ""; fromEmbed = true; }
                    } catch (e) { }
                }
                if (!fromEmbed) {
                    try {
                        var r = localStorage.getItem(STORAGE_KEY);
                        if (r) {
                            var p = JSON.parse(r);
                            for (var k in p) if (p.hasOwnProperty(k)) state[k] = p[k];
                        }
                    } catch (e) { }
                }
                if (!state.pages || !state.pages.length) {
                    state.pages = [{
                        id: Date.now(),
                        name: t("newPage") + " 1",
                        cols: [t("col1"), t("col2"), t("col3")],
                        rows: []
                    }];
                }
                normalizeState();
                if (fromEmbed) save();
            }
            function save() {
                state.mainTitle = $("#mainTitle").innerHTML;
                state.subtitle = $("#subtitle").innerHTML;
                try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch (e) { }
            }

            // Render
            function applyAttViewAll() {
                // Apply print attachment mode (used by @media print rules)
                document.body.setAttribute("data-print-att", state.printAtt || "compact");

                $$(".att-list").forEach(function (c) {
                    c.dataset.view = state.attView || "tiles";
                    c.dataset.size = state.attSize || "m";
                    clampAttList(c);
                });
            }

            function render() {
                document.body.classList.toggle("dark", state.theme === "dark");
                document.body.classList.toggle("ui-locked", !!state.uiLocked);
                var lb = $("#uiLockBtn");
                if (lb) {
                    lb.textContent = state.uiLocked ? "üîí" : "üîì";
                    lb.classList.toggle("locked", !!state.uiLocked);
                    lb.title = state.uiLocked ? "–û—Ç–∫–ª—É—á–∏ —Ä–∞—Å–ø–æ—Ä–µ–¥ –∏ –≥–æ–ª–µ–º–∏–Ω–∞ –Ω–∞ –ø—Ä–∏–ª–æ–∑–∏" : "–ó–∞–∫–ª—É—á–∏ —Ä–∞—Å–ø–æ—Ä–µ–¥ –∏ –≥–æ–ª–µ–º–∏–Ω–∞ –Ω–∞ –ø—Ä–∏–ª–æ–∑–∏";
                }
                $$("[data-theme]").forEach(function (b) { b.classList.toggle("active", b.dataset.theme === state.theme); });
                $$("[data-lang]").forEach(function (b) { b.classList.toggle("active", b.dataset.lang === state.lang); });

                var ob = $("#toggleOrderBtn");
                if (ob) ob.classList.toggle("active", !!state.showOrder);
                renderTabs();
                renderPages();
                applyAttViewAll();
            }

            function renderTabs() {
                var c = $("#tabs"); c.innerHTML = "";
                state.pages.forEach(function (p, i) {
                    var tab = document.createElement("div");
                    tab.className = "tab" + (i === state.currentPage ? " active" : "");
                    var inp = document.createElement("input");
                    inp.type = "text"; inp.value = p.name;
                    inp.addEventListener("input", function () { state.pages[i].name = inp.value; save(); });
                    inp.addEventListener("click", function (e) { e.stopPropagation(); });
                    tab.appendChild(inp);
                    if (state.pages.length > 1) {
                        var cb = document.createElement("button"); cb.className = "close-btn"; cb.textContent = "√ó";
                        cb.addEventListener("click", function (e) {
                            e.stopPropagation();
                            if (confirm(t("confirmDel"))) {
                                state.pages.splice(i, 1);
                                if (state.currentPage >= state.pages.length) state.currentPage = state.pages.length - 1;
                                save(); render();
                            }
                        });
                        tab.appendChild(cb);
                    }
                    tab.addEventListener("click", function () { state.currentPage = i; save(); render(); });
                    c.appendChild(tab);
                });
                var addB = document.createElement("button");
                addB.className = "add-tab"; addB.textContent = t("addPage");
                addB.addEventListener("click", function () {
                    state.pages.push({
                        id: Date.now(),
                        name: t("newPage") + " " + (state.pages.length + 1),
                        cols: [t("col1"), t("col2"), t("col3")],
                        rows: []
                    });
                    state.currentPage = state.pages.length - 1;
                    save(); render();
                });
                c.appendChild(addB);
            }

            
            function renderPages() {
                var c = $("#pages"); c.innerHTML = "";
                state.pages.forEach(function (p, pi) {
                    var div = document.createElement("div");
                    div.className = "page" + (pi === state.currentPage ? " active" : "");

                    // Start table container
                    var container = document.createElement("div");
                    div.appendChild(container);

                    if (!p.rows) p.rows = [];

                    // Loop through all rows to render sections and tables
                    var tableRows = [];

                    // Helper to flush current tableRows into a table
                    function flushTable() {
                        if (tableRows.length === 0) return;
                        var tw = document.createElement("div"); tw.className = "table-wrap";
                        var tbl = document.createElement("table");

                        // Header
                        var thead = document.createElement("thead");
                        var hr = document.createElement("tr");

                        if (state.showOrder) {
                            var th0 = document.createElement("th");
                            th0.className = "col-idx";
                            th0.textContent = "#";
                            hr.appendChild(th0);
                        }

                        p.cols.forEach(function (ct, ci) {
                            var th = document.createElement("th");
                            th.className = ci < 2 ? "col-sm" : "col-lg";
                            var ed = document.createElement("div");
                            ed.className = "editable"; ed.contentEditable = "true"; ed.innerHTML = ct;
                            ed.addEventListener("focus", function () { showFormatBar(this); });
                            ed.addEventListener("input", function () { state.pages[pi].cols[ci] = ed.innerHTML; save(); });
                            th.appendChild(ed); hr.appendChild(th);
                        });
                        thead.appendChild(hr); tbl.appendChild(thead);

                        // Body
                        var tbody = document.createElement("tbody");
                        renderRowChunk(tbody, pi, tableRows); // Render collected rows
                        tbl.appendChild(tbody);
                        tw.appendChild(tbl);
                        container.appendChild(tw);

                        tableRows = []; // Clear buffer
                    }

                    var secCounter = 0, rowGlobal = 0, rowInSec = 0;

                    p.rows.forEach(function (row, ri) {
                        if (row.isSection) {
                            flushTable(); // Close previous table

                            secCounter += 1;
                            rowInSec = 0;

                            // Render Section Divider
                            var secDiv = document.createElement("div");
                            secDiv.className = "section-divider";

                            var headWrap = document.createElement("div");
                            headWrap.className = "sec-head";

                            if (state.showOrder) {
                                var badge = document.createElement("div");
                                badge.className = "sec-badge";

                                var secInput = document.createElement("input");
                                secInput.type = "text";
                                secInput.className = "sec-no";
                                var autoSec = String(secCounter);
                                secInput.value = (row.secNo !== undefined && row.secNo !== null && String(row.secNo).trim() !== "") ? String(row.secNo) : autoSec;
                                secInput.title = "–ë—Ä–æ—ò –Ω–∞ —Å–µ–∫—Ü–∏—ò–∞";
                                secInput.addEventListener("input", function () {
                                    var v = secInput.value.trim();
                                    if (v) state.pages[pi].rows[ri].secNo = v;
                                    else delete state.pages[pi].rows[ri].secNo;
                                    save();
                                });

                                badge.appendChild(secInput);
                                headWrap.appendChild(badge);
                            }

                            var secTitle = document.createElement("div");
                            secTitle.className = "editable";
                            secTitle.contentEditable = "true";
                            secTitle.innerHTML = row.title || "Section";
                            secTitle.addEventListener("focus", function () { showFormatBar(this); });
                            secTitle.addEventListener("input", function () {
                                state.pages[pi].rows[ri].title = secTitle.innerHTML;
                                save();
                            });

                            headWrap.appendChild(secTitle);
                            secDiv.appendChild(headWrap);

                            // Controls for section
                            var ctrlDiv = document.createElement("div");
                            ctrlDiv.className = "section-controls";

                            if (state.showOrder) {
                                var upBtn = document.createElement("button");
                                upBtn.className = "move-btn sec-move";
                                upBtn.type = "button";
                                upBtn.textContent = "‚ñ≤";
                                upBtn.title = "–ü—Ä–µ–º–µ—Å—Ç–∏ —Å–µ–∫—Ü–∏—ò–∞ –Ω–∞–≥–æ—Ä–µ";
                                upBtn.disabled = !!state.uiLocked;
                                upBtn.addEventListener("click", function (e) {
                                    e.preventDefault(); e.stopPropagation();
                                    var idx = state.pages[pi].rows.indexOf(row);
                                    moveSection(pi, idx, -1);
                                });

                                var downBtn = document.createElement("button");
                                downBtn.className = "move-btn sec-move";
                                downBtn.type = "button";
                                downBtn.textContent = "‚ñº";
                                downBtn.title = "–ü—Ä–µ–º–µ—Å—Ç–∏ —Å–µ–∫—Ü–∏—ò–∞ –Ω–∞–¥–æ–ª—É";
                                downBtn.disabled = !!state.uiLocked;
                                downBtn.addEventListener("click", function (e) {
                                    e.preventDefault(); e.stopPropagation();
                                    var idx = state.pages[pi].rows.indexOf(row);
                                    moveSection(pi, idx, +1);
                                });

                                ctrlDiv.appendChild(upBtn);
                                ctrlDiv.appendChild(downBtn);
                            }

                            // Delete button for section
                            var delBtn = document.createElement("button");
                            delBtn.className = "btn btn-sm btn-danger";
                            delBtn.innerHTML = t("deleteRow"); // Reuse delete icon
                            delBtn.addEventListener("click", function () {
                                if (confirm(t("confirmDel"))) {
                                    state.pages[pi].rows.splice(ri, 1);
                                    save(); render();
                                }
                            });
                            ctrlDiv.appendChild(delBtn);

                            secDiv.appendChild(ctrlDiv);
                            container.appendChild(secDiv);
                        } else {
                            // Normal row
                            rowGlobal += 1;
                            rowInSec += 1;
                            tableRows.push({ row: row, index: ri, meta: { sec: secCounter, rowInSec: rowInSec, rowGlobal: rowGlobal } });
                        }
                    });

                    flushTable(); // Flush remaining rows

                    var addDiv = document.createElement("div"); addDiv.style.marginTop = "16px"; addDiv.style.display = "flex"; addDiv.style.gap = "10px";

                    var addBtn = document.createElement("button");
                    addBtn.className = "btn btn-primary"; addBtn.textContent = t("addRow");
                    addBtn.addEventListener("click", function () { addRow(pi); });

                    var addSecBtn = document.createElement("button");
                    addSecBtn.className = "btn btn-success"; addSecBtn.textContent = t("addSection");
                    addSecBtn.addEventListener("click", function () { addSection(pi); });

                    addDiv.appendChild(addBtn);
                    addDiv.appendChild(addSecBtn);

                    div.appendChild(addDiv);
                    c.appendChild(div);
                });
            }

            // New helper to render a specific chunk of rows

            
            function renderRowChunk(tbody, pi, rowItems) {
                rowItems.forEach(function (item) {
                    var row = item.row;
                    var ri = item.index; // Original index
                    var meta = item.meta || {};
                    normalizeRow(row);

                    var tr = document.createElement("tr");

                    if (state.showOrder) {
                        var td0 = document.createElement("td");
                        td0.className = "col-idx";

                        var wrap = document.createElement("div");
                        wrap.className = "idx-wrap";

                        var autoNo = "";
                        if (meta.sec && meta.sec > 0) autoNo = String(meta.sec) + "." + String(meta.rowInSec || "");
                        else autoNo = String(meta.rowGlobal || "");

                        var inp = document.createElement("input");
                        inp.type = "text";
                        inp.className = "idx-input";
                        var custom = (row.rowNo !== undefined && row.rowNo !== null && String(row.rowNo).trim() !== "") ? String(row.rowNo) : "";
                        inp.value = custom || autoNo;
                        inp.title = "–ë—Ä–æ—ò –Ω–∞ —Ä–µ–¥ (–º–æ–∂–µ –∏ —Ä–∞—á–Ω–æ)";
                        inp.addEventListener("input", function () {
                            var v = inp.value.trim();
                            if (v && v !== autoNo) state.pages[pi].rows[ri].rowNo = v;
                            else delete state.pages[pi].rows[ri].rowNo;
                            save();
                        });

                        var mv = document.createElement("div");
                        mv.className = "idx-move";

                        var up = document.createElement("button");
                        up.type = "button";
                        up.className = "move-btn";
                        up.textContent = "‚ñ≤";
                        up.title = "–ü—Ä–µ–º–µ—Å—Ç–∏ —Ä–µ–¥ –Ω–∞–≥–æ—Ä–µ";
                        up.disabled = (state.uiLocked || ri <= 0);
                        up.addEventListener("click", function (e) {
                            e.preventDefault(); e.stopPropagation();
                            moveRow(pi, ri, -1);
                        });

                        var down = document.createElement("button");
                        down.type = "button";
                        down.className = "move-btn";
                        down.textContent = "‚ñº";
                        down.title = "–ü—Ä–µ–º–µ—Å—Ç–∏ —Ä–µ–¥ –Ω–∞–¥–æ–ª—É";
                        down.disabled = (state.uiLocked || ri >= state.pages[pi].rows.length - 1);
                        down.addEventListener("click", function (e) {
                            e.preventDefault(); e.stopPropagation();
                            moveRow(pi, ri, +1);
                        });

                        mv.appendChild(up);
                        mv.appendChild(down);

                        wrap.appendChild(inp);
                        wrap.appendChild(mv);
                        td0.appendChild(wrap);
                        tr.appendChild(td0);
                    }

                    function renderCell(td, textKey, attsKey, showRowDelete) {
                        td.innerHTML = '<div class="cell-stack">' +
                            '<div class="editable cell-text" contenteditable="true"></div>' +
                            '<div class="cell-att"></div>' +
                            '</div>';

                        var ed = td.querySelector(".cell-text");
                        // Preserve legacy plain text or rich HTML
                        if (row[textKey] !== undefined && row[textKey] !== null) ed.innerHTML = row[textKey];
                        ed.addEventListener("focus", function () { showFormatBar(this); });
                        ed.addEventListener("input", function () {
                            state.pages[pi].rows[ri][textKey] = ed.innerHTML; save();
                        });

                        var attHost = td.querySelector(".cell-att");
                        renderAttCell(attHost, pi, ri, attsKey, !!showRowDelete);
                    }

                    // Col 1
                    var td1 = document.createElement("td");
                    renderCell(td1, "col1", "atts1", false);

                    // Col 2
                    var td2 = document.createElement("td");
                    renderCell(td2, "col2", "atts2", false);

                    // Col 3
                    var td3 = document.createElement("td");
                    renderCell(td3, "col3", "atts", true);

                    tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
                    tbody.appendChild(tr);
                });
            }

            // Replaces old renderRows

            function addSection(pi) {
                state.pages[pi].rows.push({ isSection: true, title: "New Section" });
                // Automatically add a row after a section for convenience
                state.pages[pi].rows.push({ col1: "", col2: "", col3: "", atts1: [], atts2: [], atts: [] });
                save(); render();
            }

            function moveRow(pi, ri, dir) {
                if (state.uiLocked) return;
                var rows = state.pages[pi].rows;
                var ti = ri + dir;
                if (ti < 0 || ti >= rows.length) return;
                var tmp = rows[ri];
                rows[ri] = rows[ti];
                rows[ti] = tmp;
                save(); render();
            }

            // Moves a whole section block (section divider + following rows until next section)
            function moveSection(pi, secIndex, dir) {
                if (state.uiLocked) return;
                var rows = state.pages[pi].rows;
                if (!rows[secIndex] || !rows[secIndex].isSection) return;

                // Find current block
                var start = secIndex;
                var end = secIndex;
                for (var i = secIndex + 1; i < rows.length; i++) {
                    if (rows[i].isSection) break;
                    end = i;
                }

                function findPrevSectionHeader(idx) {
                    for (var j = idx; j >= 0; j--) {
                        if (rows[j] && rows[j].isSection) return j;
                    }
                    return -1;
                }

                function findNextSectionHeader(idx) {
                    for (var j = idx; j < rows.length; j++) {
                        if (rows[j] && rows[j].isSection) return j;
                    }
                    return -1;
                }

                if (dir < 0) {
                    var prevHeader = findPrevSectionHeader(start - 1);
                    if (prevHeader === -1) return;

                    var prevStart = prevHeader;
                    var prevEnd = start - 1;

                    var before = rows.slice(0, prevStart);
                    var prevBlock = rows.slice(prevStart, prevEnd + 1);
                    var curBlock = rows.slice(start, end + 1);
                    var after = rows.slice(end + 1);

                    state.pages[pi].rows = before.concat(curBlock, prevBlock, after);
                    save(); render();
                    return;
                }

                if (dir > 0) {
                    var nextHeader = findNextSectionHeader(end + 1);
                    if (nextHeader === -1) return;

                    var nextStart = nextHeader;
                    var nextEnd = nextHeader;
                    for (var k = nextHeader + 1; k < rows.length; k++) {
                        if (rows[k].isSection) break;
                        nextEnd = k;
                    }

                    var before2 = rows.slice(0, start);
                    var curBlock2 = rows.slice(start, end + 1);
                    var nextBlock = rows.slice(nextStart, nextEnd + 1);
                    var after2 = rows.slice(nextEnd + 1);

                    state.pages[pi].rows = before2.concat(nextBlock, curBlock2, after2);
                    save(); render();
                    return;
                }
            }


            function renderAttCell(host, pi, ri, attsKey, showRowDelete) {
                var fid = "file-" + pi + "-" + ri + "-" + attsKey;
                var html = '<div class="att-cell">' +
                    '<button type="button" class="att-toggle" title="' + esc(t("addMore")) + '" aria-label="' + esc(t("addMore")) + '"><span class="att-toggle-clip">üìé</span><span class="att-toggle-lock" aria-hidden="true">üîí</span></button>' +
                    '<div class="att-bar">' +
                    '<div class="att-bar-title">' + esc(t("addMore")) + '</div>' +
                    '<input type="file" id="' + fid + '" multiple hidden>' +
                    '<div style="display:flex;gap:4px;width:100%;align-items:center;">' +
                    '<input type="text" class="smart-input" placeholder="' + esc(t("urlPlaceholder")) + '" style="flex:1;">' +
                    '<button class="add-smart-btn" style="padding:6px 12px;border:none;border-radius:6px;background:var(--primary);color:white;cursor:pointer;">‚ûï</button>' +
                    '<button class="file-btn" style="padding:6px 12px;border:none;border-radius:6px;background:var(--success);color:white;cursor:pointer;">üìÇ</button>' +
                    (showRowDelete ? '<button class="row-del" style="padding:6px 12px;border:none;border-radius:6px;background:var(--danger);color:white;cursor:pointer;">üóëÔ∏è</button>' : '') +
                    '</div>' +
                    '</div>' +
                    '<div class="att-list" data-view="' + esc(state.attView || "tiles") + '" data-size="' + esc(state.attSize || "m") + '"></div>' +
                    '</div>';
                host.innerHTML = html;

                var fi = host.querySelector("#" + fid);
                var smartInput = host.querySelector(".smart-input");

                // Toggle attachment bar (click) - hover also works via CSS
                var attCell = host.querySelector(".att-cell");
                var toggleBtn = host.querySelector(".att-toggle");
                if (toggleBtn && attCell) {
                    toggleBtn.addEventListener("click", function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        attCell.classList.toggle("att-open");
                        if (attCell.classList.contains("att-open") && smartInput) {
                            setTimeout(function(){ smartInput.focus(); }, 0);
                        }
                    });
                }


                // File Upload
                host.querySelector(".file-btn").addEventListener("click", function () { fi.click(); });
                fi.addEventListener("change", function (e) {
                    for (var i = 0; i < e.target.files.length; i++) addFile(pi, ri, e.target.files[i], attsKey);
                    e.target.value = "";
                });

                // Smart Add Input
                function triggerSmartAdd() {
                    var val = smartInput.value.trim();
                    if (val) {
                        smartHandle(pi, ri, val, attsKey);
                        smartInput.value = "";
                    }
                }

                host.querySelector(".add-smart-btn").addEventListener("click", triggerSmartAdd);
                smartInput.addEventListener("keydown", function (e) {
                    if (e.key === "Enter") triggerSmartAdd();
                });

                if (showRowDelete) {
                    host.querySelector(".row-del").addEventListener("click", function () {
                        if (confirm(t("confirmDel"))) { state.pages[pi].rows.splice(ri, 1); save(); render(); }
                    });
                }

                renderAtts(host.querySelector(".att-list"), pi, ri, attsKey);
            }

            function smartHandle(pi, ri, val, attsKey) {
                // Check if URL
                if (/^https?:\/\//i.test(val) || /^www\./i.test(val)) {
                    // Add protocol if missing
                    if (/^www\./i.test(val)) val = "https://" + val;
                    addLink(pi, ri, val, attsKey);
                    return;
                }

                // Check if likely a URL but missing protocol (e.g. drive.google.com)
                if ((val.includes("drive.google.com") || val.includes("docs.google.com") || val.includes("youtube.com")) && !val.includes(" ")) {
                    if (!/^https?:\/\//i.test(val)) val = "https://" + val;
                    addLink(pi, ri, val, attsKey);
                    return;
                }

                // Treat as local path (Video, PDF, or Folder)
                addLocalPath(pi, ri, val, attsKey);
            }


            // Clamp attachment list to a maximum of ~2 rows; if there are more, make it scrollable.
            // Clamp attachment list to a maximum of ~2 rows/items; if there are more, make it scrollable.
            function clampAttList(c) {
                if (!c) return;
                try {
                    var items = c.querySelectorAll(".att-item");
                    c.classList.remove("clamp2");
                    c.style.maxHeight = "";
                    c.style.overflowY = "";

                    if (!items || !items.length) return;

                    var view = (c.dataset && c.dataset.view) ? c.dataset.view : "tiles";
                    var size = (c.dataset && c.dataset.size) ? c.dataset.size : "m";

                    var cs = getComputedStyle(c);
                    var gap = parseFloat((cs.gap || cs.gridGap || "12").toString()) || 12;

                    // List view: clamp to 2 items
                    if (view === "list") {
                        if (items.length <= 2) return;
                        var h0 = items[0].getBoundingClientRect().height || 0;
                        if (!h0) return;
                        c.style.maxHeight = Math.round(h0 * 2 + gap) + "px";
                        c.style.overflowY = "auto";
                        c.classList.add("clamp2");
                        return;
                    }

                    // Tiles view: clamp to 2 grid rows (size-aware)
                    var minCol = (size === "s") ? 150 : (size === "l") ? 260 : 200;
                    var w = c.clientWidth || 0;
                    if (!w) return;

                    var cols = Math.max(1, Math.floor((w + gap) / (minCol + gap)));
                    var rows = Math.ceil(items.length / cols);

                    if (rows <= 2) return;

                    // Measure first row height (max of first-row tiles)
                    var maxH = 0;
                    for (var i = 0; i < Math.min(cols, items.length); i++) {
                        var h = items[i].getBoundingClientRect().height;
                        if (h > maxH) maxH = h;
                    }
                    if (!maxH) maxH = items[0].getBoundingClientRect().height || 0;
                    if (!maxH) return;

                    c.style.maxHeight = Math.round(maxH * 2 + gap) + "px";
                    c.style.overflowY = "auto";
                    c.classList.add("clamp2");
                } catch (e) { }
            }

            // Recalculate attachment clamp on resize (keeps row height stable)
            window.addEventListener("resize", function () {
                $$(".att-list").forEach(function (x) { clampAttList(x); });
            });


            function renderAtts(c, pi, ri, attsKey) {
                var atts = getAtts(pi, ri, attsKey);
                c.innerHTML = "";
                if (!atts.length) { c.innerHTML = '<div class="empty">' + esc(t("noAtt")) + '</div>'; return; }

                atts.forEach(function (att, ai) {
                    var item = document.createElement("div");
                    item.className = "att-item";
                    var thumbHtml = "", name = att.name || att.title || "File", size = att.size ? fmtSize(att.size) : "";
                    var storageBadge = att.storage === "cloud" ? '<span class="storage-badge cloud">‚òÅÔ∏è</span>' : (att.data ? '<span class="storage-badge local">üìé</span>' : '');

                    if (att.kind === "youtube") {
                        var thumb = "https://i.ytimg.com/vi/" + att.vid + "/hqdefault.jpg";
                        thumbHtml = storageBadge + '<div class="thumb-box"><div class="thumb-content"><img class="thumb-img" src="' + esc(thumb) + '" alt=""></div><div class="yt-play"></div><div class="thumb-hover"><span class="thumb-hover-text">' + esc(t("clickToOpen")) + '</span></div></div>';
                        name = att.title || "YouTube";
                    } else if (att.kind === "gdrive") {
                        // Google Drive file
                        var gType = att.gtype || 'file';
                        var iconClass = gType === 'doc' ? 'doc' : gType === 'xls' ? 'xls' : gType === 'ppt' ? 'ppt' : 'gdrive';
                        var iconEmoji = gType === 'doc' ? 'üìù' : gType === 'xls' ? 'üìä' : gType === 'ppt' ? 'üìΩ' : '‚òÅÔ∏è';

                        // Try to show thumbnail for images
                        if (att.isImage) {
                            thumbHtml = storageBadge + '<div class="thumb-box"><div class="thumb-content"><img class="thumb-img" src="' + esc(getGDriveDirectUrl(att.gid)) + '" alt="" onerror="this.parentElement.innerHTML=\'<div class=thumb-icon-wrap gdrive>‚òÅÔ∏è<span class=thumb-icon-text>DRIVE</span></div>\'"></div><div class="thumb-hover"><span class="thumb-hover-text">' + esc(t("clickToOpen")) + '</span></div></div>';
                        } else {
                            thumbHtml = storageBadge + '<div class="thumb-box"><div class="thumb-content"><div class="thumb-icon-wrap ' + iconClass + '">' + iconEmoji + '<span class="thumb-icon-text">' + gType.toUpperCase() + '</span></div></div><div class="thumb-hover"><span class="thumb-hover-text">' + esc(t("clickToOpen")) + '</span></div></div>';
                        }
                        name = att.title || "Google Drive";
                    } else if (att.kind === "file") {
                        var cat = att.ftype || "file";
                        if (cat === "image" && att.data) {
                            thumbHtml = storageBadge + '<div class="thumb-box"><div class="thumb-content"><img class="thumb-img" src="' + att.data + '" alt=""></div><div class="thumb-hover"><span class="thumb-hover-text">' + esc(t("clickToOpen")) + '</span></div></div>';
                        } else if (cat === "video") {
                            thumbHtml = storageBadge + '<div class="thumb-box"><div class="thumb-content"><div class="thumb-icon-wrap video">üé¨<span class="thumb-icon-text">VIDEO</span></div></div><div class="thumb-hover"><span class="thumb-hover-text">' + esc(t("clickToOpen")) + '</span></div></div>';
                        } else if (cat === "pdf") {
                            thumbHtml = storageBadge + '<div class="thumb-box"><div class="thumb-content"><div class="thumb-icon-wrap pdf">üìÑ<span class="thumb-icon-text">PDF</span></div></div><div class="thumb-hover"><span class="thumb-hover-text">' + esc(t("clickToOpen")) + '</span></div></div>';
                        } else if (cat === "doc") {
                            thumbHtml = storageBadge + '<div class="thumb-box"><div class="thumb-content"><div class="thumb-icon-wrap doc">üìù<span class="thumb-icon-text">DOC</span></div></div></div>';
                        } else if (cat === "xls") {
                            thumbHtml = storageBadge + '<div class="thumb-box"><div class="thumb-content"><div class="thumb-icon-wrap xls">üìä<span class="thumb-icon-text">XLS</span></div></div></div>';
                        } else if (cat === "ppt") {
                            thumbHtml = storageBadge + '<div class="thumb-box"><div class="thumb-content"><div class="thumb-icon-wrap ppt">üìΩ<span class="thumb-icon-text">PPT</span></div></div></div>';
                        } else {
                            var ext = fileExt(att.name).toUpperCase() || "FILE";
                            thumbHtml = storageBadge + '<div class="thumb-box"><div class="thumb-content"><div class="thumb-icon-wrap file">üìÅ<span class="thumb-icon-text">' + esc(ext) + '</span></div></div></div>';
                        }
                        name = att.name;
                    } else if (att.kind === "cloudpdf") {
                        // Cloud PDF from pCloud, Dropbox, OneDrive, or direct PDF links
                        var cloudIcon = "üìÑ";
                        var cloudLabel = "PDF";
                        if (isPCloudUrl(att.url)) cloudLabel = "pCloud";
                        else if (isDropboxUrl(att.url)) cloudLabel = "Dropbox";
                        else if (isOneDriveUrl(att.url)) cloudLabel = "OneDrive";

                        thumbHtml = storageBadge + '<div class="thumb-box"><div class="thumb-content"><div class="thumb-icon-wrap pdf">' + cloudIcon + '<span class="thumb-icon-text">' + cloudLabel + '</span></div></div><div class="thumb-hover"><span class="thumb-hover-text">' + esc(t("clickToOpen")) + '</span></div></div>';
                        name = att.title || "PDF";
                    } else if (att.kind === "localvideo") {
                        // Local video via relative path (portable USB)
                        thumbHtml = '<span class="storage-badge local">üìÅ</span><div class="thumb-box"><div class="thumb-content"><div class="thumb-icon-wrap video">üé¨<span class="thumb-icon-text">VIDEO</span></div></div><div class="thumb-hover"><span class="thumb-hover-text">' + esc(t("clickToOpen")) + '</span></div></div>';
                        name = att.title || att.name || "Video";
                    } else if (att.kind === "localpdf") {
                        // Local PDF via relative path (portable USB)
                        thumbHtml = '<span class="storage-badge local">üìÅ</span><div class="thumb-box"><div class="thumb-content"><div class="thumb-icon-wrap pdf">üìÑ<span class="thumb-icon-text">PDF</span></div></div><div class="thumb-hover"><span class="thumb-hover-text">' + esc(t("clickToOpen")) + '</span></div></div>';
                        name = att.title || att.name || "PDF";
                    } else if (att.kind === "localfolder") {
                        // Local Folder Path
                        thumbHtml = '<span class="storage-badge local">üìÇ</span><div class="thumb-box"><div class="thumb-content"><div class="thumb-icon-wrap file">üìÇ<span class="thumb-icon-text">DIR</span></div></div><div class="thumb-hover"><span class="thumb-hover-text">' + esc(t("clickToOpen")) + '</span></div></div>';
                        name = att.name || "Folder";
                    } else if (att.kind === "localfile") {
                        // Local file via relative path (portable USB)
                        var localExt = fileExt(att.name).toUpperCase() || "FILE";
                        thumbHtml = '<span class="storage-badge local">üìÅ</span><div class="thumb-box"><div class="thumb-content"><div class="thumb-icon-wrap file">üìÅ<span class="thumb-icon-text">' + esc(localExt) + '</span></div></div><div class="thumb-hover"><span class="thumb-hover-text">' + esc(t("clickToOpen")) + '</span></div></div>';
                        name = att.title || att.name || "File";
                    } else if (att.kind === "link") {
                        if (isImgUrl(att.url)) {
                            thumbHtml = storageBadge + '<div class="thumb-box"><div class="thumb-content"><img class="thumb-img" src="' + esc(att.url) + '" alt="" onerror="this.style.display=\'none\'"></div><div class="thumb-hover"><span class="thumb-hover-text">' + esc(t("clickToOpen")) + '</span></div></div>';
                        } else if (isPdfUrl(att.url)) {
                            thumbHtml = storageBadge + '<div class="thumb-box"><div class="thumb-content"><div class="thumb-icon-wrap pdf">üìÑ<span class="thumb-icon-text">PDF</span></div></div><div class="thumb-hover"><span class="thumb-hover-text">' + esc(t("clickToOpen")) + '</span></div></div>';
                        } else {
                            thumbHtml = storageBadge + '<div class="thumb-box"><div class="thumb-content"><div class="thumb-icon-wrap link">üîó<span class="thumb-icon-text">LINK</span></div></div></div>';
                        }
                        name = att.title || att.url;
                    }

                    item.innerHTML = thumbHtml +
                        '<div class="att-info">' +
                        '<div class="att-name" title="' + esc(name) + '">' + esc(name) + '</div>' +
                        '<div class="att-desc editable" contenteditable="true" data-placeholder="' + esc(t("descPlaceholder")) + '"></div>' +
                        '<div class="att-meta">' +
                        '<span class="att-size">' + size + (att.storage === "cloud" ? " ‚òÅÔ∏è" : "") + '</span>' +
                        '<div class="att-btns">' +
                        (att.data ? '<button class="dl">‚¨á</button>' : '') +
                        (att.url ? '<button class="open">‚Üó</button>' : '') +
                        '<button class="del">‚úï</button>' +
                        '</div></div>' +
                        (att.url ? '<a class="print-link" href="' + esc(att.url) + '" target="_blank">' + esc(att.url) + '</a>' : '') +
                        (att.path ? '<a class="print-link" href="' + esc(att.path) + '" target="_blank">' + esc(att.path) + '</a>' : '') +
                        '</div>';

                    // Description event
                    var descEl = item.querySelector(".att-desc");
                    setEditableContent(descEl, att.description || "");
                    descEl.addEventListener("focus", function () { showFormatBar(this); });
                    descEl.addEventListener("input", function () {
                        atts[ai].description = descEl.innerHTML; save();
                    });

                    // Thumb click events
                    var thumbBox = item.querySelector(".thumb-box");
                    if (thumbBox) {
                        thumbBox.addEventListener("click", function () {
                            if (att.kind === "youtube") {
                                openModal(name, '<iframe src="https://www.youtube.com/embed/' + att.vid + '?autoplay=1&rel=0" allow="autoplay; encrypted-media" allowfullscreen></iframe>', att.url);
                            } else if (att.kind === "gdrive") {
                                var previewUrl = getGDrivePreviewUrl(att.gid, att.gtype);
                                if (att.isImage) {
                                    openModal(att.title, '<img src="' + getGDriveDirectUrl(att.gid) + '" alt="">', att.url);
                                } else {
                                    openModal(att.title || "Google Drive", '<iframe src="' + previewUrl + '"></iframe>', att.url);
                                }
                            } else if (att.kind === "file" && att.ftype === "image" && att.data) {
                                openModal(att.name, '<img src="' + att.data + '" alt="">', att.data);
                            } else if (att.kind === "file" && att.ftype === "video" && att.data) {
                                openModal(att.name, '<video controls autoplay src="' + att.data + '"></video>', null);
                            } else if (att.kind === "file" && att.ftype === "pdf" && att.data) {
                                openModal(att.name, '<iframe src="' + att.data + '"></iframe>', att.data);
                            } else if (att.kind === "cloudpdf") {
                                // Cloud PDF from pCloud, Dropbox, OneDrive, or direct links
                                var pdfViewerUrl = getCloudPdfViewerUrl(att.url);
                                openModal(att.title || "PDF", '<iframe src="' + esc(pdfViewerUrl) + '"></iframe>', att.url);
                            } else if (att.kind === "localvideo") {
                                // Local video via relative path (portable USB)
                                openModal(att.title || att.name, '<video controls autoplay src="' + esc(att.path) + '"></video>', null);
                            } else if (att.kind === "localpdf") {
                                // Local PDF via relative path (portable USB)
                                openModal(att.title || att.name, '<iframe src="' + esc(att.path) + '"></iframe>', null);
                            } else if (att.kind === "localfolder") {
                                // Local folder - open in new tab (browser behavior varies)
                                window.open(att.path, "_blank");
                            } else if (att.kind === "localfile") {
                                // Local file via relative path - just open in new tab
                                window.open(att.path, "_blank");
                            } else if (att.kind === "link") {
                                if (isImgUrl(att.url)) openModal(att.title || "Image", '<img src="' + esc(att.url) + '" alt="">', att.url);
                                else if (isCloudPdfUrl(att.url)) {
                                    var viewerUrl = getCloudPdfViewerUrl(att.url);
                                    openModal(att.title || "PDF", '<iframe src="' + esc(viewerUrl) + '"></iframe>', att.url);
                                }
                                else window.open(att.url, "_blank");
                            }
                        });
                    }

                    // Download button
                    var dlB = item.querySelector(".dl");
                    if (dlB) dlB.addEventListener("click", function (e) {
                        e.stopPropagation();
                        var a = document.createElement("a"); a.href = att.data; a.download = att.name; a.click();
                    });

                    // Open external
                    var openB = item.querySelector(".open");
                    if (openB) openB.addEventListener("click", function (e) {
                        e.stopPropagation();
                        window.open(att.url, "_blank");
                    });

                    // Delete button
                    item.querySelector(".del").addEventListener("click", function (e) {
                        e.stopPropagation();
                        atts.splice(ai, 1); save(); render();
                    });

                    c.appendChild(item);
                });

                // Apply 2-row clamp after render
                setTimeout(function(){ clampAttList(c); }, 0);
            }

            function addRow(pi) {
                state.pages[pi].rows.push({ col1: "", col2: "", col3: "", atts1: [], atts2: [], atts: [] });
                save(); render();
            }

            function addFile(pi, ri, file, attsKey) {
                var reader = new FileReader();
                reader.onload = function () {
                    var atts = getAtts(pi, ri, attsKey);
                    atts.push({
                        kind: "file",
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        ftype: fileCat(file),
                        data: reader.result,
                        storage: "local",
                        description: ""
                    });
                    save(); render();
                };
                reader.readAsDataURL(file);
            }

            function addLink(pi, ri, url, attsKey) {
                if (!/^https?:\/\//i.test(url)) url = "https://" + url;
                var atts = getAtts(pi, ri, attsKey);

                // Check if YouTube
                var vid = ytId(url);
                if (vid) {
                    atts.push({
                        kind: "youtube", url: url, vid: vid,
                        title: "YouTube Video", storage: "cloud", description: ""
                    });
                    save(); render();
                    return;
                }

                // Check if Google Drive
                var gd = parseGoogleDriveUrl(url);
                if (gd) {
                    var isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(url);
                    atts.push({
                        kind: "gdrive",
                        url: url,
                        gid: gd.id,
                        gtype: gd.type,
                        isImage: isImage,
                        title: "Google Drive",
                        storage: "cloud",
                        description: ""
                    });
                    save(); render();
                    return;
                }

                // Check if cloud PDF (pCloud, Dropbox, OneDrive, or direct PDF link)
                if (isCloudPdfUrl(url)) {
                    var pdfTitle = "PDF";
                    if (isPCloudUrl(url)) pdfTitle = "PDF (pCloud)";
                    else if (isDropboxUrl(url)) pdfTitle = "PDF (Dropbox)";
                    else if (isOneDriveUrl(url)) pdfTitle = "PDF (OneDrive)";

                    atts.push({
                        kind: "cloudpdf",
                        url: url,
                        title: pdfTitle,
                        storage: "cloud",
                        description: ""
                    });
                    save(); render();
                    return;
                }

                // Regular link
                var domain = "";
                try { domain = new URL(url).hostname; } catch (e) { }
                var title = domain;
                if (isImgUrl(url)) title = "Image";

                atts.push({
                    kind: "link", url: url, title: title || url,
                    storage: "cloud", description: ""
                });
                save(); render();
            }

            // Add local relative path (for USB/portable videos and PDFs)
            function addLocalPath(pi, ri, path, attsKey) {
                var atts = getAtts(pi, ri, attsKey);

                // Normalize path separators (use forward slashes)
                path = path.replace(/\\/g, '/');
                var name = getVideoNameFromPath(path);

                // Check if it's a local video path
                if (isLocalVideoPath(path)) {
                    atts.push({
                        kind: "localvideo", path: path, name: name, title: name,
                        storage: "local", description: ""
                    });
                }

                // Check if it's a local PDF path
                else if (isLocalPdfPath(path)) {
                    atts.push({
                        kind: "localpdf", path: path, name: name, title: name,
                        storage: "local", description: ""
                    });
                }
                // Check if it's a folder (no extension or ends with slash)
                else if (path.indexOf(".") === -1 || path.endsWith("/")) {
                    atts.push({
                        kind: "localfolder", path: path, name: name || path, title: name || path,
                        storage: "local", description: ""
                    });
                }
                // Unknown file type - add as generic local file
                else {
                    atts.push({
                        kind: "localfile",
                        path: path,
                        name: name,
                        title: name,
                        storage: "local",
                        description: ""
                    });
                }
                save(); render();
            }

            // Export/Import
            function exportJson() {
                save();
                var b = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
                dl(b, "tabela.json");
            }

            function exportHtml() {
                save();
                var h = document.documentElement.outerHTML;
                var s = JSON.stringify(state)
                    .replace(/</g, "\\u003c")
                    .replace(/>/g, "\\u003e")
                    .replace(/&/g, "\\u0026");
                h = h.replace(
                    /<script type="application\/json" id="embeddedState"><\/script>/,
                    '<script type="application/json" id="embeddedState">' + s + '<\/script>'
                );
                var b = new Blob([h], { type: "text/html;charset=utf-8" });
                var filename = (state.mainTitle || "tabela").replace(/<[^>]*>/g, "").replace(/[^a-zA-Z0-9\u0400-\u04FF\s-]/g, "").replace(/\s+/g, "_") + ".html";
                dl(b, filename);
            }

            function dl(blob, name) {
                var u = URL.createObjectURL(blob);
                var a = document.createElement("a"); a.href = u; a.download = name; a.click();
                setTimeout(function () { URL.revokeObjectURL(u); }, 100);
            }

            function importJson(e) {
                var f = e.target.files && e.target.files[0];
                if (!f) return;
                var r = new FileReader();
                r.onload = function () {
                    try {
                        var d = JSON.parse(r.result);
                        if (d.pages) {
                            for (var k in d) if (d.hasOwnProperty(k)) state[k] = d[k];
                            normalizeState();
                            save();
                            $("#mainTitle").innerHTML = state.mainTitle;
                            $("#subtitle").innerHTML = state.subtitle;
                            render();
                        }
                    } catch (err) { alert("Error: " + err.message); }
                };
                r.readAsText(f);
                e.target.value = "";
            }

            function printPage() {
                save();
                $$(".page").forEach(function (p, i) { p.classList.toggle("printing", i === state.currentPage); });
                window.print();
                setTimeout(function () { $$(".page").forEach(function (p) { p.classList.remove("printing"); }); }, 1000);
            }

            // Setup
            function setup() {
                $$("[data-theme]").forEach(function (b) {
                    b.addEventListener("click", function () { state.theme = b.dataset.theme; save(); render(); });
                });
                $$("[data-lang]").forEach(function (b) {
                    b.addEventListener("click", function () { state.lang = b.dataset.lang; save(); render(); });
                });

                $("#mainTitle").addEventListener("focus", function () { showFormatBar(this); });
                $("#mainTitle").addEventListener("input", save);
                $("#subtitle").addEventListener("focus", function () { showFormatBar(this); });
                $("#subtitle").addEventListener("input", save);

                $("#helpBtn").addEventListener("click", function () {
                    var h = $("#gdriveHelp");
                    if (!h) return;
                    h.style.display = (h.style.display === "none" || !h.style.display) ? "block" : "none";
                });

                var ob = $("#toggleOrderBtn");
                if (ob) ob.addEventListener("click", function () {
                    state.showOrder = !state.showOrder;
                    save(); render();
                });

                var lb = $("#uiLockBtn");
                if (lb) lb.addEventListener("click", function (e) {
                    e.preventDefault();
                    state.uiLocked = !state.uiLocked;
                    save();
                    render();
                });


                // Attachment view / print mode popover
                var vb = $("#attViewBtn");
                var pop = $("#attViewPop");

                function syncViewButtons() {
                    if (!pop) return;
                    pop.querySelectorAll(".av-btn").forEach(function (b) {
                        var v = b.dataset.view;
                        var s = b.dataset.size;
                        var active = (v === (state.attView || "tiles")) && (v === "list" || s === (state.attSize || "m"));
                        b.classList.toggle("active", !!active);
                    });
                    pop.querySelectorAll(".pv-btn").forEach(function (b) {
                        b.classList.toggle("active", b.dataset.print === (state.printAtt || "compact"));
                    });
                }

                function closeAttPop() {
                    if (!pop) return;
                    pop.classList.remove("open");
                    pop.setAttribute("aria-hidden", "true");
                }

                if (vb && pop) {
                    vb.addEventListener("click", function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        pop.classList.toggle("open");
                        pop.setAttribute("aria-hidden", pop.classList.contains("open") ? "false" : "true");
                        syncViewButtons();
                    });

                    pop.addEventListener("click", function (e) { e.stopPropagation(); });

                    document.addEventListener("click", function () { closeAttPop(); });

                    pop.querySelectorAll(".av-btn").forEach(function (b) {
                        b.addEventListener("click", function () {
                            if (state.uiLocked) return;
                            state.attView = b.dataset.view || "tiles";
                            if (state.attView === "tiles") state.attSize = b.dataset.size || state.attSize || "m";
                            save();
                            applyAttViewAll();
                            syncViewButtons();
                        });
                    });

                    pop.querySelectorAll(".pv-btn").forEach(function (b) {
                        b.addEventListener("click", function () {
                            state.printAtt = b.dataset.print || "compact";
                            save();
                            applyAttViewAll();
                            syncViewButtons();
                        });
                    });

                    syncViewButtons();
                }

                $("#printBtn").addEventListener("click", printPage);
                $("#exportHtmlBtn").addEventListener("click", exportHtml);
                $("#exportJsonBtn").addEventListener("click", exportJson);
                $("#importJsonBtn").addEventListener("click", function () { $("#importFile").click(); });
                $("#importFile").addEventListener("change", importJson);

                // Modal
                $("#modalClose").addEventListener("click", closeModal);
                $("#modal").addEventListener("click", function (e) { if (e.target === this) closeModal(); });
                document.addEventListener("keydown", function (e) { if (e.key === "Escape") closeModal(); });

                $$(".modal-size-btn").forEach(function (b) {
                    b.addEventListener("click", function () {
                        $$(".modal-size-btn").forEach(function (x) { x.classList.remove("active"); });
                        b.classList.add("active");
                        setModalSize(b.dataset.w, b.dataset.h);
                    });
                });

                // Modal drag
                var head = $("#modalHead"), box = $("#modalBox"), dragging = false, sx, sy, sl, st;
                head.addEventListener("mousedown", function (e) {
                    if (e.target.tagName === "BUTTON" || e.target.tagName === "A") return;
                    dragging = true; sx = e.clientX; sy = e.clientY;
                    var r = box.getBoundingClientRect(); sl = r.left; st = r.top;
                    box.style.position = "fixed"; box.style.margin = "0";
                });
                document.addEventListener("mousemove", function (e) {
                    if (!dragging) return;
                    box.style.left = (sl + e.clientX - sx) + "px";
                    box.style.top = (st + e.clientY - sy) + "px";
                });
                document.addEventListener("mouseup", function () { dragging = false; });
            }

            function init() {
                load();
                $("#mainTitle").innerHTML = state.mainTitle;
                $("#subtitle").innerHTML = state.subtitle;
                setup();
                render();
            }

            init();
        })();
    </script>
    <script src="home-button.js"></script>
</body>

</html>
