<!DOCTYPE html>
<html lang="mk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ï–ª–µ–∫—Ç—Ä–æ–Ω—Å–∫–∏ —Ä–∞—Å–ø–æ—Ä–µ–¥ –∏ –¥–Ω–µ–≤–Ω–∏–∫</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
        }
        .header h1 { font-size: 1.3em; margin-bottom: 5px; }
        .header p { font-size: 0.85em; opacity: 0.95; }
        .tabs {
            display: flex;
            justify-content: center;
            background: linear-gradient(to bottom, #1a1a2e 0%, #16213e 100%);
            border-bottom: 3px solid #0f3460;
            padding: 0 10px;
            gap: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .tab {
            padding: 12px 30px;
            border: none;
            background: linear-gradient(to bottom, #2d3748 0%, #1a202c 100%);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 15px;
            color: #a0aec0;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            clip-path: polygon(10px 0, 100% 0, calc(100% - 10px) 100%, 0 100%);
            margin-top: 5px;
            border-top: 2px solid #4a5568;
        }
        .tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #667eea, transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tab:hover {
            background: linear-gradient(to bottom, #4a5568 0%, #2d3748 100%);
            color: #e2e8f0;
        }
        .tab:hover::before {
            opacity: 1;
        }
        .tab.active {
            background: linear-gradient(to bottom, #667eea 0%, #5568d3 100%);
            color: #ffffff;
            font-weight: bold;
            margin-top: 0;
            padding-top: 17px;
            border-top: 3px solid #818cf8;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
        }
        .tab.active::before {
            opacity: 1;
            background: linear-gradient(90deg, transparent, #ffffff, transparent);
        }
        .content { 
            padding: 20px;
            background: white;
            min-height: calc(100vh - 150px);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-success { background: #48bb78; color: white; }
        .btn-success:hover { background: #38a169; }
        .btn-danger { background: #e53e3e; color: white; }
        .btn-danger:hover { background: #c53030; }
        body.dark-mode .btn-primary { background: #818cf8; }
        body.dark-mode .btn-primary:hover { background: #6366f1; }
        body.dark-mode .btn-danger { background: #f56565; }
        body.dark-mode .btn-danger:hover { background: #e53e3e; }
        .btn-full {
            width: 100%;
            padding: 15px;
            font-size: 15px;
        }
        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }
        .stats-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-box h2 { font-size: 2.5em; margin-bottom: 5px; }
        .stat-box p { font-size: 0.9em; opacity: 0.95; }
        
        .capacity-box {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .capacity-box h3 {
            margin-bottom: 15px;
            color: #2d3748;
            font-size: 1.1em;
        }
        .capacity-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            font-size: 14px;
        }
        .capacity-item .icon {
            font-size: 18px;
        }
        .progress-bar-container {
            width: 100%;
            height: 30px;
            background: #e2e8f0;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
            position: relative;
        }
        .progress-bar-fill {
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 13px;
        }
        .progress-bar-fill.green { background: linear-gradient(90deg, #48bb78 0%, #38a169 100%); }
        .progress-bar-fill.yellow { background: linear-gradient(90deg, #ecc94b 0%, #d69e2e 100%); }
        .progress-bar-fill.red { background: linear-gradient(90deg, #f56565 0%, #e53e3e 100%); }
        
        body.dark-mode .capacity-box { background: #2d3748; border-color: #4a5568; }
        body.dark-mode .capacity-box h3 { color: #e2e8f0; }
        body.dark-mode .capacity-item { color: #e2e8f0; }
        body.dark-mode #sessionSummary { border-top-color: #4a5568; }
        body.dark-mode #sessionSummary strong { color: #e2e8f0; }
        body.dark-mode #sessionSummary .capacity-item span { color: #e2e8f0 !important; }
        .student-list-simple {
            background: white;
        }
        .student-item {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }
        .student-item:hover {
            background: #f7fafc;
        }
        .student-item-info {
            flex: 1;
        }
        .student-item h4 {
            font-size: 15px;
            margin-bottom: 3px;
        }
        .student-item p {
            font-size: 13px;
            color: #718096;
        }
        .student-item-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .student-item-arrows {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .arrow-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: #4a5568;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .arrow-btn:hover:not(:disabled) {
            background: #667eea;
            transform: scale(1.05);
        }
        .arrow-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        body.dark-mode .arrow-btn {
            background: #2d3748;
        }
        body.dark-mode .arrow-btn:hover:not(:disabled) {
            background: #818cf8;
        }
        .form-group { margin-bottom: 20px; }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600;
            font-size: 14px;
        }
        .form-group select, .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }
        .progress-list {
            margin-top: 20px;
        }
        .progress-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            margin: 8px 0;
            background: #f7fafc;
            border-radius: 6px;
            border-left: 3px solid #cbd5e0;
        }
        .progress-item.completed {
            background: #e6fffa;
            border-left-color: #48bb78;
        }
        .progress-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-top: 2px;
        }
        .progress-item-content {
            flex: 1;
        }
        .progress-item-text {
            font-size: 14px;
            margin-bottom: 3px;
        }
        .progress-item-date {
            font-size: 12px;
            color: #718096;
        }
        .time-selector {
            margin-top: 8px;
        }
        .time-selector select {
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            font-size: 13px;
        }
        .attendance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 13px;
        }
        .attendance-table th {
            background: #667eea;
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: 600;
        }
        .attendance-table td {
            padding: 10px;
            border: 1px solid #f1f5f9;
        }
        .attendance-table tr:nth-child(even) {
            background: #f8fafc;
        }
        .date-cell {
            background: #e6fffa;
            text-align: center;
            font-size: 12px;
        }
        .schedule-grid {
            display: grid;
            grid-template-columns: 80px repeat(5, 1fr);
            gap: 1px;
            background: #f1f5f9; /* Grid line color */
            border-radius: 8px;
            overflow: hidden;
            margin-top: 15px;
            border: 1px solid #f1f5f9;
            min-width: 100%;
            width: max-content;
        }
        .schedule-cell-split {
            display: flex;
            flex-direction: column;
            background: #f1f5f9;
            gap: 1px;
            width: 100%;
        }
        .schedule-cell-half {
            background: white;
            padding: 8px 4px;
            min-height: 80px;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: stretch;
            cursor: pointer;
        }
        .schedule-cell-half:hover {
            background: #edf2f7;
        }
        .schedule-cell-half.odd-row {
            background: #f8fafc;
        }
        .schedule-header {
            background: #667eea;
            color: white;
            padding: 12px 5px;
            font-weight: 600;
            text-align: center;
            font-size: 12px;
        }
        .schedule-time {
            background: #2d3748;
            color: white;
            padding: 15px 8px;
            text-align: center;
            font-size: 17px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            line-height: 1.5;
        }
        .schedule-cell {
            background: white;
            padding: 8px 4px;
            min-height: 80px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .schedule-cell.merged {
            padding: 8px 4px;
            align-items: flex-start;
            justify-content: flex-start;
            cursor: pointer;
        }
        .schedule-cell.merged:hover {
            background: #edf2f7;
        }
        .schedule-cell.merged .student-slot {
            margin: 3px 0;
            border-radius: 4px;
            width: 100%;
        }
        /* Merged cells inside split container should center and be double height */
        .schedule-cell-split .schedule-cell.merged {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 4px;
            flex: 1 1 auto;
            position: relative;
            z-index: 10;
        }
        .schedule-cell-split .schedule-cell.merged .student-slot {
            width: 100%;
            margin: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            position: relative;
        }
        /* Student slots in half-cells should be full width */
        .schedule-cell-half .student-slot {
            width: 100%;
            max-width: none;
        }
        /* Add visual separator through merged cell */
        .schedule-cell-split .schedule-cell.merged::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 1px;
            background: #f1f5f9;
            z-index: -1;
        }
        .schedule-cell.odd-row {
            background: #f8fafc;
        }
        .schedule-cell:hover { background: #edf2f7; }
        .student-slot {
            background: #e6fffa;
            padding: 6px;
            border-radius: 4px;
            margin: 3px 0;
            font-size: 17px;
            font-weight: bold;
            border-left: 3px solid #38b2ac;
            cursor: default;
            display: flex;
            align-items: center;
            justify-content: space-between;
            text-align: center;
            min-height: 30px;
            position: relative;
            min-width: 0;
        }
        .attendance-indicator {
            width: 32px;
            height: 24px;
            border-radius: 4px;
            background: #cbd5e0;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            margin-right: 8px;
            border: 2px solid #a0aec0;
            position: relative;
            z-index: 10;
            font-size: 10px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #2d3748;
        }
        .attendance-indicator:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .attendance-indicator.present {
            background: #48bb78;
            border-color: #38a169;
            color: white;
        }
        .attendance-indicator.absent {
            background: #f56565;
            border-color: #e53e3e;
            color: white;
        }
        .student-slot-name {
            flex: 1;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            min-width: 0;
            display: block;
        }
        .student-slot-order {
            position: absolute;
            left: 40px;
            font-size: 11px;
            background: rgba(0,0,0,0.1);
            padding: 2px 5px;
            border-radius: 3px;
            z-index: 1;
        }
        .student-slot.linked-first {
            border-bottom: 2px dashed #38b2ac;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            margin-bottom: 0;
        }
        .student-slot.linked-second {
            border-top: none;
            border-top-left-radius: 0;
            border-top-right-radius: 0;
            margin-top: 0;
        }
        .student-slot.linked-first::after {
            content: ' ‚Üì';
            margin-left: 5px;
            font-size: 14px;
        }
        .student-slot.linked-second::before {
            content: '‚Üë ';
            margin-right: 5px;
            font-size: 14px;
        }
        .student-slot.present { 
            background: rgba(72, 187, 120, 0.3); 
            border-left-color: #48bb78;
        }
        .student-slot.absent { 
            background: rgba(245, 101, 101, 0.3);
            border-left-color: #f56565;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .checkbox-list {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
        }
        .checkbox-item {
            padding: 10px;
            margin: 5px 0;
            background: #f7fafc;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .week-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .credit-watermark {
            position: fixed;
            bottom: 10px;
            right: 15px;
            font-size: 10px;
            color: rgba(102, 126, 234, 0.4);
            font-weight: 500;
            z-index: 10;
            pointer-events: none;
            user-select: none;
        }
        body.dark-mode .credit-watermark {
            color: rgba(129, 140, 248, 0.3);
        }
         /* Dark Mode Toggle */
        .theme-switch-wrapper {
            display: flex;
            align-items: center;
            position: absolute;
            top: 20px;
            right: 20px;
        }
        .theme-switch {
            display: inline-block;
            height: 24px;
            position: relative;
            width: 50px;
        }
        .theme-switch input { display:none; }
        .slider {
            background-color: #ccc;
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            background-color: #fff;
            bottom: 4px;
            content: "";
            height: 16px;
            left: 4px;
            position: absolute;
            transition: .4s;
            width: 16px;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #667eea;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            color: #e2e8f0;
        }
        body.dark-mode .header,
        body.dark-mode .stat-box,
        body.dark-mode .section-header {
            background: linear-gradient(135deg, #4c51bf 0%, #2d3748 100%);
        }
        body.dark-mode .tabs { background: #2d3748; border-bottom-color: #4a5568; }
        body.dark-mode .tab { 
            background: linear-gradient(to bottom, #1a202c 0%, #0f1419 100%); 
            color: #718096;
            border-top-color: #2d3748;
        }
        body.dark-mode .tab:hover {
            background: linear-gradient(to bottom, #2d3748 0%, #1a202c 100%);
            color: #cbd5e0;
        }
        body.dark-mode .tab.active { 
            background: linear-gradient(to bottom, #818cf8 0%, #6366f1 100%);
            color: #ffffff;
            border-top-color: #a5b4fc;
        }
        body.dark-mode .content, body.dark-mode .student-list-simple { background: #1a202c; }
        body.dark-mode .student-item { border-bottom-color: #4a5568; }
        body.dark-mode .student-item:hover { background: #2d3748; }
        body.dark-mode .student-item h4 { color: #e2e8f0; }
        body.dark-mode .student-list-simple h3 { color: #e2e8f0; border-bottom-color: #818cf8; }
        body.dark-mode .student-item p { color: #a0aec0; }
        body.dark-mode .form-group select, body.dark-mode .form-group input, body.dark-mode .form-group textarea { background: #2d3748; border-color: #4a5568; color: #e2e8f0; }
        body.dark-mode .progress-item { background: #2d3748; border-left-color: #718096; }
        body.dark-mode .progress-item.completed { background: #2c5282; border-left-color: #63b3ed; }
        body.dark-mode .month-header { color: #e2e8f0 !important; }
        body.dark-mode .attendance-table th { background: #4c51bf; }
        body.dark-mode .attendance-table td { border-color: #334155; }
        body.dark-mode .attendance-table tr:nth-child(even) { background: #1e293b; }
        body.dark-mode .date-cell { background: #2c5282; }
        body.dark-mode .schedule-grid { background: #334155; border-color: #334155; } /* Grid line color */
        body.dark-mode .schedule-header { background: #4c51bf; }
        body.dark-mode .schedule-cell { background: #0f172a; }
        body.dark-mode .schedule-cell.odd-row { background: #1e293b; }
        body.dark-mode .schedule-cell:hover { background: #4a5568; }
        body.dark-mode .schedule-cell.merged:hover { background: #4a5568; }
        body.dark-mode .schedule-cell-half { background: #0f172a; }
        body.dark-mode .schedule-cell-half.odd-row { background: #1e293b; }
        body.dark-mode .schedule-cell-half:hover { background: #4a5568; }
        body.dark-mode .schedule-cell-split { background: #334155; }
        body.dark-mode .schedule-cell-split .schedule-cell.merged { background: #0f172a; }
        body.dark-mode .schedule-cell-split .schedule-cell.merged:hover { background: #4a5568; }
        body.dark-mode .schedule-cell-split .schedule-cell.merged::before { background: #334155; }
        body.dark-mode .schedule-cell-split .schedule-cell.merged .student-slot { box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); }
        body.dark-mode .student-slot { background: #2c5282; border-left-color: #63b3ed; color: #e2e8f0; }
        body.dark-mode .attendance-indicator { background: #4a5568; border-color: #718096; }
        body.dark-mode .attendance-indicator.present { background: #48bb78; border-color: #38a169; }
        body.dark-mode .attendance-indicator.absent { background: #f56565; border-color: #e53e3e; }
        body.dark-mode .student-slot.linked-first { border-bottom-color: #63b3ed; }
        body.dark-mode .student-slot.present { background: rgba(72, 187, 120, 0.4); border-left-color: #48bb78; }
        body.dark-mode .student-slot.absent { background: rgba(245, 101, 101, 0.4); border-left-color: #f56565; }
        body.dark-mode .student-slot-order { background: rgba(255,255,255,0.15); }
        body.dark-mode .modal-content { background: #2d3748; }
        body.dark-mode .checkbox-list { border-color: #4a5568; }
        body.dark-mode .checkbox-item { background: #1a202c; }
        body.dark-mode .week-nav { background: #2d3748; }
        body.dark-mode div[style*="background: #f7fafc"] { background: #2d3748 !important; }

        .scrollable-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 1.1em; }
            .header h2 { font-size: 0.8em; }
            .header h4 { font-size: 0.7em; }

            .tabs {
                flex-direction: column;
            }
            .tab {
                border-bottom: 1px solid #dee2e6;
            }
            .tab.active {
                border-bottom: 3px solid #667eea;
            }
            body.dark-mode .tab {
                border-bottom-color: #4a5568;
            }
            body.dark-mode .tab.active {
                border-bottom-color: #818cf8;
            }

            .stats-row {
                grid-template-columns: 1fr;
            }

            div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }

            .scrollable-container {
                overflow-x: auto;
            }

            .schedule-grid {
                min-width: 630px;
            }
            
            .attendance-table, .trijazen-table {
                min-width: 800px;
            }

            .modal-content {
                width: 95%;
                padding: 15px;
            }
            
            .student-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .student-item-arrows {
                flex-direction: row;
                order: -1;
                width: 100%;
                justify-content: center;
            }
            
            .student-item-info {
                width: 100%;
                order: 0;
            }
            
            .student-item-actions {
                width: 100%;
                order: 1;
                justify-content: space-between;
            }
            
            .student-item-actions .btn {
                flex: 1;
                padding: 10px 15px;
            }
            
            .info-row {
                grid-template-columns: 1fr !important;
            }
        }
        
        /* Trijazen Test Styles */
        .test-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            background: #48bb78;
            color: white;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .trijazen-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }
        
        body.dark-mode .trijazen-info {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
        }
        
        .trijazen-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
            background: white;
            border-radius: 6px;
            overflow: hidden;
            table-layout: fixed;
        }
        
        body.dark-mode .trijazen-table {
            background: #1a202c;
        }
        
        .trijazen-table th:nth-child(1),
        .trijazen-table td:nth-child(1) {
            width: 10%;
        }
        
        .trijazen-table th:nth-child(2),
        .trijazen-table td:nth-child(2) {
            width: 30%;
        }
        
        .trijazen-table th:nth-child(3),
        .trijazen-table td:nth-child(3) {
            width: 60%;
        }
        
        .trijazen-table th,
        .trijazen-table td {
            border: 1px solid #e2e8f0;
            padding: 12px;
            text-align: left;
        }
        
        body.dark-mode .trijazen-table th,
        body.dark-mode .trijazen-table td {
            border-color: #4a5568;
            color: #e2e8f0;
        }
        
        .trijazen-table th {
            background: #f7fafc;
            font-weight: 600;
            color: #2d3748;
        }
        
        body.dark-mode .trijazen-table th {
            background: #2d3748;
            color: #e2e8f0;
        }
        
        .radio-group {
            display: flex;
            justify-content: space-around;
            gap: 10px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .radio-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .radio-option label {
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
        }
        
        .info-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .info-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .info-group select,
        .info-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            font-size: 14px;
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .info-group select option {
            color: #333;
        }
        
        /* Trijazen Toggle Buttons */
        .trijazen-toggle {
            width: 50px;
            height: 35px;
            border-radius: 6px;
            background: #cbd5e0;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            border: 2px solid #a0aec0;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #2d3748;
            user-select: none;
        }
        
        .trijazen-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .trijazen-toggle.plus {
            background: #48bb78;
            border-color: #38a169;
            color: white;
        }
        
        .trijazen-toggle.plusminus {
            background: #f6ad55;
            border-color: #dd6b20;
            color: white;
        }
        
        .trijazen-toggle.minus {
            background: #fc8181;
            border-color: #e53e3e;
            color: white;
        }
        
        body.dark-mode .trijazen-toggle {
            background: #4a5568;
            border-color: #718096;
        }
        
        body.dark-mode .trijazen-toggle.plus {
            background: #48bb78;
            border-color: #38a169;
        }
        
        body.dark-mode .trijazen-toggle.plusminus {
            background: #f6ad55;
            border-color: #dd6b20;
        }
        
        body.dark-mode .trijazen-toggle.minus {
            background: #fc8181;
            border-color: #e53e3e;
        }
        
        .trijazen-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 3px 8px;
            background: #805ad5;
            color: white;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        body.dark-mode .student-item label span {
            color: #cbd5e0 !important;
        }

        /* ‚îÄ‚îÄ Generator Tab Styles ‚îÄ‚îÄ */
        .gen-container { max-width: 900px; margin: 0 auto; }
        .gen-card {
            background: #fff;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: box-shadow 0.3s;
        }
        .gen-card:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .gen-card-title {
            font-size: 16px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .gen-card-title .icon { font-size: 20px; }
        body.dark-mode .gen-card { background: #2d3748; border-color: #4a5568; }
        body.dark-mode .gen-card-title { color: #e2e8f0; }

        .gen-doc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
        }
        .gen-doc-option {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px 14px;
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .gen-doc-option:hover { border-color: #667eea; background: #ebf4ff; }
        .gen-doc-option.selected { border-color: #667eea; background: #ebf4ff; box-shadow: 0 0 0 3px rgba(102,126,234,0.2); }
        .gen-doc-option input[type="checkbox"] { width: 18px; height: 18px; margin-top: 2px; accent-color: #667eea; cursor: pointer; }
        .gen-doc-label { flex: 1; }
        .gen-doc-label strong { display: block; font-size: 14px; color: #2d3748; }
        .gen-doc-label small { font-size: 12px; color: #718096; }
        body.dark-mode .gen-doc-option { background: #1a202c; border-color: #4a5568; }
        body.dark-mode .gen-doc-option:hover { border-color: #818cf8; background: #2a3350; }
        body.dark-mode .gen-doc-option.selected { border-color: #818cf8; background: #2a3350; box-shadow: 0 0 0 3px rgba(129,140,248,0.2); }
        body.dark-mode .gen-doc-label strong { color: #e2e8f0; }
        body.dark-mode .gen-doc-label small { color: #a0aec0; }

        .gen-row {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
        }
        .gen-field { display: flex; flex-direction: column; gap: 5px; }
        .gen-field label { font-size: 13px; font-weight: 600; color: #4a5568; }
        body.dark-mode .gen-field label { color: #a0aec0; }
        .gen-field input, .gen-field select {
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            background: #fff;
            color: #2d3748;
            transition: border-color 0.2s;
        }
        .gen-field input:focus, .gen-field select:focus { border-color: #667eea; outline: none; }
        body.dark-mode .gen-field input, body.dark-mode .gen-field select {
            background: #1a202c; border-color: #4a5568; color: #e2e8f0;
        }
        body.dark-mode .gen-field input:focus, body.dark-mode .gen-field select:focus { border-color: #818cf8; }

        .gen-radio-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .gen-radio-pill {
            padding: 8px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            color: #4a5568;
            transition: all 0.2s;
            user-select: none;
        }
        .gen-radio-pill:hover { border-color: #667eea; color: #667eea; }
        .gen-radio-pill.active { background: #667eea; color: #fff; border-color: #667eea; }
        body.dark-mode .gen-radio-pill { border-color: #4a5568; color: #a0aec0; }
        body.dark-mode .gen-radio-pill:hover { border-color: #818cf8; color: #818cf8; }
        body.dark-mode .gen-radio-pill.active { background: #818cf8; color: #fff; border-color: #818cf8; }

        .gen-student-select { margin-top: 12px; display: none; }
        .gen-student-select.visible { display: block; }
        .gen-student-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; max-height: 200px; overflow-y: auto; padding: 4px; }
        .gen-student-chip {
            padding: 6px 14px;
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        .gen-student-chip:hover { border-color: #667eea; }
        .gen-student-chip.selected { background: #667eea; color: #fff; border-color: #667eea; }
        body.dark-mode .gen-student-chip { background: #1a202c; border-color: #4a5568; color: #cbd5e0; }
        body.dark-mode .gen-student-chip:hover { border-color: #818cf8; }
        body.dark-mode .gen-student-chip.selected { background: #818cf8; color: #fff; border-color: #818cf8; }

        .gen-command-box {
            background: #1a202c;
            color: #68d391;
            padding: 16px 20px;
            border-radius: 8px;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.7;
            white-space: pre-wrap;
            word-break: break-all;
            position: relative;
            min-height: 60px;
            max-height: 300px;
            overflow-y: auto;
        }
        .gen-command-box .cmd-comment { color: #718096; }
        .gen-command-box .cmd-flag { color: #63b3ed; }
        .gen-command-box .cmd-value { color: #fbd38d; }

        .gen-preview {
            background: #f7fafc;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 15px 20px;
        }
        body.dark-mode .gen-preview { background: #1a202c; border-color: #4a5568; }
        .gen-preview-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 13px;
            color: #4a5568;
        }
        body.dark-mode .gen-preview-item { color: #cbd5e0; }
        .gen-preview-item .file-icon { font-size: 16px; }
        .gen-preview-count {
            font-size: 14px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 10px;
        }
        body.dark-mode .gen-preview-count { color: #818cf8; }

        .gen-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
        .gen-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .gen-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .gen-btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; }
        .gen-btn-success { background: linear-gradient(135deg, #48bb78, #38a169); color: #fff; }
        .gen-btn-secondary { background: #4a5568; color: #fff; }
        .gen-btn-info { background: linear-gradient(135deg, #4299e1, #3182ce); color: #fff; }

        .gen-toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #48bb78;
            color: #fff;
            padding: 14px 24px;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 10000;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
            pointer-events: none;
        }
        .gen-toast.show { opacity: 1; transform: translateY(0); }

        .gen-separator { height: 1px; background: #e2e8f0; margin: 8px 0 15px 0; }
        body.dark-mode .gen-separator { background: #4a5568; }

        .gen-toggle-row { display: flex; align-items: center; gap: 10px; margin: 6px 0; }
        .gen-toggle-row label { font-size: 14px; color: #4a5568; cursor: pointer; }
        body.dark-mode .gen-toggle-row label { color: #cbd5e0; }
        .gen-toggle-row input[type="checkbox"] { width: 18px; height: 18px; accent-color: #667eea; cursor: pointer; }
   </style>
</head>
<body>
    <div class="header">
        <div class="theme-switch-wrapper">
            <label class="theme-switch" for="checkbox">
                <input type="checkbox" id="checkbox" />
                <div class="slider round"></div>
            </label>
        </div>
        <div style="text-align: center;">
            <h1 style="font-size: 2.8em; margin: 10px 0; text-shadow: 0 4px 8px rgba(0,0,0,0.3); letter-spacing: 2px; font-weight: 700;">
                üìö –ï–õ–ï–ö–¢–†–û–ù–°–ö–ò –î–ù–ï–í–ù–ò–ö
            </h1>
            <h2 style="font-size: 1.1em; margin: 8px 0; opacity: 0.95;">–ö–∞–±–∏–Ω–µ—Ç –∑–∞ —Å–ª—É—Ö, –≥–æ–≤–æ—Ä, –≥–ª–∞—Å, –∞–ª—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –∏ –∞—É–≥–º–µ–Ω—Ç–∞—Ç–∏–≤–Ω–∞ –∫–æ–º—É–Ω–∏–∫–∞—Ü–∏—ò–∞</h2>
            <h4 style="font-size: 0.85em; margin: 8px 0; opacity: 0.85;">–°–∏—Å—Ç–µ–º –∑–∞ —É–ø—Ä–∞–≤—É–≤–∞—ö–µ —É—á–µ–Ω–∏—Ü–∏ —Å–æ –Ω–µ–¥–µ–ª–µ–Ω —Ä–∞—Å–ø–æ—Ä–µ–¥ –Ω–∞ —Ç—Ä–µ—Ç–º–∞–Ω–∏ –∏ –Ω–∞–ø—Ä–µ–¥–æ–∫–æ—Ç –≤–æ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–∏–æ—Ç –ø–ª–∞–Ω</h4>
        </div>
    </div>
    
    <div class="tabs">
        <button class="tab" onclick="switchTab('students')">–£—á–µ–Ω–∏—Ü–∏</button>
        <button class="tab active" onclick="switchTab('schedule')">–†–∞—Å–ø–æ—Ä–µ–¥</button>
        <button class="tab" onclick="switchTab('progress')">–ù–∞–ø—Ä–µ–¥–æ–∫</button>
        <button class="tab" onclick="switchTab('plans')">–ü–ª–∞–Ω–æ–≤–∏</button>
        <button class="tab" onclick="switchTab('trijazen')">–¢—Ä–∏—ò–∞–∂–Ω–∏ —Ç–µ—Å—Ç–æ–≤–∏</button>
        <button class="tab" onclick="switchTab('data')">–ü–æ–¥–∞—Ç–æ—Ü–∏</button>
        <button class="tab" onclick="switchTab('dosie')">üìÇ –î–æ—Å–∏–µ</button>
        <button class="tab" onclick="switchTab('audiogramsApp')">–ê—É–¥–∏–æ–≥—Ä–∞–º–∏</button>
        <button class="tab" onclick="switchTab('generator')">üìÑ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</button>
    </div>
    
    <div class="content">
        <!-- Students Tab -->
        <div id="students" class="tab-content">
            <button class="btn btn-primary btn-full" onclick="showAddStudentModal()">+ –î–æ–¥–∞–¥–∏ –£—á–µ–Ω–∏–∫</button>
            
            <div id="studentListSimple" class="student-list-simple"></div>
            
            <div class="capacity-box">
                <h3>üìã –ò—Å–∫–æ—Ä–∏—Å—Ç–µ–Ω–æ—Å—Ç –Ω–∞ —Ä–∞—Å–ø–æ—Ä–µ–¥–æ—Ç</h3>
                <div class="capacity-item">
                    <span class="icon">üë§</span>
                    <span id="capacityUsage">0/1000 –º–∏–Ω | 0% –∏—Å–∫–æ—Ä–∏—Å—Ç–µ–Ω–æ</span>
                </div>
                <div class="progress-bar-container">
                    <div id="capacityProgressBar" class="progress-bar-fill green" style="width: 0%;">0%</div>
                </div>
                <div id="capacityAlert"></div>
                <div id="sessionSummary" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;"></div>
            </div>
        </div>
        
        <!-- Schedule Tab -->
        <div id="schedule" class="tab-content active">
            <div class="week-nav">
                <button class="btn btn-primary" onclick="changeWeek(-1)">‚Üê –ü—Ä–µ—Ç—Ö–æ–¥–Ω–∞</button>
                <div id="weekDisplay" style="text-align: center;"></div>
                <button class="btn btn-primary" onclick="changeWeek(1)">–°–ª–µ–¥–Ω–∞ ‚Üí</button>
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
                <button class="btn btn-success" onclick="manualSave()">–ó–∞—á—É–≤–∞—ò</button>
                <button id="undoBtn" class="btn" style="background: #718096; color: white;" onclick="undoLastChange()" disabled>‚Ü∂ Undo</button>
                <button id="redoBtn" class="btn" style="background: #718096; color: white;" onclick="redoLastChange()" disabled>‚Ü∑ Redo</button>
                <button id="lockToggleBtn" class="btn" style="background: #e53e3e; color: white; margin-left: auto;" onclick="togglePastWeekLock()">
                    üîí –ò–∑–º–∏–Ω–∞—Ç–∞ —Å–µ–¥–º–∏—Ü–∞ –µ –∑–∞–∫–ª—É—á–µ–Ω–∞
                </button>
            </div>
            <div class="scrollable-container">
                <div id="scheduleGrid"></div>
            </div>
        </div>
        
        <!-- Progress Tab -->
        <div id="progress" class="tab-content">
            <div class="section-header">–°–ª–µ–¥–µ—ö–µ –Ω–∞ –ù–∞–ø—Ä–µ–¥–æ–∫</div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                <button class="btn btn-primary btn-full" onclick="switchProgressView('student')">–†–µ–∞–ª–∏–∑–∞—Ü–∏—ò–∞ –Ω–∞ –æ–ø–µ—Ä–∞—Ç–∏–≤–µ–Ω –ø–ª–∞–Ω</button>
                <button class="btn btn-success btn-full" onclick="switchProgressView('monthly')">–ü—Ä–∏—Å—É—Ç–Ω–æ—Å—Ç –ø–æ –º–µ—Å–µ—Ü</button>
            </div>
            
            <div id="studentProgressView">
                <div class="form-group">
                    <label>–ò–∑–±–µ—Ä–∏ –£—á–µ–Ω–∏–∫:</label>
                    <select id="progressStudentSelect" onchange="loadStudentProgress()">
                        <option value="">-- –ò–∑–±–µ—Ä–∏ —É—á–µ–Ω–∏–∫ --</option>
                    </select>
                </div>
                <div id="progressActivitiesList" class="progress-list"></div>
            </div>
            
            <div id="monthlyProgressView" style="display: none;">
                <div class="form-group">
                    <label>–ò–∑–±–µ—Ä–∏ –º–µ—Å–µ—Ü:</label>
                    <input type="month" id="monthSelector" onchange="generateMonthlyAttendance()">
                </div>
                <div class="scrollable-container">
                    <div id="monthlyAttendanceTable"></div>
                </div>
            </div>
        </div>
        
        <!-- Plans Tab -->
        <div id="plans" class="tab-content">
            <button class="btn btn-primary btn-full" onclick="showAddPlanModal()">+ –ö—Ä–µ–∏—Ä–∞—ò –ü–ª–∞–Ω</button>
            <div id="plansList" style="margin-top: 20px;"></div>
            
            <!-- Useful Links Section -->
            <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                <button class="btn btn-success btn-full" onclick="showAddLinkModal()">+ –î–æ–¥–∞–¥–∏ –õ–∏–Ω–∫</button>
                <div id="linksList" style="margin-top: 20px;"></div>
            </div>
        </div>
        
        <!-- Trijazen Test Tab -->
        <div id="trijazen" class="tab-content">
            <div class="trijazen-info">
                <h2>üéØ –§–æ–Ω–µ—Ç—Å–∫–∞ –ø—Ä–æ—Ü–µ–Ω–∞ - –¢—Ä–∏—ò–∞–∂–µ–Ω —Ç–µ—Å—Ç</h2>
                <div class="info-row">
                    <div class="info-group">
                        <label>–ò–∑–±–µ—Ä–∏ —É—á–µ–Ω–∏–∫:</label>
                        <select id="trijazenStudentSelect" onchange="updateTrijazenStudent()">
                            <option value="">-- –ò–∑–±–µ—Ä–∏ —É—á–µ–Ω–∏–∫ --</option>
                        </select>
                    </div>
                    <div class="info-group">
                        <label>–î–∞—Ç—É–º –Ω–∞ –ø—Ä–æ—Ü–µ–Ω–∞:</label>
                        <input type="date" id="trijazenDate">
                    </div>
                    <div class="info-group">
                        <label>–ü—Ä–æ—Ü–µ–Ω—É–≤–∞—á:</label>
                        <input type="text" id="trijazenAssessor" placeholder="–í–Ω–µ—Å–∏ –∏–º–µ...">
                    </div>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 6px; margin-top: 10px;">
                    <strong>–û–¥–¥–µ–ª–µ–Ω–∏–µ:</strong> <span id="trijazenGrade">–ò–∑–±–µ—Ä–µ—Ç–µ —É—á–µ–Ω–∏–∫</span>
                </div>
                <div style="margin-top: 15px; text-align: right;">
                    <button class="btn btn-primary" onclick="exportTrijazenToJpeg()">üì∏ –ï–∫—Å–ø–æ—Ä—Ç –≤–æ JPEG</button>
                </div>
            </div>
            
            <div id="trijazenFormContainer">
                <!-- Phonemes will be generated dynamically -->
            </div>
        </div>
        <!-- Dosie Tab (Embedded Single-File) -->
        <div id="dosie" class="tab-content">
            <div class="section-header">üìÇ –î–æ—Å–∏–µ</div>
            <iframe id="dosieFrame" style="width: 100%; min-height: calc(100vh - 260px); border: none; border-radius: 8px; background: white;"></iframe>
        </div>

        <!-- Audiograms Tab (Embedded Single-File) -->
        <div id="audiogramsApp" class="tab-content">
            <div class="section-header">üéß –ê—É–¥–∏–æ–≥—Ä–∞–º–∏</div>
            <iframe id="audiogramFrame" style="width: 100%; min-height: calc(100vh - 260px); border: none; border-radius: 8px; background: white;"></iframe>
        </div>




        <!-- Generator Tab -->
        <div id="generator" class="tab-content">
            <div class="section-header">üìÑ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –Ω–∞ DOCX –¥–æ–∫—É–º–µ–Ω—Ç–∏</div>
            <div class="gen-container">

                <!-- 0. WORKFLOW GUIDE -->
                <div class="gen-card" style="border-color: #667eea; border-width: 2px; background: linear-gradient(135deg, #ebf4ff 0%, #f0e6ff 100%);">
                    <div class="gen-card-title"><span class="icon">üó∫Ô∏è</span> –ö–∞–∫–æ –¥–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç–∏ (—á–µ–∫–æ—Ä –ø–æ —á–µ–∫–æ—Ä)</div>
                    <div id="genGuideContent">
                        <div style="display:grid; grid-template-columns: 40px 1fr; gap: 8px 12px; font-size:14px; line-height:1.6;">

                            <div style="background:#667eea;color:#fff;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-weight:700;">1</div>
                            <div><strong>–ü–æ–¥–≥–æ—Ç–≤–µ—Ç–µ –≥–∏ –ø–æ–¥–∞—Ç–æ—Ü–∏—Ç–µ</strong><br>
                                <span style="color:#4a5568;">–í–Ω–µ—Å–µ—Ç–µ —É—á–µ–Ω–∏—Ü–∏ –∏ –ø–æ–¥–∞—Ç–æ—Ü–∏ –≤–æ —Ç–∞–±–æ—Ç <em>–£—á–µ–Ω–∏—Ü–∏</em>, –∏–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–∞—ò—Ç–µ JSON –≤–æ —Ç–∞–±–æ—Ç <em>–ü–æ–¥–∞—Ç–æ—Ü–∏</em>.<br>
                                ‚§∑ –ö–ª–∏–∫–Ω–µ—Ç–µ <strong>üì• –ï–∫—Å–ø–æ—Ä—Ç JSON</strong> (–¥–æ–ª—É) –∑–∞ –¥–∞ –≥–æ –∑–∞—á—É–≤–∞—Ç–µ –∫–∞–∫–æ <code style="background:#e2e8f0;padding:2px 6px;border-radius:4px;">e_dnevnik_unified_state_v7.json</code></span>
                            </div>

                            <div style="background:#667eea;color:#fff;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-weight:700;">2</div>
                            <div><strong>–ü–æ–¥–≥–æ—Ç–≤–µ—Ç–µ –≥–æ —à–∞–±–ª–æ–Ω–æ—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª–Ω–æ)</strong><br>
                                <span style="color:#4a5568;">–û—Ç–≤–æ—Ä–µ—Ç–µ <code style="background:#e2e8f0;padding:2px 6px;border-radius:4px;">template.docx</code> –≤–æ Word/LibreOffice –∏ –¥–æ–¥–∞–¥–µ—Ç–µ –ø–ª–µ—ò—Å—Ö–æ–ª–¥–µ—Ä–∏:<br>
                                <code style="background:#e2e8f0;padding:2px 6px;border-radius:4px;font-size:12px;">{{firstName}} {{lastName}} {{grade}} {{birthDate}} {{findings}} {{opinion}} {{attachments}}</code><br>
                                ‚§∑ –ó–∞—á—É–≤–∞—ò—Ç–µ –≥–æ –≤–æ <strong>–∏—Å—Ç–∏–æ—Ç —Ñ–æ–ª–¥–µ—Ä</strong> –∫–∞–¥–µ –µ JSON —Ñ–∞—ò–ª–æ—Ç –∏ Python —Å–∫—Ä–∏–ø—Ç–∏—Ç–µ.</span>
                            </div>

                            <div style="background:#667eea;color:#fff;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-weight:700;">3</div>
                            <div><strong>–ü–æ—Å—Ç–∞–≤–µ—Ç–µ –≥–∏ —Ñ–∞—ò–ª–æ–≤–∏—Ç–µ –≤–æ –∏—Å—Ç —Ñ–æ–ª–¥–µ—Ä</strong><br>
                                <span style="color:#4a5568;">
                                üìÅ <strong>–í–∞—à–∏–æ—Ç —Ñ–æ–ª–¥–µ—Ä</strong> —Ç—Ä–µ–±–∞ –¥–∞ –∏–∑–≥–ª–µ–¥–∞ –≤–∞–∫–∞:<br>
                                <code style="background:#1a202c;color:#68d391;padding:8px 12px;border-radius:6px;display:block;margin:6px 0;font-size:12px;line-height:1.8;">
                                üìÇ –ú–æ—ò–§–æ–ª–¥–µ—Ä/<br>
                                ‚îú‚îÄ‚îÄ compact_factory.py<br>
                                ‚îú‚îÄ‚îÄ document_factory_v7.py<br>
                                ‚îú‚îÄ‚îÄ run_config.py &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚Üê (–≥–æ —á–∏—Ç–∞ gen_config.json)<br>
                                ‚îú‚îÄ‚îÄ LAUNCHER.bat &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚Üê (–¥–≤–æ–µ–Ω-–∫–ª–∏–∫, –≤–µ—ú–µ –æ–¥–±–ª–æ–∫–∏—Ä–∞–Ω)<br>
                                ‚îú‚îÄ‚îÄ e_dnevnik_unified_state_v7.json &nbsp;‚Üê (–æ–¥ —á–µ–∫–æ—Ä 1)<br>
                                ‚îú‚îÄ‚îÄ gen_config.json &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚Üê (–æ–¥ "–ó–∞—á—É–≤–∞—ò –∫–æ–Ω—Ñ–∏–≥" –∫–æ–ø—á–µ—Ç–æ)<br>
                                ‚îú‚îÄ‚îÄ template.docx &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚Üê (–æ–ø—Ü–∏–æ–Ω–∞–ª–Ω–æ, –∑–∞ compact_factory)<br>
                                ‚îî‚îÄ‚îÄ OUT/ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;‚Üê (—ú–µ —Å–µ –∫—Ä–µ–∏—Ä–∞ –∞–≤—Ç–æ–º–∞—Ç—Å–∫–∏)
                                </code></span>
                            </div>

                            <div style="background:#667eea;color:#fff;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-weight:700;">4</div>
                            <div><strong>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–∞—ò—Ç–µ –ø–æ–¥–æ–ª—É –∏ –≥–µ–Ω–µ—Ä–∏—Ä–∞—ò—Ç–µ –∫–æ–º–∞–Ω–¥–∞</strong><br>
                                <span style="color:#4a5568;">–ò–∑–±–µ—Ä–µ—Ç–µ —Ç–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç, —É—á–µ–Ω–∏—Ü–∏, –ø–æ—Å—Ç–∞–≤–∫–∏ ‚Üí –∫–ª–∏–∫–Ω–µ—Ç–µ <strong>üî® –ì–µ–Ω–µ—Ä–∏—Ä–∞—ò –∫–æ–º–∞–Ω–¥–∞</strong><br>
                                ‚§∑ –ö–æ–ø–∏—Ä–∞—ò—Ç–µ —ò–∞ –∫–æ–º–∞–Ω–¥–∞—Ç–∞, –∏–ª–∏ –∫–ª–∏–∫–Ω–µ—Ç–µ <em>"–ó–∞—á—É–≤–∞—ò –∫–æ–Ω—Ñ–∏–≥"</em> –∑–∞ LAUNCHER.bat</span>
                            </div>

                            <div style="background:#48bb78;color:#fff;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-weight:700;">5</div>
                            <div><strong>–ò–∑–≤—Ä—à–µ—Ç–µ –Ω–∞ –≤–∞—à–∏–æ—Ç –∫–æ–º–ø—ò—É—Ç–µ—Ä (2 –Ω–∞—á–∏–Ω–∏)</strong><br>
                                <span style="color:#4a5568;">
                                <strong style="color:#dd6b20;">üöÄ –õ–µ—Å–µ–Ω –Ω–∞—á–∏–Ω (–ø—Ä–µ–ø–æ—Ä–∞—á–∞–Ω–æ):</strong> –ö–ª–∏–∫–Ω–µ—Ç–µ <em>"–ó–∞—á—É–≤–∞—ò –∫–æ–Ω—Ñ–∏–≥ ‚Üí LAUNCHER.bat"</em> –¥–æ–ª—É ‚Üí —Å—Ç–∞–≤–µ—Ç–µ –≥–æ <code style="background:#e2e8f0;padding:2px 6px;border-radius:4px;">gen_config.json</code> –≤–æ —Ñ–æ–ª–¥–µ—Ä–æ—Ç ‚Üí –¥–≤–æ–µ–Ω-–∫–ª–∏–∫ –Ω–∞ <code style="background:#e2e8f0;padding:2px 6px;border-radius:4px;">LAUNCHER.bat</code> (–≤–µ—ú–µ –æ–¥–±–ª–æ–∫–∏—Ä–∞–Ω, –Ω–µ–º–∞ –≤–∏—Ä—É—Å –ø—Ä–µ–¥—É–ø—Ä–µ–¥—É–≤–∞—ö–∞!)<br><br>
                                <strong style="color:#4a5568;">üíª –†–∞—á–µ–Ω –Ω–∞—á–∏–Ω:</strong> –ö–æ–ø–∏—Ä–∞—ò—Ç–µ —ò–∞ –∫–æ–º–∞–Ω–¥–∞—Ç–∞ ‚Üí –æ—Ç–≤–æ—Ä–µ—Ç–µ PowerShell ‚Üí Paste ‚Üí Enter</span>
                            </div>
                        </div>
                    </div>
                    <div style="text-align:right;margin-top:10px;">
                        <button class="gen-btn gen-btn-secondary" style="padding:6px 14px;font-size:12px;" onclick="var c=document.getElementById('genGuideContent');c.style.display=c.style.display==='none'?'block':'none';this.textContent=c.style.display==='none'?'üìñ –ü–æ–∫–∞–∂–∏ –≤–æ–¥–∏—á':'üîº –°–æ–∫—Ä–∏—ò –≤–æ–¥–∏—á'">üîº –°–æ–∫—Ä–∏—ò –≤–æ–¥–∏—á</button>
                    </div>
                </div>

                <!-- 1. Document Types -->
                <div class="gen-card">
                    <div class="gen-card-title"><span class="icon">üìã</span> –¢–∏–ø –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç</div>
                    <div class="gen-doc-grid" id="genDocTypeGrid">
                        <div class="gen-doc-option selected" data-doctype="dosie" onclick="genToggleDocType(this)">
                            <input type="checkbox" checked data-doctype="dosie" onclick="event.stopPropagation()">
                            <div class="gen-doc-label">
                                <strong>üìÅ –î–æ—Å–∏–µ</strong>
                                <small>–õ–∏—á–Ω–æ –¥–æ—Å–∏–µ –∑–∞ —Å–µ–∫–æ—ò —É—á–µ–Ω–∏–∫</small>
                            </div>
                        </div>
                        <div class="gen-doc-option" data-doctype="roditelski" onclick="genToggleDocType(this)">
                            <input type="checkbox" data-doctype="roditelski" onclick="event.stopPropagation()">
                            <div class="gen-doc-label">
                                <strong>üë®‚Äçüë©‚Äçüëß –†–æ–¥–∏—Ç–µ–ª—Å–∫–∏ —Å—Ä–µ–¥–±–∏</strong>
                                <small>–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª–Ω–∏ —Å—Ä–µ–¥–±–∏ —Å–æ —Ä–æ–¥–∏—Ç–µ–ª–∏</small>
                            </div>
                        </div>
                        <div class="gen-doc-option" data-doctype="sostanoci" onclick="genToggleDocType(this)">
                            <input type="checkbox" data-doctype="sostanoci" onclick="event.stopPropagation()">
                            <div class="gen-doc-label">
                                <strong>üë• –°–æ—Å—Ç–∞–Ω–æ—Ü–∏</strong>
                                <small>–ì—Ä—É–ø–Ω–∏ —Ä–æ–¥–∏—Ç–µ–ª—Å–∫–∏ —Å–æ—Å—Ç–∞–Ω–æ—Ü–∏</small>
                            </div>
                        </div>
                        <div class="gen-doc-option" data-doctype="izvestaj" onclick="genToggleDocType(this)">
                            <input type="checkbox" data-doctype="izvestaj" onclick="event.stopPropagation()">
                            <div class="gen-doc-label">
                                <strong>üìä –ò–∑–≤–µ—à—Ç–∞—ò</strong>
                                <small>–°—É–º–∏—Ä–∞–Ω –∏–∑–≤–µ—à—Ç–∞—ò –∑–∞ —Å–∏—Ç–µ —É—á–µ–Ω–∏—Ü–∏</small>
                            </div>
                        </div>
                        <div class="gen-doc-option" data-doctype="periodicen" onclick="genToggleDocType(this)">
                            <input type="checkbox" data-doctype="periodicen" onclick="event.stopPropagation()">
                            <div class="gen-doc-label">
                                <strong>üìÖ –ü–µ—Ä–∏–æ–¥–∏—á–µ–Ω –∏–∑–≤–µ—à—Ç–∞—ò</strong>
                                <small>–ù–∞—Ä–∞—Ç–∏–≤–µ–Ω –∏–∑–≤–µ—à—Ç–∞—ò –ø–æ –æ–¥–¥–µ–ª–µ–Ω–∏–µ</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. Student Selection -->
                <div class="gen-card">
                    <div class="gen-card-title"><span class="icon">üéì</span> –ò–∑–±–æ—Ä –Ω–∞ —É—á–µ–Ω–∏—Ü–∏</div>
                    <div class="gen-radio-group" id="genStudentModeGroup">
                        <div class="gen-radio-pill active" data-mode="all" onclick="genSetStudentMode('all',this)">–°–∏—Ç–µ —É—á–µ–Ω–∏—Ü–∏</div>
                        <div class="gen-radio-pill" data-mode="single" onclick="genSetStudentMode('single',this)">–ï–¥–µ–Ω —É—á–µ–Ω–∏–∫</div>
                    </div>
                    <div id="genStudentSelect" class="gen-student-select">
                        <div class="gen-student-chips" id="genStudentChips">
                            <!-- filled dynamically -->
                        </div>
                    </div>
                </div>

                <!-- 3. Configuration -->
                <div class="gen-card">
                    <div class="gen-card-title"><span class="icon">‚öôÔ∏è</span> –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—ò–∞</div>
                    <div class="gen-row">
                        <div class="gen-field">
                            <label for="genSchoolYear">–£—á–µ–±–Ω–∞ –≥–æ–¥–∏–Ω–∞</label>
                            <input type="text" id="genSchoolYear" value="2025-2026" placeholder="2025-2026">
                        </div>
                        <div class="gen-field">
                            <label for="genTherapistName">–ò–º–µ –Ω–∞ —Ç–µ—Ä–∞–ø–µ–≤—Ç</label>
                            <input type="text" id="genTherapistName" value="–ë–ª–∞–≥–æ—ò –ù–∞—Å–µ–≤" placeholder="–ë–ª–∞–≥–æ—ò –ù–∞—Å–µ–≤">
                        </div>
                        <div class="gen-field">
                            <label for="genTherapistTitle">–¢–∏—Ç—É–ª–∞ –Ω–∞ —Ç–µ—Ä–∞–ø–µ–≤—Ç</label>
                            <input type="text" id="genTherapistTitle" value="–¥–∏–ø–ª. –¥–µ—Ñ. —Å—É—Ä–¥–æ–ª–æ–≥-–∞—É–¥–∏–æ—Ä–µ—Ö–∞–±–∏–ª–∏—Ç–∞—Ç–æ—Ä" placeholder="–¥–∏–ø–ª. –¥–µ—Ñ. —Å—É—Ä–¥–æ–ª–æ–≥-–∞—É–¥–∏–æ—Ä–µ—Ö–∞–±–∏–ª–∏—Ç–∞—Ç–æ—Ä">
                        </div>
                        <div class="gen-field">
                            <label for="genInstitution">–ò–Ω—Å—Ç–∏—Ç—É—Ü–∏—ò–∞</label>
                            <input type="text" id="genInstitution" placeholder="–¶–µ–ª–æ—Å–Ω–æ –∏–º–µ –Ω–∞ –∏–Ω—Å—Ç–∏—Ç—É—Ü–∏—ò–∞—Ç–∞">
                        </div>
                    </div>

                    <div class="gen-separator"></div>

                    <div class="gen-row" style="margin-top: 10px;">
                        <div class="gen-field">
                            <label for="genFontName">–§–æ–Ω—Ç</label>
                            <select id="genFontName">
                                <option value="Times New Roman" selected>Times New Roman</option>
                                <option value="Arial">Arial</option>
                                <option value="Calibri">Calibri</option>
                                <option value="Cambria">Cambria</option>
                                <option value="Georgia">Georgia</option>
                            </select>
                        </div>
                        <div class="gen-field">
                            <label for="genFontSize">–ì–æ–ª–µ–º–∏–Ω–∞ –Ω–∞ —Ñ–æ–Ω—Ç</label>
                            <input type="number" id="genFontSize" value="12" min="8" max="24">
                        </div>
                        <div class="gen-field">
                            <label for="genOutDir">–ò–∑–ª–µ–∑–µ–Ω —Ñ–æ–ª–¥–µ—Ä</label>
                            <input type="text" id="genOutDir" value="OUT" placeholder="OUT">
                        </div>
                    </div>

                    <div class="gen-separator"></div>

                    <div style="margin-top: 10px;">
                        <label style="font-size: 13px; font-weight: 600; color: #4a5568; margin-bottom: 8px; display: block;">–†–µ–∂–∏–º –Ω–∞ –∏–∑–ª–µ–∑</label>
                        <div class="gen-radio-group" id="genOutputModeGroup">
                            <div class="gen-radio-pill active" data-mode="separate" onclick="genSetOutputMode('separate',this)">üìë –û–¥–¥–µ–ª–Ω–∏ —Ñ–∞—ò–ª–æ–≤–∏</div>
                            <div class="gen-radio-pill" data-mode="merged" onclick="genSetOutputMode('merged',this)">üìö –°–ø–æ–µ–Ω –¥–æ–∫—É–º–µ–Ω—Ç</div>
                            <div class="gen-radio-pill" data-mode="both" onclick="genSetOutputMode('both',this)">üìë+üìö –ò –¥–≤–µ—Ç–µ</div>
                        </div>
                    </div>

                    <div class="gen-separator"></div>

                    <div class="gen-row" style="margin-top: 10px;">
                        <div class="gen-field">
                            <label for="genPeriodLabel">–ü–µ—Ä–∏–æ–¥ –∑–∞ –∏–∑–≤–µ—à—Ç–∞—ò (–∑–∞ –ø–µ—Ä–∏–æ–¥–∏—á–µ–Ω)</label>
                            <input type="text" id="genPeriodLabel" value="" placeholder="–ø—Ä. –ò–∑–≤–µ—à—Ç–∞—ò 01-07.10.2025">
                        </div>
                    </div>

                    <div class="gen-separator"></div>

                    <div class="gen-toggle-row">
                        <input type="checkbox" id="genDownloadImages">
                        <label for="genDownloadImages">üñºÔ∏è –ü—Ä–µ–∑–µ–º–∏ –∏ –≤–º–µ—Ç–Ω–∏ —Å–ª–∏–∫–∏ –æ–¥ –ª–∏–Ω–∫–æ–≤–∏</label>
                    </div>
                </div>

                <!-- 4. Template Generator (compact_factory) -->
                <div class="gen-card">
                    <div class="gen-card-title"><span class="icon">üìù</span> –®–∞–±–ª–æ–Ω –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä (compact_factory.py)</div>
                    <p style="font-size: 13px; color: #718096; margin-bottom: 12px;">
                        –ö–æ—Ä–∏—Å—Ç–µ—Ç–µ –≥–æ <code>compact_factory.py</code> –∑–∞ –≥–µ–Ω–µ—Ä–∏—Ä–∞—ö–µ —Å–æ DOCX —à–∞–±–ª–æ–Ω.<br>
                        <strong>–®–∞–±–ª–æ–Ω–æ—Ç</strong> –µ –æ–±–∏—á–µ–Ω .docx —Ñ–∞—ò–ª —Å–æ –ø–ª–µ—ò—Å—Ö–æ–ª–¥–µ—Ä–∏ <code>{{firstName}}</code>, <code>{{lastName}}</code>, –∏—Ç–Ω.
                    </p>
                    <div class="gen-row">
                        <div class="gen-field">
                            <label for="genTemplatePath">–ü–∞—Ç–µ–∫–∞ –¥–æ —à–∞–±–ª–æ–Ω (.docx)</label>
                            <input type="text" id="genTemplatePath" value="template.docx" placeholder="template.docx">
                        </div>
                        <div class="gen-field">
                            <label for="genJsonPath">JSON –ø–æ–¥–∞—Ç–æ—Ü–∏</label>
                            <input type="text" id="genJsonPath" value="e_dnevnik_unified_state_v7.json" placeholder="e_dnevnik_unified_state_v7.json">
                        </div>
                    </div>
                    <div class="gen-actions" style="margin-top: 12px;">
                        <button class="gen-btn gen-btn-info" onclick="genBuildCompactCommand()">üî® –ì–µ–Ω–µ—Ä–∏—Ä–∞—ò compact –∫–æ–º–∞–Ω–¥–∞</button>
                    </div>
                </div>

                <!-- 5. Output Preview -->
                <div class="gen-card">
                    <div class="gen-card-title"><span class="icon">üëÅÔ∏è</span> –ü—Ä–µ–≥–ª–µ–¥ –Ω–∞ –∏–∑–ª–µ–∑</div>
                    <div id="genPreview" class="gen-preview">
                        <div class="gen-preview-count" id="genPreviewCount">–°–µ –≤—á–∏—Ç—É–≤–∞...</div>
                        <div id="genPreviewList"></div>
                    </div>
                </div>

                <!-- 6. Generated Command -->
                <div class="gen-card">
                    <div class="gen-card-title"><span class="icon">üíª</span> –ì–µ–Ω–µ—Ä–∏—Ä–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞</div>
                    <div class="gen-command-box" id="genCommandBox"><span class="cmd-comment"># –ò–∑–±–µ—Ä–µ—Ç–µ –æ–ø—Ü–∏–∏ –≥–æ—Ä–µ –∏ –∫–ª–∏–∫–Ω–µ—Ç–µ "–ì–µ–Ω–µ—Ä–∏—Ä–∞—ò –∫–æ–º–∞–Ω–¥–∞"</span></div>
                    <div class="gen-actions">
                        <button class="gen-btn gen-btn-primary" onclick="genBuildCommand()">üî® –ì–µ–Ω–µ—Ä–∏—Ä–∞—ò document_factory –∫–æ–º–∞–Ω–¥–∞</button>
                        <button class="gen-btn gen-btn-secondary" onclick="genCopyCommand()">üìã –ö–æ–ø–∏—Ä–∞—ò</button>
                    </div>

                    <div class="gen-separator"></div>

                    <!-- THE KEY BUTTON: saves config for LAUNCHER.bat -->
                    <div style="margin-top:5px;">
                        <div class="gen-card-title" style="margin-bottom:10px;"><span class="icon">üöÄ</span> –°—Ç–∞—Ä—Ç—É–≤–∞—ò –ø—Ä–µ–∫—É LAUNCHER.bat (–±–µ–∑ –≤–∏—Ä—É—Å –ø—Ä–µ–¥—É–ø—Ä–µ–¥—É–≤–∞—ö–∞)</div>
                        <p style="font-size:13px;color:#718096;margin-bottom:12px;">
                            –ó–∞—á—É–≤–∞—ò—Ç–µ —ò–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—ò–∞—Ç–∞ –∫–∞–∫–æ <code>gen_config.json</code> ‚Üí —Å—Ç–∞–≤–µ—Ç–µ –≥–æ –≤–æ —Ñ–æ–ª–¥–µ—Ä–æ—Ç —Å–æ —Å–∫—Ä–∏–ø—Ç–∏—Ç–µ ‚Üí –¥–≤–æ–µ–Ω-–∫–ª–∏–∫ –Ω–∞ <strong>LAUNCHER.bat</strong> (–∫–æ—ò –≤–µ—ú–µ –≥–æ –∏–º–∞—Ç–µ –æ–¥–±–ª–æ–∫–∏—Ä–∞–Ω–æ).<br>
                            Launcher-–æ—Ç –∞–≤—Ç–æ–º–∞—Ç—Å–∫–∏ —ú–µ –≥–æ –ø—Ä–æ—á–∏—Ç–∞ –∫–æ–Ω—Ñ–∏–≥–æ—Ç –∏ —ú–µ –≥–µ–Ω–µ—Ä–∏—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∏. –ù–µ–º–∞ –Ω–æ–≤–∏ .bat —Ñ–∞—ò–ª–æ–≤–∏ = –Ω–µ–º–∞ –≤–∏—Ä—É—Å –ø—Ä–µ–¥—É–ø—Ä–µ–¥—É–≤–∞—ö–∞.
                        </p>
                        <div class="gen-actions">
                            <button class="gen-btn" style="background:linear-gradient(135deg,#f6ad55,#dd6b20);color:#fff;" onclick="genSaveConfig('document_factory_v7')">
                                üíæ –ó–∞—á—É–≤–∞—ò –∫–æ–Ω—Ñ–∏–≥ ‚Üí LAUNCHER.bat (document_factory)
                            </button>
                            <button class="gen-btn" style="background:linear-gradient(135deg,#4fd1c5,#319795);color:#fff;" onclick="genSaveConfig('compact_factory')">
                                üíæ –ó–∞—á—É–≤–∞—ò –∫–æ–Ω—Ñ–∏–≥ ‚Üí LAUNCHER.bat (compact_factory)
                            </button>
                            <button class="gen-btn gen-btn-info" onclick="genDownloadJson()">üì• –ï–∫—Å–ø–æ—Ä—Ç JSON –∑–∞ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Data Tab -->
        <div id="data" class="tab-content">
            <div class="section-header">–ï–∫—Å–ø–æ—Ä—Ç / –ò–º–ø–æ—Ä—Ç</div>
            <button class="btn btn-success btn-full" onclick="exportData()">–ï–∫—Å–ø–æ—Ä—Ç–∏—Ä–∞—ò –°√® (JSON)</button>
            <button class="btn btn-primary btn-full" onclick="document.getElementById('importFile').click()">–ò–º–ø–æ—Ä—Ç–∏—Ä–∞—ò JSON</button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
            
            <div class="section-header" style="margin-top: 30px;">–ü–æ–ø—Ä–∞–≤–∫–∞ –Ω–∞ –ø–æ–¥–∞—Ç–æ—Ü–∏</div>
            <button class="btn btn-full" style="background: #f59e0b; color: white;" onclick="rebuildAllProgress()">üîÑ –†–µ–∫–æ–Ω—Å—Ç—Ä—É–∏—Ä–∞—ò –ù–∞–ø—Ä–µ–¥–æ–∫</button>
            <p style="text-align: center; color: #718096; font-size: 13px; margin-top: 10px;">
                –û–≤–∞ —ú–µ –≥–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–∞ –ø–æ–¥–∞—Ç–æ—Ü–∏—Ç–µ –∑–∞ –Ω–∞–ø—Ä–µ–¥–æ–∫ —Å–æ –ø—Ä–∏—Å—É—Ç–Ω–æ—Å—Ç–∞. –ö–æ—Ä–∏—Å—Ç–µ—Ç–µ –≥–æ –∞–∫–æ –≤–∏–¥–∏—Ç–µ –Ω–µ—Å–æ–≤–ø–∞—ì–∞—ö–µ –ø–æ–º–µ—ì—É –±—Ä–æ—ò–æ—Ç –Ω–∞ —Å–µ—Å–∏–∏ –∏ —á–µ–∫–∏—Ä–∞–Ω–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.
            </p>
        </div>
    </div>
    
    <!-- Add Student Modal -->
    <div id="addStudentModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 15px;">–î–æ–¥–∞–¥–∏ –£—á–µ–Ω–∏–∫</h2>
            <div class="form-group">
                <label>–ò–º–µ –∏ –ü—Ä–µ–∑–∏–º–µ</label>
                <input type="text" id="studentName" placeholder="–ø—Ä. –ú–∞—Ä–∏—ò–∞ –ß–∞–¥–∞–º–æ–≤–∞">
            </div>
            <div class="form-group">
                <label>–û–¥–¥–µ–ª–µ–Ω–∏–µ</label>
                <input type="text" id="studentGrade" placeholder="–ø—Ä. IV-–∞">
            </div>
            <div class="form-group">
                <label>–ü–ª–∞–Ω</label>
                <select id="studentPlan"></select>
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="studentNeedsTrijazen" style="width: 20px; height: 20px; cursor: pointer;">
                    <span>–ü–æ—Ç—Ä–µ–±–µ–Ω —Ç—Ä–∏—ò–∞–∂–µ–Ω —Ç–µ—Å—Ç</span>
                </label>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" style="flex: 1;" onclick="saveStudent()">–ó–∞—á—É–≤–∞—ò</button>
                <button class="btn" style="flex: 1; background: #718096; color: white;" onclick="closeModal('addStudentModal')">–û—Ç–∫–∞–∂–∏</button>
            </div>
        </div>
    </div>
    
    <!-- Add Plan Modal -->
    <div id="addPlanModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 15px;">–ö—Ä–µ–∏—Ä–∞—ò –ü–ª–∞–Ω</h2>
            <div class="form-group">
                <label>–ò–º–µ –Ω–∞ –ü–ª–∞–Ω</label>
                <input type="text" id="planName" placeholder="–ø—Ä. –ü–ª–∞–Ω 1">
            </div>
            <div class="form-group">
                <label>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–µ–¥–Ω–∞ –ø–æ —Ä–µ–¥)</label>
                <textarea id="planActivities" rows="10" style="width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 6px;"></textarea>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" style="flex: 1;" onclick="savePlan()">–ó–∞—á—É–≤–∞—ò</button>
                <button class="btn" style="flex: 1; background: #718096; color: white;" onclick="closeModal('addPlanModal')">–û—Ç–∫–∞–∂–∏</button>
            </div>
        </div>
    </div>
    
    <!-- Add Link Modal -->
    <div id="addLinkModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 15px;">–î–æ–¥–∞–¥–∏ –õ–∏–Ω–∫</h2>
            <div class="form-group">
                <label>–ò–º–µ –Ω–∞ –õ–∏–Ω–∫</label>
                <input type="text" id="linkName" placeholder="–ø—Ä. –î–æ–∫—É–º–µ–Ω—Ç–∏">
            </div>
            <div class="form-group">
                <label>URL –ê–¥—Ä–µ—Å–∞</label>
                <input type="text" id="linkUrl" placeholder="–ø—Ä. https://example.com">
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-success" style="flex: 1;" onclick="saveLink()">–ó–∞—á—É–≤–∞—ò</button>
                <button class="btn" style="flex: 1; background: #718096; color: white;" onclick="closeModal('addLinkModal')">–û—Ç–∫–∞–∂–∏</button>
            </div>
        </div>
    </div>
    
    <!-- Assign Modal -->
    <div id="assignModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 15px;">–î–æ–¥–µ–ª–µ—Ç–µ –£—á–µ–Ω–∏—Ü–∏</h2>
            <div id="checkboxList" class="checkbox-list"></div>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn btn-success" style="flex: 1;" onclick="assignStudents()">–ó–∞—á—É–≤–∞—ò</button>
                <button class="btn" style="flex: 1; background: #718096; color: white;" onclick="closeModal('assignModal')">–û—Ç–∫–∞–∂–∏</button>
            </div>
        </div>
    </div>
    
    <script>
        var students = [];
        var schedule = {
            monday: [[], [], [], [], []],
            tuesday: [[], [], [], [], []],
            wednesday: [[], [], [], [], []],
            thursday: [[], [], [], [], []],
            friday: [[], [], [], [], []]
        };
        var attendance = {};
        var plans = [];
        var links = [];
        var studentProgress = {};
        var scheduleHistory = {}; // Historical schedule snapshots
        window.studentRecords = window.studentRecords || []; // Imported StudentRecords payload
        window.audiogramRecords = window.audiogramRecords || []; // Imported audiogram payload
        
        var currentWeek = 0;
        var editingStudent = null;
        var editingPlan = null;
        var editingLink = null;
        var currentSlot = null;
        var isDataDirty = false;
        var checkOrder = [];
        var pastWeeksUnlocked = false;
        var undoStack = [];
        var redoStack = [];
        
        var days = ['–ü–æ–Ω', '–í—Ç–æ', '–°—Ä–µ', '–ß–µ—Ç', '–ü–µ—Ç'];
        var daysEng = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
        var timeSlots = [
            { label: 'I', time: '08:00-08:40', half1: '08:00 - 08:20', half2: '08:20 - 08:40' },
            { label: 'II', time: '08:45-09:25', half1: '08:45 - 09:05', half2: '09:05 - 09:25' },
            { label: 'III', time: '09:40-10:20', half1: '09:40 - 10:00', half2: '10:00 - 10:20' },
            { label: 'IV', time: '10:25-11:05', half1: '10:25 - 10:45', half2: '10:45 - 11:05' },
            { label: 'V', time: '11:10-11:50', half1: '11:10 - 11:30', half2: '11:30 - 11:50' }
        ];
        
        var embeddedDosieHtmlB64 = 'PCFET0NUWVBFIGh0bWw+DQo8aHRtbCBsYW5nPSJtayI+DQoNCjxoZWFkPg0KICAgIDxtZXRhIGNoYXJzZXQ9IlVURi04Ij4NCiAgICA8bWV0YSBuYW1lPSJ2aWV3cG9ydCIgY29udGVudD0id2lkdGg9ZGV2aWNlLXdpZHRoLCBpbml0aWFsLXNjYWxlPTEuMCI+DQogICAgPHRpdGxlPtCc0LXQvdCw0Z/QtdGAINC90LAg0J/QvtC00LDRgtC+0YbQuCDQt9CwINCj0YfQtdC90LjRhtC4PC90aXRsZT4NCiAgICA8c3R5bGU+DQogICAgICAgIC8qID09PT09IENTUyBWYXJpYWJsZXMgPT09PT0gKi8NCiAgICAgICAgOnJvb3Qgew0KICAgICAgICAgICAgLS1wcmltYXJ5OiAjNjY3ZWVhOw0KICAgICAgICAgICAgLS1wcmltYXJ5LWRhcms6ICM3NjRiYTI7DQogICAgICAgICAgICAtLWdyYWRpZW50OiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCB2YXIoLS1wcmltYXJ5KSwgdmFyKC0tcHJpbWFyeS1kYXJrKSk7DQogICAgICAgICAgICAtLWJnOiAjZjBmMmY1Ow0KICAgICAgICAgICAgLS1jYXJkLWJnOiAjZmZmZmZmOw0KICAgICAgICAgICAgLS10ZXh0OiAjMWMxZTIxOw0KICAgICAgICAgICAgLS10ZXh0LXNlY29uZGFyeTogIzY1Njc2YjsNCiAgICAgICAgICAgIC0tYm9yZGVyOiAjZGRkZmUyOw0KICAgICAgICAgICAgLS1pbnB1dC1iZzogI2YwZjJmNTsNCiAgICAgICAgICAgIC0tc3VjY2VzczogIzQyYjcyYTsNCiAgICAgICAgICAgIC0tZGFuZ2VyOiAjZTQxZTNmOw0KICAgICAgICAgICAgLS1ob3Zlci1iZzogI2YyZjNmNTsNCiAgICAgICAgICAgIC0tc2hhZG93OiAwIDFweCAycHggcmdiYSgwLCAwLCAwLCAwLjEpOw0KICAgICAgICAgICAgLS13YXJuaW5nOiAjZjBhZDRlOw0KICAgICAgICB9DQoNCiAgICAgICAgYm9keS5kYXJrLW1vZGUgew0KICAgICAgICAgICAgLS1iZzogIzE4MTkxYTsNCiAgICAgICAgICAgIC0tY2FyZC1iZzogIzI0MjUyNjsNCiAgICAgICAgICAgIC0tdGV4dDogI2U0ZTZlYjsNCiAgICAgICAgICAgIC0tdGV4dC1zZWNvbmRhcnk6ICNiMGIzYjg7DQogICAgICAgICAgICAtLWJvcmRlcjogIzNlNDA0MjsNCiAgICAgICAgICAgIC0taW5wdXQtYmc6ICMzYTNiM2M7DQogICAgICAgICAgICAtLWhvdmVyLWJnOiAjM2EzYjNjOw0KICAgICAgICAgICAgLS1zaGFkb3c6IDAgMXB4IDJweCByZ2JhKDAsIDAsIDAsIDAuMyk7DQogICAgICAgIH0NCg0KICAgICAgICAvKiA9PT09PSBSZXNldCAmIEJhc2UgPT09PT0gKi8NCiAgICAgICAgKiwNCiAgICAgICAgKjo6YmVmb3JlLA0KICAgICAgICAqOjphZnRlciB7DQogICAgICAgICAgICBtYXJnaW46IDA7DQogICAgICAgICAgICBwYWRkaW5nOiAwOw0KICAgICAgICAgICAgYm94LXNpemluZzogYm9yZGVyLWJveDsNCiAgICAgICAgfQ0KDQogICAgICAgIGJvZHkgew0KICAgICAgICAgICAgZm9udC1mYW1pbHk6IC1hcHBsZS1zeXN0ZW0sIEJsaW5rTWFjU3lzdGVtRm9udCwgJ1NlZ29lIFVJJywgUm9ib3RvLCBBcmlhbCwgc2Fucy1zZXJpZjsNCiAgICAgICAgICAgIGJhY2tncm91bmQ6IHZhcigtLWJnKTsNCiAgICAgICAgICAgIGNvbG9yOiB2YXIoLS10ZXh0KTsNCiAgICAgICAgICAgIGxpbmUtaGVpZ2h0OiAxLjU7DQogICAgICAgICAgICBtaW4taGVpZ2h0OiAxMDB2aDsNCiAgICAgICAgfQ0KDQogICAgICAgIC8qID09PT09IFRvb2xiYXIgPT09PT0gKi8NCiAgICAgICAgLnRvb2xiYXIgew0KICAgICAgICAgICAgcG9zaXRpb246IHN0aWNreTsNCiAgICAgICAgICAgIHRvcDogMDsNCiAgICAgICAgICAgIHotaW5kZXg6IDEwMDsNCiAgICAgICAgICAgIGJhY2tncm91bmQ6IHZhcigtLWdyYWRpZW50KTsNCiAgICAgICAgICAgIGNvbG9yOiAjZmZmOw0KICAgICAgICAgICAgcGFkZGluZzogMTBweCAyMHB4Ow0KICAgICAgICAgICAgZGlzcGxheTogZmxleDsNCiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7DQogICAgICAgICAgICBmbGV4LXdyYXA6IHdyYXA7DQogICAgICAgICAgICBnYXA6IDhweDsNCiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgMnB4IDhweCByZ2JhKDAsIDAsIDAsIDAuMjUpOw0KICAgICAgICB9DQoNCiAgICAgICAgLnRvb2xiYXIgaDEgew0KICAgICAgICAgICAgZm9udC1zaXplOiAxLjE1ZW07DQogICAgICAgICAgICBmb250LXdlaWdodDogNzAwOw0KICAgICAgICAgICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsNCiAgICAgICAgfQ0KDQogICAgICAgIC50b29sYmFyLXNwYWNlciB7DQogICAgICAgICAgICBmbGV4OiAxOw0KICAgICAgICB9DQoNCiAgICAgICAgLnRvb2xiYXItZ3JvdXAgew0KICAgICAgICAgICAgZGlzcGxheTogZmxleDsNCiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7DQogICAgICAgICAgICBnYXA6IDZweDsNCiAgICAgICAgICAgIGZsZXgtd3JhcDogd3JhcDsNCiAgICAgICAgfQ0KDQogICAgICAgIC8qID09PT09IEJ1dHRvbnMgPT09PT0gKi8NCiAgICAgICAgLmJ0biB7DQogICAgICAgICAgICBkaXNwbGF5OiBpbmxpbmUtZmxleDsNCiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7DQogICAgICAgICAgICBnYXA6IDRweDsNCiAgICAgICAgICAgIHBhZGRpbmc6IDZweCAxMnB4Ow0KICAgICAgICAgICAgYm9yZGVyOiBub25lOw0KICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNnB4Ow0KICAgICAgICAgICAgZm9udC1zaXplOiAxMnB4Ow0KICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDYwMDsNCiAgICAgICAgICAgIGN1cnNvcjogcG9pbnRlcjsNCiAgICAgICAgICAgIHdoaXRlLXNwYWNlOiBub3dyYXA7DQogICAgICAgICAgICB0cmFuc2l0aW9uOiBmaWx0ZXIgMC4xNXMsIHRyYW5zZm9ybSAwLjFzOw0KICAgICAgICB9DQoNCiAgICAgICAgLmJ0bjpob3ZlciB7DQogICAgICAgICAgICBmaWx0ZXI6IGJyaWdodG5lc3MoMC45KTsNCiAgICAgICAgfQ0KDQogICAgICAgIC5idG46YWN0aXZlIHsNCiAgICAgICAgICAgIHRyYW5zZm9ybTogc2NhbGUoMC45Nyk7DQogICAgICAgIH0NCg0KICAgICAgICAuYnRuLXdoaXRlIHsNCiAgICAgICAgICAgIGJhY2tncm91bmQ6IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC45Mik7DQogICAgICAgICAgICBjb2xvcjogIzMzMzsNCiAgICAgICAgfQ0KDQogICAgICAgIC5idG4tZ3JlZW4gew0KICAgICAgICAgICAgYmFja2dyb3VuZDogdmFyKC0tc3VjY2Vzcyk7DQogICAgICAgICAgICBjb2xvcjogI2ZmZjsNCiAgICAgICAgfQ0KDQogICAgICAgIC5idG4tZGFuZ2VyIHsNCiAgICAgICAgICAgIGJhY2tncm91bmQ6IHZhcigtLWRhbmdlcik7DQogICAgICAgICAgICBjb2xvcjogI2ZmZjsNCiAgICAgICAgfQ0KDQogICAgICAgIC5idG4td2FybmluZyB7DQogICAgICAgICAgICBiYWNrZ3JvdW5kOiB2YXIoLS13YXJuaW5nKTsNCiAgICAgICAgICAgIGNvbG9yOiAjZmZmOw0KICAgICAgICB9DQoNCiAgICAgICAgLmJ0bi1vdXRsaW5lIHsNCiAgICAgICAgICAgIGJhY2tncm91bmQ6IHRyYW5zcGFyZW50Ow0KICAgICAgICAgICAgY29sb3I6ICNmZmY7DQogICAgICAgICAgICBib3JkZXI6IDEuNXB4IHNvbGlkIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC41KTsNCiAgICAgICAgfQ0KDQogICAgICAgIC8qIE1vZGUgaW5kaWNhdG9yICovDQogICAgICAgIC5tb2RlLWluZGljYXRvciB7DQogICAgICAgICAgICBkaXNwbGF5OiBpbmxpbmUtZmxleDsNCiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7DQogICAgICAgICAgICBnYXA6IDVweDsNCiAgICAgICAgICAgIHBhZGRpbmc6IDVweCAxMnB4Ow0KICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMjBweDsNCiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTJweDsNCiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA3MDA7DQogICAgICAgIH0NCg0KICAgICAgICAubW9kZS1pbmRpY2F0b3IubW9kZS12aWV3IHsNCiAgICAgICAgICAgIGJhY2tncm91bmQ6IHJnYmEoNjYsIDE4MywgNDIsIDAuMyk7DQogICAgICAgICAgICBjb2xvcjogI2E4ZmZhYTsNCiAgICAgICAgfQ0KDQogICAgICAgIC5tb2RlLWluZGljYXRvci5tb2RlLWVkaXQgew0KICAgICAgICAgICAgYmFja2dyb3VuZDogcmdiYSgyNDAsIDE3MywgNzgsIDAuMyk7DQogICAgICAgICAgICBjb2xvcjogI2ZmZTBhMDsNCiAgICAgICAgfQ0KDQogICAgICAgIC8qIFZpZXcgcGlsbHMgKi8NCiAgICAgICAgLnZpZXctcGlsbHMgew0KICAgICAgICAgICAgZGlzcGxheTogZmxleDsNCiAgICAgICAgICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC4yKTsNCiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDZweDsNCiAgICAgICAgICAgIHBhZGRpbmc6IDNweDsNCiAgICAgICAgfQ0KDQogICAgICAgIC52aWV3LXBpbGwgew0KICAgICAgICAgICAgYmFja2dyb3VuZDogdHJhbnNwYXJlbnQ7DQogICAgICAgICAgICBib3JkZXI6IG5vbmU7DQogICAgICAgICAgICBjb2xvcjogcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjYpOw0KICAgICAgICAgICAgcGFkZGluZzogNXB4IDEycHg7DQogICAgICAgICAgICBjdXJzb3I6IHBvaW50ZXI7DQogICAgICAgICAgICBmb250LXdlaWdodDogNjAwOw0KICAgICAgICAgICAgZm9udC1zaXplOiAxMnB4Ow0KICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNHB4Ow0KICAgICAgICAgICAgdHJhbnNpdGlvbjogMC4yczsNCiAgICAgICAgfQ0KDQogICAgICAgIC52aWV3LXBpbGwuYWN0aXZlIHsNCiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNmZmY7DQogICAgICAgICAgICBjb2xvcjogdmFyKC0tcHJpbWFyeSk7DQogICAgICAgIH0NCg0KICAgICAgICAvKiBTZWFyY2ggKi8NCiAgICAgICAgLnNlYXJjaC1pbnB1dCB7DQogICAgICAgICAgICBwYWRkaW5nOiA2cHggMTJweDsNCiAgICAgICAgICAgIGJvcmRlcjogbm9uZTsNCiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDIwcHg7DQogICAgICAgICAgICBmb250LXNpemU6IDEzcHg7DQogICAgICAgICAgICBiYWNrZ3JvdW5kOiByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuOSk7DQogICAgICAgICAgICBjb2xvcjogIzMzMzsNCiAgICAgICAgICAgIHdpZHRoOiAxNzBweDsNCiAgICAgICAgICAgIG91dGxpbmU6IG5vbmU7DQogICAgICAgIH0NCg0KICAgICAgICAuc2VhcmNoLWlucHV0OjpwbGFjZWhvbGRlciB7DQogICAgICAgICAgICBjb2xvcjogIzk5OTsNCiAgICAgICAgfQ0KDQogICAgICAgIC8qIFNlYXJjaCBoaWdobGlnaHQgKi8NCiAgICAgICAgbWFyayB7DQogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZmZmM2NkOw0KICAgICAgICAgICAgY29sb3I6ICM4NTY0MDQ7DQogICAgICAgICAgICBwYWRkaW5nOiAwIDJweDsNCiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDJweDsNCiAgICAgICAgfQ0KDQogICAgICAgIGJvZHkuZGFyay1tb2RlIG1hcmsgew0KICAgICAgICAgICAgYmFja2dyb3VuZDogIzVhNGUxYTsNCiAgICAgICAgICAgIGNvbG9yOiAjZmZlNjljOw0KICAgICAgICB9DQoNCiAgICAgICAgLyogPT09PT0gTWFpbiBDb250ZW50ID09PT09ICovDQogICAgICAgIC5tYWluIHsNCiAgICAgICAgICAgIG1heC13aWR0aDogOTYwcHg7DQogICAgICAgICAgICBtYXJnaW46IDE2cHggYXV0bzsNCiAgICAgICAgICAgIHBhZGRpbmc6IDAgMTZweDsNCiAgICAgICAgfQ0KDQogICAgICAgIC5tYWluLmZ1bGwtd2lkdGggew0KICAgICAgICAgICAgbWF4LXdpZHRoOiAxMDAlOw0KICAgICAgICB9DQoNCiAgICAgICAgLmVtcHR5LXN0YXRlIHsNCiAgICAgICAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsNCiAgICAgICAgICAgIHBhZGRpbmc6IDYwcHggMjBweDsNCiAgICAgICAgICAgIGNvbG9yOiB2YXIoLS10ZXh0LXNlY29uZGFyeSk7DQogICAgICAgICAgICBmb250LXNpemU6IDE1cHg7DQogICAgICAgIH0NCg0KICAgICAgICAvKiA9PT09PSBMaXN0IC8gQWNjb3JkaW9uIFZpZXcgPT09PT0gKi8NCiAgICAgICAgLmNhcmQgew0KICAgICAgICAgICAgYmFja2dyb3VuZDogdmFyKC0tY2FyZC1iZyk7DQogICAgICAgICAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1ib3JkZXIpOw0KICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogOHB4Ow0KICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogOHB4Ow0KICAgICAgICAgICAgYm94LXNoYWRvdzogdmFyKC0tc2hhZG93KTsNCiAgICAgICAgICAgIG92ZXJmbG93OiBoaWRkZW47DQogICAgICAgIH0NCg0KICAgICAgICAuY2FyZC1oZWFkZXIgew0KICAgICAgICAgICAgcGFkZGluZzogMTJweCAxNnB4Ow0KICAgICAgICAgICAgZGlzcGxheTogZmxleDsNCiAgICAgICAgICAgIGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjsNCiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7DQogICAgICAgICAgICBjdXJzb3I6IHBvaW50ZXI7DQogICAgICAgICAgICB1c2VyLXNlbGVjdDogbm9uZTsNCiAgICAgICAgfQ0KDQogICAgICAgIC5jYXJkLWhlYWRlcjpob3ZlciB7DQogICAgICAgICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1ob3Zlci1iZyk7DQogICAgICAgIH0NCg0KICAgICAgICAuY2FyZC1oZWFkZXIgc3Ryb25nIHsNCiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTRweDsNCiAgICAgICAgfQ0KDQogICAgICAgIC5jYXJkLWhlYWRlciAuYmFkZ2Ugew0KICAgICAgICAgICAgYmFja2dyb3VuZDogdmFyKC0taW5wdXQtYmcpOw0KICAgICAgICAgICAgcGFkZGluZzogMnB4IDEwcHg7DQogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAxMnB4Ow0KICAgICAgICAgICAgZm9udC1zaXplOiAxMXB4Ow0KICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDYwMDsNCiAgICAgICAgICAgIGNvbG9yOiB2YXIoLS10ZXh0LXNlY29uZGFyeSk7DQogICAgICAgIH0NCg0KICAgICAgICAuY2FyZC1ib2R5IHsNCiAgICAgICAgICAgIGRpc3BsYXk6IG5vbmU7DQogICAgICAgICAgICBwYWRkaW5nOiAxNnB4Ow0KICAgICAgICAgICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHZhcigtLWJvcmRlcik7DQogICAgICAgIH0NCg0KICAgICAgICAuY2FyZC1ib2R5Lm9wZW4gew0KICAgICAgICAgICAgZGlzcGxheTogYmxvY2s7DQogICAgICAgIH0NCg0KICAgICAgICAuZm9ybS1ncmlkIHsNCiAgICAgICAgICAgIGRpc3BsYXk6IGdyaWQ7DQogICAgICAgICAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDFmciAxZnI7DQogICAgICAgICAgICBnYXA6IDEwcHg7DQogICAgICAgIH0NCg0KICAgICAgICAuZm9ybS1ncmlkIC5zcGFuLTIgew0KICAgICAgICAgICAgZ3JpZC1jb2x1bW46IHNwYW4gMjsNCiAgICAgICAgfQ0KDQogICAgICAgIC5mb3JtLWxhYmVsIHsNCiAgICAgICAgICAgIGRpc3BsYXk6IGJsb2NrOw0KICAgICAgICAgICAgZm9udC1zaXplOiAxMXB4Ow0KICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDYwMDsNCiAgICAgICAgICAgIGNvbG9yOiB2YXIoLS10ZXh0LXNlY29uZGFyeSk7DQogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAzcHg7DQogICAgICAgICAgICB0ZXh0LXRyYW5zZm9ybTogdXBwZXJjYXNlOw0KICAgICAgICAgICAgbGV0dGVyLXNwYWNpbmc6IDAuM3B4Ow0KICAgICAgICB9DQoNCiAgICAgICAgLyogPT09PT0gSW5wdXQgRmllbGRzID09PT09ICovDQogICAgICAgIC5maWVsZCB7DQogICAgICAgICAgICBmb250LWZhbWlseTogIlRpbWVzIE5ldyBSb21hbiIsIFRpbWVzLCBzZXJpZjsNCiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTVweDsNCiAgICAgICAgICAgIHdpZHRoOiAxMDAlOw0KICAgICAgICAgICAgcGFkZGluZzogNnB4IDhweDsNCiAgICAgICAgICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWJvcmRlcik7DQogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA0cHg7DQogICAgICAgICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1pbnB1dC1iZyk7DQogICAgICAgICAgICBjb2xvcjogdmFyKC0tdGV4dCk7DQogICAgICAgICAgICBvdXRsaW5lOiBub25lOw0KICAgICAgICAgICAgdHJhbnNpdGlvbjogYm9yZGVyLWNvbG9yIDAuMnM7DQogICAgICAgIH0NCg0KICAgICAgICAuZmllbGQ6Zm9jdXMgew0KICAgICAgICAgICAgYm9yZGVyLWNvbG9yOiB2YXIoLS1wcmltYXJ5KTsNCiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgMCAwIDJweCByZ2JhKDEwMiwgMTI2LCAyMzQsIDAuMTUpOw0KICAgICAgICB9DQoNCiAgICAgICAgdGV4dGFyZWEuZmllbGQgew0KICAgICAgICAgICAgcmVzaXplOiB2ZXJ0aWNhbDsNCiAgICAgICAgICAgIG1pbi1oZWlnaHQ6IDM2cHg7DQogICAgICAgICAgICBtYXgtaGVpZ2h0OiA0MDBweDsNCiAgICAgICAgICAgIG92ZXJmbG93OiBhdXRvOw0KICAgICAgICB9DQoNCiAgICAgICAgLyogPT09PT0gVGFibGUgVmlldyA9PT09PSAqLw0KICAgICAgICAudGFibGUtd3JhcCB7DQogICAgICAgICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1jYXJkLWJnKTsNCiAgICAgICAgICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWJvcmRlcik7DQogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA4cHg7DQogICAgICAgICAgICBib3gtc2hhZG93OiB2YXIoLS1zaGFkb3cpOw0KICAgICAgICAgICAgb3ZlcmZsb3cteDogYXV0bzsNCiAgICAgICAgfQ0KDQogICAgICAgIC5kYXRhLXRhYmxlIHsNCiAgICAgICAgICAgIHdpZHRoOiAxMDAlOw0KICAgICAgICAgICAgYm9yZGVyLWNvbGxhcHNlOiBjb2xsYXBzZTsNCiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTNweDsNCiAgICAgICAgICAgIHRhYmxlLWxheW91dDogZml4ZWQ7DQogICAgICAgIH0NCg0KICAgICAgICAuZGF0YS10YWJsZSB0aCB7DQogICAgICAgICAgICBwb3NpdGlvbjogc3RpY2t5Ow0KICAgICAgICAgICAgdG9wOiAwOw0KICAgICAgICAgICAgYmFja2dyb3VuZDogdmFyKC0tY2FyZC1iZyk7DQogICAgICAgICAgICBjb2xvcjogdmFyKC0tdGV4dC1zZWNvbmRhcnkpOw0KICAgICAgICAgICAgZm9udC1zaXplOiAxMXB4Ow0KICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDcwMDsNCiAgICAgICAgICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7DQogICAgICAgICAgICBsZXR0ZXItc3BhY2luZzogMC41cHg7DQogICAgICAgICAgICBwYWRkaW5nOiA4cHggNnB4Ow0KICAgICAgICAgICAgdGV4dC1hbGlnbjogbGVmdDsNCiAgICAgICAgICAgIGJvcmRlci1ib3R0b206IDJweCBzb2xpZCB2YXIoLS1ib3JkZXIpOw0KICAgICAgICAgICAgd2hpdGUtc3BhY2U6IG5vd3JhcDsNCiAgICAgICAgfQ0KDQogICAgICAgIC5kYXRhLXRhYmxlIHRkIHsNCiAgICAgICAgICAgIHBhZGRpbmc6IDZweDsNCiAgICAgICAgICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCB2YXIoLS1ib3JkZXIpOw0KICAgICAgICAgICAgdmVydGljYWwtYWxpZ246IHRvcDsNCiAgICAgICAgICAgIHdvcmQtd3JhcDogYnJlYWstd29yZDsNCiAgICAgICAgICAgIG92ZXJmbG93LXdyYXA6IGJyZWFrLXdvcmQ7DQogICAgICAgIH0NCg0KICAgICAgICAuZGF0YS10YWJsZSB0Ym9keSB0cjpob3ZlciB0ZCB7DQogICAgICAgICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1ob3Zlci1iZyk7DQogICAgICAgIH0NCg0KICAgICAgICAvKiBDb2x1bW4gd2lkdGhzIChXb3JkLXN0eWxlOiBmaXhlZCBwcm9wb3J0aW9uYWwpICovDQogICAgICAgIC5kYXRhLXRhYmxlIC5jb2wtYWN0IHsNCiAgICAgICAgICAgIHdpZHRoOiAzNnB4Ow0KICAgICAgICB9DQoNCiAgICAgICAgLmRhdGEtdGFibGUgLmNvbC1uYW1lIHsNCiAgICAgICAgICAgIHdpZHRoOiAxMiU7DQogICAgICAgIH0NCg0KICAgICAgICAuZGF0YS10YWJsZSAuY29sLWdyYWRlIHsNCiAgICAgICAgICAgIHdpZHRoOiA1JTsNCiAgICAgICAgfQ0KDQogICAgICAgIC5kYXRhLXRhYmxlIC5jb2wtZGF0ZSB7DQogICAgICAgICAgICB3aWR0aDogOSU7DQogICAgICAgIH0NCg0KICAgICAgICAuZGF0YS10YWJsZSAuY29sLXBhcmVudHMgew0KICAgICAgICAgICAgd2lkdGg6IDEyJTsNCiAgICAgICAgfQ0KDQogICAgICAgIC5kYXRhLXRhYmxlIC5jb2wtY29udGFjdCB7DQogICAgICAgICAgICB3aWR0aDogMTIlOw0KICAgICAgICB9DQoNCiAgICAgICAgLmRhdGEtdGFibGUgLmNvbC1maW5kaW5ncyB7DQogICAgICAgICAgICB3aWR0aDogMjAlOw0KICAgICAgICB9DQoNCiAgICAgICAgLmRhdGEtdGFibGUgLmNvbC1vcGluaW9uIHsNCiAgICAgICAgICAgIHdpZHRoOiAyMCU7DQogICAgICAgIH0NCg0KICAgICAgICAuZGF0YS10YWJsZSAuY29sLWF0dGFjaCB7DQogICAgICAgICAgICB3aWR0aDogOCU7DQogICAgICAgIH0NCg0KICAgICAgICAvKiBUYWJsZSBpbnB1dHMgKi8NCiAgICAgICAgLmRhdGEtdGFibGUgLmZpZWxkIHsNCiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTNweDsNCiAgICAgICAgICAgIHBhZGRpbmc6IDRweCA2cHg7DQogICAgICAgICAgICB3aWR0aDogMTAwJTsNCiAgICAgICAgfQ0KDQogICAgICAgIC5kYXRhLXRhYmxlIHRleHRhcmVhLmZpZWxkIHsNCiAgICAgICAgICAgIG1pbi1oZWlnaHQ6IDI4cHg7DQogICAgICAgICAgICBtYXgtaGVpZ2h0OiAyMDBweDsNCiAgICAgICAgfQ0KDQogICAgICAgIC8qIFRBQkxFIFZJRVcgTU9ERSAqLw0KICAgICAgICAuZGF0YS10YWJsZSAuY2VsbC10ZXh0IHsNCiAgICAgICAgICAgIGZvbnQtZmFtaWx5OiAiVGltZXMgTmV3IFJvbWFuIiwgVGltZXMsIHNlcmlmOw0KICAgICAgICAgICAgZm9udC1zaXplOiAxM3B4Ow0KICAgICAgICAgICAgbGluZS1oZWlnaHQ6IDEuNDsNCiAgICAgICAgICAgIHBhZGRpbmc6IDRweCAycHg7DQogICAgICAgICAgICB3b3JkLXdyYXA6IGJyZWFrLXdvcmQ7DQogICAgICAgICAgICBvdmVyZmxvdy13cmFwOiBicmVhay13b3JkOw0KICAgICAgICAgICAgd2hpdGUtc3BhY2U6IHByZS13cmFwOw0KICAgICAgICB9DQoNCiAgICAgICAgLmRlbC1idG4gew0KICAgICAgICAgICAgYmFja2dyb3VuZDogbm9uZTsNCiAgICAgICAgICAgIGJvcmRlcjogbm9uZTsNCiAgICAgICAgICAgIGNvbG9yOiB2YXIoLS1kYW5nZXIpOw0KICAgICAgICAgICAgZm9udC1zaXplOiAxNXB4Ow0KICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDcwMDsNCiAgICAgICAgICAgIGN1cnNvcjogcG9pbnRlcjsNCiAgICAgICAgICAgIHBhZGRpbmc6IDJweCA2cHg7DQogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA0cHg7DQogICAgICAgIH0NCg0KICAgICAgICAuZGVsLWJ0bjpob3ZlciB7DQogICAgICAgICAgICBiYWNrZ3JvdW5kOiByZ2JhKDIyOCwgMzAsIDYzLCAwLjEpOw0KICAgICAgICB9DQoNCiAgICAgICAgLyogPT09PT0gSW1hZ2UgVGh1bWJzID09PT09ICovDQogICAgICAgIC50aHVtYi1yb3cgew0KICAgICAgICAgICAgZGlzcGxheTogZmxleDsNCiAgICAgICAgICAgIGdhcDogM3B4Ow0KICAgICAgICAgICAgZmxleC13cmFwOiB3cmFwOw0KICAgICAgICB9DQoNCiAgICAgICAgLnRodW1iLWltZyB7DQogICAgICAgICAgICB3aWR0aDogMzZweDsNCiAgICAgICAgICAgIGhlaWdodDogMzZweDsNCiAgICAgICAgICAgIG9iamVjdC1maXQ6IGNvdmVyOw0KICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogM3B4Ow0KICAgICAgICAgICAgY3Vyc29yOiBwb2ludGVyOw0KICAgICAgICAgICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tYm9yZGVyKTsNCiAgICAgICAgICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAwLjE1czsNCiAgICAgICAgfQ0KDQogICAgICAgIC50aHVtYi1pbWc6aG92ZXIgew0KICAgICAgICAgICAgdHJhbnNmb3JtOiBzY2FsZSgxLjIpOw0KICAgICAgICB9DQoNCiAgICAgICAgLmFkZC1pbWctbGFiZWwgew0KICAgICAgICAgICAgZm9udC1zaXplOiAxMXB4Ow0KICAgICAgICAgICAgY29sb3I6IHZhcigtLXByaW1hcnkpOw0KICAgICAgICAgICAgY3Vyc29yOiBwb2ludGVyOw0KICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDYwMDsNCiAgICAgICAgfQ0KDQogICAgICAgIC5hZGQtaW1nLWxhYmVsOmhvdmVyIHsNCiAgICAgICAgICAgIHRleHQtZGVjb3JhdGlvbjogdW5kZXJsaW5lOw0KICAgICAgICB9DQoNCiAgICAgICAgLyogPT09PT0gSW1hZ2UgTW9kYWwgPT09PT0gKi8NCiAgICAgICAgLm1vZGFsLW92ZXJsYXkgew0KICAgICAgICAgICAgZGlzcGxheTogbm9uZTsNCiAgICAgICAgICAgIHBvc2l0aW9uOiBmaXhlZDsNCiAgICAgICAgICAgIGluc2V0OiAwOw0KICAgICAgICAgICAgei1pbmRleDogMTAwMDsNCiAgICAgICAgICAgIGJhY2tncm91bmQ6IHJnYmEoMCwgMCwgMCwgMC45Mik7DQogICAgICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOw0KICAgICAgICAgICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7DQogICAgICAgICAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOw0KICAgICAgICB9DQoNCiAgICAgICAgLm1vZGFsLW92ZXJsYXkub3BlbiB7DQogICAgICAgICAgICBkaXNwbGF5OiBmbGV4Ow0KICAgICAgICB9DQoNCiAgICAgICAgLm1vZGFsLW92ZXJsYXkgaW1nIHsNCiAgICAgICAgICAgIG1heC13aWR0aDogOTAlOw0KICAgICAgICAgICAgbWF4LWhlaWdodDogODV2aDsNCiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDZweDsNCiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgMCAzMHB4IHJnYmEoMCwgMCwgMCwgMC41KTsNCiAgICAgICAgfQ0KDQogICAgICAgIC5tb2RhbC1jbG9zZSB7DQogICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7DQogICAgICAgICAgICB0b3A6IDE2cHg7DQogICAgICAgICAgICByaWdodDogMjRweDsNCiAgICAgICAgICAgIGNvbG9yOiAjZmZmOw0KICAgICAgICAgICAgZm9udC1zaXplOiAzNnB4Ow0KICAgICAgICAgICAgY3Vyc29yOiBwb2ludGVyOw0KICAgICAgICB9DQoNCiAgICAgICAgLm1vZGFsLWhpbnQgew0KICAgICAgICAgICAgY29sb3I6IHJnYmEoMjU1LCAyNTUsIDI1NSwgMC41KTsNCiAgICAgICAgICAgIG1hcmdpbi10b3A6IDEwcHg7DQogICAgICAgICAgICBmb250LXNpemU6IDEzcHg7DQogICAgICAgIH0NCg0KICAgICAgICAvKiA9PT09PSBSZXNwb25zaXZlID09PT09ICovDQogICAgICAgIEBtZWRpYSAobWF4LXdpZHRoOiA3MDBweCkgew0KICAgICAgICAgICAgLnRvb2xiYXIgew0KICAgICAgICAgICAgICAgIHBhZGRpbmc6IDhweCAxMHB4Ow0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAudG9vbGJhciBoMSB7DQogICAgICAgICAgICAgICAgZm9udC1zaXplOiAxZW07DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIC5mb3JtLWdyaWQgew0KICAgICAgICAgICAgICAgIGdyaWQtdGVtcGxhdGUtY29sdW1uczogMWZyOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAuZm9ybS1ncmlkIC5zcGFuLTIgew0KICAgICAgICAgICAgICAgIGdyaWQtY29sdW1uOiBzcGFuIDE7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIC5tYWluIHsNCiAgICAgICAgICAgICAgICBwYWRkaW5nOiAwIDhweDsNCiAgICAgICAgICAgICAgICBtYXJnaW46IDEwcHggYXV0bzsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgLnNlYXJjaC1pbnB1dCB7DQogICAgICAgICAgICAgICAgd2lkdGg6IDEyMHB4Ow0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAuZGF0YS10YWJsZSB7DQogICAgICAgICAgICAgICAgdGFibGUtbGF5b3V0OiBhdXRvOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgPC9zdHlsZT4NCjwvaGVhZD4NCg0KPGJvZHk+DQoNCiAgICA8IS0tID09PT09IFRPT0xCQVIgPT09PT0gLS0+DQogICAgPGRpdiBjbGFzcz0idG9vbGJhciI+DQogICAgICAgIDxoMT7wn5OCINCc0LXQvdCw0Z/QtdGAINC90LAg0J/QvtC00LDRgtC+0YbQuDwvaDE+DQoNCiAgICAgICAgPGRpdiBjbGFzcz0idmlldy1waWxscyI+DQogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJ2aWV3LXBpbGwgYWN0aXZlIiBpZD0iYnRuTGlzdCIgb25jbGljaz0iYXBwLnN3aXRjaFZpZXcoJ2xpc3QnKSI+8J+TiyDQm9C40YHRgtCwPC9idXR0b24+DQogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJ2aWV3LXBpbGwiIGlkPSJidG5UYWJsZSIgb25jbGljaz0iYXBwLnN3aXRjaFZpZXcoJ3RhYmxlJykiPvCfk4og0KLQsNCx0LXQu9CwPC9idXR0b24+DQogICAgICAgIDwvZGl2Pg0KDQogICAgICAgIDxkaXYgY2xhc3M9InRvb2xiYXItc3BhY2VyIj48L2Rpdj4NCg0KICAgICAgICA8ZGl2IGNsYXNzPSJ0b29sYmFyLWdyb3VwIj4NCiAgICAgICAgICAgIDwhLS0gTW9kZSB0b2dnbGUgKG9ubHkgaW4gdGFibGUgdmlldykgLS0+DQogICAgICAgICAgICA8c3BhbiBjbGFzcz0ibW9kZS1pbmRpY2F0b3IgbW9kZS12aWV3IiBpZD0ibW9kZUxhYmVsIiBzdHlsZT0iZGlzcGxheTpub25lOyI+8J+RgSDQn9GA0LXQs9C70LXQtDwvc3Bhbj4NCiAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBidG4tb3V0bGluZSIgaWQ9Im1vZGVUb2dnbGVCdG4iIHN0eWxlPSJkaXNwbGF5Om5vbmU7IiBvbmNsaWNrPSJhcHAudG9nZ2xlTW9kZSgpIj7inI/vuI8NCiAgICAgICAgICAgICAgICDQn9GA0L7QvNC10L3QuDwvYnV0dG9uPg0KDQogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXdoaXRlIiBpZD0iZGFya01vZGVCdG4iIG9uY2xpY2s9ImFwcC50b2dnbGVEYXJrKCkiPvCfjJkg0KLQtdC80L3QvjwvYnV0dG9uPg0KDQogICAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgY2xhc3M9InNlYXJjaC1pbnB1dCIgaWQ9InNlYXJjaElucHV0IiBwbGFjZWhvbGRlcj0i8J+UjSDQn9GA0LXQsdCw0YDQsNGYLi4uIg0KICAgICAgICAgICAgICAgIG9uaW5wdXQ9ImFwcC5yZW5kZXIoKSI+DQoNCiAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBidG4td2hpdGUiIG9uY2xpY2s9ImRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmaWxlSW5wdXQnKS5jbGljaygpIj7wn5OlINCj0LLQtdC30Lg8L2J1dHRvbj4NCiAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBidG4td2hpdGUiIG9uY2xpY2s9ImFwcC5leHBvcnREYXRhKCkiPvCfk6Qg0JjQt9Cy0LXQt9C4PC9idXR0b24+DQogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLWdyZWVuIiBvbmNsaWNrPSJhcHAuYWRkU3R1ZGVudCgpIj4rINCd0L7QsjwvYnV0dG9uPg0KICAgICAgICA8L2Rpdj4NCiAgICA8L2Rpdj4NCg0KICAgIDwhLS0gPT09PT0gTUFJTiBDT05URU5UID09PT09IC0tPg0KICAgIDxkaXYgY2xhc3M9Im1haW4iIGlkPSJtYWluQ29udGFpbmVyIj4NCiAgICAgICAgPGRpdiBpZD0iY29udGVudEFyZWEiPjwvZGl2Pg0KICAgIDwvZGl2Pg0KDQogICAgPCEtLSA9PT09PSBJTUFHRSBNT0RBTCA9PT09PSAtLT4NCiAgICA8ZGl2IGNsYXNzPSJtb2RhbC1vdmVybGF5IiBpZD0iaW1hZ2VNb2RhbCIgb25jbGljaz0iYXBwLmNsb3NlTW9kYWwoKSI+DQogICAgICAgIDxzcGFuIGNsYXNzPSJtb2RhbC1jbG9zZSI+JnRpbWVzOzwvc3Bhbj4NCiAgICAgICAgPGltZyBpZD0ibW9kYWxJbWciIHNyYz0iIiBhbHQ9ItCf0YDQtdCz0LvQtdC0Ij4NCiAgICAgICAgPGRpdiBjbGFzcz0ibW9kYWwtaGludCI+0JrQu9C40LrQvdC10YLQtSDQutCw0LTQtSDQsdC40LvQviDQt9CwINC30LDRgtCy0L7RgNCw0ZrQtTwvZGl2Pg0KICAgIDwvZGl2Pg0KDQogICAgPGlucHV0IHR5cGU9ImZpbGUiIGlkPSJmaWxlSW5wdXQiIGhpZGRlbiBhY2NlcHQ9Ii5qc29uIiBvbmNoYW5nZT0iYXBwLmltcG9ydERhdGEodGhpcykiPg0KDQogICAgPHNjcmlwdD4NCiAgICAgICAgY2xhc3MgU3R1ZGVudE1hbmFnZXIgew0KICAgICAgICAgICAgY29uc3RydWN0b3IoKSB7DQogICAgICAgICAgICAgICAgdGhpcy5TVE9SQUdFX0tFWSA9ICdzdHVkZW50X2RiX3RlbXAnOw0KICAgICAgICAgICAgICAgIHRoaXMuc3R1ZGVudHMgPSBbXTsNCiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRWaWV3ID0gJ2xpc3QnOyAgIC8vICdsaXN0JyBvciAndGFibGUnDQogICAgICAgICAgICAgICAgdGhpcy5lZGl0TW9kZSA9IGZhbHNlOyAgICAgICAvLyBmYWxzZSA9IFZpZXcgbW9kZSwgdHJ1ZSA9IEVkaXQgbW9kZQ0KICAgICAgICAgICAgICAgIHRoaXMubG9hZCgpOw0KICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyKCk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIC8vIOKUgOKUgCBQZXJzaXN0ZW5jZSDilIDilIANCiAgICAgICAgICAgIGxvYWQoKSB7DQogICAgICAgICAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmF3ID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0odGhpcy5TVE9SQUdFX0tFWSk7DQogICAgICAgICAgICAgICAgICAgIGlmIChyYXcpIHRoaXMuc3R1ZGVudHMgPSBKU09OLnBhcnNlKHJhdyk7DQogICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgeyAvKiBzdGFydCBmcmVzaCAqLyB9DQogICAgICAgICAgICB9DQogICAgICAgICAgICBzYXZlKCkgew0KICAgICAgICAgICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKHRoaXMuU1RPUkFHRV9LRVksIEpTT04uc3RyaW5naWZ5KHRoaXMuc3R1ZGVudHMpKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgLy8g4pSA4pSAIERhcmsgTW9kZSDilIDilIANCiAgICAgICAgICAgIHRvZ2dsZURhcmsoKSB7DQogICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QudG9nZ2xlKCdkYXJrLW1vZGUnKTsNCiAgICAgICAgICAgICAgICBjb25zdCBpc0RhcmsgPSBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5jb250YWlucygnZGFyay1tb2RlJyk7DQogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RhcmtNb2RlQnRuJykudGV4dENvbnRlbnQgPSBpc0RhcmsgPyAn4piA77iPINCh0LLQtdGC0LvQvicgOiAn8J+MmSDQotC10LzQvdC+JzsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgLy8g4pSA4pSAIEVkaXQgLyBWaWV3IE1vZGUg4pSA4pSADQogICAgICAgICAgICB0b2dnbGVNb2RlKCkgew0KICAgICAgICAgICAgICAgIHRoaXMuZWRpdE1vZGUgPSAhdGhpcy5lZGl0TW9kZTsNCiAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZU1vZGVVSSgpOw0KICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyKCk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIHVwZGF0ZU1vZGVVSSgpIHsNCiAgICAgICAgICAgICAgICBjb25zdCBsYWJlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtb2RlTGFiZWwnKTsNCiAgICAgICAgICAgICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbW9kZVRvZ2dsZUJ0bicpOw0KICAgICAgICAgICAgICAgIGNvbnN0IHNob3cgPSB0aGlzLmN1cnJlbnRWaWV3ID09PSAndGFibGUnOw0KICAgICAgICAgICAgICAgIGxhYmVsLnN0eWxlLmRpc3BsYXkgPSBzaG93ID8gJ2lubGluZS1mbGV4JyA6ICdub25lJzsNCiAgICAgICAgICAgICAgICBidG4uc3R5bGUuZGlzcGxheSA9IHNob3cgPyAnaW5saW5lLWZsZXgnIDogJ25vbmUnOw0KDQogICAgICAgICAgICAgICAgaWYgKHRoaXMuZWRpdE1vZGUpIHsNCiAgICAgICAgICAgICAgICAgICAgbGFiZWwuY2xhc3NOYW1lID0gJ21vZGUtaW5kaWNhdG9yIG1vZGUtZWRpdCc7DQogICAgICAgICAgICAgICAgICAgIGxhYmVsLmlubmVySFRNTCA9ICfinI/vuI8g0KPRgNC10LTRg9Cy0LDRmtC1JzsNCiAgICAgICAgICAgICAgICAgICAgYnRuLmlubmVySFRNTCA9ICfwn5GBINCf0YDQtdCz0LvQtdC0JzsNCiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTmFtZSA9ICdidG4gYnRuLW91dGxpbmUnOw0KICAgICAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgICAgIGxhYmVsLmNsYXNzTmFtZSA9ICdtb2RlLWluZGljYXRvciBtb2RlLXZpZXcnOw0KICAgICAgICAgICAgICAgICAgICBsYWJlbC5pbm5lckhUTUwgPSAn8J+RgSDQn9GA0LXQs9C70LXQtCc7DQogICAgICAgICAgICAgICAgICAgIGJ0bi5pbm5lckhUTUwgPSAn4pyP77iPINCf0YDQvtC80LXQvdC4JzsNCiAgICAgICAgICAgICAgICAgICAgYnRuLmNsYXNzTmFtZSA9ICdidG4gYnRuLW91dGxpbmUnOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgLy8g4pSA4pSAIFZpZXcgU3dpdGNoaW5nIOKUgOKUgA0KICAgICAgICAgICAgc3dpdGNoVmlldyh2aWV3KSB7DQogICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50VmlldyA9IHZpZXc7DQogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2J0bkxpc3QnKS5jbGFzc0xpc3QudG9nZ2xlKCdhY3RpdmUnLCB2aWV3ID09PSAnbGlzdCcpOw0KICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdidG5UYWJsZScpLmNsYXNzTGlzdC50b2dnbGUoJ2FjdGl2ZScsIHZpZXcgPT09ICd0YWJsZScpOw0KICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYWluQ29udGFpbmVyJykuY2xhc3NMaXN0LnRvZ2dsZSgnZnVsbC13aWR0aCcsIHZpZXcgPT09ICd0YWJsZScpOw0KICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlTW9kZVVJKCk7DQogICAgICAgICAgICAgICAgdGhpcy5yZW5kZXIoKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgLy8g4pSA4pSAIFNlYXJjaCBoaWdobGlnaHRpbmcg4pSA4pSADQogICAgICAgICAgICBoaWdobGlnaHQodGV4dCwgcXVlcnkpIHsNCiAgICAgICAgICAgICAgICBpZiAoIXF1ZXJ5IHx8ICF0ZXh0KSByZXR1cm4gdGhpcy5lc2ModGV4dCk7DQogICAgICAgICAgICAgICAgY29uc3QgZXNjYXBlZCA9IHRoaXMuZXNjKHRleHQpOw0KICAgICAgICAgICAgICAgIGNvbnN0IHEgPSBxdWVyeS5yZXBsYWNlKC9bLiorP14ke30oKXxbXF1cXF0vZywgJ1xcJCYnKTsNCiAgICAgICAgICAgICAgICByZXR1cm4gZXNjYXBlZC5yZXBsYWNlKG5ldyBSZWdFeHAoYCgke3F9KWAsICdnaScpLCAnPG1hcms+JDE8L21hcms+Jyk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIC8vIOKUgOKUgCBSZW5kZXIg4pSA4pSADQogICAgICAgICAgICByZW5kZXIoKSB7DQogICAgICAgICAgICAgICAgY29uc3QgYXJlYSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb250ZW50QXJlYScpOw0KICAgICAgICAgICAgICAgIGNvbnN0IHF1ZXJ5ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NlYXJjaElucHV0JykudmFsdWUudG9Mb3dlckNhc2UoKS50cmltKCk7DQoNCiAgICAgICAgICAgICAgICBjb25zdCBmaWx0ZXJlZCA9IHRoaXMuc3R1ZGVudHMuZmlsdGVyKHMgPT4gew0KICAgICAgICAgICAgICAgICAgICBpZiAoIXF1ZXJ5KSByZXR1cm4gdHJ1ZTsNCiAgICAgICAgICAgICAgICAgICAgY29uc3QgYWxsID0gW3MuZmlyc3ROYW1lLCBzLmxhc3ROYW1lLCBzLmdyYWRlLCBzLmZpbmRpbmdzLCBzLm9waW5pb24sDQogICAgICAgICAgICAgICAgICAgIHMuZmF0aGVyTmFtZSwgcy5tb3RoZXJOYW1lLCBzLmFkZHJlc3MsIHMuY29udGFjdF0NCiAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAodiA9PiAodiB8fCAnJykudG9Mb3dlckNhc2UoKSkuam9pbignICcpOw0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gYWxsLmluY2x1ZGVzKHF1ZXJ5KTsNCiAgICAgICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgICAgIGFyZWEuaW5uZXJIVE1MID0gJyc7DQoNCiAgICAgICAgICAgICAgICBpZiAoZmlsdGVyZWQubGVuZ3RoID09PSAwKSB7DQogICAgICAgICAgICAgICAgICAgIGFyZWEuaW5uZXJIVE1MID0gJzxkaXYgY2xhc3M9ImVtcHR5LXN0YXRlIj7QndC10LzQsCDQv9GA0L7QvdCw0ZjQtNC10L3QuCDQt9Cw0L/QuNGB0LguPC9kaXY+JzsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRWaWV3ID09PSAnbGlzdCcpIHsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJMaXN0KGFyZWEsIGZpbHRlcmVkLCBxdWVyeSk7DQogICAgICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJUYWJsZShhcmVhLCBmaWx0ZXJlZCwgcXVlcnkpOw0KICAgICAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgICAgIC8vIEF1dG8tZ3JvdyB0ZXh0YXJlYXMNCiAgICAgICAgICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4gew0KICAgICAgICAgICAgICAgICAgICBhcmVhLnF1ZXJ5U2VsZWN0b3JBbGwoJ3RleHRhcmVhLmZpZWxkJykuZm9yRWFjaCh0YSA9PiB0aGlzLmF1dG9Hcm93KHRhKSk7DQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIC8vIOKUgOKUgCBMaXN0IFZpZXcg4pSA4pSADQogICAgICAgICAgICByZW5kZXJMaXN0KGFyZWEsIGRhdGEsIHF1ZXJ5KSB7DQogICAgICAgICAgICAgICAgZGF0YS5mb3JFYWNoKHN0dWRlbnQgPT4gew0KICAgICAgICAgICAgICAgICAgICBjb25zdCBpZHggPSB0aGlzLnN0dWRlbnRzLmluZGV4T2Yoc3R1ZGVudCk7DQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhcmQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsNCiAgICAgICAgICAgICAgICAgICAgY2FyZC5jbGFzc05hbWUgPSAnY2FyZCc7DQogICAgICAgICAgICAgICAgICAgIGNhcmQuaW5uZXJIVE1MID0gYA0KICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2FyZC1oZWFkZXIiIG9uY2xpY2s9InRoaXMubmV4dEVsZW1lbnRTaWJsaW5nLmNsYXNzTGlzdC50b2dnbGUoJ29wZW4nKSI+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHN0cm9uZz4ke3RoaXMuaGlnaGxpZ2h0KHN0dWRlbnQuZmlyc3ROYW1lLCBxdWVyeSl9ICR7dGhpcy5oaWdobGlnaHQoc3R1ZGVudC5sYXN0TmFtZSwgcXVlcnkpfTwvc3Ryb25nPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJiYWRnZSI+JHt0aGlzLmVzYyhzdHVkZW50LmdyYWRlKSB8fCAn4oCUJ308L3NwYW4+DQogICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4NCiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNhcmQtYm9keSI+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0iZm9ybS1ncmlkIj4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHt0aGlzLmZvcm1GaWVsZChpZHgsICdmaXJzdE5hbWUnLCAn0JjQvNC1Jyl9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR7dGhpcy5mb3JtRmllbGQoaWR4LCAnbGFzdE5hbWUnLCAn0J/RgNC10LfQuNC80LUnKX0NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHt0aGlzLmZvcm1GaWVsZChpZHgsICdncmFkZScsICfQntC00LTQtdC70LXQvdC40LUnKX0NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHt0aGlzLmZvcm1GaWVsZChpZHgsICdiaXJ0aERhdGUnLCAn0JTQsNGC0YPQvCDQvdCwINGA0LDRk9Cw0ZrQtScsICdkYXRlJyl9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNwYW4tMiI+JHt0aGlzLmZvcm1GaWVsZChpZHgsICdmaW5kaW5ncycsICfQndCw0L7QtNC4JywgJ3RleHRhcmVhJyl9PC9kaXY+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNwYW4tMiI+JHt0aGlzLmZvcm1GaWVsZChpZHgsICdvcGluaW9uJywgJ9Cc0LjRgdC70LXRmtC1JywgJ3RleHRhcmVhJyl9PC9kaXY+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9InNwYW4tMiI+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8bGFiZWwgY2xhc3M9ImZvcm0tbGFiZWwiPtCf0YDQuNC70L7Qt9C4PC9sYWJlbD4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJmaWxlIiBtdWx0aXBsZSBhY2NlcHQ9ImltYWdlLyoiIG9uY2hhbmdlPSJhcHAuYWRkSW1hZ2VzKCR7aWR4fSwgdGhpcykiPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0idGh1bWItcm93IiBzdHlsZT0ibWFyZ2luLXRvcDo0cHg7Ij4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAke3RoaXMucmVuZGVyVGh1bWJzKHN0dWRlbnQpfQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2Pg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2Pg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBidG4tZGFuZ2VyIiBzdHlsZT0ibWFyZ2luLXRvcDoxMnB4OyIgb25jbGljaz0iYXBwLmRlbGV0ZVN0dWRlbnQoJHtpZHh9KSI+8J+XkSDQmNC30LHRgNC40YjQuDwvYnV0dG9uPg0KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+YDsNCiAgICAgICAgICAgICAgICAgICAgYXJlYS5hcHBlbmRDaGlsZChjYXJkKTsNCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgLy8g4pSA4pSAIFRhYmxlIFZpZXcg4pSA4pSADQogICAgICAgICAgICByZW5kZXJUYWJsZShhcmVhLCBkYXRhLCBxdWVyeSkgew0KICAgICAgICAgICAgICAgIGNvbnN0IGlzRWRpdCA9IHRoaXMuZWRpdE1vZGU7DQogICAgICAgICAgICAgICAgY29uc3Qgd3JhcCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOw0KICAgICAgICAgICAgICAgIHdyYXAuY2xhc3NOYW1lID0gJ3RhYmxlLXdyYXAnOw0KDQogICAgICAgICAgICAgICAgbGV0IGhlYWRlckhUTUwgPSBgDQogICAgICAgICAgICAgICAgICAgIDx0YWJsZSBjbGFzcz0iZGF0YS10YWJsZSI+DQogICAgICAgICAgICAgICAgICAgICAgICA8Y29sZ3JvdXA+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGNvbCBjbGFzcz0iY29sLWFjdCI+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGNvbCBjbGFzcz0iY29sLW5hbWUiPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxjb2wgY2xhc3M9ImNvbC1ncmFkZSI+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGNvbCBjbGFzcz0iY29sLWRhdGUiPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDxjb2wgY2xhc3M9ImNvbC1wYXJlbnRzIj4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8Y29sIGNsYXNzPSJjb2wtY29udGFjdCI+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGNvbCBjbGFzcz0iY29sLWZpbmRpbmdzIj4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8Y29sIGNsYXNzPSJjb2wtb3BpbmlvbiI+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGNvbCBjbGFzcz0iY29sLWF0dGFjaCI+DQogICAgICAgICAgICAgICAgICAgICAgICA8L2NvbGdyb3VwPg0KICAgICAgICAgICAgICAgICAgICAgICAgPHRoZWFkPjx0cj4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGg+PC90aD4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGg+0JjQvNC1IC8g0J/RgNC10LfQuNC80LU8L3RoPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0aD7QntC00LQuPC90aD4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGg+0JTQsNGC0YPQvDwvdGg+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRoPtCg0L7QtNC40YLQtdC70Lg8L3RoPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0aD7QkNC00YDQtdGB0LAgLyDQmtC+0L3RgtCw0LrRgjwvdGg+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRoPtCd0LDQvtC00Lg8L3RoPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0aD7QnNC40YHQu9C10ZrQtTwvdGg+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRoPtCf0YDQuNC70L7Qt9C4PC90aD4NCiAgICAgICAgICAgICAgICAgICAgICAgIDwvdHI+PC90aGVhZD4NCiAgICAgICAgICAgICAgICAgICAgICAgIDx0Ym9keT48L3Rib2R5Pg0KICAgICAgICAgICAgICAgICAgICA8L3RhYmxlPmA7DQoNCiAgICAgICAgICAgICAgICB3cmFwLmlubmVySFRNTCA9IGhlYWRlckhUTUw7DQogICAgICAgICAgICAgICAgY29uc3QgdGJvZHkgPSB3cmFwLnF1ZXJ5U2VsZWN0b3IoJ3Rib2R5Jyk7DQoNCiAgICAgICAgICAgICAgICBkYXRhLmZvckVhY2goc3R1ZGVudCA9PiB7DQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGlkeCA9IHRoaXMuc3R1ZGVudHMuaW5kZXhPZihzdHVkZW50KTsNCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0cicpOw0KDQogICAgICAgICAgICAgICAgICAgIGlmIChpc0VkaXQpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIOKUgOKUgCBFRElUIE1PREU6IGlucHV0cyDilIDilIANCiAgICAgICAgICAgICAgICAgICAgICAgIHRyLmlubmVySFRNTCA9IGANCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+PGJ1dHRvbiBjbGFzcz0iZGVsLWJ0biIgb25jbGljaz0iYXBwLmRlbGV0ZVN0dWRlbnQoJHtpZHh9KSIgdGl0bGU9ItCY0LfQsdGA0LjRiNC4Ij7inJU8L2J1dHRvbj48L3RkPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHt0aGlzLnRhYmxlSW5wdXQoaWR4LCAnZmlyc3ROYW1lJywgJ9CY0LzQtScpfQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAke3RoaXMudGFibGVJbnB1dChpZHgsICdsYXN0TmFtZScsICfQn9GA0LXQt9C40LzQtScpfQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvdGQ+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPiR7dGhpcy50YWJsZUlucHV0KGlkeCwgJ2dyYWRlJywgJ9Ce0LTQtC4nKX08L3RkPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD4ke3RoaXMudGFibGVJbnB1dChpZHgsICdiaXJ0aERhdGUnLCAnJywgJ2RhdGUnKX08L3RkPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHt0aGlzLnRhYmxlSW5wdXQoaWR4LCAnZmF0aGVyTmFtZScsICfQotCw0YLQutC+Jyl9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR7dGhpcy50YWJsZUlucHV0KGlkeCwgJ21vdGhlck5hbWUnLCAn0JzQsNGY0LrQsCcpfQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvdGQ+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAke3RoaXMudGFibGVJbnB1dChpZHgsICdhZGRyZXNzJywgJ9CQ0LTRgNC10YHQsCcpfQ0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAke3RoaXMudGFibGVJbnB1dChpZHgsICdjb250YWN0JywgJ9Ca0L7QvdGC0LDQutGCJyl9DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPC90ZD4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+JHt0aGlzLnRhYmxlSW5wdXQoaWR4LCAnZmluZGluZ3MnLCAn0J3QsNC+0LTQuCcsICd0ZXh0YXJlYScpfTwvdGQ+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPiR7dGhpcy50YWJsZUlucHV0KGlkeCwgJ29waW5pb24nLCAn0JzQuNGB0LvQtdGa0LUnLCAndGV4dGFyZWEnKX08L3RkPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0idGh1bWItcm93Ij4ke3RoaXMucmVuZGVyVGh1bWJzKHN0dWRlbnQpfTwvZGl2Pg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8bGFiZWwgY2xhc3M9ImFkZC1pbWctbGFiZWwiPisg0KHQu9C40LrQsA0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9ImZpbGUiIGhpZGRlbiBtdWx0aXBsZSBhY2NlcHQ9ImltYWdlLyoiIG9uY2hhbmdlPSJhcHAuYWRkSW1hZ2VzKCR7aWR4fSwgdGhpcykiPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2xhYmVsPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDwvdGQ+YDsNCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIOKUgOKUgCBWSUVXIE1PREU6IHBsYWluIHRleHQsIHJlYWQtb25seSDilIDilIANCiAgICAgICAgICAgICAgICAgICAgICAgIHRyLmlubmVySFRNTCA9IGANCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+PC90ZD4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+PGRpdiBjbGFzcz0iY2VsbC10ZXh0Ij48c3Ryb25nPiR7dGhpcy5oaWdobGlnaHQoc3R1ZGVudC5maXJzdE5hbWUsIHF1ZXJ5KX08L3N0cm9uZz4gJHt0aGlzLmhpZ2hsaWdodChzdHVkZW50Lmxhc3ROYW1lLCBxdWVyeSl9PC9kaXY+PC90ZD4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+PGRpdiBjbGFzcz0iY2VsbC10ZXh0Ij4ke3RoaXMuaGlnaGxpZ2h0KHN0dWRlbnQuZ3JhZGUsIHF1ZXJ5KX08L2Rpdj48L3RkPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD48ZGl2IGNsYXNzPSJjZWxsLXRleHQiPiR7dGhpcy5lc2Moc3R1ZGVudC5iaXJ0aERhdGUpfTwvZGl2PjwvdGQ+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkPjxkaXYgY2xhc3M9ImNlbGwtdGV4dCI+JHt0aGlzLmhpZ2hsaWdodChzdHVkZW50LmZhdGhlck5hbWUsIHF1ZXJ5KX08YnI+JHt0aGlzLmhpZ2hsaWdodChzdHVkZW50Lm1vdGhlck5hbWUsIHF1ZXJ5KX08L2Rpdj48L3RkPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD48ZGl2IGNsYXNzPSJjZWxsLXRleHQiPiR7dGhpcy5oaWdobGlnaHQoc3R1ZGVudC5hZGRyZXNzLCBxdWVyeSl9PGJyPiR7dGhpcy5oaWdobGlnaHQoc3R1ZGVudC5jb250YWN0LCBxdWVyeSl9PC9kaXY+PC90ZD4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+PGRpdiBjbGFzcz0iY2VsbC10ZXh0Ij4ke3RoaXMuaGlnaGxpZ2h0KHN0dWRlbnQuZmluZGluZ3MsIHF1ZXJ5KX08L2Rpdj48L3RkPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0ZD48ZGl2IGNsYXNzPSJjZWxsLXRleHQiPiR7dGhpcy5oaWdobGlnaHQoc3R1ZGVudC5vcGluaW9uLCBxdWVyeSl9PC9kaXY+PC90ZD4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQ+PGRpdiBjbGFzcz0idGh1bWItcm93Ij4ke3RoaXMucmVuZGVyVGh1bWJzKHN0dWRlbnQpfTwvZGl2PjwvdGQ+YDsNCiAgICAgICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgICAgIHRib2R5LmFwcGVuZENoaWxkKHRyKTsNCiAgICAgICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgICAgIGFyZWEuYXBwZW5kQ2hpbGQod3JhcCk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIC8vIOKUgOKUgCBGaWVsZCBHZW5lcmF0b3JzIOKUgOKUgA0KICAgICAgICAgICAgZm9ybUZpZWxkKGlkeCwga2V5LCBsYWJlbCwgdHlwZSA9ICd0ZXh0Jykgew0KICAgICAgICAgICAgICAgIGNvbnN0IHZhbCA9IHRoaXMuZXNjKHRoaXMuc3R1ZGVudHNbaWR4XVtrZXldKTsNCiAgICAgICAgICAgICAgICBsZXQgaW5wdXQ7DQogICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICd0ZXh0YXJlYScpIHsNCiAgICAgICAgICAgICAgICAgICAgaW5wdXQgPSBgPHRleHRhcmVhIGNsYXNzPSJmaWVsZCIgb25pbnB1dD0iYXBwLm9uRWRpdCgke2lkeH0sJyR7a2V5fScsdGhpcy52YWx1ZSk7IGFwcC5hdXRvR3Jvdyh0aGlzKTsiPiR7dmFsfTwvdGV4dGFyZWE+YDsNCiAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICBpbnB1dCA9IGA8aW5wdXQgdHlwZT0iJHt0eXBlfSIgY2xhc3M9ImZpZWxkIiB2YWx1ZT0iJHt2YWx9IiBvbmlucHV0PSJhcHAub25FZGl0KCR7aWR4fSwnJHtrZXl9Jyx0aGlzLnZhbHVlKSI+YDsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgcmV0dXJuIGA8ZGl2PjxsYWJlbCBjbGFzcz0iZm9ybS1sYWJlbCI+JHtsYWJlbH08L2xhYmVsPiR7aW5wdXR9PC9kaXY+YDsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgdGFibGVJbnB1dChpZHgsIGtleSwgcGxhY2Vob2xkZXIsIHR5cGUgPSAndGV4dCcpIHsNCiAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSB0aGlzLmVzYyh0aGlzLnN0dWRlbnRzW2lkeF1ba2V5XSk7DQogICAgICAgICAgICAgICAgaWYgKHR5cGUgPT09ICd0ZXh0YXJlYScpIHsNCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGA8dGV4dGFyZWEgY2xhc3M9ImZpZWxkIiBwbGFjZWhvbGRlcj0iJHtwbGFjZWhvbGRlcn0iIG9uaW5wdXQ9ImFwcC5vbkVkaXQoJHtpZHh9LCcke2tleX0nLHRoaXMudmFsdWUpOyBhcHAuYXV0b0dyb3codGhpcyk7Ij4ke3ZhbH08L3RleHRhcmVhPmA7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJldHVybiBgPGlucHV0IHR5cGU9IiR7dHlwZX0iIGNsYXNzPSJmaWVsZCIgcGxhY2Vob2xkZXI9IiR7cGxhY2Vob2xkZXJ9IiB2YWx1ZT0iJHt2YWx9IiBvbmlucHV0PSJhcHAub25FZGl0KCR7aWR4fSwnJHtrZXl9Jyx0aGlzLnZhbHVlKSIgc3R5bGU9Im1hcmdpbi1ib3R0b206MnB4OyI+YDsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgcmVuZGVyVGh1bWJzKHN0dWRlbnQpIHsNCiAgICAgICAgICAgICAgICBpZiAoIXN0dWRlbnQuYXR0YWNobWVudHMgfHwgIXN0dWRlbnQuYXR0YWNobWVudHMubGVuZ3RoKSByZXR1cm4gJyc7DQogICAgICAgICAgICAgICAgcmV0dXJuIHN0dWRlbnQuYXR0YWNobWVudHMubWFwKHNyYyA9Pg0KICAgICAgICAgICAgICAgICAgICBgPGltZyBzcmM9IiR7c3JjfSIgY2xhc3M9InRodW1iLWltZyIgb25jbGljaz0iYXBwLm9wZW5Nb2RhbCh0aGlzLnNyYykiPmANCiAgICAgICAgICAgICAgICApLmpvaW4oJycpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvLyDilIDilIAgQXV0by1ncm93IHRleHRhcmVhIOKUgOKUgA0KICAgICAgICAgICAgYXV0b0dyb3coZWwpIHsNCiAgICAgICAgICAgICAgICBlbC5zdHlsZS5oZWlnaHQgPSAnYXV0byc7DQogICAgICAgICAgICAgICAgZWwuc3R5bGUuaGVpZ2h0ID0gZWwuc2Nyb2xsSGVpZ2h0ICsgJ3B4JzsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgLy8g4pSA4pSAIEVzY2FwZSBIVE1MIOKUgOKUgA0KICAgICAgICAgICAgZXNjKHN0cikgew0KICAgICAgICAgICAgICAgIGlmICghc3RyKSByZXR1cm4gJyc7DQogICAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZyhzdHIpLnJlcGxhY2UoLyYvZywgJyZhbXA7JykucmVwbGFjZSgvPC9nLCAnJmx0OycpLnJlcGxhY2UoLz4vZywgJyZndDsnKS5yZXBsYWNlKC8iL2csICcmcXVvdDsnKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgLy8g4pSA4pSAIERhdGEgQWN0aW9ucyDilIDilIANCiAgICAgICAgICAgIG9uRWRpdChpZHgsIGtleSwgdmFsdWUpIHsNCiAgICAgICAgICAgICAgICB0aGlzLnN0dWRlbnRzW2lkeF1ba2V5XSA9IHZhbHVlOw0KICAgICAgICAgICAgICAgIHRoaXMuc2F2ZSgpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBhZGRTdHVkZW50KCkgew0KICAgICAgICAgICAgICAgIHRoaXMuc3R1ZGVudHMudW5zaGlmdCh7DQogICAgICAgICAgICAgICAgICAgIGlkOiBEYXRlLm5vdygpLCBmaXJzdE5hbWU6ICcnLCBsYXN0TmFtZTogJycsIGdyYWRlOiAnJywNCiAgICAgICAgICAgICAgICAgICAgYmlydGhEYXRlOiAnJywgZmluZGluZ3M6ICcnLCBvcGluaW9uOiAnJywgYXR0YWNobWVudHM6IFtdDQogICAgICAgICAgICAgICAgfSk7DQogICAgICAgICAgICAgICAgdGhpcy5zYXZlKCk7DQogICAgICAgICAgICAgICAgLy8gSWYgaW4gdGFibGUgdmlldyBtb2RlLCBzd2l0Y2ggdG8gZWRpdCBmb3IgdGhlIG5ldyByb3cNCiAgICAgICAgICAgICAgICBpZiAodGhpcy5jdXJyZW50VmlldyA9PT0gJ3RhYmxlJyAmJiAhdGhpcy5lZGl0TW9kZSkgew0KICAgICAgICAgICAgICAgICAgICB0aGlzLmVkaXRNb2RlID0gdHJ1ZTsNCiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVNb2RlVUkoKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgdGhpcy5yZW5kZXIoKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgZGVsZXRlU3R1ZGVudChpZHgpIHsNCiAgICAgICAgICAgICAgICBpZiAoIWNvbmZpcm0oJ9CY0LfQsdGA0LjRiNC4INCz0L4g0L7QstC+0Zgg0LfQsNC/0LjRgT8nKSkgcmV0dXJuOw0KICAgICAgICAgICAgICAgIHRoaXMuc3R1ZGVudHMuc3BsaWNlKGlkeCwgMSk7DQogICAgICAgICAgICAgICAgdGhpcy5zYXZlKCk7DQogICAgICAgICAgICAgICAgdGhpcy5yZW5kZXIoKTsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgYXN5bmMgYWRkSW1hZ2VzKGlkeCwgaW5wdXQpIHsNCiAgICAgICAgICAgICAgICBpZiAoIWlucHV0LmZpbGVzIHx8IGlucHV0LmZpbGVzLmxlbmd0aCA9PT0gMCkgcmV0dXJuOw0KICAgICAgICAgICAgICAgIGNvbnN0IHByb21pc2VzID0gQXJyYXkuZnJvbShpbnB1dC5maWxlcykubWFwKGZpbGUgPT4gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7DQogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7DQogICAgICAgICAgICAgICAgICAgIHJlYWRlci5vbmxvYWQgPSBlID0+IHJlc29sdmUoZS50YXJnZXQucmVzdWx0KTsNCiAgICAgICAgICAgICAgICAgICAgcmVhZGVyLnJlYWRBc0RhdGFVUkwoZmlsZSk7DQogICAgICAgICAgICAgICAgfSkpOw0KICAgICAgICAgICAgICAgIGNvbnN0IGltZ3MgPSBhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlcyk7DQogICAgICAgICAgICAgICAgaWYgKCF0aGlzLnN0dWRlbnRzW2lkeF0uYXR0YWNobWVudHMpIHRoaXMuc3R1ZGVudHNbaWR4XS5hdHRhY2htZW50cyA9IFtdOw0KICAgICAgICAgICAgICAgIHRoaXMuc3R1ZGVudHNbaWR4XS5hdHRhY2htZW50cy5wdXNoKC4uLmltZ3MpOw0KICAgICAgICAgICAgICAgIHRoaXMuc2F2ZSgpOw0KICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyKCk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIC8vIOKUgOKUgCBNb2RhbCDilIDilIANCiAgICAgICAgICAgIG9wZW5Nb2RhbChzcmMpIHsNCiAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbW9kYWxJbWcnKS5zcmMgPSBzcmM7DQogICAgICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2ltYWdlTW9kYWwnKS5jbGFzc0xpc3QuYWRkKCdvcGVuJyk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjbG9zZU1vZGFsKCkgew0KICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdpbWFnZU1vZGFsJykuY2xhc3NMaXN0LnJlbW92ZSgnb3BlbicpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvLyDilIDilIAgSW1wb3J0IC8gRXhwb3J0IOKUgOKUgA0KICAgICAgICAgICAgaW1wb3J0RGF0YShpbnB1dCkgew0KICAgICAgICAgICAgICAgIGNvbnN0IGZpbGUgPSBpbnB1dC5maWxlc1swXTsNCiAgICAgICAgICAgICAgICBpZiAoIWZpbGUpIHJldHVybjsNCiAgICAgICAgICAgICAgICBjb25zdCByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpOw0KICAgICAgICAgICAgICAgIHJlYWRlci5vbmxvYWQgPSBlID0+IHsNCiAgICAgICAgICAgICAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGpzb24gPSBKU09OLnBhcnNlKGUudGFyZ2V0LnJlc3VsdCk7DQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoanNvbi5kYXRhICYmIEFycmF5LmlzQXJyYXkoanNvbi5kYXRhLnN0dWRlbnRfcmVjb3JkcykpIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnN0dWRlbnRzID0ganNvbi5kYXRhLnN0dWRlbnRfcmVjb3JkczsNCiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShqc29uKSkgew0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc3R1ZGVudHMgPSBqc29uOw0KICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2Zvcm1hdCcpOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5zYXZlKCk7DQogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlcigpOw0KICAgICAgICAgICAgICAgICAgICAgICAgYWxlcnQoJ9Cj0LLQvtC30L7RgiDQtSDRg9GB0L/QtdGI0LXQvSEnKTsNCiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBhbGVydCgn0JPRgNC10YjQutCwINC/0YDQuCDRg9Cy0L7QtyDQvdCwIEpTT04nKTsNCiAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICAgICAgcmVhZGVyLnJlYWRBc1RleHQoZmlsZSk7DQogICAgICAgICAgICAgICAgaW5wdXQudmFsdWUgPSAnJzsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgZXhwb3J0RGF0YSgpIHsNCiAgICAgICAgICAgICAgICBjb25zdCBleHBvcnRPYmogPSB7DQogICAgICAgICAgICAgICAgICAgIG1ldGE6IHsgdmVyc2lvbjogMiwgZXhwb3J0ZWQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSB9LA0KICAgICAgICAgICAgICAgICAgICBkYXRhOiB7IHN0dWRlbnRfcmVjb3JkczogdGhpcy5zdHVkZW50cyB9DQogICAgICAgICAgICAgICAgfTsNCiAgICAgICAgICAgICAgICBjb25zdCBibG9iID0gbmV3IEJsb2IoW0pTT04uc3RyaW5naWZ5KGV4cG9ydE9iaiwgbnVsbCwgMildLCB7IHR5cGU6ICdhcHBsaWNhdGlvbi9qc29uJyB9KTsNCiAgICAgICAgICAgICAgICBjb25zdCB1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpOw0KICAgICAgICAgICAgICAgIGNvbnN0IGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7DQogICAgICAgICAgICAgICAgYS5ocmVmID0gdXJsOw0KICAgICAgICAgICAgICAgIGEuZG93bmxvYWQgPSBgc3R1ZGVudF9kYXRhXyR7bmV3IERhdGUoKS50b0lTT1N0cmluZygpLnNsaWNlKDAsIDEwKX0uanNvbmA7DQogICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChhKTsNCiAgICAgICAgICAgICAgICBhLmNsaWNrKCk7DQogICAgICAgICAgICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChhKTsNCiAgICAgICAgICAgICAgICBVUkwucmV2b2tlT2JqZWN0VVJMKHVybCk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICBjb25zdCBhcHAgPSBuZXcgU3R1ZGVudE1hbmFnZXIoKTsNCiAgICA8L3NjcmlwdD4NCjwvYm9keT4NCg0KPC9odG1sPg==';
        var embeddedAudiogramHtmlB64 = 'PCFET0NUWVBFIGh0bWw+DQo8aHRtbCBsYW5nPSJtayI+DQoNCjxoZWFkPg0KICAgIDxtZXRhIGNoYXJzZXQ9IlVURi04Ij4NCiAgICA8bWV0YSBuYW1lPSJ2aWV3cG9ydCIgY29udGVudD0id2lkdGg9ZGV2aWNlLXdpZHRoLCBpbml0aWFsLXNjYWxlPTEuMCI+DQogICAgPHRpdGxlPtCQ0YPQtNC40L7Qs9GA0LDQvNC4IC0g0JrQvtGH0L4g0KDQsNGG0LjQvSAo0JHQsNC30LAg0L3QsCDQv9C+0LTQsNGC0L7RhtC4KTwvdGl0bGU+DQogICAgPHN0eWxlPg0KICAgICAgICAqIHsNCiAgICAgICAgICAgIG1hcmdpbjogMDsNCiAgICAgICAgICAgIHBhZGRpbmc6IDA7DQogICAgICAgICAgICBib3gtc2l6aW5nOiBib3JkZXItYm94Ow0KICAgICAgICB9DQoNCiAgICAgICAgYm9keSB7DQogICAgICAgICAgICBmb250LWZhbWlseTogJ1NlZ29lIFVJJywgQXJpYWwsIHNhbnMtc2VyaWY7DQogICAgICAgICAgICBtaW4taGVpZ2h0OiAxMDB2aDsNCiAgICAgICAgICAgIHBhZGRpbmc6IDEwcHg7DQogICAgICAgICAgICB0cmFuc2l0aW9uOiBiYWNrZ3JvdW5kIDAuM3MgZWFzZTsNCiAgICAgICAgfQ0KDQogICAgICAgIGJvZHkubGlnaHQtbW9kZSB7DQogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZjVmNWY1Ow0KICAgICAgICAgICAgY29sb3I6ICMzMzM7DQogICAgICAgIH0NCg0KICAgICAgICBib2R5LmRhcmstbW9kZSB7DQogICAgICAgICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCAjMWExYTJlIDAlLCAjMTYyMTNlIDEwMCUpOw0KICAgICAgICAgICAgY29sb3I6ICNlMGUwZTA7DQogICAgICAgIH0NCg0KICAgICAgICAubG9nbyB7DQogICAgICAgICAgICB3aWR0aDogODBweDsNCiAgICAgICAgICAgIGhlaWdodDogYXV0bzsNCiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDEwcHg7DQogICAgICAgIH0NCg0KICAgICAgICAvKiAtLS0gSGVhZGVyIFN0eWxlcyAtLS0gKi8NCiAgICAgICAgLmhlYWRlciB7DQogICAgICAgICAgICB0ZXh0LWFsaWduOiBjZW50ZXI7DQogICAgICAgICAgICBwYWRkaW5nOiAyMHB4Ow0KICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogMjBweDsNCiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDE1cHg7DQogICAgICAgICAgICBib3gtc2hhZG93OiAwIDhweCAzMnB4IHJnYmEoMCwgMCwgMCwgMC40KTsNCiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7DQogICAgICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOw0KICAgICAgICAgICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7DQogICAgICAgICAgICBnYXA6IDI1cHg7DQogICAgICAgICAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMSk7DQogICAgICAgICAgICB0cmFuc2l0aW9uOiBiYWNrZ3JvdW5kIDAuM3MgZWFzZTsNCiAgICAgICAgICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsNCiAgICAgICAgfQ0KDQogICAgICAgIGJvZHkubGlnaHQtbW9kZSAuaGVhZGVyIHsNCiAgICAgICAgICAgIGJhY2tncm91bmQ6IHdoaXRlOw0KICAgICAgICB9DQoNCiAgICAgICAgYm9keS5kYXJrLW1vZGUgLmhlYWRlciB7DQogICAgICAgICAgICBiYWNrZ3JvdW5kOiBsaW5lYXItZ3JhZGllbnQoMTM1ZGVnLCAjNGE0ZTY5IDAlLCAjNWE1ZjdkIDEwMCUpOw0KICAgICAgICB9DQoNCiAgICAgICAgLmhlYWRlciBoMSB7DQogICAgICAgICAgICBmb250LXNpemU6IDIycHg7DQogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiA4cHg7DQogICAgICAgICAgICBmb250LXdlaWdodDogNjAwOw0KICAgICAgICB9DQoNCiAgICAgICAgYm9keS5saWdodC1tb2RlIC5oZWFkZXIgaDEgew0KICAgICAgICAgICAgY29sb3I6ICMyYzNlNTA7DQogICAgICAgIH0NCg0KICAgICAgICBib2R5LmRhcmstbW9kZSAuaGVhZGVyIGgxIHsNCiAgICAgICAgICAgIGNvbG9yOiAjZmZmZmZmOw0KICAgICAgICAgICAgdGV4dC1zaGFkb3c6IDAgMnB4IDRweCByZ2JhKDAsIDAsIDAsIDAuMyk7DQogICAgICAgIH0NCg0KICAgICAgICAuaGVhZGVyIGgyIHsNCiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTZweDsNCiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA1MDA7DQogICAgICAgIH0NCg0KICAgICAgICBib2R5LmxpZ2h0LW1vZGUgLmhlYWRlciBoMiB7DQogICAgICAgICAgICBjb2xvcjogIzM0NDk1ZTsNCiAgICAgICAgfQ0KDQogICAgICAgIGJvZHkuZGFyay1tb2RlIC5oZWFkZXIgaDIgew0KICAgICAgICAgICAgY29sb3I6ICNhOGRhZGM7DQogICAgICAgIH0NCg0KICAgICAgICAuaGVhZGVyLXJpZ2h0IHsNCiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsNCiAgICAgICAgICAgIHJpZ2h0OiAyMHB4Ow0KICAgICAgICAgICAgdG9wOiA1MCU7DQogICAgICAgICAgICB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoLTUwJSk7DQogICAgICAgIH0NCg0KICAgICAgICAudGhlbWUtdG9nZ2xlIHsNCiAgICAgICAgICAgIHBhZGRpbmc6IDA7DQogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAyNXB4Ow0KICAgICAgICAgICAgYm9yZGVyOiBub25lOw0KICAgICAgICAgICAgY3Vyc29yOiBwb2ludGVyOw0KICAgICAgICAgICAgd2lkdGg6IDYwcHg7DQogICAgICAgICAgICBoZWlnaHQ6IDMycHg7DQogICAgICAgICAgICBwb3NpdGlvbjogcmVsYXRpdmU7DQogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjY2NjOw0KICAgICAgICB9DQoNCiAgICAgICAgYm9keS5kYXJrLW1vZGUgLnRoZW1lLXRvZ2dsZSB7DQogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjNTg2NUYyOw0KICAgICAgICB9DQoNCiAgICAgICAgLnRoZW1lLXRvZ2dsZTo6YWZ0ZXIgew0KICAgICAgICAgICAgY29udGVudDogJyc7DQogICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7DQogICAgICAgICAgICB0b3A6IDNweDsNCiAgICAgICAgICAgIGxlZnQ6IDNweDsNCiAgICAgICAgICAgIHdpZHRoOiAyNnB4Ow0KICAgICAgICAgICAgaGVpZ2h0OiAyNnB4Ow0KICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogNTAlOw0KICAgICAgICAgICAgYmFja2dyb3VuZDogd2hpdGU7DQogICAgICAgICAgICB0cmFuc2l0aW9uOiBhbGwgMC4zcyBlYXNlOw0KICAgICAgICB9DQoNCiAgICAgICAgYm9keS5kYXJrLW1vZGUgLnRoZW1lLXRvZ2dsZTo6YWZ0ZXIgew0KICAgICAgICAgICAgbGVmdDogMzFweDsNCiAgICAgICAgfQ0KDQogICAgICAgIC8qIC0tLSBOYXZpZ2F0aW9uIFBhbmVsIChOZXcpIC0tLSAqLw0KICAgICAgICAubmF2LXBhbmVsIHsNCiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7DQogICAgICAgICAgICBnYXA6IDE1cHg7DQogICAgICAgICAgICBwYWRkaW5nOiAxNXB4Ow0KICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogMjBweDsNCiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDE1cHg7DQogICAgICAgICAgICBhbGlnbi1pdGVtczogY2VudGVyOw0KICAgICAgICAgICAganVzdGlmeS1jb250ZW50OiBzcGFjZS1iZXR3ZWVuOw0KICAgICAgICAgICAgYm94LXNoYWRvdzogMCA0cHggMTZweCByZ2JhKDAsIDAsIDAsIDAuMyk7DQogICAgICAgICAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMSk7DQogICAgICAgICAgICBmbGV4LXdyYXA6IHdyYXA7DQogICAgICAgIH0NCg0KICAgICAgICBib2R5LmxpZ2h0LW1vZGUgLm5hdi1wYW5lbCB7DQogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZTNmMmZkOw0KICAgICAgICAgICAgYm9yZGVyOiAxcHggc29saWQgIzkwY2FmOTsNCiAgICAgICAgfQ0KDQogICAgICAgIGJvZHkuZGFyay1tb2RlIC5uYXYtcGFuZWwgew0KICAgICAgICAgICAgYmFja2dyb3VuZDogIzIzMjc0MjsNCiAgICAgICAgfQ0KDQogICAgICAgIC5uYXYtY29udHJvbHMgew0KICAgICAgICAgICAgZGlzcGxheTogZmxleDsNCiAgICAgICAgICAgIGdhcDogMTBweDsNCiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7DQogICAgICAgICAgICBmbGV4OiAxOw0KICAgICAgICB9DQoNCiAgICAgICAgLnJlY29yZC1zZWxlY3RvciB7DQogICAgICAgICAgICBmbGV4OiAxOw0KICAgICAgICAgICAgcGFkZGluZzogMTBweDsNCiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDhweDsNCiAgICAgICAgICAgIGJvcmRlcjogMXB4IHNvbGlkIHJnYmEoMjU1LCAyNTUsIDI1NSwgMC4yKTsNCiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTRweDsNCiAgICAgICAgICAgIG1pbi13aWR0aDogMjAwcHg7DQogICAgICAgIH0NCg0KICAgICAgICBib2R5LmxpZ2h0LW1vZGUgLnJlY29yZC1zZWxlY3RvciB7DQogICAgICAgICAgICBiYWNrZ3JvdW5kOiB3aGl0ZTsNCiAgICAgICAgICAgIGNvbG9yOiAjMzMzOw0KICAgICAgICAgICAgYm9yZGVyLWNvbG9yOiAjY2NjOw0KICAgICAgICB9DQoNCiAgICAgICAgYm9keS5kYXJrLW1vZGUgLnJlY29yZC1zZWxlY3RvciB7DQogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjNDI0NzY5Ow0KICAgICAgICAgICAgY29sb3I6IHdoaXRlOw0KICAgICAgICB9DQoNCiAgICAgICAgLm5hdi1idG4gew0KICAgICAgICAgICAgcGFkZGluZzogMTBweCAyMHB4Ow0KICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogOHB4Ow0KICAgICAgICAgICAgYm9yZGVyOiBub25lOw0KICAgICAgICAgICAgY3Vyc29yOiBwb2ludGVyOw0KICAgICAgICAgICAgZm9udC13ZWlnaHQ6IGJvbGQ7DQogICAgICAgICAgICBmb250LXNpemU6IDE2cHg7DQogICAgICAgICAgICB0cmFuc2l0aW9uOiB0cmFuc2Zvcm0gMC4xczsNCiAgICAgICAgfQ0KDQogICAgICAgIC5uYXYtYnRuOmhvdmVyIHsNCiAgICAgICAgICAgIHRyYW5zZm9ybTogc2NhbGUoMS4wNSk7DQogICAgICAgIH0NCg0KICAgICAgICAubmF2LWJ0bjphY3RpdmUgew0KICAgICAgICAgICAgdHJhbnNmb3JtOiBzY2FsZSgwLjk1KTsNCiAgICAgICAgfQ0KDQogICAgICAgIC5idG4tcHJpbWFyeSB7DQogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjNTg2NUYyOw0KICAgICAgICAgICAgY29sb3I6IHdoaXRlOw0KICAgICAgICB9DQoNCiAgICAgICAgLmJ0bi1zdWNjZXNzIHsNCiAgICAgICAgICAgIGJhY2tncm91bmQ6ICMyZWNjNzE7DQogICAgICAgICAgICBjb2xvcjogd2hpdGU7DQogICAgICAgIH0NCg0KICAgICAgICAuYnRuLWRhbmdlciB7DQogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZTc0YzNjOw0KICAgICAgICAgICAgY29sb3I6IHdoaXRlOw0KICAgICAgICB9DQoNCiAgICAgICAgLmJ0bi1zZWNvbmRhcnkgew0KICAgICAgICAgICAgYmFja2dyb3VuZDogIzRhNGU2OTsNCiAgICAgICAgICAgIGNvbG9yOiB3aGl0ZTsNCiAgICAgICAgfQ0KDQogICAgICAgIGJvZHkubGlnaHQtbW9kZSAuYnRuLXNlY29uZGFyeSB7DQogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjOTVhNWE2Ow0KICAgICAgICAgICAgY29sb3I6IHdoaXRlOw0KICAgICAgICB9DQoNCiAgICAgICAgLmNvdW50ZXItZGlzcGxheSB7DQogICAgICAgICAgICBmb250LXdlaWdodDogYm9sZDsNCiAgICAgICAgICAgIG1pbi13aWR0aDogMTAwcHg7DQogICAgICAgICAgICB0ZXh0LWFsaWduOiBjZW50ZXI7DQogICAgICAgIH0NCg0KICAgICAgICAvKiAtLS0gSW5wdXQgRmllbGRzIC0tLSAqLw0KICAgICAgICAuc3ViamVjdC1pbmZvIHsNCiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDE1cHg7DQogICAgICAgICAgICBwYWRkaW5nOiAxNXB4Ow0KICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMTBweDsNCiAgICAgICAgICAgIGRpc3BsYXk6IGZsZXg7DQogICAgICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsNCiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7DQogICAgICAgICAgICBnYXA6IDE1cHg7DQogICAgICAgICAgICBtYXgtd2lkdGg6IDE5MDBweDsNCiAgICAgICAgICAgIG1hcmdpbi1sZWZ0OiBhdXRvOw0KICAgICAgICAgICAgbWFyZ2luLXJpZ2h0OiBhdXRvOw0KICAgICAgICB9DQoNCiAgICAgICAgYm9keS5saWdodC1tb2RlIC5zdWJqZWN0LWluZm8gew0KICAgICAgICAgICAgYmFja2dyb3VuZDogd2hpdGU7DQogICAgICAgICAgICBib3gtc2hhZG93OiAwIDJweCAxMHB4IHJnYmEoMCwgMCwgMCwgMC4xKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGJvZHkuZGFyay1tb2RlIC5zdWJqZWN0LWluZm8gew0KICAgICAgICAgICAgYmFja2dyb3VuZDogIzJkMzI1MDsNCiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgNHB4IDE2cHggcmdiYSgwLCAwLCAwLCAwLjMpOw0KICAgICAgICB9DQoNCiAgICAgICAgLnN1YmplY3QtaW5mbyBpbnB1dCB7DQogICAgICAgICAgICBwYWRkaW5nOiAxMHB4IDIwcHg7DQogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA4cHg7DQogICAgICAgICAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMik7DQogICAgICAgICAgICBmb250LXNpemU6IDE2cHg7DQogICAgICAgICAgICB0ZXh0LWFsaWduOiBjZW50ZXI7DQogICAgICAgICAgICBmb250LXdlaWdodDogNTAwOw0KICAgICAgICB9DQoNCiAgICAgICAgYm9keS5saWdodC1tb2RlIC5zdWJqZWN0LWluZm8gaW5wdXQgew0KICAgICAgICAgICAgYmFja2dyb3VuZDogI2Y4ZjlmYTsNCiAgICAgICAgICAgIGNvbG9yOiAjMmMzZTUwOw0KICAgICAgICAgICAgYm9yZGVyLWNvbG9yOiAjY2NjOw0KICAgICAgICB9DQoNCiAgICAgICAgYm9keS5kYXJrLW1vZGUgLnN1YmplY3QtaW5mbyBpbnB1dCB7DQogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjNDI0NzY5Ow0KICAgICAgICAgICAgY29sb3I6ICNlMGUwZTA7DQogICAgICAgIH0NCg0KICAgICAgICAvKiAtLS0gQ2FudmFzICYgTGF5b3V0IC0tLSAqLw0KICAgICAgICAubWFpbi1jb250YWluZXIgew0KICAgICAgICAgICAgZGlzcGxheTogZmxleDsNCiAgICAgICAgICAgIGdhcDogMTVweDsNCiAgICAgICAgICAgIHBhZGRpbmc6IDI1cHg7DQogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAxNXB4Ow0KICAgICAgICAgICAgYm94LXNoYWRvdzogMCA4cHggMzJweCByZ2JhKDAsIDAsIDAsIDAuNCk7DQogICAgICAgICAgICBib3JkZXI6IDFweCBzb2xpZCByZ2JhKDI1NSwgMjU1LCAyNTUsIDAuMSk7DQogICAgICAgICAgICB0cmFuc2l0aW9uOiBiYWNrZ3JvdW5kIDAuM3MgZWFzZTsNCiAgICAgICAgICAgIG1heC13aWR0aDogMTkwMHB4Ow0KICAgICAgICAgICAgbWFyZ2luOiAwIGF1dG87DQogICAgICAgIH0NCg0KICAgICAgICBib2R5LmxpZ2h0LW1vZGUgLm1haW4tY29udGFpbmVyIHsNCiAgICAgICAgICAgIGJhY2tncm91bmQ6IHdoaXRlOw0KICAgICAgICB9DQoNCiAgICAgICAgYm9keS5kYXJrLW1vZGUgLm1haW4tY29udGFpbmVyIHsNCiAgICAgICAgICAgIGJhY2tncm91bmQ6ICMyZDMyNTA7DQogICAgICAgIH0NCg0KICAgICAgICAuYXVkaW9ncmFtLXBhbmVsIHsNCiAgICAgICAgICAgIGZsZXg6IDE7DQogICAgICAgICAgICBwb3NpdGlvbjogcmVsYXRpdmU7DQogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAxMHB4Ow0KICAgICAgICAgICAgcGFkZGluZzogMTBweDsNCiAgICAgICAgfQ0KDQogICAgICAgIGJvZHkubGlnaHQtbW9kZSAuYXVkaW9ncmFtLXBhbmVsIHsNCiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNmYWZhZmE7DQogICAgICAgIH0NCg0KICAgICAgICBib2R5LmRhcmstbW9kZSAuYXVkaW9ncmFtLXBhbmVsIHsNCiAgICAgICAgICAgIGJhY2tncm91bmQ6ICMxZTIyMzU7DQogICAgICAgICAgICBib3gtc2hhZG93OiBpbnNldCAwIDJweCAxMHB4IHJnYmEoMCwgMCwgMCwgMC4zKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGNhbnZhcyB7DQogICAgICAgICAgICBkaXNwbGF5OiBibG9jazsNCiAgICAgICAgICAgIHdpZHRoOiAxMDAlOw0KICAgICAgICAgICAgY3Vyc29yOiBjcm9zc2hhaXI7DQogICAgICAgICAgICBib3JkZXItcmFkaXVzOiA4cHg7DQogICAgICAgIH0NCg0KICAgICAgICAvKiAtLS0gVG9vbGJhciAmIExlZ2VuZCAtLS0gKi8NCiAgICAgICAgLnRvb2xiYXIgew0KICAgICAgICAgICAgZGlzcGxheTogZmxleDsNCiAgICAgICAgICAgIGdhcDogMTJweDsNCiAgICAgICAgICAgIHBhZGRpbmc6IDE4cHg7DQogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAxNXB4Ow0KICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogMTVweDsNCiAgICAgICAgICAgIGZsZXgtd3JhcDogd3JhcDsNCiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7DQogICAgICAgICAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsNCiAgICAgICAgICAgIGJveC1zaGFkb3c6IDAgNHB4IDE2cHggcmdiYSgwLCAwLCAwLCAwLjMpOw0KICAgICAgICB9DQoNCiAgICAgICAgYm9keS5saWdodC1tb2RlIC50b29sYmFyIHsNCiAgICAgICAgICAgIGJhY2tncm91bmQ6ICNmOGY5ZmE7DQogICAgICAgIH0NCg0KICAgICAgICBib2R5LmRhcmstbW9kZSAudG9vbGJhciB7DQogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjMmQzMjUwOw0KICAgICAgICB9DQoNCiAgICAgICAgLnRvb2xiYXIgc2VsZWN0LA0KICAgICAgICAudG9vbGJhciBidXR0b24gew0KICAgICAgICAgICAgcGFkZGluZzogMTBweCAxOHB4Ow0KICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogOHB4Ow0KICAgICAgICAgICAgYm9yZGVyOiAxcHggc29saWQgcmdiYSgyNTUsIDI1NSwgMjU1LCAwLjIpOw0KICAgICAgICAgICAgY3Vyc29yOiBwb2ludGVyOw0KICAgICAgICB9DQoNCiAgICAgICAgYm9keS5kYXJrLW1vZGUgLnRvb2xiYXIgc2VsZWN0IHsNCiAgICAgICAgICAgIGJhY2tncm91bmQ6ICM0MjQ3Njk7DQogICAgICAgICAgICBjb2xvcjogI2UwZTBlMDsNCiAgICAgICAgfQ0KDQogICAgICAgIGJvZHkubGlnaHQtbW9kZSAudG9vbGJhciBzZWxlY3Qgew0KICAgICAgICAgICAgYmFja2dyb3VuZDogd2hpdGU7DQogICAgICAgICAgICBjb2xvcjogIzMzMzsNCiAgICAgICAgfQ0KDQogICAgICAgIC5sZWdlbmQgew0KICAgICAgICAgICAgZGlzcGxheTogZmxleDsNCiAgICAgICAgICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOw0KICAgICAgICAgICAgZ2FwOiA0MHB4Ow0KICAgICAgICAgICAgbWFyZ2luLXRvcDogMTVweDsNCiAgICAgICAgICAgIHBhZGRpbmc6IDIwcHg7DQogICAgICAgICAgICBib3JkZXItcmFkaXVzOiAxNXB4Ow0KICAgICAgICB9DQoNCiAgICAgICAgYm9keS5saWdodC1tb2RlIC5sZWdlbmQgew0KICAgICAgICAgICAgYmFja2dyb3VuZDogd2hpdGU7DQogICAgICAgIH0NCg0KICAgICAgICBib2R5LmRhcmstbW9kZSAubGVnZW5kIHsNCiAgICAgICAgICAgIGJhY2tncm91bmQ6ICMyZDMyNTA7DQogICAgICAgIH0NCg0KICAgICAgICAubGVnZW5kLWl0ZW0gew0KICAgICAgICAgICAgZGlzcGxheTogZmxleDsNCiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7DQogICAgICAgICAgICBnYXA6IDEycHg7DQogICAgICAgICAgICBwYWRkaW5nOiA4cHggMTZweDsNCiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDhweDsNCiAgICAgICAgfQ0KDQogICAgICAgIGJvZHkuZGFyay1tb2RlIC5sZWdlbmQtaXRlbSB7DQogICAgICAgICAgICBiYWNrZ3JvdW5kOiByZ2JhKDY2LCA3MSwgMTA1LCAwLjUpOw0KICAgICAgICB9DQoNCiAgICAgICAgYm9keS5saWdodC1tb2RlIC5sZWdlbmQtaXRlbSB7DQogICAgICAgICAgICBiYWNrZ3JvdW5kOiAjZjBmMGYwOw0KICAgICAgICB9DQoNCiAgICAgICAgLmxlZ2VuZC1zeW1ib2wgew0KICAgICAgICAgICAgZm9udC1zaXplOiAyNnB4Ow0KICAgICAgICAgICAgZm9udC13ZWlnaHQ6IGJvbGQ7DQogICAgICAgIH0NCg0KICAgICAgICAucmVkIHsNCiAgICAgICAgICAgIGNvbG9yOiAjZmY2YjZiOw0KICAgICAgICB9DQoNCiAgICAgICAgLmJsdWUgew0KICAgICAgICAgICAgY29sb3I6ICM0ZWNkYzQ7DQogICAgICAgIH0NCg0KICAgICAgICBib2R5LmxpZ2h0LW1vZGUgLnJlZCB7DQogICAgICAgICAgICBjb2xvcjogI2U3NGMzYzsNCiAgICAgICAgfQ0KDQogICAgICAgIGJvZHkubGlnaHQtbW9kZSAuYmx1ZSB7DQogICAgICAgICAgICBjb2xvcjogIzM0OThkYjsNCiAgICAgICAgfQ0KDQogICAgICAgIC5leGFtaW5lci1mb290ZXIgew0KICAgICAgICAgICAgdGV4dC1hbGlnbjogcmlnaHQ7DQogICAgICAgICAgICBwYWRkaW5nOiAxNXB4IDI1cHg7DQogICAgICAgICAgICBtYXJnaW4tdG9wOiAxNXB4Ow0KICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogMTBweDsNCiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTVweDsNCiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA3MDA7DQogICAgICAgIH0NCg0KICAgICAgICBib2R5LmRhcmstbW9kZSAuZXhhbWluZXItZm9vdGVyIHsNCiAgICAgICAgICAgIGJhY2tncm91bmQ6ICMyZDMyNTA7DQogICAgICAgICAgICBjb2xvcjogI2E4ZGFkYzsNCiAgICAgICAgfQ0KDQogICAgICAgIGJvZHkubGlnaHQtbW9kZSAuZXhhbWluZXItZm9vdGVyIHsNCiAgICAgICAgICAgIGJhY2tncm91bmQ6IHdoaXRlOw0KICAgICAgICAgICAgY29sb3I6ICMyYzNlNTA7DQogICAgICAgIH0NCg0KICAgICAgICBAbWVkaWEgcHJpbnQgew0KDQogICAgICAgICAgICAudG9vbGJhciwNCiAgICAgICAgICAgIC50aGVtZS10b2dnbGUsDQogICAgICAgICAgICAubmF2LXBhbmVsIHsNCiAgICAgICAgICAgICAgICBkaXNwbGF5OiBub25lOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBib2R5IHsNCiAgICAgICAgICAgICAgICBiYWNrZ3JvdW5kOiB3aGl0ZSAhaW1wb3J0YW50Ow0KICAgICAgICAgICAgICAgIGNvbG9yOiBibGFjazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgIDwvc3R5bGU+DQo8L2hlYWQ+DQoNCjxib2R5IGNsYXNzPSJkYXJrLW1vZGUiPg0KICAgIDxkaXYgY2xhc3M9ImhlYWRlciI+DQogICAgICAgIDxkaXYgY2xhc3M9ImhlYWRlci10ZXh0Ij4NCiAgICAgICAgICAgIDxoMT7QntCh0J3QntCS0J4g0KPQp9CY0JvQmNCo0KLQlSDQodCeINCg0JXQodCj0KDQodCV0J0g0KbQldCd0KLQkNCgINCa0J7Qp9CeINCg0JDQptCY0J0g0JHQmNCi0J7Qm9CQPC9oMT4NCiAgICAgICAgICAgIDxoMj7QmtCw0LHQuNC90LXRgiDQt9CwINGB0LvRg9GFLCDQs9C+0LLQvtGALCDQs9C70LDRgSwg0LDQu9GC0LXRgNC90LDRgtC40LLQvdCwINC4INCw0YPQs9C80LXQvdGC0LDRgtC40LLQvdCwINC60L7QvNGD0L3QuNC60LDRhtC40ZjQsDwvaDI+DQogICAgICAgIDwvZGl2Pg0KICAgICAgICA8ZGl2IGNsYXNzPSJoZWFkZXItcmlnaHQiPg0KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0idGhlbWUtdG9nZ2xlIiBvbmNsaWNrPSJ0b2dnbGVUaGVtZSgpIiB0aXRsZT0i0KHQvNC10L3QuCDRgtC10LzQsCI+PC9idXR0b24+DQogICAgICAgIDwvZGl2Pg0KICAgIDwvZGl2Pg0KDQogICAgPGRpdiBjbGFzcz0ibmF2LXBhbmVsIj4NCiAgICAgICAgPGRpdiBjbGFzcz0ibmF2LWNvbnRyb2xzIiBzdHlsZT0iZmxleDogMCAwIGF1dG87Ij4NCiAgICAgICAgICAgIDxpbnB1dCB0eXBlPSJmaWxlIiBpZD0iYnVsa1VwbG9hZElucHV0IiBhY2NlcHQ9Ii5qc29uIiBzdHlsZT0iZGlzcGxheTpub25lIg0KICAgICAgICAgICAgICAgIG9uY2hhbmdlPSJoYW5kbGVCdWxrVXBsb2FkKGV2ZW50KSI+DQogICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJuYXYtYnRuIGJ0bi1wcmltYXJ5IiBvbmNsaWNrPSJkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnVsa1VwbG9hZElucHV0JykuY2xpY2soKSI+8J+TgiDQktGH0LjRgtCw0ZgNCiAgICAgICAgICAgICAgICDQkdCw0LfQsCAoSlNPTik8L2J1dHRvbj4NCiAgICAgICAgICAgIDxidXR0b24gY2xhc3M9Im5hdi1idG4gYnRuLXN1Y2Nlc3MiIG9uY2xpY2s9InNhdmVGdWxsRGF0YWJhc2UoKSI+8J+SviDQl9Cw0YfRg9Cy0LDRmCDQptCV0JvQkCDQkdCQ0JfQkDwvYnV0dG9uPg0KICAgICAgICA8L2Rpdj4NCg0KICAgICAgICA8ZGl2IGNsYXNzPSJuYXYtY29udHJvbHMiIHN0eWxlPSJmbGV4OiAxOyBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsiPg0KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0ibmF2LWJ0biBidG4tc2Vjb25kYXJ5IiBvbmNsaWNrPSJwcmV2UmVjb3JkKCkiPuKshe+4jzwvYnV0dG9uPg0KDQogICAgICAgICAgICA8c2VsZWN0IGlkPSJyZWNvcmRTZWxlY3RvciIgY2xhc3M9InJlY29yZC1zZWxlY3RvciIgb25jaGFuZ2U9Imp1bXBUb1JlY29yZCgpIj4NCiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSItMSI+LS0g0JLRh9C40YLQsNGY0YLQtSDQv9C+0LTQsNGC0L7RhtC4IC0tPC9vcHRpb24+DQogICAgICAgICAgICA8L3NlbGVjdD4NCg0KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0ibmF2LWJ0biBidG4tc2Vjb25kYXJ5IiBvbmNsaWNrPSJuZXh0UmVjb3JkKCkiPuKeoe+4jzwvYnV0dG9uPg0KICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0ibmF2LWJ0biBidG4tcHJpbWFyeSIgb25jbGljaz0iYWRkTmV3UmVjb3JkKCkiIHRpdGxlPSLQlNC+0LTQsNGYINC90L7QsiDQv9GA0LDQt9C10L0g0LfQsNC/0LjRgSDQstC+INCx0LDQt9Cw0YLQsCI+4p6VINCd0L7Qsg0KICAgICAgICAgICAgICAgINCX0LDQv9C40YE8L2J1dHRvbj4NCiAgICAgICAgPC9kaXY+DQoNCiAgICAgICAgPGRpdiBjbGFzcz0iY291bnRlci1kaXNwbGF5IiBpZD0icmVjb3JkQ291bnRlciI+MCAvIDA8L2Rpdj4NCiAgICA8L2Rpdj4NCg0KICAgIDxkaXYgY2xhc3M9InN1YmplY3QtaW5mbyI+DQogICAgICAgIDxsYWJlbCBmb3I9InN1YmplY3ROYW1lIj7QmNC80LU6PC9sYWJlbD4NCiAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIGlkPSJzdWJqZWN0TmFtZSIgcGxhY2Vob2xkZXI9ItCY0LzQtSDQvdCwINC40YHQv9C40YLQsNC90LjQuiINCiAgICAgICAgICAgIG9uaW5wdXQ9InVwZGF0ZUN1cnJlbnREYXRhRmllbGQoJ3N1YmplY3ROYW1lJykiPg0KDQogICAgICAgIDxsYWJlbCBmb3I9InRlc3REYXRlIj7QlNCw0YLRg9C8OjwvbGFiZWw+DQogICAgICAgIDxpbnB1dCB0eXBlPSJkYXRlIiBpZD0idGVzdERhdGUiIG9uaW5wdXQ9InVwZGF0ZUN1cnJlbnREYXRhRmllbGQoJ2RhdGUnKSI+DQogICAgPC9kaXY+DQoNCiAgICA8ZGl2IGNsYXNzPSJ0b29sYmFyIj4NCiAgICAgICAgPGxhYmVsPtCj0LLQvjo8L2xhYmVsPg0KICAgICAgICA8c2VsZWN0IGlkPSJlYXJTZWxlY3QiIG9uY2hhbmdlPSJyZWRyYXdBbGwoKSI+DQogICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSJyaWdodCI+0JTQtdGB0L3Qvjwvb3B0aW9uPg0KICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0ibGVmdCI+0JvQtdCy0L48L29wdGlvbj4NCiAgICAgICAgPC9zZWxlY3Q+DQoNCiAgICAgICAgPGxhYmVsPtCi0LXRgdGCOjwvbGFiZWw+DQogICAgICAgIDxzZWxlY3QgaWQ9InRlc3RUeXBlU2VsZWN0IiBvbmNoYW5nZT0icmVkcmF3QWxsKCkiPg0KICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iYWlyIj7QktC+0LfQtNGD0YjQvdCwINC/0YDQvtCy0L7QtNC90L7RgdGCIChBQyk8L29wdGlvbj4NCiAgICAgICAgICAgIDxvcHRpb24gdmFsdWU9ImJvbmUiPtCa0L7RgdC60LXQvdCwINC/0YDQvtCy0L7QtNC90L7RgdGCIChCQyk8L29wdGlvbj4NCiAgICAgICAgPC9zZWxlY3Q+DQoNCiAgICAgICAgPGJ1dHRvbiBvbmNsaWNrPSJjbGVhckN1cnJlbnRSZWNvcmQoKSI+8J+Xke+4jyDQmNGB0YfQuNGB0YLQuCDRgtC10LrQvtCy0LXQvTwvYnV0dG9uPg0KICAgICAgICA8YnV0dG9uIG9uY2xpY2s9InVwZGF0ZUN1cnJlbnRSZWNvcmQoKSIgY2xhc3M9ImJ0bi1wcmltYXJ5IiBzdHlsZT0iYmFja2dyb3VuZC1jb2xvcjogI2YzOWMxMjsiPvCfkr4g0JDQttGD0YDQuNGA0LDRmA0KICAgICAgICAgICAgKNCi0LXQutC+0LLQtdC9KTwvYnV0dG9uPg0KICAgICAgICA8YnV0dG9uIG9uY2xpY2s9ImRlbGV0ZVJlY29yZCgpIiBjbGFzcz0iYnRuLWRhbmdlciIgc3R5bGU9ImJhY2tncm91bmQtY29sb3I6ICNjMDM5MmI7Ij7inYwg0JjQt9Cx0YDQuNGI0Lgg0JfQsNC/0LjRgTwvYnV0dG9uPg0KICAgICAgICA8YnV0dG9uIG9uY2xpY2s9ImV4cG9ydFNpbmdsZSgpIj7wn5K+INCX0LDRh9GD0LLQsNGYICjQldC00LXQvSk8L2J1dHRvbj4NCiAgICAgICAgPGJ1dHRvbiBvbmNsaWNrPSJleHBvcnRBc0ltYWdlKCkiPvCfk7gg0KHQu9C40LrQsCAo0JXQtNC10L0pPC9idXR0b24+DQogICAgICAgIDxidXR0b24gb25jbGljaz0iZXhwb3J0SGlzdG9yeUltYWdlcygpIiBjbGFzcz0iYnRuLXByaW1hcnkiIHN0eWxlPSJiYWNrZ3JvdW5kOiAjOGU0NGFkOyI+8J+TuCDQmNGB0YLQvtGA0LjRmNCwDQogICAgICAgICAgICAo0KHQuNGC0LUpPC9idXR0b24+DQogICAgPC9kaXY+DQoNCiAgICA8ZGl2IGNsYXNzPSJtYWluLWNvbnRhaW5lciI+DQogICAgICAgIDxkaXYgY2xhc3M9ImF1ZGlvZ3JhbS1wYW5lbCBsZWZ0Ij4NCiAgICAgICAgICAgIDxjYW52YXMgaWQ9InJpZ2h0Q2FudmFzIiB3aWR0aD0iOTAwIiBoZWlnaHQ9IjY1MCI+PC9jYW52YXM+DQogICAgICAgIDwvZGl2Pg0KICAgICAgICA8ZGl2IGNsYXNzPSJhdWRpb2dyYW0tcGFuZWwgcmlnaHQiPg0KICAgICAgICAgICAgPGNhbnZhcyBpZD0ibGVmdENhbnZhcyIgd2lkdGg9IjkwMCIgaGVpZ2h0PSI2NTAiPjwvY2FudmFzPg0KICAgICAgICA8L2Rpdj4NCiAgICA8L2Rpdj4NCg0KICAgIDxkaXYgY2xhc3M9ImxlZ2VuZCI+DQogICAgICAgIDxkaXYgY2xhc3M9ImxlZ2VuZC1pdGVtIj4NCiAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJsZWdlbmQtc3ltYm9sIHJlZCI+4peLPC9zcGFuPiA8c3Bhbj48c3Ryb25nPlI8L3N0cm9uZz4g4pa2IDxzdHJvbmc+TDwvc3Ryb25nPiAoQUMpPC9zcGFuPg0KICAgICAgICA8L2Rpdj4NCiAgICAgICAgPGRpdiBjbGFzcz0ibGVnZW5kLWl0ZW0iPg0KICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImxlZ2VuZC1zeW1ib2wgcmVkIj4mbHQ7PC9zcGFuPiA8c3Bhbj48c3Ryb25nPlI8L3N0cm9uZz4g4pa2IDxzdHJvbmc+TDwvc3Ryb25nPiAoQkMpPC9zcGFuPg0KICAgICAgICA8L2Rpdj4NCiAgICAgICAgPGRpdiBjbGFzcz0ibGVnZW5kLWl0ZW0iPg0KICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImxlZ2VuZC1zeW1ib2wgYmx1ZSI+4pyVPC9zcGFuPiA8c3Bhbj48c3Ryb25nPlI8L3N0cm9uZz4g4peAIDxzdHJvbmc+TDwvc3Ryb25nPiAoQUMpPC9zcGFuPg0KICAgICAgICA8L2Rpdj4NCiAgICAgICAgPGRpdiBjbGFzcz0ibGVnZW5kLWl0ZW0iPg0KICAgICAgICAgICAgPHNwYW4gY2xhc3M9ImxlZ2VuZC1zeW1ib2wgYmx1ZSI+Wzwvc3Bhbj4gPHNwYW4+PHN0cm9uZz5SPC9zdHJvbmc+IOKXgCA8c3Ryb25nPkw8L3N0cm9uZz4gKEJDKTwvc3Bhbj4NCiAgICAgICAgPC9kaXY+DQogICAgPC9kaXY+DQoNCiAgICA8ZGl2IGNsYXNzPSJleGFtaW5lci1mb290ZXIiPg0KICAgICAgICA8c3Ryb25nPtC00LjQv9C7LiDQtNC10YQuINCR0LvQsNCz0L7RmCDQndCw0YHQtdCyPC9zdHJvbmc+DQogICAgPC9kaXY+DQoNCiAgICA8c2NyaXB0Pg0KICAgICAgICAvLyAtLS0gREFUQSBNQU5BR0VNRU5UIC0tLQ0KICAgICAgICBsZXQgYWxsUmVjb3JkcyA9IFtdOw0KICAgICAgICBsZXQgY3VycmVudEluZGV4ID0gLTE7DQoNCiAgICAgICAgLy8gQ3VycmVudCB3b3JraW5nIHJlY29yZA0KICAgICAgICBjb25zdCBkYXRhID0gew0KICAgICAgICAgICAgcmlnaHRBaXI6IHt9LCByaWdodEJvbmU6IHt9LA0KICAgICAgICAgICAgbGVmdEFpcjoge30sIGxlZnRCb25lOiB7fSwNCiAgICAgICAgICAgIHN1YmplY3ROYW1lOiAnJywgZGF0ZTogJycNCiAgICAgICAgfTsNCg0KICAgICAgICBjb25zdCBmcmVxdWVuY2llcyA9IFsxMjUsIDI1MCwgNTAwLCA3NTAsIDEwMDAsIDE1MDAsIDIwMDAsIDMwMDAsIDQwMDAsIDYwMDAsIDgwMDBdOw0KICAgICAgICBjb25zdCBtaW5EQiA9IDAsIG1heERCID0gMTIwOw0KICAgICAgICBjb25zdCBtYXJnaW4gPSB7IHRvcDogNjAsIHJpZ2h0OiA3MCwgYm90dG9tOiA4MCwgbGVmdDogMTEwIH07DQoNCiAgICAgICAgY29uc3QgbGVmdENhbnZhcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdsZWZ0Q2FudmFzJyk7DQogICAgICAgIGNvbnN0IHJpZ2h0Q2FudmFzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JpZ2h0Q2FudmFzJyk7DQogICAgICAgIGNvbnN0IGxlZnRDdHggPSBsZWZ0Q2FudmFzLmdldENvbnRleHQoJzJkJyk7DQogICAgICAgIGNvbnN0IHJpZ2h0Q3R4ID0gcmlnaHRDYW52YXMuZ2V0Q29udGV4dCgnMmQnKTsNCg0KICAgICAgICAvLyAtLS0gQlVMSyBOQVZJR0FUSU9OIEZVTkNUSU9OUyAtLS0NCg0KICAgICAgICBmdW5jdGlvbiBoYW5kbGVCdWxrVXBsb2FkKGV2ZW50KSB7DQogICAgICAgICAgICBjb25zdCBmaWxlID0gZXZlbnQudGFyZ2V0LmZpbGVzWzBdOw0KICAgICAgICAgICAgaWYgKCFmaWxlKSByZXR1cm47DQoNCiAgICAgICAgICAgIGNvbnN0IHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7DQogICAgICAgICAgICByZWFkZXIub25sb2FkID0gKGUpID0+IHsNCiAgICAgICAgICAgICAgICB0cnkgew0KICAgICAgICAgICAgICAgICAgICBjb25zdCBqc29uID0gSlNPTi5wYXJzZShlLnRhcmdldC5yZXN1bHQpOw0KDQogICAgICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGpzb24pKSB7DQogICAgICAgICAgICAgICAgICAgICAgICBhbGxSZWNvcmRzID0ganNvbjsNCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhbGxSZWNvcmRzLmxlbmd0aCA+IDApIHsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50SW5kZXggPSAwOw0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvcHVsYXRlRHJvcGRvd24oKTsNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2FkUmVjb3JkKDApOw0KICAgICAgICAgICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICAgICAgLy8gSGFuZGxlIHNpbmdsZSBmaWxlIHVwbG9hZCBsZWdhY3kgd2F5DQogICAgICAgICAgICAgICAgICAgICAgICBhbGxSZWNvcmRzID0gW2pzb25dOw0KICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudEluZGV4ID0gMDsNCiAgICAgICAgICAgICAgICAgICAgICAgIHBvcHVsYXRlRHJvcGRvd24oKTsNCiAgICAgICAgICAgICAgICAgICAgICAgIGxvYWRSZWNvcmQoMCk7DQogICAgICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnJvcikgew0KICAgICAgICAgICAgICAgICAgICBhbGVydCgn0JPRgNC10YjQutCwINC/0YDQuCDRh9C40YLQsNGa0LUg0L3QsCDRhNCw0ZjQu9C+0YI6ICcgKyBlcnJvci5tZXNzYWdlKTsNCiAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9Ow0KICAgICAgICAgICAgcmVhZGVyLnJlYWRBc1RleHQoZmlsZSk7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBwb3B1bGF0ZURyb3Bkb3duKCkgew0KICAgICAgICAgICAgY29uc3Qgc2VsZWN0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JlY29yZFNlbGVjdG9yJyk7DQogICAgICAgICAgICBzZWxlY3QuaW5uZXJIVE1MID0gJyc7DQoNCiAgICAgICAgICAgIGlmIChhbGxSZWNvcmRzLmxlbmd0aCA9PT0gMCkgew0KICAgICAgICAgICAgICAgIGNvbnN0IG9wdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGlvbicpOw0KICAgICAgICAgICAgICAgIG9wdC50ZXh0ID0gIi0tINCd0LXQvNCwINC/0L7QtNCw0YLQvtGG0LggLS0iOw0KICAgICAgICAgICAgICAgIHNlbGVjdC5hcHBlbmRDaGlsZChvcHQpOw0KICAgICAgICAgICAgICAgIHJldHVybjsNCiAgICAgICAgICAgIH0NCg0KICAgICAgICAgICAgYWxsUmVjb3Jkcy5mb3JFYWNoKChyZWMsIGluZGV4KSA9PiB7DQogICAgICAgICAgICAgICAgY29uc3Qgb3B0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnb3B0aW9uJyk7DQogICAgICAgICAgICAgICAgb3B0LnZhbHVlID0gaW5kZXg7DQogICAgICAgICAgICAgICAgLy8gRm9ybWF0OiAiMS4gTmFtZSAoRGF0ZSkiDQogICAgICAgICAgICAgICAgY29uc3QgZGF0ZVN0ciA9IHJlYy5kYXRlID8gYCAoJHtyZWMuZGF0ZX0pYCA6ICcnOw0KICAgICAgICAgICAgICAgIG9wdC50ZXh0ID0gYCR7aW5kZXggKyAxfS4gJHtyZWMuc3ViamVjdE5hbWUgfHwgJ9Cd0LXQv9C+0LfQvdCw0YInfSR7ZGF0ZVN0cn1gOw0KICAgICAgICAgICAgICAgIHNlbGVjdC5hcHBlbmRDaGlsZChvcHQpOw0KICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgIHVwZGF0ZUNvdW50ZXIoKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIGxvYWRSZWNvcmQoaW5kZXgpIHsNCiAgICAgICAgICAgIGlmIChpbmRleCA8IDAgfHwgaW5kZXggPj0gYWxsUmVjb3Jkcy5sZW5ndGgpIHJldHVybjsNCg0KICAgICAgICAgICAgY3VycmVudEluZGV4ID0gaW5kZXg7DQogICAgICAgICAgICBjb25zdCByZWNvcmQgPSBhbGxSZWNvcmRzW2luZGV4XTsNCg0KICAgICAgICAgICAgLy8gRGVlcCBjb3B5IHRvIGN1cnJlbnQgZGF0YSBvYmplY3QNCiAgICAgICAgICAgIGRhdGEucmlnaHRBaXIgPSByZWNvcmQucmlnaHRBaXIgfHwge307DQogICAgICAgICAgICBkYXRhLnJpZ2h0Qm9uZSA9IHJlY29yZC5yaWdodEJvbmUgfHwge307DQogICAgICAgICAgICBkYXRhLmxlZnRBaXIgPSByZWNvcmQubGVmdEFpciB8fCB7fTsNCiAgICAgICAgICAgIGRhdGEubGVmdEJvbmUgPSByZWNvcmQubGVmdEJvbmUgfHwge307DQogICAgICAgICAgICBkYXRhLnN1YmplY3ROYW1lID0gcmVjb3JkLnN1YmplY3ROYW1lIHx8ICcnOw0KICAgICAgICAgICAgZGF0YS5kYXRlID0gcmVjb3JkLmRhdGUgfHwgJyc7DQoNCiAgICAgICAgICAgIC8vIFVwZGF0ZSBVSSBJbnB1dHMNCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdWJqZWN0TmFtZScpLnZhbHVlID0gZGF0YS5zdWJqZWN0TmFtZTsNCiAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0ZXN0RGF0ZScpLnZhbHVlID0gZGF0YS5kYXRlOw0KDQogICAgICAgICAgICAvLyBTeW5jIERyb3Bkb3duDQogICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVjb3JkU2VsZWN0b3InKS52YWx1ZSA9IGluZGV4Ow0KDQogICAgICAgICAgICB1cGRhdGVDb3VudGVyKCk7DQogICAgICAgICAgICByZWRyYXdBbGwoKTsNCiAgICAgICAgfQ0KDQogICAgICAgIC8vIC0tLSBORVcgRkVBVFVSRVMgLS0tDQoNCiAgICAgICAgZnVuY3Rpb24gdXBkYXRlQ3VycmVudFJlY29yZCgpIHsNCiAgICAgICAgICAgIGlmIChjdXJyZW50SW5kZXggPT09IC0xKSB7DQogICAgICAgICAgICAgICAgYWxlcnQoItCd0LXQvNCwINCy0YfQuNGC0LDQvdC+INC30LDQv9C40YEg0LfQsCDQsNC20YPRgNC40YDQsNGa0LUuIik7DQogICAgICAgICAgICAgICAgcmV0dXJuOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvLyBFeHBsaWNpdGx5IHN5bmMgY3VycmVudCAnZGF0YScgdG8gJ2FsbFJlY29yZHNbY3VycmVudEluZGV4XScNCiAgICAgICAgICAgIGNvbnN0IHJlYyA9IGFsbFJlY29yZHNbY3VycmVudEluZGV4XTsNCiAgICAgICAgICAgIHJlYy5zdWJqZWN0TmFtZSA9IGRhdGEuc3ViamVjdE5hbWU7DQogICAgICAgICAgICByZWMuZGF0ZSA9IGRhdGEuZGF0ZTsNCg0KICAgICAgICAgICAgLy8gRGVlcCBjb3B5IHRvIGVuc3VyZSBpc29sYXRpb24NCiAgICAgICAgICAgIHJlYy5yaWdodEFpciA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZGF0YS5yaWdodEFpcikpOw0KICAgICAgICAgICAgcmVjLnJpZ2h0Qm9uZSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZGF0YS5yaWdodEJvbmUpKTsNCiAgICAgICAgICAgIHJlYy5sZWZ0QWlyID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShkYXRhLmxlZnRBaXIpKTsNCiAgICAgICAgICAgIHJlYy5sZWZ0Qm9uZSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZGF0YS5sZWZ0Qm9uZSkpOw0KDQogICAgICAgICAgICAvLyBSZWZyZXNoIFVJIGp1c3QgaW4gY2FzZQ0KICAgICAgICAgICAgcG9wdWxhdGVEcm9wZG93bigpOw0KICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JlY29yZFNlbGVjdG9yJykudmFsdWUgPSBjdXJyZW50SW5kZXg7DQoNCiAgICAgICAgICAgIGFsZXJ0KCLinIUg0JfQsNC/0LjRgdC+0YIg0LUg0YPRgdC/0LXRiNC90L4g0LDQttGD0YDQuNGA0LDQvSEgKNCh0LXQs9CwINC80L7QttC10YLQtSDQtNCwINGY0LAg0LfQsNGH0YPQstCw0YLQtSDRhtC10LvQsNGC0LAg0LHQsNC30LApIik7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBhZGROZXdSZWNvcmQoKSB7DQogICAgICAgICAgICBjb25zdCBuZXdSZWNvcmQgPSB7DQogICAgICAgICAgICAgICAgc3ViamVjdE5hbWU6ICLQndC+0LIg0JjRgdC/0LjRgtCw0L3QuNC6IiwNCiAgICAgICAgICAgICAgICBkYXRlOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkuc3BsaXQoJ1QnKVswXSwNCiAgICAgICAgICAgICAgICByaWdodEFpcjoge30sIHJpZ2h0Qm9uZToge30sDQogICAgICAgICAgICAgICAgbGVmdEFpcjoge30sIGxlZnRCb25lOiB7fQ0KICAgICAgICAgICAgfTsNCiAgICAgICAgICAgIGFsbFJlY29yZHMucHVzaChuZXdSZWNvcmQpOw0KICAgICAgICAgICAgY3VycmVudEluZGV4ID0gYWxsUmVjb3Jkcy5sZW5ndGggLSAxOw0KICAgICAgICAgICAgcG9wdWxhdGVEcm9wZG93bigpOw0KICAgICAgICAgICAgbG9hZFJlY29yZChjdXJyZW50SW5kZXgpOw0KICAgICAgICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N1YmplY3ROYW1lJykuc2VsZWN0KCk7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBkZWxldGVSZWNvcmQoKSB7DQogICAgICAgICAgICBpZiAoY3VycmVudEluZGV4ID09PSAtMSkgcmV0dXJuOw0KICAgICAgICAgICAgaWYgKGNvbmZpcm0oYNCU0LDQu9C4INGB0YLQtSDRgdC40LPRg9GA0L3QuCDQtNC10LrQsCDRgdCw0LrQsNGC0LUg0LTQsCDQs9C+INC40LfQsdGA0LjRiNC10YLQtSDQt9Cw0L/QuNGB0L7RgiDQt9CwOiAke2RhdGEuc3ViamVjdE5hbWV9P2ApKSB7DQogICAgICAgICAgICAgICAgYWxsUmVjb3Jkcy5zcGxpY2UoY3VycmVudEluZGV4LCAxKTsNCiAgICAgICAgICAgICAgICBpZiAoYWxsUmVjb3Jkcy5sZW5ndGggPiAwKSB7DQogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRJbmRleCA9IE1hdGgubWF4KDAsIGN1cnJlbnRJbmRleCAtIDEpOw0KICAgICAgICAgICAgICAgICAgICBwb3B1bGF0ZURyb3Bkb3duKCk7DQogICAgICAgICAgICAgICAgICAgIGxvYWRSZWNvcmQoY3VycmVudEluZGV4KTsNCiAgICAgICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgICAgICBjdXJyZW50SW5kZXggPSAtMTsNCiAgICAgICAgICAgICAgICAgICAgZGF0YS5zdWJqZWN0TmFtZSA9ICcnOyBkYXRhLmRhdGUgPSAnJzsNCiAgICAgICAgICAgICAgICAgICAgZGF0YS5yaWdodEFpciA9IHt9OyBkYXRhLnJpZ2h0Qm9uZSA9IHt9Ow0KICAgICAgICAgICAgICAgICAgICBkYXRhLmxlZnRBaXIgPSB7fTsgZGF0YS5sZWZ0Qm9uZSA9IHt9Ow0KICAgICAgICAgICAgICAgICAgICBwb3B1bGF0ZURyb3Bkb3duKCk7DQogICAgICAgICAgICAgICAgICAgIHJlZHJhd0FsbCgpOw0KICAgICAgICAgICAgICAgICAgICB1cGRhdGVDb3VudGVyKCk7DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgZnVuY3Rpb24gc2F2ZUZ1bGxEYXRhYmFzZSgpIHsNCiAgICAgICAgICAgIGlmIChhbGxSZWNvcmRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIGFsZXJ0KCLQkdCw0LfQsNGC0LAg0LUg0L/RgNCw0LfQvdCwLiIpOw0KICAgICAgICAgICAgY29uc3QganNvbiA9IEpTT04uc3RyaW5naWZ5KGFsbFJlY29yZHMsIG51bGwsIDIpOw0KICAgICAgICAgICAgY29uc3QgYmxvYiA9IG5ldyBCbG9iKFtqc29uXSwgeyB0eXBlOiAnYXBwbGljYXRpb24vanNvbicgfSk7DQogICAgICAgICAgICBjb25zdCB1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpOw0KICAgICAgICAgICAgY29uc3QgYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsNCiAgICAgICAgICAgIGEuaHJlZiA9IHVybDsNCiAgICAgICAgICAgIGEuZG93bmxvYWQgPSAnQVVESU9HUkFNSV9CQVpBXycgKyBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkuc2xpY2UoMCwgMTApICsgJy5qc29uJzsNCiAgICAgICAgICAgIGEuY2xpY2soKTsNCiAgICAgICAgICAgIFVSTC5yZXZva2VPYmplY3RVUkwodXJsKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIG5leHRSZWNvcmQoKSB7DQogICAgICAgICAgICBpZiAoY3VycmVudEluZGV4IDwgYWxsUmVjb3Jkcy5sZW5ndGggLSAxKSB7DQogICAgICAgICAgICAgICAgbG9hZFJlY29yZChjdXJyZW50SW5kZXggKyAxKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIHByZXZSZWNvcmQoKSB7DQogICAgICAgICAgICBpZiAoY3VycmVudEluZGV4ID4gMCkgew0KICAgICAgICAgICAgICAgIGxvYWRSZWNvcmQoY3VycmVudEluZGV4IC0gMSk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBqdW1wVG9SZWNvcmQoKSB7DQogICAgICAgICAgICBjb25zdCBzZWxlY3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVjb3JkU2VsZWN0b3InKTsNCiAgICAgICAgICAgIGxvYWRSZWNvcmQocGFyc2VJbnQoc2VsZWN0LnZhbHVlKSk7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVDb3VudGVyKCkgew0KICAgICAgICAgICAgY29uc3QgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVjb3JkQ291bnRlcicpOw0KICAgICAgICAgICAgaWYgKGFsbFJlY29yZHMubGVuZ3RoID09PSAwKSB7DQogICAgICAgICAgICAgICAgZWwuaW5uZXJUZXh0ID0gIjAgLyAwIjsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgICAgZWwuaW5uZXJUZXh0ID0gYCR7Y3VycmVudEluZGV4ICsgMX0gLyAke2FsbFJlY29yZHMubGVuZ3RofWA7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiB1cGRhdGVDdXJyZW50RGF0YUZpZWxkKGZpZWxkKSB7DQogICAgICAgICAgICBjb25zdCB2YWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChmaWVsZCA9PT0gJ3N1YmplY3ROYW1lJyA/ICdzdWJqZWN0TmFtZScgOiAndGVzdERhdGUnKS52YWx1ZTsNCiAgICAgICAgICAgIGRhdGFbZmllbGRdID0gdmFsOw0KDQogICAgICAgICAgICAvLyBVcGRhdGUgdGhlIGFycmF5IGluIG1lbW9yeSBzbyBjaGFuZ2VzIGFyZW4ndCBsb3N0IHdoZW4gbmF2aWdhdGluZw0KICAgICAgICAgICAgaWYgKGN1cnJlbnRJbmRleCA+PSAwICYmIGFsbFJlY29yZHNbY3VycmVudEluZGV4XSkgew0KICAgICAgICAgICAgICAgIGFsbFJlY29yZHNbY3VycmVudEluZGV4XVtmaWVsZF0gPSB2YWw7DQogICAgICAgICAgICAgICAgLy8gVXBkYXRlIGRyb3Bkb3duIHRleHQgaWYgbmFtZSBjaGFuZ2VkDQogICAgICAgICAgICAgICAgaWYgKGZpZWxkID09PSAnc3ViamVjdE5hbWUnIHx8IGZpZWxkID09PSAnZGF0ZScpIHBvcHVsYXRlRHJvcGRvd24oKTsNCiAgICAgICAgICAgICAgICAvLyBSZXN0b3JlIHNlbGVjdGlvbg0KICAgICAgICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdyZWNvcmRTZWxlY3RvcicpLnZhbHVlID0gY3VycmVudEluZGV4Ow0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgcmVkcmF3QWxsKCk7DQogICAgICAgIH0NCg0KICAgICAgICAvLyAtLS0gRFJBV0lORyBGVU5DVElPTlMgKFN0YW5kYXJkKSAtLS0NCg0KICAgICAgICBmdW5jdGlvbiB0b2dnbGVUaGVtZSgpIHsNCiAgICAgICAgICAgIGNvbnN0IGJvZHkgPSBkb2N1bWVudC5ib2R5Ow0KICAgICAgICAgICAgaWYgKGJvZHkuY2xhc3NMaXN0LmNvbnRhaW5zKCdkYXJrLW1vZGUnKSkgew0KICAgICAgICAgICAgICAgIGJvZHkuY2xhc3NMaXN0LnJlbW92ZSgnZGFyay1tb2RlJyk7DQogICAgICAgICAgICAgICAgYm9keS5jbGFzc0xpc3QuYWRkKCdsaWdodC1tb2RlJyk7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIGJvZHkuY2xhc3NMaXN0LnJlbW92ZSgnbGlnaHQtbW9kZScpOw0KICAgICAgICAgICAgICAgIGJvZHkuY2xhc3NMaXN0LmFkZCgnZGFyay1tb2RlJyk7DQogICAgICAgICAgICB9DQogICAgICAgICAgICByZWRyYXdBbGwoKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIGlzRGFya01vZGUoKSB7IHJldHVybiBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5jb250YWlucygnZGFyay1tb2RlJyk7IH0NCg0KICAgICAgICBmdW5jdGlvbiBkcmF3QXVkaW9ncmFtKGNhbnZhcywgY3R4LCBzaG93UmlnaHQpIHsNCiAgICAgICAgICAgIGNvbnN0IGRhcmsgPSBpc0RhcmtNb2RlKCk7DQogICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gZGFyayA/ICcjMWUyMjM1JyA6ICcjZmZmZmZmJzsNCiAgICAgICAgICAgIGN0eC5maWxsUmVjdCgwLCAwLCBjYW52YXMud2lkdGgsIGNhbnZhcy5oZWlnaHQpOw0KDQogICAgICAgICAgICBjb25zdCBwbG90V2lkdGggPSBjYW52YXMud2lkdGggLSBtYXJnaW4ubGVmdCAtIG1hcmdpbi5yaWdodDsNCiAgICAgICAgICAgIGNvbnN0IHBsb3RIZWlnaHQgPSBjYW52YXMuaGVpZ2h0IC0gbWFyZ2luLnRvcCAtIG1hcmdpbi5ib3R0b207DQoNCiAgICAgICAgICAgIC8vIFRpdGxlDQogICAgICAgICAgICBjdHguZm9udCA9ICdib2xkIDI2cHggQXJpYWwnOw0KICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGRhcmsgPyAnI2UwZTBlMCcgOiAnIzJjM2U1MCc7DQogICAgICAgICAgICBjdHgudGV4dEFsaWduID0gJ2NlbnRlcic7DQogICAgICAgICAgICBjdHguZmlsbFRleHQoJ2RCIEhMJywgY2FudmFzLndpZHRoIC8gMiwgNDApOw0KDQogICAgICAgICAgICBkcmF3R3JpZChjdHgsIHBsb3RXaWR0aCwgcGxvdEhlaWdodCwgZGFyayk7DQogICAgICAgICAgICBkcmF3TGFiZWxzKGN0eCwgcGxvdFdpZHRoLCBwbG90SGVpZ2h0LCBkYXJrKTsNCg0KICAgICAgICAgICAgY29uc3QgcmVkQ29sb3IgPSBkYXJrID8gJyNmZjZiNmInIDogJyNlNzRjM2MnOw0KICAgICAgICAgICAgY29uc3QgYmx1ZUNvbG9yID0gZGFyayA/ICcjNUI5QkQ1JyA6ICcjMzQ5OGRiJzsNCg0KICAgICAgICAgICAgaWYgKHNob3dSaWdodCkgew0KICAgICAgICAgICAgICAgIGRyYXdEYXRhU2V0KGN0eCwgZGF0YS5yaWdodEFpciwgcGxvdFdpZHRoLCBwbG90SGVpZ2h0LCByZWRDb2xvciwgJ2NpcmNsZScsIGRhcmspOw0KICAgICAgICAgICAgICAgIGRyYXdEYXRhU2V0KGN0eCwgZGF0YS5yaWdodEJvbmUsIHBsb3RXaWR0aCwgcGxvdEhlaWdodCwgcmVkQ29sb3IsICdsZXNzJywgZGFyayk7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIGRyYXdEYXRhU2V0KGN0eCwgZGF0YS5sZWZ0QWlyLCBwbG90V2lkdGgsIHBsb3RIZWlnaHQsIGJsdWVDb2xvciwgJ3gnLCBkYXJrKTsNCiAgICAgICAgICAgICAgICBkcmF3RGF0YVNldChjdHgsIGRhdGEubGVmdEJvbmUsIHBsb3RXaWR0aCwgcGxvdEhlaWdodCwgYmx1ZUNvbG9yLCAnYnJhY2tldCcsIGRhcmspOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgZnVuY3Rpb24gZHJhd0dyaWQoY3R4LCBwbG90V2lkdGgsIHBsb3RIZWlnaHQsIGRhcmspIHsNCiAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9IGRhcmsgPyAnI2E4ZGFkYycgOiAnIzMzMyc7DQogICAgICAgICAgICBjdHgubGluZVdpZHRoID0gMzsNCiAgICAgICAgICAgIGN0eC5zdHJva2VSZWN0KG1hcmdpbi5sZWZ0LCBtYXJnaW4udG9wLCBwbG90V2lkdGgsIHBsb3RIZWlnaHQpOw0KDQogICAgICAgICAgICBjb25zdCBwYWRkaW5nID0gcGxvdFdpZHRoICogMC4wNTsNCiAgICAgICAgICAgIGNvbnN0IHVzYWJsZVdpZHRoID0gcGxvdFdpZHRoIC0gKHBhZGRpbmcgKiAyKTsNCg0KICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IDE7DQogICAgICAgICAgICBmcmVxdWVuY2llcy5mb3JFYWNoKChmcmVxLCBpKSA9PiB7DQogICAgICAgICAgICAgICAgY29uc3QgeCA9IG1hcmdpbi5sZWZ0ICsgcGFkZGluZyArIChpICogdXNhYmxlV2lkdGggLyAoZnJlcXVlbmNpZXMubGVuZ3RoIC0gMSkpOw0KICAgICAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9IGRhcmsgPyAncmdiYSgxNjgsIDIxOCwgMjIwLCAwLjIpJyA6ICdyZ2JhKDAsIDAsIDAsIDAuMSknOw0KICAgICAgICAgICAgICAgIGN0eC5iZWdpblBhdGgoKTsgY3R4Lm1vdmVUbyh4LCBtYXJnaW4udG9wICsgMSk7IGN0eC5saW5lVG8oeCwgbWFyZ2luLnRvcCArIHBsb3RIZWlnaHQgLSAxKTsgY3R4LnN0cm9rZSgpOw0KICAgICAgICAgICAgfSk7DQoNCiAgICAgICAgICAgIGZvciAobGV0IGRiID0gbWluREI7IGRiIDw9IG1heERCOyBkYiArPSAxMCkgew0KICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBnZXRZUG9zaXRpb24oZGIsIHBsb3RIZWlnaHQpOw0KICAgICAgICAgICAgICAgIGNvbnN0IGlzTWFqb3IgPSBkYiAlIDIwID09PSAwOw0KICAgICAgICAgICAgICAgIGN0eC5zdHJva2VTdHlsZSA9IGRhcmsNCiAgICAgICAgICAgICAgICAgICAgPyAoaXNNYWpvciA/ICdyZ2JhKDE2OCwgMjE4LCAyMjAsIDAuNCknIDogJ3JnYmEoMTY4LCAyMTgsIDIyMCwgMC4xNSknKQ0KICAgICAgICAgICAgICAgICAgICA6IChpc01ham9yID8gJ3JnYmEoMCwgMCwgMCwgMC4zKScgOiAncmdiYSgwLCAwLCAwLCAwLjEpJyk7DQogICAgICAgICAgICAgICAgY3R4LmxpbmVXaWR0aCA9IGlzTWFqb3IgPyAxLjUgOiAxOw0KICAgICAgICAgICAgICAgIGlmIChkYiA+IG1pbkRCICYmIGRiIDwgbWF4REIpIHsNCiAgICAgICAgICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOyBjdHgubW92ZVRvKG1hcmdpbi5sZWZ0ICsgMSwgeSk7IGN0eC5saW5lVG8obWFyZ2luLmxlZnQgKyBwbG90V2lkdGggLSAxLCB5KTsgY3R4LnN0cm9rZSgpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIGRyYXdMYWJlbHMoY3R4LCBwbG90V2lkdGgsIHBsb3RIZWlnaHQsIGRhcmspIHsNCiAgICAgICAgICAgIGN0eC5mb250ID0gJzE2cHggQXJpYWwnOw0KICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9IGRhcmsgPyAnI2UwZTBlMCcgOiAnIzMzMyc7DQogICAgICAgICAgICBjb25zdCBwYWRkaW5nID0gcGxvdFdpZHRoICogMC4wNTsNCiAgICAgICAgICAgIGNvbnN0IHVzYWJsZVdpZHRoID0gcGxvdFdpZHRoIC0gKHBhZGRpbmcgKiAyKTsNCg0KICAgICAgICAgICAgZnJlcXVlbmNpZXMuZm9yRWFjaCgoZnJlcSwgaSkgPT4gew0KICAgICAgICAgICAgICAgIGNvbnN0IHggPSBtYXJnaW4ubGVmdCArIHBhZGRpbmcgKyAoaSAqIHVzYWJsZVdpZHRoIC8gKGZyZXF1ZW5jaWVzLmxlbmd0aCAtIDEpKTsNCiAgICAgICAgICAgICAgICBjb25zdCBsYWJlbCA9IGZyZXEgPj0gMTAwMCA/IChmcmVxIC8gMTAwMCkudG9TdHJpbmcoKS5yZXBsYWNlKCcuJywgJywnKSArICdrJyA6IGZyZXEudG9TdHJpbmcoKTsNCiAgICAgICAgICAgICAgICBjdHgudGV4dEFsaWduID0gJ2NlbnRlcic7IGN0eC5maWxsVGV4dChsYWJlbCArICcgSHonLCB4LCBtYXJnaW4udG9wICsgcGxvdEhlaWdodCArIDM1KTsNCiAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICBmb3IgKGxldCBkYiA9IG1pbkRCOyBkYiA8PSBtYXhEQjsgZGIgKz0gMTApIHsNCiAgICAgICAgICAgICAgICBjb25zdCB5ID0gZ2V0WVBvc2l0aW9uKGRiLCBwbG90SGVpZ2h0KTsNCiAgICAgICAgICAgICAgICBjdHgudGV4dEFsaWduID0gJ3JpZ2h0JzsgY3R4LmZpbGxUZXh0KGRiLnRvU3RyaW5nKCksIG1hcmdpbi5sZWZ0IC0gMTgsIHkgKyA2KTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIGRyYXdEYXRhU2V0KGN0eCwgZGF0YXNldCwgcGxvdFdpZHRoLCBwbG90SGVpZ2h0LCBjb2xvciwgc3ltYm9sLCBkYXJrKSB7DQogICAgICAgICAgICBjb25zdCBwb2ludHMgPSBPYmplY3Qua2V5cyhkYXRhc2V0KS5tYXAoZnJlcSA9PiAoeyBmcmVxOiBwYXJzZUludChmcmVxKSwgZGI6IGRhdGFzZXRbZnJlcV0gfSkpLnNvcnQoKGEsIGIpID0+IGEuZnJlcSAtIGIuZnJlcSk7DQogICAgICAgICAgICBpZiAocG9pbnRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuOw0KDQogICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSBjb2xvcjsgY3R4LmxpbmVXaWR0aCA9IDIuNTsNCiAgICAgICAgICAgIGlmIChkYXJrKSB7IGN0eC5zaGFkb3dDb2xvciA9IGNvbG9yOyBjdHguc2hhZG93Qmx1ciA9IDY7IH0NCg0KICAgICAgICAgICAgY3R4LmJlZ2luUGF0aCgpOw0KICAgICAgICAgICAgcG9pbnRzLmZvckVhY2goKHBvaW50LCBpKSA9PiB7DQogICAgICAgICAgICAgICAgY29uc3QgeCA9IGdldFhQb3NpdGlvbihwb2ludC5mcmVxLCBwbG90V2lkdGgpOw0KICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBnZXRZUG9zaXRpb24ocG9pbnQuZGIsIHBsb3RIZWlnaHQpOw0KICAgICAgICAgICAgICAgIGlmIChpID09PSAwKSBjdHgubW92ZVRvKHgsIHkpOyBlbHNlIGN0eC5saW5lVG8oeCwgeSk7DQogICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIGN0eC5zdHJva2UoKTsgY3R4LnNoYWRvd0JsdXIgPSAwOw0KDQogICAgICAgICAgICBwb2ludHMuZm9yRWFjaChwb2ludCA9PiB7DQogICAgICAgICAgICAgICAgY29uc3QgeCA9IGdldFhQb3NpdGlvbihwb2ludC5mcmVxLCBwbG90V2lkdGgpOw0KICAgICAgICAgICAgICAgIGNvbnN0IHkgPSBnZXRZUG9zaXRpb24ocG9pbnQuZGIsIHBsb3RIZWlnaHQpOw0KICAgICAgICAgICAgICAgIGRyYXdTeW1ib2woY3R4LCB4LCB5LCBjb2xvciwgc3ltYm9sLCBkYXJrKTsNCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9DQoNCiAgICAgICAgZnVuY3Rpb24gZHJhd1N5bWJvbChjdHgsIHgsIHksIGNvbG9yLCB0eXBlLCBkYXJrKSB7DQogICAgICAgICAgICBjb25zdCBzaXplID0gMTY7DQogICAgICAgICAgICBjdHguc3Ryb2tlU3R5bGUgPSBjb2xvcjsgY3R4LmZpbGxTdHlsZSA9IGNvbG9yOyBjdHgubGluZVdpZHRoID0gMi41Ow0KICAgICAgICAgICAgaWYgKGRhcmspIHsgY3R4LnNoYWRvd0NvbG9yID0gY29sb3I7IGN0eC5zaGFkb3dCbHVyID0gNTsgfQ0KDQogICAgICAgICAgICBpZiAodHlwZSA9PT0gJ2NpcmNsZScpIHsNCiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7IGN0eC5hcmMoeCwgeSwgc2l6ZSAvIDIsIDAsIE1hdGguUEkgKiAyKTsgY3R4LnN0cm9rZSgpOw0KICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlID09PSAneCcpIHsNCiAgICAgICAgICAgICAgICBjdHguYmVnaW5QYXRoKCk7DQogICAgICAgICAgICAgICAgY3R4Lm1vdmVUbyh4IC0gc2l6ZSAvIDIsIHkgLSBzaXplIC8gMik7IGN0eC5saW5lVG8oeCArIHNpemUgLyAyLCB5ICsgc2l6ZSAvIDIpOw0KICAgICAgICAgICAgICAgIGN0eC5tb3ZlVG8oeCArIHNpemUgLyAyLCB5IC0gc2l6ZSAvIDIpOyBjdHgubGluZVRvKHggLSBzaXplIC8gMiwgeSArIHNpemUgLyAyKTsNCiAgICAgICAgICAgICAgICBjdHguc3Ryb2tlKCk7DQogICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGUgPT09ICdsZXNzJykgew0KICAgICAgICAgICAgICAgIGN0eC5mb250ID0gJ2JvbGQgMjRweCBBcmlhbCc7IGN0eC50ZXh0QWxpZ24gPSAnY2VudGVyJzsgY3R4LnRleHRCYXNlbGluZSA9ICdtaWRkbGUnOyBjdHguZmlsbFRleHQoJzwnLCB4LCB5KTsNCiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gJ2JyYWNrZXQnKSB7DQogICAgICAgICAgICAgICAgY3R4LmZvbnQgPSAnYm9sZCAyNHB4IEFyaWFsJzsgY3R4LnRleHRBbGlnbiA9ICdjZW50ZXInOyBjdHgudGV4dEJhc2VsaW5lID0gJ21pZGRsZSc7IGN0eC5maWxsVGV4dCgnWycsIHgsIHkpOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY3R4LnNoYWRvd0JsdXIgPSAwOw0KICAgICAgICB9DQoNCiAgICAgICAgLy8gLS0tIEhFTFBFUiBGVU5DVElPTlMgLS0tDQogICAgICAgIGZ1bmN0aW9uIGdldFhQb3NpdGlvbihmcmVxLCBwbG90V2lkdGgpIHsNCiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gZnJlcXVlbmNpZXMuaW5kZXhPZihmcmVxKTsNCiAgICAgICAgICAgIGlmIChpbmRleCA9PT0gLTEpIHJldHVybiBtYXJnaW4ubGVmdDsNCiAgICAgICAgICAgIGNvbnN0IHBhZGRpbmcgPSBwbG90V2lkdGggKiAwLjA1Ow0KICAgICAgICAgICAgY29uc3QgdXNhYmxlV2lkdGggPSBwbG90V2lkdGggLSAocGFkZGluZyAqIDIpOw0KICAgICAgICAgICAgcmV0dXJuIG1hcmdpbi5sZWZ0ICsgcGFkZGluZyArIChpbmRleCAqIHVzYWJsZVdpZHRoIC8gKGZyZXF1ZW5jaWVzLmxlbmd0aCAtIDEpKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIGdldFlQb3NpdGlvbihkYiwgcGxvdEhlaWdodCkgew0KICAgICAgICAgICAgY29uc3QgcmF0aW8gPSAoZGIgLSBtaW5EQikgLyAobWF4REIgLSBtaW5EQik7DQogICAgICAgICAgICByZXR1cm4gbWFyZ2luLnRvcCArIChyYXRpbyAqIHBsb3RIZWlnaHQpOw0KICAgICAgICB9DQoNCiAgICAgICAgZnVuY3Rpb24gZ2V0TmVhcmVzdEZyZXF1ZW5jeSh4LCBwbG90V2lkdGgpIHsNCiAgICAgICAgICAgIGNvbnN0IHBhZGRpbmcgPSBwbG90V2lkdGggKiAwLjA1Ow0KICAgICAgICAgICAgY29uc3QgdXNhYmxlV2lkdGggPSBwbG90V2lkdGggLSAocGFkZGluZyAqIDIpOw0KICAgICAgICAgICAgY29uc3QgcmVsYXRpdmVYID0geCAtIG1hcmdpbi5sZWZ0IC0gcGFkZGluZzsNCiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gTWF0aC5yb3VuZChyZWxhdGl2ZVggLyAodXNhYmxlV2lkdGggLyAoZnJlcXVlbmNpZXMubGVuZ3RoIC0gMSkpKTsNCiAgICAgICAgICAgIHJldHVybiBmcmVxdWVuY2llc1tNYXRoLm1heCgwLCBNYXRoLm1pbihmcmVxdWVuY2llcy5sZW5ndGggLSAxLCBpbmRleCkpXTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIGdldERCTGV2ZWwoeSwgcGxvdEhlaWdodCkgew0KICAgICAgICAgICAgY29uc3QgcmVsYXRpdmVZID0geSAtIG1hcmdpbi50b3A7DQogICAgICAgICAgICBjb25zdCByYXRpbyA9IHJlbGF0aXZlWSAvIHBsb3RIZWlnaHQ7DQogICAgICAgICAgICBjb25zdCBkYiA9IE1hdGgucm91bmQoKG1pbkRCICsgKHJhdGlvICogKG1heERCIC0gbWluREIpKSkgLyA1KSAqIDU7DQogICAgICAgICAgICByZXR1cm4gTWF0aC5tYXgobWluREIsIE1hdGgubWluKG1heERCLCBkYikpOw0KICAgICAgICB9DQoNCiAgICAgICAgLy8gLS0tIElOVEVSQUNUSU9OIC0tLQ0KICAgICAgICBmdW5jdGlvbiBzZXR1cENhbnZhc0V2ZW50cyhjYW52YXMsIGlzUmlnaHQpIHsNCiAgICAgICAgICAgIC8vIENsaWNrIHRvIGFkZCBPUiByZW1vdmUgcG9pbnQgKFRvZ2dsZSkNCiAgICAgICAgICAgIGNhbnZhcy5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKSA9PiB7DQogICAgICAgICAgICAgICAgY29uc3QgcmVjdCA9IGNhbnZhcy5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsNCiAgICAgICAgICAgICAgICBjb25zdCB4ID0gKGUuY2xpZW50WCAtIHJlY3QubGVmdCkgKiAoY2FudmFzLndpZHRoIC8gcmVjdC53aWR0aCk7DQogICAgICAgICAgICAgICAgY29uc3QgeSA9IChlLmNsaWVudFkgLSByZWN0LnRvcCkgKiAoY2FudmFzLmhlaWdodCAvIHJlY3QuaGVpZ2h0KTsNCiAgICAgICAgICAgICAgICBjb25zdCBwbG90V2lkdGggPSBjYW52YXMud2lkdGggLSBtYXJnaW4ubGVmdCAtIG1hcmdpbi5yaWdodDsNCiAgICAgICAgICAgICAgICBjb25zdCBwbG90SGVpZ2h0ID0gY2FudmFzLmhlaWdodCAtIG1hcmdpbi50b3AgLSBtYXJnaW4uYm90dG9tOw0KDQogICAgICAgICAgICAgICAgaWYgKHggPCBtYXJnaW4ubGVmdCB8fCB4ID4gbWFyZ2luLmxlZnQgKyBwbG90V2lkdGggfHwgeSA8IG1hcmdpbi50b3AgfHwgeSA+IG1hcmdpbi50b3AgKyBwbG90SGVpZ2h0KSByZXR1cm47DQoNCiAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50RWFyID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2VhclNlbGVjdCcpLnZhbHVlOw0KICAgICAgICAgICAgICAgIGNvbnN0IGNhbnZhc0VhciA9IGlzUmlnaHQgPyAncmlnaHQnIDogJ2xlZnQnOw0KICAgICAgICAgICAgICAgIGlmIChjdXJyZW50RWFyICE9PSBjYW52YXNFYXIpIHJldHVybjsNCg0KICAgICAgICAgICAgICAgIGNvbnN0IGZyZXEgPSBnZXROZWFyZXN0RnJlcXVlbmN5KHgsIHBsb3RXaWR0aCk7DQogICAgICAgICAgICAgICAgY29uc3QgZGIgPSBnZXREQkxldmVsKHksIHBsb3RIZWlnaHQpOw0KICAgICAgICAgICAgICAgIGNvbnN0IHRlc3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGVzdFR5cGVTZWxlY3QnKS52YWx1ZTsNCiAgICAgICAgICAgICAgICBjb25zdCBrZXkgPSBjdXJyZW50RWFyICsgdGVzdC5jaGFyQXQoMCkudG9VcHBlckNhc2UoKSArIHRlc3Quc2xpY2UoMSk7DQoNCiAgICAgICAgICAgICAgICAvLyBUb2dnbGUgTG9naWM6IElmIHBvaW50IGV4aXN0cyBhdCB0aGlzIGZyZXEgQU5EIHJvdWdobHkgc2FtZSBkQiwgZGVsZXRlIGl0Lg0KICAgICAgICAgICAgICAgIGlmIChkYXRhW2tleV1bZnJlcV0gIT09IHVuZGVmaW5lZCAmJiBkYXRhW2tleV1bZnJlcV0gPT09IGRiKSB7DQogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBkYXRhW2tleV1bZnJlcV07DQogICAgICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgICAgICAgZGF0YVtrZXldW2ZyZXFdID0gZGI7DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgLy8gVXBkYXRlIG1hc3RlciByZWNvcmQgaWYgd2UgYXJlIGluIGJ1bGsgbW9kZQ0KICAgICAgICAgICAgICAgIGlmIChjdXJyZW50SW5kZXggPj0gMCAmJiBhbGxSZWNvcmRzW2N1cnJlbnRJbmRleF0pIHsNCiAgICAgICAgICAgICAgICAgICAgYWxsUmVjb3Jkc1tjdXJyZW50SW5kZXhdW2tleV0gPSBkYXRhW2tleV07DQogICAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgICAgcmVkcmF3QWxsKCk7DQogICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgLy8gUmlnaHQgY2xpY2sgdG8gZGVsZXRlIHBvaW50DQogICAgICAgICAgICBjYW52YXMuYWRkRXZlbnRMaXN0ZW5lcignY29udGV4dG1lbnUnLCAoZSkgPT4gew0KICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsNCiAgICAgICAgICAgICAgICBjb25zdCByZWN0ID0gY2FudmFzLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOw0KICAgICAgICAgICAgICAgIGNvbnN0IHggPSAoZS5jbGllbnRYIC0gcmVjdC5sZWZ0KSAqIChjYW52YXMud2lkdGggLyByZWN0LndpZHRoKTsNCiAgICAgICAgICAgICAgICBjb25zdCB5ID0gKGUuY2xpZW50WSAtIHJlY3QudG9wKSAqIChjYW52YXMuaGVpZ2h0IC8gcmVjdC5oZWlnaHQpOw0KICAgICAgICAgICAgICAgIGNvbnN0IHBsb3RXaWR0aCA9IGNhbnZhcy53aWR0aCAtIG1hcmdpbi5sZWZ0IC0gbWFyZ2luLnJpZ2h0Ow0KICAgICAgICAgICAgICAgIGNvbnN0IHBsb3RIZWlnaHQgPSBjYW52YXMuaGVpZ2h0IC0gbWFyZ2luLnRvcCAtIG1hcmdpbi5ib3R0b207DQoNCiAgICAgICAgICAgICAgICBpZiAoeCA8IG1hcmdpbi5sZWZ0IHx8IHggPiBtYXJnaW4ubGVmdCArIHBsb3RXaWR0aCB8fCB5IDwgbWFyZ2luLnRvcCB8fCB5ID4gbWFyZ2luLnRvcCArIHBsb3RIZWlnaHQpIHJldHVybjsNCg0KICAgICAgICAgICAgICAgIGNvbnN0IGZyZXEgPSBnZXROZWFyZXN0RnJlcXVlbmN5KHgsIHBsb3RXaWR0aCk7DQogICAgICAgICAgICAgICAgY29uc3QgY3VycmVudEVhciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdlYXJTZWxlY3QnKS52YWx1ZTsNCiAgICAgICAgICAgICAgICBjb25zdCBjYW52YXNFYXIgPSBpc1JpZ2h0ID8gJ3JpZ2h0JyA6ICdsZWZ0JzsNCiAgICAgICAgICAgICAgICBpZiAoY3VycmVudEVhciAhPT0gY2FudmFzRWFyKSByZXR1cm47DQoNCiAgICAgICAgICAgICAgICBjb25zdCB0ZXN0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Rlc3RUeXBlU2VsZWN0JykudmFsdWU7DQogICAgICAgICAgICAgICAgY29uc3Qga2V5ID0gY3VycmVudEVhciArIHRlc3QuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyB0ZXN0LnNsaWNlKDEpOw0KDQogICAgICAgICAgICAgICAgaWYgKGRhdGFba2V5XVtmcmVxXSAhPT0gdW5kZWZpbmVkKSB7DQogICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBkYXRhW2tleV1bZnJlcV07DQogICAgICAgICAgICAgICAgICAgIC8vIFVwZGF0ZSBtYXN0ZXIgcmVjb3JkDQogICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50SW5kZXggPj0gMCAmJiBhbGxSZWNvcmRzW2N1cnJlbnRJbmRleF0pIHsNCiAgICAgICAgICAgICAgICAgICAgICAgIGFsbFJlY29yZHNbY3VycmVudEluZGV4XVtrZXldID0gZGF0YVtrZXldOw0KICAgICAgICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgICAgICAgIHJlZHJhd0FsbCgpOw0KICAgICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9DQoNCiAgICAgICAgZnVuY3Rpb24gcmVkcmF3QWxsKCkgew0KICAgICAgICAgICAgZHJhd0F1ZGlvZ3JhbShyaWdodENhbnZhcywgcmlnaHRDdHgsIHRydWUpOw0KICAgICAgICAgICAgZHJhd0F1ZGlvZ3JhbShsZWZ0Q2FudmFzLCBsZWZ0Q3R4LCBmYWxzZSk7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBjbGVhckN1cnJlbnRSZWNvcmQoKSB7DQogICAgICAgICAgICBpZiAoY3VycmVudEluZGV4ID09PSAtMSkgcmV0dXJuOw0KICAgICAgICAgICAgaWYgKGNvbmZpcm0oJ9CY0LfQsdGA0LjRiNC4INCz0Lgg0YLQtdC60L7QstC90LjRgtC1INGC0L7Rh9C60Lgg0LfQsCDQvtCy0L7RmCDRg9GH0LXQvdC40Lo/JykpIHsNCiAgICAgICAgICAgICAgICBkYXRhLnJpZ2h0QWlyID0ge307IGRhdGEucmlnaHRCb25lID0ge307DQogICAgICAgICAgICAgICAgZGF0YS5sZWZ0QWlyID0ge307IGRhdGEubGVmdEJvbmUgPSB7fTsNCiAgICAgICAgICAgICAgICBpZiAoY3VycmVudEluZGV4ID49IDApIHsNCiAgICAgICAgICAgICAgICAgICAgYWxsUmVjb3Jkc1tjdXJyZW50SW5kZXhdLnJpZ2h0QWlyID0ge307DQogICAgICAgICAgICAgICAgICAgIGFsbFJlY29yZHNbY3VycmVudEluZGV4XS5yaWdodEJvbmUgPSB7fTsNCiAgICAgICAgICAgICAgICAgICAgYWxsUmVjb3Jkc1tjdXJyZW50SW5kZXhdLmxlZnRBaXIgPSB7fTsNCiAgICAgICAgICAgICAgICAgICAgYWxsUmVjb3Jkc1tjdXJyZW50SW5kZXhdLmxlZnRCb25lID0ge307DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJlZHJhd0FsbCgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgZnVuY3Rpb24gY2xlYXJBbGwoKSB7DQogICAgICAgICAgICBpZiAoY29uZmlybSgn0JjQt9Cx0YDQuNGI0Lgg0LPQuCDRgtC10LrQvtCy0L3QuNGC0LUg0L/QvtC00LDRgtC+0YbQuD8gKNCe0LLQsCDQvdC1INCz0L4g0LHRgNC40YjQtSDRhNCw0ZjQu9C+0YIpJykpIHsNCiAgICAgICAgICAgICAgICBkYXRhLnJpZ2h0QWlyID0ge307IGRhdGEucmlnaHRCb25lID0ge307DQogICAgICAgICAgICAgICAgZGF0YS5sZWZ0QWlyID0ge307IGRhdGEubGVmdEJvbmUgPSB7fTsNCiAgICAgICAgICAgICAgICBpZiAoY3VycmVudEluZGV4ID49IDApIHsNCiAgICAgICAgICAgICAgICAgICAgYWxsUmVjb3Jkc1tjdXJyZW50SW5kZXhdLnJpZ2h0QWlyID0ge307DQogICAgICAgICAgICAgICAgICAgIGFsbFJlY29yZHNbY3VycmVudEluZGV4XS5yaWdodEJvbmUgPSB7fTsNCiAgICAgICAgICAgICAgICAgICAgYWxsUmVjb3Jkc1tjdXJyZW50SW5kZXhdLmxlZnRBaXIgPSB7fTsNCiAgICAgICAgICAgICAgICAgICAgYWxsUmVjb3Jkc1tjdXJyZW50SW5kZXhdLmxlZnRCb25lID0ge307DQogICAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICAgIHJlZHJhd0FsbCgpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQoNCiAgICAgICAgZnVuY3Rpb24gZXhwb3J0U2luZ2xlKCkgew0KICAgICAgICAgICAgY29uc3QganNvbiA9IEpTT04uc3RyaW5naWZ5KGRhdGEsIG51bGwsIDIpOw0KICAgICAgICAgICAgY29uc3QgYmxvYiA9IG5ldyBCbG9iKFtqc29uXSwgeyB0eXBlOiAnYXBwbGljYXRpb24vanNvbicgfSk7DQogICAgICAgICAgICBjb25zdCB1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpOw0KICAgICAgICAgICAgY29uc3QgYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsNCiAgICAgICAgICAgIGEuaHJlZiA9IHVybDsNCiAgICAgICAgICAgIGEuZG93bmxvYWQgPSAnYXVkaW9ncmFtXycgKyAoZGF0YS5zdWJqZWN0TmFtZSB8fCAndW5uYW1lZCcpICsgJy5qc29uJzsNCiAgICAgICAgICAgIGEuY2xpY2soKTsNCiAgICAgICAgICAgIFVSTC5yZXZva2VPYmplY3RVUkwodXJsKTsNCiAgICAgICAgfQ0KDQogICAgICAgIGZ1bmN0aW9uIGV4cG9ydEFzSW1hZ2UoKSB7DQogICAgICAgICAgICAvLyAoU2FtZSBhcyBwcmV2aW91cyBpbWFnZSBleHBvcnQgbG9naWMsIHNpbXBsaWZpZWQgZm9yIGJyZXZpdHkgYnV0IGZ1bGx5IGZ1bmN0aW9uYWwpDQogICAgICAgICAgICBjb25zdCBleHBvcnRDYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsNCiAgICAgICAgICAgIGV4cG9ydENhbnZhcy53aWR0aCA9IDI0MDA7IGV4cG9ydENhbnZhcy5oZWlnaHQgPSAxNTUwOw0KICAgICAgICAgICAgY29uc3QgZXhwb3J0Q3R4ID0gZXhwb3J0Q2FudmFzLmdldENvbnRleHQoJzJkJyk7DQogICAgICAgICAgICBjb25zdCBkYXJrID0gaXNEYXJrTW9kZSgpOw0KDQogICAgICAgICAgICBpZiAoZGFyaykgew0KICAgICAgICAgICAgICAgIGNvbnN0IGdyYWRpZW50ID0gZXhwb3J0Q3R4LmNyZWF0ZUxpbmVhckdyYWRpZW50KDAsIDAsIDI0MDAsIDE1NTApOw0KICAgICAgICAgICAgICAgIGdyYWRpZW50LmFkZENvbG9yU3RvcCgwLCAnIzFhMWEyZScpOyBncmFkaWVudC5hZGRDb2xvclN0b3AoMSwgJyMxNjIxM2UnKTsNCiAgICAgICAgICAgICAgICBleHBvcnRDdHguZmlsbFN0eWxlID0gZ3JhZGllbnQ7DQogICAgICAgICAgICB9IGVsc2UgeyBleHBvcnRDdHguZmlsbFN0eWxlID0gJyNmZmZmZmYnOyB9DQogICAgICAgICAgICBleHBvcnRDdHguZmlsbFJlY3QoMCwgMCwgZXhwb3J0Q2FudmFzLndpZHRoLCBleHBvcnRDYW52YXMuaGVpZ2h0KTsNCg0KICAgICAgICAgICAgLy8gSGVhZGVyDQogICAgICAgICAgICBleHBvcnRDdHguZmlsbFN0eWxlID0gZGFyayA/ICcjNGE0ZTY5JyA6ICcjZmZmZmZmJzsNCiAgICAgICAgICAgIGV4cG9ydEN0eC5maWxsUmVjdCg1MCwgMzAsIDIzMDAsIDE1MCk7DQogICAgICAgICAgICBleHBvcnRDdHguZmlsbFN0eWxlID0gZGFyayA/ICcjZmZmZmZmJyA6ICcjMmMzZTUwJzsNCiAgICAgICAgICAgIGV4cG9ydEN0eC5mb250ID0gJ2JvbGQgNDBweCBBcmlhbCc7IGV4cG9ydEN0eC50ZXh0QWxpZ24gPSAnY2VudGVyJzsNCiAgICAgICAgICAgIGV4cG9ydEN0eC5maWxsVGV4dCgn0J7QodCd0J7QktCeINCj0KfQmNCb0JjQqNCi0JUg0KHQniDQoNCV0KHQo9Cg0KHQldCdINCm0JXQndCi0JDQoCcsIDEyMDAsIDkwKTsNCiAgICAgICAgICAgIGV4cG9ydEN0eC5maWxsVGV4dCgn0JrQntCn0J4g0KDQkNCm0JjQnSDQkdCY0KLQntCb0JAnLCAxMjAwLCAxNDApOw0KDQogICAgICAgICAgICAvLyBJbmZvDQogICAgICAgICAgICBpZiAoZGF0YS5zdWJqZWN0TmFtZSkgew0KICAgICAgICAgICAgICAgIGV4cG9ydEN0eC5maWxsU3R5bGUgPSBkYXJrID8gJyMyZDMyNTAnIDogJyNmZmZmZmYnOw0KICAgICAgICAgICAgICAgIGV4cG9ydEN0eC5maWxsUmVjdCg1MCwgMjAwLCAyMzAwLCA3MCk7DQogICAgICAgICAgICAgICAgZXhwb3J0Q3R4LmZpbGxTdHlsZSA9IGRhcmsgPyAnI2E4ZGFkYycgOiAnIzJjM2U1MCc7DQogICAgICAgICAgICAgICAgZXhwb3J0Q3R4LmZvbnQgPSAnYm9sZCAyOHB4IEFyaWFsJzsNCiAgICAgICAgICAgICAgICBjb25zdCBkYXRlVGV4dCA9IGRhdGEuZGF0ZSA/IGAgfCDQlNCw0YLRg9C8OiAke2RhdGEuZGF0ZX1gIDogJyc7DQogICAgICAgICAgICAgICAgZXhwb3J0Q3R4LmZpbGxUZXh0KGDQmNC80LU6ICR7ZGF0YS5zdWJqZWN0TmFtZX0ke2RhdGVUZXh0fWAsIDEyMDAsIDI0NSk7DQogICAgICAgICAgICB9DQoNCiAgICAgICAgICAgIGNvbnN0IGdyYXBoc1N0YXJ0WSA9IGRhdGEuc3ViamVjdE5hbWUgPyAyOTAgOiAyMDA7DQogICAgICAgICAgICBleHBvcnRDdHguZHJhd0ltYWdlKHJpZ2h0Q2FudmFzLCA1MCwgZ3JhcGhzU3RhcnRZLCAxMTAwLCA5MjApOw0KICAgICAgICAgICAgZXhwb3J0Q3R4LmRyYXdJbWFnZShsZWZ0Q2FudmFzLCAxMjAwLCBncmFwaHNTdGFydFksIDExMDAsIDkyMCk7DQoNCiAgICAgICAgICAgIC8vIExlZ2VuZCAmIEZvb3RlciAoU2ltcGxpZmllZCBmb3IgZXhwb3J0KQ0KICAgICAgICAgICAgY29uc3QgbGVnZW5kWSA9IGdyYXBoc1N0YXJ0WSArIDk2MDsNCiAgICAgICAgICAgIGV4cG9ydEN0eC5mb250ID0gJ2JvbGQgMjJweCBBcmlhbCc7IGV4cG9ydEN0eC50ZXh0QWxpZ24gPSAncmlnaHQnOw0KICAgICAgICAgICAgZXhwb3J0Q3R4LmZpbGxTdHlsZSA9IGRhcmsgPyAnI2E4ZGFkYycgOiAnIzJjM2U1MCc7DQogICAgICAgICAgICBleHBvcnRDdHguZmlsbFRleHQoJ9C00LjQv9C7LiDQtNC10YQuINCR0LvQsNCz0L7RmCDQndCw0YHQtdCyJywgMjMwMCwgbGVnZW5kWSArIDcwKTsNCg0KICAgICAgICAgICAgZXhwb3J0Q2FudmFzLnRvQmxvYihibG9iID0+IHsNCiAgICAgICAgICAgICAgICBjb25zdCB1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpOw0KICAgICAgICAgICAgICAgIGNvbnN0IGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7DQogICAgICAgICAgICAgICAgYS5ocmVmID0gdXJsOw0KICAgICAgICAgICAgICAgIGEuZG93bmxvYWQgPSBgYXVkaW9ncmFtXyR7ZGF0YS5zdWJqZWN0TmFtZSB8fCAndW5uYW1lZCd9LnBuZ2A7DQogICAgICAgICAgICAgICAgYS5jbGljaygpOw0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0NCg0KICAgICAgICAvLyAtLS0gTkVXOiBFWFBPUlQgSElTVE9SWSAoQ2VudGVyZWQgJiBMYXJnZXIpIC0tLQ0KICAgICAgICBmdW5jdGlvbiBleHBvcnRIaXN0b3J5SW1hZ2VzKCkgew0KICAgICAgICAgICAgY29uc3QgbmFtZSA9IGRhdGEuc3ViamVjdE5hbWUudHJpbSgpOw0KICAgICAgICAgICAgaWYgKCFuYW1lKSByZXR1cm4gYWxlcnQoItCd0LXQvNCwINC40LfQsdGA0LDQvdC+INC40LzQtSDQvdCwINC40YHQv9C40YLQsNC90LjQui4iKTsNCg0KICAgICAgICAgICAgLy8gMS4gRmlsdGVyIGFuZCBTb3J0DQogICAgICAgICAgICBjb25zdCByZWNvcmRzID0gYWxsUmVjb3Jkcy5maWx0ZXIociA9PiAoci5zdWJqZWN0TmFtZSB8fCAnJykudHJpbSgpID09PSBuYW1lKQ0KICAgICAgICAgICAgICAgIC5zb3J0KChhLCBiKSA9PiBuZXcgRGF0ZShhLmRhdGUpIC0gbmV3IERhdGUoYi5kYXRlKSk7DQoNCiAgICAgICAgICAgIGlmIChyZWNvcmRzLmxlbmd0aCA9PT0gMCkgcmV0dXJuIGFsZXJ0KCLQndC10LzQsCDQt9Cw0L/QuNGB0Lgg0LfQsCDQvtCy0L7RmCDQuNGB0L/QuNGC0LDQvdC40LouIik7DQoNCiAgICAgICAgICAgIC8vIDIuIENodW5rIGludG8gZ3JvdXBzIG9mIDQNCiAgICAgICAgICAgIGNvbnN0IGNodW5rcyA9IFtdOw0KICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZWNvcmRzLmxlbmd0aDsgaSArPSA0KSB7DQogICAgICAgICAgICAgICAgY2h1bmtzLnB1c2gocmVjb3Jkcy5zbGljZShpLCBpICsgNCkpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAvLyAzLiBUZW1wb3JhcmlseSBlbmZvcmNlIGxpZ2h0IG1vZGUgcHJvcGVydGllcyBmb3IgZHJhd2luZw0KICAgICAgICAgICAgY29uc3Qgd2FzRGFyayA9IGlzRGFya01vZGUoKTsNCiAgICAgICAgICAgIGlmICh3YXNEYXJrKSBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5yZW1vdmUoJ2RhcmstbW9kZScpOw0KDQogICAgICAgICAgICAvLyA0LiBHZW5lcmF0ZSBJbWFnZSBmb3IgZWFjaCBjaHVuaw0KICAgICAgICAgICAgY2h1bmtzLmZvckVhY2goKGNodW5rLCBwYWdlSW5kZXgpID0+IHsNCiAgICAgICAgICAgICAgICBjb25zdCBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsNCiAgICAgICAgICAgICAgICAvLyBJbmNyZWFzZWQgSGVpZ2h0IHRvIDM1MDBweCB0byBhbGxvdyBmb3IgbGFyZ2VyIGdyYXBocyBhbmQgc3BhY2luZw0KICAgICAgICAgICAgICAgIGNhbnZhcy53aWR0aCA9IDI0MDA7DQogICAgICAgICAgICAgICAgY2FudmFzLmhlaWdodCA9IDM2MDA7DQogICAgICAgICAgICAgICAgY29uc3QgY3R4ID0gY2FudmFzLmdldENvbnRleHQoJzJkJyk7DQoNCiAgICAgICAgICAgICAgICAvLyBXaGl0ZSBCYWNrZ3JvdW5kDQogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjZmZmZmZmJzsNCiAgICAgICAgICAgICAgICBjdHguZmlsbFJlY3QoMCwgMCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0KTsNCg0KICAgICAgICAgICAgICAgIC8vIC0tLSBIRUFERVIgLS0tDQogICAgICAgICAgICAgICAgY3R4LmZpbGxTdHlsZSA9ICcjMmMzZTUwJzsNCiAgICAgICAgICAgICAgICBjdHgudGV4dEFsaWduID0gJ2NlbnRlcic7DQogICAgICAgICAgICAgICAgY3R4LmZvbnQgPSAnYm9sZCA0NXB4IEFyaWFsJzsNCiAgICAgICAgICAgICAgICBjdHguZmlsbFRleHQoJ9Ce0KHQndCe0JLQniDQo9Cn0JjQm9CY0KjQotCVINCh0J4g0KDQldCh0KPQoNCh0JXQnSDQptCV0J3QotCQ0KAnLCAxMjAwLCA4MCk7DQogICAgICAgICAgICAgICAgY3R4LmZpbGxUZXh0KCfQmtCe0KfQniDQoNCQ0KbQmNCdINCR0JjQotCe0JvQkCcsIDEyMDAsIDE0MCk7DQoNCiAgICAgICAgICAgICAgICBjdHguZm9udCA9ICdib2xkIDM2cHggQXJpYWwnOw0KICAgICAgICAgICAgICAgIGN0eC5maWxsVGV4dChg0JjQodCi0J7QoNCY0IjQkCDQndCQINCQ0KPQlNCY0J7Qk9Cg0JDQnNCYOiAke25hbWUudG9VcHBlckNhc2UoKX1gLCAxMjAwLCAyNDApOw0KICAgICAgICAgICAgICAgIGN0eC5mb250ID0gJ2l0YWxpYyAyNHB4IEFyaWFsJzsNCiAgICAgICAgICAgICAgICBjdHguZmlsbFRleHQoYNCh0YLRgNCw0L3QuNGG0LAgJHtwYWdlSW5kZXggKyAxfSDQvtC0ICR7Y2h1bmtzLmxlbmd0aH1gLCAxMjAwLCAyOTApOw0KDQogICAgICAgICAgICAgICAgLy8gLS0tIERSQVcgUk9XUyAtLS0NCiAgICAgICAgICAgICAgICBsZXQgeU9mZnNldCA9IDM1MDsNCg0KICAgICAgICAgICAgICAgIC8vIENvbmZpZyBmb3IgY2VudGVyZWQgbGFyZ2UgZ3JhcGhzDQogICAgICAgICAgICAgICAgY29uc3QgZ3JhcGhXaWR0aCA9IDkwMCAqIDEuMDsgLy8gU2NhbGUgMS4wID0gOTAwcHgNCiAgICAgICAgICAgICAgICBjb25zdCBncmFwaEhlaWdodCA9IDY1MCAqIDEuMDsNCiAgICAgICAgICAgICAgICBjb25zdCBnYXAgPSAxMDA7IC8vIEdhcCBiZXR3ZWVuIEwgYW5kIFINCg0KICAgICAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBDZW50ZXJpbmcNCiAgICAgICAgICAgICAgICAvLyBUb3RhbCBXaWR0aCA9IDI0MDANCiAgICAgICAgICAgICAgICAvLyBDb250ZW50IFdpZHRoID0gZ3JhcGhXaWR0aCAqIDIgKyBnYXAgPSAxODAwICsgMTAwID0gMTkwMA0KICAgICAgICAgICAgICAgIC8vIE1hcmdpbiBMZWZ0ID0gKDI0MDAgLSAxOTAwKSAvIDIgPSAyNTANCiAgICAgICAgICAgICAgICBjb25zdCBtYXJnaW5MZWZ0ID0gKGNhbnZhcy53aWR0aCAtIChncmFwaFdpZHRoICogMiArIGdhcCkpIC8gMjsNCg0KICAgICAgICAgICAgICAgIGNodW5rLmZvckVhY2goKHJlYykgPT4gew0KICAgICAgICAgICAgICAgICAgICAvLyBEcmF3IERhdGUgVGl0bGUgYWJvdmUgdGhlIHJvdw0KICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJyMyYzNlNTAnOw0KICAgICAgICAgICAgICAgICAgICBjdHguZm9udCA9ICdib2xkIDMycHggQXJpYWwnOw0KICAgICAgICAgICAgICAgICAgICBjdHgudGV4dEFsaWduID0gJ2xlZnQnOw0KICAgICAgICAgICAgICAgICAgICBjdHguZmlsbFRleHQoYNCU0LDRgtGD0Lw6ICR7cmVjLmRhdGUgfHwgJ9Cd0LXQv9C+0LfQvdCw0YInfWAsIG1hcmdpbkxlZnQsIHlPZmZzZXQgLSAyNSk7DQoNCiAgICAgICAgICAgICAgICAgICAgLy8gTW9jayBnbG9iYWwgZGF0YSBmb3IgdGhlIGRyYXcgZnVuY3Rpb24NCiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc2F2ZWREYXRhID0geyAuLi5kYXRhIH07IC8vIGJhY2t1cCBjdXJyZW50DQogICAgICAgICAgICAgICAgICAgIGRhdGEucmlnaHRBaXIgPSByZWMucmlnaHRBaXI7IGRhdGEucmlnaHRCb25lID0gcmVjLnJpZ2h0Qm9uZTsNCiAgICAgICAgICAgICAgICAgICAgZGF0YS5sZWZ0QWlyID0gcmVjLmxlZnRBaXI7IGRhdGEubGVmdEJvbmUgPSByZWMubGVmdEJvbmU7DQoNCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGVtcEMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsgdGVtcEMud2lkdGggPSA5MDA7IHRlbXBDLmhlaWdodCA9IDY1MDsNCiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGVtcEN0eCA9IHRlbXBDLmdldENvbnRleHQoJzJkJyk7DQoNCiAgICAgICAgICAgICAgICAgICAgLy8gRHJhdyBSaWdodA0KICAgICAgICAgICAgICAgICAgICBkcmF3QXVkaW9ncmFtKHRlbXBDLCB0ZW1wQ3R4LCB0cnVlKTsNCiAgICAgICAgICAgICAgICAgICAgY3R4LmRyYXdJbWFnZSh0ZW1wQywgbWFyZ2luTGVmdCwgeU9mZnNldCwgZ3JhcGhXaWR0aCwgZ3JhcGhIZWlnaHQpOw0KDQogICAgICAgICAgICAgICAgICAgIC8vIERyYXcgTGVmdA0KICAgICAgICAgICAgICAgICAgICBkcmF3QXVkaW9ncmFtKHRlbXBDLCB0ZW1wQ3R4LCBmYWxzZSk7DQogICAgICAgICAgICAgICAgICAgIGN0eC5kcmF3SW1hZ2UodGVtcEMsIG1hcmdpbkxlZnQgKyBncmFwaFdpZHRoICsgZ2FwLCB5T2Zmc2V0LCBncmFwaFdpZHRoLCBncmFwaEhlaWdodCk7DQoNCiAgICAgICAgICAgICAgICAgICAgLy8gUmVzdG9yZSBnbG9iYWwgZGF0YQ0KICAgICAgICAgICAgICAgICAgICBPYmplY3QuYXNzaWduKGRhdGEsIHNhdmVkRGF0YSk7DQoNCiAgICAgICAgICAgICAgICAgICAgeU9mZnNldCArPSBncmFwaEhlaWdodCArIDExMDsgLy8gTW92ZSBkb3duIGZvciBuZXh0IHJvdw0KICAgICAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICAgICAgLy8gLS0tIEZPT1RFUiAtLS0NCiAgICAgICAgICAgICAgICBjdHguZmlsbFN0eWxlID0gJyMyYzNlNTAnOw0KICAgICAgICAgICAgICAgIGN0eC5mb250ID0gJ2JvbGQgMjZweCBBcmlhbCc7DQogICAgICAgICAgICAgICAgY3R4LnRleHRBbGlnbiA9ICdyaWdodCc7DQogICAgICAgICAgICAgICAgY3R4LmZpbGxUZXh0KCfQtNC40L/Quy4g0LTQtdGELiDQkdC70LDQs9C+0Zgg0J3QsNGB0LXQsicsIDIzMDAsIGNhbnZhcy5oZWlnaHQgLSA1MCk7DQoNCiAgICAgICAgICAgICAgICAvLyBEb3dubG9hZA0KICAgICAgICAgICAgICAgIGNhbnZhcy50b0Jsb2IoYmxvYiA9PiB7DQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7DQogICAgICAgICAgICAgICAgICAgIGEuaHJlZiA9IFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYik7DQogICAgICAgICAgICAgICAgICAgIGEuZG93bmxvYWQgPSBgSGlzdG9yeV8ke25hbWV9X1BhZ2Uke3BhZ2VJbmRleCArIDF9LnBuZ2A7DQogICAgICAgICAgICAgICAgICAgIGEuY2xpY2soKTsNCiAgICAgICAgICAgICAgICB9KTsNCiAgICAgICAgICAgIH0pOw0KDQogICAgICAgICAgICAvLyBSZXN0b3JlIFRoZW1lDQogICAgICAgICAgICBpZiAod2FzRGFyaykgeyBkb2N1bWVudC5ib2R5LmNsYXNzTGlzdC5hZGQoJ2RhcmstbW9kZScpOyByZWRyYXdBbGwoKTsgfQ0KICAgICAgICAgICAgZWxzZSB7IHJlZHJhd0FsbCgpOyB9IC8vIGp1c3QgdG8gYmUgc2FmZQ0KICAgICAgICB9DQoNCiAgICAgICAgLy8gSW5pdA0KICAgICAgICBzZXR1cENhbnZhc0V2ZW50cyhyaWdodENhbnZhcywgdHJ1ZSk7DQogICAgICAgIHNldHVwQ2FudmFzRXZlbnRzKGxlZnRDYW52YXMsIGZhbHNlKTsNCiAgICAgICAgcmVkcmF3QWxsKCk7DQogICAgPC9zY3JpcHQ+DQo8L2JvZHk+DQoNCjwvaHRtbD4NCg==';

        function b64ToUtf8(b64) {
            var binary = atob(b64);
            var bytes = new Uint8Array(binary.length);
            for (var i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return new TextDecoder('utf-8').decode(bytes);
        }

        function deepCloneJson(value, fallback) {
            try {
                return JSON.parse(JSON.stringify(value));
            } catch (e) {
                return fallback;
            }
        }

        function readDosieFromStorage() {
            try {
                var raw = localStorage.getItem('student_db_temp');
                if (!raw) return [];
                var parsed = JSON.parse(raw);
                return Array.isArray(parsed) ? parsed : [];
            } catch (e) {
                return [];
            }
        }

        function pullEmbeddedDataToUnified() {
            var dosieFrame = document.getElementById('dosieFrame');
            if (dosieFrame && dosieFrame.dataset.loaded === '1') {
                try {
                    var dosieWin = dosieFrame.contentWindow;
                    if (dosieWin && dosieWin.app && Array.isArray(dosieWin.app.students)) {
                        window.studentRecords = deepCloneJson(dosieWin.app.students, window.studentRecords || []);
                    }
                } catch (e) {}
            }

            var persistedDosie = readDosieFromStorage();
            if (persistedDosie.length > 0 || !Array.isArray(window.studentRecords) || window.studentRecords.length === 0) {
                window.studentRecords = persistedDosie;
            }

            var audiogramFrame = document.getElementById('audiogramFrame');
            if (audiogramFrame && audiogramFrame.dataset.loaded === '1') {
                try {
                    var audiogramWin = audiogramFrame.contentWindow;
                    if (audiogramWin && typeof audiogramWin.eval === 'function') {
                        var serialized = audiogramWin.eval('JSON.stringify(allRecords || [])');
                        var parsedRecords = serialized ? JSON.parse(serialized) : [];
                        if (Array.isArray(parsedRecords)) {
                            window.audiogramRecords = parsedRecords;
                        }
                    }
                } catch (e) {}
            }

            ensureUnifiedCollections();
        }

        function syncDosieDataToEmbedded(forceRender) {
            var records = Array.isArray(window.studentRecords) ? window.studentRecords : [];

            try {
                localStorage.setItem('student_db_temp', JSON.stringify(records));
            } catch (e) {}

            var frame = document.getElementById('dosieFrame');
            if (!frame || frame.dataset.loaded !== '1') return;

            try {
                var frameWin = frame.contentWindow;
                if (!frameWin || !frameWin.app) return;

                frameWin.app.students = deepCloneJson(records, []);
                if (typeof frameWin.app.save === 'function') frameWin.app.save();
                if (forceRender !== false && typeof frameWin.app.render === 'function') frameWin.app.render();
            } catch (e) {}
        }

        function syncAudiogramDataToEmbedded(forceRender) {
            var records = Array.isArray(window.audiogramRecords) ? window.audiogramRecords : [];
            var frame = document.getElementById('audiogramFrame');
            if (!frame || frame.dataset.loaded !== '1') return;

            try {
                var frameWin = frame.contentWindow;
                if (!frameWin || typeof frameWin.eval !== 'function') return;

                var jsonAsStringLiteral = JSON.stringify(JSON.stringify(records));
                var script = [
                    '(function(){',
                    'var imported = JSON.parse(' + jsonAsStringLiteral + ');',
                    'allRecords = Array.isArray(imported) ? imported : [];',
                    'currentIndex = allRecords.length > 0 ? 0 : -1;',
                    'if (typeof populateDropdown === "function") populateDropdown();',
                    'if (allRecords.length > 0 && typeof loadRecord === "function") {',
                    'loadRecord(currentIndex);',
                    '} else if (typeof updateCounter === "function") {',
                    'updateCounter();',
                    '}',
                    '})();'
                ].join('');

                frameWin.eval(script);
                if (forceRender !== false && typeof frameWin.redrawAll === 'function') {
                    frameWin.redrawAll();
                }
            } catch (e) {}
        }

        function syncUnifiedDataToEmbedded(forceRender) {
            ensureUnifiedCollections();
            syncDosieDataToEmbedded(forceRender);
            syncAudiogramDataToEmbedded(forceRender);
        }

        function ensureEmbeddedAppLoaded(frameId, htmlB64) {
            var frame = document.getElementById(frameId);
            if (!frame) return;
            if (frame.dataset.hooked !== '1') {
                frame.addEventListener('load', function() {
                    if (frameId === 'dosieFrame') {
                        syncDosieDataToEmbedded(true);
                    } else if (frameId === 'audiogramFrame') {
                        syncAudiogramDataToEmbedded(true);
                    }
                });
                frame.dataset.hooked = '1';
            }
            if (frame.dataset.loaded === '1') return;
            frame.srcdoc = b64ToUtf8(htmlB64);
            frame.dataset.loaded = '1';
        }
        
        function switchTab(tab) {
            // Pull latest edits from embedded apps before changing tab.
            pullEmbeddedDataToUnified();

            // Hide all tab contents
            var tabContents = document.getElementsByClassName('tab-content');
            for (var i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }
            
            // Remove active class from all tabs
            var tabs = document.getElementsByClassName('tab');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            
            // Show the selected tab content and mark tab as active
            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');
            
            // Update any necessary data when switching tabs
            if (tab === 'students') updateStats();
            if (tab === 'schedule') renderSchedule();
            if (tab === 'progress') updateProgressStudentList();
            if (tab === 'plans') { renderPlansList(); renderLinksList(); }
            if (tab === 'trijazen') initTrijazenTab();
            if (tab === 'dosie') {
                ensureEmbeddedAppLoaded('dosieFrame', embeddedDosieHtmlB64);
                syncDosieDataToEmbedded(true);
            }
            if (tab === 'audiogramsApp') {
                ensureEmbeddedAppLoaded('audiogramFrame', embeddedAudiogramHtmlB64);
                syncAudiogramDataToEmbedded(true);
            }
            if (tab === 'generator') { genInitTab(); }
        }
        
        function showAddStudentModal() {
            editingStudent = null;
            updatePlanDropdown();
            document.getElementById('studentName').value = '';
            document.getElementById('studentGrade').value = '';
            document.getElementById('studentNeedsTrijazen').checked = false;
            document.getElementById('addStudentModal').classList.add('active');
        }
        
        function showAddPlanModal() {
            editingPlan = null;
            document.getElementById('planName').value = '';
            document.getElementById('planActivities').value = '';
            document.getElementById('addPlanModal').querySelector('h2').textContent = '–ö—Ä–µ–∏—Ä–∞—ò –ü–ª–∞–Ω';
            document.getElementById('addPlanModal').classList.add('active');
        }
        
        function editPlan(idx) {
            editingPlan = idx;
            var plan = plans[idx];
            document.getElementById('planName').value = plan.name;
            document.getElementById('planActivities').value = plan.activities.join('\n');
            document.getElementById('addPlanModal').querySelector('h2').textContent = '–ò–∑–º–µ–Ω–∏ –ü–ª–∞–Ω';
            document.getElementById('addPlanModal').classList.add('active');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
        
        function updatePlanDropdown() {
            var select = document.getElementById('studentPlan');
            select.innerHTML = '';
            
            if (plans.length === 0) {
                var opt = document.createElement('option');
                opt.value = '';
                opt.textContent = '–ù–µ–º–∞ –ø–ª–∞–Ω–æ–≤–∏ - –∫—Ä–µ–∏—Ä–∞—ò—Ç–µ –ø–ª–∞–Ω –ø—Ä–≤–æ';
                select.appendChild(opt);
            } else {
                for (var i = 0; i < plans.length; i++) {
                    var opt = document.createElement('option');
                    opt.value = plans[i].id;
                    opt.textContent = plans[i].name;
                    select.appendChild(opt);
                }
            }
        }
        
        function saveStudent() {
            var name = document.getElementById('studentName').value.trim();
            var grade = document.getElementById('studentGrade').value.trim();
            var planId = parseInt(document.getElementById('studentPlan').value);
            var needsTrijazen = document.getElementById('studentNeedsTrijazen').checked;

            if (!name || !grade || !planId) {
                alert('–ü–æ–ø–æ–ª–Ω–µ—Ç–µ –≥–∏ —Å–∏—Ç–µ –ø–æ–ª–∏—ö–∞');
                return;
            }

            if (editingStudent !== null) {
                // Editing existing student
                students[editingStudent].name = name;
                students[editingStudent].grade = grade;
                students[editingStudent].planId = planId;
                students[editingStudent].needsTrijazen = needsTrijazen;
                editingStudent = null;
            } else {
                // Adding new student
                var newStudent = { id: Date.now(), name: name, grade: grade, planId: planId, needsTrijazen: needsTrijazen };
                students.push(newStudent);
                studentProgress[newStudent.id] = {};
                studentProgress[newStudent.id][planId] = [];
            }
            
            saveData();
            renderStudentListSimple();
            updateStats();
            updateProgressStudentList();
            closeModal('addStudentModal');
        }
        
        function savePlan() {
            var name = document.getElementById('planName').value.trim();
            var activitiesText = document.getElementById('planActivities').value.trim();
            
            if (!name || !activitiesText) {
                alert('–ü–æ–ø–æ–ª–Ω–µ—Ç–µ –≥–∏ —Å–∏—Ç–µ –ø–æ–ª–∏—ö–∞');
                return;
            }
            
            var activities = activitiesText.split('\n').map(function(a) { return a.trim(); }).filter(function(a) { return a.length > 0; });
            
            if (editingPlan !== null) {
                // Editing existing plan
                plans[editingPlan].name = name;
                plans[editingPlan].activities = activities;
                editingPlan = null;
            } else {
                // Adding new plan
                plans.push({ id: Date.now(), name: name, activities: activities });
            }
            
            saveData();
            renderPlansList();
            updatePlanDropdown();
            closeModal('addPlanModal');
        }
        
        function renderStudentListSimple() {
            var list = document.getElementById('studentListSimple');
            list.innerHTML = '';
            
            // Add header with student count
            if (students.length > 0) {
                var header = document.createElement('h3');
                header.style.cssText = 'margin: 20px 0 15px 0; padding-bottom: 10px; border-bottom: 2px solid #667eea; color: #2d3748; font-size: 18px;';
                header.textContent = 'üìö –£—á–µ–Ω–∏—Ü–∏ (' + students.length + ')';
                list.appendChild(header);
            }
            
            for (var i = 0; i < students.length; i++) {
                var s = students[i];
                var plan = getPlanById(s.planId);
                var completed = (studentProgress[s.id] && studentProgress[s.id][s.planId]) ? studentProgress[s.id][s.planId].length : 0;
                var total = plan ? plan.activities.length : 0;
                
                // Count weekly sessions - two consecutive slots = one 40-min session
                var sessions40min = 0;
                var sessions20min = 0;
                
                for (var day in schedule) {
                    var processedSlots = [];
                    for (var t = 0; t < schedule[day].length; t++) {
                        if (processedSlots.indexOf(t) !== -1) continue; // Already counted
                        
                        if (schedule[day][t].indexOf(s.id) !== -1) {
                            // Check if student is also in the next consecutive slot
                            var isInNextSlot = (t + 1 < schedule[day].length && 
                                schedule[day][t + 1].indexOf(s.id) !== -1);
                            
                            // Check if previous slot was already processed (we're the second half)
                            var isPreviousProcessed = processedSlots.indexOf(t - 1) !== -1;
                            
                            if (isInNextSlot && !isPreviousProcessed) {
                                // Two consecutive slots = 1 session of 40 min (2x20 or 1x40)
                                sessions40min++;
                                processedSlots.push(t, t + 1); // Mark both as processed
                            } else if (!isPreviousProcessed) {
                                // Single slot
                                var numStudentsInSlot = schedule[day][t].length;
                                if (numStudentsInSlot === 1) {
                                    // Alone = 40 min
                                    sessions40min++;
                                } else {
                                    // With others = 20 min
                                    sessions20min++;
                                }
                                processedSlots.push(t);
                            }
                            // If isPreviousProcessed is true, do nothing (already counted)
                        }
                    }
                }

                // Calculate total sessions for display
                var totalSessions = sessions40min + sessions20min;
                var sessionDisplay = totalSessions > 0 ? totalSessions + ' —Å–µ—Å–∏–∏ –Ω–µ–¥–µ–ª–Ω–æ' : '–ù–µ–º–∞ —Å–µ—Å–∏–∏';
                
                var item = document.createElement('div');
                item.className = 'student-item';
                
                // Create up/down arrows
                var upDisabled = i === 0 ? ' disabled' : '';
                var downDisabled = i === students.length - 1 ? ' disabled' : '';
                
                var arrowsHTML = '<div class="student-item-arrows">' +
                    '<button class="arrow-btn" onclick="moveStudent(' + i + ', -1)" title="–ü–æ–º–µ—Å—Ç–∏ –Ω–∞–≥–æ—Ä–µ"' + upDisabled + '>‚Üë</button>' +
                    '<button class="arrow-btn" onclick="moveStudent(' + i + ', 1)" title="–ü–æ–º–µ—Å—Ç–∏ –Ω–∞–¥–æ–ª—É"' + downDisabled + '>‚Üì</button>' +
                    '</div>';
                
                item.innerHTML = arrowsHTML +
                    '<div class="student-item-info">' +
                    '<h4><span style="color: #667eea; font-weight: bold; margin-right: 8px;">' + (i + 1) + '.</span>' + 
                    s.grade + ' - ' + s.name + '</h4>' +
                    '<p>–ü–ª–∞–Ω: ' + (plan ? plan.name : 'N/A') + ' | ' + sessionDisplay + '</p>' +
                    '</div>' +
                    '<div class="student-item-actions">' +
                    '<button class="btn btn-primary" style="padding: 10px 20px; margin: 0;" onclick="editStudent(' + i + ')">–ò–∑–º–µ–Ω–∏</button>' +
                    '<button class="btn btn-danger" style="padding: 10px 20px; margin: 0;" onclick="deleteStudent(' + i + ')">–ò–∑–±—Ä–∏—à–∏</button>' +
                    '</div>';
                list.appendChild(item);
            }
        }
        
        function moveStudent(idx, direction) {
            var newIdx = idx + direction;
            
            // Validate bounds
            if (newIdx < 0 || newIdx >= students.length) return;
            
            // Swap students in array
            var temp = students[idx];
            students[idx] = students[newIdx];
            students[newIdx] = temp;
            
            saveData();
            renderStudentListSimple();
            updateStats();
            updateProgressStudentList();
        }
        
        function toggleStudentTrijazen(idx) {
            students[idx].needsTrijazen = !students[idx].needsTrijazen;
            saveData();
            renderStudentListSimple();
            updateTrijazenStudentList(); // Update dropdown in trijazen tab
        }
        
        function editStudent(idx) {
            editingStudent = idx;
            var s = students[idx];
            updatePlanDropdown();
            document.getElementById('studentName').value = s.name;
            document.getElementById('studentGrade').value = s.grade;
            document.getElementById('studentPlan').value = s.planId;
            document.getElementById('studentNeedsTrijazen').checked = s.needsTrijazen || false;
            document.getElementById('addStudentModal').classList.add('active');
        }
        
        function deleteStudent(idx) {
            if (!confirm('–ò–∑–±—Ä–∏—à–∏ –≥–æ —É—á–µ–Ω–∏–∫–æ—Ç?')) return;
            
            var studentId = students[idx].id;
            students.splice(idx, 1);
            
            // Remove from schedule
            for (var day in schedule) {
                for (var i = 0; i < schedule[day].length; i++) {
                    schedule[day][i] = schedule[day][i].filter(function(sid) { return sid !== studentId; });
                }
            }
            
            // Remove progress
            delete studentProgress[studentId];
            
            saveData();
            renderStudentListSimple();
            updateStats();
            updateProgressStudentList();
        }
        
        function updateStats() {
            var totalSlotsUsed = 0; // Count occupied hours (each hour = 2 slots)
            
            // Count occupied hours: if ANY student is in that hour, it's occupied = 2 slots
            for (var day in schedule) {
                for (var i = 0; i < schedule[day].length; i++) {
                    if (schedule[day][i].length > 0) {
                        // This hour is occupied (regardless of number of students)
                        totalSlotsUsed += 2;
                    }
                }
            }
            
            // Calculate capacity in 20-min slots: 5 days √ó 5 hours √ó 2 halves = 50 slots
            var maxSlots = 50;
            var totalMinutesUsed = totalSlotsUsed * 20;
            var maxCapacity = maxSlots * 20; // 1000 minutes
            var percentUsed = maxCapacity > 0 ? (totalMinutesUsed / maxCapacity * 100).toFixed(1) : 0;
            var availableMinutes = maxCapacity - totalMinutesUsed;
            
            // Update capacity display
            document.getElementById('capacityUsage').textContent = 
                totalMinutesUsed + '/' + maxCapacity + ' –º–∏–Ω | ' + percentUsed + '% –∏—Å–∫–æ—Ä–∏—Å—Ç–µ–Ω–æ';
            
            // Update progress bar
            var progressBar = document.getElementById('capacityProgressBar');
            progressBar.style.width = percentUsed + '%';
            progressBar.textContent = percentUsed + '%';
            
            // Set color based on usage
            progressBar.className = 'progress-bar-fill';
            if (percentUsed >= 100) {
                progressBar.classList.add('red');
            } else if (percentUsed >= 80) {
                progressBar.classList.add('yellow');
            } else {
                progressBar.classList.add('green');
            }
            
            // Update alert message and find free slots
            var alertDiv = document.getElementById('capacityAlert');
            alertDiv.innerHTML = '';
            
            // Find free time slots
            var freeSlots = [];
            for (var day in schedule) {
                for (var i = 0; i < schedule[day].length; i++) {
                    if (schedule[day][i].length === 0) {
                        var dayName = days[daysEng.indexOf(day)];
                        var timeLabel = timeSlots[i].label + ' (' + timeSlots[i].time + ')';
                        freeSlots.push(dayName + ' - –ß–∞—Å ' + timeLabel);
                    }
                }
            }
            
            if (percentUsed >= 100) {
                var item = document.createElement('div');
                item.className = 'capacity-item';
                item.style.color = '#e53e3e';
                item.innerHTML = '<span class="icon">‚ö†Ô∏è</span><span><strong>–ù–µ–º–∞ —Å–ª–æ–±–æ–¥–Ω–∏ —Ç–µ—Ä–º–∏–Ω–∏!</strong></span>';
                alertDiv.appendChild(item);
            } else if (percentUsed >= 80) {
                var available40 = Math.floor(availableMinutes / 40);
                var available20 = Math.floor(availableMinutes / 20);
                var item = document.createElement('div');
                item.className = 'capacity-item';
                item.style.color = '#d69e2e';
                item.innerHTML = '<span class="icon">üß°</span><span>' + availableMinutes + ' –º–∏–Ω —Å–ª–æ–±–æ–¥–Ω–∏ (' + 
                    available20 + ' —Å–ª–æ—Ç–∞)</span>';
                alertDiv.appendChild(item);
                
                // Show free slots
                if (freeSlots.length > 0) {
                    var freeItem = document.createElement('div');
                    freeItem.style.cssText = 'margin-top: 10px; padding: 10px; background: rgba(237, 137, 54, 0.1); border-radius: 5px; font-size: 13px;';
                    freeItem.innerHTML = '<strong>üìÖ –°–ª–æ–±–æ–¥–Ω–∏ —Ç–µ—Ä–º–∏–Ω–∏:</strong><br>' + freeSlots.join('<br>');
                    alertDiv.appendChild(freeItem);
                }
            } else {
                var available40 = Math.floor(availableMinutes / 40);
                var available20 = Math.floor(availableMinutes / 20);
                var item = document.createElement('div');
                item.className = 'capacity-item';
                item.style.color = '#38a169';
                item.innerHTML = '<span class="icon">üíö</span><span>' + availableMinutes + ' –º–∏–Ω —Å–ª–æ–±–æ–¥–Ω–∏ (' + 
                    available20 + ' —Å–ª–æ—Ç–∞)</span>';
                alertDiv.appendChild(item);
                
                // Show free slots
                if (freeSlots.length > 0) {
                    var freeItem = document.createElement('div');
                    freeItem.style.cssText = 'margin-top: 10px; padding: 10px; background: rgba(72, 187, 120, 0.1); border-radius: 5px; font-size: 13px;';
                    freeItem.innerHTML = '<strong>üìÖ –°–ª–æ–±–æ–¥–Ω–∏ —Ç–µ—Ä–º–∏–Ω–∏:</strong><br>' + freeSlots.join('<br>');
                    alertDiv.appendChild(freeItem);
                }
            }
            
            // Generate session summary for all students
            var sessionStats = {}; // Format: "2x40" -> {count: N, students: [names]}
            
            for (var i = 0; i < students.length; i++) {
                var s = students[i];
                var sessions40 = 0;
                var sessions20 = 0;
                
                // Count sessions for this student (same logic as renderStudentListSimple)
                for (var day in schedule) {
                    var processedSlots = [];
                    for (var t = 0; t < schedule[day].length; t++) {
                        if (processedSlots.indexOf(t) !== -1) continue;
                        
                        if (schedule[day][t].indexOf(s.id) !== -1) {
                            var isInNextSlot = (t + 1 < schedule[day].length && 
                                schedule[day][t + 1].indexOf(s.id) !== -1);
                            var isPreviousProcessed = processedSlots.indexOf(t - 1) !== -1;
                            
                            if (isInNextSlot && !isPreviousProcessed) {
                                sessions40++;
                                processedSlots.push(t, t + 1);
                            } else if (!isPreviousProcessed) {
                                var numStudentsInSlot = schedule[day][t].length;
                                if (numStudentsInSlot === 1) {
                                    sessions40++;
                                } else {
                                    sessions20++;
                                }
                                processedSlots.push(t);
                            }
                        }
                    }
                }
                
                // Create key like "2x40+1x20" or "2x40" or "1x20"
                var key = '';
                if (sessions40 > 0) key += sessions40 + 'x40';
                if (sessions20 > 0) {
                    if (key.length > 0) key += '+';
                    key += sessions20 + 'x20';
                }
                if (key.length === 0) key = '0';
                
                if (!sessionStats[key]) {
                    sessionStats[key] = {count: 0, students: []};
                }
                sessionStats[key].count++;
                sessionStats[key].students.push(s.name);
            }
            
            // Display session summary
            var summaryDiv = document.getElementById('sessionSummary');
            summaryDiv.innerHTML = '<strong style="font-size: 14px; display: block; margin-bottom: 10px;">üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–±–∞ –Ω–∞ —Å–µ—Å–∏–∏:</strong>';
            
            var sortedKeys = Object.keys(sessionStats).sort();
            for (var i = 0; i < sortedKeys.length; i++) {
                var key = sortedKeys[i];
                var data = sessionStats[key];
                var count = data.count;
                var studentNames = data.students;
                
                if (key === '0') {
                    summaryDiv.innerHTML += '<div class="capacity-item" style="margin: 5px 0; font-size: 13px;">' +
                        '<span style="color: #718096;">‚Ä¢ ' + count + ' —É—á–µ–Ω–∏—Ü–∏ –±–µ–∑ —Ä–∞—Å–ø–æ—Ä–µ–¥: ' + studentNames.join(', ') + '</span></div>';
                } else {
                    // Format key nicely: "2x40+1x20" -> "2 —Å–µ—Å–∏–∏ –ø–æ 40 –º–∏–Ω + 1 —Å–µ—Å–∏—ò–∞ –ø–æ 20 –º–∏–Ω"
                    var formatted = key.replace(/(\d+)x40/g, function(match, num) {
                        return num + (num == 1 ? ' —Å–µ—Å–∏—ò–∞' : ' —Å–µ—Å–∏–∏') + ' –ø–æ 40 –º–∏–Ω';
                    }).replace(/(\d+)x20/g, function(match, num) {
                        return num + (num == 1 ? ' —Å–µ—Å–∏—ò–∞' : ' —Å–µ—Å–∏–∏') + ' –ø–æ 20 –º–∏–Ω';
                    }).replace('+', ' + ');
                    
                    var studentWord = count == 1 ? '—É—á–µ–Ω–∏–∫' : '—É—á–µ–Ω–∏—Ü–∏';
                    summaryDiv.innerHTML += '<div class="capacity-item" style="margin: 5px 0; font-size: 13px;">' +
                        '<span style="color: #2d3748;"><strong>‚Ä¢ ' + count + ' ' + studentWord + ' —Å–æ ' + formatted + ':</strong><br>' +
                        '<span style="font-size: 12px; color: #4a5568; margin-left: 12px;">' + studentNames.join(', ') + '</span></span></div>';
                }
            }
        }
        
        function updateProgressStudentList() {
            var select = document.getElementById('progressStudentSelect');
            select.innerHTML = '<option value="">-- –ò–∑–±–µ—Ä–∏ —É—á–µ–Ω–∏–∫ --</option>';
            
            for (var i = 0; i < students.length; i++) {
                var opt = document.createElement('option');
                opt.value = students[i].id;
                opt.textContent = students[i].grade + ' - ' + students[i].name;
                select.appendChild(opt);
            }
        }
        
        function loadStudentProgress() {
            var studentId = parseInt(document.getElementById('progressStudentSelect').value);
            var container = document.getElementById('progressActivitiesList');
            container.innerHTML = '';
            
            if (!studentId) return;
            
            var student = getStudentById(studentId);
            if (!student) return;
            
            var plan = getPlanById(student.planId);
            if (!plan) {
                container.innerHTML = '<p>–£—á–µ–Ω–∏–∫–æ—Ç –Ω–µ–º–∞ –¥–æ–¥–µ–ª–µ–Ω –ø–ª–∞–Ω</p>';
                return;
            }
            
            var completed = (studentProgress[studentId] && studentProgress[studentId][student.planId]) ? studentProgress[studentId][student.planId] : [];

            completed.sort(function(a, b) {
                var dateA = new Date(a.date + 'T' + a.time.split('-')[0] + ':00');
                var dateB = new Date(b.date + 'T' + b.time.split('-')[0] + ':00');
                return dateA - dateB;
            });
            
            var completedIndices = new Set(completed.map(function(c) { return c.index; }));

            // Render completed items first, in chronological order
            completed.forEach(function(activityData) {
                var i = activityData.index;
                var item = document.createElement('div');
                item.className = 'progress-item completed';
                
                var dateParts = activityData.date.split('-');
                var formattedDate = dateParts[2] + '.' + dateParts[1] + '.' + dateParts[0];
                var timestampText = '–ó–∞–≤—Ä—à–µ–Ω–æ –Ω–∞: ' + formattedDate + ' ' + activityData.time;

                item.innerHTML = '<input type="checkbox" checked disabled>' +
                    '<div class="progress-item-content">' +
                    '<div class="progress-item-text">' + (i + 1) + '. ' + plan.activities[i] + '</div>' +
                    '<div class="progress-item-date">' + timestampText + '</div>' +
                    '</div>';
                container.appendChild(item);
            });

            // Render uncompleted items
            for (var i = 0; i < plan.activities.length; i++) {
                if (!completedIndices.has(i)) {
                    var item = document.createElement('div');
                    item.className = 'progress-item';
                    var timestampText = '–ù–µ –µ –∑–∞–≤—Ä—à–µ–Ω–æ';

                    item.innerHTML = '<input type="checkbox" disabled>' +
                        '<div class="progress-item-content">' +
                        '<div class="progress-item-text">' + (i + 1) + '. ' + plan.activities[i] + '</div>' +
                        '<div class="progress-item-date">' + timestampText + '</div>' +
                        '</div>';
                    container.appendChild(item);
                }
            }
        }
        
        function getActivityDate(studentId, activityIndex) {
            var student = getStudentById(studentId);
            if (!student) return 'N/A';
            
            var completed = (studentProgress[studentId] && studentProgress[studentId][student.planId]) ? studentProgress[studentId][student.planId] : [];
            
            for (var i = 0; i < completed.length; i++) {
                if (completed[i].index === activityIndex) {
                    if (completed[i].date && completed[i].time) {
                        var dateParts = completed[i].date.split('-');
                        return dateParts[2] + '.' + dateParts[1] + '.' + dateParts[0] + ' ' + completed[i].time;
                    }
                    return '–ó–∞–≤—Ä—à–µ–Ω–æ';
                }
            }
            
            return 'N/A';
        }
        
        function switchProgressView(view) {
            if (view === 'student') {
                document.getElementById('studentProgressView').style.display = 'block';
                document.getElementById('monthlyProgressView').style.display = 'none';
            } else {
                document.getElementById('studentProgressView').style.display = 'none';
                document.getElementById('monthlyProgressView').style.display = 'block';
                setCurrentMonth();
            }
        }
        
        function setCurrentMonth() {
            var now = new Date();
            document.getElementById('monthSelector').value = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
            generateMonthlyAttendance();
        }
        
        function generateMonthlyAttendance() {
            var monthValue = document.getElementById('monthSelector').value;
            if (!monthValue) return;
            
            var parts = monthValue.split('-');
            var year = parseInt(parts[0]);
            var month = parseInt(parts[1]);
            
            var monthNames = ['–à–∞–Ω—É–∞—Ä–∏', '–§–µ–≤—Ä—É–∞—Ä–∏', '–ú–∞—Ä—Ç', '–ê–ø—Ä–∏–ª', '–ú–∞—ò', '–à—É–Ω–∏', 
                             '–à—É–ª–∏', '–ê–≤–≥—É—Å—Ç', '–°–µ–ø—Ç–µ–º–≤—Ä–∏', '–û–∫—Ç–æ–º–≤—Ä–∏', '–ù–æ–µ–º–≤—Ä–∏', '–î–µ–∫–µ–º–≤—Ä–∏'];
            var monthName = monthNames[month - 1];
            
            var dayNames = ['–Ω–µ–¥.', '–ø–æ–Ω.', '–≤—Ç–æ.', '—Å—Ä–µ.', '—á–µ—Ç.', '–ø–µ—Ç.', '—Å–∞–±.'];
            
            var container = document.getElementById('monthlyAttendanceTable');
            var html = '<h3 class="month-header" style="text-align: center; margin-bottom: 15px; color: #2d3748;">' + monthName + ' ' + year + '</h3>';
            html += '<table class="attendance-table">';
            html += '<tr><th>–£—á–µ–Ω–∏–∫</th>';
            
            // Get all dates in month
            var lastDay = new Date(year, month, 0).getDate();
            for (var day = 1; day <= lastDay; day++) {
                html += '<th>' + day + '</th>';
            }
            html += '</tr>';
            
            // Add day names row
            html += '<tr><th></th>';
            for (var day = 1; day <= lastDay; day++) {
                var date = new Date(year, month - 1, day);
                var dayOfWeek = date.getDay();
                html += '<th style="font-size: 11px; font-weight: normal;">' + dayNames[dayOfWeek] + '</th>';
            }
            html += '</tr>';
            
            // For each student
            for (var i = 0; i < students.length; i++) {
                var s = students[i];
                html += '<tr><td>' + s.grade + ' - ' + s.name + '</td>';
                
                for (var day = 1; day <= lastDay; day++) {
                    var dateStr = year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0');
                    var hasAttendance = checkAttendanceForDate(s.id, dateStr);
                    html += '<td class="' + (hasAttendance ? 'date-cell' : '') + '">' + (hasAttendance ? '‚úì' : '') + '</td>';
                }
                html += '</tr>';
            }
            
            html += '</table>';
            container.innerHTML = html;
        }
        
        function checkAttendanceForDate(studentId, dateStr) {
            if (!attendance[dateStr]) return false;
            if (!attendance[dateStr][studentId]) return false;
            
            for (var key in attendance[dateStr][studentId]) {
                if (attendance[dateStr][studentId][key].status === 'present') return true;
            }
            return false;
        }
        
        function renderPlansList() {
            var container = document.getElementById('plansList');
            container.innerHTML = '';
            
            if (plans.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #a0aec0; padding: 20px;">–ù–µ–º–∞ –ø–ª–∞–Ω–æ–≤–∏. –ö—Ä–µ–∏—Ä–∞—ò—Ç–µ –Ω–æ–≤–∏ –ø–ª–∞–Ω–æ–≤–∏.</p>';
                return;
            }
            
            for (var i = 0; i < plans.length; i++) {
                var p = plans[i];
                var div = document.createElement('div');
                div.style.cssText = 'background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%); padding: 18px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #667eea; box-shadow: 0 4px 6px rgba(0,0,0,0.3);';
                div.innerHTML = '<h4 style="margin-bottom: 12px; color: #e2e8f0; font-size: 16px;">' + p.name + ' <span style="color: #a0aec0; font-size: 14px;">(' + p.activities.length + ' –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)</span></h4>' +
                    '<div style="display: flex; gap: 10px;">' +
                    '<button class="btn btn-primary" onclick="editPlan(' + i + ')">–ò–∑–º–µ–Ω–∏</button>' +
                    '<button class="btn" style="background: #f56565; color: white;" onclick="deletePlan(' + i + ')">–ò–∑–±—Ä–∏—à–∏</button>' +
                    '</div>';
                container.appendChild(div);
            }
        }
        
        function renderLinksList() {
            var container = document.getElementById('linksList');
            container.innerHTML = '';
            
            if (links.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #a0aec0; padding: 20px;">–ù–µ–º–∞ –ª–∏–Ω–∫–æ–≤–∏. –î–æ–¥–∞–¥–µ—Ç–µ –Ω–æ–≤–∏ –ª–∏–Ω–∫–æ–≤–∏.</p>';
                return;
            }
            
            for (var i = 0; i < links.length; i++) {
                var link = links[i];
                var div = document.createElement('div');
                div.style.cssText = 'background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%); padding: 18px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #48bb78; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 6px rgba(0,0,0,0.3);';
                div.innerHTML = '<div style="flex: 1;">' +
                    '<h4 style="margin-bottom: 8px; color: #e2e8f0; font-size: 16px;">' + link.name + '</h4>' +
                    '<a href="' + link.url + '" target="_blank" rel="noopener noreferrer" style="color: #818cf8; font-size: 13px; word-break: break-all; text-decoration: none;">' + link.url + '</a>' +
                    '</div>' +
                    '<div style="display: flex; gap: 10px; margin-left: 15px; flex-shrink: 0;">' +
                    '<a href="' + link.url + '" target="_blank" rel="noopener noreferrer" class="btn btn-success" style="text-decoration: none;">–û—Ç–≤–æ—Ä–∏</a>' +
                    '<button class="btn btn-primary" onclick="editLink(' + i + ')">–ò–∑–º–µ–Ω–∏</button>' +
                    '<button class="btn" style="background: #f56565; color: white;" onclick="deleteLink(' + i + ')">–ò–∑–±—Ä–∏—à–∏</button>' +
                    '</div>';
                container.appendChild(div);
            }
        }
        
        function deletePlan(idx) {
            if (!confirm('–ò–∑–±—Ä–∏—à–∏ –≥–æ –ø–ª–∞–Ω–æ—Ç?')) return;
            plans.splice(idx, 1);
            saveData();
            renderPlansList();
        }
        
        function showAddLinkModal() {
            editingLink = null;
            document.getElementById('linkName').value = '';
            document.getElementById('linkUrl').value = '';
            document.getElementById('addLinkModal').querySelector('h2').textContent = '–î–æ–¥–∞–¥–∏ –õ–∏–Ω–∫';
            document.getElementById('addLinkModal').classList.add('active');
        }
        
        function editLink(idx) {
            editingLink = idx;
            var link = links[idx];
            document.getElementById('linkName').value = link.name;
            document.getElementById('linkUrl').value = link.url;
            document.getElementById('addLinkModal').querySelector('h2').textContent = '–ò–∑–º–µ–Ω–∏ –õ–∏–Ω–∫';
            document.getElementById('addLinkModal').classList.add('active');
        }
        
        function saveLink() {
            var name = document.getElementById('linkName').value.trim();
            var url = document.getElementById('linkUrl').value.trim();
            
            if (!name || !url) {
                alert('–ü–æ–ø–æ–ª–Ω–µ—Ç–µ –≥–∏ —Å–∏—Ç–µ –ø–æ–ª–∏—ö–∞');
                return;
            }
            
            // Add https:// if no protocol specified
            if (!url.match(/^https?:\/\//i)) {
                url = 'https://' + url;
            }
            
            if (editingLink !== null) {
                // Editing existing link
                links[editingLink].name = name;
                links[editingLink].url = url;
                editingLink = null;
            } else {
                // Adding new link
                links.push({ id: Date.now(), name: name, url: url });
            }
            
            saveData();
            renderLinksList();
            closeModal('addLinkModal');
        }
        
        function deleteLink(idx) {
            if (!confirm('–ò–∑–±—Ä–∏—à–∏ –≥–æ –ª–∏–Ω–∫–æ—Ç?')) return;
            links.splice(idx, 1);
            saveData();
            renderLinksList();
        }
        
        function getStudentById(id) {
            for (var i = 0; i < students.length; i++) {
                if (students[i].id === id) return students[i];
            }
            return null;
        }
        
        function getPlanById(id) {
            for (var i = 0; i < plans.length; i++) {
                if (plans[i].id === id) return plans[i];
            }
            return null;
        }
        
        function changeWeek(dir) {
            // Save snapshot of current week before leaving (if it's current or future)
            var oldWeekKey = getWeekKey();
            var now = new Date();
            var todayStart = new Date();
            todayStart.setHours(0, 0, 0, 0);
            var currentMondayStart = new Date(todayStart);
            currentMondayStart.setDate(todayStart.getDate() - todayStart.getDay() + 1);
            var oldWeekDate = new Date(oldWeekKey);
            
            // Only save snapshot if we're leaving current or future week
            if (oldWeekDate >= currentMondayStart) {
                if (!scheduleHistory[oldWeekKey]) {
                    scheduleHistory[oldWeekKey] = JSON.parse(JSON.stringify(schedule));
                    saveData();
                }
            }
            
            currentWeek += dir;
            
            // Auto-lock when switching weeks (safety feature)
            pastWeeksUnlocked = false;
            
            // Clear undo/redo stacks when switching weeks
            undoStack = [];
            redoStack = [];
            
            renderSchedule();
            updateWeekDisplay();
            updateUndoRedoButtons();
        }
        
        function getWeekKey() {
            var now = new Date();
            now.setDate(now.getDate() + (currentWeek * 7));
            var monday = new Date(now);
            var day = monday.getDay();
            // Handle Sunday (day = 0) - go back 6 days to previous Monday
            var daysToMonday = day === 0 ? -6 : (1 - day);
            monday.setDate(monday.getDate() + daysToMonday);
            // Use local date format to avoid timezone issues
            var year = monday.getFullYear();
            var month = String(monday.getMonth() + 1).padStart(2, '0');
            var date = String(monday.getDate()).padStart(2, '0');
            return year + '-' + month + '-' + date;
        }
        
        function getScheduleForWeek(weekKey) {
            // Calculate if this week is in the past
            var now = new Date();
            var todayStart = new Date();
            todayStart.setHours(0, 0, 0, 0);
            var currentMondayStart = new Date(todayStart);
            var day = currentMondayStart.getDay();
            var daysToMonday = day === 0 ? -6 : (1 - day);
            currentMondayStart.setDate(currentMondayStart.getDate() + daysToMonday);
            
            var weekDate = new Date(weekKey);
            
            // For current and future weeks, ALWAYS use the live schedule (editable)
            if (weekDate >= currentMondayStart) {
                return schedule; // Live template - editable
            }
            
            // For past weeks, use historical snapshot if exists, otherwise reconstruct from attendance
            if (scheduleHistory[weekKey]) {
                return scheduleHistory[weekKey];
            }
            
            // If no snapshot exists, reconstruct from attendance records
            return reconstructScheduleFromAttendance(weekKey);
        }
        
        function reconstructScheduleFromAttendance(weekStartDate) {
            // Create empty schedule
            var reconstructed = {
                monday: [[], [], [], [], []],
                tuesday: [[], [], [], [], []],
                wednesday: [[], [], [], [], []],
                thursday: [[], [], [], [], []],
                friday: [[], [], [], [], []]
            };
            
            // Parse the week dates
            var weekStart = new Date(weekStartDate);
            
            // Go through each day of that week
            for (var d = 0; d < 5; d++) {
                var dayDate = new Date(weekStart);
                dayDate.setDate(weekStart.getDate() + d);
                // Use local date format to avoid timezone issues
                var year = dayDate.getFullYear();
                var month = String(dayDate.getMonth() + 1).padStart(2, '0');
                var dayNum = String(dayDate.getDate()).padStart(2, '0');
                var dateStr = year + '-' + month + '-' + dayNum;
                
                var dayName = daysEng[d];
                
                // Check attendance for this date
                if (attendance[dateStr]) {
                    // For each time slot
                    for (var t = 0; t < 5; t++) {
                        var studentsInSlot = [];
                        
                        // Check each student
                        for (var studentId in attendance[dateStr]) {
                            var key = dayName + '-' + t;
                            var attRecord = attendance[dateStr][studentId][key];
                            
                            if (attRecord) {
                                // Check status (handle both old string and new object format)
                                var status = typeof attRecord === 'string' ? attRecord : attRecord.status;
                                
                                if (status === 'present' || status === 'absent') {
                                    // This student had a scheduled session here
                                    var studentIdInt = parseInt(studentId);
                                    if (studentsInSlot.indexOf(studentIdInt) === -1) {
                                        studentsInSlot.push(studentIdInt);
                                    }
                                }
                            }
                        }
                        
                        reconstructed[dayName][t] = studentsInSlot;
                    }
                }
            }
            
            return reconstructed;
        }
        
        function getWeekNumber(date) {
            var d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            var dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }
        
        function getSchoolWeekInfo(date) {
            // School year 2025/2026 starts on September 2, 2025
            var schoolYearStart = new Date(2025, 8, 2); // September 2, 2025 (month is 0-indexed)
            var firstHalfEnd = new Date(2026, 0, 30); // January 30, 2026 (end of 18th week)
            var schoolYearEnd = new Date(2026, 5, 12); // June 12, 2026 (end of school year)
            
            // Holidays (weeks to skip)
            var holidays = [
                { start: new Date(2026, 0, 1), end: new Date(2026, 0, 21) }, // Winter break (Jan 1-21)
                { start: new Date(2026, 1, 1), end: new Date(2026, 1, 8) }, // February break
                { start: new Date(2026, 2, 30), end: new Date(2026, 3, 5) }, // Easter break
            ];
            
            var monday = new Date(date);
            monday.setDate(date.getDate() - date.getDay() + 1);
            
            // Check if in holiday
            var isHoliday = false;
            for (var i = 0; i < holidays.length; i++) {
                if (monday >= holidays[i].start && monday <= holidays[i].end) {
                    isHoliday = true;
                    break;
                }
            }
            
            // Calculate week number
            var weekNumber = 0;
            var currentDate = new Date(schoolYearStart);
            
            while (currentDate <= monday) {
                var inHoliday = false;
                for (var i = 0; i < holidays.length; i++) {
                    if (currentDate >= holidays[i].start && currentDate <= holidays[i].end) {
                        inHoliday = true;
                        break;
                    }
                }
                if (!inHoliday && currentDate < schoolYearEnd) {
                    weekNumber++;
                }
                currentDate.setDate(currentDate.getDate() + 7);
            }
            
            // Determine which half
            var half = weekNumber <= 18 ? 'I' : 'II';
            var totalWeeks = 39;
            var weeksRemaining = totalWeeks - weekNumber;
            var halfWeeksTotal = half === 'I' ? 18 : 21;
            var halfWeekNumber = half === 'I' ? weekNumber : (weekNumber - 18);
            
            return {
                week: weekNumber,
                half: half,
                halfWeek: halfWeekNumber,
                halfTotal: halfWeeksTotal,
                remaining: weeksRemaining,
                total: totalWeeks,
                isHoliday: isHoliday,
                inSchoolYear: monday >= schoolYearStart && monday < schoolYearEnd
            };
        }
        
        function updateWeekDisplay() {
            var now = new Date();
            now.setDate(now.getDate() + (currentWeek * 7));
            var monday = new Date(now);
            monday.setDate(monday.getDate() - monday.getDay() + 1);
            var friday = new Date(monday);
            friday.setDate(monday.getDate() + 4);
            
            var schoolWeek = getSchoolWeekInfo(monday);
            
            var weekInfo = '';
            if (!schoolWeek.inSchoolYear) {
                weekInfo = '–ò–∑–≤–æ–Ω —É—á–µ–±–Ω–∞ –≥–æ–¥–∏–Ω–∞';
            } else if (schoolWeek.isHoliday) {
                weekInfo = '–†–∞—Å–ø—É—Å—Ç';
            } else {
                weekInfo = '–°–µ–¥–º–∏—Ü–∞ ' + schoolWeek.week + ' –æ–¥ ' + schoolWeek.total + 
                    ' (' + schoolWeek.half + ' –ø–æ–ª—É–≥–æ–¥–∏–µ: ' + schoolWeek.halfWeek + ' –æ–¥ ' + schoolWeek.halfTotal + ')';
            }
            
            var dateRange = String(monday.getDate()).padStart(2, '0') + '.' + String(monday.getMonth()+1).padStart(2, '0') + '.' + monday.getFullYear() + ' - ' + 
                String(friday.getDate()).padStart(2, '0') + '.' + String(friday.getMonth()+1).padStart(2, '0') + '.' + friday.getFullYear();
            
            document.getElementById('weekDisplay').innerHTML = 
                '<div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">' + dateRange + '</div>' +
                '<div style="font-size: 13px; font-weight: bold; color: #667eea;">' + weekInfo + '</div>';
            
            // Show/hide lock button and undo/redo buttons based on whether viewing a past week
            var todayStart = new Date();
            todayStart.setHours(0, 0, 0, 0);
            var currentMondayStart = new Date(todayStart);
            currentMondayStart.setDate(todayStart.getDate() - todayStart.getDay() + 1);
            var lockBtn = document.getElementById('lockToggleBtn');
            var undoBtn = document.getElementById('undoBtn');
            var redoBtn = document.getElementById('redoBtn');
            
            if (monday < currentMondayStart) {
                // Viewing past week - show lock button
                lockBtn.style.display = 'block';
                updateLockButtonAppearance();
                
                // Show undo/redo buttons only when unlocked
                if (pastWeeksUnlocked) {
                    undoBtn.style.display = 'block';
                    redoBtn.style.display = 'block';
                } else {
                    undoBtn.style.display = 'none';
                    redoBtn.style.display = 'none';
                }
            } else {
                // Viewing current or future week - hide lock button and undo/redo
                lockBtn.style.display = 'none';
                undoBtn.style.display = 'none';
                redoBtn.style.display = 'none';
            }
        }
        
        function togglePastWeekLock() {
            pastWeeksUnlocked = !pastWeeksUnlocked;
            updateLockButtonAppearance();
            updateWeekDisplay(); // Refresh to show/hide undo/redo buttons
            
            if (pastWeeksUnlocked) {
                alert('üîì –ò–∑–º–∏–Ω–∞—Ç–∞ —Å–µ–¥–º–∏—Ü–∞ –µ –æ—Ç–∫–ª—É—á–µ–Ω–∞!\n\n–°–µ–≥–∞ –º–æ–∂–µ—Ç–µ –¥–∞ –≥–∏ –º–µ–Ω—É–≤–∞—Ç–µ –ø–æ–¥–∞—Ç–æ—Ü–∏—Ç–µ –∑–∞ –º–∏–Ω–∞—Ç–∏—Ç–µ –Ω–µ–¥–µ–ª–∏.\n\n‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –ü—Ä–æ–º–µ–Ω–∏—Ç–µ –Ω–∞ –∏—Å—Ç–æ—Ä–∏—Å–∫–∏ –ø–æ–¥–∞—Ç–æ—Ü–∏ –º–æ–∂–µ –¥–∞ –≤–ª–∏—ò–∞–∞—Ç –Ω–∞ —Ç–æ—á–Ω–æ—Å—Ç–∞ –Ω–∞ –∑–∞–ø–∏—Å–∏—Ç–µ.');
            }
        }
        
        function updateLockButtonAppearance() {
            var lockBtn = document.getElementById('lockToggleBtn');
            if (pastWeeksUnlocked) {
                lockBtn.style.background = '#48bb78';
                lockBtn.innerHTML = 'üîì –ò–∑–º–∏–Ω–∞—Ç–∞ —Å–µ–¥–º–∏—Ü–∞ –µ –æ—Ç–∫–ª—É—á–µ–Ω–∞';
            } else {
                lockBtn.style.background = '#e53e3e';
                lockBtn.innerHTML = 'üîí –ò–∑–º–∏–Ω–∞—Ç–∞ —Å–µ–¥–º–∏—Ü–∞ –µ –∑–∞–∫–ª—É—á–µ–Ω–∞';
            }
        }
        
        function createStudentSlot(sid, day, timeIdx, position, totalStudents, dateStr, isMerged) {
            var student = getStudentById(sid);
            if (!student) {
                console.error('Student not found:', sid);
                return document.createElement('div');
            }
            
            var slot = document.createElement('div');
            slot.className = 'student-slot';
            slot.dataset.sid = String(sid);
            slot.dataset.day = day; // This should already be a string
            slot.dataset.time = String(timeIdx); // Ensure this is always a string
            slot.dataset.position = String(position);
            slot.dataset.merged = isMerged ? 'true' : 'false';
            
            // Debug log for problematic student
            if (student.grade === 'VI' && student.name.includes('–ï–º–∏–Ω')) {
                console.log('Creating slot for –ï–º–∏–Ω –ï—Ç–µ–º–æ–≤:', {
                    sid: sid,
                    day: day, 
                    timeIdx: timeIdx,
                    dateStr: dateStr,
                    isMerged: isMerged
                });
            }
            
            var key = day + '-' + timeIdx;
            var status = null;
            
            if (attendance[dateStr] && attendance[dateStr][sid] && attendance[dateStr][sid][key]) {
                var attData = attendance[dateStr][sid][key];
                // Handle both old string format and new object format
                if (typeof attData === 'string') {
                    status = attData; // Old format: "present" or "absent"
                } else if (attData.status) {
                    status = attData.status; // New format: {status: "present", ...}
                }
            }
            
            // For merged cells, also check the second slot's status
            if (isMerged && timeIdx + 1 < timeSlots.length) {
                var key2 = day + '-' + (timeIdx + 1);
                if (attendance[dateStr] && attendance[dateStr][sid] && attendance[dateStr][sid][key2]) {
                    var attData2 = attendance[dateStr][sid][key2];
                    var status2 = null;
                    // Handle both formats for second slot too
                    if (typeof attData2 === 'string') {
                        status2 = attData2;
                    } else if (attData2.status) {
                        status2 = attData2.status;
                    }
                    
                    if (status2 === 'present' || status === 'present') {
                        status = 'present';
                    } else if (status2 === 'absent' || status === 'absent') {
                        status = 'absent';
                    }
                }
            }
            
            if (status === 'present') slot.classList.add('present');
            if (status === 'absent') slot.classList.add('absent');
            
            // Build slot content with attendance indicator and order label
            var orderText = '';
            if (totalStudents > 1 && !isMerged) {
                orderText = (position + 1) + '/' + totalStudents;
            }
            
            // Create attendance indicator
            var indicatorClass = 'attendance-indicator';
            if (status === 'present') indicatorClass += ' present';
            if (status === 'absent') indicatorClass += ' absent';
            
            var fullName = student.grade + ' - ' + student.name;
            slot.innerHTML = 
                '<div class="' + indicatorClass + '" data-sid="' + sid + '" data-day="' + day + '" data-time="' + timeIdx + '" data-merged="' + (isMerged ? 'true' : 'false') + '">' + orderText + '</div>' +
                '<span class="student-slot-name" title="' + fullName + '">' + fullName + '</span>';
            return slot;
        }
        
        function renderSchedule() {
            // Detect if viewing past week
    var now = new Date();
    var viewingWeekStart = new Date(now);
    viewingWeekStart.setDate(now.getDate() + (currentWeek * 7) - now.getDay() + 1);
    viewingWeekStart.setHours(0, 0, 0, 0);
    
    var todayStart = new Date();
    todayStart.setHours(0, 0, 0, 0);
    
    var currentMondayStart = new Date(todayStart);
    currentMondayStart.setDate(todayStart.getDate() - todayStart.getDay() + 1);
    
    var isPastWeek = viewingWeekStart < currentMondayStart;
    
    // Show/hide past week notice
    var scheduleContainer = document.getElementById('schedule');
    var existingNotice = document.getElementById('pastWeekNotice');
    
    if (isPastWeek) {
        if (!existingNotice) {
            var notice = document.createElement('div');
            notice.id = 'pastWeekNotice';
            notice.className = 'past-week-notice';
            notice.innerHTML = '<span class="icon">üîí</span>' +
                '<span><strong>–ì–ª–µ–¥–∞—Ç–µ –∏—Å—Ç–æ—Ä–∏—Å–∫–∞ –Ω–µ–¥–µ–ª–∞.</strong> ' +
                '–ü–æ–¥–∞—Ç–æ—Ü–∏—Ç–µ —Å–µ –∑–∞—à—Ç–∏—Ç–µ–Ω–∏ –∏ –Ω–µ –º–æ–∂–∞—Ç –¥–∞ —Å–µ –º–µ–Ω—É–≤–∞–∞—Ç. ' +
                '–†–∞—Å–ø–æ—Ä–µ–¥–æ—Ç –µ —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∏—Ä–∞–Ω –æ–¥ –∑–∞–ø–∏—Å–∏—Ç–µ –∑–∞ –ø—Ä–∏—Å—É—Ç–Ω–æ—Å—Ç.</span>';
            var weekNav = scheduleContainer.querySelector('.week-nav');
            scheduleContainer.insertBefore(notice, weekNav);
        }
    } else {
        if (existingNotice) {
            existingNotice.remove();
        }
    }
    
    // Get the schedule for the week we're viewing
    var weekKey = getWeekKey();
    var weekSchedule = getScheduleForWeek(weekKey);
    
            var grid = document.getElementById('scheduleGrid');
            grid.innerHTML = '';
            grid.className = 'schedule-grid';
            
            // Calculate the actual week dates
            var now = new Date();
            now.setDate(now.getDate() + (currentWeek * 7));
            var monday = new Date(now);
            monday.setDate(monday.getDate() - monday.getDay() + 1);
            
            var headerTime = document.createElement('div');
            headerTime.className = 'schedule-header';
            headerTime.textContent = '–ß–∞—Å';
            grid.appendChild(headerTime);
            
            for (var i = 0; i < days.length; i++) {
                var headerDay = document.createElement('div');
                headerDay.className = 'schedule-header';
                
                // Calculate date for this day
                var dayDate = new Date(monday);
                dayDate.setDate(monday.getDate() + i);
                var dayNum = String(dayDate.getDate()).padStart(2, '0');
                var monthNum = String(dayDate.getMonth() + 1).padStart(2, '0');
                var yearNum = dayDate.getFullYear();
                
                headerDay.innerHTML = '<div style="font-size: 14px; font-weight: bold;">' + days[i] + '</div>' +
                    '<div style="font-size: 11px; margin-top: 3px;">' + dayNum + '. ' + monthNum + '. ' + yearNum + '</div>';
                grid.appendChild(headerDay);
            }
            
            // Track which cells should be skipped (because they're merged)
            var mergedCells = {};
            
            for (var t = 0; t < timeSlots.length; t++) {
                var time = timeSlots[t];
                var timeCell = document.createElement('div');
                timeCell.className = 'schedule-time';
                timeCell.innerHTML = '<div style="font-size: 20px; font-weight: bold; margin-bottom: 5px;">' + time.label + '</div>' +
                    '<div style="font-size: 11px; line-height: 1.6; white-space: nowrap;">' + time.half1 + '</div>' +
                    '<div style="font-size: 11px; line-height: 1.6; white-space: nowrap;">' + time.half2 + '</div>';
                grid.appendChild(timeCell);
                
                for (var d = 0; d < daysEng.length; d++) {
                    var day = daysEng[d];
                    var cellKey = day + '-' + t;
                    
                    // Skip this cell if it's been merged with the previous one
                    if (mergedCells[cellKey]) {
                        continue;
                    }
                    
                    // Calculate actual date for this cell
                    var cellDate = new Date(monday);
                    cellDate.setDate(monday.getDate() + d);
                    // Use local date format to avoid timezone issues
                    var year = cellDate.getFullYear();
                    var month = String(cellDate.getMonth() + 1).padStart(2, '0');
                    var dayNum = String(cellDate.getDate()).padStart(2, '0');
                    var dateStr = year + '-' + month + '-' + dayNum;
                    
                    var studentIds = weekSchedule[day][t];
                    var nextSlotStudents = t + 1 < timeSlots.length ? weekSchedule[day][t + 1] : [];
                    
                    // Check for cross-slot merge: last student of current slot is first student of next slot
                    var crossSlotMerge = false;
                    var mergeStudentId = null;
                    if (studentIds.length > 1 && nextSlotStudents.length > 1 && t + 1 < timeSlots.length) {
                        var lastStudentCurrent = studentIds[studentIds.length - 1];
                        var firstStudentNext = nextSlotStudents[0];
                        if (lastStudentCurrent === firstStudentNext) {
                            crossSlotMerge = true;
                            mergeStudentId = lastStudentCurrent;
                        }
                    }
                    
                    // Check if this should be a simple merged cell (single student in consecutive slots)
                    var shouldMerge = false;
                    if (studentIds.length === 1 && nextSlotStudents.length === 1 && studentIds[0] === nextSlotStudents[0]) {
                        shouldMerge = true;
                        mergedCells[day + '-' + (t + 1)] = true;
                    }
                    
                    var cell = document.createElement('div');
                    
                    if (crossSlotMerge) {
                        // Create split cell with 3 sections
                        cell.className = 'schedule-cell-split';
                        cell.style.gridRow = 'span 2';
                        mergedCells[day + '-' + (t + 1)] = true;
                        
                        // Top half - students from current slot except the last one
                        var topHalf = document.createElement('div');
                        topHalf.className = 'schedule-cell-half';
                        if (t % 2 === 0) topHalf.classList.add('odd-row');
                        topHalf.dataset.day = day;
                        topHalf.dataset.time = t;
                        for (var s = 0; s < studentIds.length - 1; s++) {
                            topHalf.appendChild(createStudentSlot(studentIds[s], day, t, s, studentIds.length, dateStr, false));
                        }
                        cell.appendChild(topHalf);
                        
                        // Middle merged - the student that spans both
                        var middle = document.createElement('div');
                        middle.className = 'schedule-cell';
                        middle.classList.add('merged');
                        middle.dataset.day = day;
                        middle.dataset.time = t;
                        // Pass day and time explicitly - the createStudentSlot function will set attributes correctly
                        middle.appendChild(createStudentSlot(mergeStudentId, day, t, studentIds.length - 1, 1, dateStr, true));
                        cell.appendChild(middle);
                        
                        // Bottom half - students from next slot except the first one
                        var bottomHalf = document.createElement('div');
                        bottomHalf.className = 'schedule-cell-half';
                        if ((t + 1) % 2 === 0) bottomHalf.classList.add('odd-row');
                        bottomHalf.dataset.day = day;
                        bottomHalf.dataset.time = t + 1;
                        for (var s = 1; s < nextSlotStudents.length; s++) {
                            bottomHalf.appendChild(createStudentSlot(nextSlotStudents[s], day, t + 1, s, nextSlotStudents.length, dateStr, false));
                        }
                        cell.appendChild(bottomHalf);
                        
                    } else {
                        // Regular cell or simple merge
                        cell.className = 'schedule-cell';
                        if (t % 2 === 0) cell.classList.add('odd-row');
                        cell.dataset.day = day;
                        cell.dataset.time = t;
                        
                        if (shouldMerge) {
                            cell.style.gridRow = 'span 2';
                            cell.classList.add('merged');
                        }
                        
                        for (var s = 0; s < studentIds.length; s++) {
                            cell.appendChild(createStudentSlot(studentIds[s], day, t, s, studentIds.length, dateStr, shouldMerge));
                        }
                    }
                    
                    grid.appendChild(cell);
                }
            }
            
            setTimeout(function() {
                // Select ALL attendance indicators
                var indicators = document.querySelectorAll('.attendance-indicator');
                console.log('Found ' + indicators.length + ' attendance indicators to attach handlers');
                
                for (var i = 0; i < indicators.length; i++) {
                    indicators[i].addEventListener('click', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        
                        var sid = parseInt(this.dataset.sid);
                        var day = this.dataset.day;
                        var timeIdx = parseInt(this.dataset.time);
                        var isMerged = this.dataset.merged === 'true';
                        
                        // Debug logging
                        console.log('Clicked slot:', {
                            sid: sid,
                            day: day,
                            timeIdx: timeIdx,
                            isMerged: isMerged,
                            dataset: this.dataset,
                            student: getStudentById(sid)
                        });
                        
                        // Check if required data is present
                        if (!sid || !day || isNaN(timeIdx)) {
                            console.error('Missing data for slot click:', {sid: sid, day: day, timeIdx: timeIdx});
                            alert('Error: Missing data for this slot. Please refresh the page.');
                            return;
                        }
                        
                        if (isMerged && timeIdx + 1 < timeSlots.length) {
                            // For merged cells, sync both slots to same state
                            // Calculate the actual week dates
                            var now = new Date();
                            now.setDate(now.getDate() + (currentWeek * 7));
                            var monday = new Date(now);
                            var dayOfWeek = monday.getDay();
                            var daysToMonday = dayOfWeek === 0 ? -6 : (1 - dayOfWeek);
                            monday.setDate(monday.getDate() + daysToMonday);
                            var dayIndex = daysEng.indexOf(day);
                            var actualDate = new Date(monday);
                            actualDate.setDate(monday.getDate() + dayIndex);
                            var year = actualDate.getFullYear();
                            var month = String(actualDate.getMonth() + 1).padStart(2, '0');
                            var dayNum = String(actualDate.getDate()).padStart(2, '0');
                            var dateStr = year + '-' + month + '-' + dayNum;
                            
                            if (!attendance[dateStr]) attendance[dateStr] = {};
                            if (!attendance[dateStr][sid]) attendance[dateStr][sid] = {};
                            
                            var key1 = day + '-' + timeIdx;
                            var key2 = day + '-' + (timeIdx + 1);
                            var current1 = attendance[dateStr][sid][key1];
                            
                            var timeSlot1 = timeSlots[timeIdx].time;
                            var timeSlot2 = timeSlots[timeIdx + 1].time;
                            
                            if (!current1) {
                                // Unaddressed -> Present (1 session = 1 activity, regardless of duration)
                                attendance[dateStr][sid][key1] = { status: 'present', date: dateStr, time: timeSlot1 + ' + ' + timeSlot2 };
                                attendance[dateStr][sid][key2] = { status: 'present', date: dateStr, time: timeSlot1 + ' + ' + timeSlot2 };
                                checkNextActivity(sid, dateStr, timeSlot1 + ' + ' + timeSlot2);
                            } else if (current1.status === 'present') {
                                // Present -> Absent
                                attendance[dateStr][sid][key1] = { status: 'absent', date: dateStr, time: timeSlot1 + ' + ' + timeSlot2 };
                                attendance[dateStr][sid][key2] = { status: 'absent', date: dateStr, time: timeSlot1 + ' + ' + timeSlot2 };
                                uncheckLastActivity(sid, dateStr, timeSlot1 + ' + ' + timeSlot2);
                            } else if (current1.status === 'absent') {
                                // Absent -> Unaddressed (reset)
                                delete attendance[dateStr][sid][key1];
                                delete attendance[dateStr][sid][key2];
                            }
                            
                            saveData();
                            renderSchedule();
                        } else {
                            // Regular cell - normal toggle
                            toggleAttendance(sid, day, timeIdx);
                        }
                    });
                }
                
                // Add click handlers for regular cells (excluding merged cells to avoid conflicts)
                var cells = document.querySelectorAll('.schedule-cell:not(.merged)');
                for (var i = 0; i < cells.length; i++) {
                    cells[i].addEventListener('click', function(e) {
                        // Check if click is on a student slot or any of its children
                        var clickedElement = e.target;
                        var isStudentSlotClick = false;
                        
                        // Walk up the DOM tree to see if we're inside a student-slot
                        while (clickedElement && clickedElement !== this) {
                            if (clickedElement.classList && clickedElement.classList.contains('student-slot')) {
                                isStudentSlotClick = true;
                                break;
                            }
                            clickedElement = clickedElement.parentElement;
                        }
                        
                        // Only open modal if NOT clicking on a student slot
                        if (!isStudentSlotClick) {
                            var day = this.dataset.day;
                            var timeIdx = parseInt(this.dataset.time);
                            openAssignModal(day, timeIdx);
                        }
                    });
                }
                
                // Add click handlers for merged cells too
                var mergedCells = document.querySelectorAll('.schedule-cell.merged');
                for (var i = 0; i < mergedCells.length; i++) {
                    mergedCells[i].addEventListener('click', function(e) {
                        // Check if click is on a student slot or any of its children
                        var clickedElement = e.target;
                        var isStudentSlotClick = false;
                        
                        // Walk up the DOM tree to see if we're inside a student-slot
                        while (clickedElement && clickedElement !== this) {
                            if (clickedElement.classList && clickedElement.classList.contains('student-slot')) {
                                isStudentSlotClick = true;
                                break;
                            }
                            clickedElement = clickedElement.parentElement;
                        }
                        
                        // Only open modal if NOT clicking on a student slot
                        if (!isStudentSlotClick) {
                            var day = this.dataset.day;
                            var timeIdx = parseInt(this.dataset.time);
                            openAssignModal(day, timeIdx);
                        }
                    });
                }
                
                // Add click handlers for half cells
                var halfCells = document.querySelectorAll('.schedule-cell-half');
                for (var i = 0; i < halfCells.length; i++) {
                    halfCells[i].addEventListener('click', function(e) {
                        // Check if click is on a student slot or any of its children
                        var clickedElement = e.target;
                        var isStudentSlotClick = false;
                        
                        // Walk up the DOM tree to see if we're inside a student-slot
                        while (clickedElement && clickedElement !== this) {
                            if (clickedElement.classList && clickedElement.classList.contains('student-slot')) {
                                isStudentSlotClick = true;
                                break;
                            }
                            clickedElement = clickedElement.parentElement;
                        }
                        
                        // Only open modal if NOT clicking on a student slot
                        if (!isStudentSlotClick) {
                            var day = this.dataset.day;
                            var timeIdx = parseInt(this.dataset.time);
                            openAssignModal(day, timeIdx);
                        }
                    });
                }
            }, 0);
        }
        
        function openAssignModal(day, timeIdx) {
            currentSlot = { day: day, timeIdx: timeIdx };
            var list = document.getElementById('checkboxList');
            list.innerHTML = '';
            
            // Determine which schedule to read from
            var weekKey = getWeekKey();
            var now = new Date();
            var todayStart = new Date();
            todayStart.setHours(0, 0, 0, 0);
            var currentMondayStart = new Date(todayStart);
            currentMondayStart.setDate(todayStart.getDate() - todayStart.getDay() + 1);
            
            var viewingWeekStart = new Date(now);
            viewingWeekStart.setDate(now.getDate() + (currentWeek * 7) - now.getDay() + 1);
            viewingWeekStart.setHours(0, 0, 0, 0);
            
            var isPastWeek = viewingWeekStart < currentMondayStart;
            var sourceSchedule = isPastWeek && scheduleHistory[weekKey] ? scheduleHistory[weekKey] : schedule;
            
            var current = sourceSchedule[day][timeIdx];
            checkOrder = current.slice(); // Copy current order
            
            for (var i = 0; i < students.length; i++) {
                var s = students[i];
                var item = document.createElement('div');
                item.className = 'checkbox-item';
                var checked = current.indexOf(s.id) !== -1 ? 'checked' : '';
                item.innerHTML = '<input type="checkbox" id="cb-' + s.id + '" value="' + s.id + '" ' + checked + '>' +
                    '<label for="cb-' + s.id + '">' + s.grade + ' - ' + s.name + '</label>';
                list.appendChild(item);
            }
            
            // Add event listeners to track check order
            setTimeout(function() {
                var checkboxes = document.querySelectorAll('#checkboxList input[type="checkbox"]');
                for (var i = 0; i < checkboxes.length; i++) {
                    checkboxes[i].addEventListener('change', function() {
                        var id = parseInt(this.value);
                        if (this.checked) {
                            // Add to order if not already there
                            if (checkOrder.indexOf(id) === -1) {
                                checkOrder.push(id);
                            }
                        } else {
                            // Remove from order
                            var idx = checkOrder.indexOf(id);
                            if (idx !== -1) {
                                checkOrder.splice(idx, 1);
                            }
                        }
                    });
                }
            }, 0);
            
            document.getElementById('assignModal').classList.add('active');
        }
        
       function assignStudents() {
    if (!currentSlot) return;
    
    // CHECK IF EDITING PAST WEEK
    var now = new Date();
    var viewingWeekStart = new Date(now);
    viewingWeekStart.setDate(now.getDate() + (currentWeek * 7) - now.getDay() + 1);
    viewingWeekStart.setHours(0, 0, 0, 0);
    
    var todayStart = new Date();
    todayStart.setHours(0, 0, 0, 0);
    
    // Monday of current real week
    var currentMondayStart = new Date(todayStart);
    currentMondayStart.setDate(todayStart.getDate() - todayStart.getDay() + 1);
    
    if (viewingWeekStart < currentMondayStart && !pastWeeksUnlocked) {
        alert('‚ö†Ô∏è –ù–µ –º–æ–∂–µ—Ç–µ –¥–∞ –º–µ–Ω—É–≤–∞—Ç–µ —Ä–∞—Å–ø–æ—Ä–µ–¥ –Ω–∞ –º–∏–Ω–∞—Ç–∏ –Ω–µ–¥–µ–ª–∏!\n\n' +
              '–ò–∑–º–∏–Ω–∞—Ç–∞ —Å–µ–¥–º–∏—Ü–∞ –µ –∑–∞—à—Ç–∏—Ç–µ–Ω–∞ –∑–∞ –¥–∞ —Å–µ –∑–∞—á—É–≤–∞–∞—Ç —Ç–æ—á–Ω–∏—Ç–µ –∑–∞–ø–∏—Å–∏.\n\n' +
              '–ü—Ä–æ–º–µ–Ω–∏—Ç–µ –º–æ–∂–∞—Ç –¥–∞ —Å–µ –ø—Ä–∞–≤–∞—Ç —Å–∞–º–æ –∑–∞ —Ç–µ–∫–æ–≤–Ω–∞—Ç–∞ –∏ –∏–¥–Ω–∏—Ç–µ –Ω–µ–¥–µ–ª–∏.\n\n' +
              '–ö–ª–∏–∫–Ω–µ—Ç–µ –Ω–∞ "üîí –ò–∑–º–∏–Ω–∞—Ç–∞ —Å–µ–¥–º–∏—Ü–∞ –µ –∑–∞–∫–ª—É—á–µ–Ω–∞" –∑–∞ –¥–∞ —ò–∞ –æ—Ç–∫–ª—É—á–∏—Ç–µ.');
        closeModal('assignModal');
        return;
    }
    
    var weekKey = getWeekKey();
    var isPastWeek = viewingWeekStart < currentMondayStart;
    
    // Determine which schedule to modify
    var targetSchedule;
    if (isPastWeek) {
        // Editing past week - modify historical schedule
        if (!scheduleHistory[weekKey]) {
            scheduleHistory[weekKey] = JSON.parse(JSON.stringify(schedule));
        }
        targetSchedule = scheduleHistory[weekKey];
    } else {
        // Editing current/future week - modify live schedule
        targetSchedule = schedule;
        
        // Save snapshot before making changes
        if (!scheduleHistory[weekKey]) {
            scheduleHistory[weekKey] = JSON.parse(JSON.stringify(schedule));
        }
    }
    
    // Save state for undo
    saveUndoState({
        type: 'scheduleChange',
        weekKey: weekKey,
        day: currentSlot.day,
        timeIdx: currentSlot.timeIdx,
        oldValue: targetSchedule[currentSlot.day][currentSlot.timeIdx].slice(),
        newValue: checkOrder.slice(),
        isPastWeek: isPastWeek
    });
    
    // Apply the change
    targetSchedule[currentSlot.day][currentSlot.timeIdx] = checkOrder.slice();
    
    // If editing live schedule, ensure it's reflected
    if (!isPastWeek) {
        schedule[currentSlot.day][currentSlot.timeIdx] = checkOrder.slice();
    }
    
    saveData();
    renderSchedule();
    renderStudentListSimple();
    updateStats();
    closeModal('assignModal');
}
        
        function saveUndoState(action) {
            // Save current state to undo stack
            undoStack.push(action);
            
            // Limit undo stack to last 10 changes
            if (undoStack.length > 10) {
                undoStack.shift();
            }
            
            // Clear redo stack when new action is performed
            redoStack = [];
            
            updateUndoRedoButtons();
        }
        
        function undoLastChange() {
            if (undoStack.length === 0) return;
            
            var action = undoStack.pop();
            
            if (action.type === 'scheduleChange') {
                // Determine which schedule to modify
                var targetSchedule;
                if (action.isPastWeek) {
                    targetSchedule = scheduleHistory[action.weekKey];
                } else {
                    targetSchedule = schedule;
                }
                
                // Save current state to redo stack
                redoStack.push(action);
                
                // Restore old value
                targetSchedule[action.day][action.timeIdx] = action.oldValue.slice();
                
                // If live schedule, update it
                if (!action.isPastWeek) {
                    schedule[action.day][action.timeIdx] = action.oldValue.slice();
                }
                
                saveData();
                renderSchedule();
                renderStudentListSimple();
                updateStats();
            }
            
            updateUndoRedoButtons();
        }
        
        function redoLastChange() {
            if (redoStack.length === 0) return;
            
            var action = redoStack.pop();
            
            if (action.type === 'scheduleChange') {
                // Determine which schedule to modify
                var targetSchedule;
                if (action.isPastWeek) {
                    targetSchedule = scheduleHistory[action.weekKey];
                } else {
                    targetSchedule = schedule;
                }
                
                // Save back to undo stack
                undoStack.push(action);
                
                // Reapply new value
                targetSchedule[action.day][action.timeIdx] = action.newValue.slice();
                
                // If live schedule, update it
                if (!action.isPastWeek) {
                    schedule[action.day][action.timeIdx] = action.newValue.slice();
                }
                
                saveData();
                renderSchedule();
                renderStudentListSimple();
                updateStats();
            }
            
            updateUndoRedoButtons();
        }
        
        function updateUndoRedoButtons() {
            var undoBtn = document.getElementById('undoBtn');
            var redoBtn = document.getElementById('redoBtn');
            
            if (undoBtn) {
                undoBtn.disabled = undoStack.length === 0;
                undoBtn.style.opacity = undoStack.length === 0 ? '0.5' : '1';
                undoBtn.style.cursor = undoStack.length === 0 ? 'not-allowed' : 'pointer';
            }
            
            if (redoBtn) {
                redoBtn.disabled = redoStack.length === 0;
                redoBtn.style.opacity = redoStack.length === 0 ? '0.5' : '1';
                redoBtn.style.cursor = redoStack.length === 0 ? 'not-allowed' : 'pointer';
            }
        }
        
        function toggleAttendance(sid, day, timeIdx) {
            // Calculate the actual date for this day in the current week
            var now = new Date();
            now.setDate(now.getDate() + (currentWeek * 7));
            var monday = new Date(now);
            var dayOfWeek = monday.getDay();
            var daysToMonday = dayOfWeek === 0 ? -6 : (1 - dayOfWeek);
            monday.setDate(monday.getDate() + daysToMonday);
            
            var dayIndex = daysEng.indexOf(day);
            var actualDate = new Date(monday);
            actualDate.setDate(monday.getDate() + dayIndex);
            var year = actualDate.getFullYear();
            var month = String(actualDate.getMonth() + 1).padStart(2, '0');
            var dayNum = String(actualDate.getDate()).padStart(2, '0');
            var dateStr = year + '-' + month + '-' + dayNum;
            
            if (!attendance[dateStr]) attendance[dateStr] = {};
            if (!attendance[dateStr][sid]) attendance[dateStr][sid] = {};
            
            var key = day + '-' + timeIdx;
            var current = attendance[dateStr][sid][key];
            var timeSlot = timeSlots[timeIdx].time;
            
            // Handle both old string format ("present"/"absent") and new object format ({status: "present"})
            var currentStatus = null;
            if (current) {
                if (typeof current === 'string') {
                    currentStatus = current; // Old format
                } else if (current.status) {
                    currentStatus = current.status; // New format
                }
            }

            if (!currentStatus) {
                // Unaddressed -> Present
                attendance[dateStr][sid][key] = { status: 'present', date: dateStr, time: timeSlot };
                checkNextActivity(sid, dateStr, timeSlot);
            } else if (currentStatus === 'present') {
                // Present -> Absent
                attendance[dateStr][sid][key] = { status: 'absent', date: dateStr, time: timeSlot };
                uncheckLastActivity(sid, dateStr, timeSlot);
            } else if (currentStatus === 'absent') {
                // Absent -> Unaddressed (reset)
                delete attendance[dateStr][sid][key];
            }
            
            saveData();
            renderSchedule();
        }
        
        function uncheckLastActivity(studentId, dateStr, timeSlot) {
            var student = getStudentById(studentId);
            if (!student) return;

            var completed = (studentProgress[studentId] && studentProgress[studentId][student.planId]) ? studentProgress[studentId][student.planId] : [];
            if (completed.length === 0) return;

            // Find the specific activity completed on this date and time to remove it
            let activityToRemoveIndex = -1;
            for (let i = completed.length - 1; i >= 0; i--) {
                if (completed[i].date === dateStr && completed[i].time === timeSlot) {
                    activityToRemoveIndex = i;
                    break;
                }
            }

            if (activityToRemoveIndex > -1) {
                completed.splice(activityToRemoveIndex, 1);
            }
        }

        function checkNextActivity(studentId, dateStr, timeSlot) {
            var student = getStudentById(studentId);
            if (!student) return;
            
            var plan = getPlanById(student.planId);
            if (!plan || !plan.activities || plan.activities.length === 0) return;
            
            if (!studentProgress[studentId]) {
                studentProgress[studentId] = {};
            }
            if (!studentProgress[studentId][student.planId]) {
                studentProgress[studentId][student.planId] = [];
            }
            
            var completed = studentProgress[studentId][student.planId];
            
            for (var i = 0; i < plan.activities.length; i++) {
                var alreadyCompleted = false;
                for (var j = 0; j < completed.length; j++) {
                    if (completed[j].index === i) {
                        alreadyCompleted = true;
                        break;
                    }
                }
                
                if (!alreadyCompleted) {
                    completed.push({
                        index: i,
                        date: dateStr,
                        time: timeSlot
                    });
                    break;
                }
            }
            
            saveData();
        }
        
        function rebuildStudentProgress(studentId) {
            var student = getStudentById(studentId);
            if (!student) return;
            
            var plan = getPlanById(student.planId);
            if (!plan || !plan.activities || plan.activities.length === 0) return;
            
            // Clear existing progress for this student's current plan
            if (!studentProgress[studentId]) studentProgress[studentId] = {};
            studentProgress[studentId][student.planId] = [];
            
            // Collect all attendance records for this student
            var attendanceRecords = [];
            for (var dateStr in attendance) {
                if (attendance[dateStr][studentId]) {
                    for (var key in attendance[dateStr][studentId]) {
                        var attData = attendance[dateStr][studentId][key];
                        if (attData.status === 'present') {
                            attendanceRecords.push({
                                date: dateStr,
                                time: attData.time,
                                key: key
                            });
                        }
                    }
                }
            }
            
            // Sort by date and time
            attendanceRecords.sort(function(a, b) {
                var dateCompare = a.date.localeCompare(b.date);
                if (dateCompare !== 0) return dateCompare;
                return a.time.localeCompare(b.time);
            });
            
            // Remove duplicates for merged sessions (same date+time)
            var uniqueRecords = [];
            var seen = new Set();
            for (var i = 0; i < attendanceRecords.length; i++) {
                var record = attendanceRecords[i];
                var recordKey = record.date + '|' + record.time;
                if (!seen.has(recordKey)) {
                    seen.add(recordKey);
                    uniqueRecords.push(record);
                }
            }
            
            // Check activities in order based on attendance
            var completed = studentProgress[studentId][student.planId];
            for (var i = 0; i < uniqueRecords.length && i < plan.activities.length; i++) {
                completed.push({
                    index: i,
                    date: uniqueRecords[i].date,
                    time: uniqueRecords[i].time
                });
            }
            
            saveData();
        }
        
        function rebuildAllProgress() {
            if (!confirm('–û–≤–∞ —ú–µ –≥–∏ —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∏—Ä–∞ —Å–∏—Ç–µ –ø–æ–¥–∞—Ç–æ—Ü–∏ –∑–∞ –Ω–∞–ø—Ä–µ–¥–æ–∫ –≤—Ä–∑ –±–∞–∑–∞ –Ω–∞ –ø—Ä–∏—Å—É—Ç–Ω–æ—Å—Ç–∞. –î–∞–ª–∏ —Å—Ç–µ —Å–∏–≥—É—Ä–Ω–∏?')) return;
            
            for (var i = 0; i < students.length; i++) {
                rebuildStudentProgress(students[i].id);
            }
            
            renderAll();
            alert('–ù–∞–ø—Ä–µ–¥–æ–∫–æ—Ç –µ —É—Å–ø–µ—à–Ω–æ —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∏—Ä–∞–Ω –∑–∞ —Å–∏—Ç–µ —É—á–µ–Ω–∏—Ü–∏!');
        }
        
        function hasOwn(obj, key) {
            return Object.prototype.hasOwnProperty.call(obj || {}, key);
        }

        function isDiaryStudentShape(student) {
            return !!(
                student &&
                typeof student === 'object' &&
                hasOwn(student, 'id') &&
                typeof student.name === 'string' &&
                hasOwn(student, 'planId')
            );
        }

        function isUnifiedStudentShape(student) {
            return !!(
                student &&
                typeof student === 'object' &&
                (
                    hasOwn(student, 'studentId') ||
                    hasOwn(student, 'firstName') ||
                    hasOwn(student, 'lastName') ||
                    hasOwn(student, 'audiograms') ||
                    hasOwn(student, 'triage')
                )
            );
        }

        function normalizeName(value) {
            return (value || '').toString().replace(/\s+/g, ' ').trim();
        }

        function splitName(fullName) {
            var normalized = normalizeName(fullName);
            if (!normalized) {
                return { firstName: '', lastName: '' };
            }
            var parts = normalized.split(' ');
            if (parts.length === 1) {
                return { firstName: parts[0], lastName: '' };
            }
            return {
                firstName: parts[0],
                lastName: parts.slice(1).join(' ')
            };
        }

        function ensureUnifiedCollections() {
            if (!Array.isArray(window.trijazenTestovi)) window.trijazenTestovi = [];
            if (!Array.isArray(window.studentRecords)) window.studentRecords = [];
            if (!Array.isArray(window.audiogramRecords)) window.audiogramRecords = [];
        }

        function ensureStudentProgressStructure() {
            if (!studentProgress || typeof studentProgress !== 'object') {
                studentProgress = {};
            }

            for (var i = 0; i < students.length; i++) {
                var s = students[i];
                if (!s || !hasOwn(s, 'id')) continue;

                if (!studentProgress[s.id] || typeof studentProgress[s.id] !== 'object') {
                    studentProgress[s.id] = {};
                }

                if (!Array.isArray(studentProgress[s.id][s.planId])) {
                    studentProgress[s.id][s.planId] = [];
                }
            }
        }

        function getDefaultPlanIdForImport() {
            if (Array.isArray(plans) && plans.length > 0) {
                return plans[0].id;
            }

            var autoPlanId = Date.now();
            plans = [{
                id: autoPlanId,
                name: '–û—Å–Ω–æ–≤–µ–Ω –ø–ª–∞–Ω (–∞–≤—Ç–æ–º–∞—Ç—Å–∫–∏ import)',
                activities: ['–ò–Ω–∏—Ü–∏—ò–∞–ª–Ω–∞ –ø—Ä–æ—Ü–µ–Ω–∫–∞']
            }];
            return autoPlanId;
        }

        function mapUnifiedStudentsToDiaryStudents(unifiedStudents) {
            if (!Array.isArray(unifiedStudents)) return [];

            var defaultPlanId = getDefaultPlanIdForImport();
            var seenIds = {};
            var mapped = [];

            for (var i = 0; i < unifiedStudents.length; i++) {
                var u = unifiedStudents[i];
                if (!u || typeof u !== 'object') continue;

                var fullName = normalizeName(u.name || ((u.firstName || '') + ' ' + (u.lastName || '')));
                if (!fullName) continue;

                var rawId = Number(u.studentId || u.id);
                var studentId = Number.isFinite(rawId) ? rawId : (Date.now() + i);
                while (seenIds[studentId]) {
                    studentId += 1;
                }
                seenIds[studentId] = true;

                mapped.push({
                    id: studentId,
                    name: fullName,
                    grade: u.grade || '',
                    planId: defaultPlanId,
                    needsTrijazen: true
                });
            }

            return mapped;
        }

        function extractStudentRecords(payload) {
            if (!payload || typeof payload !== 'object') return [];

            if (Array.isArray(payload.studentRecords)) return payload.studentRecords;
            if (Array.isArray(payload.student_records)) return payload.student_records;
            if (payload.data && Array.isArray(payload.data.student_records)) return payload.data.student_records;

            var records = [];
            if (Array.isArray(payload.students)) {
                for (var i = 0; i < payload.students.length; i++) {
                    var s = payload.students[i];
                    if (!isUnifiedStudentShape(s)) continue;

                    var fullName = normalizeName(s.name || ((s.firstName || '') + ' ' + (s.lastName || '')));
                    var parts = splitName(fullName);

                    records.push({
                        id: s.studentId || s.id || (Date.now() + i),
                        firstName: s.firstName || parts.firstName,
                        lastName: s.lastName || parts.lastName,
                        grade: s.grade || '',
                        timestamp: s.timestamp || new Date().toISOString(),
                        birthDate: s.birthDate || '',
                        contact: s.contact || '',
                        fatherName: s.fatherName || '',
                        motherName: s.motherName || '',
                        address: s.address || '',
                        residence: s.residence || '',
                        findings: s.findings || '',
                        opinion: s.opinion || '',
                        attachmentLinks: Array.isArray(s.attachmentLinks) ? s.attachmentLinks : []
                    });
                }
            }

            return records;
        }

        function extractAudiogramRecords(payload) {
            if (!payload || typeof payload !== 'object') return [];

            if (Array.isArray(payload.audiogramRecords)) return payload.audiogramRecords;
            if (Array.isArray(payload.audiograms)) return payload.audiograms;
            if (payload.data && Array.isArray(payload.data.audiograms)) return payload.data.audiograms;

            var records = [];

            // Standalone audiogram export format (numeric keys + optional top-level snapshot)
            for (var key in payload) {
                if (!Object.prototype.hasOwnProperty.call(payload, key)) continue;
                if (/^\d+$/.test(key) && payload[key] && payload[key].subjectName) {
                    records.push({
                        subjectName: payload[key].subjectName,
                        date: payload[key].date || null,
                        rightAir: payload[key].rightAir || {},
                        rightBone: payload[key].rightBone || {},
                        leftAir: payload[key].leftAir || {},
                        leftBone: payload[key].leftBone || {},
                        recordType: 'history'
                    });
                }
            }

            if (payload.subjectName && (payload.rightAir || payload.leftAir || payload.rightBone || payload.leftBone)) {
                records.push({
                    subjectName: payload.subjectName,
                    date: payload.date || null,
                    rightAir: payload.rightAir || {},
                    rightBone: payload.rightBone || {},
                    leftAir: payload.leftAir || {},
                    leftBone: payload.leftBone || {},
                    recordType: 'current_snapshot'
                });
            }

            // Unified merged format (students[].audiograms)
            if (Array.isArray(payload.students)) {
                for (var i = 0; i < payload.students.length; i++) {
                    var s = payload.students[i];
                    if (!s || !Array.isArray(s.audiograms)) continue;

                    var subjectName = normalizeName(s.name || ((s.firstName || '') + ' ' + (s.lastName || '')));
                    for (var j = 0; j < s.audiograms.length; j++) {
                        var a = s.audiograms[j] || {};
                        records.push({
                            subjectName: subjectName || a.subjectName || '',
                            date: a.date || null,
                            rightAir: a.rightAir || {},
                            rightBone: a.rightBone || {},
                            leftAir: a.leftAir || {},
                            leftBone: a.leftBone || {},
                            recordType: a.recordType || 'history'
                        });
                    }
                }
            }

            return records;
        }

        function extractTrijazenTests(payload) {
            if (!payload || typeof payload !== 'object') return [];

            if (Array.isArray(payload.trijazenTestovi)) return payload.trijazenTestovi;
            if (payload.data && Array.isArray(payload.data.triage)) return payload.data.triage;

            var tests = [];

            // Unified merged format (students[].triage.tests)
            if (Array.isArray(payload.students)) {
                for (var i = 0; i < payload.students.length; i++) {
                    var s = payload.students[i];
                    if (!s || typeof s !== 'object' || !s.triage) continue;

                    var studentId = Number(s.studentId || s.id);
                    if (!Number.isFinite(studentId)) {
                        studentId = Date.now() + i;
                    }

                    var studentName = normalizeName(s.name || ((s.firstName || '') + ' ' + (s.lastName || '')));

                    if (Array.isArray(s.triage.tests) && s.triage.tests.length > 0) {
                        for (var j = 0; j < s.triage.tests.length; j++) {
                            var t = s.triage.tests[j] || {};
                            tests.push({
                                id: t.id || (Date.now() + i + j),
                                studentId: studentId,
                                studentName: studentName,
                                grade: s.grade || '',
                                date: t.date || s.triage.latestTestDate || '',
                                assessor: t.assessor || s.triage.latestAssessor || '',
                                timestamp: t.timestamp || new Date().toISOString(),
                                assessments: t.assessments || {}
                            });
                        }
                    } else if (s.triage.latestAssessments && typeof s.triage.latestAssessments === 'object') {
                        tests.push({
                            id: Date.now() + i,
                            studentId: studentId,
                            studentName: studentName,
                            grade: s.grade || '',
                            date: s.triage.latestTestDate || '',
                            assessor: s.triage.latestAssessor || '',
                            timestamp: new Date().toISOString(),
                            assessments: s.triage.latestAssessments
                        });
                    }
                }
            }

            return tests;
        }

        function parseJsonSafely(raw, sourceLabel) {
            if (typeof raw !== 'string') return null;
            var cleaned = raw.replace(/^\uFEFF/, '').trim();
            if (!cleaned) return null;
            try {
                return JSON.parse(cleaned);
            } catch (err) {
                throw new Error((sourceLabel || 'JSON') + ': ' + err.message);
            }
        }

        function buildDiaryPayload() {
            pullEmbeddedDataToUnified();
            ensureUnifiedCollections();
            ensureStudentProgressStructure();

            return {
                students: students,
                schedule: schedule,
                scheduleHistory: scheduleHistory,
                attendance: attendance,
                plans: plans,
                links: links,
                studentProgress: studentProgress,
                trijazenTestovi: window.trijazenTestovi || [],
                student_records: window.studentRecords || [],
                audiograms: window.audiogramRecords || []
            };
        }

        function saveData() {
            var data = buildDiaryPayload();
            localStorage.setItem('electronicDiary', JSON.stringify(data));
            isDataDirty = true;
        }

        function loadData() {
            var saved = localStorage.getItem('electronicDiary');
            if (saved) {
                try {
                    var data = parseJsonSafely(saved, '–õ–æ–∫–∞–ª–Ω–∏ –ø–æ–¥–∞—Ç–æ—Ü–∏') || {};

                    if (Array.isArray(data.students) && data.students.length > 0 && isDiaryStudentShape(data.students[0])) {
                        students = data.students;
                    }
                    if (data.schedule) schedule = data.schedule;
                    if (data.attendance) attendance = data.attendance;
                    if (data.plans) plans = data.plans;
                    if (data.links) links = data.links;
                    if (data.studentProgress) studentProgress = data.studentProgress;
                    if (data.scheduleHistory) scheduleHistory = data.scheduleHistory;

                    var loadedTrijazen = extractTrijazenTests(data);
                    if (loadedTrijazen.length > 0 || hasOwn(data, 'trijazenTestovi') || (data.data && hasOwn(data.data, 'triage'))) {
                        window.trijazenTestovi = loadedTrijazen;
                    }

                    var loadedStudentRecords = extractStudentRecords(data);
                    if (loadedStudentRecords.length > 0 || hasOwn(data, 'student_records') || hasOwn(data, 'studentRecords') || (data.data && hasOwn(data.data, 'student_records'))) {
                        window.studentRecords = loadedStudentRecords;
                    }

                    var loadedAudiograms = extractAudiogramRecords(data);
                    if (loadedAudiograms.length > 0 || hasOwn(data, 'audiograms') || hasOwn(data, 'audiogramRecords')) {
                        window.audiogramRecords = loadedAudiograms;
                    }
                } catch (err) {
                    console.error('loadData error:', err);
                    // Corrupted local copy should not break startup, keep app usable.
                    localStorage.removeItem('electronicDiary');
                }
            }

            if (!scheduleHistory) scheduleHistory = {};
            ensureUnifiedCollections();
            ensureStudentProgressStructure();
            syncUnifiedDataToEmbedded(false);
            isDataDirty = false;
        }

        function exportData() {
            var data = buildDiaryPayload();
            var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'e_dnevnik_unified_state_v7.json';
            a.click();
            isDataDirty = false;
            alert('–ï–∫—Å–ø–æ—Ä—Ç–∏—Ä–∞–Ω–æ!');
        }

        function importData(e) {
            var file = e.target.files[0];
            if (!file) return;

            var reader = new FileReader();
            reader.onload = function(event) {
                try {
                    var data = parseJsonSafely(event.target.result || '', '–£–≤–µ–∑–µ–Ω JSON');
                    if (!data || typeof data !== 'object') {
                        throw new Error('–ü—Ä–∞–∑–µ–Ω –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω JSON');
                    }

                    if (data.schedule) schedule = data.schedule;
                    if (data.scheduleHistory) scheduleHistory = data.scheduleHistory;
                    if (!scheduleHistory) scheduleHistory = {};
                    if (data.attendance) attendance = data.attendance;
                    if (data.plans) plans = data.plans;
                    if (data.links) links = data.links;
                    if (data.studentProgress) studentProgress = data.studentProgress;

                    if (Array.isArray(data.students) && data.students.length > 0) {
                        if (isDiaryStudentShape(data.students[0])) {
                            students = data.students;
                        } else if (isUnifiedStudentShape(data.students[0])) {
                            var mappedStudents = mapUnifiedStudentsToDiaryStudents(data.students);
                            if (mappedStudents.length > 0) {
                                students = mappedStudents;
                            }
                        }
                    }

                    var importedTrijazen = extractTrijazenTests(data);
                    if (importedTrijazen.length > 0 || hasOwn(data, 'trijazenTestovi') || (data.data && hasOwn(data.data, 'triage'))) {
                        window.trijazenTestovi = importedTrijazen;
                    }

                    var importedStudentRecords = extractStudentRecords(data);
                    var hasStudentRecordSource = hasOwn(data, 'student_records') || hasOwn(data, 'studentRecords') || (data.data && hasOwn(data.data, 'student_records'));
                    var hasUnifiedStudents = Array.isArray(data.students) && data.students.length > 0 && isUnifiedStudentShape(data.students[0]);
                    if (importedStudentRecords.length > 0 || hasStudentRecordSource || hasUnifiedStudents) {
                        window.studentRecords = importedStudentRecords;
                    }

                    var importedAudiograms = extractAudiogramRecords(data);
                    var hasAudiogramSource = hasOwn(data, 'audiograms') || hasOwn(data, 'audiogramRecords') || (hasOwn(data, 'subjectName') && (hasOwn(data, 'rightAir') || hasOwn(data, 'leftAir')));
                    if (importedAudiograms.length > 0 || hasAudiogramSource || hasUnifiedStudents) {
                        window.audiogramRecords = importedAudiograms;
                    }

                    ensureUnifiedCollections();
                    ensureStudentProgressStructure();
                    syncUnifiedDataToEmbedded(true);

                    saveData();
                    renderAll();

                    var details = [];
                    if (Array.isArray(window.studentRecords) && window.studentRecords.length > 0) {
                        details.push('–î–æ—Å–∏–µ –∑–∞–ø–∏—Å–∏: ' + window.studentRecords.length);
                    }
                    if (Array.isArray(window.audiogramRecords) && window.audiogramRecords.length > 0) {
                        details.push('–ê—É–¥–∏–æ–≥—Ä–∞–º–∏: ' + window.audiogramRecords.length);
                    }
                    if (Array.isArray(window.trijazenTestovi) && window.trijazenTestovi.length > 0) {
                        details.push('–¢—Ä–∏—ò–∞–∂–Ω–∏ —Ç–µ—Å—Ç–æ–≤–∏: ' + window.trijazenTestovi.length);
                    }

                    alert('–ò–º–ø–æ—Ä—Ç–∏—Ä–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ!' + (details.length ? '\n' + details.join(' | ') : ''));
                } catch (err) {
                    console.error('importData error:', err);
                    alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≤—á–∏—Ç—É–≤–∞—ö–µ: ' + err.message);
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        }

        function renderAll() {
            renderStudentListSimple();
            renderSchedule();
            updateWeekDisplay();
            renderPlansList();
            renderLinksList();
            updateStats();
            updateProgressStudentList();
            updateUndoRedoButtons();
        }
        
        function manualSave() {
            saveData();
            alert('–ó–∞—á—É–≤–∞–Ω–æ!');
        }
        
        // Initialize
        loadData();
        renderAll(); // Ensure UI is rendered after loading data
        
        // Initialize trijazenTestovi if it doesn't exist
        if (!window.trijazenTestovi) {
            window.trijazenTestovi = [];
        }
        
        // Save snapshot of current week on load (to preserve current schedule)
        saveUndoState('Initial load');
        
        // Set up event listeners for undo/redo
        document.addEventListener('keydown', function(e) {
            // Ctrl+Z for undo
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                undoLastChange();
            }
            // Ctrl+Shift+Z or Ctrl+Y for redo
            if (((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'Z') || 
                ((e.ctrlKey || e.metaKey) && e.key === 'y')) {
                e.preventDefault();
                redoLastChange();
            }
        });
        
        // Set up auto-save interval (every 30 seconds)
        setInterval(function() {
            if (isDataDirty) {
                saveData();
                isDataDirty = false;
            }
        }, 30000);
        
        // Initialize trijazen tab when it's shown
        document.addEventListener('DOMContentLoaded', function() {
            // Generate the form
            generateTrijazenForm();
            
            // Initialize date picker with today's date
            var today = new Date();
            var dateStr = today.toISOString().split('T')[0];
            var dateEl = document.getElementById('trijazenDate');
            if (dateEl) dateEl.value = dateStr;
            
            // Set up student dropdown
            updateTrijazenStudentList();
        });
        
        // Trijazen Test Functions
        var phonemeData = [
            { section: '–°–∞–º–æ–≥–ª–∞—Å–∫–∏', phonemes: [
                { letter: '–∏', examples: '–∏–º–∞, –ú–∏–º–∏ —Å–≤–∏—Ä–∏' },
                { letter: '–µ', examples: '–µ–≤–µ, –±–µ–±–µ' },
                { letter: '–∞', examples: '–ê–Ω–∞, –º–∞–º–∞' },
                { letter: '–æ', examples: '–æ–ø–∞, –≤–æ–¥–∞, –æ–∫–æ' },
                { letter: '—É', examples: '—É—Ä–∞, —Ç—É–±–∞, —Ç—É—Ç—É' }
            ]},
            { section: '–ü–ª–æ–∑–∏–≤–Ω–∏ —Å–æ–≥–ª–∞—Å–∫–∏', phonemes: [
                { letter: '–ø', examples: '–ø–µ—Ç, –ø–∞–ø–∞, —Ç–æ–ø' },
                { letter: '–±', examples: '–±–∞–±–∞, —Ä–æ–±' },
                { letter: '—Ç', examples: '—Ç–∞—Ç–æ, —Å–∞–∞—Ç' },
                { letter: '–¥', examples: '–¥–µ–¥–æ, –º–µ–¥' },
                { letter: '–∫', examples: '–∫–æ—Å–∞, –æ–∫–æ, —Å–æ–∫' },
                { letter: '–≥', examples: '–≥—É–º–∞, –Ω–æ–≥–∞, —Ä–æ–≥' }
            ]},
            { section: '–ê—Ñ—Ä–∏–∫–∞—Ç–∏', phonemes: [
                { letter: '—Ü', examples: '—Ü—É—Ü–ª–∞, —Å–æ–Ω—Ü–µ, –º–µ—Å–µ—Ü' },
                { letter: '—ú', examples: '—ú–µ–±–µ, —Å–≤–µ—ú–∞, –Ω–æ—ú' },
                { letter: '—ì', examples: '—ì–µ–≤—Ä–µ–∫, –≤–µ—ì–∏' },
                { letter: '—á', examples: '—á–æ—Ä–∞–ø–∏, —É—á–∏, –º–µ—á' },
                { letter: '—ü', examples: '—ü—É—ü–µ, —ü–µ–±, –±–µ—ü' },
                { letter: '—ï', examples: '—ï–∏–¥' }
            ]},
            { section: '–§—Ä–∏–∫–∞—Ç–∏–≤–∏', phonemes: [
                { letter: '—Ñ', examples: '—Ñ—É—Å—Ç–∞–Ω, –∫–∞—Ñ–µ, —à—Ç–æ—Ñ' },
                { letter: '–≤', examples: '–≤–æ–¥–∞, –≥–ª–∞–≤–∞, –ª–∞–≤' },
                { letter: '—Å', examples: '—Å—Ç–æ–ª, –ø–∏—Å–º–æ, —á–∞—Å' },
                { letter: '–∑', examples: '–∑–∏–º–∞, –≤–∞–∑–Ω–∞, –≤–æ–∑' },
                { letter: '—à', examples: '—à—É–º–∞, —É—à–∏, –ª–æ—à' },
                { letter: '–∂', examples: '–∂–∞–±–∞, –∫–æ–∂–∞, –º–∞–∂' },
                { letter: '—Ö', examples: '—Ö—Ä–∞–Ω–∞, –ú–∏—Ö–æ, —à–∞—Ö' },
                { letter: '—ò', examples: '—ò–∞–¥–µ, –ú–∞—ò–∞, –º–∞—ò' },
                { letter: '—Ä', examples: '—Ä–∏–±–∞, –í–µ—Ä–∞, –±–æ—Ä' },
                { letter: '–º', examples: '–º–∞–º–∞, –º–µ—Å–æ, —Å–∞–º' },
                { letter: '–Ω', examples: '–Ω–∞–Ω–µ, –Ω–æ—Å, —á–µ–∫–∞–Ω' },
                { letter: '—ö', examples: '–∫–æ—ö, —Å–≤–∏—ö–∞' },
                { letter: '–ª', examples: '–ª–æ–ø–∞, –≥–ª–∞–≤–∞, —Å–æ–ª' },
                { letter: '—ô', examples: '—ô—É–±–æ–≤, –ø—Ä–∏–ª–µ–ø, –∑–µ–º—ò–∞' }
            ]}
        ];
        
        function generateTrijazenForm() {
            var container = document.getElementById('trijazenFormContainer');
            var html = '';
            
            for (var i = 0; i < phonemeData.length; i++) {
                var section = phonemeData[i];
                html += '<div class="section-header">' + section.section + '</div>';
                html += '<table class="trijazen-table"><thead><tr>';
                html += '<th>–ì–ª–∞—Å</th><th>–ü—Ä–∏–º–µ—Ä–∏</th><th>–û—Ü–µ–Ω–∫–∞</th>';
                html += '</tr></thead><tbody>';
                
                for (var j = 0; j < section.phonemes.length; j++) {
                    var phoneme = section.phonemes[j];
                    var phonemeId = phoneme.letter;
                    html += '<tr>';
                    html += '<td><strong>' + phoneme.letter + '</strong></td>';
                    html += '<td>' + phoneme.examples + '</td>';
                    html += '<td><div class="trijazen-toggle" onclick="autoSaveTrijazen(this, \'' + phonemeId + '\')" data-phoneme="' + phonemeId + '"></div></td>';
                    html += '</tr>';
                }
                
                html += '</tbody></table>';
            }
            
            container.innerHTML = html;
        }
        
        function initTrijazenTab() {
            generateTrijazenForm();
            updateTrijazenStudentList();
            var today = new Date();
            var dateStr = today.toISOString().split('T')[0];
            document.getElementById('trijazenDate').value = dateStr;
            
            // Add event listeners for auto-save on date/assessor change
            var dateInput = document.getElementById('trijazenDate');
            var assessorInput = document.getElementById('trijazenAssessor');
            
            if (dateInput) {
                dateInput.addEventListener('change', function() {
                    saveCurrentTrijazenTest();
                });
            }
            
            if (assessorInput) {
                assessorInput.addEventListener('blur', function() {
                    saveCurrentTrijazenTest();
                });
            }
        }
        
        function updateTrijazenStudentList() {
            var select = document.getElementById('trijazenStudentSelect');
            if (!select) return;
            
            // Save current selection
            var currentValue = select.value;
            
            // Clear existing options except the first one
            select.innerHTML = '<option value="">-- –ò–∑–±–µ—Ä–∏ —É—á–µ–Ω–∏–∫ --</option>';
            
            // Show ALL students (not just those with needsTrijazen flag)
            if (students.length === 0) {
                var noOption = document.createElement('option');
                noOption.value = '';
                noOption.textContent = '-- –ù–µ–º–∞ —É—á–µ–Ω–∏—Ü–∏ --';
                noOption.disabled = true;
                select.appendChild(noOption);
            } else {
                students.forEach(function(student) {
                    var option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = student.name + (student.grade ? ' (' + student.grade + ')' : '');
                    select.appendChild(option);
                });
            }
            
            // Restore selection if possible
            if (currentValue) {
                select.value = currentValue;
                updateTrijazenStudent();
            }
        }
        
        function updateTrijazenStudent() {
            var select = document.getElementById('trijazenStudentSelect');
            var gradeSpan = document.getElementById('trijazenGrade');
            
            if (!select || !gradeSpan) return;
            
            var studentId = parseInt(select.value);
            if (isNaN(studentId)) {
                gradeSpan.textContent = '–ò–∑–±–µ—Ä–µ—Ç–µ —É—á–µ–Ω–∏–∫';
                // Reset form when no student is selected
                resetTrijazenToggles();
                document.getElementById('trijazenDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('trijazenAssessor').value = '';
                return;
            }
            
            var student = students.find(function(s) { return s.id === studentId; });
            if (student) {
                gradeSpan.textContent = student.grade || '–ù–µ–º–∞ –ø–æ–¥–∞—Ç–æ—Ü–∏';
                // Reset form first
                resetTrijazenToggles();
                document.getElementById('trijazenDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('trijazenAssessor').value = '';
                // Then load existing test data for this student if any
                loadTrijazenData(studentId);
            } else {
                gradeSpan.textContent = '–ò–∑–±–µ—Ä–µ—Ç–µ —É—á–µ–Ω–∏–∫';
                resetTrijazenToggles();
                document.getElementById('trijazenDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('trijazenAssessor').value = '';
            }
        }
        
        function loadTrijazenData(studentId) {
            // Find the latest test for this student
            var latestTest = window.trijazenTestovi
                .filter(function(test) { return test.studentId === studentId; })
                .sort(function(a, b) { return new Date(b.timestamp) - new Date(a.timestamp); })[0];
                
            if (!latestTest) return;
            
            // Set the form values
            document.getElementById('trijazenDate').value = latestTest.date || '';
            document.getElementById('trijazenAssessor').value = latestTest.assessor || '';
            
            // Set toggle buttons
            var assessments = latestTest.assessments || {};
            var toggles = document.querySelectorAll('.trijazen-toggle');
            toggles.forEach(function(toggle) {
                var phoneme = toggle.getAttribute('data-phoneme');
                if (phoneme && assessments[phoneme]) {
                    var value = assessments[phoneme];
                    toggle.setAttribute('data-value', value);
                    
                    if (value === '+') {
                        toggle.className = 'trijazen-toggle plus';
                        toggle.textContent = '+';
                    } else if (value === '+-') {
                        toggle.className = 'trijazen-toggle plusminus';
                        toggle.textContent = '+-';
                    } else if (value === '-') {
                        toggle.className = 'trijazen-toggle minus';
                        toggle.textContent = '-';
                    }
                }
            });
        }
        
        // Auto-save trijazen on toggle click
        function autoSaveTrijazen(element, phonemeName) {
            var currentState = element.getAttribute('data-value') || '';
            var newState = '';
            
            // Cycle through states: '' ‚Üí '+' ‚Üí '+-' ‚Üí '-' ‚Üí ''
            if (currentState === '') {
                newState = '+';
                element.className = 'trijazen-toggle plus';
                element.textContent = '+';
            } else if (currentState === '+') {
                newState = '+-';
                element.className = 'trijazen-toggle plusminus';
                element.textContent = '+-';
            } else if (currentState === '+-') {
                newState = '-';
                element.className = 'trijazen-toggle minus';
                element.textContent = '-';
            } else {
                newState = '';
                element.className = 'trijazen-toggle';
                element.textContent = '';
            }
            
            element.setAttribute('data-value', newState);
            element.setAttribute('data-phoneme', phonemeName);
            
            // Auto-save immediately
            saveCurrentTrijazenTest();
        }
        
        // Save current trijazen test to localStorage
        function saveCurrentTrijazenTest() {
            var studentId = parseInt(document.getElementById('trijazenStudentSelect').value);
            if (isNaN(studentId)) return; // No student selected
            
            var date = document.getElementById('trijazenDate').value;
            var assessor = document.getElementById('trijazenAssessor').value.trim();
            
            if (!date) return; // Date is required, but assessor is optional
            
            var student = students.find(function(s) { return s.id === studentId; });
            if (!student) return;
            
            // Collect all toggle values
            var assessments = {};
            var toggles = document.querySelectorAll('.trijazen-toggle');
            toggles.forEach(function(toggle) {
                var phoneme = toggle.getAttribute('data-phoneme');
                var value = toggle.getAttribute('data-value') || '';
                if (phoneme && value) {
                    assessments[phoneme] = value;
                }
            });
            
            // Find existing test for this student and date (assessor may change)
            var existingTestIndex = -1;
            for (var i = 0; i < window.trijazenTestovi.length; i++) {
                if (window.trijazenTestovi[i].studentId === studentId && 
                    window.trijazenTestovi[i].date === date) {
                    existingTestIndex = i;
                    break;
                }
            }
            
            var testData = {
                id: existingTestIndex >= 0 ? window.trijazenTestovi[existingTestIndex].id : Date.now(),
                studentId: studentId,
                studentName: student.name,
                grade: student.grade || '',
                date: date,
                assessor: assessor,
                timestamp: new Date().toISOString(),
                assessments: assessments
            };
            
            if (existingTestIndex >= 0) {
                // Update existing test
                window.trijazenTestovi[existingTestIndex] = testData;
            } else {
                // Add new test
                window.trijazenTestovi.push(testData);
            }
            
            saveData();
            renderStudentListSimple(); // Update badge
        }
        
        
        // Reset all toggle buttons to neutral state
        function resetTrijazenToggles() {
            var toggles = document.querySelectorAll('.trijazen-toggle');
            toggles.forEach(function(toggle) {
                toggle.className = 'trijazen-toggle';
                toggle.textContent = '';
                toggle.setAttribute('data-value', '');
            });
        }

        function exportTrijazenToJpeg() {
            var element = document.getElementById('trijazen');
            var originalBtn = element.querySelector('button[onclick="exportTrijazenToJpeg()"]');
            
            // Hide button for capture
            if(originalBtn) originalBtn.style.display = 'none';

            // Create a clone to modify for export
            var clone = element.cloneNode(true);
            clone.style.width = '1000px'; // Fixed width for A4-like ratio
            clone.style.padding = '20px';
            clone.style.background = '#1a202c'; // Ensure background is dark
            clone.style.color = 'white';
            
            // Remove the export button from clone
            var btn = clone.querySelector('button[onclick="exportTrijazenToJpeg()"]');
            if(btn) btn.remove();

            // Modify clone for "One Page" and "Default Values"
            var toggles = clone.querySelectorAll('.trijazen-toggle');
            toggles.forEach(function(toggle) {
                var val = toggle.getAttribute('data-value');
                if (!val) {
                    toggle.textContent = '+-';
                    toggle.className = 'trijazen-toggle plusminus'; // Apply yellow style
                    // Optional: Add a visual indicator that this is a default value? 
                    // User just said "default valie +-", so making it look like a real +- is probably what they want.
                }
            });

            // Compact styles for the clone
            var style = document.createElement('style');
            style.innerHTML = `
                .trijazen-table { font-size: 12px; margin-bottom: 10px; }
                .trijazen-table th, .trijazen-table td { padding: 4px 8px; }
                .section-header { font-size: 14px; margin-top: 10px; padding: 5px; }
                .trijazen-info { margin-bottom: 10px; padding: 10px; }
                .info-group { margin-bottom: 5px; }
                h2 { font-size: 18px; margin-bottom: 10px; }
            `;
            clone.appendChild(style);

            // Append clone to body temporarily to render
            clone.style.position = 'absolute';
            clone.style.top = '-9999px';
            clone.style.left = '-9999px';
            document.body.appendChild(clone);

            html2canvas(clone, {
                backgroundColor: '#1a202c',
                scale: 2 // High resolution
            }).then(canvas => {
                // Remove clone
                document.body.removeChild(clone);
                if(originalBtn) originalBtn.style.display = 'inline-block';

                // Download
                var link = document.createElement('a');
                var studentName = document.getElementById('trijazenStudentSelect').options[document.getElementById('trijazenStudentSelect').selectedIndex].text;
                var date = document.getElementById('trijazenDate').value;
                link.download = 'Trijazen_Test_' + studentName + '_' + date + '.jpg';
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
            }).catch(err => {
                console.error(err);
                alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –µ–∫—Å–ø–æ—Ä—Ç: ' + err.message);
                document.body.removeChild(clone);
                if(originalBtn) originalBtn.style.display = 'inline-block';
            });
        }
        
        // Dark Mode Logic
        const toggleSwitch = document.querySelector('.theme-switch input[type="checkbox"]');

        function isDarkThemeValue(value) {
            var normalized = (value || '').toString().toLowerCase();
            return normalized === 'dark-mode' || normalized === 'dark' || normalized === '1' || normalized === 'true';
        }

        function applyTheme(isDark) {
            document.body.classList.toggle('dark-mode', !!isDark);
            if (toggleSwitch) toggleSwitch.checked = !!isDark;
            try {
                localStorage.setItem('theme', isDark ? 'dark-mode' : 'light-mode');
            } catch (e) {}
        }

        (function initTheme() {
            var storedTheme = '';
            try {
                storedTheme = localStorage.getItem('theme') || '';
            } catch (e) {}
            document.body.classList.remove('light-mode');
            document.body.classList.toggle('dark-mode', isDarkThemeValue(storedTheme));
            if (toggleSwitch) toggleSwitch.checked = document.body.classList.contains('dark-mode');
        })();

        function switchTheme(e) {
            var isDark = !!(e && e.target && e.target.checked);
            applyTheme(isDark);
        }

        if (toggleSwitch) {
            toggleSwitch.addEventListener('change', switchTheme, false);
        }



        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // GENERATOR TAB - JavaScript (v2 - all bugs fixed)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        var genConfig = {
            docTypes: ['dosie'],
            studentMode: 'all',
            selectedStudent: null,
            outputMode: 'separate',
            lastCommand: '',
            initialized: false
        };

        function genInitTab() {
            // Set institution value via JS to avoid quote escaping issues in HTML
            if (!genConfig.initialized) {
                var instEl = document.getElementById('genInstitution');
                if (instEl && !instEl.value) {
                    instEl.value = '–ó–∞–≤–æ–¥ –∑–∞ —Ä–µ—Ö–∞–±–∏–ª–∏—Ç–∞—Ü–∏—ò–∞ –Ω–∞ –¥–µ—Ü–∞ —Å–æ –æ—à—Ç–µ—Ç–µ–Ω —Å–ª—É—Ö, –≥–æ–≤–æ—Ä, –≥–ª–∞—Å –∏ –¥—Ä—É–≥–∏ –ø—Ä–æ–±–ª–µ–º–∏ –≤–æ —Ä–∞–∑–≤–æ—ò–æ—Ç \u201E–ö–æ—á–æ –†–∞—Ü–∏–Ω\u201C \u2013 –ë–∏—Ç–æ–ª–∞';
                }
                genConfig.initialized = true;
            }
            genPopulateStudentChips();
            genUpdatePreview();
        }

        // FIX: <div> onclick toggles checkbox; checkbox onclick stops propagation
        // so there's no double-toggle anymore
        function genToggleDocType(el) {
            var cb = el.querySelector('input[type="checkbox"]');
            // Toggle the checkbox (since el is a <div>, not a <label>, browser won't auto-toggle)
            cb.checked = !cb.checked;
            el.classList.toggle('selected', cb.checked);
            genRebuildDocTypes();
            genUpdatePreview();
        }

        // Also handle direct checkbox clicks (stopPropagation prevents div handler)
        document.addEventListener('DOMContentLoaded', function() {
            // Attach checkbox direct-click handlers
            setTimeout(function() {
                var grid = document.getElementById('genDocTypeGrid');
                if (!grid) return;
                grid.querySelectorAll('input[type="checkbox"]').forEach(function(cb) {
                    cb.addEventListener('change', function(e) {
                        var parent = cb.closest('.gen-doc-option');
                        if (parent) {
                            parent.classList.toggle('selected', cb.checked);
                        }
                        genRebuildDocTypes();
                        genUpdatePreview();
                    });
                });
            }, 100);
        });

        function genRebuildDocTypes() {
            genConfig.docTypes = [];
            var checkboxes = document.querySelectorAll('#genDocTypeGrid input[type="checkbox"]:checked');
            for (var i = 0; i < checkboxes.length; i++) {
                genConfig.docTypes.push(checkboxes[i].getAttribute('data-doctype'));
            }
        }

        function genSetStudentMode(mode, el) {
            genConfig.studentMode = mode;
            var pills = el.parentElement.querySelectorAll('.gen-radio-pill');
            for (var i = 0; i < pills.length; i++) { pills[i].classList.remove('active'); }
            el.classList.add('active');
            var selectDiv = document.getElementById('genStudentSelect');
            if (mode === 'single') {
                selectDiv.classList.add('visible');
                genPopulateStudentChips();
            } else {
                selectDiv.classList.remove('visible');
                genConfig.selectedStudent = null;
            }
            genUpdatePreview();
        }

        function genSetOutputMode(mode, el) {
            genConfig.outputMode = mode;
            var pills = el.parentElement.querySelectorAll('.gen-radio-pill');
            for (var i = 0; i < pills.length; i++) { pills[i].classList.remove('active'); }
            el.classList.add('active');
        }

        function genPopulateStudentChips() {
            var container = document.getElementById('genStudentChips');
            if (!container) return;
            container.innerHTML = '';
            var allStudents = (typeof students !== 'undefined' && Array.isArray(students)) ? students : [];
            if (allStudents.length === 0) {
                container.innerHTML = '<div style="color:#718096;font-size:13px;padding:8px 0;">' +
                    '‚ö†Ô∏è –ù–µ–º–∞ —É—á–µ–Ω–∏—Ü–∏. –ü—Ä–≤–æ –¥–æ–¥–∞–¥–µ—Ç–µ —É—á–µ–Ω–∏—Ü–∏ –≤–æ —Ç–∞–±–æ—Ç <strong>–£—á–µ–Ω–∏—Ü–∏</strong>, ' +
                    '–∏–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–∞—ò—Ç–µ JSON –≤–æ —Ç–∞–±–æ—Ç <strong>–ü–æ–¥–∞—Ç–æ—Ü–∏</strong>.</div>';
                return;
            }
            for (var i = 0; i < allStudents.length; i++) {
                (function(st) {
                    var chip = document.createElement('div');
                    chip.className = 'gen-student-chip';
                    chip.textContent = st.name || '–ë–µ–∑ –∏–º–µ';
                    chip.addEventListener('click', function() {
                        var chips = container.querySelectorAll('.gen-student-chip');
                        for (var j = 0; j < chips.length; j++) { chips[j].classList.remove('selected'); }
                        chip.classList.add('selected');
                        genConfig.selectedStudent = st.name;
                        genUpdatePreview();
                    });
                    if (genConfig.selectedStudent === st.name) chip.classList.add('selected');
                    container.appendChild(chip);
                })(allStudents[i]);
            }
        }

        function genUpdatePreview() {
            var types = genConfig.docTypes;
            var allStudents = (typeof students !== 'undefined' && Array.isArray(students)) ? students : [];
            var numStudents = allStudents.length;
            var isSingle = genConfig.studentMode === 'single' && genConfig.selectedStudent;
            var count = 0;
            var items = [];

            for (var t = 0; t < types.length; t++) {
                var dtype = types[t];
                if (dtype === 'dosie') {
                    if (isSingle) {
                        items.push({ icon: 'üìÅ', text: '–î–û–°–ò–ï_' + genConfig.selectedStudent.replace(/\s+/g, '_') + '.docx' });
                        count += 1;
                    } else {
                        for (var s = 0; s < allStudents.length; s++) {
                            var nm = (allStudents[s].name || '–£—á–µ–Ω–∏–∫').replace(/\s+/g, '_');
                            items.push({ icon: 'üìÅ', text: '–î–û–°–ò–ï_' + nm + '.docx' });
                        }
                        count += numStudents;
                    }
                } else if (dtype === 'roditelski') {
                    items.push({ icon: 'üë®‚Äçüë©‚Äçüëß', text: '–†–û–î–ò–¢–ï–õ–°–ö–ò_–°–†–ï–î–ë–ò.docx' });
                    count += 1;
                } else if (dtype === 'sostanoci') {
                    items.push({ icon: 'üë•', text: '–†–û–î–ò–¢–ï–õ–°–ö–ò_–°–û–°–¢–ê–ù–û–¶–ò.docx' });
                    count += 1;
                } else if (dtype === 'izvestaj') {
                    items.push({ icon: 'üìä', text: '–ò–ó–í–ï–®–¢–ê–à_–°–£–ú–ò–†–ê–ù–û.docx' });
                    count += 1;
                } else if (dtype === 'periodicen') {
                    items.push({ icon: 'üìÖ', text: '–ü–ï–†–ò–û–î–ò–ß–ï–ù_–ò–ó–í–ï–®–¢–ê–à.docx' });
                    count += 1;
                }
            }

            var countEl = document.getElementById('genPreviewCount');
            if (types.length === 0) {
                countEl.textContent = '‚ö†Ô∏è –ò–∑–±–µ—Ä–µ—Ç–µ –±–∞—Ä–µ–º –µ–¥–µ–Ω —Ç–∏–ø –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç';
                countEl.style.color = '#e53e3e';
            } else {
                countEl.style.color = '';
                countEl.textContent = 'üì¶ –í–∫—É–ø–Ω–æ: ~' + count + ' —Ñ–∞—ò–ª' + (count !== 1 ? '–æ–≤–∏' : '') +
                    ' (' + types.length + ' —Ç–∏–ø' + (types.length !== 1 ? '–∞' : '') +
                    ', ' + (isSingle ? '1 —É—á–µ–Ω–∏–∫' : numStudents + ' —É—á–µ–Ω–∏—Ü–∏') + ')';
            }

            var listEl = document.getElementById('genPreviewList');
            if (items.length === 0) {
                listEl.innerHTML = '<div style="color:#a0aec0;font-size:13px;padding:10px 0;">–ò–∑–±–µ—Ä–µ—Ç–µ —Ç–∏–ø –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç –∑–∞ –ø—Ä–µ–≥–ª–µ–¥.</div>';
            } else {
                var maxShow = 15;
                var html = '';
                for (var i = 0; i < Math.min(items.length, maxShow); i++) {
                    html += '<div class="gen-preview-item"><span class="file-icon">' + items[i].icon + '</span> ' + items[i].text + '</div>';
                }
                if (items.length > maxShow) {
                    html += '<div class="gen-preview-item" style="color:#667eea;font-weight:600;">... –∏ —É—à—Ç–µ ' + (items.length - maxShow) + ' —Ñ–∞—ò–ª–æ–≤–∏</div>';
                }
                listEl.innerHTML = html;
            }
        }

        function genGetVal(id) {
            var el = document.getElementById(id);
            return el ? el.value : '';
        }

        function genBuildCommand() {
            var types = genConfig.docTypes;
            if (types.length === 0) {
                genShowToast('‚ö†Ô∏è –ò–∑–±–µ—Ä–µ—Ç–µ –±–∞—Ä–µ–º –µ–¥–µ–Ω —Ç–∏–ø –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç!', '#e53e3e');
                return;
            }

            var jsonPath = genGetVal('genJsonPath') || 'e_dnevnik_unified_state_v7.json';
            var outDir = genGetVal('genOutDir') || 'OUT';
            var schoolYear = genGetVal('genSchoolYear') || '2025-2026';
            var therapistName = genGetVal('genTherapistName');
            var therapistTitle = genGetVal('genTherapistTitle');
            var institution = genGetVal('genInstitution');
            var fontName = genGetVal('genFontName');
            var fontSize = genGetVal('genFontSize');
            var periodLabel = genGetVal('genPeriodLabel');
            var dlImages = document.getElementById('genDownloadImages');
            var downloadImages = dlImages ? dlImages.checked : false;
            var outputMode = genConfig.outputMode;
            var isSingle = genConfig.studentMode === 'single' && genConfig.selectedStudent;

            // Build args array: [flag, value] pairs
            var args = [];
            args.push(['--unified', jsonPath]);
            args.push(['--out', outDir]);
            args.push(['--doc-types', types.join(',')]);
            args.push(['--school-year', schoolYear]);
            args.push(['--output-mode', outputMode]);
            args.push(['--font-name', fontName]);
            args.push(['--font-size', fontSize]);
            if (therapistName) args.push(['--therapist-name', therapistName]);
            if (therapistTitle) args.push(['--therapist-title', therapistTitle]);
            if (institution) args.push(['--institution', institution]);
            if (periodLabel) args.push(['--period-label', periodLabel]);
            if (isSingle) args.push(['--student', genConfig.selectedStudent]);
            if (downloadImages) args.push(['--download-images', null]);

            // Display: multi-line for readability
            var displayLines = [];
            displayLines.push('<span class="cmd-comment"># document_factory_v7.py ‚Äî –ì–µ–Ω–µ—Ä–∏—Ä–∞—ò DOCX –¥–æ–∫—É–º–µ–Ω—Ç–∏</span>');
            displayLines.push('<span class="cmd-comment"># –ö–æ–ø–∏—Ä–∞—ò—Ç–µ –∏ –∑–∞–ª–µ–ø–µ—Ç–µ –≤–æ CMD –∏–ª–∏ PowerShell</span>');
            displayLines.push('python document_factory_v7.py');
            for (var i = 0; i < args.length; i++) {
                var flag = args[i][0];
                var val = args[i][1];
                if (val === null) {
                    displayLines.push('  <span class="cmd-flag">' + flag + '</span>');
                } else {
                    displayLines.push('  <span class="cmd-flag">' + flag + '</span> <span class="cmd-value">"' + val + '"</span>');
                }
            }

            // Copy: SINGLE LINE ‚Äî works in CMD, PowerShell, and bash
            var singleLine = 'python document_factory_v7.py';
            for (var i = 0; i < args.length; i++) {
                var flag = args[i][0];
                var val = args[i][1];
                if (val === null) {
                    singleLine += ' ' + flag;
                } else {
                    singleLine += ' ' + flag + ' "' + val + '"';
                }
            }

            document.getElementById('genCommandBox').innerHTML = displayLines.join('\n');
            genConfig.lastCommand = singleLine;
            genShowToast('‚úÖ –ö–æ–º–∞–Ω–¥–∞—Ç–∞ –µ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–∞! –ö–æ–ø–∏—Ä–∞—ò—Ç–µ –∏ –∑–∞–ª–µ–ø–µ—Ç–µ –≤–æ CMD/PowerShell', '#48bb78');
        }

        function genBuildCompactCommand() {
            var jsonPath = genGetVal('genJsonPath') || 'e_dnevnik_unified_state_v7.json';
            var templatePath = genGetVal('genTemplatePath') || 'template.docx';
            var outDir = genGetVal('genOutDir') || 'OUT';
            var isSingle = genConfig.studentMode === 'single' && genConfig.selectedStudent;

            var args = [];
            args.push(['--unified', jsonPath]);
            args.push(['--template', templatePath]);
            args.push(['--out', outDir]);
            if (isSingle) args.push(['--student', genConfig.selectedStudent]);

            // Display: multi-line for readability
            var displayLines = [];
            displayLines.push('<span class="cmd-comment"># compact_factory.py ‚Äî –®–∞–±–ª–æ–Ω-–±–∞–∑–∏—Ä–∞–Ω –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä</span>');
            displayLines.push('<span class="cmd-comment"># –ö–æ–ø–∏—Ä–∞—ò—Ç–µ –∏ –∑–∞–ª–µ–ø–µ—Ç–µ –≤–æ CMD –∏–ª–∏ PowerShell</span>');
            displayLines.push('python compact_factory.py gen-template');
            for (var i = 0; i < args.length; i++) {
                displayLines.push('  <span class="cmd-flag">' + args[i][0] + '</span> <span class="cmd-value">"' + args[i][1] + '"</span>');
            }

            // Copy: SINGLE LINE
            var singleLine = 'python compact_factory.py gen-template';
            for (var i = 0; i < args.length; i++) {
                singleLine += ' ' + args[i][0] + ' "' + args[i][1] + '"';
            }

            document.getElementById('genCommandBox').innerHTML = displayLines.join('\n');
            genConfig.lastCommand = singleLine;
            genShowToast('‚úÖ Compact –∫–æ–º–∞–Ω–¥–∞—Ç–∞ –µ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–∞!', '#4299e1');
        }

        function genCopyCommand() {
            if (!genConfig.lastCommand) {
                genShowToast('‚ö†Ô∏è –ü—Ä–≤–æ –≥–µ–Ω–µ—Ä–∏—Ä–∞—ò—Ç–µ –∫–æ–º–∞–Ω–¥–∞!', '#e53e3e');
                return;
            }
            var text = genConfig.lastCommand;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(function() {
                    genShowToast('üìã –ö–æ–ø–∏—Ä–∞–Ω–æ –≤–æ clipboard!', '#48bb78');
                }).catch(function() {
                    genCopyFallback(text);
                });
            } else {
                genCopyFallback(text);
            }
        }

        function genCopyFallback(text) {
            var ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            document.body.appendChild(ta);
            ta.select();
            try {
                document.execCommand('copy');
                genShowToast('üìã –ö–æ–ø–∏—Ä–∞–Ω–æ –≤–æ clipboard!', '#48bb78');
            } catch(e) {
                genShowToast('‚ùå –ù–µ –º–æ–∂–µ –¥–∞ —Å–µ –∫–æ–ø–∏—Ä–∞', '#e53e3e');
            }
            document.body.removeChild(ta);
        }

        function genSaveConfig(generatorType) {
            var types = genConfig.docTypes;
            if (types.length === 0 && generatorType === 'document_factory_v7') {
                genShowToast('‚ö†Ô∏è –ò–∑–±–µ—Ä–µ—Ç–µ –±–∞—Ä–µ–º –µ–¥–µ–Ω —Ç–∏–ø –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç!', '#e53e3e');
                return;
            }

            var isSingle = genConfig.studentMode === 'single' && genConfig.selectedStudent;

            var config = {
                _comment: 'Generated by S-Dnevnik Generator tab. Put this file in the same folder as LAUNCHER.bat and double-click LAUNCHER.bat to run.',
                generator: generatorType,
                jsonPath: genGetVal('genJsonPath') || 'e_dnevnik_unified_state_v7.json',
                outDir: genGetVal('genOutDir') || 'OUT',
                docTypes: types,
                schoolYear: genGetVal('genSchoolYear') || '2025-2026',
                outputMode: genConfig.outputMode,
                fontName: genGetVal('genFontName') || 'Times New Roman',
                fontSize: parseInt(genGetVal('genFontSize')) || 12,
                therapistName: genGetVal('genTherapistName') || '',
                therapistTitle: genGetVal('genTherapistTitle') || '',
                institution: genGetVal('genInstitution') || '',
                periodLabel: genGetVal('genPeriodLabel') || '',
                templatePath: genGetVal('genTemplatePath') || 'template.docx',
                selectedStudent: isSingle ? genConfig.selectedStudent : null,
                downloadImages: document.getElementById('genDownloadImages') ? document.getElementById('genDownloadImages').checked : false
            };

            var blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'gen_config.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            genShowToast('üíæ gen_config.json –∑–∞—á—É–≤–∞–Ω! –°—Ç–∞–≤–µ—Ç–µ –≥–æ –≤–æ —Ñ–æ–ª–¥–µ—Ä–æ—Ç –∏ –∫–ª–∏–∫–Ω–µ—Ç–µ LAUNCHER.bat', '#dd6b20');
        }

        function genDownloadJson() {
            if (typeof buildDiaryPayload !== 'function') {
                genShowToast('‚ùå –§—É–Ω–∫—Ü–∏—ò–∞—Ç–∞ buildDiaryPayload –Ω–µ –µ –¥–æ—Å—Ç–∞–ø–Ω–∞', '#e53e3e');
                return;
            }
            var data = buildDiaryPayload();
            var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'e_dnevnik_unified_state_v7.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            genShowToast('üì• JSON –µ–∫—Å–ø–æ—Ä—Ç–∏—Ä–∞–Ω! –°—Ç–∞–≤–µ—Ç–µ –≥–æ –≤–æ —Ñ–æ–ª–¥–µ—Ä–æ—Ç —Å–æ Python —Å–∫—Ä–∏–ø—Ç–∏—Ç–µ.', '#4299e1');
        }

        function genShowToast(msg, color) {
            var existing = document.getElementById('genToast');
            if (existing) existing.remove();
            var toast = document.createElement('div');
            toast.id = 'genToast';
            toast.className = 'gen-toast';
            toast.style.background = color || '#48bb78';
            toast.textContent = msg;
            document.body.appendChild(toast);
            requestAnimationFrame(function() {
                requestAnimationFrame(function() {
                    toast.classList.add('show');
                });
            });
            setTimeout(function() {
                toast.classList.remove('show');
                setTimeout(function() { if (toast.parentNode) toast.remove(); }, 300);
            }, 3000);
        }


        // Warn user about unsaved changes
        window.addEventListener('beforeunload', function (e) {
            if (isDataDirty) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
    
    <div class="credit-watermark">Created by Blagoj Nasev</div>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<script src="home-button.js"></script>
</body>
</html>


