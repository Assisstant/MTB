<!DOCTYPE html>
<html lang="mk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>üìÇ –°—Ç—É–¥–µ–Ω—Ç—Å–∫–æ –î–æ—Å–∏–µ (GitHub-Friendly)</title>

  <!-- Optional: for JPEG export (kept as CDN; still a single HTML file) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root{
      --primary:#667eea;
      --primary2:#764ba2;
      --bg: linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --card: rgba(255,255,255,.95);
      --text:#2d3748;
      --muted:#718096;
      --border:#e2e8f0;
      --input:#fff;
      --shadow: 0 10px 25px rgba(0,0,0,.2);
    }
    body.dark-mode{
      --bg: linear-gradient(135deg,#2d3748 0%,#1a202c 100%);
      --card:#1a202c;
      --text:#e2e8f0;
      --muted:#a0aec0;
      --border:#4a5568;
      --input:#2d3748;
      --shadow: 0 10px 25px rgba(0,0,0,.45);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg);
      min-height:100vh;
      color: var(--text);
      padding: 20px;
      transition: background .25s,color .25s;
    }
    .container{
      max-width: 1200px;
      margin: 0 auto;
      background: var(--card);
      border-radius: 15px;
      box-shadow: var(--shadow);
      overflow: hidden;
      min-height: 82vh;
      display:flex;
      flex-direction:column;
    }
    .header{
      background: linear-gradient(135deg,var(--primary) 0%,var(--primary2) 100%);
      color:#fff;
      padding: 16px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
    }
    .header h1{font-size: 1.15rem; display:flex; align-items:center; gap:10px;}
    .db-status{
      display:flex;
      align-items:center;
      gap: 10px;
      font-size: 13px;
      opacity: .95;
    }
    .pill{
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.22);
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .controls{display:flex; gap: 10px; flex-wrap:wrap; align-items:center;}
    .btn{
      padding: 10px 14px;
      border:none;
      border-radius: 8px;
      font-weight: 700;
      cursor:pointer;
      font-size: 13px;
      transition: transform .15s, box-shadow .15s, opacity .15s;
    }
    .btn:hover{transform: translateY(-1px); box-shadow: 0 4px 10px rgba(0,0,0,.18);}
    .btn:active{transform: translateY(0px); opacity:.9}
    .btn-primary{background: var(--primary); color:#fff;}
    .btn-secondary{background:#cbd5e0; color:#2d3748;}
    body.dark-mode .btn-secondary{background:#4a5568;color:#e2e8f0;}
    .btn-success{background:#48bb78;color:#fff;}
    .btn-danger{background:#e53e3e;color:#fff;}

    .main{display:flex;flex:1;overflow:hidden;}
    .sidebar{
      width: 360px;
      border-right: 1px solid var(--border);
      background: rgba(0,0,0,.02);
      display:flex;
      flex-direction:column;
      min-height: 0;
    }
    body.dark-mode .sidebar{background: rgba(255,255,255,.03);}
    .search-box{
      padding: 14px;
      border-bottom: 1px solid var(--border);
    }
    .search-box input{
      width:100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--input);
      color: var(--text);
      outline:none;
    }
    .student-list{flex:1;overflow:auto;}
    .student-item{
      padding: 14px;
      border-bottom: 1px solid var(--border);
      cursor:pointer;
      transition: background .15s;
    }
    .student-item:hover{background: rgba(0,0,0,.05);}
    body.dark-mode .student-item:hover{background: rgba(255,255,255,.05);}
    .student-item.active{
      background: rgba(102,126,234,.12);
      border-left: 4px solid var(--primary);
    }
    .student-item h3{font-size: 15px;margin-bottom: 4px;}
    .student-item p{font-size: 12.5px; color: var(--muted);}

    .detail{flex:1; padding: 24px; overflow:auto; min-height:0;}
    .empty{
      height:100%;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      opacity:.7;
      text-align:center;
      gap:6px;
      color: var(--muted);
    }

    .section-title{
      font-size: 1.05rem;
      margin: 18px 0 10px 0;
      color: var(--primary);
      border-bottom: 2px solid var(--border);
      padding-bottom: 8px;
    }

    .form-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px 18px;
    }
    .form-group{display:flex;flex-direction:column;gap:8px;}
    .form-group.full{grid-column: span 2;}
    label{font-weight: 700; font-size: 13px; opacity:.95;}
    input, textarea{
      width:100%;
      padding: 12px;
      border: 2px solid var(--border);
      border-radius: 10px;
      background: var(--input);
      color: var(--text);
      font-size: 14px;
      outline:none;
      transition: border-color .2s;
    }
    input:focus, textarea:focus{border-color: var(--primary);}
    textarea{min-height: 110px; resize: vertical;}

    .preview{
      display:flex;
      flex-direction:column;
      gap: 14px;
    }
    .preview h2{margin-top: 2px; text-align:center; color: var(--primary); font-size: 1.45rem;}
    .preview h3{text-align:center; font-weight: 500; color: var(--muted); margin-top: -8px;}
    .preview-grid{display:flex; flex-direction:column; gap: 10px;}
    .row{
      display:grid;
      grid-template-columns: 240px 1fr;
      gap: 16px;
      padding: 10px 0;
      border-bottom: 1px solid rgba(0,0,0,.07);
    }
    body.dark-mode .row{border-bottom: 1px solid rgba(255,255,255,.09);}
    .k{font-weight: 800; color: var(--primary); font-size: 13px;}
    .v{font-size: 14.5px; line-height: 1.55;}
    .muted{color: var(--muted);}

    .attachments{
      margin-top: 18px;
      border-top: 1px solid var(--border);
      padding-top: 14px;
    }
    .attachments h4{color:#4a5568;font-size: 15.5px;margin-bottom:10px;}
    body.dark-mode .attachments h4{color:#cbd5e0;}
    .att-links a{
      display:block;
      word-break: break-all;
      margin-bottom: 8px;
      color: var(--primary);
      text-decoration: none;
      font-size: 13px;
    }
    .att-links a:hover{text-decoration: underline;}
    .thumb-grid{
      display:grid;
      grid-template-columns: repeat(auto-fill,minmax(150px,1fr));
      gap: 10px;
      margin-top: 10px;
    }
    .thumb{
      width:100%;
      height: 150px;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(0,0,0,.02);
      cursor:pointer;
      transition: transform .15s;
    }
    body.dark-mode .thumb{border: 1px solid rgba(255,255,255,.16); background: rgba(255,255,255,.03);}
    .thumb:hover{transform: scale(1.03);}

    .actions{
      margin-top: 18px;
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .theme-switch{
      position: fixed;
      bottom: 18px;
      right: 18px;
      z-index: 50;
      display:flex;
      align-items:center;
      gap: 10px;
      background: var(--card);
      padding: 10px 12px;
      border-radius: 999px;
      box-shadow: 0 4px 12px rgba(0,0,0,.2);
      border: 1px solid var(--border);
    }
    .toggle{
      width: 52px;
      height: 28px;
      border-radius: 999px;
      background: #cbd5e0;
      position:relative;
      cursor:pointer;
      transition: background .2s;
    }
    .toggle:after{
      content:"";
      position:absolute;
      top:3px; left:3px;
      width: 22px; height: 22px;
      border-radius: 50%;
      background:#fff;
      transition: transform .2s;
      box-shadow: 0 2px 6px rgba(0,0,0,.18);
    }
    body.dark-mode .toggle{background: var(--primary);}
    body.dark-mode .toggle:after{transform: translateX(24px);}

    .help{
      font-size: 12.5px;
      color: var(--muted);
      line-height: 1.5;
      margin-top: 10px;
    }
    code.inline{
      background: rgba(0,0,0,.06);
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 12px;
    }
    body.dark-mode code.inline{background: rgba(255,255,255,.08);}

    @media (max-width: 860px){
      body{padding:0}
      .container{border-radius:0; min-height:100vh;}
      .main{flex-direction:column;}
      .sidebar{width:100%; height: 40vh;}
      .detail{height: 60vh;}
      .form-grid{grid-template-columns: 1fr;}
      .form-group.full{grid-column: span 1;}
      .row{grid-template-columns: 1fr; gap:6px;}
    }

    @media print{
      body, body.dark-mode{background:#fff !important; color:#000 !important; padding: 1.8cm !important;}
      .header,.sidebar,.theme-switch,.actions .btn,#editView{display:none !important;}
      .container{box-shadow:none !important;}
      .detail{padding:0 !important;}
      a{color:#000 !important; text-decoration: underline !important;}
      .thumb-grid{display:none !important;} /* keep printing simple and robust */
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
        <h1>üìÇ –°—Ç—É–¥–µ–Ω—Ç—Å–∫–æ –î–æ—Å–∏–µ <span style="font-size:12px;font-weight:700;opacity:.9;">(GitHub-Friendly)</span></h1>
        <div class="db-status">
          <div class="pill">
            <span id="dbStatusIcon">üî¥</span>
            <span id="dbStatusText">Disconnected</span>
          </div>
          <div class="pill" id="dbMetaPill" style="display:none;">
            <span id="dbMetaText"></span>
          </div>
        </div>
      </div>
      <div class="controls">
        <button class="btn btn-secondary" id="btnBackup">‚¨á Backup</button>
        <button class="btn btn-secondary" id="btnImport">‚¨Ü Import</button>
        <input type="file" id="importFile" accept="application/json" hidden />
        <button class="btn btn-success" id="btnNew">+ –ù–æ–≤ –£—á–µ–Ω–∏–∫</button>
      </div>
    </div>

    <div class="main">
      <div class="sidebar">
        <div class="search-box">
          <input id="searchInput" type="text" placeholder="üîç –ü—Ä–µ–±–∞—Ä–∞—ò —É—á–µ–Ω–∏–∫..." />
        </div>
        <div class="student-list" id="studentList"></div>
      </div>

      <div class="detail">
        <div id="emptyState" class="empty">
          <h2>–ò–∑–±–µ—Ä–µ—Ç–µ —É—á–µ–Ω–∏–∫ –æ–¥ –ª–∏—Å—Ç–∞—Ç–∞</h2>
          <p>–∏–ª–∏ –∫—Ä–µ–∏—Ä–∞—ò—Ç–µ –Ω–æ–≤ –∑–∞–ø–∏—Å</p>
        </div>

        <!-- PREVIEW -->
        <div id="previewView" style="display:none;">
          <div class="preview" id="previewRoot">
            <h2>–£—á–µ–Ω–∏—á–∫–æ –¥–æ—Å–∏–µ</h2>
            <h3 id="previewTitle">–£—á–µ–Ω–∏–∫</h3>

            <div class="preview-grid">
              <div class="row"><div class="k">–û–¥–¥–µ–ª–µ–Ω–∏–µ</div><div class="v" data-field="grade"></div></div>
              <div class="row"><div class="k">–ò–º–µ</div><div class="v" data-field="firstName"></div></div>
              <div class="row"><div class="k">–ü—Ä–µ–∑–∏–º–µ</div><div class="v" data-field="lastName"></div></div>
              <div class="row"><div class="k">–î–∞—Ç—É–º –Ω–∞ —Ä–∞—ì–∞—ö–µ</div><div class="v" data-field="birthDate"></div></div>
              <div class="row"><div class="k">–ö–æ–Ω—Ç–∞–∫—Ç –¥–µ—Ç–∞–ª–∏</div><div class="v" data-field="contact"></div></div>

              <div class="row"><div class="k">–ò–º–µ –∏ –ø—Ä–µ–∑–∏–º–µ –Ω–∞ —Ç–∞—Ç–∫–æ—Ç–æ</div><div class="v" data-field="fatherName"></div></div>
              <div class="row"><div class="k">–ò–º–µ –∏ –ø—Ä–µ–∑–∏–º–µ –Ω–∞ –º–∞—ò–∫–∞—Ç–∞</div><div class="v" data-field="motherName"></div></div>
              <div class="row"><div class="k">–ê–¥—Ä–µ—Å–∞</div><div class="v" data-field="address"></div></div>
              <div class="row"><div class="k">–ú–µ—Å—Ç–æ –Ω–∞ –∂–∏–≤–µ–µ—ö–µ</div><div class="v" data-field="residence"></div></div>

              <div class="row"><div class="k">–ù–∞–æ–¥</div><div class="v" data-field="findings"></div></div>
              <div class="row"><div class="k">–ú–∏—Å–ª–µ—ö–µ</div><div class="v" data-field="opinion"></div></div>
            </div>

            <div class="attachments" id="attachmentContainer" style="display:none;">
              <h4>–ü—Ä–∏–ª–æ–∑–∏ (–ª–∏–Ω–∫–æ–≤–∏ + thumbnails –∫–æ–≥–∞ –µ –º–æ–∂–Ω–æ)</h4>
              <div class="att-links" id="attachmentLinks"></div>
              <div class="thumb-grid" id="thumbGrid"></div>

              <div class="help">
                Thumbnail —Å–µ –ø—Ä–∏–∫–∞–∂—É–≤–∞ —Å–∞–º–æ –∞–∫–æ –ª–∏–Ω–∫–æ—Ç –µ ‚Äû–¥–∏—Ä–µ–∫—Ç–µ–Ω‚Äú (–Ω–∞ –ø—Ä–∏–º–µ—Ä –∑–∞–≤—Ä—à—É–≤–∞ —Å–æ <code class="inline">.jpg</code>, <code class="inline">.png</code>, –∏—Ç–Ω.).
                –ó–∞ Dropbox: –∞–∫–æ –ª–∏–Ω–∫–æ—Ç –∏–º–∞ <code class="inline">dl=0</code>, —Å–º–µ–Ω–∏ –≤–æ <code class="inline">raw=1</code> (–∞–ø–ª–∏–∫–∞—Ü–∏—ò–∞—Ç–∞ —ú–µ –ø—Ä–æ–±–∞ –∞–≤—Ç–æ–º–∞—Ç—Å–∫–∏).
              </div>
            </div>

            <div class="actions">
              <button class="btn btn-primary" id="btnEdit">‚úé –ü—Ä–æ–º–µ–Ω–∏</button>
              <button class="btn btn-secondary" id="btnJpeg">üì∏ –ó–∞—á—É–≤–∞—ò –∫–∞–∫–æ –°–ª–∏–∫–∞</button>
              <button class="btn btn-secondary" onclick="window.print()">üñ®Ô∏è Print</button>
              <button class="btn btn-secondary" id="btnClose">–ù–∞–∑–∞–¥ –¥–æ –ª–∏—Å—Ç–∞—Ç–∞</button>
            </div>
          </div>
        </div>

        <!-- EDIT -->
        <form id="editView" style="display:none;" onsubmit="event.preventDefault();">
          <div class="form-grid">
            <div class="section-title" style="grid-column: span 2;">–û—Å–Ω–æ–≤–Ω–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</div>

            <div class="form-group">
              <label>–û–¥–¥–µ–ª–µ–Ω–∏–µ</label>
              <input name="grade" type="text" />
            </div>

            <div class="form-group">
              <label>–ò–º–µ</label>
              <input name="firstName" type="text" required />
            </div>

            <div class="form-group">
              <label>–ü—Ä–µ–∑–∏–º–µ</label>
              <input name="lastName" type="text" required />
            </div>

            <div class="form-group">
              <label>–î–∞—Ç—É–º –Ω–∞ —Ä–∞—ì–∞—ö–µ</label>
              <input name="birthDate" type="date" />
            </div>

            <div class="form-group">
              <label>–ö–æ–Ω—Ç–∞–∫—Ç –¥–µ—Ç–∞–ª–∏</label>
              <input name="contact" type="text" />
            </div>

            <div class="section-title" style="grid-column: span 2;">–°–µ–º–µ—ò–Ω–∏ –ø–æ–¥–∞—Ç–æ—Ü–∏</div>

            <div class="form-group">
              <label>–ò–º–µ –∏ –ø—Ä–µ–∑–∏–º–µ –Ω–∞ —Ç–∞—Ç–∫–æ—Ç–æ</label>
              <input name="fatherName" type="text" />
            </div>

            <div class="form-group">
              <label>–ò–º–µ –∏ –ø—Ä–µ–∑–∏–º–µ –Ω–∞ –º–∞—ò–∫–∞—Ç–∞</label>
              <input name="motherName" type="text" />
            </div>

            <div class="form-group full">
              <label>–ê–¥—Ä–µ—Å–∞</label>
              <input name="address" type="text" />
            </div>

            <div class="form-group full">
              <label>–ú–µ—Å—Ç–æ –Ω–∞ –∂–∏–≤–µ–µ—ö–µ</label>
              <input name="residence" type="text" />
            </div>

            <div class="section-title" style="grid-column: span 2;">–°—Ç—Ä—É—á–Ω–∞ –ø—Ä–æ—Ü–µ–Ω–∫–∞</div>

            <div class="form-group full">
              <label>–ù–∞–æ–¥</label>
              <textarea name="findings"></textarea>
            </div>

            <div class="form-group full">
              <label>–ú–∏—Å–ª–µ—ö–µ</label>
              <textarea name="opinion"></textarea>
            </div>

            <div class="section-title" style="grid-column: span 2;">–ü—Ä–∏–ª–æ–∑–∏ (cloud –ª–∏–Ω–∫–æ–≤–∏)</div>

            <div class="form-group full">
              <label>–õ–∏–Ω–∫–æ–≤–∏ –¥–æ –ø—Ä–∏–ª–æ–∑–∏ (–ø–æ –µ–¥–µ–Ω –ª–∏–Ω–∫ –≤–æ —Ä–µ–¥)</label>
              <textarea id="attachmentLinksInput" placeholder="https://..."></textarea>
              <div class="help">
                –ü—Ä–µ–ø–æ—Ä–∞–∫–∞: —á—É–≤–∞—ò —Å–ª–∏–∫–∏ –≤–æ cloud –∏ –ª–µ–ø–∏ –ª–∏–Ω–∫–æ–≤–∏ —Ç—É–∫–∞. –û–≤–∞ –ø—Ä–∞–≤–∏ Backup/Import –¥–∞ —Ä–∞–±–æ—Ç–∏ —Å–∏–≥—É—Ä–Ω–æ –Ω–∞ GitHub Pages.
                Thumbnail —ú–µ —Å–µ –ø—Ä–∏–∫–∞–∂–µ —Å–∞–º–æ –∑–∞ –¥–∏—Ä–µ–∫—Ç–Ω–∏ —Å–ª–∏–∫–∏ (–Ω–∞ –ø—Ä. –ª–∏–Ω–∫ —à—Ç–æ –∑–∞–≤—Ä—à—É–≤–∞ —Å–æ <code class="inline">.jpg</code>/<code class="inline">.png</code>).
              </div>
            </div>
          </div>

          <div class="actions">
            <button class="btn btn-secondary" id="btnCancel">–û—Ç–∫–∞–∂–∏</button>
            <button class="btn btn-danger" id="btnDelete">–ò–∑–±—Ä–∏—à–∏</button>
            <button class="btn btn-primary" id="btnSave">–ó–∞—á—É–≤–∞—ò –ø—Ä–æ–º–µ–Ω–∏</button>
          </div>
        </form>

      </div>
    </div>
  </div>

  <div class="theme-switch">
    <span style="font-size:13px;font-weight:800;">Dark</span>
    <div class="toggle" id="themeToggle"></div>
  </div>

<script>
/* ===========================
   IndexedDB (single-file DB)
   =========================== */
(function(){
  const DB_NAME = "student_dossier_db";
  const DB_VERSION = 2;
  const STORES = [
    { name: "student_records", keyPath: "id" }
  ];

  function openDB(){
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, DB_VERSION);
      req.onupgradeneeded = (e) => {
        const db = req.result;
        for (const s of STORES) {
          if (!db.objectStoreNames.contains(s.name)) {
            db.createObjectStore(s.name, { keyPath: s.keyPath });
          }
        }
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  class StudentDB {
    constructor(){
      this.db = null;
      this.isConnected = false;
      this.name = DB_NAME;
      this.version = DB_VERSION;
    }

    async connect(){
      this.db = await openDB();
      this.isConnected = true;
      window.dispatchEvent(new CustomEvent("db-ready"));
    }

    getStatus(){
      return this.isConnected
        ? { status: "Connected", name: this.name, version: this.version }
        : { status: "Disconnected" };
    }

    _tx(storeName, mode="readonly"){
      const tx = this.db.transaction([storeName], mode);
      return { tx, store: tx.objectStore(storeName) };
    }

    getAllRecords(storeName){
      return new Promise((resolve, reject) => {
        const { store } = this._tx(storeName, "readonly");
        const req = store.getAll();
        req.onsuccess = () => resolve(req.result || []);
        req.onerror = () => reject(req.error);
      });
    }

    addRecord(storeName, record){
      return new Promise((resolve, reject) => {
        const { store } = this._tx(storeName, "readwrite");
        const req = store.add(record);
        req.onsuccess = () => resolve(true);
        req.onerror = () => reject(req.error);
      });
    }

    updateRecord(storeName, record){
      return new Promise((resolve, reject) => {
        const { store } = this._tx(storeName, "readwrite");
        const req = store.put(record);
        req.onsuccess = () => resolve(true);
        req.onerror = () => reject(req.error);
      });
    }

    deleteRecord(storeName, id){
      return new Promise((resolve, reject) => {
        const { store } = this._tx(storeName, "readwrite");
        const req = store.delete(id);
        req.onsuccess = () => resolve(true);
        req.onerror = () => reject(req.error);
      });
    }

    async exportBackup(){
      const stripLargeFields = (record) => {
        const r = { ...record };

        // remove legacy base64 fields if they exist
        if (typeof r.attachment === "string" && r.attachment.startsWith("data:image")) delete r.attachment;
        if (Array.isArray(r.attachments)) {
          r.attachments = r.attachments.filter(x => !(typeof x === "string" && x.startsWith("data:image")));
          if (r.attachments.length === 0) delete r.attachments;
        }
        // keep r.attachmentLinks as-is
        return r;
      };

      const data = {};
      for (const s of STORES) {
        const rows = await this.getAllRecords(s.name);
        data[s.name] = rows.map(stripLargeFields);
      }

      const backup = {
        meta: { dbName: DB_NAME, dbVersion: DB_VERSION, date: new Date().toISOString() },
        data
      };
      return JSON.stringify(backup, null, 2);
    }

    async importBackup(jsonString){
      const cleaned = String(jsonString || "").replace(/^\uFEFF/, "").trim();
      const backup = JSON.parse(cleaned);
      if (!backup || !backup.data) throw new Error("Invalid backup format");

      for (const s of STORES) {
        const rows = backup.data[s.name];
        if (!Array.isArray(rows)) continue;

        const tx = this.db.transaction([s.name], "readwrite");
        const store = tx.objectStore(s.name);

        await new Promise((resolve, reject) => {
          const req = store.clear();
          req.onsuccess = () => resolve(true);
          req.onerror = () => reject(req.error);
        });

        for (const r of rows) {
          await new Promise((resolve, reject) => {
            const req = store.put(r);
            req.onsuccess = () => resolve(true);
            req.onerror = () => reject(req.error);
          });
        }

        await new Promise((resolve, reject) => {
          tx.oncomplete = () => resolve(true);
          tx.onerror = () => reject(tx.error);
          tx.onabort = () => reject(tx.error || new Error("Import aborted"));
        });
      }
      return true;
    }
  }

  window.studentDB = new StudentDB();
  window.studentDB.connect().catch(err => {
    console.error("DB connect failed:", err);
    alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏—ò–∞–ª–∏–∑–∞—Ü–∏—ò–∞ –Ω–∞ –±–∞–∑–∞—Ç–∞: " + (err?.message || err));
  });
})();

/* ===========================
   GitHub-friendly attachments
   =========================== */
function looksLikeDirectImageUrl(url){
  return /\.(png|jpe?g|webp|gif)(\?.*)?$/i.test(url);
}

// best-effort normalizers for thumbnail-friendliness
function normalizeImageLink(url){
  if (!url) return url;
  let u = url.trim();

  // Dropbox: dl=0 -> raw=1
  if (u.includes("dropbox.com") && /[?&]dl=0/.test(u)) {
    u = u.replace(/([?&])dl=0/, "$1raw=1");
  }

  // Google Drive share -> try direct download form (thumbnail may or may not work)
  // Examples:
  // https://drive.google.com/file/d/FILE_ID/view?usp=sharing
  // -> https://drive.google.com/uc?export=download&id=FILE_ID
 const m = u.match(/drive\.google\.com\/file\/d\/([^\/\?]+)/i);
if (m && m[1]) {
  u = `https://drive.google.com/uc?export=view&id=${m[1]}`;
}


  return u;
}

/* ===========================
   App UI Logic
   =========================== */
const INITIAL_STUDENTS = [
  { id: 1759384696342, firstName: "–°–∞—Ä–¥–∏", lastName: "–ú—É–∞—Ä–µ–º–∏", grade: "(–Ω–∞–¥.)" },
  { id: 1759384710134, firstName: "–¢–µ–æ–¥–æ—Ä–∞", lastName: "–ë–æ–≥–∞—Ç–∏–Ω–æ–≤–∞", grade: "(–Ω–∞–¥.)" },
  { id: 1759384625367, firstName: "–ï–Ω–µ—Å", lastName: "–ê–ª–∏—É", grade: "(–Ω–∞–¥.)" },
  { id: 1759384723398, firstName: "–°—Ç–µ—Ñ–∞–Ω", lastName: "–ú–∞—Ä–∏–Ω–∫–æ–≤–∏—ú", grade: "(–Ω–∞–¥.)" },
  { id: 1759384447857, firstName: "–ú–∏—Ä–µ–º", lastName: "–û—Å–º–∞–Ω–æ–≤–∞", grade: "IV-–∞" },
  { id: 1759384496127, firstName: "–õ–µ–∞—Ä—Ç–∞", lastName: "–ó—É–ª–∞–º–∏", grade: "V-–∞" },
  { id: 1759384514431, firstName: "–ú–∞—Ä—Ç–∏–Ω", lastName: "–É—É—Ä–æ–≤—Å–∫–∏", grade: "V-–±" },
  { id: 1759384531343, firstName: "–ò–≤–∞–Ω", lastName: "–¶–≤–µ—Ç–∞–Ω–æ–≤—Å–∫–∏", grade: "V-–±" },
  { id: 1759384547455, firstName: "–ú–∞—Ä–∏—ò–∞", lastName: "–ß–∞–¥–∞–º–æ–≤–∞", grade: "VI-–∞" },
  { id: 1759384565063, firstName: "–ï–º–∏–Ω", lastName: "–ï—Ç–µ–º–æ–≤", grade: "VI" },
  { id: 1759384580351, firstName: "–î–∏–º–∏—Ç–∞—Ä", lastName: "–¢—Ä–∞—ò—á–µ–≤—Å–∫–∏", grade: "VII-–∞" },
  { id: 1759384595134, firstName: "–ú–∞–∫—Å–∏–ª–¥–∞", lastName: "–°–µ–ª–∏–º–æ–≤–∞", grade: "VII-–±" },
  { id: 1759384610343, firstName: "–î–∞–≤–∏–¥", lastName: "–ü–µ—Ç—Ä–æ–≤—Å–∫–∏", grade: "VII-–±" },
  { id: 1759384642270, firstName: "–ì–∞–±—Ä–∏–µ–ª–∞", lastName: "–ö–æ–Ω–µ—Å–∫–∞", grade: "VIII-–∞" },
  { id: 1759384666199, firstName: "–°–µ—ò—Ö–∞–Ω", lastName: "–ù–µ—ü–∏–ø–æ–≤", grade: "VIII-–∞" },
  { id: 1759384680910, firstName: "–ö—Ä–∏—Å—Ç–∏—ò–∞–Ω", lastName: "–¢–æ–¥–æ—Ä–æ—Å–∫–∏", grade: "VIII-–±" }
];

const el = (id) => document.getElementById(id);

const UI = {
  list: el("studentList"),
  search: el("searchInput"),
  empty: el("emptyState"),
  preview: el("previewView"),
  edit: el("editView"),
  previewTitle: el("previewTitle"),

  btnNew: el("btnNew"),
  btnBackup: el("btnBackup"),
  btnImport: el("btnImport"),
  importFile: el("importFile"),

  btnEdit: el("btnEdit"),
  btnClose: el("btnClose"),
  btnJpeg: el("btnJpeg"),

  btnSave: el("btnSave"),
  btnCancel: el("btnCancel"),
  btnDelete: el("btnDelete"),

  attContainer: el("attachmentContainer"),
  attLinks: el("attachmentLinks"),
  thumbGrid: el("thumbGrid"),
  attLinksInput: el("attachmentLinksInput"),

  dbIcon: el("dbStatusIcon"),
  dbText: el("dbStatusText"),
  dbMetaPill: el("dbMetaPill"),
  dbMetaText: el("dbMetaText"),

  themeToggle: el("themeToggle"),
};

const app = {
  students: [],
  currentId: null,

  async start(){
    this.updateDbStatus();

    await this.loadStudents();

    // init theme
    if (window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches) {
      document.body.classList.add("dark-mode");
    }

    // events
    UI.search.addEventListener("input", () => this.renderList(UI.search.value));
    UI.btnNew.addEventListener("click", () => this.createNewStudent());
    UI.btnBackup.addEventListener("click", () => this.exportData());
    UI.btnImport.addEventListener("click", () => UI.importFile.click());
    UI.importFile.addEventListener("change", (e) => this.importData(e.target.files?.[0]));

    UI.btnEdit.addEventListener("click", () => this.editStudent());
    UI.btnClose.addEventListener("click", () => this.closeStudent());
    UI.btnJpeg.addEventListener("click", () => this.exportToJpeg());

    UI.btnCancel.addEventListener("click", (e) => { e.preventDefault(); this.cancelEdit(); });
    UI.btnSave.addEventListener("click", (e) => { e.preventDefault(); this.saveCurrentStudent(); });
    UI.btnDelete.addEventListener("click", (e) => { e.preventDefault(); this.deleteStudent(); });

    UI.themeToggle.addEventListener("click", () => document.body.classList.toggle("dark-mode"));
  },

  updateDbStatus(){
    const s = window.studentDB.getStatus();
    if (s.status === "Connected") {
      UI.dbIcon.textContent = "üü¢";
      UI.dbText.textContent = "Connected";
      UI.dbMetaPill.style.display = "flex";
      UI.dbMetaText.textContent = `${s.name} v${s.version}`;
    } else {
      UI.dbIcon.textContent = "üî¥";
      UI.dbText.textContent = "Disconnected";
      UI.dbMetaPill.style.display = "none";
    }
  },

  async loadStudents(){
    this.students = await window.studentDB.getAllRecords("student_records");

    if (this.students.length === 0) {
      for (const s of INITIAL_STUDENTS) await window.studentDB.addRecord("student_records", s);
      this.students = await window.studentDB.getAllRecords("student_records");
    }
    this.renderList(UI.search.value || "");
  },

  renderList(filter=""){
    const f = filter.trim().toLowerCase();
    UI.list.innerHTML = "";

    const items = this.students
      .filter(s => (`${s.firstName||""} ${s.lastName||""}`).toLowerCase().includes(f))
      .sort((a,b) => (`${a.lastName||""} ${a.firstName||""}`).localeCompare(`${b.lastName||""} ${b.firstName||""}`, "mk"));

    items.forEach(s => {
      const d = document.createElement("div");
      d.className = "student-item" + (s.id === this.currentId ? " active" : "");
      d.innerHTML = `<h3>${escapeHtml(s.firstName||"")} ${escapeHtml(s.lastName||"")}</h3>
                     <p>${escapeHtml(s.grade || "–ù–µ–º–∞ –æ–¥–¥–µ–ª–µ–Ω–∏–µ")}</p>`;
      d.addEventListener("click", () => this.loadStudent(s.id));
      UI.list.appendChild(d);
    });

    if (!this.currentId) {
      UI.empty.style.display = "flex";
      UI.preview.style.display = "none";
      UI.edit.style.display = "none";
    }
  },

  async loadStudent(id){
    this.currentId = id;
    const student = this.students.find(s => s.id === id);
    if (!student) return;

    UI.empty.style.display = "none";
    UI.edit.style.display = "none";
    UI.preview.style.display = "block";

    document.title = `–°—Ç—É–¥–µ–Ω—Ç—Å–∫–æ –¥–æ—Å–∏–µ - ${student.firstName || ""} ${student.lastName || ""}`.trim();
    UI.previewTitle.textContent = `${student.firstName || ""} ${student.lastName || ""}`.trim() || "–£—á–µ–Ω–∏–∫";

    // fill preview fields
    UI.preview.querySelectorAll("[data-field]").forEach(node => {
      const key = node.getAttribute("data-field");
      const val = student[key];
      node.textContent = (val === undefined || val === null || val === "") ? "/" : String(val);
    });

    // attachments (links + optional thumbnails)
    this.renderAttachments(student);

    this.renderList(UI.search.value || "");
  },

  renderAttachments(student){
    UI.attLinks.innerHTML = "";
    UI.thumbGrid.innerHTML = "";

    const rawLinks = Array.isArray(student.attachmentLinks) ? student.attachmentLinks : [];
    const links = Array.from(new Set(rawLinks.map(normalizeImageLink).map(s => (s||"").trim()).filter(Boolean)));

    if (links.length === 0) {
      UI.attContainer.style.display = "none";
      return;
    }

    UI.attContainer.style.display = "block";

    links.forEach(url => {
      // clickable link always
      const a = document.createElement("a");
      a.href = url;
      a.target = "_blank";
      a.rel = "noopener";
      a.textContent = url;
      UI.attLinks.appendChild(a);

      // thumbnail only when it's clearly a direct image URL
      if (looksLikeDirectImageUrl(url)) {
        const img = document.createElement("img");
        img.className = "thumb";
        img.loading = "lazy";
        img.src = url;
        img.alt = "–ü—Ä–∏–ª–æ–≥";
        img.addEventListener("click", () => window.open(url, "_blank", "noopener"));
        UI.thumbGrid.appendChild(img);
      }
    });
  },

  editStudent(){
    const student = this.students.find(s => s.id === this.currentId);
    if (!student) return;

    UI.preview.style.display = "none";
    UI.edit.style.display = "block";

    // populate inputs
    UI.edit.querySelectorAll("input[name], textarea[name]").forEach(inp => {
      inp.value = student[inp.name] || "";
    });

    const rawLinks = Array.isArray(student.attachmentLinks) ? student.attachmentLinks : [];
    UI.attLinksInput.value = rawLinks.join("\n");
  },

  cancelEdit(){
    if (!this.currentId) return;
    this.loadStudent(this.currentId);
  },

  closeStudent(){
    this.currentId = null;
    document.title = "üìÇ –°—Ç—É–¥–µ–Ω—Ç—Å–∫–æ –î–æ—Å–∏–µ (GitHub-Friendly)";
    UI.preview.style.display = "none";
    UI.edit.style.display = "none";
    UI.empty.style.display = "flex";
    this.renderList(UI.search.value || "");
  },

  async createNewStudent(){
    const id = Date.now();
    const s = { id, firstName: "–ù–æ–≤", lastName: "–£—á–µ–Ω–∏–∫", grade: "", attachmentLinks: [] };
    await window.studentDB.addRecord("student_records", s);
    await this.loadStudents();
    this.currentId = id;
    this.renderList(UI.search.value || "");
    this.editStudent();
  },

  async saveCurrentStudent(){
    const studentIndex = this.students.findIndex(s => s.id === this.currentId);
    if (studentIndex === -1) return;

    const student = this.students[studentIndex];

    // collect form data
    const data = {};
    UI.edit.querySelectorAll("input[name], textarea[name]").forEach(inp => {
      data[inp.name] = inp.value;
    });

    // links
    const linksText = UI.attLinksInput.value || "";
    const links = linksText
      .split("\n")
      .map(s => normalizeImageLink(s))
      .map(s => (s || "").trim())
      .filter(Boolean)
      .filter(u => /^https?:\/\//i.test(u));

    const updated = { ...student, ...data, attachmentLinks: links };

    await window.studentDB.updateRecord("student_records", updated);
    await this.loadStudents();
    await this.loadStudent(this.currentId);
  },

  async deleteStudent(){
    if (!this.currentId) return;
    if (!confirm("–î–∞–ª–∏ —Å—Ç–µ —Å–∏–≥—É—Ä–Ω–∏ –¥–µ–∫–∞ —Å–∞–∫–∞—Ç–µ –¥–∞ –≥–æ –∏–∑–±—Ä–∏—à–µ—Ç–µ –æ–≤–æ—ò —É—á–µ–Ω–∏–∫?")) return;
    await window.studentDB.deleteRecord("student_records", this.currentId);
    this.closeStudent();
    await this.loadStudents();
  },

  async exportData(){
    try{
      const json = await window.studentDB.exportBackup();
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `student_db_backup_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    } catch(err){
      alert("Export failed: " + (err?.message || err?.name || String(err)));
    }
  },

  async importData(file){
    if (!file) return;
    try{
      const text = await file.text();
      await window.studentDB.importBackup(text);
      await this.loadStudents();
      alert("Backup —É—Å–ø–µ—à–Ω–æ –≤–Ω–µ—Å–µ–Ω (import) ‚úÖ");
    } catch(err){
      console.error(err);
      alert("Import failed: " + (err?.message || err?.name || String(err)));
    } finally {
      UI.importFile.value = "";
    }
  },

  async exportToJpeg(){
    if (!window.html2canvas) {
      alert("html2canvas –Ω–µ –µ –≤—á–∏—Ç–∞–Ω (–ø—Ä–æ–≤–µ—Ä–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç/ CDN).");
      return;
    }
    const root = document.getElementById("previewRoot");
    if (!root) return;

    // temporarily hide buttons for capture
    const buttons = root.querySelectorAll(".actions");
    buttons.forEach(b => b.style.display = "none");

    try{
      const canvas = await html2canvas(root, { scale: 2, backgroundColor: "#ffffff" });
      const a = document.createElement("a");
      const student = this.students.find(s => s.id === this.currentId) || {};
      a.download = `Dossier_${(student.firstName||"")}_${(student.lastName||"")}.jpg`.replace(/\s+/g,"_");
      a.href = canvas.toDataURL("image/jpeg", 0.92);
      a.click();
    } catch(err){
      alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –µ–∫—Å–ø–æ—Ä—Ç: " + (err?.message || String(err)));
    } finally {
      buttons.forEach(b => b.style.display = "");
    }
  }
};

function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

window.addEventListener("db-ready", async () => {
  app.updateDbStatus();
  await app.start();
});
</script>
</body>
</html>

