<!DOCTYPE html>
<html lang="mk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê—É–¥–∏–æ–≥—Ä–∞–º–∏ - –ö–æ—á–æ –†–∞—Ü–∏–Ω (–ë–∞–∑–∞ –Ω–∞ –ø–æ–¥–∞—Ç–æ—Ü–∏)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            min-height: 100vh;
            padding: 10px;
            transition: background 0.3s ease;
        }

        body.light-mode {
            background: #f5f5f5;
            color: #333;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
        }

        .logo {
            width: 80px;
            height: auto;
            margin-bottom: 10px;
        }

        /* --- Header Styles --- */
        .header {
            text-align: center;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: background 0.3s ease;
            position: relative;
        }

        body.light-mode .header {
            background: white;
        }

        body.dark-mode .header {
            background: linear-gradient(135deg, #4a4e69 0%, #5a5f7d 100%);
        }

        .header h1 {
            font-size: 22px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        body.light-mode .header h1 {
            color: #2c3e50;
        }

        body.dark-mode .header h1 {
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header h2 {
            font-size: 16px;
            font-weight: 500;
        }

        body.light-mode .header h2 {
            color: #34495e;
        }

        body.dark-mode .header h2 {
            color: #a8dadc;
        }

        .header-right {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
        }

        .theme-toggle {
            padding: 0;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            width: 60px;
            height: 32px;
            position: relative;
            background: #ccc;
        }

        body.dark-mode .theme-toggle {
            background: #5865F2;
        }

        .theme-toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: white;
            transition: all 0.3s ease;
        }

        body.dark-mode .theme-toggle::after {
            left: 31px;
        }

        /* --- Navigation Panel (New) --- */
        .nav-panel {
            display: flex;
            gap: 15px;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 15px;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
        }

        body.light-mode .nav-panel {
            background: #e3f2fd;
            border: 1px solid #90caf9;
        }

        body.dark-mode .nav-panel {
            background: #232742;
        }

        .nav-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex: 1;
        }

        .record-selector {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 14px;
            min-width: 200px;
        }

        body.light-mode .record-selector {
            background: white;
            color: #333;
            border-color: #ccc;
        }

        body.dark-mode .record-selector {
            background: #424769;
            color: white;
        }

        .nav-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: transform 0.1s;
        }

        .nav-btn:hover {
            transform: scale(1.05);
        }

        .nav-btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background: #5865F2;
            color: white;
        }

        .btn-success {
            background: #2ecc71;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-secondary {
            background: #4a4e69;
            color: white;
        }

        body.light-mode .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .counter-display {
            font-weight: bold;
            min-width: 100px;
            text-align: center;
        }

        /* --- Input Fields --- */
        .subject-info {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            max-width: 1900px;
            margin-left: auto;
            margin-right: auto;
        }

        body.light-mode .subject-info {
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .subject-info {
            background: #2d3250;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .subject-info input {
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 16px;
            text-align: center;
            font-weight: 500;
        }

        body.light-mode .subject-info input {
            background: #f8f9fa;
            color: #2c3e50;
            border-color: #ccc;
        }

        body.dark-mode .subject-info input {
            background: #424769;
            color: #e0e0e0;
        }

        /* --- Canvas & Layout --- */
        .main-container {
            display: flex;
            gap: 15px;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: background 0.3s ease;
            max-width: 1900px;
            margin: 0 auto;
        }

        body.light-mode .main-container {
            background: white;
        }

        body.dark-mode .main-container {
            background: #2d3250;
        }

        .audiogram-panel {
            flex: 1;
            position: relative;
            border-radius: 10px;
            padding: 10px;
        }

        body.light-mode .audiogram-panel {
            background: #fafafa;
        }

        body.dark-mode .audiogram-panel {
            background: #1e2235;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        canvas {
            display: block;
            width: 100%;
            cursor: crosshair;
            border-radius: 8px;
        }

        /* --- Toolbar & Legend --- */
        .toolbar {
            display: flex;
            gap: 12px;
            padding: 18px;
            border-radius: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        body.light-mode .toolbar {
            background: #f8f9fa;
        }

        body.dark-mode .toolbar {
            background: #2d3250;
        }

        .toolbar select,
        .toolbar button {
            padding: 10px 18px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
        }

        body.dark-mode .toolbar select {
            background: #424769;
            color: #e0e0e0;
        }

        body.light-mode .toolbar select {
            background: white;
            color: #333;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 15px;
            padding: 20px;
            border-radius: 15px;
        }

        body.light-mode .legend {
            background: white;
        }

        body.dark-mode .legend {
            background: #2d3250;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            border-radius: 8px;
        }

        body.dark-mode .legend-item {
            background: rgba(66, 71, 105, 0.5);
        }

        body.light-mode .legend-item {
            background: #f0f0f0;
        }

        .legend-symbol {
            font-size: 26px;
            font-weight: bold;
        }

        .red {
            color: #ff6b6b;
        }

        .blue {
            color: #4ecdc4;
        }

        body.light-mode .red {
            color: #e74c3c;
        }

        body.light-mode .blue {
            color: #3498db;
        }

        .examiner-footer {
            text-align: right;
            padding: 15px 25px;
            margin-top: 15px;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 700;
        }

        body.dark-mode .examiner-footer {
            background: #2d3250;
            color: #a8dadc;
        }

        body.light-mode .examiner-footer {
            background: white;
            color: #2c3e50;
        }

        @media print {

            .toolbar,
            .theme-toggle,
            .nav-panel {
                display: none;
            }

            body {
                background: white !important;
                color: black;
            }
        }
    </style>
</head>

<body class="dark-mode">
    <div class="header">
        <div class="header-text">
            <h1>–û–°–ù–û–í–û –£–ß–ò–õ–ò–®–¢–ï –°–û –†–ï–°–£–†–°–ï–ù –¶–ï–ù–¢–ê–† –ö–û–ß–û –†–ê–¶–ò–ù –ë–ò–¢–û–õ–ê</h1>
            <h2>–ö–∞–±–∏–Ω–µ—Ç –∑–∞ —Å–ª—É—Ö, –≥–æ–≤–æ—Ä, –≥–ª–∞—Å, –∞–ª—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∞ –∏ –∞—É–≥–º–µ–Ω—Ç–∞—Ç–∏–≤–Ω–∞ –∫–æ–º—É–Ω–∏–∫–∞—Ü–∏—ò–∞</h2>
        </div>
        <div class="header-right">
            <button class="theme-toggle" onclick="toggleTheme()" title="–°–º–µ–Ω–∏ —Ç–µ–º–∞"></button>
        </div>
    </div>

    <div class="nav-panel">
        <div class="nav-controls" style="flex: 0 0 auto;">
            <input type="file" id="bulkUploadInput" accept=".json" style="display:none"
                onchange="handleBulkUpload(event)">
            <button class="nav-btn btn-primary" onclick="document.getElementById('bulkUploadInput').click()">üìÇ –í—á–∏—Ç–∞—ò
                –ë–∞–∑–∞ (JSON)</button>
            <button class="nav-btn btn-success" onclick="saveFullDatabase()">üíæ –ó–∞—á—É–≤–∞—ò –¶–ï–õ–ê –ë–ê–ó–ê</button>
        </div>

        <div class="nav-controls" style="flex: 1; justify-content: center;">
            <button class="nav-btn btn-secondary" onclick="prevRecord()">‚¨ÖÔ∏è</button>

            <select id="recordSelector" class="record-selector" onchange="jumpToRecord()">
                <option value="-1">-- –í—á–∏—Ç–∞—ò—Ç–µ –ø–æ–¥–∞—Ç–æ—Ü–∏ --</option>
            </select>

            <button class="nav-btn btn-secondary" onclick="nextRecord()">‚û°Ô∏è</button>
            <button class="nav-btn btn-primary" onclick="addNewRecord()" title="–î–æ–¥–∞—ò –Ω–æ–≤ –ø—Ä–∞–∑–µ–Ω –∑–∞–ø–∏—Å –≤–æ –±–∞–∑–∞—Ç–∞">‚ûï –ù–æ–≤
                –ó–∞–ø–∏—Å</button>
        </div>

        <div class="counter-display" id="recordCounter">0 / 0</div>
    </div>

    <div class="subject-info">
        <label for="subjectName">–ò–º–µ:</label>
        <input type="text" id="subjectName" placeholder="–ò–º–µ –Ω–∞ –∏—Å–ø–∏—Ç–∞–Ω–∏–∫"
            oninput="updateCurrentDataField('subjectName')">

        <label for="testDate">–î–∞—Ç—É–º:</label>
        <input type="date" id="testDate" oninput="updateCurrentDataField('date')">
    </div>

    <div class="toolbar">
        <label>–£–≤–æ:</label>
        <select id="earSelect" onchange="redrawAll()">
            <option value="right">–î–µ—Å–Ω–æ</option>
            <option value="left">–õ–µ–≤–æ</option>
        </select>

        <label>–¢–µ—Å—Ç:</label>
        <select id="testTypeSelect" onchange="redrawAll()">
            <option value="air">–í–æ–∑–¥—É—à–Ω–∞ –ø—Ä–æ–≤–æ–¥–Ω–æ—Å—Ç (AC)</option>
            <option value="bone">–ö–æ—Å–∫–µ–Ω–∞ –ø—Ä–æ–≤–æ–¥–Ω–æ—Å—Ç (BC)</option>
        </select>

        <button onclick="clearCurrentRecord()">üóëÔ∏è –ò—Å—á–∏—Å—Ç–∏ —Ç–µ–∫–æ–≤–µ–Ω</button>
        <button onclick="deleteRecord()" class="btn-danger" style="background-color: #c0392b;">‚ùå –ò–∑–±—Ä–∏—à–∏ –ó–∞–ø–∏—Å</button>
        <button onclick="exportSingle()">üíæ –ó–∞—á—É–≤–∞—ò (–ï–¥–µ–Ω)</button>
        <button onclick="exportAsImage()">üì∏ –°–ª–∏–∫–∞ (–ï–¥–µ–Ω)</button>
        <button onclick="exportHistoryImages()" class="btn-primary" style="background: #8e44ad;">üì∏ –ò—Å—Ç–æ—Ä–∏—ò–∞
            (–°–∏—Ç–µ)</button>
    </div>

    <div class="main-container">
        <div class="audiogram-panel left">
            <canvas id="rightCanvas" width="900" height="650"></canvas>
        </div>
        <div class="audiogram-panel right">
            <canvas id="leftCanvas" width="900" height="650"></canvas>
        </div>
    </div>

    <div class="legend">
        <div class="legend-item">
            <span class="legend-symbol red">‚óã</span> <span><strong>R</strong> ‚ñ∂ <strong>L</strong> (AC)</span>
        </div>
        <div class="legend-item">
            <span class="legend-symbol red">&lt;</span> <span><strong>R</strong> ‚ñ∂ <strong>L</strong> (BC)</span>
        </div>
        <div class="legend-item">
            <span class="legend-symbol blue">‚úï</span> <span><strong>R</strong> ‚óÄ <strong>L</strong> (AC)</span>
        </div>
        <div class="legend-item">
            <span class="legend-symbol blue">[</span> <span><strong>R</strong> ‚óÄ <strong>L</strong> (BC)</span>
        </div>
    </div>

    <div class="examiner-footer">
        <strong>–¥–∏–ø–ª. –¥–µ—Ñ. –ë–ª–∞–≥–æ—ò –ù–∞—Å–µ–≤</strong>
    </div>

    <script>
        // --- DATA MANAGEMENT ---
        let allRecords = [];
        let currentIndex = -1;

        // Current working record
        const data = {
            rightAir: {}, rightBone: {},
            leftAir: {}, leftBone: {},
            subjectName: '', date: ''
        };

        const frequencies = [125, 250, 500, 750, 1000, 1500, 2000, 3000, 4000, 6000, 8000];
        const minDB = 0, maxDB = 120;
        const margin = { top: 60, right: 70, bottom: 80, left: 110 };

        const leftCanvas = document.getElementById('leftCanvas');
        const rightCanvas = document.getElementById('rightCanvas');
        const leftCtx = leftCanvas.getContext('2d');
        const rightCtx = rightCanvas.getContext('2d');

        // --- BULK NAVIGATION FUNCTIONS ---

        function handleBulkUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);

                    if (Array.isArray(json)) {
                        allRecords = json;
                        if (allRecords.length > 0) {
                            currentIndex = 0;
                            populateDropdown();
                            loadRecord(0);
                        }
                    } else {
                        // Handle single file upload legacy way
                        allRecords = [json];
                        currentIndex = 0;
                        populateDropdown();
                        loadRecord(0);
                    }
                } catch (error) {
                    alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —á–∏—Ç–∞—ö–µ –Ω–∞ —Ñ–∞—ò–ª–æ—Ç: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function populateDropdown() {
            const select = document.getElementById('recordSelector');
            select.innerHTML = '';

            if (allRecords.length === 0) {
                const opt = document.createElement('option');
                opt.text = "-- –ù–µ–º–∞ –ø–æ–¥–∞—Ç–æ—Ü–∏ --";
                select.appendChild(opt);
                return;
            }

            allRecords.forEach((rec, index) => {
                const opt = document.createElement('option');
                opt.value = index;
                // Format: "1. Name (Date)"
                const dateStr = rec.date ? ` (${rec.date})` : '';
                opt.text = `${index + 1}. ${rec.subjectName || '–ù–µ–ø–æ–∑–Ω–∞—Ç'}${dateStr}`;
                select.appendChild(opt);
            });

            updateCounter();
        }

        function loadRecord(index) {
            if (index < 0 || index >= allRecords.length) return;

            currentIndex = index;
            const record = allRecords[index];

            // Deep copy to current data object
            data.rightAir = record.rightAir || {};
            data.rightBone = record.rightBone || {};
            data.leftAir = record.leftAir || {};
            data.leftBone = record.leftBone || {};
            data.subjectName = record.subjectName || '';
            data.date = record.date || '';

            // Update UI Inputs
            document.getElementById('subjectName').value = data.subjectName;
            document.getElementById('testDate').value = data.date;

            // Sync Dropdown
            document.getElementById('recordSelector').value = index;

            updateCounter();
            redrawAll();
        }

        // --- NEW FEATURES ---

        function addNewRecord() {
            const newRecord = {
                subjectName: "–ù–æ–≤ –ò—Å–ø–∏—Ç–∞–Ω–∏–∫",
                date: new Date().toISOString().split('T')[0],
                rightAir: {}, rightBone: {},
                leftAir: {}, leftBone: {}
            };
            allRecords.push(newRecord);
            currentIndex = allRecords.length - 1;
            populateDropdown();
            loadRecord(currentIndex);
            document.getElementById('subjectName').select();
        }

        function deleteRecord() {
            if (currentIndex === -1) return;
            if (confirm(`–î–∞–ª–∏ —Å—Ç–µ —Å–∏–≥—É—Ä–Ω–∏ –¥–µ–∫–∞ —Å–∞–∫–∞—Ç–µ –¥–∞ –≥–æ –∏–∑–±—Ä–∏—à–µ—Ç–µ –∑–∞–ø–∏—Å–æ—Ç –∑–∞: ${data.subjectName}?`)) {
                allRecords.splice(currentIndex, 1);
                if (allRecords.length > 0) {
                    currentIndex = Math.max(0, currentIndex - 1);
                    populateDropdown();
                    loadRecord(currentIndex);
                } else {
                    currentIndex = -1;
                    data.subjectName = ''; data.date = '';
                    data.rightAir = {}; data.rightBone = {};
                    data.leftAir = {}; data.leftBone = {};
                    populateDropdown();
                    redrawAll();
                    updateCounter();
                }
            }
        }

        function saveFullDatabase() {
            if (allRecords.length === 0) return alert("–ë–∞–∑–∞—Ç–∞ –µ –ø—Ä–∞–∑–Ω–∞.");
            const json = JSON.stringify(allRecords, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'AUDIOGRAMI_BAZA_' + new Date().toISOString().slice(0, 10) + '.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function nextRecord() {
            if (currentIndex < allRecords.length - 1) {
                loadRecord(currentIndex + 1);
            }
        }

        function prevRecord() {
            if (currentIndex > 0) {
                loadRecord(currentIndex - 1);
            }
        }

        function jumpToRecord() {
            const select = document.getElementById('recordSelector');
            loadRecord(parseInt(select.value));
        }

        function updateCounter() {
            const el = document.getElementById('recordCounter');
            if (allRecords.length === 0) {
                el.innerText = "0 / 0";
            } else {
                el.innerText = `${currentIndex + 1} / ${allRecords.length}`;
            }
        }

        function updateCurrentDataField(field) {
            const val = document.getElementById(field === 'subjectName' ? 'subjectName' : 'testDate').value;
            data[field] = val;

            // Update the array in memory so changes aren't lost when navigating
            if (currentIndex >= 0 && allRecords[currentIndex]) {
                allRecords[currentIndex][field] = val;
                // Update dropdown text if name changed
                if (field === 'subjectName' || field === 'date') populateDropdown();
                // Restore selection
                document.getElementById('recordSelector').value = currentIndex;
            }
            redrawAll();
        }

        // --- DRAWING FUNCTIONS (Standard) ---

        function toggleTheme() {
            const body = document.body;
            if (body.classList.contains('dark-mode')) {
                body.classList.remove('dark-mode');
                body.classList.add('light-mode');
            } else {
                body.classList.remove('light-mode');
                body.classList.add('dark-mode');
            }
            redrawAll();
        }

        function isDarkMode() { return document.body.classList.contains('dark-mode'); }

        function drawAudiogram(canvas, ctx, showRight) {
            const dark = isDarkMode();
            ctx.fillStyle = dark ? '#1e2235' : '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const plotWidth = canvas.width - margin.left - margin.right;
            const plotHeight = canvas.height - margin.top - margin.bottom;

            // Title
            ctx.font = 'bold 26px Arial';
            ctx.fillStyle = dark ? '#e0e0e0' : '#2c3e50';
            ctx.textAlign = 'center';
            ctx.fillText('dB HL', canvas.width / 2, 40);

            drawGrid(ctx, plotWidth, plotHeight, dark);
            drawLabels(ctx, plotWidth, plotHeight, dark);

            const redColor = dark ? '#ff6b6b' : '#e74c3c';
            const blueColor = dark ? '#5B9BD5' : '#3498db';

            if (showRight) {
                drawDataSet(ctx, data.rightAir, plotWidth, plotHeight, redColor, 'circle', dark);
                drawDataSet(ctx, data.rightBone, plotWidth, plotHeight, redColor, 'less', dark);
            } else {
                drawDataSet(ctx, data.leftAir, plotWidth, plotHeight, blueColor, 'x', dark);
                drawDataSet(ctx, data.leftBone, plotWidth, plotHeight, blueColor, 'bracket', dark);
            }
        }

        function drawGrid(ctx, plotWidth, plotHeight, dark) {
            ctx.strokeStyle = dark ? '#a8dadc' : '#333';
            ctx.lineWidth = 3;
            ctx.strokeRect(margin.left, margin.top, plotWidth, plotHeight);

            const padding = plotWidth * 0.05;
            const usableWidth = plotWidth - (padding * 2);

            ctx.lineWidth = 1;
            frequencies.forEach((freq, i) => {
                const x = margin.left + padding + (i * usableWidth / (frequencies.length - 1));
                ctx.strokeStyle = dark ? 'rgba(168, 218, 220, 0.2)' : 'rgba(0, 0, 0, 0.1)';
                ctx.beginPath(); ctx.moveTo(x, margin.top + 1); ctx.lineTo(x, margin.top + plotHeight - 1); ctx.stroke();
            });

            for (let db = minDB; db <= maxDB; db += 10) {
                const y = getYPosition(db, plotHeight);
                const isMajor = db % 20 === 0;
                ctx.strokeStyle = dark
                    ? (isMajor ? 'rgba(168, 218, 220, 0.4)' : 'rgba(168, 218, 220, 0.15)')
                    : (isMajor ? 'rgba(0, 0, 0, 0.3)' : 'rgba(0, 0, 0, 0.1)');
                ctx.lineWidth = isMajor ? 1.5 : 1;
                if (db > minDB && db < maxDB) {
                    ctx.beginPath(); ctx.moveTo(margin.left + 1, y); ctx.lineTo(margin.left + plotWidth - 1, y); ctx.stroke();
                }
            }
        }

        function drawLabels(ctx, plotWidth, plotHeight, dark) {
            ctx.font = '16px Arial';
            ctx.fillStyle = dark ? '#e0e0e0' : '#333';
            const padding = plotWidth * 0.05;
            const usableWidth = plotWidth - (padding * 2);

            frequencies.forEach((freq, i) => {
                const x = margin.left + padding + (i * usableWidth / (frequencies.length - 1));
                const label = freq >= 1000 ? (freq / 1000).toString().replace('.', ',') + 'k' : freq.toString();
                ctx.textAlign = 'center'; ctx.fillText(label + ' Hz', x, margin.top + plotHeight + 35);
            });

            for (let db = minDB; db <= maxDB; db += 10) {
                const y = getYPosition(db, plotHeight);
                ctx.textAlign = 'right'; ctx.fillText(db.toString(), margin.left - 18, y + 6);
            }
        }

        function drawDataSet(ctx, dataset, plotWidth, plotHeight, color, symbol, dark) {
            const points = Object.keys(dataset).map(freq => ({ freq: parseInt(freq), db: dataset[freq] })).sort((a, b) => a.freq - b.freq);
            if (points.length === 0) return;

            ctx.strokeStyle = color; ctx.lineWidth = 2.5;
            if (dark) { ctx.shadowColor = color; ctx.shadowBlur = 6; }

            ctx.beginPath();
            points.forEach((point, i) => {
                const x = getXPosition(point.freq, plotWidth);
                const y = getYPosition(point.db, plotHeight);
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            });
            ctx.stroke(); ctx.shadowBlur = 0;

            points.forEach(point => {
                const x = getXPosition(point.freq, plotWidth);
                const y = getYPosition(point.db, plotHeight);
                drawSymbol(ctx, x, y, color, symbol, dark);
            });
        }

        function drawSymbol(ctx, x, y, color, type, dark) {
            const size = 16;
            ctx.strokeStyle = color; ctx.fillStyle = color; ctx.lineWidth = 2.5;
            if (dark) { ctx.shadowColor = color; ctx.shadowBlur = 5; }

            if (type === 'circle') {
                ctx.beginPath(); ctx.arc(x, y, size / 2, 0, Math.PI * 2); ctx.stroke();
            } else if (type === 'x') {
                ctx.beginPath();
                ctx.moveTo(x - size / 2, y - size / 2); ctx.lineTo(x + size / 2, y + size / 2);
                ctx.moveTo(x + size / 2, y - size / 2); ctx.lineTo(x - size / 2, y + size / 2);
                ctx.stroke();
            } else if (type === 'less') {
                ctx.font = 'bold 24px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText('<', x, y);
            } else if (type === 'bracket') {
                ctx.font = 'bold 24px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText('[', x, y);
            }
            ctx.shadowBlur = 0;
        }

        // --- HELPER FUNCTIONS ---
        function getXPosition(freq, plotWidth) {
            const index = frequencies.indexOf(freq);
            if (index === -1) return margin.left;
            const padding = plotWidth * 0.05;
            const usableWidth = plotWidth - (padding * 2);
            return margin.left + padding + (index * usableWidth / (frequencies.length - 1));
        }

        function getYPosition(db, plotHeight) {
            const ratio = (db - minDB) / (maxDB - minDB);
            return margin.top + (ratio * plotHeight);
        }

        function getNearestFrequency(x, plotWidth) {
            const padding = plotWidth * 0.05;
            const usableWidth = plotWidth - (padding * 2);
            const relativeX = x - margin.left - padding;
            const index = Math.round(relativeX / (usableWidth / (frequencies.length - 1)));
            return frequencies[Math.max(0, Math.min(frequencies.length - 1, index))];
        }

        function getDBLevel(y, plotHeight) {
            const relativeY = y - margin.top;
            const ratio = relativeY / plotHeight;
            const db = Math.round((minDB + (ratio * (maxDB - minDB))) / 5) * 5;
            return Math.max(minDB, Math.min(maxDB, db));
        }

        // --- INTERACTION ---
        function setupCanvasEvents(canvas, isRight) {
            // Click to add point
            canvas.addEventListener('click', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX - rect.left) * (canvas.width / rect.width);
                const y = (e.clientY - rect.top) * (canvas.height / rect.height);
                const plotWidth = canvas.width - margin.left - margin.right;
                const plotHeight = canvas.height - margin.top - margin.bottom;

                if (x < margin.left || x > margin.left + plotWidth || y < margin.top || y > margin.top + plotHeight) return;

                const currentEar = document.getElementById('earSelect').value;
                const canvasEar = isRight ? 'right' : 'left';
                if (currentEar !== canvasEar) return;

                const freq = getNearestFrequency(x, plotWidth);
                const db = getDBLevel(y, plotHeight);
                const test = document.getElementById('testTypeSelect').value;
                const key = currentEar + test.charAt(0).toUpperCase() + test.slice(1);

                data[key][freq] = db;

                // Update master record if we are in bulk mode
                if (currentIndex >= 0 && allRecords[currentIndex]) {
                    allRecords[currentIndex][key] = data[key];
                }

                redrawAll();
            });

            // Right click to delete point
            canvas.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX - rect.left) * (canvas.width / rect.width);
                const y = (e.clientY - rect.top) * (canvas.height / rect.height);
                const plotWidth = canvas.width - margin.left - margin.right;
                const plotHeight = canvas.height - margin.top - margin.bottom;

                if (x < margin.left || x > margin.left + plotWidth || y < margin.top || y > margin.top + plotHeight) return;

                const freq = getNearestFrequency(x, plotWidth);
                const currentEar = document.getElementById('earSelect').value;
                const canvasEar = isRight ? 'right' : 'left';
                if (currentEar !== canvasEar) return;

                const test = document.getElementById('testTypeSelect').value;
                const key = currentEar + test.charAt(0).toUpperCase() + test.slice(1);

                if (data[key][freq] !== undefined) {
                    delete data[key][freq];
                    // Update master record
                    if (currentIndex >= 0 && allRecords[currentIndex]) {
                        allRecords[currentIndex][key] = data[key];
                    }
                    redrawAll();
                }
            });
        }

        function redrawAll() {
            drawAudiogram(rightCanvas, rightCtx, true);
            drawAudiogram(leftCanvas, leftCtx, false);
        }

        function clearCurrentRecord() {
            if (currentIndex === -1) return;
            if (confirm('–ò–∑–±—Ä–∏—à–∏ –≥–∏ —Ç–µ–∫–æ–≤–Ω–∏—Ç–µ —Ç–æ—á–∫–∏ –∑–∞ –æ–≤–æ—ò —É—á–µ–Ω–∏–∫?')) {
                data.rightAir = {}; data.rightBone = {};
                data.leftAir = {}; data.leftBone = {};
                if (currentIndex >= 0) {
                    allRecords[currentIndex].rightAir = {};
                    allRecords[currentIndex].rightBone = {};
                    allRecords[currentIndex].leftAir = {};
                    allRecords[currentIndex].leftBone = {};
                }
                redrawAll();
            }
        }

        function clearAll() {
            if (confirm('–ò–∑–±—Ä–∏—à–∏ –≥–∏ —Ç–µ–∫–æ–≤–Ω–∏—Ç–µ –ø–æ–¥–∞—Ç–æ—Ü–∏? (–û–≤–∞ –Ω–µ –≥–æ –±—Ä–∏—à–µ —Ñ–∞—ò–ª–æ—Ç)')) {
                data.rightAir = {}; data.rightBone = {};
                data.leftAir = {}; data.leftBone = {};
                if (currentIndex >= 0) {
                    allRecords[currentIndex].rightAir = {};
                    allRecords[currentIndex].rightBone = {};
                    allRecords[currentIndex].leftAir = {};
                    allRecords[currentIndex].leftBone = {};
                }
                redrawAll();
            }
        }

        function exportSingle() {
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'audiogram_' + (data.subjectName || 'unnamed') + '.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportAsImage() {
            // (Same as previous image export logic, simplified for brevity but fully functional)
            const exportCanvas = document.createElement('canvas');
            exportCanvas.width = 2400; exportCanvas.height = 1550;
            const exportCtx = exportCanvas.getContext('2d');
            const dark = isDarkMode();

            if (dark) {
                const gradient = exportCtx.createLinearGradient(0, 0, 2400, 1550);
                gradient.addColorStop(0, '#1a1a2e'); gradient.addColorStop(1, '#16213e');
                exportCtx.fillStyle = gradient;
            } else { exportCtx.fillStyle = '#ffffff'; }
            exportCtx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);

            // Header
            exportCtx.fillStyle = dark ? '#4a4e69' : '#ffffff';
            exportCtx.fillRect(50, 30, 2300, 150);
            exportCtx.fillStyle = dark ? '#ffffff' : '#2c3e50';
            exportCtx.font = 'bold 40px Arial'; exportCtx.textAlign = 'center';
            exportCtx.fillText('–û–°–ù–û–í–û –£–ß–ò–õ–ò–®–¢–ï –°–û –†–ï–°–£–†–°–ï–ù –¶–ï–ù–¢–ê–†', 1200, 90);
            exportCtx.fillText('–ö–û–ß–û –†–ê–¶–ò–ù –ë–ò–¢–û–õ–ê', 1200, 140);

            // Info
            if (data.subjectName) {
                exportCtx.fillStyle = dark ? '#2d3250' : '#ffffff';
                exportCtx.fillRect(50, 200, 2300, 70);
                exportCtx.fillStyle = dark ? '#a8dadc' : '#2c3e50';
                exportCtx.font = 'bold 28px Arial';
                const dateText = data.date ? ` | –î–∞—Ç—É–º: ${data.date}` : '';
                exportCtx.fillText(`–ò–º–µ: ${data.subjectName}${dateText}`, 1200, 245);
            }

            const graphsStartY = data.subjectName ? 290 : 200;
            exportCtx.drawImage(rightCanvas, 50, graphsStartY, 1100, 920);
            exportCtx.drawImage(leftCanvas, 1200, graphsStartY, 1100, 920);

            // Legend & Footer (Simplified for export)
            const legendY = graphsStartY + 960;
            exportCtx.font = 'bold 22px Arial'; exportCtx.textAlign = 'right';
            exportCtx.fillStyle = dark ? '#a8dadc' : '#2c3e50';
            exportCtx.fillText('–¥–∏–ø–ª. –¥–µ—Ñ. –ë–ª–∞–≥–æ—ò –ù–∞—Å–µ–≤', 2300, legendY + 70);

            exportCanvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `audiogram_${data.subjectName || 'unnamed'}.png`;
                a.click();
            });
        }

        // --- NEW: EXPORT HISTORY (Centered & Larger) ---
        function exportHistoryImages() {
            const name = data.subjectName.trim();
            if (!name) return alert("–ù–µ–º–∞ –∏–∑–±—Ä–∞–Ω–æ –∏–º–µ –Ω–∞ –∏—Å–ø–∏—Ç–∞–Ω–∏–∫.");

            // 1. Filter and Sort
            const records = allRecords.filter(r => (r.subjectName || '').trim() === name)
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            if (records.length === 0) return alert("–ù–µ–º–∞ –∑–∞–ø–∏—Å–∏ –∑–∞ –æ–≤–æ—ò –∏—Å–ø–∏—Ç–∞–Ω–∏–∫.");

            // 2. Chunk into groups of 4
            const chunks = [];
            for (let i = 0; i < records.length; i += 4) {
                chunks.push(records.slice(i, i + 4));
            }

            // 3. Temporarily enforce light mode properties for drawing
            const wasDark = isDarkMode();
            if (wasDark) document.body.classList.remove('dark-mode');

            // 4. Generate Image for each chunk
            chunks.forEach((chunk, pageIndex) => {
                const canvas = document.createElement('canvas');
                // Increased Height to 3500px to allow for larger graphs and spacing
                canvas.width = 2400;
                canvas.height = 3600;
                const ctx = canvas.getContext('2d');

                // White Background
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // --- HEADER ---
                ctx.fillStyle = '#2c3e50';
                ctx.textAlign = 'center';
                ctx.font = 'bold 45px Arial';
                ctx.fillText('–û–°–ù–û–í–û –£–ß–ò–õ–ò–®–¢–ï –°–û –†–ï–°–£–†–°–ï–ù –¶–ï–ù–¢–ê–†', 1200, 80);
                ctx.fillText('–ö–û–ß–û –†–ê–¶–ò–ù –ë–ò–¢–û–õ–ê', 1200, 140);

                ctx.font = 'bold 36px Arial';
                ctx.fillText(`–ò–°–¢–û–†–ò–à–ê –ù–ê –ê–£–î–ò–û–ì–†–ê–ú–ò: ${name.toUpperCase()}`, 1200, 240);
                ctx.font = 'italic 24px Arial';
                ctx.fillText(`–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${pageIndex + 1} –æ–¥ ${chunks.length}`, 1200, 290);

                // --- DRAW ROWS ---
                let yOffset = 350;

                // Config for centered large graphs
                const graphWidth = 900 * 1.0; // Scale 1.0 = 900px
                const graphHeight = 650 * 1.0;
                const gap = 100; // Gap between L and R

                // Calculate Centering
                // Total Width = 2400
                // Content Width = graphWidth * 2 + gap = 1800 + 100 = 1900
                // Margin Left = (2400 - 1900) / 2 = 250
                const marginLeft = (canvas.width - (graphWidth * 2 + gap)) / 2;

                chunk.forEach((rec) => {
                    // Draw Date Title above the row
                    ctx.fillStyle = '#2c3e50';
                    ctx.font = 'bold 32px Arial';
                    ctx.textAlign = 'left';
                    ctx.fillText(`–î–∞—Ç—É–º: ${rec.date || '–ù–µ–ø–æ–∑–Ω–∞—Ç'}`, marginLeft, yOffset - 25);

                    // Mock global data for the draw function
                    const savedData = { ...data }; // backup current
                    data.rightAir = rec.rightAir; data.rightBone = rec.rightBone;
                    data.leftAir = rec.leftAir; data.leftBone = rec.leftBone;

                    const tempC = document.createElement('canvas'); tempC.width = 900; tempC.height = 650;
                    const tempCtx = tempC.getContext('2d');

                    // Draw Right
                    drawAudiogram(tempC, tempCtx, true);
                    ctx.drawImage(tempC, marginLeft, yOffset, graphWidth, graphHeight);

                    // Draw Left
                    drawAudiogram(tempC, tempCtx, false);
                    ctx.drawImage(tempC, marginLeft + graphWidth + gap, yOffset, graphWidth, graphHeight);

                    // Restore global data
                    Object.assign(data, savedData);

                    yOffset += graphHeight + 110; // Move down for next row
                });

                // --- FOOTER ---
                ctx.fillStyle = '#2c3e50';
                ctx.font = 'bold 26px Arial';
                ctx.textAlign = 'right';
                ctx.fillText('–¥–∏–ø–ª. –¥–µ—Ñ. –ë–ª–∞–≥–æ—ò –ù–∞—Å–µ–≤', 2300, canvas.height - 50);

                // Download
                canvas.toBlob(blob => {
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `History_${name}_Page${pageIndex + 1}.png`;
                    a.click();
                });
            });

            // Restore Theme
            if (wasDark) { document.body.classList.add('dark-mode'); redrawAll(); }
            else { redrawAll(); } // just to be safe
        }

        // Init
        setupCanvasEvents(rightCanvas, true);
        setupCanvasEvents(leftCanvas, false);
        redrawAll();
    </script>
</body>

</html>