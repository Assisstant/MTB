<!DOCTYPE html>
<html lang="mk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EduHub</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß∞</text></svg>">
  <style>
    :root {
      --bg: #f5f7fa;
      --surface: #ffffff;
      --surface-light: #f0f2f5;
      --text: #1a1a2e;
      --text-secondary: #64748b;
      --border: rgba(0, 0, 0, 0.08);
      --accent: #6366f1;
      --accent-hover: #4f46e5;
      --accent-light: rgba(99, 102, 241, 0.1);
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
      --radius: 12px;
      --radius-sm: 8px;
    }

    [data-theme="dark"] {
      --bg: #0f172a;
      --surface: #1e293b;
      --surface-light: #334155;
      --text: #f1f5f9;
      --text-secondary: #94a3b8;
      --border: rgba(255, 255, 255, 0.08);
      --accent: #818cf8;
      --accent-hover: #6366f1;
      --accent-light: rgba(129, 140, 248, 0.15);
      --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.5;
      transition: background 0.3s, color 0.3s;
    }

    /* --- TOP NAVIGATION --- */
    .top-nav {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-sm);
    }

    .nav-btn {
      width: 36px;
      height: 36px;
      border: 1px solid var(--border);
      background: var(--surface-light);
      color: var(--text);
      border-radius: var(--radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      transition: all 0.2s;
    }

    .nav-btn:hover { 
      background: var(--accent); 
      color: white; 
      border-color: var(--accent);
    }

    .nav-btn.danger:hover { background: var(--danger); border-color: var(--danger); }
    .nav-btn.success:hover { background: var(--success); border-color: var(--success); }

    .nav-separator { width: 1px; height: 24px; background: var(--border); margin: 0 6px; }

    .nav-title {
      font-size: 18px;
      font-weight: 700;
      margin-right: auto;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .nav-stats {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .lang-btn {
      padding: 5px 10px;
      background: var(--accent-light);
      color: var(--accent);
      border: 1px solid var(--accent);
      border-radius: 15px;
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
    }

    .lang-btn:hover { background: var(--accent); color: white; }

    /* --- TABS --- */
    .tabs-container {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 0 20px;
      display: flex;
      align-items: center;
      gap: 4px;
      overflow-x: auto;
    }

    .tabs-container::-webkit-scrollbar { height: 3px; }
    .tabs-container::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 3px; }

    .tab {
      padding: 12px 18px;
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .tab:hover { color: var(--text); background: var(--surface-light); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

    .tab .tab-count {
      background: var(--surface-light);
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 10px;
    }

    .tab.active .tab-count { background: var(--accent-light); }

    .tab-close {
      margin-left: 4px;
      opacity: 0;
      font-size: 12px;
      transition: opacity 0.2s;
    }

    .tab:hover .tab-close { opacity: 0.6; }
    .tab-close:hover { opacity: 1; color: var(--danger); }

    .add-tab-btn {
      padding: 8px 12px;
      background: none;
      border: 1px dashed var(--border);
      color: var(--text-secondary);
      border-radius: var(--radius-sm);
      font-size: 12px;
      cursor: pointer;
      margin-left: 8px;
      transition: all 0.2s;
    }

    .add-tab-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-light);
    }

    /* --- SEARCH --- */
    .search-bar {
      padding: 16px 20px;
      display: flex;
      justify-content: center;
    }

    .search-input {
      width: 100%;
      max-width: 400px;
      padding: 12px 18px 12px 42px;
      border: 2px solid var(--border);
      border-radius: 25px;
      font-size: 14px;
      background: var(--surface);
      color: var(--text);
      outline: none;
      transition: all 0.2s;
    }

    .search-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }

    .search-wrapper {
      position: relative;
      width: 100%;
      max-width: 400px;
    }

    .search-wrapper::before {
      content: 'üîç';
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
    }

    /* --- MAIN GRID --- */
    .main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 10px 20px 100px;
    }

    .app-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 14px;
    }

    @media (max-width: 1200px) { .app-grid { grid-template-columns: repeat(4, 1fr); } }
    @media (max-width: 900px) { .app-grid { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 600px) { .app-grid { grid-template-columns: repeat(2, 1fr); } }

    /* --- APP CARDS --- */
    .app-card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 14px;
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: var(--text);
      position: relative;
      transition: all 0.2s;
      border: 1px solid var(--border);
      cursor: grab;
      user-select: none;
    }

    .app-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-lg);
      border-color: var(--accent);
    }

    .app-card.dragging {
      opacity: 0.5;
      transform: scale(1.02);
      box-shadow: var(--shadow-lg);
    }

    .app-card.drag-over {
      border-color: var(--accent);
      border-style: dashed;
      background: var(--accent-light);
    }

    .app-icon {
      width: 42px;
      height: 42px;
      background: var(--accent-light);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      flex-shrink: 0;
    }

    .app-name {
      font-weight: 600;
      font-size: 13px;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .app-actions {
      position: absolute;
      top: 6px;
      right: 6px;
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .app-card:hover .app-actions { opacity: 1; }

    .app-action {
      width: 24px;
      height: 24px;
      border: none;
      background: var(--surface-light);
      color: var(--text-secondary);
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .app-action:hover { background: var(--accent); color: white; }
    .app-action.delete:hover { background: var(--danger); }
    .app-action.star { color: var(--text-secondary); }
    .app-action.star.active { color: #f59e0b; background: rgba(245, 158, 11, 0.1); }

    /* --- ADD CARD --- */
    .add-card {
      background: var(--surface);
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .add-card:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-light);
    }

    /* --- MODALS --- */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-overlay.show { display: flex; }

    .modal {
      background: var(--surface);
      width: 100%;
      max-width: 480px;
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow-lg);
      max-height: 85vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal-close {
      width: 30px;
      height: 30px;
      background: var(--surface-light);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .modal-close:hover { background: var(--danger); color: white; }

    .form-group { margin-bottom: 16px; }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 6px;
      text-transform: uppercase;
    }

    .form-input, .form-select {
      width: 100%;
      padding: 11px 14px;
      background: var(--bg);
      border: 2px solid var(--border);
      color: var(--text);
      border-radius: var(--radius-sm);
      font-size: 14px;
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .icon-grid {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 6px;
      background: var(--bg);
      padding: 10px;
      border-radius: var(--radius-sm);
      border: 2px solid var(--border);
    }

    .icon-option {
      aspect-ratio: 1;
      border: 2px solid transparent;
      background: var(--surface);
      border-radius: 6px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    .icon-option:hover { border-color: var(--accent); transform: scale(1.1); }
    .icon-option.active { border-color: var(--accent); background: var(--accent-light); }

    .btn {
      padding: 12px 20px;
      border-radius: var(--radius-sm);
      border: none;
      cursor: pointer;
      font-weight: 700;
      font-size: 13px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
    }

    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-danger { background: var(--danger); color: white; }
    .btn-secondary { background: var(--surface-light); color: var(--text-secondary); margin-top: 8px; }

    /* --- APP SELECTOR (for tabs) --- */
    .app-selector {
      max-height: 250px;
      overflow-y: auto;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--bg);
    }

    .app-selector-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: background 0.15s;
    }

    .app-selector-item:last-child { border-bottom: none; }
    .app-selector-item:hover { background: var(--surface-light); }

    .app-selector-item input { width: 18px; height: 18px; accent-color: var(--accent); }
    .app-selector-item .icon { font-size: 20px; }
    .app-selector-item .name { font-weight: 500; font-size: 13px; }

    /* --- STORAGE LIST --- */
    .storage-list { max-height: 280px; overflow-y: auto; }

    .storage-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: var(--bg);
      border-radius: var(--radius-sm);
      margin-bottom: 6px;
      border: 1px solid var(--border);
    }

    .storage-item input { width: 18px; height: 18px; accent-color: var(--accent); }
    .storage-key { font-weight: 600; font-size: 13px; }
    .storage-size { font-size: 11px; color: var(--text-secondary); }

    .warning-box {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--danger);
      border-radius: var(--radius-sm);
      padding: 12px;
      font-size: 12px;
      color: var(--danger);
      margin-bottom: 16px;
    }

    /* --- FILE DROP --- */
    .file-drop {
      border: 2px dashed var(--border);
      border-radius: var(--radius);
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 12px;
    }

    .file-drop:hover { border-color: var(--accent); background: var(--accent-light); }
    .file-drop-icon { font-size: 32px; margin-bottom: 8px; }
    .file-drop-text { color: var(--text-secondary); font-size: 13px; }

    /* --- TOAST --- */
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--surface);
      color: var(--text);
      padding: 12px 24px;
      border-radius: 25px;
      box-shadow: var(--shadow-lg);
      font-weight: 600;
      font-size: 13px;
      z-index: 9999;
      opacity: 0;
      transition: all 0.3s;
      border: 2px solid var(--accent);
    }

    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    .toast.error { border-color: var(--danger); }

    /* --- EMPTY STATE --- */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .empty-state-icon { font-size: 50px; margin-bottom: 12px; opacity: 0.5; }

    @media (max-width: 600px) {
      .nav-title span { display: none; }
      .nav-stats { display: none; }
      .tab { padding: 10px 14px; font-size: 12px; }
    }
  </style>
</head>
<body>

  <!-- TOP NAV -->
  <nav class="top-nav">
    <div class="nav-title">üß∞ <span>App Toolbox</span></div>
    <button class="nav-btn" id="themeBtn" title="–¢–µ–º–∞">üåô</button>
    <button class="nav-btn" onclick="openImportModal()" title="–£–≤–µ–∑–∏">üì•</button>
    <button class="nav-btn" onclick="exportData()" title="–ò–∑–≤–µ–∑–∏">üì§</button>
    <div class="nav-separator"></div>
    <button class="nav-btn success" onclick="scanGitHub()" title="Sync GitHub">üîÑ</button>
    <button class="nav-btn danger" onclick="openCleanModal()" title="–ß–∏—Å—Ç –∏–∑–ª–µ–∑">üö™</button>
    <div class="nav-separator"></div>
    <button class="lang-btn" id="langBtn" onclick="toggleLang()">EN</button>
    <div class="nav-stats">
      <span>üì± <strong id="totalApps">0</strong></span>
    </div>
  </nav>

  <!-- TABS -->
  <div class="tabs-container" id="tabsContainer">
    <!-- Tabs render here -->
  </div>

  <!-- SEARCH -->
  <div class="search-bar">
    <div class="search-wrapper">
      <input type="text" class="search-input" id="searchInput" placeholder="–ü—Ä–µ–±–∞—Ä–∞—ò...">
    </div>
  </div>

  <!-- MAIN -->
  <main class="main">
    <div class="app-grid" id="appGrid"></div>
  </main>

  <!-- APP MODAL -->
  <div class="modal-overlay" id="appModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="appModalTitle">‚ûï –î–æ–¥–∞—ò</h2>
        <button class="modal-close" onclick="closeAppModal()">‚úï</button>
      </div>
      <div class="form-group">
        <label class="form-label">–ò–º–µ</label>
        <input type="text" class="form-input" id="appName" placeholder="–ò–º–µ –Ω–∞ –∞–ø–ª–∏–∫–∞—Ü–∏—ò–∞">
      </div>
      <div class="form-group">
        <label class="form-label">URL</label>
        <input type="text" class="form-input" id="appUrl" placeholder="https://...">
      </div>
      <div class="form-group">
        <label class="form-label">–ò–∫–æ–Ω–∞</label>
        <div class="icon-grid" id="iconGrid"></div>
      </div>
      <button class="btn btn-primary" onclick="saveApp()">üíæ –ó–∞—á—É–≤–∞—ò</button>
      <button class="btn btn-secondary" onclick="closeAppModal()">–û—Ç–∫–∞–∂–∏</button>
    </div>
  </div>

  <!-- TAB MODAL -->
  <div class="modal-overlay" id="tabModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">üìÅ –ù–æ–≤–∞ –∫–æ–ª–µ–∫—Ü–∏—ò–∞</h2>
        <button class="modal-close" onclick="closeTabModal()">‚úï</button>
      </div>
      <div class="form-group">
        <label class="form-label">–ò–º–µ –Ω–∞ –∫–æ–ª–µ–∫—Ü–∏—ò–∞</label>
        <input type="text" class="form-input" id="tabName" placeholder="–ø—Ä. –†–∞–±–æ—Ç–∞, –î–æ–º–∞...">
      </div>
      <div class="form-group">
        <label class="form-label">–ò–∫–æ–Ω–∞</label>
        <div class="icon-grid" id="tabIconGrid"></div>
      </div>
      <div class="form-group">
        <label class="form-label">–ò–∑–±–µ—Ä–∏ –∞–ø–ª–∏–∫–∞—Ü–∏–∏</label>
        <div class="app-selector" id="appSelector"></div>
      </div>
      <button class="btn btn-primary" onclick="saveTab()">üíæ –ó–∞—á—É–≤–∞—ò</button>
      <button class="btn btn-secondary" onclick="closeTabModal()">–û—Ç–∫–∞–∂–∏</button>
    </div>
  </div>

  <!-- IMPORT MODAL -->
  <div class="modal-overlay" id="importModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">üì• –£–≤–µ–∑–∏</h2>
        <button class="modal-close" onclick="closeImportModal()">‚úï</button>
      </div>
      <div class="file-drop" onclick="document.getElementById('fileInput').click()">
        <div class="file-drop-icon">üìÅ</div>
        <div class="file-drop-text">–ö–ª–∏–∫–Ω–∏ –∏–ª–∏ –≤–ª–µ—á–∏ JSON –¥–∞—Ç–æ—Ç–µ–∫–∞</div>
      </div>
      <input type="file" id="fileInput" accept=".json" style="display:none" onchange="handleFile(event)">
      <textarea class="form-input" id="importText" rows="4" placeholder="–∏–ª–∏ –∑–∞–ª–µ–ø–∏ JSON..."></textarea>
      <button class="btn btn-primary" onclick="doImport()" style="margin-top:12px">üöÄ –£–≤–µ–∑–∏</button>
    </div>
  </div>

  <!-- CLEAN EXIT MODAL -->
  <div class="modal-overlay" id="cleanModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">üö™ –ß–∏—Å—Ç –∏–∑–ª–µ–∑</h2>
        <button class="modal-close" onclick="closeCleanModal()">‚úï</button>
      </div>
      <div class="warning-box">‚ö†Ô∏è –û–≤–∞ —ú–µ –≥–∏ –∏–∑–±—Ä–∏—à–µ –∏–∑–±—Ä–∞–Ω–∏—Ç–µ –ø–æ–¥–∞—Ç–æ—Ü–∏ –Ω–µ–ø–æ–≤—Ä–∞—Ç–Ω–æ!</div>
      <div class="storage-list" id="storageList"></div>
      <button class="btn btn-danger" onclick="performClean()" style="margin-top:12px">üóëÔ∏è –ò–∑–±—Ä–∏—à–∏</button>
    </div>
  </div>

  <!-- TOAST -->
  <div class="toast" id="toast"></div>

  <script>
    const ICONS = ['üìã', 'üìä', 'üìà', 'üìÖ', 'üìù', 'üìÅ', 'üîß', '‚öôÔ∏è', 'üé®', 'üì±', 'üíª', 'üåê', 'üìö', 'üí∞', 'üöÄ', 'üî•', '‚ö°', 'üß∞', 'üéØ', 'üì¶', '‚úÖ', 'üîî', 'üí°', 'üéì', 'üë•', 'üè†', 'üíº', 'üéÆ', 'üéµ', 'üì∑', '‚úèÔ∏è', 'üëÇ'];
    const STORE_KEY = 'app-toolbox-v4';
    
    const FILE_MAPPINGS = {
      'StudentRecords.html': { name: '–°—Ç—É–¥–µ–Ω—Ç—Å–∫–∏ –î–æ—Å–∏–µ–∞', icon: 'üìã' },
      'S_M_U_R_O_P.html': { name: '–°–ú–£–†–û–ü –î–Ω–µ–≤–Ω–∏–∫', icon: 'üìÖ' },
      'audiogram.html': { name: '–ê—É–¥–∏–æ–≥—Ä–∞–º', icon: 'üëÇ' },
      'kanban.html': { name: '–ö–∞–Ω–±–∞–Ω –¢–∞–±–ª–∞', icon: 'üìå' },
      'Kanban-Bookmark - Enhanced-v2.html': { name: '–ö–∞–Ω–±–∞–Ω –û–±–µ–ª–µ–∂—É–≤–∞—á–∏', icon: 'üîñ' },
      'cyrillic-whiteboard-enhanced.html': { name: '–ö–∏—Ä–∏–ª–∏—á–Ω–∞ –¢–∞–±–ª–∞', icon: '‚úèÔ∏è' },
      'TabelaSoDokazi.html': { name: '–¢–∞–±–µ–ª–∞ —Å–æ –î–æ–∫–∞–∑–∏', icon: 'üìë' },
      '–ö–∞—Ä—Ç–∏—á–∫–∞.html': { name: '–ê–ê–ö –ö–∞—Ä—Ç–∏—á–∫–∏', icon: 'üé¥' }
    };

    const i18n = {
      mk: { all: '–°–∏—Ç–µ', favorites: '‚≠ê –û–º–∏–ª–µ–Ω–∏', search: '–ü—Ä–µ–±–∞—Ä–∞—ò...', newCollection: '+ –ö–æ–ª–µ–∫—Ü–∏—ò–∞', noApps: '–ù–µ–º–∞ –∞–ø–ª–∏–∫–∞—Ü–∏–∏', addNew: '‚ûï –î–æ–¥–∞—ò', goodbye: '–î–æ–≤–∏–¥—É–≤–∞—ö–µ! üëã' },
      en: { all: 'All', favorites: '‚≠ê Favorites', search: 'Search...', newCollection: '+ Collection', noApps: 'No apps', addNew: '‚ûï Add', goodbye: 'Goodbye! üëã' }
    };

    let state = JSON.parse(localStorage.getItem(STORE_KEY)) || {
      apps: [],
      tabs: [],
      order: [],
      theme: 'dark',
      lang: 'mk',
      repoUrl: 'Assisstant/MTB',
      activeTab: 'all'
    };

    let editingAppId = null;
    let editingTabId = null;
    let selectedIcon = 'üìã';
    let selectedTabIcon = 'üìÅ';
    let draggedCard = null;

    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const t = k => i18n[state.lang]?.[k] || k;

    function save() {
      localStorage.setItem(STORE_KEY, JSON.stringify(state));
      render();
    }

    function render() {
      renderTabs();
      renderApps();
      $('#totalApps').textContent = state.apps.length;
      $('#langBtn').textContent = state.lang === 'mk' ? 'EN' : 'MK';
      $('#themeBtn').textContent = state.theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
      $('#searchInput').placeholder = t('search');
    }

    function renderTabs() {
      const container = $('#tabsContainer');
      const favCount = state.apps.filter(a => a.favorite).length;
      
      let html = `
        <button class="tab ${state.activeTab === 'all' ? 'active' : ''}" onclick="setTab('all')">
          üè† ${t('all')} <span class="tab-count">${state.apps.length}</span>
        </button>
        <button class="tab ${state.activeTab === 'favorites' ? 'active' : ''}" onclick="setTab('favorites')">
          ${t('favorites')} <span class="tab-count">${favCount}</span>
        </button>
      `;

      state.tabs.forEach(tab => {
        const count = state.apps.filter(a => a.tabs?.includes(tab.id)).length;
        html += `
          <button class="tab ${state.activeTab === tab.id ? 'active' : ''}" onclick="setTab('${tab.id}')">
            ${tab.icon} ${tab.name} <span class="tab-count">${count}</span>
            <span class="tab-close" onclick="event.stopPropagation(); deleteTab('${tab.id}')">‚úï</span>
          </button>
        `;
      });

      html += `<button class="add-tab-btn" onclick="openTabModal()">${t('newCollection')}</button>`;
      container.innerHTML = html;
    }

    function renderApps() {
      const grid = $('#appGrid');
      const search = $('#searchInput').value.toLowerCase();
      
      let apps = [...state.apps];

      // Filter by tab
      if (state.activeTab === 'favorites') {
        apps = apps.filter(a => a.favorite);
      } else if (state.activeTab !== 'all') {
        apps = apps.filter(a => a.tabs?.includes(state.activeTab));
      }

      // Filter by search
      if (search) {
        apps = apps.filter(a => a.name.toLowerCase().includes(search));
      }

      // Sort by order
      if (state.order.length) {
        apps.sort((a, b) => {
          const ia = state.order.indexOf(a.id);
          const ib = state.order.indexOf(b.id);
          if (ia === -1) return 1;
          if (ib === -1) return -1;
          return ia - ib;
        });
      }

      if (apps.length === 0 && !search) {
        grid.innerHTML = `
          <div class="empty-state" style="grid-column: 1/-1;">
            <div class="empty-state-icon">üì≠</div>
            <div>${t('noApps')}</div>
          </div>
        `;
        return;
      }

      let html = apps.map(app => `
        <div class="app-card" draggable="true" data-id="${app.id}" onclick="openApp('${app.url}')">
          <div class="app-actions">
            <button class="app-action star ${app.favorite ? 'active' : ''}" onclick="event.stopPropagation(); toggleFav('${app.id}')" title="–û–º–∏–ª–µ–Ω–æ">‚òÖ</button>
            <button class="app-action" onclick="event.stopPropagation(); editApp('${app.id}')" title="–£—Ä–µ–¥–∏">‚úèÔ∏è</button>
            <button class="app-action delete" onclick="event.stopPropagation(); deleteApp('${app.id}')" title="–ò–∑–±—Ä–∏—à–∏">üóëÔ∏è</button>
          </div>
          <div class="app-icon">${app.icon || 'üìÑ'}</div>
          <div class="app-name">${app.name}</div>
        </div>
      `).join('');

      html += `<div class="add-card" onclick="openAppModal()">${t('addNew')}</div>`;
      grid.innerHTML = html;

      // Add drag events
      $$('.app-card[draggable]').forEach(card => {
        card.addEventListener('dragstart', handleDragStart);
        card.addEventListener('dragend', handleDragEnd);
        card.addEventListener('dragover', handleDragOver);
        card.addEventListener('drop', handleDrop);
        card.addEventListener('dragleave', handleDragLeave);
      });
    }

    // Drag & Drop
    function handleDragStart(e) {
      draggedCard = this;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }

    function handleDragEnd() {
      this.classList.remove('dragging');
      $$('.app-card').forEach(c => c.classList.remove('drag-over'));
      draggedCard = null;
    }

    function handleDragOver(e) {
      e.preventDefault();
      if (this !== draggedCard) {
        this.classList.add('drag-over');
      }
    }

    function handleDragLeave() {
      this.classList.remove('drag-over');
    }

    function handleDrop(e) {
      e.preventDefault();
      this.classList.remove('drag-over');
      
      if (this === draggedCard) return;

      const fromId = draggedCard.dataset.id;
      const toId = this.dataset.id;

      // Update order
      let order = state.order.length ? [...state.order] : state.apps.map(a => a.id);
      const fromIdx = order.indexOf(fromId);
      const toIdx = order.indexOf(toId);

      if (fromIdx > -1) order.splice(fromIdx, 1);
      order.splice(toIdx, 0, fromId);

      state.order = order;
      save();
    }

    // Tab functions
    window.setTab = (tabId) => {
      state.activeTab = tabId;
      save();
    };

    window.openTabModal = (tab = null) => {
      editingTabId = tab ? tab.id : null;
      $('#tabModal').classList.add('show');
      $('#tabName').value = tab ? tab.name : '';
      selectedTabIcon = tab ? tab.icon : 'üìÅ';
      renderTabIconGrid();
      renderAppSelector(tab);
    };

    window.closeTabModal = () => {
      $('#tabModal').classList.remove('show');
      editingTabId = null;
    };

    function renderTabIconGrid() {
      $('#tabIconGrid').innerHTML = ICONS.slice(0, 24).map(icon =>
        `<div class="icon-option ${selectedTabIcon === icon ? 'active' : ''}" onclick="selectedTabIcon='${icon}'; renderTabIconGrid()">${icon}</div>`
      ).join('');
    }

    function renderAppSelector(tab = null) {
      const selected = tab ? state.apps.filter(a => a.tabs?.includes(tab.id)).map(a => a.id) : [];
      $('#appSelector').innerHTML = state.apps.map(app => `
        <label class="app-selector-item">
          <input type="checkbox" value="${app.id}" ${selected.includes(app.id) ? 'checked' : ''}>
          <span class="icon">${app.icon || 'üìÑ'}</span>
          <span class="name">${app.name}</span>
        </label>
      `).join('') || '<div style="padding:20px;text-align:center;color:var(--text-secondary)">–ù–µ–º–∞ –∞–ø–ª–∏–∫–∞—Ü–∏–∏</div>';
    }

    window.saveTab = () => {
      const name = $('#tabName').value.trim();
      if (!name) return showToast('–í–Ω–µ—Å–∏ –∏–º–µ!', 'error');

      const selectedApps = [...$$('#appSelector input:checked')].map(i => i.value);

      if (editingTabId) {
        const tab = state.tabs.find(t => t.id === editingTabId);
        if (tab) {
          tab.name = name;
          tab.icon = selectedTabIcon;
        }
        // Update app assignments
        state.apps.forEach(app => {
          app.tabs = app.tabs?.filter(t => t !== editingTabId) || [];
          if (selectedApps.includes(app.id)) {
            app.tabs.push(editingTabId);
          }
        });
      } else {
        const newTab = { id: 'tab_' + Date.now(), name, icon: selectedTabIcon };
        state.tabs.push(newTab);
        // Assign apps
        state.apps.forEach(app => {
          if (selectedApps.includes(app.id)) {
            app.tabs = app.tabs || [];
            app.tabs.push(newTab.id);
          }
        });
      }

      save();
      closeTabModal();
    };

    window.deleteTab = (tabId) => {
      if (!confirm('–ò–∑–±—Ä–∏—à–∏ –∫–æ–ª–µ–∫—Ü–∏—ò–∞?')) return;
      state.tabs = state.tabs.filter(t => t.id !== tabId);
      state.apps.forEach(app => {
        app.tabs = app.tabs?.filter(t => t !== tabId) || [];
      });
      if (state.activeTab === tabId) state.activeTab = 'all';
      save();
    };

    // App functions
    window.openApp = (url) => {
      window.open(url, '_blank');
    };

    window.toggleFav = (id) => {
      const app = state.apps.find(a => a.id === id);
      if (app) app.favorite = !app.favorite;
      save();
    };

    window.openAppModal = (app = null) => {
      editingAppId = app ? app.id : null;
      $('#appModal').classList.add('show');
      $('#appModalTitle').textContent = app ? '‚úèÔ∏è –£—Ä–µ–¥–∏' : '‚ûï –î–æ–¥–∞—ò';
      $('#appName').value = app ? app.name : '';
      $('#appUrl').value = app ? app.url : '';
      selectedIcon = app ? app.icon : 'üìã';
      renderIconGrid();
    };

    window.closeAppModal = () => {
      $('#appModal').classList.remove('show');
      editingAppId = null;
    };

    function renderIconGrid() {
      $('#iconGrid').innerHTML = ICONS.map(icon =>
        `<div class="icon-option ${selectedIcon === icon ? 'active' : ''}" onclick="selectedIcon='${icon}'; renderIconGrid()">${icon}</div>`
      ).join('');
    }

    window.saveApp = () => {
      const name = $('#appName').value.trim();
      const url = $('#appUrl').value.trim();
      if (!name || !url) return showToast('–ü–æ–ø–æ–ª–Ω–∏ —Å√®!', 'error');

      if (editingAppId) {
        const app = state.apps.find(a => a.id === editingAppId);
        if (app) {
          app.name = name;
          app.url = url;
          app.icon = selectedIcon;
        }
      } else {
        state.apps.push({
          id: 'app_' + Date.now(),
          name, url,
          icon: selectedIcon,
          favorite: false,
          tabs: []
        });
      }

      save();
      closeAppModal();
    };

    window.editApp = (id) => {
      const app = state.apps.find(a => a.id === id);
      if (app) openAppModal(app);
    };

    window.deleteApp = (id) => {
      if (!confirm('–ò–∑–±—Ä–∏—à–∏?')) return;
      state.apps = state.apps.filter(a => a.id !== id);
      state.order = state.order.filter(o => o !== id);
      save();
    };

    // GitHub scan
    window.scanGitHub = async () => {
      const repo = prompt('üìÇ GitHub repo:', state.repoUrl || 'Assisstant/MTB');
      if (!repo) return;
      state.repoUrl = repo;

      showToast('üîÑ –°–∫–µ–Ω–∏—Ä–∞—ö–µ...');
      try {
        const res = await fetch(`https://api.github.com/repos/${repo}/contents`);
        if (!res.ok) throw new Error('Not found');
        const files = await res.json();

        const htmlFiles = files.filter(f => 
          f.name.endsWith('.html') && 
          f.type === 'file' && 
          !['index.html', 'iiindex.html'].includes(f.name.toLowerCase())
        );

        let added = 0;
        htmlFiles.forEach(file => {
          if (state.apps.some(a => a.url === file.name)) return;
          const map = FILE_MAPPINGS[file.name] || {};
          state.apps.push({
            id: 'gh_' + file.sha.slice(0, 8),
            name: map.name || file.name.replace('.html', '').replace(/[-_]/g, ' '),
            url: file.name,
            icon: map.icon || 'üìÑ',
            favorite: false,
            tabs: []
          });
          added++;
        });

        save();
        showToast(`‚úÖ –î–æ–¥–∞–¥–µ–Ω–∏ ${added} –∞–ø–ª–∏–∫–∞—Ü–∏–∏`);
      } catch (e) {
        showToast('‚ùå –ì—Ä–µ—à–∫–∞: ' + e.message, 'error');
      }
    };

    // Import/Export
    window.openImportModal = () => $('#importModal').classList.add('show');
    window.closeImportModal = () => $('#importModal').classList.remove('show');

    window.handleFile = (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => { $('#importText').value = ev.target.result; };
        reader.readAsText(file);
      }
    };

    window.doImport = () => {
      try {
        const data = JSON.parse($('#importText').value);
        if (data.apps) state.apps = data.apps;
        if (data.tabs) state.tabs = data.tabs;
        if (data.order) state.order = data.order;
        if (data.theme) { state.theme = data.theme; document.documentElement.dataset.theme = data.theme; }
        if (data.lang) state.lang = data.lang;
        save();
        closeImportModal();
        showToast('‚úÖ –£–≤–µ–∑–µ–Ω–æ!');
      } catch (e) {
        showToast('‚ùå –ì—Ä–µ—à–∫–∞!', 'error');
      }
    };

    window.exportData = () => {
      const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `toolbox-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      showToast('üì§ –ò–∑–≤–µ–∑–µ–Ω–æ!');
    };

    // Clean exit
    window.openCleanModal = () => {
      $('#cleanModal').classList.add('show');
      let html = '';
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        const size = (localStorage.getItem(key).length / 1024).toFixed(1);
        html += `
          <div class="storage-item">
            <input type="checkbox" data-key="${key}">
            <div><div class="storage-key">${key}</div><div class="storage-size">${size} KB</div></div>
          </div>
        `;
      }
      $('#storageList').innerHTML = html || '<div style="padding:20px;text-align:center">–ü—Ä–∞–∑–Ω–æ</div>';
    };

    window.closeCleanModal = () => $('#cleanModal').classList.remove('show');

    window.performClean = () => {
      const checked = [...$$('#storageList input:checked')];
      if (!checked.length) return showToast('–ò–∑–±–µ—Ä–∏ –Ω–µ—à—Ç–æ', 'error');
      checked.forEach(cb => localStorage.removeItem(cb.dataset.key));
      showToast('üßπ –ò–∑–±—Ä–∏—à–∞–Ω–æ!');
      closeCleanModal();
      setTimeout(() => {
        document.body.innerHTML = `
          <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;background:var(--bg);color:var(--text);text-align:center">
            <div style="font-size:60px;margin-bottom:16px">üëã</div>
            <h1>${t('goodbye')}</h1>
          </div>
        `;
      }, 800);
    };

    // Theme & Lang
    $('#themeBtn').onclick = () => {
      state.theme = state.theme === 'dark' ? 'light' : 'dark';
      document.documentElement.dataset.theme = state.theme;
      save();
    };

    window.toggleLang = () => {
      state.lang = state.lang === 'mk' ? 'en' : 'mk';
      save();
    };

    // Search
    $('#searchInput').oninput = () => renderApps();

    // Toast
    function showToast(msg, type = 'success') {
      const toast = $('#toast');
      toast.textContent = msg;
      toast.className = 'toast show ' + type;
      setTimeout(() => toast.classList.remove('show'), 2500);
    }

    // Init
    document.documentElement.dataset.theme = state.theme;
    render();
  </script>
</body>
</html>
